!function(){class t extends THREE.Loader{constructor(t){super(t),this.availableExtensions=[]}load(t,e,r,n){const o=this,s=new THREE.FileLoader(o.manager);s.setPath(o.path),s.setResponseType("arraybuffer"),s.setRequestHeader(o.requestHeader),s.setWithCredentials(o.withCredentials),s.load(t,function(r){try{e(o.parse(r))}catch(e){n?n(e):console.error(e),o.manager.itemError(t)}},r,n)}parse(t){const e=this,r=new THREE.TextureLoader(this.manager);function n(t){const e=[],r=(new DOMParser).parseFromString(t,"application/xml").querySelectorAll("Relationship");for(let t=0;t<r.length;t++){const n=r[t],o={target:n.getAttribute("Target"),id:n.getAttribute("Id"),type:n.getAttribute("Type")};e.push(o)}return e}function o(t){const e={id:t.getAttribute("id"),basematerials:[]},r=t.querySelectorAll("base");for(let t=0;t<r.length;t++){const n=a(r[t]);n.index=t,e.basematerials.push(n)}return e}function s(t){return{id:t.getAttribute("id"),path:t.getAttribute("path"),contenttype:t.getAttribute("contenttype"),tilestyleu:t.getAttribute("tilestyleu"),tilestylev:t.getAttribute("tilestylev"),filter:t.getAttribute("filter")}}function i(t){const e={id:t.getAttribute("id"),texid:t.getAttribute("texid"),displaypropertiesid:t.getAttribute("displaypropertiesid")},r=t.querySelectorAll("tex2coord"),n=[];for(let t=0;t<r.length;t++){const e=r[t],o=e.getAttribute("u"),s=e.getAttribute("v");n.push(parseFloat(o),parseFloat(s))}return e.uvs=new Float32Array(n),e}function l(t){const e={id:t.getAttribute("id"),displaypropertiesid:t.getAttribute("displaypropertiesid")},r=t.querySelectorAll("color"),n=[],o=new THREE.Color;for(let t=0;t<r.length;t++){const e=r[t].getAttribute("color");o.setStyle(e.substring(0,7)),o.convertSRGBToLinear(),n.push(o.r,o.g,o.b)}return e.colors=new Float32Array(n),e}function u(t){const e={id:t.getAttribute("id")},r=t.querySelectorAll("pbmetallic"),n=[];for(let t=0;t<r.length;t++){const e=r[t];n.push({name:e.getAttribute("name"),metallicness:parseFloat(e.getAttribute("metallicness")),roughness:parseFloat(e.getAttribute("roughness"))})}return e.data=n,e}function a(t){const e={};return e.name=t.getAttribute("name"),e.displaycolor=t.getAttribute("displaycolor"),e.displaypropertiesid=t.getAttribute("displaypropertiesid"),e}function c(t){const e={};e.objectId=t.getAttribute("objectid");const r=t.getAttribute("transform");return r&&(e.transform=p(r)),e}function p(t){const e=[];t.split(" ").forEach(function(t){e.push(parseFloat(t))});const r=new THREE.Matrix4;return r.set(e[0],e[3],e[6],e[9],e[1],e[4],e[7],e[10],e[2],e[5],e[8],e[11],0,0,0,1),r}function d(t){const e={type:t.getAttribute("type")},r=t.getAttribute("id");r&&(e.id=r);const n=t.getAttribute("pid");n&&(e.pid=n);const o=t.getAttribute("pindex");o&&(e.pindex=o);const s=t.getAttribute("thumbnail");s&&(e.thumbnail=s);const i=t.getAttribute("partnumber");i&&(e.partnumber=i);const l=t.getAttribute("name");l&&(e.name=l);const u=t.querySelector("mesh");u&&(e.mesh=function(t){const e={},r=[],n=t.querySelectorAll("vertices vertex");for(let t=0;t<n.length;t++){const e=n[t],o=e.getAttribute("x"),s=e.getAttribute("y"),i=e.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(i))}e.vertices=new Float32Array(r);const o=[],s=[],i=t.querySelectorAll("triangles triangle");for(let t=0;t<i.length;t++){const e=i[t],r=e.getAttribute("v1"),n=e.getAttribute("v2"),l=e.getAttribute("v3"),u=e.getAttribute("p1"),a=e.getAttribute("p2"),c=e.getAttribute("p3"),p=e.getAttribute("pid"),d={};d.v1=parseInt(r,10),d.v2=parseInt(n,10),d.v3=parseInt(l,10),s.push(d.v1,d.v2,d.v3),u&&(d.p1=parseInt(u,10)),a&&(d.p2=parseInt(a,10)),c&&(d.p3=parseInt(c,10)),p&&(d.pid=p),0<Object.keys(d).length&&o.push(d)}return e.triangleProperties=o,e.triangles=new Uint32Array(s),e}(u));const a=t.querySelector("components");return a&&(e.components=function(t){const e=[],r=t.querySelectorAll("component");for(let t=0;t<r.length;t++){const n=c(r[t]);e.push(n)}return e}(a)),e}function h(t){const e={unit:t.getAttribute("unit")||"millimeter"},r=t.querySelectorAll("metadata");r&&(e.metadata=function(t){const e={};for(let r=0;r<t.length;r++){const n=t[r],o=n.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(o)&&(e[o]=n.textContent)}return e}(r));const n=t.querySelector("resources");n&&(e.resources=function(t){const e={basematerials:{}},r=t.querySelectorAll("basematerials");for(let t=0;t<r.length;t++){const n=o(r[t]);e.basematerials[n.id]=n}e.texture2d={};const n=t.querySelectorAll("texture2d");for(let t=0;t<n.length;t++){const r=s(n[t]);e.texture2d[r.id]=r}e.colorgroup={};const a=t.querySelectorAll("colorgroup");for(let t=0;t<a.length;t++){const r=l(a[t]);e.colorgroup[r.id]=r}e.pbmetallicdisplayproperties={};const c=t.querySelectorAll("pbmetallicdisplayproperties");for(let t=0;t<c.length;t++){const r=u(c[t]);e.pbmetallicdisplayproperties[r.id]=r}e.texture2dgroup={};const p=t.querySelectorAll("texture2dgroup");for(let t=0;t<p.length;t++){const r=i(p[t]);e.texture2dgroup[r.id]=r}e.object={};const h=t.querySelectorAll("object");for(let t=0;t<h.length;t++){const r=d(h[t]);e.object[r.id]=r}return e}(n));const a=t.querySelector("build");return a&&(e.build=function(t){const e=[],r=t.querySelectorAll("item");for(let t=0;t<r.length;t++){const n=r[t],o={objectId:n.getAttribute("objectid")},s=n.getAttribute("transform");s&&(o.transform=p(s)),e.push(o)}return e}(a)),e}function g(t,e,n,o){const s=t.texid,i=n.resources.texture2d[s];if(i){const t=o[i.path],e=i.contenttype,n=new Blob([t],{type:e}),s=URL.createObjectURL(n),l=r.load(s,function(){URL.revokeObjectURL(s)});switch(l.encoding=THREE.sRGBEncoding,i.tilestyleu){case"wrap":default:l.wrapS=THREE.RepeatWrapping;break;case"mirror":l.wrapS=THREE.MirroredRepeatWrapping;break;case"none":case"clamp":l.wrapS=THREE.ClampToEdgeWrapping}switch(i.tilestylev){case"wrap":default:l.wrapT=THREE.RepeatWrapping;break;case"mirror":l.wrapT=THREE.MirroredRepeatWrapping;break;case"none":case"clamp":l.wrapT=THREE.ClampToEdgeWrapping}switch(i.filter){case"auto":default:l.magFilter=THREE.LinearFilter,l.minFilter=THREE.LinearMipmapLinearFilter;break;case"linear":l.magFilter=THREE.LinearFilter,l.minFilter=THREE.LinearFilter;break;case"nearest":l.magFilter=THREE.NearestFilter,l.minFilter=THREE.NearestFilter}return l}return null}function f(t,e,r,n,o,s,i){const l=i.pindex,u={};for(let t=0,r=e.length;t<r;t++){const r=e[t],n=void 0!==r.p1?r.p1:l;void 0===u[n]&&(u[n]=[]),u[n].push(r)}const a=Object.keys(u),c=[];for(let e=0,l=a.length;e<l;e++){const l=a[e],p=u[l],d=v(t.basematerials[l],n,o,s,i,R),h=new THREE.BufferGeometry,g=[],f=r.vertices;for(let t=0,e=p.length;t<e;t++){const e=p[t];g.push(f[3*e.v1+0]),g.push(f[3*e.v1+1]),g.push(f[3*e.v1+2]),g.push(f[3*e.v2+0]),g.push(f[3*e.v2+1]),g.push(f[3*e.v2+2]),g.push(f[3*e.v3+0]),g.push(f[3*e.v3+1]),g.push(f[3*e.v3+2])}h.setAttribute("position",new THREE.Float32BufferAttribute(g,3));const b=new THREE.Mesh(h,d);c.push(b)}return c}function b(t,e,r,n,o,s,i){const l=new THREE.BufferGeometry,u=[],a=[],c=r.vertices,p=t.uvs;for(let t=0,r=e.length;t<r;t++){const r=e[t];u.push(c[3*r.v1+0]),u.push(c[3*r.v1+1]),u.push(c[3*r.v1+2]),u.push(c[3*r.v2+0]),u.push(c[3*r.v2+1]),u.push(c[3*r.v2+2]),u.push(c[3*r.v3+0]),u.push(c[3*r.v3+1]),u.push(c[3*r.v3+2]),a.push(p[2*r.p1+0]),a.push(p[2*r.p1+1]),a.push(p[2*r.p2+0]),a.push(p[2*r.p2+1]),a.push(p[2*r.p3+0]),a.push(p[2*r.p3+1])}l.setAttribute("position",new THREE.Float32BufferAttribute(u,3)),l.setAttribute("uv",new THREE.Float32BufferAttribute(a,2));const d=v(t,n,o,s,i,g),h=new THREE.MeshPhongMaterial({map:d,flatShading:!0});return new THREE.Mesh(l,h)}function E(t,e,r,n){const o=new THREE.BufferGeometry,s=[],i=[],l=r.vertices,u=t.colors;for(let t=0,r=e.length;t<r;t++){const r=e[t],o=r.v1,a=r.v2,c=r.v3;s.push(l[3*o+0]),s.push(l[3*o+1]),s.push(l[3*o+2]),s.push(l[3*a+0]),s.push(l[3*a+1]),s.push(l[3*a+2]),s.push(l[3*c+0]),s.push(l[3*c+1]),s.push(l[3*c+2]);const p=void 0!==r.p1?r.p1:n.pindex,d=void 0!==r.p2?r.p2:p,h=void 0!==r.p3?r.p3:p;i.push(u[3*p+0]),i.push(u[3*p+1]),i.push(u[3*p+2]),i.push(u[3*d+0]),i.push(u[3*d+1]),i.push(u[3*d+2]),i.push(u[3*h+0]),i.push(u[3*h+1]),i.push(u[3*h+2])}o.setAttribute("position",new THREE.Float32BufferAttribute(s,3)),o.setAttribute("color",new THREE.Float32BufferAttribute(i,3));const a=new THREE.MeshPhongMaterial({vertexColors:!0,flatShading:!0});return new THREE.Mesh(o,a)}function m(t){const e=new THREE.BufferGeometry;e.setIndex(new THREE.BufferAttribute(t.triangles,1)),e.setAttribute("position",new THREE.BufferAttribute(t.vertices,3));const r=new THREE.MeshPhongMaterial({color:16777215,flatShading:!0});return new THREE.Mesh(e,r)}function A(t,e){return void 0!==e.resources.texture2dgroup[t]?"texture":void 0!==e.resources.basematerials[t]?"material":void 0!==e.resources.colorgroup[t]?"vertexColors":"default"===t?"default":void 0}function y(t,e,r,n,o){const s=new THREE.Group,i=function(t,e){const r={},n=t.triangleProperties,o=e.pid;for(let t=0,e=n.length;t<e;t++){const e=n[t];let s=void 0!==e.pid?e.pid:o;void 0===s&&(s="default"),void 0===r[s]&&(r[s]=[]),r[s].push(e)}return r}(t,o),l=function(t,e,r,n,o,s){const i=Object.keys(t),l=[];for(let u=0,a=i.length;u<a;u++){const a=i[u],c=t[a];switch(A(a,n)){case"material":const t=f(n.resources.basematerials[a],c,e,r,n,o,s);for(let e=0,r=t.length;e<r;e++)l.push(t[e]);break;case"texture":const i=n.resources.texture2dgroup[a];l.push(b(i,c,e,r,n,o,s));break;case"vertexColors":const u=n.resources.colorgroup[a];l.push(E(u,c,e,s));break;case"default":l.push(m(e));break;default:console.error("THREE.3MFLoader: Unsupported resource type.")}}if(s.name)for(let t=0;t<l.length;t++)l[t].name=s.name;return l}(i,t,e,r,n,o);for(let t=0,e=l.length;t<e;t++)s.add(l[t]);return s}function v(t,e,r,n,o,s){return void 0!==t.build||(t.build=s(t,e,r,n,o)),t.build}function R(t,e,r){let n;const o=t.displaypropertiesid,s=r.resources.pbmetallicdisplayproperties;if(null!==o&&void 0!==s[o]){const e=s[o].data[t.index];n=new THREE.MeshStandardMaterial({flatShading:!0,roughness:e.roughness,metalness:e.metallicness})}else n=new THREE.MeshPhongMaterial({flatShading:!0});n.name=t.name;const i=t.displaycolor,l=i.substring(0,7);return n.color.setStyle(l),n.color.convertSRGBToLinear(),9===i.length&&(n.opacity=parseInt(i.charAt(7)+i.charAt(8),16)/255),n}function T(t,e,r,n){const o=new THREE.Group;for(let s=0;s<t.length;s++){const i=t[s];let l=e[i.objectId];void 0===l&&(x(i.objectId,e,r,n),l=e[i.objectId]);const u=l.clone(),a=i.transform;a&&u.applyMatrix4(a),o.add(u)}return o}function x(t,r,n,o){const s=n.resources.object[t];if(s.mesh){const t=s.mesh;!function(t,r,n){if(!t)return;const o=[],s=Object.keys(t);for(let t=0;t<s.length;t++){const r=s[t];for(let t=0;t<e.availableExtensions.length;t++){const n=e.availableExtensions[t];n.ns===r&&o.push(n)}}for(let e=0;e<o.length;e++){const s=o[e];s.apply(n,t[s.ns],r)}}(n.extensions,t,n.xml),r[s.id]=v(t,r,n,o,s,y)}else{const t=s.components;r[s.id]=v(t,r,n,o,s,T)}s.name&&(r[s.id].name=s.name)}const w=function(t){let e,r,o=null,s=null;const i=[],l=[];let u;const a={},c={};try{o=fflate.unzipSync(new Uint8Array(t))}catch(t){if(t instanceof ReferenceError)return console.error("THREE.3MFLoader: fflate missing and file is compressed."),null}for(s in o)s.match(/\_rels\/.rels$/)?e=s:s.match(/3D\/_rels\/.*\.model\.rels$/)?r=s:s.match(/^3D\/.*\.model$/)?i.push(s):s.match(/^3D\/Textures?\/.*/)&&l.push(s);const p=o[e],d=n(THREE.LoaderUtils.decodeText(p));if(r){const t=o[r];u=n(THREE.LoaderUtils.decodeText(t))}for(let t=0;t<i.length;t++){const e=i[t],r=o[e],n=THREE.LoaderUtils.decodeText(r),s=(new DOMParser).parseFromString(n,"application/xml");"model"!==s.documentElement.nodeName.toLowerCase()&&console.error("THREE.3MFLoader: Error loading 3MF - no 3MF document found: ",e);const l=s.querySelector("model"),u={};for(let t=0;t<l.attributes.length;t++){const e=l.attributes[t];e.name.match(/^xmlns:(.+)$/)&&(u[e.value]=RegExp.$1)}const c=h(l);c.xml=l,0<Object.keys(u).length&&(c.extensions=u),a[e]=c}for(let t=0;t<l.length;t++){const e=l[t];c[e]=o[e].buffer}return{rels:d,modelRels:u,model:a,printTicket:{},texture:c}}(t),H=function(t){const e=t.model,r=t.modelRels,n={},o=Object.keys(e),s={};if(r)for(let e=0,n=r.length;e<n;e++){const n=r[e],o=n.target.substring(1);t.texture[o]&&(s[n.target]=t.texture[o])}for(let t=0;t<o.length;t++){const r=e[o[t]],i=Object.keys(r.resources.object);for(let t=0;t<i.length;t++){x(i[t],n,r,s)}}return n}(w);return function(t,e){const r=new THREE.Group,n=function(t){for(let e=0;e<t.length;e++){const r=t[e];if("model"===r.target.split(".").pop().toLowerCase())return r}}(e.rels),o=e.model[n.target.substring(1)].build;for(let e=0;e<o.length;e++){const n=o[e],s=t[n.objectId].clone(),i=n.transform;i&&s.applyMatrix4(i),r.add(s)}return r}(H,w)}addExtension(t){this.availableExtensions.push(t)}}THREE.ThreeMFLoader=t}();