import{Box2,Camera,Color,Matrix3,Matrix4,Object3D,SRGBColorSpace,Vector3}from"three";import{Projector,RenderableFace,RenderableLine,RenderableSprite}from"./Projector.js";class SVGObject extends Object3D{constructor(e){super(),this.isSVGObject=!0,this.node=e}}class SVGRenderer{constructor(){let e,t,o,i,r,n,s,a,c,l,d,p,u,h=0,f=0,S=0,y=null,m=1;const x=this,g=new Box2,b=new Box2,w=new Color,v=new Color,M=new Color,C=new Color,z=new Color,j=new Color,O=new Vector3,R=new Vector3,L=new Vector3,k=new Matrix3,P=new Matrix4,B=new Matrix4,G=[],V=[],E=[],A=new Projector,F=document.createElementNS("http://www.w3.org/2000/svg","svg");function W(){for(h=0;F.childNodes.length>0;)F.removeChild(F.childNodes[0])}function N(e){return null!==y?e.toFixed(y):e}function D(e,t){const o=void 0!==e.data.renderOrder?e.data.renderOrder:0,i=void 0!==t.data.renderOrder?t.data.renderOrder:0;if(o!==i)return o-i;{const o=void 0!==e.data.z?e.data.z:0;return(void 0!==t.data.z?t.data.z:0)-o}}function I(e,t,o){let i=t.scale.x*n,r=t.scale.y*s;o.isPointsMaterial&&(i*=o.size,r*=o.size);const a="M"+N(e.x-.5*i)+","+N(e.y-.5*r)+"h"+N(i)+"v"+N(r)+"h"+N(-i)+"z";let c="";(o.isSpriteMaterial||o.isPointsMaterial)&&(c="fill:"+o.color.getStyle(x.outputColorSpace)+";fill-opacity:"+o.opacity),Q(c,a)}function T(e,t,o){const i="M"+N(e.positionScreen.x)+","+N(e.positionScreen.y)+"L"+N(t.positionScreen.x)+","+N(t.positionScreen.y);if(o.isLineBasicMaterial){let e="fill:none;stroke:"+o.color.getStyle(x.outputColorSpace)+";stroke-opacity:"+o.opacity+";stroke-width:"+o.linewidth+";stroke-linecap:"+o.linecap;o.isLineDashedMaterial&&(e=e+";stroke-dasharray:"+o.dashSize+","+o.gapSize),Q(e,i)}}function q(e,t,i,r,n){x.info.render.vertices+=3,x.info.render.faces++;const s="M"+N(e.positionScreen.x)+","+N(e.positionScreen.y)+"L"+N(t.positionScreen.x)+","+N(t.positionScreen.y)+"L"+N(i.positionScreen.x)+","+N(i.positionScreen.y)+"z";let a="";n.isMeshBasicMaterial?(w.copy(n.color),n.vertexColors&&w.multiply(r.color)):n.isMeshLambertMaterial||n.isMeshPhongMaterial||n.isMeshStandardMaterial?(v.copy(n.color),n.vertexColors&&v.multiply(r.color),w.copy(M),R.copy(e.positionWorld).add(t.positionWorld).add(i.positionWorld).divideScalar(3),function(e,t,o,i){for(let r=0,n=e.length;r<n;r++){const n=e[r],s=n.color;if(n.isDirectionalLight){const e=O.setFromMatrixPosition(n.matrixWorld).normalize();let t=o.dot(e);if(t<=0)continue;t*=n.intensity,i.r+=s.r*t,i.g+=s.g*t,i.b+=s.b*t}else if(n.isPointLight){const e=O.setFromMatrixPosition(n.matrixWorld);let r=o.dot(O.subVectors(e,t).normalize());if(r<=0)continue;if(r*=0==n.distance?1:1-Math.min(t.distanceTo(e)/n.distance,1),0==r)continue;r*=n.intensity,i.r+=s.r*r,i.g+=s.g*r,i.b+=s.b*r}}}(o,R,r.normalModel,w),w.multiply(v).add(n.emissive)):n.isMeshNormalMaterial&&(L.copy(r.normalModel).applyMatrix3(k).normalize(),w.setRGB(L.x,L.y,L.z).multiplyScalar(.5).addScalar(.5)),a=n.wireframe?"fill:none;stroke:"+w.getStyle(x.outputColorSpace)+";stroke-opacity:"+n.opacity+";stroke-width:"+n.wireframeLinewidth+";stroke-linecap:"+n.wireframeLinecap+";stroke-linejoin:"+n.wireframeLinejoin:"fill:"+w.getStyle(x.outputColorSpace)+";fill-opacity:"+n.opacity,Q(a,s)}function H(e,t,o){let i=t.x-e.x,r=t.y-e.y;const n=i*i+r*r;if(0===n)return;const s=o/Math.sqrt(n);i*=s,r*=s,t.x+=i,t.y+=r,e.x-=i,e.y-=r}function Q(e,t){u===e?p+=t:(J(),u=e,p=t)}function J(){p&&(d=function(e){let t=G[e];void 0===t&&(t=document.createElementNS("http://www.w3.org/2000/svg","path"),0==m&&t.setAttribute("shape-rendering","crispEdges"),G[e]=t);return t}(h++),d.setAttribute("d",p),d.setAttribute("style",u),F.appendChild(d)),p="",u=""}function K(e,t,o,i){let r=E[e];return void 0===r?(r={type:t,data:o,material:i},E[e]=r,r):(r.type=t,r.data=o,r.material=i,r)}this.domElement=F,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.overdraw=.5,this.outputColorSpace=SRGBColorSpace,this.info={render:{vertices:0,faces:0}},this.setQuality=function(e){switch(e){case"high":m=1;break;case"low":m=0}},this.setClearColor=function(e){j.set(e)},this.setPixelRatio=function(){},this.setSize=function(e,t){i=e,r=t,n=i/2,s=r/2,F.setAttribute("viewBox",-n+" "+-s+" "+i+" "+r),F.setAttribute("width",i),F.setAttribute("height",r),g.min.set(-n,-s),g.max.set(n,s)},this.getSize=function(){return{width:i,height:r}},this.setPrecision=function(e){y=e},this.clear=function(){W(),F.style.backgroundColor=j.getStyle(x.outputColorSpace)},this.render=function(i,r){if(r instanceof Camera==!1)return void console.error("THREE.SVGRenderer.render: camera is not an instance of Camera.");const d=i.background;d&&d.isColor?(W(),F.style.backgroundColor=d.getStyle(x.outputColorSpace)):!0===this.autoClear&&this.clear(),x.info.render.vertices=0,x.info.render.faces=0,P.copy(r.matrixWorldInverse),B.multiplyMatrices(r.projectionMatrix,P),e=A.projectScene(i,r,this.sortObjects,this.sortElements),t=e.elements,o=e.lights,k.getNormalMatrix(r.matrixWorldInverse),function(e){M.setRGB(0,0,0),C.setRGB(0,0,0),z.setRGB(0,0,0);for(let t=0,o=e.length;t<o;t++){const o=e[t],i=o.color;o.isAmbientLight?(M.r+=i.r,M.g+=i.g,M.b+=i.b):o.isDirectionalLight?(C.r+=i.r,C.g+=i.g,C.b+=i.b):o.isPointLight&&(z.r+=i.r,z.g+=i.g,z.b+=i.b)}}(o),S=0;for(let e=0,o=t.length;e<o;e++){const o=t[e],i=o.material;void 0!==i&&0!==i.opacity&&K(S++,"element",o,i)}f=0,i.traverseVisible(function(e){if(e.isSVGObject){if(O.setFromMatrixPosition(e.matrixWorld),O.applyMatrix4(B),O.z<-1||O.z>1)return;const t=O.x*n,o=-O.y*s,i=function(e){let t=V[e];void 0===t&&(t={node:null,x:0,y:0,z:0,renderOrder:0},V[e]=t);return t}(f++);i.node=e.node,i.x=t,i.y=o,i.z=O.z,i.renderOrder=e.renderOrder,K(S++,"svgObject",i,null)}}),this.sortElements&&function(e,t,o){for(let i=t+1;i<t+o;i++){const o=e[i];let r=i-1;for(;r>=t&&D(e[r],o)>0;)e[r+1]=e[r],r--;e[r+1]=o}}(E,0,S),p="",u="";for(let e=0;e<S;e++){const t=E[e];if("svgObject"===t.type){J();const e=t.data,o=e.node;o.setAttribute("transform","translate("+e.x+","+e.y+")"),F.appendChild(o)}else{const e=t.data,o=t.material;b.makeEmpty(),e instanceof RenderableSprite?(a=e,a.x*=n,a.y*=-s,I(a,e,o)):e instanceof RenderableLine?(a=e.v1,c=e.v2,a.positionScreen.x*=n,a.positionScreen.y*=-s,c.positionScreen.x*=n,c.positionScreen.y*=-s,b.setFromPoints([a.positionScreen,c.positionScreen]),!0===g.intersectsBox(b)&&T(a,c,o)):e instanceof RenderableFace&&(a=e.v1,c=e.v2,l=e.v3,a.positionScreen.x*=n,a.positionScreen.y*=-s,c.positionScreen.x*=n,c.positionScreen.y*=-s,l.positionScreen.x*=n,l.positionScreen.y*=-s,this.overdraw>0&&(H(a.positionScreen,c.positionScreen,this.overdraw),H(c.positionScreen,l.positionScreen,this.overdraw),H(l.positionScreen,a.positionScreen,this.overdraw)),b.setFromPoints([a.positionScreen,c.positionScreen,l.positionScreen]),!0===g.intersectsBox(b)&&q(a,c,l,e,o))}}J()}}}export{SVGObject,SVGRenderer};