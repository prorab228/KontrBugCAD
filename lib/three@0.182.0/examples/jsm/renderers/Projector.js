import{Box3,Color,DoubleSide,Frustum,Matrix3,Matrix4,Vector2,Vector3,Vector4}from"three";class RenderableObject{constructor(){this.id=0,this.object=null,this.z=0,this.renderOrder=0}}class RenderableFace{constructor(){this.id=0,this.v1=new RenderableVertex,this.v2=new RenderableVertex,this.v3=new RenderableVertex,this.normalModel=new Vector3,this.vertexNormalsModel=[new Vector3,new Vector3,new Vector3],this.vertexNormalsLength=0,this.color=new Color,this.material=null,this.uvs=[new Vector2,new Vector2,new Vector2],this.z=0,this.renderOrder=0}}class RenderableVertex{constructor(){this.position=new Vector3,this.positionWorld=new Vector3,this.positionScreen=new Vector4,this.visible=!0}copy(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)}}class RenderableLine{constructor(){this.id=0,this.v1=new RenderableVertex,this.v2=new RenderableVertex,this.vertexColors=[new Color,new Color],this.material=null,this.z=0,this.renderOrder=0}}class RenderableSprite{constructor(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new Vector2,this.material=null,this.renderOrder=0}}class Projector{constructor(){let e,t,r,o,n,i,s,l,c,a,p,u=0,d=0,h=0,f=0,m=0,x=[],y=[];const w={objects:[],lights:[],elements:[]},b=new Vector3,g=new Vector4,v=new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1)),M=new Box3,z=new Array(3),S=new Matrix4,V=new Matrix4,j=new Matrix4,O=new Frustum,R=[],W=[],C=[],A=[],L=[],N=[],F=new Vector4,T=new Vector4,P=new Vector4,B=[],I=[null,null,null],k=[{sign:1},{sign:-1}];const U=new function(){const e=[],t=[],i=[];let c=null;const a=new Matrix3;function u(e){const t=e.position,r=e.positionWorld,o=e.positionScreen;r.copy(t).applyMatrix4(p),o.copy(r).applyMatrix4(V);const n=1/o.w;o.x*=n,o.y*=n,o.z*=n,e.visible=o.x>=-1&&o.x<=1&&o.y>=-1&&o.y<=1&&o.z>=-1&&o.z<=1}function h(e,t,r){return!0===e.visible||!0===t.visible||!0===r.visible||(z[0]=e.positionScreen,z[1]=t.positionScreen,z[2]=r.positionScreen,v.intersectsBox(M.setFromPoints(z)))}function m(e,t,r){return(r.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(r.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0}return{setObject:function(r){c=r,a.getNormalMatrix(c.matrixWorld),e.length=0,t.length=0,i.length=0},projectVertex:u,checkTriangleVisibility:h,checkBackfaceCulling:m,pushVertex:function(e,t,n){r=function(){if(o===d){const e=new RenderableVertex;return W.push(e),d++,o++,e}return W[o++]}(),r.position.set(e,t,n),u(r)},pushNormal:function(t,r,o){e.push(t,r,o)},pushColor:function(e,r,o){t.push(e,r,o)},pushUv:function(e,t){i.push(e,t)},pushLine:function(e,r){const o=W[e],n=W[r];o.positionScreen.copy(o.position).applyMatrix4(j),n.positionScreen.copy(n.position).applyMatrix4(j),!0===function(e,t){let r=0,o=1;const n=e.z+e.w,i=t.z+t.w,s=-e.z+e.w,l=-t.z+t.w;return n>=0&&i>=0&&s>=0&&l>=0||!(n<0&&i<0||s<0&&l<0)&&(n<0?r=Math.max(r,n/(n-i)):i<0&&(o=Math.min(o,n/(n-i))),s<0?r=Math.max(r,s/(s-l)):l<0&&(o=Math.min(o,s/(s-l))),!(o<r)&&(e.lerp(t,r),t.lerp(e,1-o),!0))}(o.positionScreen,n.positionScreen)&&(o.positionScreen.multiplyScalar(1/o.positionScreen.w),n.positionScreen.multiplyScalar(1/n.positionScreen.w),s=function(){if(l===f){const e=new RenderableLine;return A.push(e),f++,l++,e}return A[l++]}(),s.id=c.id,s.v1.copy(o),s.v2.copy(n),s.z=Math.max(o.positionScreen.z,n.positionScreen.z),s.renderOrder=c.renderOrder,s.material=c.material,c.material.vertexColors&&(s.vertexColors[0].fromArray(t,3*e),s.vertexColors[1].fromArray(t,3*r)),w.elements.push(s))},pushTriangle:function(r,o,s,l){const p=W[r],u=W[o],d=W[s];F.copy(p.positionWorld).applyMatrix4(V),T.copy(u.positionWorld).applyMatrix4(V),P.copy(d.positionWorld).applyMatrix4(V);const f=F.z+F.w,v=T.z+T.w,M=P.z+P.w,z=-F.z+F.w,S=-T.z+T.w,j=-P.z+P.w;if(f<0&&v<0&&M<0||z<0&&S<0&&j<0)return;if(f>=0&&v>=0&&M>=0&&z>=0&&S>=0&&j>=0){if(!1===h(p,u,d))return;if(l.side===DoubleSide||!0===m(p,u,d)){n=Z(),n.id=c.id,n.v1.copy(p),n.v2.copy(u),n.v3.copy(d),n.z=(p.positionScreen.z+u.positionScreen.z+d.positionScreen.z)/3,n.renderOrder=c.renderOrder,b.subVectors(d.position,u.position),g.subVectors(p.position,u.position),b.cross(g),n.normalModel.copy(b),n.normalModel.applyMatrix3(a).normalize();for(let t=0;t<3;t++){const r=n.vertexNormalsModel[t];r.fromArray(e,3*arguments[t]),r.applyMatrix3(a).normalize();n.uvs[t].fromArray(i,2*arguments[t])}n.vertexNormalsLength=3,n.material=l,l.vertexColors&&n.color.fromArray(t,3*r),w.elements.push(n)}return}I[0]=F,I[1]=T,I[2]=P;const O=function(e){x[0]=e[0],x[1]=e[1],x[2]=e[2];let t=3,r=0;for(let e=0;e<k.length;e++){const o=k[e];if(r=0,0===t)break;for(let e=0;e<t;e++){const n=x[e],i=x[(e+1)%t],s=o.sign*n.z+n.w,l=o.sign*i.z+i.w,c=s>=0,a=l>=0;if(c&&a)y[r++]=n;else if(c&&!a){y[r++]=n;const e=s/(s-l);let t=N[r];t||(t=new Vector4,N[r]=t),t.lerpVectors(n,i,e),y[r++]=t}else if(!c&&a){const e=s/(s-l);let t=N[r];t||(t=new Vector4,N[r]=t),t.lerpVectors(n,i,e),y[r++]=t}}const n=x;x=y,y=n,t=r}return t}(I);if(!(O<3)){for(let e=0;e<O;e++){const t=x[e];let r=B[e];r||(r=new RenderableVertex,B[e]=r);const o=1/t.w;r.positionScreen.set(t.x*o,t.y*o,t.z*o,1),r.positionWorld.copy(p.positionWorld),r.visible=!0}for(let o=1;o<O-1;o++){const s=B[0],h=B[o],f=B[o+1];if(l.side===DoubleSide||!0===m(s,h,f)){n=Z(),n.id=c.id,n.v1.copy(s),n.v2.copy(h),n.v3.copy(f),n.z=(s.positionScreen.z+h.positionScreen.z+f.positionScreen.z)/3,n.renderOrder=c.renderOrder,b.subVectors(d.position,u.position),g.subVectors(p.position,u.position),b.cross(g),n.normalModel.copy(b),n.normalModel.applyMatrix3(a).normalize();for(let t=0;t<3;t++){const r=n.vertexNormalsModel[t];r.fromArray(e,3*arguments[t]),r.applyMatrix3(a).normalize();n.uvs[t].fromArray(i,2*arguments[t])}n.vertexNormalsLength=3,n.material=l,l.vertexColors&&n.color.fromArray(t,3*r),w.elements.push(n)}}}}}};function D(e){if(!1===e.visible)return;if(e.isLight)w.lights.push(e);else if(e.isMesh||e.isLine||e.isPoints){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===O.intersectsObject(e))return;X(e)}else if(e.isSprite){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===O.intersectsSprite(e))return;X(e)}const t=e.children;for(let e=0,r=t.length;e<r;e++)D(t[e])}function X(r){e=function(){if(t===u){const e=new RenderableObject;return R.push(e),u++,t++,e}return R[t++]}(),e.id=r.id,e.object=r,b.setFromMatrixPosition(r.matrixWorld),b.applyMatrix4(V),e.z=b.z,e.renderOrder=r.renderOrder,w.objects.push(e)}function Y(e,t,r){const o=1/e.w;e.z*=o,e.z>=-1&&e.z<=1&&(c=function(){if(a===m){const e=new RenderableSprite;return L.push(e),m++,a++,e}return L[a++]}(),c.id=t.id,c.x=e.x*o,c.y=e.y*o,c.z=e.z,c.renderOrder=t.renderOrder,c.object=t,c.rotation=t.rotation,c.scale.x=t.scale.x*Math.abs(c.x-(e.x+r.projectionMatrix.elements[0])/(e.w+r.projectionMatrix.elements[12])),c.scale.y=t.scale.y*Math.abs(c.y-(e.y+r.projectionMatrix.elements[5])/(e.w+r.projectionMatrix.elements[13])),c.material=t.material,w.elements.push(c))}function Z(){if(i===h){const e=new RenderableFace;return C.push(e),h++,i++,e}return C[i++]}function q(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function E(e,t,r){for(let o=t+1;o<t+r;o++){const r=e[o];let n=o-1;for(;n>=t&&q(e[n],r)>0;)e[n+1]=e[n],n--;e[n+1]=r}}this.projectScene=function(e,r,n,s){i=0,l=0,a=0,w.elements.length=0,!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===r.parent&&!0===r.matrixWorldAutoUpdate&&r.updateMatrixWorld(),S.copy(r.matrixWorldInverse),V.multiplyMatrices(r.projectionMatrix,S),O.setFromProjectionMatrix(V),t=0,w.objects.length=0,w.lights.length=0,D(e),!0===n&&E(w.objects,0,w.objects.length);const c=w.objects;for(let e=0,t=c.length;e<t;e++){const t=c[e].object,n=t.geometry;if(U.setObject(t),p=t.matrixWorld,o=0,t.isMesh){let e=t.material;const r=Array.isArray(e),o=n.attributes,i=n.groups;if(void 0===o.position)continue;const s=o.position.array;for(let e=0,r=s.length;e<r;e+=3){let r=s[e],o=s[e+1],i=s[e+2];const l=n.morphAttributes.position;if(void 0!==l){const c=n.morphTargetsRelative,a=t.morphTargetInfluences;for(let t=0,n=l.length;t<n;t++){const n=a[t];if(0===n)continue;const p=l[t];c?(r+=p.getX(e/3)*n,o+=p.getY(e/3)*n,i+=p.getZ(e/3)*n):(r+=(p.getX(e/3)-s[e])*n,o+=(p.getY(e/3)-s[e+1])*n,i+=(p.getZ(e/3)-s[e+2])*n)}}U.pushVertex(r,o,i)}if(void 0!==o.normal){const e=o.normal.array;for(let t=0,r=e.length;t<r;t+=3)U.pushNormal(e[t],e[t+1],e[t+2])}if(void 0!==o.color){const e=o.color.array;for(let t=0,r=e.length;t<r;t+=3)U.pushColor(e[t],e[t+1],e[t+2])}if(void 0!==o.uv){const e=o.uv.array;for(let t=0,r=e.length;t<r;t+=2)U.pushUv(e[t],e[t+1])}if(null!==n.index){const o=n.index.array;if(i.length>0)for(let n=0;n<i.length;n++){const s=i[n];if(e=!0===r?t.material[s.materialIndex]:t.material,void 0!==e)for(let t=s.start,r=s.start+s.count;t<r;t+=3)U.pushTriangle(o[t],o[t+1],o[t+2],e)}else for(let t=0,r=o.length;t<r;t+=3)U.pushTriangle(o[t],o[t+1],o[t+2],e)}else if(i.length>0)for(let o=0;o<i.length;o++){const n=i[o];if(e=!0===r?t.material[n.materialIndex]:t.material,void 0!==e)for(let t=n.start,r=n.start+n.count;t<r;t+=3)U.pushTriangle(t,t+1,t+2,e)}else for(let t=0,r=s.length/3;t<r;t+=3)U.pushTriangle(t,t+1,t+2,e)}else if(t.isLine){j.multiplyMatrices(V,p);const e=n.attributes;if(void 0!==e.position){const r=e.position.array;for(let e=0,t=r.length;e<t;e+=3)U.pushVertex(r[e],r[e+1],r[e+2]);if(void 0!==e.color){const t=e.color.array;for(let e=0,r=t.length;e<r;e+=3)U.pushColor(t[e],t[e+1],t[e+2])}if(null!==n.index){const e=n.index.array;for(let t=0,r=e.length;t<r;t+=2)U.pushLine(e[t],e[t+1])}else{const e=t.isLineSegments?2:1;for(let t=0,o=r.length/3-1;t<o;t+=e)U.pushLine(t,t+1)}}}else if(t.isPoints){j.multiplyMatrices(V,p);const e=n.attributes;if(void 0!==e.position){const o=e.position.array;for(let e=0,n=o.length;e<n;e+=3)g.set(o[e],o[e+1],o[e+2],1),g.applyMatrix4(j),Y(g,t,r)}}else t.isSprite&&(t.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,t.matrixWorld),g.set(p.elements[12],p.elements[13],p.elements[14],1),g.applyMatrix4(V),Y(g,t,r))}return!0===s&&E(w.elements,0,w.elements.length),w}}}export{RenderableObject,RenderableFace,RenderableVertex,RenderableLine,RenderableSprite,Projector};