import{Style}from"./Style.js";export class Profiler{constructor(){this.tabs={},this.activeTabId=null,this.isResizing=!1,this.lastHeightBottom=350,this.lastWidthRight=450,this.position="bottom",this.detachedWindows=[],this.isMobile=this.detectMobile(),this.maxZIndex=1002,this.nextTabOriginalIndex=0,Style.init(),this.setupShell(),this.setupResizing(),this.isMobile&&this.setupOrientationListener(),this.setupWindowResizeListener()}detectMobile(){const t=navigator.userAgent||navigator.vendor||window.opera,e=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(t),i="ontouchstart"in window||navigator.maxTouchPoints>0,n=window.innerWidth<=768;return e||i&&n}setupOrientationListener(){const t=()=>{const t=window.innerWidth>window.innerHeight?"right":"bottom";this.position!==t&&this.setPosition(t)};t(),window.addEventListener("orientationchange",t),window.addEventListener("resize",t)}setupWindowResizeListener(){const t=()=>{this.detachedWindows.forEach(t=>{this.constrainWindowToBounds(t.panel)})},e=()=>{if(this.panel.classList.contains("maximized"))return;const t=window.innerWidth,e=window.innerHeight;if("bottom"===this.position){const t=e-50;this.panel.offsetHeight>t&&(this.panel.style.height=`${t}px`,this.lastHeightBottom=t)}else if("right"===this.position){const e=t-50;this.panel.offsetWidth>e&&(this.panel.style.width=`${e}px`,this.lastWidthRight=e)}};window.addEventListener("resize",()=>{t(),e()})}constrainWindowToBounds(t){const e=window.innerWidth,i=window.innerHeight,n=t.offsetWidth,s=t.offsetHeight;let o=parseFloat(t.style.left)||t.offsetLeft||0,a=parseFloat(t.style.top)||t.offsetTop||0;const l=n/2,h=s/2;o+n>e+l&&(o=e+l-n),o<-l&&(o=-l),a+s>i+h&&(a=i+h-s),a<-h&&(a=-h),t.style.left=`${o}px`,t.style.top=`${a}px`}setupShell(){this.domElement=document.createElement("div"),this.domElement.id="profiler-shell",this.toggleButton=document.createElement("button"),this.toggleButton.id="profiler-toggle",this.toggleButton.innerHTML='\n<span id="builtin-tabs-container"></span>\n<span id="toggle-text">\n\t<span id="fps-counter">-</span>\n\t<span class="fps-label">FPS</span>\n</span>\n<span id="toggle-icon">\n\t<svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-device-ipad-horizontal-search"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M11.5 20h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v5.5" /><path d="M9 17h2" /><path d="M18 18m-3 0a3 3 0 1 0 6 0a3 3 0 1 0 -6 0" /><path d="M20.2 20.2l1.8 1.8" /></svg>\n</span>\n',this.toggleButton.onclick=()=>this.togglePanel(),this.builtinTabsContainer=this.toggleButton.querySelector("#builtin-tabs-container"),this.miniPanel=document.createElement("div"),this.miniPanel.id="profiler-mini-panel",this.miniPanel.className="profiler-mini-panel",this.panel=document.createElement("div"),this.panel.id="profiler-panel";const t=document.createElement("div");t.className="profiler-header",this.tabsContainer=document.createElement("div"),this.tabsContainer.className="profiler-tabs";const e=document.createElement("div");e.className="profiler-controls",this.floatingBtn=document.createElement("button"),this.floatingBtn.id="floating-btn",this.floatingBtn.title="Switch to Right Side",this.floatingBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="15" y1="3" x2="15" y2="21"></line></svg>',this.floatingBtn.onclick=()=>this.togglePosition(),this.isMobile&&(this.floatingBtn.style.display="none",this.panel.classList.add("hide-position-toggle")),this.maximizeBtn=document.createElement("button"),this.maximizeBtn.id="maximize-btn",this.maximizeBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>',this.maximizeBtn.onclick=()=>this.toggleMaximize();const i=document.createElement("button");i.id="hide-panel-btn",i.textContent="-",i.onclick=()=>this.togglePanel(),e.append(this.floatingBtn,this.maximizeBtn,i),t.append(this.tabsContainer,e),this.contentWrapper=document.createElement("div"),this.contentWrapper.className="profiler-content-wrapper";const n=document.createElement("div");n.className="panel-resizer",this.panel.append(n,t,this.contentWrapper),this.domElement.append(this.toggleButton,this.miniPanel,this.panel),this.panel.classList.add(`position-${this.position}`)}setupResizing(){const t=this.panel.querySelector(".panel-resizer");t.addEventListener("pointerdown",e=>{this.isResizing=!0,this.panel.classList.add("resizing"),t.setPointerCapture(e.pointerId);const i=e.clientX,n=e.clientY,s=this.panel.offsetHeight,o=this.panel.offsetWidth,a=t=>{if(!this.isResizing)return;t.preventDefault();const e=t.clientX,a=t.clientY;if("bottom"===this.position){const t=s-(a-n);t>100&&t<window.innerHeight-50&&(this.panel.style.height=`${t}px`)}else if("right"===this.position){const t=o-(e-i);t>200&&t<window.innerWidth-50&&(this.panel.style.width=`${t}px`)}},l=()=>{this.isResizing=!1,this.panel.classList.remove("resizing"),t.removeEventListener("pointermove",a),t.removeEventListener("pointerup",l),t.removeEventListener("pointercancel",l),this.panel.classList.contains("maximized")||("bottom"===this.position?this.lastHeightBottom=this.panel.offsetHeight:"right"===this.position&&(this.lastWidthRight=this.panel.offsetWidth),this.saveLayout())};t.addEventListener("pointermove",a),t.addEventListener("pointerup",l),t.addEventListener("pointercancel",l)})}toggleMaximize(){this.panel.classList.contains("maximized")?(this.panel.classList.remove("maximized"),"bottom"===this.position?(this.panel.style.height=`${this.lastHeightBottom}px`,this.panel.style.width="100%"):"right"===this.position&&(this.panel.style.height="100%",this.panel.style.width=`${this.lastWidthRight}px`),this.maximizeBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>'):("bottom"===this.position?this.lastHeightBottom=this.panel.offsetHeight:"right"===this.position&&(this.lastWidthRight=this.panel.offsetWidth),this.panel.classList.add("maximized"),"bottom"===this.position?(this.panel.style.height="100vh",this.panel.style.width="100%"):"right"===this.position&&(this.panel.style.height="100%",this.panel.style.width="100vw"),this.maximizeBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="8" width="12" height="12" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>')}addTab(t){this.tabs[t.id]=t,t.originalIndex=this.nextTabOriginalIndex++,!1===t.allowDetach&&t.button.classList.add("no-detach"),t.onVisibilityChange=()=>this.updatePanelSize(),this.setupTabDragAndDrop(t),this.tabsContainer.appendChild(t.button),this.contentWrapper.appendChild(t.content),t.isVisible||(t.button.style.display="none",t.content.style.display="none"),t.builtin&&this.addBuiltinTab(t),this.updatePanelSize()}addBuiltinTab(t){const e=document.createElement("button");e.className="builtin-tab-btn",t.icon?e.innerHTML=t.icon:e.textContent=t.button.textContent.charAt(0).toUpperCase(),e.title=t.button.textContent;const i=document.createElement("div");if(i.className="mini-panel-content",i.style.display="none",t.builtinButton=e,t.miniContent=i,this.miniPanel.appendChild(i),e.onclick=n=>{n.stopPropagation();if(this.panel.classList.contains("visible"))t.isVisible||t.show(),t.isDetached?t.detachedWindow&&this.bringWindowToFront(t.detachedWindow.panel):this.setActiveTab(t.id);else{const n="none"!==i.style.display&&i.children.length>0;if(this.miniPanel.querySelectorAll(".mini-panel-content").forEach(t=>{t.style.display="none"}),this.builtinTabsContainer.querySelectorAll(".builtin-tab-btn").forEach(t=>{t.classList.remove("active")}),n)this.miniPanel.classList.remove("visible"),i.style.display="none",i.firstChild&&t.content.appendChild(i.firstChild);else{if(e.classList.add("active"),!i.firstChild){const e=t.content.querySelector(".list-scroll-wrapper")||t.content.firstElementChild;e&&i.appendChild(e)}i.style.display="block",this.miniPanel.classList.add("visible")}}},this.builtinTabsContainer.appendChild(e),t.builtinButton=e,t.miniContent=i,t.profiler=this,!t.isVisible){e.style.display="none",i.style.display="none";Array.from(this.builtinTabsContainer.querySelectorAll(".builtin-tab-btn")).some(t=>"none"!==t.style.display)||(this.builtinTabsContainer.style.display="none")}}updatePanelSize(){if(Object.values(this.tabs).some(t=>!t.isDetached&&t.isVisible)){if(this.panel.classList.remove("no-tabs"),Object.keys(this.tabs).length>0)if("bottom"===this.position){38===parseInt(this.panel.style.height)&&(this.panel.style.height=`${this.lastHeightBottom}px`)}else if("right"===this.position){45===parseInt(this.panel.style.width)&&(this.panel.style.width=`${this.lastWidthRight}px`)}}else this.panel.classList.add("no-tabs"),this.panel.classList.contains("maximized")&&(this.panel.classList.remove("maximized"),this.maximizeBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>'),"bottom"===this.position?this.panel.style.height="38px":"right"===this.position&&(this.panel.style.width="45px")}setupTabDragAndDrop(t){if(this.isMobile)return void t.button.addEventListener("click",()=>{this.setActiveTab(t.id)});if(!1===t.allowDetach)return t.button.addEventListener("click",()=>{this.setActiveTab(t.id)}),void(t.button.style.cursor="default");let e,i,n=!1,s=!1,o=null;const a=a=>{const l=a.clientX,h=a.clientY,d=Math.abs(l-e),r=Math.abs(h-i);!n&&(d>10||r>10)&&(n=!0,t.button.style.cursor="grabbing",t.button.style.opacity="0.5",t.button.style.transform="scale(1.05)",o=this.createPreviewWindow(t,l,h),o.style.opacity="0.8"),n&&o&&(s=!0,a.preventDefault(),o.style.left=l-200+"px",o.style.top=h-20+"px")},l=()=>{if(n&&s&&o){o.parentNode&&o.parentNode.removeChild(o);const e=parseInt(o.style.left)+200,i=parseInt(o.style.top)+20;this.detachTab(t,e,i)}else s||this.setActiveTab(t.id),o&&o.parentNode&&o.parentNode.removeChild(o);t.button.style.opacity="",t.button.style.transform="",t.button.style.cursor="",n=!1,s=!1,o=null,t.button.removeEventListener("pointermove",a),t.button.removeEventListener("pointerup",l),t.button.removeEventListener("pointercancel",l)};t.button.addEventListener("pointerdown",o=>{(o=>{e=o.clientX,i=o.clientY,n=!1,s=!1,t.button.setPointerCapture(o.pointerId)})(o),t.button.addEventListener("pointermove",a),t.button.addEventListener("pointerup",l),t.button.addEventListener("pointercancel",l)}),t.button.style.cursor="grab"}createPreviewWindow(t,e,i){const n=document.createElement("div");n.className="detached-tab-panel",n.style.left=e-200+"px",n.style.top=i-20+"px",n.style.pointerEvents="none",this.maxZIndex++,n.style.setProperty("z-index",this.maxZIndex,"important");const s=document.createElement("div");s.className="detached-tab-header";const o=document.createElement("span");o.textContent=t.button.textContent.replace("⇱","").trim(),s.appendChild(o);const a=document.createElement("div");a.className="detached-header-controls";const l=document.createElement("button");l.className="detached-reattach-btn",l.innerHTML="↩",a.appendChild(l),s.appendChild(a);const h=document.createElement("div");h.className="detached-tab-content";const d=document.createElement("div");return d.className="detached-tab-resizer",n.appendChild(d),n.appendChild(s),n.appendChild(h),document.body.appendChild(n),n}detachTab(t,e,i){if(t.isDetached)return;if(!1===t.allowDetach)return;const n=Array.from(this.tabsContainer.children).map(t=>Object.keys(this.tabs).find(e=>this.tabs[e].button===t)).filter(t=>void 0!==t),s=n.indexOf(t.id);let o=null;if(this.activeTabId===t.id){t.setActive(!1);const e=n.filter(e=>e!==t.id&&!this.tabs[e].isDetached&&this.tabs[e].isVisible);if(e.length>0){for(let t=s-1;t>=0;t--)if(e.includes(n[t])){o=n[t];break}if(!o)for(let t=s+1;t<n.length;t++)if(e.includes(n[t])){o=n[t];break}o||(o=e[0])}}t.button.parentNode&&t.button.parentNode.removeChild(t.button),t.content.parentNode&&t.content.parentNode.removeChild(t.content);const a=this.createDetachedWindow(t,e,i);this.detachedWindows.push(a),t.isDetached=!0,t.detachedWindow=a,o?this.setActiveTab(o):this.activeTabId===t.id&&(this.activeTabId=null),this.updatePanelSize(),this.saveLayout()}createDetachedWindow(t,e,i){const n=window.innerWidth,s=window.innerHeight;let o=e-200,a=i-20;o+400>n&&(o=n-400),o<0&&(o=0),a+300>s&&(a=s-300),a<0&&(a=0);const l=document.createElement("div");l.className="detached-tab-panel",l.style.left=`${o}px`,l.style.top=`${a}px`,this.panel.classList.contains("visible")||(l.style.opacity="0",l.style.visibility="hidden",l.style.pointerEvents="none"),t.isVisible||(l.style.display="none");const h=document.createElement("div");h.className="detached-tab-header";const d=document.createElement("span");d.textContent=t.button.textContent.replace("⇱","").trim(),h.appendChild(d);const r=document.createElement("div");r.className="detached-header-controls";const c=document.createElement("button");c.className="detached-reattach-btn",c.innerHTML="↩",c.title="Reattach to main panel",c.onclick=()=>this.reattachTab(t),r.appendChild(c),h.appendChild(r);const p=document.createElement("div");p.className="detached-tab-content",p.appendChild(t.content),t.content.style.display="block",t.content.classList.add("active");const b=document.createElement("div");b.className="detached-tab-resizer-top";const m=document.createElement("div");m.className="detached-tab-resizer-right";const g=document.createElement("div");g.className="detached-tab-resizer-bottom";const u=document.createElement("div");u.className="detached-tab-resizer-left";const v=document.createElement("div");return v.className="detached-tab-resizer",l.appendChild(b),l.appendChild(m),l.appendChild(g),l.appendChild(u),l.appendChild(v),l.appendChild(h),l.appendChild(p),document.body.appendChild(l),this.setupDetachedWindowDrag(l,h,t),this.setupDetachedWindowResize(l,b,m,g,u,v),l.style.setProperty("z-index",this.maxZIndex,"important"),{panel:l,tab:t}}bringWindowToFront(t){this.maxZIndex++,t.style.setProperty("z-index",this.maxZIndex,"important")}setupDetachedWindowDrag(t,e,i){let n,s,o,a,l=!1;t.addEventListener("pointerdown",()=>{this.bringWindowToFront(t)});const h=i=>{if(i.target.classList.contains("detached-reattach-btn"))return;this.bringWindowToFront(t),l=!0,e.style.cursor="grabbing",e.setPointerCapture(i.pointerId),n=i.clientX,s=i.clientY;const h=t.getBoundingClientRect();o=h.left,a=h.top},d=e=>{if(!l)return;e.preventDefault();const i=e.clientX,h=e.clientY;let d=o+(i-n),r=a+(h-s);const c=window.innerWidth,p=window.innerHeight,b=t.offsetWidth,m=t.offsetHeight,g=b/2,u=m/2;d+b>c+g&&(d=c+g-b),d<-g&&(d=-g),r+m>p+u&&(r=p+u-m),r<-u&&(r=-u),t.style.left=`${d}px`,t.style.top=`${r}px`;const v=this.panel.getBoundingClientRect();i>=v.left&&i<=v.right&&h>=v.top&&h<=v.bottom?(t.style.opacity="0.5",this.panel.style.outline="2px solid var(--accent-color)"):(t.style.opacity="",this.panel.style.outline="")},r=n=>{if(!l)return;l=!1,e.style.cursor="",t.style.opacity="",this.panel.style.outline="";const s=n.clientX,o=n.clientY;if(void 0!==s&&void 0!==o){const t=this.panel.getBoundingClientRect();s>=t.left&&s<=t.right&&o>=t.top&&o<=t.bottom&&i?this.reattachTab(i):this.saveLayout()}e.removeEventListener("pointermove",d),e.removeEventListener("pointerup",r),e.removeEventListener("pointercancel",r)};e.addEventListener("pointerdown",t=>{h(t),e.addEventListener("pointermove",d),e.addEventListener("pointerup",r),e.addEventListener("pointercancel",r)}),e.style.cursor="grab"}setupDetachedWindowResize(t,e,i,n,s,o){const a=(e,i)=>{let n,s,o,a,l,h,d=!1;const r=i=>{i.preventDefault(),i.stopPropagation(),d=!0,this.bringWindowToFront(t),e.setPointerCapture(i.pointerId),n=i.clientX,s=i.clientY,o=t.offsetWidth,a=t.offsetHeight,l=t.offsetLeft,h=t.offsetTop},c=e=>{if(!d)return;e.preventDefault();const r=e.clientX,c=e.clientY,p=r-n,b=c-s,m=window.innerWidth,g=window.innerHeight;if("right"===i||"corner"===i){const e=o+p;e>=250&&e<=m-l&&(t.style.width=`${e}px`)}if("bottom"===i||"corner"===i){const e=a+b;e>=150&&e<=g-h&&(t.style.height=`${e}px`)}if("left"===i){const e=o-p;if(e>=250){const i=l+p;i>=0&&i<=l+o-250&&(t.style.width=`${e}px`,t.style.left=`${i}px`)}}if("top"===i){const e=a-b;if(e>=150){const i=h+b;i>=0&&i<=h+a-150&&(t.style.height=`${e}px`,t.style.top=`${i}px`)}}},p=()=>{d=!1,e.removeEventListener("pointermove",c),e.removeEventListener("pointerup",p),e.removeEventListener("pointercancel",p),this.saveLayout()};e.addEventListener("pointerdown",t=>{r(t),e.addEventListener("pointermove",c),e.addEventListener("pointerup",p),e.addEventListener("pointercancel",p)})};a(e,"top"),a(i,"right"),a(n,"bottom"),a(s,"left"),a(o,"corner")}reattachTab(t){if(!t.isDetached)return;if(t.detachedWindow){const e=this.detachedWindows.indexOf(t.detachedWindow);e>-1&&this.detachedWindows.splice(e,1),t.detachedWindow.panel.parentNode&&t.detachedWindow.panel.parentNode.removeChild(t.detachedWindow.panel),t.detachedWindow=null}t.isDetached=!1;const e=Object.values(this.tabs).filter(t=>void 0!==t.originalIndex&&t.isVisible).sort((t,e)=>t.originalIndex-e.originalIndex),i=Array.from(this.tabsContainer.children);let n=0;for(const i of e){if(i.id===t.id)break;i.isDetached||n++}n>=i.length||0===i.length?this.tabsContainer.appendChild(t.button):this.tabsContainer.insertBefore(t.button,i[n]),this.contentWrapper.appendChild(t.content),this.setActiveTab(t.id),this.updatePanelSize(),this.saveLayout()}setActiveTab(t){this.activeTabId&&this.tabs[this.activeTabId]&&!this.tabs[this.activeTabId].isDetached&&this.tabs[this.activeTabId].setActive(!1),this.activeTabId=t,this.tabs[t]&&this.tabs[t].setActive(!0)}togglePanel(){this.panel.classList.toggle("visible"),this.toggleButton.classList.toggle("hidden");const t=this.panel.classList.contains("visible");if(t)this.savedMiniPanelState={isVisible:this.miniPanel.classList.contains("visible"),activeTabId:null,contentMap:{}},this.miniPanel.querySelectorAll(".mini-panel-content").forEach(t=>{"none"!==t.style.display&&t.firstChild&&Object.values(this.tabs).forEach(e=>{e.miniContent===t&&(this.savedMiniPanelState.activeTabId=e.id,e.content.appendChild(t.firstChild))})}),this.miniPanel.classList.remove("visible"),this.miniPanel.querySelectorAll(".mini-panel-content").forEach(t=>{t.style.display="none"}),this.builtinTabsContainer.querySelectorAll(".builtin-tab-btn").forEach(t=>{t.classList.remove("active")});else if(this.savedMiniPanelState&&this.savedMiniPanelState.isVisible&&this.savedMiniPanelState.activeTabId){const t=this.tabs[this.savedMiniPanelState.activeTabId];if(t&&t.miniContent&&t.builtinButton){this.miniPanel.classList.add("visible"),t.miniContent.style.display="block",t.builtinButton.classList.add("active");const e=t.content.querySelector(".list-scroll-wrapper, .profiler-content > *");e&&t.miniContent.appendChild(e)}}this.detachedWindows.forEach(e=>{t?(e.panel.style.opacity="",e.panel.style.visibility="",e.panel.style.pointerEvents=""):(e.panel.style.opacity="0",e.panel.style.visibility="hidden",e.panel.style.pointerEvents="none")})}togglePosition(){const t="bottom"===this.position?"right":"bottom";this.setPosition(t)}setPosition(t){if(this.position===t)return;this.panel.style.transition="none";const e=this.panel.classList.contains("maximized");"right"===t?(this.position="right",this.floatingBtn.classList.add("active"),this.floatingBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M3 15h18"></path></svg>',this.floatingBtn.title="Switch to Bottom",this.panel.classList.remove("position-bottom"),this.panel.classList.add("position-right"),this.panel.style.bottom="",this.panel.style.top="0",this.panel.style.right="0",this.panel.style.left="",e?(this.panel.style.width="100vw",this.panel.style.height="100%"):(this.panel.style.width=`${this.lastWidthRight}px`,this.panel.style.height="100%")):(this.position="bottom",this.floatingBtn.classList.remove("active"),this.floatingBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="15" y1="3" x2="15" y2="21"></line></svg>',this.floatingBtn.title="Switch to Right Side",this.panel.classList.remove("position-right"),this.panel.classList.add("position-bottom"),this.panel.style.top="",this.panel.style.right="",this.panel.style.bottom="0",this.panel.style.left="0",e?(this.panel.style.width="100%",this.panel.style.height="100vh"):(this.panel.style.width="100%",this.panel.style.height=`${this.lastHeightBottom}px`)),setTimeout(()=>{this.panel.style.transition=""},50),this.updatePanelSize(),this.saveLayout()}saveLayout(){const t={position:this.position,lastHeightBottom:this.lastHeightBottom,lastWidthRight:this.lastWidthRight,activeTabId:this.activeTabId,detachedTabs:[]};this.detachedWindows.forEach(e=>{const i=e.tab,n=e.panel,s=parseFloat(n.style.left)||n.offsetLeft||0,o=parseFloat(n.style.top)||n.offsetTop||0,a=n.offsetWidth,l=n.offsetHeight;t.detachedTabs.push({tabId:i.id,originalIndex:void 0!==i.originalIndex?i.originalIndex:0,left:s,top:o,width:a,height:l})});try{localStorage.setItem("profiler-layout",JSON.stringify(t))}catch(t){console.warn("Failed to save profiler layout:",t)}}loadLayout(){try{const t=localStorage.getItem("profiler-layout");if(!t)return;const e=JSON.parse(t);if(e.detachedTabs&&e.detachedTabs.length>0){const t=window.innerWidth,i=window.innerHeight;e.detachedTabs=e.detachedTabs.map(e=>{let{left:n,top:s,width:o,height:a}=e;o>t&&(o=t-100),a>i&&(a=i-100);const l=o/2,h=a/2;return n+o>t+l&&(n=t+l-o),n<-l&&(n=-l),s+a>i+h&&(s=i+h-a),s<-h&&(s=-h),{...e,left:n,top:s,width:o,height:a}})}e.position&&(this.position=e.position),e.lastHeightBottom&&(this.lastHeightBottom=e.lastHeightBottom),e.lastWidthRight&&(this.lastWidthRight=e.lastWidthRight);const i=window.innerWidth,n=window.innerHeight;if(this.lastHeightBottom>n-50&&(this.lastHeightBottom=n-50),this.lastWidthRight>i-50&&(this.lastWidthRight=i-50),"right"===this.position?(this.floatingBtn.classList.add("active"),this.floatingBtn.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M3 15h18"></path></svg>',this.floatingBtn.title="Switch to Bottom",this.panel.classList.remove("position-bottom"),this.panel.classList.add("position-right"),this.panel.style.bottom="",this.panel.style.top="0",this.panel.style.right="0",this.panel.style.left="",this.panel.style.width=`${this.lastWidthRight}px`,this.panel.style.height="100%"):this.panel.style.height=`${this.lastHeightBottom}px`,e.activeTabId){e.detachedTabs&&e.detachedTabs.some(t=>t.tabId===e.activeTabId)&&this.setActiveTab(e.activeTabId)}e.detachedTabs&&e.detachedTabs.length>0&&(this.pendingDetachedTabs=e.detachedTabs,this.restoreDetachedTabs()),this.updatePanelSize()}catch(t){console.warn("Failed to load profiler layout:",t)}}restoreDetachedTabs(){if(!this.pendingDetachedTabs||0===this.pendingDetachedTabs.length)return;this.pendingDetachedTabs.forEach(t=>{const e=this.tabs[t.tabId];if(!e||e.isDetached)return;void 0!==t.originalIndex&&(e.originalIndex=t.originalIndex),e.button.parentNode&&e.button.parentNode.removeChild(e.button),e.content.parentNode&&e.content.parentNode.removeChild(e.content);const i=this.createDetachedWindow(e,0,0);i.panel.style.left=`${t.left}px`,i.panel.style.top=`${t.top}px`,i.panel.style.width=`${t.width}px`,i.panel.style.height=`${t.height}px`,this.constrainWindowToBounds(i.panel),this.detachedWindows.push(i),e.isDetached=!0,e.detachedWindow=i}),this.pendingDetachedTabs=null,this.detachedWindows.forEach(t=>{const e=parseInt(getComputedStyle(t.panel).zIndex)||0;e>this.maxZIndex&&(this.maxZIndex=e)});if(!this.activeTabId||!this.tabs[this.activeTabId]||this.tabs[this.activeTabId].isDetached||!this.tabs[this.activeTabId].isVisible){const t=Object.keys(this.tabs).filter(t=>!this.tabs[t].isDetached&&this.tabs[t].isVisible);if(t.length>0){const e=Array.from(this.tabsContainer.children).map(t=>Object.keys(this.tabs).find(e=>this.tabs[e].button===t)).filter(t=>void 0!==t&&!this.tabs[t].isDetached&&this.tabs[t].isVisible);this.setActiveTab(e[0]||t[0])}else this.activeTabId=null}this.updatePanelSize()}}