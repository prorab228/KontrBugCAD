import{Tab}from"../ui/Tab.js";import{List}from"../ui/List.js";import{Graph}from"../ui/Graph.js";import{Item}from"../ui/Item.js";import{createValueSpan,setText}from"../ui/utils.js";class Performance extends Tab{constructor(e={}){super("Performance",e);const t=new List("Name","CPU","GPU","Total");t.setGridStyle("minmax(200px, 2fr) 80px 80px 80px"),t.domElement.style.minWidth="600px";const a=document.createElement("div");a.className="list-scroll-wrapper",a.appendChild(t.domElement),this.content.appendChild(a);const s=document.createElement("div");s.className="graph-container";const n=new Graph;n.addLine("fps","--accent-color"),s.append(n.domElement);const r=new Item("Graph Stats",createValueSpan(),createValueSpan(),createValueSpan("graph-fps-counter"));t.add(r);const i=new Item(s);i.itemRow.childNodes[0].style.gridColumn="1 / -1",r.add(i);const o=new Item("Frame Stats",createValueSpan(),createValueSpan(),createValueSpan());t.add(o);const m=new Item("Miscellaneous & Idle",createValueSpan(),createValueSpan(),createValueSpan());m.domElement.firstChild.style.backgroundColor="#00ff0b1a",m.domElement.firstChild.classList.add("no-hover"),o.add(m),this.notInUse=new Map,this.frameStats=o,this.graphStats=r,this.graph=n,this.miscellaneous=m,this.currentRender=null,this.currentItem=null,this.frameItems=new Map}resolveStats(e,t){const a=e.getStatsData(t.cid);let s=a.item;if(void 0===s)s=new Item(createValueSpan(),createValueSpan(),createValueSpan(),createValueSpan()),t.name?!0===t.isComputeStats&&(t.name=`${t.name} [ Compute ]`):t.name=`Unnamed ${t.cid}`,s.userData.name=t.name,this.currentItem.add(s),a.item=s;else{s.userData.name=t.name,this.notInUse.has(t.cid)&&(s.domElement.firstElementChild.classList.remove("alert"),this.notInUse.delete(t.cid));const e=t.parent.children.indexOf(t);null!==s.parent&&s.parent.children.indexOf(s)===e||this.currentItem.add(s,e)}let n=s.userData.name;t.isComputeStats&&(n+=" [ Compute ]"),setText(s.data[0],n),setText(s.data[1],a.cpu.toFixed(2)),setText(s.data[2],!0===t.gpuNotAvailable?"-":a.gpu.toFixed(2)),setText(s.data[3],a.total.toFixed(2));const r=this.currentItem;this.currentItem=s;for(const a of t.children)this.resolveStats(e,a);this.currentItem=r,this.frameItems.set(t.cid,s)}updateGraph(e){this.graph.addPoint("fps",e.fps),this.graph.update()}addNotInUse(e,t){t.domElement.firstElementChild.classList.add("alert"),this.notInUse.set(e,{item:t,time:performance.now()}),this.updateNotInUse(e)}updateNotInUse(e){const{item:t,time:a}=this.notInUse.get(e),s=performance.now(),n=5-Math.floor((s-a)/1e3);if(n>=0){const e="*".repeat(Math.max(0,n)),a=t.domElement.querySelector(".list-item-cell .value");setText(a,t.userData.name+" (not in use) "+e)}else t.domElement.firstElementChild.classList.remove("alert"),t.parent.remove(t),this.notInUse.delete(e)}updateText(e,t){const a=new Map(this.frameItems);this.frameItems.clear(),this.currentItem=this.frameStats;for(const a of t.children)this.resolveStats(e,a);for(const[e,t]of a)this.frameItems.has(e)||(this.addNotInUse(e,t),a.delete(e));for(const e of this.notInUse.keys())this.updateNotInUse(e);setText("graph-fps-counter",e.fps.toFixed()+" FPS"),setText(this.frameStats.data[1],t.cpu.toFixed(2)),setText(this.frameStats.data[2],t.gpu.toFixed(2)),setText(this.frameStats.data[3],t.total.toFixed(2)),setText(this.miscellaneous.data[1],t.miscellaneous.toFixed(2)),setText(this.miscellaneous.data[2],"-"),setText(this.miscellaneous.data[3],t.miscellaneous.toFixed(2)),this.currentItem=null}}export{Performance};