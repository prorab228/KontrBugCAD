import{InspectorBase,TimestampQuery,warnOnce}from"three/webgpu";class ObjectStats{constructor(e,t){this.uid=e,this.cid=e.match(/^(.*):f(\d+)$/)[1],this.name=t,this.timestamp=0,this.cpu=0,this.gpu=0,this.fps=0,this.children=[],this.parent=null}}class RenderStats extends ObjectStats{constructor(e,t,s,r){let i=t.name;""===i&&(t.isScene?i="Scene":t.isQuadMesh&&(i="QuadMesh")),super(e,i),this.scene=t,this.camera=s,this.renderTarget=r,this.isRenderStats=!0}}class ComputeStats extends ObjectStats{constructor(e,t){super(e,t.name),this.computeNode=t,this.isComputeStats=!0}}export class RendererInspector extends InspectorBase{constructor(){super(),this.currentFrame=null,this.currentRender=null,this.currentNodes=null,this.lastFrame=null,this.frames=[],this.framesLib={},this.maxFrames=512,this._lastFinishTime=0,this._resolveTimestampPromise=null,this.isRendererInspector=!0}getParent(){return this.currentRender||this.getFrame()}begin(){this.currentFrame=this._createFrame(),this.currentRender=this.currentFrame,this.currentNodes=[]}finish(){const e=performance.now(),t=this.currentFrame;t.finishTime=e,t.deltaTime=e-(this._lastFinishTime>0?this._lastFinishTime:e),this.addFrame(t),this.fps=this._getFPS(),this.lastFrame=t,this.currentFrame=null,this.currentRender=null,this.currentNodes=null,this._lastFinishTime=e}_getFPS(){let e=0,t=0;for(let s=this.frames.length-1;s>=0;s--){if(e++,t+=this.frames[s].deltaTime,t>=1e3)break}return 1e3*e/t}_createFrame(){return{frameId:this.nodeFrame.frameId,resolvedCompute:!1,resolvedRender:!1,deltaTime:0,startTime:performance.now(),finishTime:0,miscellaneous:0,children:[],renders:[],computes:[]}}getFrame(){return this.currentFrame||this.lastFrame}getFrameById(e){return this.framesLib[e]||null}resolveViewer(){}resolveFrame(){}async resolveTimestamp(){return null!==this._resolveTimestampPromise||(this._resolveTimestampPromise=new Promise(e=>{requestAnimationFrame(async()=>{const t=this.getRenderer();await t.resolveTimestampsAsync(TimestampQuery.COMPUTE),await t.resolveTimestampsAsync(TimestampQuery.RENDER);const s=t.backend.getTimestampFrames(TimestampQuery.COMPUTE),r=t.backend.getTimestampFrames(TimestampQuery.RENDER),i=[...new Set([...s,...r])];for(const e of i){const i=this.getFrameById(e);if(null!==i){if(!1===i.resolvedCompute)if(i.computes.length>0){if(s.includes(e)){for(const e of i.computes)t.backend.hasTimestamp(e.uid)?e.gpu=t.backend.getTimestamp(e.uid):(e.gpu=0,e.gpuNotAvailable=!0);i.resolvedCompute=!0}}else i.resolvedCompute=!0;if(!1===i.resolvedRender)if(i.renders.length>0){if(r.includes(e)){for(const e of i.renders)t.backend.hasTimestamp(e.uid)?e.gpu=t.backend.getTimestamp(e.uid):(e.gpu=0,e.gpuNotAvailable=!0);i.resolvedRender=!0}}else i.resolvedRender=!0;!0===i.resolvedCompute&&!0===i.resolvedRender&&this.resolveFrame(i)}}this._resolveTimestampPromise=null,e()})})),this._resolveTimestampPromise}get isAvailable(){return null!==this.getRenderer()}addFrame(e){if(this.frames.length>=this.maxFrames){const e=this.frames.shift();delete this.framesLib[e.frameId]}this.frames.push(e),this.framesLib[e.frameId]=e,this.isAvailable&&(this.resolveViewer(),this.resolveTimestamp())}inspect(e){const t=this.currentNodes;null!==t?t.push(e):warnOnce('RendererInspector: Unable to inspect node outside of frame scope. Use "renderer.setAnimationLoop()".')}beginCompute(e,t){const s=this.getFrame();if(!s)return;const r=new ComputeStats(e,t);r.timestamp=performance.now(),r.parent=this.currentCompute||this.getParent(),s.computes.push(r),null!==this.currentRender?this.currentRender.children.push(r):s.children.push(r),this.currentCompute=r}finishCompute(){if(!this.getFrame())return;const e=this.currentCompute;e.cpu=performance.now()-e.timestamp,this.currentCompute=e.parent.isComputeStats?e.parent:null}beginRender(e,t,s,r){const i=this.getFrame();if(!i)return;const n=new RenderStats(e,t,s,r);n.timestamp=performance.now(),n.parent=this.getParent(),i.renders.push(n),null!==this.currentRender?this.currentRender.children.push(n):i.children.push(n),this.currentRender=n}finishRender(){if(!this.getFrame())return;const e=this.currentRender;e.cpu=performance.now()-e.timestamp,this.currentRender=e.parent}}