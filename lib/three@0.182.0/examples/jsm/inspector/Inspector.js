import{RendererInspector}from"./RendererInspector.js";import{Profiler}from"./ui/Profiler.js";import{Performance}from"./tabs/Performance.js";import{Console}from"./tabs/Console.js";import{Parameters}from"./tabs/Parameters.js";import{Viewer}from"./tabs/Viewer.js";import{setText,splitPath,splitCamelCase}from"./ui/utils.js";import{QuadMesh,NodeMaterial,CanvasTarget,setConsoleFunction,REVISION,NoToneMapping}from"three/webgpu";import{renderOutput,vec2,vec3,vec4,Fn,screenUV,step,OnMaterialUpdate,uniform}from"three/tsl";const aspectRatioUV=Fn(([e,t])=>{const s=uniform(0);OnMaterialUpdate(()=>{const{width:e,height:a}=t.value;s.value=e/a});const a=e.sub(.5),i=vec2(a.x.div(s),a.y).add(.5),r=step(0,i.x).mul(step(i.x,1)).mul(step(0,i.y)).mul(step(i.y,1));return vec3(i,r)});class Inspector extends RendererInspector{constructor(){super();const e=new Profiler,t=new Parameters({builtin:!0,icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 6m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M4 6l8 0" /><path d="M16 6l4 0" /><path d="M8 12m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M4 12l2 0" /><path d="M10 12l10 0" /><path d="M17 18m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0" /><path d="M4 18l11 0" /><path d="M19 18l1 0" /></svg>'});t.hide(),e.addTab(t);const s=new Viewer;s.hide(),e.addTab(s);const a=new Performance;e.addTab(a);const i=new Console;e.addTab(i),e.loadLayout(),e.activeTabId||e.setActiveTab(a.id),this.statsData=new Map,this.canvasNodes=new Map,this.profiler=e,this.performance=a,this.console=i,this.parameters=t,this.viewer=s,this.once={},this.displayCycle={text:{needsUpdate:!1,duration:.25,time:0},graph:{needsUpdate:!1,duration:.02,time:0}}}get domElement(){return this.profiler.domElement}resolveConsoleOnce(e,t){const s=e+t;!0!==this.once[s]&&(this.resolveConsole(e,t),this.once[s]=!0)}resolveConsole(e,t){switch(e){case"log":this.console.addMessage("info",t),console.log(t);break;case"warn":this.console.addMessage("warn",t),console.warn(t);break;case"error":this.console.addMessage("error",t),console.error(t)}}init(){const e=this.getRenderer();let t=`THREE.WebGPURenderer: ${REVISION} [ "`;e.backend.isWebGPUBackend?t+="WebGPU":e.backend.isWebGLBackend&&(t+="WebGL2"),t+='" ]',this.console.addMessage("info",t),null===e.inspector.domElement.parentElement&&null!==e.domElement.parentElement&&e.domElement.parentElement.appendChild(e.inspector.domElement)}setRenderer(e){return super.setRenderer(e),null!==e&&(setConsoleFunction(this.resolveConsole.bind(this)),this.isAvailable&&(e.backend.trackTimestamp=!0,e.init().then(()=>{!0!==e.hasFeature("timestamp-query")&&this.console.addMessage("error","THREE.Inspector: GPU Timestamp Queries not available.")}))),this}createParameters(e){return!1===this.parameters.isVisible&&(this.parameters.show(),!1===this.parameters.isDetached&&this.profiler.setActiveTab(this.parameters.id)),this.parameters.createGroup(e)}getStatsData(e){let t=this.statsData.get(e);return void 0===t&&(t={},this.statsData.set(e,t)),t}resolveStats(e){const t=this.getStatsData(e.cid);!0!==t.initialized&&(t.cpu=e.cpu,t.gpu=e.gpu,t.stats=[],t.initialized=!0),t.stats.length>this.maxFrames&&t.stats.shift(),t.stats.push(e),t.cpu=this.getAverageDeltaTime(t,"cpu"),t.gpu=this.getAverageDeltaTime(t,"gpu"),t.total=t.cpu+t.gpu;for(const s of e.children){this.resolveStats(s);const e=this.getStatsData(s.cid);t.cpu+=e.cpu,t.gpu+=e.gpu,t.total+=e.total}}getCanvasDataByNode(e){let t=this.canvasNodes.get(e);if(void 0===t){const s=this.getRenderer(),a=document.createElement("canvas"),i=new CanvasTarget(a);i.setPixelRatio(window.devicePixelRatio),i.setSize(140,140);const r=e.id,{path:o,name:n}=splitPath(splitCamelCase(e.getName()||"(unnamed)")),l=e.context({getUV:e=>{const t=aspectRatioUV(screenUV,e),s=t.xy,a=t.z;return s.mul(a)}});let d=vec4(vec3(l),1);d=renderOutput(d,NoToneMapping,s.outputColorSpace),d=d.context({inspector:!0});const c=new NodeMaterial;c.outputNode=d;const p=new QuadMesh(c);p.name="Viewer - "+n,t={id:r,name:n,path:o,node:e,quad:p,canvasTarget:i,material:c},this.canvasNodes.set(e,t)}return t}resolveViewer(){const e=this.currentNodes,t=this.getRenderer();if(0===e.length)return;if(!t.backend.isWebGPUBackend)return void this.resolveConsoleOnce("warn","Inspector: Viewer is only available with WebGPU.");this.viewer.isVisible||this.viewer.show();const s=e.map(e=>this.getCanvasDataByNode(e));this.viewer.update(t,s)}getAverageDeltaTime(e,t,s=this.fps){const a=e.stats;let i=0,r=0;for(let e=a.length-1;e>=0&&r<s;e--){const s=a[e][t];s>0&&(i+=s,r++)}return r>0?i/r:0}resolveFrame(e){const t=this.getFrameById(e.frameId+1);if(t){e.cpu=0,e.gpu=0,e.total=0;for(const t of e.children){this.resolveStats(t);const s=this.getStatsData(t.cid);e.cpu+=s.cpu,e.gpu+=s.gpu,e.total+=s.total}e.deltaTime=t.startTime-e.startTime,e.miscellaneous=e.deltaTime-e.total,e.miscellaneous<0&&(e.miscellaneous=0),this.updateCycle(this.displayCycle.text),this.updateCycle(this.displayCycle.graph),this.displayCycle.text.needsUpdate&&(setText("fps-counter",this.fps.toFixed()),this.performance.updateText(this,e)),this.displayCycle.graph.needsUpdate&&this.performance.updateGraph(this,e),this.displayCycle.text.needsUpdate=!1,this.displayCycle.graph.needsUpdate=!1}}updateCycle(e){e.time+=this.nodeFrame.deltaTime,e.time>=e.duration&&(e.needsUpdate=!0,e.time=0)}}export{Inspector};