import{RenderTarget,Vector2,TempNode,QuadMesh,NodeMaterial,RendererUtils,MathUtils}from"three/webgpu";import{clamp,normalize,reference,nodeObject,Fn,NodeUpdateType,uniform,vec4,passTexture,uv,logarithmicDepthToViewZ,viewZToPerspectiveDepth,getViewPosition,screenCoordinate,float,sub,fract,dot,vec2,rand,vec3,Loop,mul,PI,cos,sin,uint,cross,acos,sign,pow,luminance,If,max,abs,Break,sqrt,HALF_PI,div,ceil,shiftRight,convertToTexture,bool,getNormalFromDepth,countOneBits,interleavedGradientNoise}from"three/tsl";const _quadMesh=new QuadMesh,_size=new Vector2,_temporalRotations=[60,300,180,240,120,0],_spatialOffsets=[0,.5,.25,.75];let _rendererState;class SSGINode extends TempNode{static get type(){return"SSGINode"}constructor(e,t,s,o){super("vec4"),this.beautyNode=e,this.depthNode=t,this.normalNode=s,this.updateBeforeType=NodeUpdateType.FRAME,this.sliceCount=uniform(1,"uint"),this.stepCount=uniform(12,"uint"),this.aoIntensity=uniform(1,"float"),this.giIntensity=uniform(10,"float"),this.radius=uniform(12,"float"),this.useScreenSpaceSampling=uniform(!0,"bool"),this.expFactor=uniform(2,"float"),this.thickness=uniform(1,"float"),this.useLinearThickness=uniform(!1,"bool"),this.backfaceLighting=uniform(0,"float"),this.useTemporalFiltering=!0,this._resolution=uniform(new Vector2),this._halfProjScale=uniform(1),this._temporalDirection=uniform(0),this._temporalOffset=uniform(0),this._cameraProjectionMatrix=uniform(o.projectionMatrix),this._cameraProjectionMatrixInverse=uniform(o.projectionMatrixInverse),this._cameraNear=reference("near","float",o),this._cameraFar=reference("far","float",o),this._camera=o,this._ssgiRenderTarget=new RenderTarget(1,1,{depthBuffer:!1}),this._ssgiRenderTarget.texture.name="SSGI",this._material=new NodeMaterial,this._material.name="SSGI",this._textureNode=passTexture(this,this._ssgiRenderTarget.texture)}getTextureNode(){return this._textureNode}setSize(e,t){this._resolution.value.set(e,t),this._ssgiRenderTarget.setSize(e,t),this._halfProjScale.value=t/(2*Math.tan(this._camera.fov*MathUtils.DEG2RAD*.5))*.5}updateBefore(e){const{renderer:t}=e;_rendererState=RendererUtils.resetRendererState(t,_rendererState);const s=t.getDrawingBufferSize(_size);if(this.setSize(s.width,s.height),!0===this.useTemporalFiltering){const t=e.frameId;this._temporalDirection.value=_temporalRotations[t%6]/360,this._temporalOffset.value=_spatialOffsets[t%4]}else this._temporalDirection.value=1,this._temporalOffset.value=1;_quadMesh.material=this._material,_quadMesh.name="SSGI",t.setClearColor(0,1),t.setRenderTarget(this._ssgiRenderTarget),_quadMesh.render(t),RendererUtils.restoreRendererState(t,_rendererState)}setup(e){const t=uv(),s=uint(32),o=uint(0),a=t=>{const s=this.depthNode.sample(t).r;if(!0===e.renderer.logarithmicDepthBuffer){const e=logarithmicDepthToViewZ(s,this._cameraNear,this._cameraFar);return viewZToPerspectiveDepth(e,this._cameraNear,this._cameraFar)}return s},i=e=>null!==this.normalNode?this.normalNode.sample(e).rgb.normalize():getNormalFromDepth(e,this.depthNode.value,this._cameraProjectionMatrixInverse),n=e=>this.beautyNode.sample(e),r=Fn(([e])=>float(.25).mul(sub(e.y,e.x).bitAnd(3))).setLayout({name:"spatialOffsets",type:"float",inputs:[{name:"position",type:"vec2"}]}),l=Fn(([e])=>{const t=abs(e).mul(float(-.156583)).add(HALF_PI);t.mulAssign(sqrt(abs(e).oneMinus()));const s=e.x.greaterThanEqual(0).select(t.x,PI.sub(t.x)),o=e.y.greaterThanEqual(0).select(t.y,PI.sub(t.y));return vec2(s,o)}).setLayout({name:"GTAOFastAcos",type:"vec2",inputs:[{name:"value",type:"vec2"}]}),u=Fn(([e,t,r,u,c,d,h,m,f])=>{const p=this.stepCount.toConst(),g=this.expFactor.toConst(),_=this.thickness.toConst(),v=this.backfaceLighting.toConst(),T=float(0);If(this.useScreenSpaceSampling.equal(!0),()=>{T.assign(t.mul(this._resolution.x.div(2)).div(float(16)))}).Else(()=>{T.assign(max(t.mul(this._halfProjScale).div(r.z.negate()),float(p)))}),T.divAssign(float(p).add(1));const x=max(1,float(p.sub(1))).mul(T),b=e.equal(!0).select(vec2(1,-1),vec2(-1,1)),C=e.equal(!0).select(1,-1),S=vec3(0),I=vec3(r).toVar();return Loop({start:uint(0),end:p,type:"uint",condition:"<"},({i:t})=>{const p=pow(abs(mul(T,float(t).add(c)).div(x)),g).mul(x).toConst(),N=u.mul(max(p,float(t).add(1))).toConst(),y=d.add(N.mul(b)).toConst();If(y.x.lessThanEqual(0).or(y.y.lessThanEqual(0)).or(y.x.greaterThanEqual(1)).or(y.y.greaterThanEqual(1)),()=>{Break()});const M=getViewPosition(y,a(y),this._cameraProjectionMatrixInverse).toConst(),P=M.sub(r).normalize().toConst(),F=this.useLinearThickness.equal(!0).select(M.z.negate().div(this._cameraFar).clamp().mul(100),float(1)),R=normalize(M.sub(F.mul(h).mul(_)).sub(r));let w=vec2(dot(P,h),dot(R,h));w=l(clamp(w,-1,1)),w=clamp(div(mul(C,w.negate()).sub(f.sub(HALF_PI)),PI)),w=e.equal(!0).select(w.yx,w.xy);const A=w.x.toConst(),q=w.y.toConst(),z=uint(w.mul(float(s))).toConst(),D=uint(ceil(q.sub(A).mul(float(s)))).toConst();let O=D.greaterThan(uint(0)).select(uint(shiftRight(uint(4294967295),uint(32).sub(s).add(s.sub(D)))),uint(0)).toConst().shiftLeft(z);O=O.bitAnd(o.bitNot()),o.assign(o.bitOr(O));const L=countOneBits(O);If(L.greaterThan(0),()=>{const e=n(y);If(luminance(e).greaterThan(.001),()=>{const t=normalize(P),o=clamp(dot(m,t));If(o.greaterThan(.001),()=>{const a=i(y);let n=dot(a,t.negate());const r=sign(n).lessThan(0).select(abs(n).mul(v),abs(n));n=v.greaterThan(0).and(dot(a,h).greaterThan(0)).select(r,clamp(n)),S.rgb.addAssign(float(L).div(float(s)).mul(e).mul(o).mul(n))})})}),I.assign(M)}),vec3(S)}),c=Fn(()=>{const e=a(t).toVar();e.greaterThanEqual(1).discard();const n=getViewPosition(t,e,this._cameraProjectionMatrixInverse).toVar(),l=i(t).toVar(),c=normalize(n.xyz.negate()).toVar(),d=r(screenCoordinate),h=interleavedGradientNoise(screenCoordinate),m=this._temporalDirection.mul(.02),f=fract(d.add(this._temporalOffset)).add(rand(t.add(m).mul(2).sub(1))),p=float(0),g=vec3(0),_=this.sliceCount.toConst(),v=this.aoIntensity.toConst(),T=this.giIntensity.toConst(),x=this.radius.toConst();Loop({start:uint(0),end:_,type:"uint",condition:"<"},({i:e})=>{const a=mul(float(e).add(h).add(this._temporalDirection),PI.div(float(_))).toConst(),i=vec3(vec2(cos(a),sin(a)),0).toConst(),r=i.xy.mul(float(1).div(this._resolution)).toConst(),d=normalize(cross(i,c)).toConst(),m=cross(c,d).toConst(),v=l.sub(d.mul(dot(l,d))).toConst(),T=normalize(v).toConst(),b=clamp(dot(T,c),-1,1).toConst(),C=sign(dot(v,m)).negate().mul(acos(b)).toConst();o.assign(0),g.addAssign(u(bool(!0),x,n,r,f,t,c,l,C)),g.addAssign(u(bool(!1),x,n,r,f,t,c,l,C)),p.addAssign(float(countOneBits(o)).div(float(s)))}),p.divAssign(float(_)),p.assign(pow(p.clamp().oneMinus(),v).clamp()),g.divAssign(float(_)),g.mulAssign(T);const b=float(7).toConst(),C=luminance(g),S=C.greaterThan(b).select(b.div(C),float(1));return g.mulAssign(S),vec4(g,p)});return this._material.fragmentNode=c().context(e.getSharedContext()),this._material.needsUpdate=!0,this._textureNode}dispose(){this._ssgiRenderTarget.dispose(),this._material.dispose()}}export default SSGINode;export const ssgi=(e,t,s,o)=>nodeObject(new SSGINode(convertToTexture(e),t,s,o));