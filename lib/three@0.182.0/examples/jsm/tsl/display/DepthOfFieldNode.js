import{TempNode,NodeMaterial,NodeUpdateType,RenderTarget,Vector2,HalfFloatType,RedFormat,QuadMesh,RendererUtils}from"three/webgpu";import{convertToTexture,nodeObject,Fn,uniform,smoothstep,step,texture,max,uniformArray,outputStruct,property,vec4,vec3,uv,Loop,min,mix}from"three/tsl";import{gaussianBlur}from"./GaussianBlurNode.js";const _quadMesh=new QuadMesh;let _rendererState;class DepthOfFieldNode extends TempNode{static get type(){return"DepthOfFieldNode"}constructor(e,t,r,s,a){super("vec4"),this.textureNode=e,this.viewZNode=t,this.focusDistanceNode=r,this.focalLengthNode=s,this.bokehScaleNode=a,this._invSize=uniform(new Vector2),this._CoCRT=new RenderTarget(1,1,{depthBuffer:!1,type:HalfFloatType,format:RedFormat,count:2}),this._CoCRT.textures[0].name="DepthOfField.NearField",this._CoCRT.textures[1].name="DepthOfField.FarField",this._CoCBlurredRT=new RenderTarget(1,1,{depthBuffer:!1,type:HalfFloatType,format:RedFormat}),this._CoCBlurredRT.texture.name="DepthOfField.NearFieldBlurred",this._blur64RT=new RenderTarget(1,1,{depthBuffer:!1,type:HalfFloatType}),this._blur64RT.texture.name="DepthOfField.Blur64",this._blur16NearRT=new RenderTarget(1,1,{depthBuffer:!1,type:HalfFloatType}),this._blur16NearRT.texture.name="DepthOfField.Blur16Near",this._blur16FarRT=new RenderTarget(1,1,{depthBuffer:!1,type:HalfFloatType}),this._blur16FarRT.texture.name="DepthOfField.Blur16Far",this._compositeRT=new RenderTarget(1,1,{depthBuffer:!1,type:HalfFloatType}),this._compositeRT.texture.name="DepthOfField.Composite",this._CoCMaterial=new NodeMaterial,this._CoCBlurredMaterial=new NodeMaterial,this._blur64Material=new NodeMaterial,this._blur16Material=new NodeMaterial,this._compositeMaterial=new NodeMaterial,this._textureNode=texture(this._compositeRT.texture),this._CoCTextureNode=texture(this._CoCRT.texture),this._blur64TextureNode=texture(this._blur64RT.texture),this._blur16NearTextureNode=texture(this._blur16NearRT.texture),this._blur16FarTextureNode=texture(this._blur16FarRT.texture),this.updateBeforeType=NodeUpdateType.FRAME}setSize(e,t){this._invSize.value.set(1/e,1/t),this._CoCRT.setSize(e,t),this._compositeRT.setSize(e,t);const r=Math.round(e/2),s=Math.round(t/2);this._CoCBlurredRT.setSize(r,s),this._blur64RT.setSize(r,s),this._blur16NearRT.setSize(r,s),this._blur16FarRT.setSize(r,s)}getTextureNode(){return this._textureNode}updateBefore(e){const{renderer:t}=e,r=this.textureNode.value;this.setSize(r.image.width,r.image.height),_rendererState=RendererUtils.resetRendererState(t,_rendererState),t.setClearColor(0,0),_quadMesh.material=this._CoCMaterial,t.setRenderTarget(this._CoCRT),_quadMesh.name="DoF [ CoC ]",_quadMesh.render(t),this._CoCTextureNode.value=this._CoCRT.textures[0],_quadMesh.material=this._CoCBlurredMaterial,t.setRenderTarget(this._CoCBlurredRT),_quadMesh.name="DoF [ CoC Blur ]",_quadMesh.render(t),this._CoCTextureNode.value=this._CoCBlurredRT.texture,_quadMesh.material=this._blur64Material,t.setRenderTarget(this._blur64RT),_quadMesh.name="DoF [ Blur64 Near ]",_quadMesh.render(t),_quadMesh.material=this._blur16Material,t.setRenderTarget(this._blur16NearRT),_quadMesh.name="DoF [ Blur16 Near ]",_quadMesh.render(t),this._CoCTextureNode.value=this._CoCRT.textures[1],_quadMesh.material=this._blur64Material,t.setRenderTarget(this._blur64RT),_quadMesh.name="DoF [ Blur64 Far ]",_quadMesh.render(t),_quadMesh.material=this._blur16Material,t.setRenderTarget(this._blur16FarRT),_quadMesh.name="DoF [ Blur16 Far ]",_quadMesh.render(t),_quadMesh.material=this._compositeMaterial,t.setRenderTarget(this._compositeRT),_quadMesh.name="DoF [ Composite ]",_quadMesh.render(t),RendererUtils.restoreRendererState(t,_rendererState)}setup(e){const t=this._generateKernels(),r=property("float"),s=property("float"),a=outputStruct(r,s),i=Fn(()=>{const e=this.viewZNode.negate().sub(this.focusDistanceNode),t=smoothstep(0,this.focalLengthNode,e.abs());return r.assign(step(e,0).mul(t)),s.assign(step(0,e).mul(t)),vec4(0)});this._CoCMaterial.colorNode=i().context(e.getSharedContext()),this._CoCMaterial.outputNode=a,this._CoCMaterial.needsUpdate=!0,this._CoCBlurredMaterial.colorNode=gaussianBlur(this._CoCTextureNode,1,2),this._CoCBlurredMaterial.needsUpdate=!0;const o=uniformArray(t.points64),u=Fn(()=>{const e=vec3(),t=uv(),r=this._CoCTextureNode.sample(t).r,s=this._invSize.mul(this.bokehScaleNode).mul(r);return Loop(64,({i:r})=>{const a=t.add(s.mul(o.element(r))),i=this.textureNode.sample(a);e.addAssign(i.rgb)}),e.divAssign(64),vec4(e,r)});this._blur64Material.fragmentNode=u().context(e.getSharedContext()),this._blur64Material.needsUpdate=!0;const d=uniformArray(t.points16),l=Fn(()=>{const e=uv(),t=this._blur64TextureNode.sample(e).toVar(),r=t.rgb,s=t.a,a=this._invSize.mul(this.bokehScaleNode).mul(s);return Loop(16,({i:t})=>{const s=e.add(a.mul(d.element(t))),i=this._blur64TextureNode.sample(s);r.assign(max(i.rgb,r))}),vec4(r,s)});this._blur16Material.fragmentNode=l().context(e.getSharedContext()),this._blur16Material.needsUpdate=!0;const h=Fn(()=>{const e=uv(),t=this._blur16NearTextureNode.sample(e),r=this._blur16FarTextureNode.sample(e),s=this.textureNode.sample(e),a=min(t.a,.5).mul(2),i=min(r.a,.5).mul(2),o=vec4(0,0,0,1).toVar();return o.rgb=mix(s.rgb,r.rgb,i),o.rgb=mix(o.rgb,t.rgb,a),o});return this._compositeMaterial.fragmentNode=h().context(e.getSharedContext()),this._compositeMaterial.needsUpdate=!0,this._textureNode}_generateKernels(){const e=[],t=[];let r=0,s=0;for(let a=0;a<80;a++){const i=2.39996323*a,o=Math.sqrt(a)/Math.sqrt(80),u=new Vector2(o*Math.cos(i),o*Math.sin(i));a%5==0?(t[s]=u,s++):(e[r]=u,r++)}return{points16:t,points64:e}}dispose(){this._CoCRT.dispose(),this._CoCBlurredRT.dispose(),this._blur64RT.dispose(),this._blur16NearRT.dispose(),this._blur16FarRT.dispose(),this._compositeRT.dispose(),this._CoCMaterial.dispose(),this._CoCBlurredMaterial.dispose(),this._blur64Material.dispose(),this._blur16Material.dispose(),this._compositeMaterial.dispose()}}export default DepthOfFieldNode;export const dof=(e,t,r=1,s=1,a=1)=>nodeObject(new DepthOfFieldNode(convertToTexture(e),nodeObject(t),nodeObject(r),nodeObject(s),nodeObject(a)));