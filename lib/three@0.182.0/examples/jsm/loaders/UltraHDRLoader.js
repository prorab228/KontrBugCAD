import{ClampToEdgeWrapping,DataTexture,DataUtils,FileLoader,HalfFloatType,LinearFilter,LinearMipMapLinearFilter,LinearSRGBColorSpace,Loader,RGBAFormat,UVMapping}from"three";const SRGB_TO_LINEAR=new Float64Array(1024);for(let t=0;t<1024;t++)SRGB_TO_LINEAR[t]=Math.pow(.003717127*t+.0521327014,2.4);class UltraHDRLoader extends Loader{constructor(t){super(t),this.type=HalfFloatType}setDataType(t){return this.type=t,this}parse(t,e){const a={version:null,baseRenditionIsHDR:null,gainMapMin:null,gainMapMax:null,gamma:null,offsetSDR:null,offsetHDR:null,hdrCapacityMin:null,hdrCapacityMax:null},r=new TextDecoder,i=new Uint8Array(t),n=[];let o,s,l=0;for(;l<i.length-1;){if(255!==i[l]){l++;continue}const t=i[l+1];if(216!==t){if(224===t||225===t||226===t){const e=l+2+(i[l+2]<<8|i[l+3]);n.push({sectionType:t,section:i.subarray(l,e),sectionOffset:l+2}),l=e;continue}if(t>=192&&t<=254&&217!==t&&(t<208||t>215)){l+=2+(i[l+2]<<8|i[l+3]);continue}l+=2}else n.push({sectionType:t,section:i.subarray(l,l+2),sectionOffset:l+2}),l+=2}for(let e=0;e<n.length;e++){const{sectionType:i,section:l,sectionOffset:p}=n[e];if(224===i);else if(225===i)this._parseXMPMetadata(r.decode(new Uint8Array(l)),a);else if(226===i){const e=new DataView(l.buffer,l.byteOffset+2,l.byteLength-2);if(1297106432===e.getUint32(2,!1)){const a=1229531648===e.getUint32(6),r=60,i=e.getUint32(r,a),n=e.getUint32(r+4,a),l=e.getUint32(r+16,a),g=e.getUint32(r+20,a)+p+6;o=new Uint8Array(t,n,i),s=new Uint8Array(t,g,l)}}}if(!a.version)throw new Error("THREE.UltraHDRLoader: Not a valid UltraHDR image");if(!o||!s)throw new Error("THREE.UltraHDRLoader: Could not parse UltraHDR images");this._applyGainmapToSDR(a,o,s,(t,a,r)=>{e({width:a,height:r,data:t,format:RGBAFormat,type:this.type})},t=>{throw new Error(t)})}load(t,e,a,r){const i=new DataTexture(this.type===HalfFloatType?new Uint16Array:new Float32Array,0,0,RGBAFormat,this.type,UVMapping,ClampToEdgeWrapping,ClampToEdgeWrapping,LinearFilter,LinearMipMapLinearFilter,1,LinearSRGBColorSpace);i.generateMipmaps=!0,i.flipY=!0;const n=new FileLoader(this.manager);return n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setPath(this.path),n.setWithCredentials(this.withCredentials),n.load(t,t=>{try{this.parse(t,t=>{i.image={data:t.data,width:t.width,height:t.height},i.needsUpdate=!0,e&&e(i,t)})}catch(t){r&&r(t),console.error(t)}},a,r),i}_parseXMPMetadata(t,e){const a=(new DOMParser).parseFromString(t.substring(t.indexOf("<"),t.lastIndexOf(">")+1),"text/xml"),[r]=a.getElementsByTagName("Container:Directory");if(r);else{const[t]=a.getElementsByTagName("rdf:Description");e.version=t.getAttribute("hdrgm:Version"),e.baseRenditionIsHDR="True"===t.getAttribute("hdrgm:BaseRenditionIsHDR"),e.gainMapMin=parseFloat(t.getAttribute("hdrgm:GainMapMin")||0),e.gainMapMax=parseFloat(t.getAttribute("hdrgm:GainMapMax")||1),e.gamma=parseFloat(t.getAttribute("hdrgm:Gamma")||1),e.offsetSDR=parseFloat(t.getAttribute("hdrgm:OffsetSDR")/(1/64)),e.offsetHDR=parseFloat(t.getAttribute("hdrgm:OffsetHDR")/(1/64)),e.hdrCapacityMin=parseFloat(t.getAttribute("hdrgm:HDRCapacityMin")||0),e.hdrCapacityMax=parseFloat(t.getAttribute("hdrgm:HDRCapacityMax")||1)}}_srgbToLinear(t){return t<10.31475?303527e-9*t:t<1024?SRGB_TO_LINEAR[0|t]:Math.pow(.003717127*t+.0521327014,2.4)}_applyGainmapToSDR(t,e,a,r,i){const n=t=>createImageBitmap(new Blob([t],{type:"image/jpeg"}));Promise.all([n(e),n(a)]).then(([e,a])=>{const n=e.width,o=e.height;if(n/o!==a.width/a.height)return void i("THREE.UltraHDRLoader Error: Aspect ratio mismatch between SDR and Gainmap images");const s=document.createElement("canvas"),l=s.getContext("2d",{willReadFrequently:!0,colorSpace:"srgb"});s.width=n,s.height=o,l.drawImage(a,0,0,a.width,a.height,0,0,n,o);const p=l.getImageData(0,0,n,o,{colorSpace:"srgb"});l.drawImage(e,0,0);const g=l.getImageData(0,0,n,o,{colorSpace:"srgb"}),h=1.8**(.5*t.hdrCapacityMax),d=(Math.log2(h)-t.hdrCapacityMin)/(t.hdrCapacityMax-t.hdrCapacityMin),c=Math.min(Math.max(d,0),1),m=g.data,f=p.data,y=m.length,M=t.gainMapMin,R=t.gainMapMax,u=t.offsetSDR,w=t.offsetHDR,D=1/t.gamma,T=1===t.gamma,F=this.type===HalfFloatType,H=DataUtils.toHalfFloat,b=this._srgbToLinear,A=F?new Uint16Array(y).fill(15360):new Float32Array(y).fill(1);for(let t=0;t<y;t+=4)for(let e=0;e<3;e++){const a=t+e,r=m[a],i=.00392156862745098*f[a],n=M+(R-M)*(T?i:Math.pow(i,D)),o=(r+u)*(n*c===0?1:Math.pow(2,n*c))-w,s=Math.min(Math.max(b(o),0),65504);A[a]=F?H(s):s}r(A,n,o)}).catch(t=>{i(t)})}}export{UltraHDRLoader};