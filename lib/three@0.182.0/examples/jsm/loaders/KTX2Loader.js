import{CompressedArrayTexture,CompressedCubeTexture,CompressedTexture,Data3DTexture,DataTexture,FileLoader,FloatType,HalfFloatType,LinearFilter,LinearMipmapLinearFilter,NearestFilter,NearestMipmapNearestFilter,LinearSRGBColorSpace,Loader,NoColorSpace,RGBAFormat,RGBA_ASTC_4x4_Format,RGBA_ASTC_6x6_Format,RGBA_BPTC_Format,RGBA_S3TC_DXT3_Format,RGBA_ETC2_EAC_Format,R11_EAC_Format,SIGNED_R11_EAC_Format,RG11_EAC_Format,SIGNED_RG11_EAC_Format,RGBA_PVRTC_4BPPV1_Format,RGBA_PVRTC_2BPPV1_Format,RGBA_S3TC_DXT1_Format,RGBA_S3TC_DXT5_Format,RGB_BPTC_UNSIGNED_Format,RGB_ETC1_Format,RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format,SIGNED_RED_GREEN_RGTC2_Format,SIGNED_RED_RGTC1_Format,RED_GREEN_RGTC2_Format,RED_RGTC1_Format,RGBFormat,RGFormat,RedFormat,SRGBColorSpace,UnsignedByteType,UnsignedInt5999Type,UnsignedInt101111Type}from"three";import{WorkerPool}from"../utils/WorkerPool.js";import{read,KHR_DF_FLAG_ALPHA_PREMULTIPLIED,KHR_DF_PRIMARIES_BT709,KHR_DF_PRIMARIES_DISPLAYP3,KHR_DF_PRIMARIES_UNSPECIFIED,KHR_DF_TRANSFER_SRGB,KHR_SUPERCOMPRESSION_NONE,KHR_SUPERCOMPRESSION_ZSTD,VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT,VK_FORMAT_ASTC_6x6_SFLOAT_BLOCK_EXT,VK_FORMAT_ASTC_4x4_SRGB_BLOCK,VK_FORMAT_ASTC_4x4_UNORM_BLOCK,VK_FORMAT_ASTC_6x6_SRGB_BLOCK,VK_FORMAT_ASTC_6x6_UNORM_BLOCK,VK_FORMAT_BC1_RGBA_SRGB_BLOCK,VK_FORMAT_BC1_RGBA_UNORM_BLOCK,VK_FORMAT_BC1_RGB_SRGB_BLOCK,VK_FORMAT_BC1_RGB_UNORM_BLOCK,VK_FORMAT_BC3_SRGB_BLOCK,VK_FORMAT_BC3_UNORM_BLOCK,VK_FORMAT_BC4_SNORM_BLOCK,VK_FORMAT_BC4_UNORM_BLOCK,VK_FORMAT_BC5_SNORM_BLOCK,VK_FORMAT_BC5_UNORM_BLOCK,VK_FORMAT_BC7_SRGB_BLOCK,VK_FORMAT_BC7_UNORM_BLOCK,VK_FORMAT_ETC2_R8G8B8_SRGB_BLOCK,VK_FORMAT_ETC2_R8G8B8A8_SRGB_BLOCK,VK_FORMAT_EAC_R11_UNORM_BLOCK,VK_FORMAT_EAC_R11_SNORM_BLOCK,VK_FORMAT_EAC_R11G11_UNORM_BLOCK,VK_FORMAT_EAC_R11G11_SNORM_BLOCK,VK_FORMAT_PVRTC1_4BPP_SRGB_BLOCK_IMG,VK_FORMAT_PVRTC1_4BPP_UNORM_BLOCK_IMG,VK_FORMAT_PVRTC1_2BPP_SRGB_BLOCK_IMG,VK_FORMAT_PVRTC1_2BPP_UNORM_BLOCK_IMG,VK_FORMAT_R16G16B16A16_SFLOAT,VK_FORMAT_R16G16_SFLOAT,VK_FORMAT_R16_SFLOAT,VK_FORMAT_R32G32B32A32_SFLOAT,VK_FORMAT_R32G32_SFLOAT,VK_FORMAT_R32_SFLOAT,VK_FORMAT_R8G8B8A8_SRGB,VK_FORMAT_R8G8B8A8_UNORM,VK_FORMAT_R8G8_SRGB,VK_FORMAT_R8G8_UNORM,VK_FORMAT_R8_SRGB,VK_FORMAT_R8_UNORM,VK_FORMAT_E5B9G9R9_UFLOAT_PACK32,VK_FORMAT_B10G11R11_UFLOAT_PACK32,VK_FORMAT_UNDEFINED}from"../libs/ktx-parse.module.js";import{ZSTDDecoder}from"../libs/zstddec.module.js";import{DisplayP3ColorSpace,LinearDisplayP3ColorSpace}from"../math/ColorSpaces.js";const _taskCache=new WeakMap;let _zstd,_activeLoaders=0;class KTX2Loader extends Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new WorkerPool,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return console.warn('KTX2Loader: "detectSupportAsync()" has been deprecated. Use "detectSupport()" and "await renderer.init();" when creating the renderer.'),await e.init(),this.detectSupport(e)}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-s3tc"),bptcSupported:e.hasFeature("texture-compression-bc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:(this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},"undefined"!=typeof navigator&&navigator.platform.indexOf("Linux")>=0&&navigator.userAgent.indexOf("Firefox")>=0&&this.workerConfig.astcSupported&&this.workerConfig.etc2Supported&&this.workerConfig.bptcSupported&&this.workerConfig.dxtSupported&&(this.workerConfig.astcSupported=!1,this.workerConfig.etc2Supported=!1)),this}init(){if(!this.transcoderPending){const e=new FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),_=new FileLoader(this.manager);_.setPath(this.transcoderPath),_.setResponseType("arraybuffer"),_.setWithCredentials(this.withCredentials);const r=_.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,r]).then(([e,t])=>{const _=KTX2Loader.BasisWorker.toString(),r=["/* constants */","let _EngineFormat = "+JSON.stringify(KTX2Loader.EngineFormat),"let _EngineType = "+JSON.stringify(KTX2Loader.EngineType),"let _TranscoderFormat = "+JSON.stringify(KTX2Loader.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(KTX2Loader.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",_.substring(_.indexOf("{")+1,_.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r])),this.transcoderBinary=t,this.workerPool.setWorkerCreator(()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e})}),_activeLoaders>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),_activeLoaders++}return this.transcoderPending}load(e,t,_,r){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const o=new FileLoader(this.manager);o.setPath(this.path),o.setCrossOrigin(this.crossOrigin),o.setWithCredentials(this.withCredentials),o.setRequestHeader(this.requestHeader),o.setResponseType("arraybuffer"),o.load(e,e=>{this.parse(e,t,r)},_,r)}parse(e,t,_){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(_taskCache.has(e)){return _taskCache.get(e).promise.then(t).catch(_)}this._createTexture(e).then(e=>t?t(e):null).catch(_)}_createTextureFrom(e,t){const{type:_,error:r,data:{faces:o,width:a,height:s,format:n,type:i,dfdFlags:R}}=e;if("error"===_)return Promise.reject(r);let T;if(6===t.faceCount)T=new CompressedCubeTexture(o,n,i);else{const e=o[0].mipmaps;T=t.layerCount>1?new CompressedArrayTexture(e,a,s,t.layerCount,n,i):new CompressedTexture(e,a,s,n,i)}return T.minFilter=1===o[0].mipmaps.length?LinearFilter:LinearMipmapLinearFilter,T.magFilter=LinearFilter,T.generateMipmaps=!1,T.needsUpdate=!0,T.colorSpace=parseColorSpace(t),T.premultiplyAlpha=!!(R&KHR_DF_FLAG_ALPHA_PREMULTIPLIED),T}async _createTexture(e,t={}){const _=read(new Uint8Array(e)),r=_.vkFormat===VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT&&167===_.dataFormatDescriptor[0].colorModel;if(!(_.vkFormat===VK_FORMAT_UNDEFINED||r&&!this.workerConfig.astcHDRSupported))return createRawTexture(_);const o=t,a=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:o},[e])).then(e=>this._createTextureFrom(e.data,_));return _taskCache.set(e,{promise:a}),a}dispose(){this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),_activeLoaders--}}KTX2Loader.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2},KTX2Loader.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25},KTX2Loader.EngineFormat={RGBAFormat:RGBAFormat,RGBA_ASTC_4x4_Format:RGBA_ASTC_4x4_Format,RGB_BPTC_UNSIGNED_Format:RGB_BPTC_UNSIGNED_Format,RGBA_BPTC_Format:RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:RGB_ETC1_Format,RGB_ETC2_Format:RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:RGB_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT1_Format:RGBA_S3TC_DXT1_Format},KTX2Loader.EngineType={UnsignedByteType:UnsignedByteType,HalfFloatType:HalfFloatType,FloatType:FloatType},KTX2Loader.BasisWorker=function(){let e,t,_;const r=_EngineFormat,o=_EngineType,a=_TranscoderFormat,s=_BasisFormat;self.addEventListener("message",function(r){const a=r.data;switch(a.type){case"init":e=a.config,n=a.transcoderBinary,t=new Promise(e=>{_={wasmBinary:n,onRuntimeInitialized:e},BASIS(_)}).then(()=>{_.initializeBasis(),void 0===_.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")});break;case"transcode":t.then(()=>{try{const{faces:t,buffers:r,width:n,height:B,hasAlpha:F,format:A,type:C,dfdFlags:p}=function(t){const r=new _.KTX2File(new Uint8Array(t));function a(){r.close(),r.delete()}if(!r.isValid())throw a(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");let n;if(r.isUASTC())n=s.UASTC;else if(r.isETC1S())n=s.ETC1S;else{if(!r.isHDR())throw new Error("THREE.KTX2Loader: Unknown Basis encoding");n=s.UASTC_HDR}const B=r.getWidth(),F=r.getHeight(),A=r.getLayers()||1,C=r.getLevels(),p=r.getFaces(),O=r.getHasAlpha(),d=r.getDFDFlags(),{transcoderFormat:S,engineFormat:m,engineType:c}=function(t,_,r,o){const a=i[t];for(let s=0;s<a.length;s++){const n=a[s];if(n.if&&!e[n.if])continue;if(!n.basisFormat.includes(t))continue;if(o&&n.transcoderFormat.length<2)continue;if(n.needsPowerOfTwo&&(!R(_)||!R(r)))continue;return{transcoderFormat:n.transcoderFormat[o?1:0],engineFormat:n.engineFormat[o?1:0],engineType:n.engineType[0]}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}(n,B,F,O);if(!B||!F||!C)throw a(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!r.startTranscoding())throw a(),new Error("THREE.KTX2Loader: .startTranscoding failed");const K=[],M=[];for(let e=0;e<p;e++){const t=[];for(let _=0;_<C;_++){const s=[];let n,i;for(let t=0;t<A;t++){const R=r.getImageLevelInfo(_,t,e);0!==e||0!==_||0!==t||R.origWidth%4==0&&R.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),C>1?(n=R.origWidth,i=R.origHeight):(n=R.width,i=R.height);let T=new Uint8Array(r.getImageTranscodedSizeInBytes(_,t,0,S));const B=r.transcodeImage(T,_,t,e,S,0,-1,-1);if(c===o.HalfFloatType&&(T=new Uint16Array(T.buffer,T.byteOffset,T.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!B)throw a(),new Error("THREE.KTX2Loader: .transcodeImage failed.");s.push(T)}const R=T(s);t.push({data:R,width:n,height:i}),M.push(R.buffer)}K.push({mipmaps:t,width:B,height:F,format:m,type:c})}return a(),{faces:K,buffers:M,width:B,height:F,hasAlpha:O,dfdFlags:d,format:m,type:c}}(a.buffer);self.postMessage({type:"transcode",id:a.id,data:{faces:t,width:n,height:B,hasAlpha:F,format:A,type:C,dfdFlags:p}},r)}catch(e){console.error(e),self.postMessage({type:"error",id:a.id,error:e.message})}})}var n});const n=[{if:"astcSupported",basisFormat:[s.UASTC],transcoderFormat:[a.ASTC_4x4,a.ASTC_4x4],engineFormat:[r.RGBA_ASTC_4x4_Format,r.RGBA_ASTC_4x4_Format],engineType:[o.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[s.ETC1S,s.UASTC],transcoderFormat:[a.BC7_M5,a.BC7_M5],engineFormat:[r.RGBA_BPTC_Format,r.RGBA_BPTC_Format],engineType:[o.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[s.ETC1S,s.UASTC],transcoderFormat:[a.BC1,a.BC3],engineFormat:[r.RGBA_S3TC_DXT1_Format,r.RGBA_S3TC_DXT5_Format],engineType:[o.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[s.ETC1S,s.UASTC],transcoderFormat:[a.ETC1,a.ETC2],engineFormat:[r.RGB_ETC2_Format,r.RGBA_ETC2_EAC_Format],engineType:[o.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[s.ETC1S,s.UASTC],transcoderFormat:[a.ETC1],engineFormat:[r.RGB_ETC1_Format],engineType:[o.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[s.ETC1S,s.UASTC],transcoderFormat:[a.PVRTC1_4_RGB,a.PVRTC1_4_RGBA],engineFormat:[r.RGB_PVRTC_4BPPV1_Format,r.RGBA_PVRTC_4BPPV1_Format],engineType:[o.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[s.UASTC_HDR],transcoderFormat:[a.BC6H],engineFormat:[r.RGB_BPTC_UNSIGNED_Format],engineType:[o.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[s.ETC1S,s.UASTC],transcoderFormat:[a.RGBA32,a.RGBA32],engineFormat:[r.RGBAFormat,r.RGBAFormat],engineType:[o.UnsignedByteType,o.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[s.UASTC_HDR],transcoderFormat:[a.RGBA_HALF],engineFormat:[r.RGBAFormat],engineType:[o.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],i={[s.ETC1S]:n.filter(e=>e.basisFormat.includes(s.ETC1S)).sort((e,t)=>e.priorityETC1S-t.priorityETC1S),[s.UASTC]:n.filter(e=>e.basisFormat.includes(s.UASTC)).sort((e,t)=>e.priorityUASTC-t.priorityUASTC),[s.UASTC_HDR]:n.filter(e=>e.basisFormat.includes(s.UASTC_HDR)).sort((e,t)=>e.priorityHDR-t.priorityHDR)};function R(e){return e<=2||!(e&e-1)&&0!==e}function T(e){if(1===e.length)return e[0];let t=0;for(let _=0;_<e.length;_++){t+=e[_].byteLength}const _=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++){const o=e[t];_.set(o,r),r+=o.byteLength}return _}};const UNCOMPRESSED_FORMATS=new Set([RGBAFormat,RGBFormat,RGFormat,RedFormat]),FORMAT_MAP={[VK_FORMAT_R32G32B32A32_SFLOAT]:RGBAFormat,[VK_FORMAT_R32G32_SFLOAT]:RGFormat,[VK_FORMAT_R32_SFLOAT]:RedFormat,[VK_FORMAT_R16G16B16A16_SFLOAT]:RGBAFormat,[VK_FORMAT_R16G16_SFLOAT]:RGFormat,[VK_FORMAT_R16_SFLOAT]:RedFormat,[VK_FORMAT_R8G8B8A8_SRGB]:RGBAFormat,[VK_FORMAT_R8G8B8A8_UNORM]:RGBAFormat,[VK_FORMAT_R8G8_SRGB]:RGFormat,[VK_FORMAT_R8G8_UNORM]:RGFormat,[VK_FORMAT_R8_SRGB]:RedFormat,[VK_FORMAT_R8_UNORM]:RedFormat,[VK_FORMAT_E5B9G9R9_UFLOAT_PACK32]:RGBFormat,[VK_FORMAT_B10G11R11_UFLOAT_PACK32]:RGBFormat,[VK_FORMAT_ETC2_R8G8B8A8_SRGB_BLOCK]:RGBA_ETC2_EAC_Format,[VK_FORMAT_ETC2_R8G8B8_SRGB_BLOCK]:RGB_ETC2_Format,[VK_FORMAT_EAC_R11_UNORM_BLOCK]:R11_EAC_Format,[VK_FORMAT_EAC_R11_SNORM_BLOCK]:SIGNED_R11_EAC_Format,[VK_FORMAT_EAC_R11G11_UNORM_BLOCK]:RG11_EAC_Format,[VK_FORMAT_EAC_R11G11_SNORM_BLOCK]:SIGNED_RG11_EAC_Format,[VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT]:RGBA_ASTC_4x4_Format,[VK_FORMAT_ASTC_4x4_SRGB_BLOCK]:RGBA_ASTC_4x4_Format,[VK_FORMAT_ASTC_4x4_UNORM_BLOCK]:RGBA_ASTC_4x4_Format,[VK_FORMAT_ASTC_6x6_SFLOAT_BLOCK_EXT]:RGBA_ASTC_6x6_Format,[VK_FORMAT_ASTC_6x6_SRGB_BLOCK]:RGBA_ASTC_6x6_Format,[VK_FORMAT_ASTC_6x6_UNORM_BLOCK]:RGBA_ASTC_6x6_Format,[VK_FORMAT_BC1_RGBA_SRGB_BLOCK]:RGBA_S3TC_DXT1_Format,[VK_FORMAT_BC1_RGBA_UNORM_BLOCK]:RGBA_S3TC_DXT1_Format,[VK_FORMAT_BC1_RGB_SRGB_BLOCK]:RGB_S3TC_DXT1_Format,[VK_FORMAT_BC1_RGB_UNORM_BLOCK]:RGB_S3TC_DXT1_Format,[VK_FORMAT_BC3_SRGB_BLOCK]:RGBA_S3TC_DXT3_Format,[VK_FORMAT_BC3_UNORM_BLOCK]:RGBA_S3TC_DXT3_Format,[VK_FORMAT_BC4_SNORM_BLOCK]:SIGNED_RED_RGTC1_Format,[VK_FORMAT_BC4_UNORM_BLOCK]:RED_RGTC1_Format,[VK_FORMAT_BC5_SNORM_BLOCK]:SIGNED_RED_GREEN_RGTC2_Format,[VK_FORMAT_BC5_UNORM_BLOCK]:RED_GREEN_RGTC2_Format,[VK_FORMAT_BC7_SRGB_BLOCK]:RGBA_BPTC_Format,[VK_FORMAT_BC7_UNORM_BLOCK]:RGBA_BPTC_Format,[VK_FORMAT_PVRTC1_4BPP_SRGB_BLOCK_IMG]:RGBA_PVRTC_4BPPV1_Format,[VK_FORMAT_PVRTC1_4BPP_UNORM_BLOCK_IMG]:RGBA_PVRTC_4BPPV1_Format,[VK_FORMAT_PVRTC1_2BPP_SRGB_BLOCK_IMG]:RGBA_PVRTC_2BPPV1_Format,[VK_FORMAT_PVRTC1_2BPP_UNORM_BLOCK_IMG]:RGBA_PVRTC_2BPPV1_Format},TYPE_MAP={[VK_FORMAT_R32G32B32A32_SFLOAT]:FloatType,[VK_FORMAT_R32G32_SFLOAT]:FloatType,[VK_FORMAT_R32_SFLOAT]:FloatType,[VK_FORMAT_R16G16B16A16_SFLOAT]:HalfFloatType,[VK_FORMAT_R16G16_SFLOAT]:HalfFloatType,[VK_FORMAT_R16_SFLOAT]:HalfFloatType,[VK_FORMAT_R8G8B8A8_SRGB]:UnsignedByteType,[VK_FORMAT_R8G8B8A8_UNORM]:UnsignedByteType,[VK_FORMAT_R8G8_SRGB]:UnsignedByteType,[VK_FORMAT_R8G8_UNORM]:UnsignedByteType,[VK_FORMAT_R8_SRGB]:UnsignedByteType,[VK_FORMAT_R8_UNORM]:UnsignedByteType,[VK_FORMAT_E5B9G9R9_UFLOAT_PACK32]:UnsignedInt5999Type,[VK_FORMAT_B10G11R11_UFLOAT_PACK32]:UnsignedInt101111Type,[VK_FORMAT_ETC2_R8G8B8A8_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_ETC2_R8G8B8_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_EAC_R11_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_EAC_R11_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_EAC_R11G11_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_EAC_R11G11_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT]:HalfFloatType,[VK_FORMAT_ASTC_4x4_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_ASTC_4x4_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_ASTC_6x6_SFLOAT_BLOCK_EXT]:HalfFloatType,[VK_FORMAT_ASTC_6x6_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_ASTC_6x6_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC1_RGBA_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_BC1_RGBA_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC1_RGB_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_BC1_RGB_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC3_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_BC3_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC4_SNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC4_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC5_SNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC5_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_BC7_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_BC7_UNORM_BLOCK]:UnsignedByteType,[VK_FORMAT_PVRTC1_4BPP_SRGB_BLOCK_IMG]:UnsignedByteType,[VK_FORMAT_PVRTC1_4BPP_UNORM_BLOCK_IMG]:UnsignedByteType,[VK_FORMAT_PVRTC1_2BPP_SRGB_BLOCK_IMG]:UnsignedByteType,[VK_FORMAT_PVRTC1_2BPP_UNORM_BLOCK_IMG]:UnsignedByteType};async function createRawTexture(e){const{vkFormat:t}=e;if(void 0===FORMAT_MAP[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat: "+t);let _;void 0===TYPE_MAP[t]&&console.warn('THREE.KTX2Loader: Missing ".type" for vkFormat: '+t),e.supercompressionScheme===KHR_SUPERCOMPRESSION_ZSTD&&(_zstd||(_zstd=new Promise(async e=>{const t=new ZSTDDecoder;await t.init(),e(t)})),_=await _zstd);const r=[];for(let o=0;o<e.levels.length;o++){const a=Math.max(1,e.pixelWidth>>o),s=Math.max(1,e.pixelHeight>>o),n=e.pixelDepth?Math.max(1,e.pixelDepth>>o):0,i=e.levels[o];let R,T;if(e.supercompressionScheme===KHR_SUPERCOMPRESSION_NONE)R=i.levelData;else{if(e.supercompressionScheme!==KHR_SUPERCOMPRESSION_ZSTD)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");R=_.decode(i.levelData,i.uncompressedByteLength)}T=TYPE_MAP[t]===FloatType?new Float32Array(R.buffer,R.byteOffset,R.byteLength/Float32Array.BYTES_PER_ELEMENT):TYPE_MAP[t]===HalfFloatType?new Uint16Array(R.buffer,R.byteOffset,R.byteLength/Uint16Array.BYTES_PER_ELEMENT):TYPE_MAP[t]===UnsignedInt5999Type||TYPE_MAP[t]===UnsignedInt101111Type?new Uint32Array(R.buffer,R.byteOffset,R.byteLength/Uint32Array.BYTES_PER_ELEMENT):R,r.push({data:T,width:a,height:s,depth:n})}const o=0===e.levelCount||r.length>1;let a;if(UNCOMPRESSED_FORMATS.has(FORMAT_MAP[t]))a=0===e.pixelDepth?new DataTexture(r[0].data,e.pixelWidth,e.pixelHeight):new Data3DTexture(r[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth),a.minFilter=o?NearestMipmapNearestFilter:NearestFilter,a.magFilter=NearestFilter,a.generateMipmaps=0===e.levelCount;else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");a=new CompressedTexture(r,e.pixelWidth,e.pixelHeight),a.minFilter=o?LinearMipmapLinearFilter:LinearFilter,a.magFilter=LinearFilter}return a.mipmaps=r,a.type=TYPE_MAP[t],a.format=FORMAT_MAP[t],a.colorSpace=parseColorSpace(e),a.needsUpdate=!0,Promise.resolve(a)}function parseColorSpace(e){const t=e.dataFormatDescriptor[0];return t.colorPrimaries===KHR_DF_PRIMARIES_BT709?t.transferFunction===KHR_DF_TRANSFER_SRGB?SRGBColorSpace:LinearSRGBColorSpace:t.colorPrimaries===KHR_DF_PRIMARIES_DISPLAYP3?t.transferFunction===KHR_DF_TRANSFER_SRGB?DisplayP3ColorSpace:LinearDisplayP3ColorSpace:(t.colorPrimaries===KHR_DF_PRIMARIES_UNSPECIFIED||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),NoColorSpace)}export{KTX2Loader};