import{BufferGeometry,Color,Data3DTexture,FileLoader,Float32BufferAttribute,Group,Loader,LinearFilter,Matrix4,Mesh,MeshStandardMaterial,NearestFilter,RedFormat,SRGBColorSpace}from"three";function readString(e,t){const n=e.getUint32(t,!0);t+=4;let r="";for(let s=0;s<n;s++)r+=String.fromCharCode(e.getUint8(t++));return{value:r,size:4+n}}function readDict(e,t){const n={},r=e.getUint32(t,!0);t+=4;let s=4;for(let o=0;o<r;o++){const r=readString(e,t);t+=r.size,s+=r.size;const o=readString(e,t);t+=o.size,s+=o.size,n[r.value]=o.value}return{value:n,size:s}}function decodeRotation(e){const t=3&e,n=e>>2&3,r=e>>4&1?-1:1,s=e>>5&1?-1:1,o=e>>6&1?-1:1,a=3-t-n,i=[[0,0,0],[0,0,0],[0,0,0]];i[0][t]=r,i[1][n]=s,i[2][a]=o;const l=new Matrix4;return l.set(i[0][0],i[0][2],-i[0][1],0,i[2][0],i[2][2],-i[2][1],0,-i[1][0],-i[1][2],i[1][1],0,0,0,0,1),l}function applyTransform(e,t){if(t.attributes._name&&(e.name=t.attributes._name),t.frames.length>0){const n=t.frames[0];n.rotation&&e.applyMatrix4(n.rotation),n.translation&&e.position.set(n.translation.x,n.translation.z,-n.translation.y)}}function buildObject(e,t,n){const r=t[e];if("transform"===r.type){const e=t[r.childNodeId],s=r.frames[0],o=s&&(s.rotation||s.translation);if("shape"===e.type&&1===e.models.length){const t=buildMesh(n[e.models[0].modelId]);return applyTransform(t,r),t}if(!o){const e=buildObject(r.childNodeId,t,n);return e&&r.attributes._name&&(e.name=r.attributes._name),e}const a=new Group;applyTransform(a,r);const i=buildObject(r.childNodeId,t,n);return i&&a.add(i),a}if("group"===r.type){const e=new Group;for(const s of r.childIds){const r=buildObject(s,t,n);r&&e.add(r)}return e}if("shape"===r.type){if(1===r.models.length){return buildMesh(n[r.models[0].modelId])}const e=new Group;for(const t of r.models){const r=n[t.modelId];e.add(buildMesh(r))}return e}return null}class VOXLoader extends Loader{load(e,t,n,r){const s=this,o=new FileLoader(s.manager);o.setPath(s.path),o.setResponseType("arraybuffer"),o.setRequestHeader(s.requestHeader),o.load(e,function(n){try{t(s.parse(n))}catch(t){r?r(t):console.error(t),s.manager.itemError(e)}},n,r)}parse(e){const t=new DataView(e),n=t.getUint32(0,!0),r=t.getUint32(4,!0);if(542658390!==n)return void console.error("THREE.VOXLoader: Invalid VOX file.");if(150!==r&&200!==r)return void console.error("THREE.VOXLoader: Invalid VOX file. Unsupported version:",r);const s=[0,4294967295,4291624959,4288282623,4284940287,4281597951,4278255615,4294954239,4291611903,4288269567,4284927231,4281584895,4278242559,4294941183,4291598847,4288256511,4284914175,4281571839,4278229503,4294928127,4291585791,4288243455,4284901119,4281558783,4278216447,4294915071,4291572735,4288230399,4284888063,4281545727,4278203391,4294902015,4291559679,4288217343,4284875007,4281532671,4278190335,4294967244,4291624908,4288282572,4284940236,4281597900,4278255564,4294954188,4291611852,4288269516,4284927180,4281584844,4278242508,4294941132,4291598796,4288256460,4284914124,4281571788,4278229452,4294928076,4291585740,4288243404,4284901068,4281558732,4278216396,4294915020,4291572684,4288230348,4284888012,4281545676,4278203340,4294901964,4291559628,4288217292,4284874956,4281532620,4278190284,4294967193,4291624857,4288282521,4284940185,4281597849,4278255513,4294954137,4291611801,4288269465,4284927129,4281584793,4278242457,4294941081,4291598745,4288256409,4284914073,4281571737,4278229401,4294928025,4291585689,4288243353,4284901017,4281558681,4278216345,4294914969,4291572633,4288230297,4284887961,4281545625,4278203289,4294901913,4291559577,4288217241,4284874905,4281532569,4278190233,4294967142,4291624806,4288282470,4284940134,4281597798,4278255462,4294954086,4291611750,4288269414,4284927078,4281584742,4278242406,4294941030,4291598694,4288256358,4284914022,4281571686,4278229350,4294927974,4291585638,4288243302,4284900966,4281558630,4278216294,4294914918,4291572582,4288230246,4284887910,4281545574,4278203238,4294901862,4291559526,4288217190,4284874854,4281532518,4278190182,4294967091,4291624755,4288282419,4284940083,4281597747,4278255411,4294954035,4291611699,4288269363,4284927027,4281584691,4278242355,4294940979,4291598643,4288256307,4284913971,4281571635,4278229299,4294927923,4291585587,4288243251,4284900915,4281558579,4278216243,4294914867,4291572531,4288230195,4284887859,4281545523,4278203187,4294901811,4291559475,4288217139,4284874803,4281532467,4278190131,4294967040,4291624704,4288282368,4284940032,4281597696,4278255360,4294953984,4291611648,4288269312,4284926976,4281584640,4278242304,4294940928,4291598592,4288256256,4284913920,4281571584,4278229248,4294927872,4291585536,4288243200,4284900864,4281558528,4278216192,4294914816,4291572480,4288230144,4284887808,4281545472,4278203136,4294901760,4291559424,4288217088,4284874752,4281532416,4278190318,4278190301,4278190267,4278190250,4278190216,4278190199,4278190165,4278190148,4278190114,4278190097,4278251008,4278246656,4278237952,4278233600,4278224896,4278220544,4278211840,4278207488,4278198784,4278194432,4293787648,4292673536,4290445312,4289331200,4287102976,4285988864,4283760640,4282646528,4280418304,4279304192,4293848814,4292730333,4290493371,4289374890,4287137928,4286019447,4283782485,4282664004,4280427042,4279308561];let o,a=8;const i=[],l={};let c=s;for(;a<t.byteLength;){let n="";for(let e=0;e<4;e++)n+=String.fromCharCode(t.getUint8(a++));const r=t.getUint32(a,!0);if(a+=4,a+=4,"SIZE"===n){const e=t.getUint32(a,!0);a+=4;const n=t.getUint32(a,!0);a+=4;const l=t.getUint32(a,!0);a+=4,o={palette:s,size:{x:e,y:n,z:l}},i.push(o),a+=r-12}else if("XYZI"===n){const n=t.getUint32(a,!0);a+=4,o.data=new Uint8Array(e,a,4*n),a+=4*n}else if("RGBA"===n){c=[0];for(let e=0;e<256;e++)c[e+1]=t.getUint32(a,!0),a+=4;o.palette=c}else if("nTRN"===n){const e=t.getUint32(a,!0);a+=4;const n=readDict(t,a);a+=n.size;const r=t.getUint32(a,!0);a+=4,a+=4;const s=t.getInt32(a,!0);a+=4;const o=t.getUint32(a,!0);a+=4;const i=[];for(let e=0;e<o;e++){const e=readDict(t,a);a+=e.size;const n={rotation:null,translation:null};if(void 0!==e.value._r&&(n.rotation=decodeRotation(parseInt(e.value._r))),void 0!==e.value._t){const t=e.value._t.split(" ").map(Number);n.translation={x:t[0],y:t[1],z:t[2]}}i.push(n)}l[e]={type:"transform",id:e,attributes:n.value,childNodeId:r,layerId:s,frames:i}}else if("nGRP"===n){const e=t.getUint32(a,!0);a+=4;const n=readDict(t,a);a+=n.size;const r=t.getUint32(a,!0);a+=4;const s=[];for(let e=0;e<r;e++)s.push(t.getUint32(a,!0)),a+=4;l[e]={type:"group",id:e,attributes:n.value,childIds:s}}else if("nSHP"===n){const e=t.getUint32(a,!0);a+=4;const n=readDict(t,a);a+=n.size;const r=t.getUint32(a,!0);a+=4;const s=[];for(let e=0;e<r;e++){const e=t.getUint32(a,!0);a+=4;const n=readDict(t,a);a+=n.size,s.push({modelId:e,attributes:n.value})}l[e]={type:"shape",id:e,attributes:n.value,models:s}}else a+=r}for(let e=0;e<i.length;e++)i[e].palette=c;let d=null;Object.keys(l).length>0&&(d=buildObject(0,l,i));let u=!1;return new Proxy({chunks:i,scene:d},{get:(e,t)=>"string"==typeof t&&/^\d+$/.test(t)?(u||(console.warn("THREE.VOXLoader: Accessing result as an array is deprecated. Use result.chunks[] instead."),u=!0),e.chunks[parseInt(t)]):"length"===t?(u||(console.warn("THREE.VOXLoader: Accessing result as an array is deprecated. Use result.chunks instead."),u=!0),e.chunks.length):t===Symbol.iterator?(u||(console.warn("THREE.VOXLoader: Iterating result as an array is deprecated. Use result.chunks instead."),u=!0),e.chunks[Symbol.iterator].bind(e.chunks)):e[t]})}}function buildMesh(e){const t=e.data,n=e.size,r=e.palette,s=n.x,o=n.y,a=n.z,i=new Uint8Array(s*o*a);for(let e=0;e<t.length;e+=4){const n=t[e+0],r=t[e+1],a=t[e+2],l=t[e+3];i[n+r*s+a*s*o]=l}const l=[],c=[],d=[],u=new Color;let f=!1;const h=[s,o,a];for(let e=0;e<3;e++){const t=(e+1)%3,n=(e+2)%3,p=h[e],g=h[t],m=h[n],b=[0,0,0],y=new Int16Array(g*m);b[e]=1;for(let h=0;h<=p;h++){let U=0;for(let r=0;r<m;r++)for(let a=0;a<g;a++){const l=[0,0,0];l[e]=h,l[t]=a,l[n]=r;const c=l[0],d=l[1],u=l[2],f=h>0?i[c-b[0]+(d-b[1])*s+(u-b[2])*s*o]:0,g=h<p?i[c+d*s+u*s*o]:0;y[U]=f>0&&0===g?f:g>0&&0===f?-g:0,U++}U=0;for(let i=0;i<m;i++)for(let p=0;p<g;){const b=y[U];if(0!==b){let x=1;for(;p+x<g&&y[U+x]===b;)x++;let D=1,w=!1;for(;i+D<m&&!w;){for(let e=0;e<x;e++)if(y[U+e+D*g]!==b){w=!0;break}w||D++}const I=[0,0,0];I[e]=h,I[t]=p,I[n]=i;const M=[0,0,0],O=[0,0,0];M[t]=x,O[n]=D;const v=r[Math.abs(b)],z=(255&v)/255,T=(v>>8&255)/255,F=(v>>16&255)/255;(z>0||T>0||F>0)&&(f=!0),u.setRGB(z,T,F,SRGBColorSpace);const R=e=>[e[0]-s/2,e[2]-a/2,-e[1]+o/2],V=R(I),X=R([I[0]+M[0],I[1]+M[1],I[2]+M[2]]),A=R([I[0]+M[0]+O[0],I[1]+M[1]+O[1],I[2]+M[2]+O[2]]),S=R([I[0]+O[0],I[1]+O[1],I[2]+O[2]]),L=l.length/3;b>0?(l.push(...V,...X,...A,...S),c.push(L,L+1,L+2,L,L+2,L+3)):(l.push(...V,...S,...A,...X),c.push(L,L+1,L+2,L,L+2,L+3)),d.push(u.r,u.g,u.b,u.r,u.g,u.b,u.r,u.g,u.b,u.r,u.g,u.b);for(let e=0;e<D;e++)for(let t=0;t<x;t++)y[U+t+e*g]=0;p+=x,U+=x}else p++,U++}}}const p=new BufferGeometry;p.setAttribute("position",new Float32BufferAttribute(l,3)),p.setIndex(c),p.computeVertexNormals();const g=new MeshStandardMaterial;return f&&(p.setAttribute("color",new Float32BufferAttribute(d,3)),g.vertexColors=!0),new Mesh(p,g)}function buildData3DTexture(e){const t=e.data,n=e.size,r=n.x,s=n.x*n.y,o=new Uint8Array(n.x*n.y*n.z);for(let e=0;e<t.length;e+=4){o[t[e+0]+t[e+1]*r+t[e+2]*s]=255}const a=new Data3DTexture(o,n.x,n.y,n.z);return a.format=RedFormat,a.minFilter=NearestFilter,a.magFilter=LinearFilter,a.unpackAlignment=1,a.needsUpdate=!0,a}class VOXMesh extends Mesh{constructor(e){console.warn("VOXMesh has been deprecated. Use buildMesh() instead.");const t=buildMesh(e);super(t.geometry,t.material)}}class VOXData3DTexture extends Data3DTexture{constructor(e){console.warn("VOXData3DTexture has been deprecated. Use buildData3DTexture() instead.");const t=buildData3DTexture(e);super(t.image.data,t.image.width,t.image.height,t.image.depth),this.format=t.format,this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.unpackAlignment=t.unpackAlignment,this.needsUpdate=!0}}export{VOXLoader,buildMesh,buildData3DTexture,VOXMesh,VOXData3DTexture};