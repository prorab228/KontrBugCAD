import{Clock,Vector3,Quaternion,Matrix4}from"three";const JOLT_PATH="https://cdn.jsdelivr.net/npm/jolt-physics@0.23.0/dist/jolt-physics.wasm-compat.js",frameRate=60;let Jolt=null;function getShape(t){const e=t.parameters;if("BoxGeometry"===t.type){const t=void 0!==e.width?e.width/2:.5,o=void 0!==e.height?e.height/2:.5,n=void 0!==e.depth?e.depth/2:.5;return new Jolt.BoxShape(new Jolt.Vec3(t,o,n),.05*Math.min(t,o,n),null)}if("SphereGeometry"===t.type||"IcosahedronGeometry"===t.type){const t=void 0!==e.radius?e.radius:1;return new Jolt.SphereShape(t,null)}return console.error("JoltPhysics: Unsupported geometry type:",t.type),null}const LAYER_NON_MOVING=0,LAYER_MOVING=1,NUM_OBJECT_LAYERS=2;function setupCollisionFiltering(t){const e=new Jolt.ObjectLayerPairFilterTable(2);e.EnableCollision(0,1),e.EnableCollision(1,1);const o=new Jolt.BroadPhaseLayer(0),n=new Jolt.BroadPhaseLayer(1),s=new Jolt.BroadPhaseLayerInterfaceTable(2,2);s.MapObjectToBroadPhaseLayer(0,o),s.MapObjectToBroadPhaseLayer(1,n),t.mObjectLayerPairFilter=e,t.mBroadPhaseLayerInterface=s,t.mObjectVsBroadPhaseLayerFilter=new Jolt.ObjectVsBroadPhaseLayerFilterTable(t.mBroadPhaseLayerInterface,2,t.mObjectLayerPairFilter,2)}async function JoltPhysics(){if(null===Jolt){const{default:t}=await import(`${JOLT_PATH}`);Jolt=await t()}const t=new Jolt.JoltSettings;setupCollisionFiltering(t);const e=new Jolt.JoltInterface(t);Jolt.destroy(t);const o=e.GetPhysicsSystem().GetBodyInterface(),n=[],s=new WeakMap,r=new Vector3,a=new Quaternion,i=new Vector3(1,1,1),c=new Matrix4;function l(t,e=0,o=0){const i=getShape(t.geometry);if(null===i)return;const l=t.isInstancedMesh?function(t,e,o,n){const s=t.instanceMatrix.array,i=[];for(let l=0;l<t.count;l++){const t=r.fromArray(s,16*l+12),h=a.setFromRotationMatrix(c.fromArray(s,16*l));i.push(y(t,h,e,o,n))}return i}(t,e,o,i):y(t.position,t.quaternion,e,o,i);e>0&&(n.push(t),s.set(t,l))}function y(t,e,n,s,r){const a=new Jolt.Vec3(t.x,t.y,t.z),i=new Jolt.Quat(e.x,e.y,e.z,e.w),c=n>0?Jolt.EMotionType_Dynamic:Jolt.EMotionType_Static,l=n>0?1:0,y=new Jolt.BodyCreationSettings(r,a,i,c,l);y.mRestitution=s;const h=o.CreateBody(y);return o.AddBody(h.GetID(),Jolt.EActivation_Activate),Jolt.destroy(y),h}const h=new Clock;return setInterval(function(){let t=h.getDelta();t=Math.min(t,1/30);const o=t>1/55?2:1;e.Step(t,o);for(let t=0,e=n.length;t<e;t++){const e=n[t];if(e.isInstancedMesh){const t=e.instanceMatrix.array,o=s.get(e);for(let e=0;e<o.length;e++){const n=o[e],s=n.GetPosition(),l=n.GetRotation();r.set(s.GetX(),s.GetY(),s.GetZ()),a.set(l.GetX(),l.GetY(),l.GetZ(),l.GetW()),c.compose(r,a,i).toArray(t,16*e)}e.instanceMatrix.needsUpdate=!0,e.computeBoundingSphere()}else{const t=s.get(e),o=t.GetPosition(),n=t.GetRotation();e.position.set(o.GetX(),o.GetY(),o.GetZ()),e.quaternion.set(n.GetX(),n.GetY(),n.GetZ(),n.GetW())}}},1e3/60),{addScene:function(t){t.traverse(function(t){if(t.isMesh){const e=t.userData.physics;e&&l(t,e.mass,e.restitution)}})},addMesh:l,setMeshPosition:function(t,e,n=0){if(t.isInstancedMesh){const r=s.get(t),a=r[n];o.RemoveBody(a.GetID()),o.DestroyBody(a.GetID());const i=t.userData.physics,c=a.GetShape(),l=y(e,{x:0,y:0,z:0,w:1},i.mass,i.restitution,c);r[n]=l}},setMeshVelocity:function(t,e,o=0){}}}export{JoltPhysics};