import{BufferAttribute,BufferGeometry,Color,DynamicDrawUsage,Matrix4,Mesh,MeshStandardMaterial,Vector3}from"three";function TubePainter(){const r=3e6,a=new BufferAttribute(new Float32Array(r),3);a.usage=DynamicDrawUsage;const t=new BufferAttribute(new Float32Array(r),3);t.usage=DynamicDrawUsage;const o=new BufferAttribute(new Float32Array(r),3);o.usage=DynamicDrawUsage;const e=new BufferGeometry;e.setAttribute("position",a),e.setAttribute("normal",t),e.setAttribute("color",o),e.drawRange.count=0;const y=new MeshStandardMaterial({vertexColors:!0}),n=new Mesh(e,y);function s(r){const a=2*Math.PI,t=[],o=.01*r;for(let r=0;r<15;r++){const e=r/15*a;t.push(new Vector3(Math.sin(e)*o,Math.cos(e)*o,0))}return t}n.frustumCulled=!1;const c=new Vector3,i=new Vector3,l=new Vector3,A=new Vector3,d=new Vector3,p=new Color(16777215),M=new Color(16777215);let u=1,m=1;function f(r,y,n,M){let u=e.drawRange.count;const m=s(M).length,f=.01*M,h=n?-1:1;for(let e=0;e<4;e++){const s=e/4*Math.PI*.5,M=(e+1)/4*Math.PI*.5,z=Math.sin(s)*f*h,V=Math.cos(s)*f,x=Math.sin(M)*f*h,D=Math.cos(M)*f;for(let e=0;e<m;e++){const s=e/m*Math.PI*2,M=(e+1)/m*Math.PI*2,f=Math.sin(s)*V,h=Math.cos(s)*V,R=Math.sin(M)*V,b=Math.cos(M)*V,U=Math.sin(s)*D,P=Math.cos(s)*D,I=Math.sin(M)*D,S=Math.cos(M)*D;i.set(f,h,z).applyMatrix4(y).add(r),l.set(R,b,z).applyMatrix4(y).add(r),A.set(U,P,x).applyMatrix4(y).add(r),d.set(I,S,x).applyMatrix4(y).add(r),w.set(f,h,z).normalize().transformDirection(y),c.set(R,b,z).normalize().transformDirection(y),g.set(U,P,x).normalize().transformDirection(y),n?(i.toArray(a.array,3*u),l.toArray(a.array,3*(u+1)),A.toArray(a.array,3*(u+2)),w.toArray(t.array,3*u),c.toArray(t.array,3*(u+1)),g.toArray(t.array,3*(u+2))):(i.toArray(a.array,3*u),A.toArray(a.array,3*(u+1)),l.toArray(a.array,3*(u+2)),w.toArray(t.array,3*u),g.toArray(t.array,3*(u+1)),c.toArray(t.array,3*(u+2))),p.toArray(o.array,3*u),p.toArray(o.array,3*(u+1)),p.toArray(o.array,3*(u+2)),u+=3,D>.001&&(w.set(R,b,z).normalize().transformDirection(y),c.set(I,S,x).normalize().transformDirection(y),g.set(U,P,x).normalize().transformDirection(y),n?(l.toArray(a.array,3*u),d.toArray(a.array,3*(u+1)),A.toArray(a.array,3*(u+2)),w.toArray(t.array,3*u),c.toArray(t.array,3*(u+1)),g.toArray(t.array,3*(u+2))):(A.toArray(a.array,3*u),d.toArray(a.array,3*(u+1)),l.toArray(a.array,3*(u+2)),g.toArray(t.array,3*u),c.toArray(t.array,3*(u+1)),w.toArray(t.array,3*(u+2))),p.toArray(o.array,3*u),p.toArray(o.array,3*(u+1)),p.toArray(o.array,3*(u+2)),u+=3)}}e.drawRange.count=u}const h=new Vector3,w=new Vector3,g=new Vector3,z=new Vector3,V=new Vector3,x=new Matrix4,D=new Matrix4,R=new Vector3,b=new Vector3,U=new Vector3;let P=!0,I=null,S=0;let B=0;return{mesh:n,moveTo:function(r){V.copy(r),R.set(0,1,0),P=!0,I=null,S=0},lineTo:function(r){z.copy(r),h.subVectors(z,V),0!==h.length()&&(h.normalize(),function(){if(!0===P)Math.abs(h.y)<.99?(c.copy(h).multiplyScalar(h.y),w.set(0,1,0).sub(c).normalize()):(c.copy(h).multiplyScalar(h.x),w.set(1,0,0).sub(c).normalize());else{U.crossVectors(b,h);const r=U.length();if(r>1e-4){U.divideScalar(r),c.addVectors(b,h);const a=-2/(1+b.dot(h)),t=R.dot(c);w.copy(R).addScaledVector(c,a*t)}else w.copy(R)}if(g.crossVectors(h,w).normalize(),w.crossVectors(g,h).normalize(),!1===P){const r=.3;w.lerp(R,r).normalize(),g.crossVectors(h,w).normalize(),w.crossVectors(g,h).normalize()}R.copy(w),b.copy(h),x.makeBasis(g,w,c.copy(h).negate())}(),!0===P&&(M.copy(p),m=u,D.copy(x),f(V,D,!1,m),I=e.drawRange.count,f(z,x,!0,u),S=e.drawRange.count-I),function(r,y,n,c,u,m){if(0===r.distanceToSquared(y))return;let f=e.drawRange.count;const h=s(u),w=s(m);for(let e=0,s=w.length;e<s;e++){const u=w[e],m=w[(e+1)%s],g=h[e],z=h[(e+1)%s];i.copy(u).applyMatrix4(c).add(y),l.copy(m).applyMatrix4(c).add(y),A.copy(z).applyMatrix4(n).add(r),d.copy(g).applyMatrix4(n).add(r),i.toArray(a.array,3*(f+0)),l.toArray(a.array,3*(f+1)),d.toArray(a.array,3*(f+2)),l.toArray(a.array,3*(f+3)),A.toArray(a.array,3*(f+4)),d.toArray(a.array,3*(f+5)),i.copy(u).applyMatrix4(c).normalize(),l.copy(m).applyMatrix4(c).normalize(),A.copy(z).applyMatrix4(n).normalize(),d.copy(g).applyMatrix4(n).normalize(),i.toArray(t.array,3*(f+0)),l.toArray(t.array,3*(f+1)),d.toArray(t.array,3*(f+2)),l.toArray(t.array,3*(f+3)),A.toArray(t.array,3*(f+4)),d.toArray(t.array,3*(f+5)),M.toArray(o.array,3*(f+0)),M.toArray(o.array,3*(f+1)),p.toArray(o.array,3*(f+2)),M.toArray(o.array,3*(f+3)),p.toArray(o.array,3*(f+4)),p.toArray(o.array,3*(f+5)),f+=6}e.drawRange.count=f}(z,V,x,D,u,m),function(r,e,y){if(null===I)return;const n=s(y).length,M=.01*y;let u=I;for(let y=0;y<4;y++){const s=y/4*Math.PI*.5,m=(y+1)/4*Math.PI*.5,f=-Math.sin(s)*M,h=Math.cos(s)*M,z=-Math.sin(m)*M,V=Math.cos(m)*M;for(let y=0;y<n;y++){const s=y/n*Math.PI*2,M=(y+1)/n*Math.PI*2,m=Math.sin(s)*h,x=Math.cos(s)*h,D=Math.sin(M)*h,R=Math.cos(M)*h,b=Math.sin(s)*V,U=Math.cos(s)*V,P=Math.sin(M)*V,I=Math.cos(M)*V;i.set(m,x,f).applyMatrix4(e).add(r),l.set(D,R,f).applyMatrix4(e).add(r),A.set(b,U,z).applyMatrix4(e).add(r),d.set(P,I,z).applyMatrix4(e).add(r),w.set(m,x,f).normalize().transformDirection(e),c.set(D,R,f).normalize().transformDirection(e),g.set(b,U,z).normalize().transformDirection(e),i.toArray(a.array,3*u),l.toArray(a.array,3*(u+1)),A.toArray(a.array,3*(u+2)),w.toArray(t.array,3*u),c.toArray(t.array,3*(u+1)),g.toArray(t.array,3*(u+2)),p.toArray(o.array,3*u),p.toArray(o.array,3*(u+1)),p.toArray(o.array,3*(u+2)),u+=3,V>.001&&(w.set(D,R,f).normalize().transformDirection(e),c.set(P,I,z).normalize().transformDirection(e),g.set(b,U,z).normalize().transformDirection(e),l.toArray(a.array,3*u),d.toArray(a.array,3*(u+1)),A.toArray(a.array,3*(u+2)),w.toArray(t.array,3*u),c.toArray(t.array,3*(u+1)),g.toArray(t.array,3*(u+2)),p.toArray(o.array,3*u),p.toArray(o.array,3*(u+1)),p.toArray(o.array,3*(u+2)),u+=3)}}a.addUpdateRange(3*I,3*S),t.addUpdateRange(3*I,3*S),o.addUpdateRange(3*I,3*S)}(z,x,u),V.copy(z),D.copy(x),M.copy(p),m=u,P=!1)},setSize:function(r){u=r},setColor:function(r){p.copy(r)},update:function(){const r=B,y=e.drawRange.count;r!==y&&(a.addUpdateRange(3*r,3*(y-r)),a.needsUpdate=!0,t.addUpdateRange(3*r,3*(y-r)),t.needsUpdate=!0,o.addUpdateRange(3*r,3*(y-r)),o.needsUpdate=!0,B=y)}}}export{TubePainter};