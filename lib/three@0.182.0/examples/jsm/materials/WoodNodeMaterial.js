import*as THREE from"three";import*as TSL from"three/tsl";const mapRange=TSL.Fn(([a,e,r,n,i,t])=>{const l=a.sub(e).div(r.sub(e)),o=n.add(l.mul(i.sub(n)));return TSL.select(t,TSL.max(TSL.min(o,i),n),o)}),voronoi3d=TSL.wgslFn("\n    fn voronoi3d(x: vec3<f32>, smoothness: f32, randomness: f32) -> f32\n    {\n        let p = floor(x);\n        let f = fract(x);\n\n        var res = 0.0;\n        var totalWeight = 0.0;\n        \n        for (var k = -1; k <= 1; k++)\n        {\n            for (var j = -1; j <= 1; j++)\n            {\n                for (var i = -1; i <= 1; i++)\n                {\n                    let b = vec3<f32>(f32(i), f32(j), f32(k));\n                    let hashOffset = hash3d(p + b) * randomness;\n                    let r = b - f + hashOffset;\n                    let d = length(r);\n                    \n                    let weight = exp(-d * d / max(smoothness * smoothness, 0.001));\n                    res += d * weight;\n                    totalWeight += weight;\n                }\n            }\n        }\n        \n        if (totalWeight > 0.0)\n        {\n            res /= totalWeight;\n        }\n        \n        return smoothstep(0.0, 1.0, res);\n    }\n\n    fn hash3d(p: vec3<f32>) -> vec3<f32>\n    {\n        var p3 = fract(p * vec3<f32>(0.1031, 0.1030, 0.0973));\n        p3 += dot(p3, p3.yzx + 33.33);\n        return fract((p3.xxy + p3.yzz) * p3.zyx);\n    }\n"),softLightMix=TSL.Fn(([a,e,r])=>{const n=TSL.float(1).sub(a),i=TSL.vec3(1),t=i.sub(i.sub(r).mul(i.sub(e)));return n.mul(e).add(a.mul(i.sub(e).mul(r).mul(e).add(e.mul(t))))}),noiseFbm=TSL.Fn(([a,e,r,n,i])=>{const t=TSL.float(1).toVar(),l=TSL.float(1).toVar(),o=TSL.float(0).toVar(),s=TSL.float(0).toVar(),c=e.floor();TSL.Loop(c,()=>{const e=TSL.mx_noise_float(a.mul(t));s.addAssign(e.mul(l)),o.addAssign(l),l.mulAssign(r),t.mulAssign(n)});const S=e.sub(c),m=S.greaterThan(.001);return TSL.select(m,TSL.select(i.equal(1),(()=>{const e=TSL.mx_noise_float(a.mul(t)),r=s.add(e.mul(l)),n=o.add(l),i=s.div(o).mul(.5).add(.5),c=r.div(n).mul(.5).add(.5);return TSL.mix(i,c,S)})(),(()=>{const e=TSL.mx_noise_float(a.mul(t)),r=s.add(e.mul(l));return TSL.mix(s,r,S)})()),TSL.select(i.equal(1),s.div(o).mul(.5).add(.5),s))}),noiseFbm3d=TSL.Fn(([a,e,r,n,i])=>{const t=TSL.float(1).toVar(),l=TSL.float(1).toVar(),o=TSL.float(0).toVar(),s=TSL.vec3(0).toVar(),c=e.floor();TSL.Loop(c,()=>{const e=TSL.mx_noise_vec3(a.mul(t));s.addAssign(e.mul(l)),o.addAssign(l),l.mulAssign(r),t.mulAssign(n)});const S=e.sub(c),m=S.greaterThan(.001);return TSL.select(m,TSL.select(i.equal(1),(()=>{const e=TSL.mx_noise_vec3(a.mul(t)),r=s.add(e.mul(l)),n=o.add(l),i=s.div(o).mul(.5).add(.5),c=r.div(n).mul(.5).add(.5);return TSL.mix(i,c,S)})(),(()=>{const e=TSL.mx_noise_vec3(a.mul(t)),r=s.add(e.mul(l));return TSL.mix(s,r,S)})()),TSL.select(i.equal(1),s.div(o).mul(.5).add(.5),s))}),woodCenter=TSL.Fn(([a,e])=>{const r=a.mul(TSL.vec3(1,1,0)).length();return mapRange(r,0,1,0,e,!0)}),spaceWarp=TSL.Fn(([a,e,r,n])=>{const i=TSL.vec3(r,r,n).mul(a),t=noiseFbm3d(i.mul(1.6*1.5),TSL.float(1),TSL.float(.5),TSL.float(2),TSL.int(1)).sub(.5).mul(e),l=a.mul(TSL.vec3(1,1,0)),o=l.normalize();return t.mul(o).add(l)}),woodRings=TSL.Fn(([a,e,r,n,i,t])=>{const l=noiseFbm(a.mul(i),TSL.float(1),TSL.float(.5),TSL.float(1),TSL.int(1)).mul(n).add(a).mul(e).fract().mul(t),o=TSL.min(mapRange(l,0,r,0,1,TSL.bool(!0)),mapRange(l,r,1,1,0,TSL.bool(!0))),s=TSL.max(TSL.positionView.length().div(10),1);return TSL.smoothstep(s.negate(),s,o.sub(.5)).mul(.5).add(.5)}),woodDetail=TSL.Fn(([a,e,r,n])=>{const i=TSL.clamp(TSL.atan(a.y,a.x).div(TSL.PI2).add(.5),0,1).mul(TSL.PI2.mul(3)),t=TSL.vec3(i.sin(),r,i.cos().mul(e.z)),l=TSL.vec3(.1,1.19,.05).mul(t);return noiseFbm(l.mul(n),TSL.float(1),TSL.float(.5),TSL.float(2),TSL.bool(!0))}),cellStructure=TSL.Fn(([a,e,r])=>{const n=spaceWarp(a.mul(e.div(50)),e.div(1e3),.1,1.77),i=voronoi3d(n.xy.mul(75),.5,1);return mapRange(i,r,r.add(.21),0,1,TSL.bool(!0))}),wood=TSL.Fn(([a,e,r,n,i,t,l,o,s,c,S,m,p,g,f,h,u,d,T])=>{const L=woodCenter(a,e),W=spaceWarp(spaceWarp(a,L,r,n),i,t,.17),k=spaceWarp(W,l,o,.17),b=woodRings(k.length(),TSL.float(1).div(s),c,S,m,p),x=woodDetail(k,a,k.length(),g),z=cellStructure(W,h,u.div(TSL.max(TSL.positionView.length().mul(10),1))),G=TSL.mix(d,T,b);return softLightMix(f,softLightMix(.407,G,z),x)}),woodParams={teak:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.11,largeWarpScale:.32,largeGrainStretch:.24,smallWarpStrength:.059,smallWarpScale:2,fineWarpStrength:.006,fineWarpScale:32.8,ringThickness:1/34,ringBias:.03,ringSizeVariance:.03,ringVarianceScale:4.4,barkThickness:.3,splotchScale:.2,splotchIntensity:.541,cellScale:910,cellSize:.1,darkGrainColor:"#0c0504",lightGrainColor:"#926c50"},walnut:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.07,largeWarpScale:.42,largeGrainStretch:.34,smallWarpStrength:.016,smallWarpScale:10.3,fineWarpStrength:.028,fineWarpScale:12.7,ringThickness:1/32,ringBias:.08,ringSizeVariance:.03,ringVarianceScale:5.5,barkThickness:.98,splotchScale:1.84,splotchIntensity:.97,cellScale:710,cellSize:.31,darkGrainColor:"#311e13",lightGrainColor:"#523424"},white_oak:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.23,largeWarpScale:.21,largeGrainStretch:.21,smallWarpStrength:.034,smallWarpScale:2.44,fineWarpStrength:.01,fineWarpScale:14.3,ringThickness:1/34,ringBias:.82,ringSizeVariance:.16,ringVarianceScale:1.4,barkThickness:.7,splotchScale:.2,splotchIntensity:.541,cellScale:800,cellSize:.28,darkGrainColor:"#8b4c21",lightGrainColor:"#c57e43"},pine:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.23,largeWarpScale:.21,largeGrainStretch:.18,smallWarpStrength:.041,smallWarpScale:2.44,fineWarpStrength:.006,fineWarpScale:23.2,ringThickness:1/24,ringBias:.1,ringSizeVariance:.07,ringVarianceScale:5,barkThickness:.35,splotchScale:.51,splotchIntensity:3.32,cellScale:1480,cellSize:.07,darkGrainColor:"#c58355",lightGrainColor:"#d19d61"},poplar:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.43,largeWarpScale:.33,largeGrainStretch:.18,smallWarpStrength:.04,smallWarpScale:4.3,fineWarpStrength:.004,fineWarpScale:33.6,ringThickness:1/37,ringBias:.07,ringSizeVariance:.03,ringVarianceScale:3.8,barkThickness:.3,splotchScale:1.92,splotchIntensity:.71,cellScale:830,cellSize:.04,darkGrainColor:"#716347",lightGrainColor:"#998966"},maple:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.4,largeWarpScale:.38,largeGrainStretch:.25,smallWarpStrength:.067,smallWarpScale:2.5,fineWarpStrength:.005,fineWarpScale:33.6,ringThickness:1/35,ringBias:.1,ringSizeVariance:.07,ringVarianceScale:4.6,barkThickness:.61,splotchScale:.46,splotchIntensity:1.49,cellScale:800,cellSize:.03,darkGrainColor:"#b08969",lightGrainColor:"#bc9d7d"},red_oak:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.21,largeWarpScale:.24,largeGrainStretch:.25,smallWarpStrength:.044,smallWarpScale:2.54,fineWarpStrength:.01,fineWarpScale:14.5,ringThickness:1/34,ringBias:.92,ringSizeVariance:.03,ringVarianceScale:5.6,barkThickness:1.01,splotchScale:.28,splotchIntensity:3.48,cellScale:800,cellSize:.25,darkGrainColor:"#af613b",lightGrainColor:"#e0a27a"},cherry:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.33,largeWarpScale:.11,largeGrainStretch:.33,smallWarpStrength:.024,smallWarpScale:2.48,fineWarpStrength:.01,fineWarpScale:15.3,ringThickness:1/36,ringBias:.02,ringSizeVariance:.04,ringVarianceScale:6.5,barkThickness:.09,splotchScale:1.27,splotchIntensity:1.24,cellScale:1530,cellSize:.15,darkGrainColor:"#913f27",lightGrainColor:"#b45837"},cedar:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.11,largeWarpScale:.39,largeGrainStretch:.12,smallWarpStrength:.061,smallWarpScale:1.9,fineWarpStrength:.006,fineWarpScale:4.8,ringThickness:.04,ringBias:.01,ringSizeVariance:.07,ringVarianceScale:6.7,barkThickness:.1,splotchScale:.61,splotchIntensity:2.54,cellScale:630,cellSize:.19,darkGrainColor:"#9a5b49",lightGrainColor:"#ae745e"},mahogany:{transformationMatrix:(new THREE.Matrix4).identity(),centerSize:1.25,largeWarpScale:.26,largeGrainStretch:.29,smallWarpStrength:.044,smallWarpScale:2.54,fineWarpStrength:.01,fineWarpScale:15.3,ringThickness:1/38,ringBias:.01,ringSizeVariance:.33,ringVarianceScale:1.2,barkThickness:.07,splotchScale:.77,splotchIntensity:1.39,cellScale:1400,cellSize:.23,darkGrainColor:"#501d12",lightGrainColor:"#6d3722"}};export const WoodGenuses=["teak","walnut","white_oak","pine","poplar","maple","red_oak","cherry","cedar","mahogany"];export const Finishes=["raw","matte","semigloss","gloss"];export function GetWoodPreset(a,e){const r=woodParams[a];let n,i,t;switch(e){case"gloss":t=.2,i=.1,n=1;break;case"semigloss":t=.4,i=.4,n=1;break;case"matte":t=.6,i=1,n=1;break;default:t=1,i=0,n=0}return{...r,transformationMatrix:(new THREE.Matrix4).copy(r.transformationMatrix),genus:a,finish:e,clearcoat:n,clearcoatRoughness:i,clearcoatDarken:t}}const params=GetWoodPreset(WoodGenuses[0],Finishes[0]),uniforms={};uniforms.centerSize=TSL.uniform(params.centerSize).onObjectUpdate(({material:a})=>a.centerSize),uniforms.largeWarpScale=TSL.uniform(params.largeWarpScale).onObjectUpdate(({material:a})=>a.largeWarpScale),uniforms.largeGrainStretch=TSL.uniform(params.largeGrainStretch).onObjectUpdate(({material:a})=>a.largeGrainStretch),uniforms.smallWarpStrength=TSL.uniform(params.smallWarpStrength).onObjectUpdate(({material:a})=>a.smallWarpStrength),uniforms.smallWarpScale=TSL.uniform(params.smallWarpScale).onObjectUpdate(({material:a})=>a.smallWarpScale),uniforms.fineWarpStrength=TSL.uniform(params.fineWarpStrength).onObjectUpdate(({material:a})=>a.fineWarpStrength),uniforms.fineWarpScale=TSL.uniform(params.fineWarpScale).onObjectUpdate(({material:a})=>a.fineWarpScale),uniforms.ringThickness=TSL.uniform(params.ringThickness).onObjectUpdate(({material:a})=>a.ringThickness),uniforms.ringBias=TSL.uniform(params.ringBias).onObjectUpdate(({material:a})=>a.ringBias),uniforms.ringSizeVariance=TSL.uniform(params.ringSizeVariance).onObjectUpdate(({material:a})=>a.ringSizeVariance),uniforms.ringVarianceScale=TSL.uniform(params.ringVarianceScale).onObjectUpdate(({material:a})=>a.ringVarianceScale),uniforms.barkThickness=TSL.uniform(params.barkThickness).onObjectUpdate(({material:a})=>a.barkThickness),uniforms.splotchScale=TSL.uniform(params.splotchScale).onObjectUpdate(({material:a})=>a.splotchScale),uniforms.splotchIntensity=TSL.uniform(params.splotchIntensity).onObjectUpdate(({material:a})=>a.splotchIntensity),uniforms.cellScale=TSL.uniform(params.cellScale).onObjectUpdate(({material:a})=>a.cellScale),uniforms.cellSize=TSL.uniform(params.cellSize).onObjectUpdate(({material:a})=>a.cellSize),uniforms.darkGrainColor=TSL.uniform(new THREE.Color(params.darkGrainColor)).onObjectUpdate(({material:a},e)=>e.value.set(a.darkGrainColor)),uniforms.lightGrainColor=TSL.uniform(new THREE.Color(params.lightGrainColor)).onObjectUpdate(({material:a},e)=>e.value.set(a.lightGrainColor)),uniforms.transformationMatrix=TSL.uniform((new THREE.Matrix4).copy(params.transformationMatrix)).onObjectUpdate(({material:a})=>a.transformationMatrix);const colorNode=wood(uniforms.transformationMatrix.mul(TSL.vec4(TSL.positionLocal,1)).xyz,uniforms.centerSize,uniforms.largeWarpScale,uniforms.largeGrainStretch,uniforms.smallWarpStrength,uniforms.smallWarpScale,uniforms.fineWarpStrength,uniforms.fineWarpScale,uniforms.ringThickness,uniforms.ringBias,uniforms.ringSizeVariance,uniforms.ringVarianceScale,uniforms.barkThickness,uniforms.splotchScale,uniforms.splotchIntensity,uniforms.cellScale,uniforms.cellSize,uniforms.darkGrainColor,uniforms.lightGrainColor).mul(params.clearcoatDarken);export class WoodNodeMaterial extends THREE.MeshPhysicalMaterial{static get type(){return"WoodNodeMaterial"}constructor(a={}){super(),this.isWoodNodeMaterial=!0;const e={...GetWoodPreset("teak","raw"),...a};for(const a in e)"genus"!==a&&"finish"!==a&&("string"==typeof e[a]?this[a]=new THREE.Color(e[a]):this[a]=e[a]);this.colorNode=colorNode,this.clearcoatNode=e.clearcoat,this.clearcoatRoughness=e.clearcoatRoughness}static fromPreset(a="teak",e="raw"){const r=GetWoodPreset(a,e);return new WoodNodeMaterial(r)}}