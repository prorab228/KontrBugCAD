import{BackSide,BoxGeometry,Mesh,Vector3,NodeMaterial}from"three/webgpu";import{Fn,float,vec3,acos,add,mul,clamp,cos,dot,exp,max,mix,modelViewProjection,normalize,positionWorld,pow,smoothstep,sub,varyingProperty,vec4,uniform,cameraPosition}from"three/tsl";class SkyMesh extends Mesh{constructor(){const o=new NodeMaterial;super(new BoxGeometry(1,1,1),o),this.turbidity=uniform(2),this.rayleigh=uniform(1),this.mieCoefficient=uniform(.005),this.mieDirectionalG=uniform(.8),this.sunPosition=uniform(new Vector3),this.upUniform=uniform(new Vector3(0,1,0)),this.isSky=!0,this.isSkyMesh=!0;const t=varyingProperty("vec3"),i=varyingProperty("float"),e=varyingProperty("float"),s=varyingProperty("vec3"),a=varyingProperty("vec3"),l=Fn(()=>{const o=float(2.718281828459045),l=vec3(5804542996261093e-21,13562911419845635e-21,30265902468824876e-21),m=vec3(183999185144339.78,277980239196605.28,407904795438610.94),n=float(1.6110731556870734),r=float(1.5),u=float(1e3),d=normalize(this.sunPosition);t.assign(d);const c=dot(d,this.upUniform),f=clamp(c,-1,1),p=u.mul(max(0,float(1).sub(pow(o,n.sub(acos(f)).div(r).negate()))));i.assign(p);const h=float(1).sub(clamp(float(1).sub(exp(this.sunPosition.y.div(45e4))),0,1));e.assign(h);const v=this.rayleigh.sub(float(1).mul(float(1).sub(h)));s.assign(l.mul(v));const y=float(.2).mul(this.turbidity).mul(1e-17),g=float(.434).mul(y).mul(m);a.assign(g.mul(this.mieCoefficient));const w=modelViewProjection;return w.z.assign(w.w),w})(),m=Fn(()=>{const o=float(3.141592653589793),l=float(8400),m=float(1250),n=float(.9999566769464484),r=float(.05968310365946075),u=float(.07957747154594767),d=normalize(positionWorld.sub(cameraPosition)),c=acos(max(0,dot(this.upUniform,d))),f=float(1).div(cos(c).add(float(.15).mul(pow(float(93.885).sub(c.mul(180).div(o)),-1.253)))),p=l.mul(f),h=m.mul(f),v=exp(mul(s,p).add(mul(a,h)).negate()),y=dot(d,t),g=y.mul(.5).add(.5),w=r.mul(float(1).add(pow(g,2))),b=s.mul(w),x=pow(this.mieDirectionalG,2),P=float(1).div(pow(float(1).sub(float(2).mul(this.mieDirectionalG).mul(y)).add(x),1.5)),M=u.mul(float(1).sub(x)).mul(P),k=a.mul(M),S=pow(i.mul(add(b,k).div(add(s,a))).mul(sub(1,v)),vec3(1.5));S.mulAssign(mix(vec3(1),pow(i.mul(add(b,k).div(add(s,a))).mul(v),vec3(.5)),clamp(pow(sub(1,dot(this.upUniform,t)),5),0,1)));const G=vec3(.1).mul(v),V=smoothstep(n,n.add(2e-5),y);G.addAssign(i.mul(19e3).mul(v).mul(V));const z=add(S,G).mul(.04).add(vec3(0,3e-4,75e-5)),B=pow(z,vec3(float(1).div(float(1.2).add(e.mul(1.2)))));return vec4(B,1)})();o.side=BackSide,o.depthWrite=!1,o.vertexNode=l,o.colorNode=m}}export{SkyMesh};