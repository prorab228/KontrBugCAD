import{Color,Mesh,Vector3,MeshLambertNodeMaterial}from"three/webgpu";import{Fn,add,cameraPosition,div,normalize,positionWorld,sub,time,texture,vec2,vec3,max,dot,reflect,pow,length,float,uniform,reflector,mul,mix,diffuseColor}from"three/tsl";class WaterMesh extends Mesh{constructor(o,t){const e=new MeshLambertNodeMaterial;super(o,e),this.isWaterMesh=!0,this.resolutionScale=void 0!==t.resolutionScale?t.resolutionScale:.5,this.waterNormals=texture(t.waterNormals),this.alpha=uniform(void 0!==t.alpha?t.alpha:1),this.size=uniform(void 0!==t.size?t.size:1),this.sunColor=uniform(new Color(void 0!==t.sunColor?t.sunColor:16777215)),this.sunDirection=uniform(void 0!==t.sunDirection?t.sunDirection:new Vector3(.70707,.70707,0)),this.waterColor=uniform(new Color(void 0!==t.waterColor?t.waterColor:8355711)),this.distortionScale=uniform(void 0!==t.distortionScale?t.distortionScale:20);const i=Fn(([o])=>{const t=time,e=add(div(o,103),vec2(div(t,17),div(t,29))).toVar(),i=div(o,107).sub(vec2(div(t,-19),div(t,31))).toVar(),r=add(div(o,vec2(8907,9803)),vec2(div(t,101),div(t,97))).toVar(),s=sub(div(o,vec2(1091,1027)),vec2(div(t,109),div(t,-113))).toVar(),a=this.waterNormals.sample(e),l=this.waterNormals.sample(i),d=this.waterNormals.sample(r),n=this.waterNormals.sample(s);return a.add(l).add(d).add(n).mul(.5).sub(1)})(positionWorld.xz.mul(this.size)),r=normalize(i.xzy.mul(1.5,1,1.5)),s=cameraPosition.sub(positionWorld),a=normalize(s),l=normalize(reflect(this.sunDirection.negate(),r)),d=max(0,dot(a,l)),n=pow(d,100).mul(this.sunColor).mul(2),u=max(dot(this.sunDirection,r),0).mul(this.sunColor).mul(.5),m=length(s),c=r.xz.mul(float(.001).add(float(1).div(m))).mul(this.distortionScale);e.transparent=!0,e.opacityNode=this.alpha,e.receivedShadowPositionNode=positionWorld.add(c),e.setupOutgoingLight=()=>diffuseColor.rgb,e.colorNode=Fn(()=>{const o=reflector();o.uvNode=o.uvNode.add(c),o.reflector.resolutionScale=this.resolutionScale,this.add(o.target);const t=max(dot(a,r),0),e=float(.3),i=mul(pow(float(1).sub(t),5),float(1).sub(e)).add(e),s=max(0,dot(r,a)).mul(this.waterColor);return mix(this.sunColor.mul(u).mul(.3).add(s),o.rgb.mul(n).add(o.rgb.mul(.9)).add(vec3(.1)),i)})()}}export{WaterMesh};