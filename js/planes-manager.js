class PlanesManager{constructor(e){this.editor=e}createBasePlanes(){this.editor.basePlanes&&this.editor.worldGroup.remove(this.editor.basePlanes),this.editor.basePlanes=new THREE.Group,this.editor.basePlanes.name="base_planes";[{type:"xy",color:65280,position:{z:0},rotation:{x:0}},{type:"xz",color:16711680,position:{y:0},rotation:{x:-Math.PI/2}},{type:"yz",color:255,position:{x:0},rotation:{y:Math.PI/2,x:0}}].forEach(e=>{const t=this.createBasePlane(e.type,e.color);Object.assign(t.position,e.position),Object.assign(t.rotation,e.rotation),this.editor.basePlanes.add(t)}),this.editor.basePlanes.visible=!1,this.editor.worldGroup.add(this.editor.basePlanes)}createBasePlane(e,t){const o=new THREE.PlaneGeometry(50,50),n=new THREE.MeshBasicMaterial({color:t,transparent:!0,opacity:.1,side:THREE.DoubleSide}),a=new THREE.Mesh(o,n);return a.name=`base_plane_${e}`,a.userData={type:"base_plane",planeType:e,basePlane:!0},a}createWorkPlaneObject(e={}){const{name:t="Рабочая плоскость",planeType:o="custom",position:n=new THREE.Vector3(0,0,0),normal:a=new THREE.Vector3(0,0,1),up:r=new THREE.Vector3(0,1,0)}=e,i=new THREE.PlaneGeometry(50,50),s=new THREE.MeshBasicMaterial({color:9868816,transparent:!0,opacity:.1,side:THREE.DoubleSide,depthWrite:!1}),l=new THREE.Mesh(i,s);return l.name=`WorkPlane_${Date.now()}`,l.position.copy(n),this.orientPlaneToNormal(l,a,r),l.userData={type:"work_plane",id:`work_plane_${Date.now()}`,name:t,planeType:o,createdAt:(new Date).toISOString(),operations:[],originalNormal:a.clone(),originalUp:r.clone()},l}createSketchPlaneObject(e={}){const{position:t=new THREE.Vector3(0,0,0),normal:o=new THREE.Vector3(0,0,1),up:n=new THREE.Vector3(0,1,0),name:a="Плоскость скетча"}=e,r=new THREE.PlaneGeometry(100,100),i=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.5,side:THREE.DoubleSide,depthWrite:!1}),s=new THREE.Mesh(r,i);return s.name=`SketchPlane_${Date.now()}`,s.position.copy(t),this.orientPlaneToNormal(s,o,n),s.userData={type:"sketch_plane",id:`sketch_plane_${Date.now()}`,name:a,createdAt:(new Date).toISOString(),sketchElements:[],originalNormal:o.clone(),originalUp:n.clone()},s}orientPlaneToNormal(e,t,o=new THREE.Vector3(0,1,0)){const n=t.clone().normalize(),a=o.clone().normalize(),r=new THREE.Vector3(0,0,1);new THREE.Vector3(0,1,0);if(Math.abs(n.dot(r))>.9999)Math.abs(n.y)>.5?(e.lookAt(e.position.clone().add(n)),e.rotateY(Math.PI/2)):e.lookAt(e.position.clone().add(n));else{const t=new THREE.Quaternion;t.setFromUnitVectors(r,n),e.setRotationFromQuaternion(t);const o=new THREE.Vector3(0,1,0).applyQuaternion(e.quaternion),i=new THREE.Quaternion;i.setFromUnitVectors(o,a),e.quaternion.premultiply(i)}e.updateMatrixWorld(!0)}createPlaneOnObjectFace(e,t=!1){if(!e||!e.face)return console.warn("Неверные данные пересечения для создания плоскости"),null;const o=e.point,n=e.object;let a=e.face.normal.clone();if(n.matrixWorld){const e=(new THREE.Matrix3).getNormalMatrix(n.matrixWorld);a.applyMatrix3(e).normalize()}const r=new THREE.Vector3;n.getWorldPosition(r);r.clone().sub(o).normalize();let i=new THREE.Vector3(0,1,0);if(Math.abs(a.y)>.9)i=new THREE.Vector3(1,0,0);else{i=new THREE.Vector3(0,1,0);const e=i.clone().projectOnPlane(a).normalize();i=e.length()<.1?new THREE.Vector3(1,0,0).projectOnPlane(a).normalize():e}const s={position:o,normal:a,up:i,name:t?"Скетч на поверхности":"Рабочая плоскость на поверхности"};return t?this.createSketchPlaneObject(s):this.createWorkPlaneObject(s)}createPlaneFacingCamera(e=!1,t=100){const o=this.editor.camera,n=new THREE.Vector3;o.getWorldDirection(n);const a={position:o.position.clone().add(n.multiplyScalar(t)),normal:n.clone().negate(),up:o.up.clone(),name:e?"Скетч перед камерой":"Рабочая плоскость перед камерой"};return e?this.createSketchPlaneObject(a):this.createWorkPlaneObject(a)}setCameraForSketch(e){const t=new THREE.Vector3(0,0,1);t.applyQuaternion(e.quaternion);const o=e.position.clone().add(t.multiplyScalar(100));this.editor.camera.position.copy(o),this.editor.camera.lookAt(e.position);const n=new THREE.Vector3(0,1,0);n.applyQuaternion(e.quaternion),this.editor.camera.up.copy(n),this.editor.controls.target.copy(e.position),this.editor.controls.update()}getPlaneOrientation(e){const t=new THREE.Vector3(0,0,1);t.applyQuaternion(e.quaternion);const o=new THREE.Vector3(0,1,0);o.applyQuaternion(e.quaternion);const n=new THREE.Vector3(1,0,0);return n.applyQuaternion(e.quaternion),{normal:t,up:o,right:n,isValid:Math.abs(t.length()-1)<.001}}}