class CameraManager{constructor(t){this.renderer=t,this.camera=null,this.controls=null,this.sketchState=null,this.isSketchMode=!1,this.sketchPlane=null,this.listeners=[]}setupCamera(t,e){this.camera=new THREE.PerspectiveCamera(50,t/e,.1,1e3),this.camera.position.set(100,100,100),this.camera.lookAt(0,0,0),this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.configureControls(),this.notify()}configureControls(){this.controls.enableDamping=!0,this.controls.dampingFactor=.07,this.controls.screenSpacePanning=!0,this.controls.mouseButtons={LEFT:null,MIDDLE:THREE.MOUSE.PAN,RIGHT:THREE.MOUSE.ROTATE},this.controls.panSpeed=1,this.controls.rotateSpeed=1,this.controls.zoomSpeed=1,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.maxPolarAngle=Math.PI}setCornerView(t,e,s){console.log("setCornerView",t,e,s);const o=this.controls.enableDamping,a=this.controls.enabled;this.controls.enabled=!1,this.controls.enableDamping=!1;this.camera.position.set(100*t,100*e,100*s),this.controls.target.set(0,0,0),this.camera.up.set(0,1,0),this.camera.lookAt(this.controls.target),this.camera.updateProjectionMatrix();for(let t=0;t<3;t++)this.controls.update();this.controls.saveState(),this.controls.reset(),this.controls.enabled=a,this.controls.enableDamping=o,o&&this.controls.update(),this.notify()}setView(t){console.log("setView",t);const e=this.controls.enabled,s=this.controls.enableDamping;if(this.controls.enabled=!1,this.controls.enableDamping=!1,this.isSketchMode&&"home"===t)this._orientCameraToPlane(this.sketchPlane);else{const e={home:[100,100,100],isometric:[100,100,100],front:[0,0,-100],back:[0,0,100],top:[0,100,0],bottom:[0,-100,0],left:[-100,0,0],right:[100,0,0]};e[t]&&(this.camera.position.set(...e[t]),this.controls.target.set(0,0,0),this.camera.up.set(0,1,0),this.camera.lookAt(this.controls.target)),"perspective"===t?this.setPerspective():"orthographic"===t&&this.setOrthographic()}this.camera.updateProjectionMatrix(),this.controls.update(),this.controls.saveState(),this.controls.reset(),this.controls.enableDamping=s,this.controls.enabled=e,s&&this.controls.update(),this.notify()}_orientCameraToPlane(t){if(!t)return;const e=this.renderer.domElement.width/this.renderer.domElement.height,s=(new THREE.Box3).setFromObject(t),o=new THREE.Vector3;s.getCenter(o);const a=new THREE.Vector3;s.getSize(a);const i=Math.max(a.x,a.y,a.z),r=Math.max(.6*i,50);this.camera instanceof THREE.OrthographicCamera||this.setOrthographic(),this.camera instanceof THREE.OrthographicCamera&&(this.camera.left=-r*e/2,this.camera.right=r*e/2,this.camera.top=r/2,this.camera.bottom=-r/2);const n=new THREE.Vector3(0,1,0).applyQuaternion(t.quaternion),c=new THREE.Vector3(0,0,1).applyQuaternion(t.quaternion),h=r/2,l=o.clone().add(c.clone().multiplyScalar(h));this.camera.position.copy(l),this.camera.lookAt(o),this.camera.up.copy(n),this.controls.target.copy(o),this.camera.updateProjectionMatrix(),this.controls.update(),this.notify()}toggleProjection(){this.camera instanceof THREE.PerspectiveCamera?this.setOrthographic():this.setPerspective(),this.notify()}setPerspective(){if(!(this.camera instanceof THREE.PerspectiveCamera)){const t=this.camera.aspect||this.renderer.domElement.width/this.renderer.domElement.height,e=new THREE.PerspectiveCamera(60,t,.1,1e3);e.position.copy(this.camera.position),e.quaternion.copy(this.camera.quaternion),e.up.copy(this.camera.up),this.controls.object=e,this.camera=e}}setOrthographic(){if(!(this.camera instanceof THREE.OrthographicCamera)){const t=this.renderer.domElement.width/this.renderer.domElement.height,e=150,s=new THREE.OrthographicCamera(-e*t/2,e*t/2,e/2,-e/2,.1,1e3);s.position.copy(this.camera.position),s.quaternion.copy(this.camera.quaternion),s.up.copy(this.camera.up),this.controls.object=s,this.camera=s}}getProjectionType(){return this.camera instanceof THREE.PerspectiveCamera?"perspective":"orthographic"}pan(t,e){if(!this.camera||!this.controls)return;const s=new THREE.Vector3(1,0,0).applyQuaternion(this.camera.quaternion),o=new THREE.Vector3(0,1,0).applyQuaternion(this.camera.quaternion),a=(new THREE.Vector3).addScaledVector(s,t).addScaledVector(o,e);this.camera.position.add(a),this.controls.target.add(a),this.camera.updateProjectionMatrix(),this.controls.update(),this.notify()}enterSketchMode(t){this.sketchState={camera:this.camera,position:this.camera.position.clone(),target:this.controls.target.clone(),up:this.camera.up.clone()},this.isSketchMode=!0,this.sketchPlane=t,this._orientCameraToPlane(t)}exitSketchMode(){this.sketchState&&(this.controls.object=this.sketchState.camera,this.camera=this.sketchState.camera,this.camera.position.copy(this.sketchState.position),this.controls.target.copy(this.sketchState.target),this.camera.up.copy(this.sketchState.up),this.camera.updateProjectionMatrix(),this.controls.update(),this.sketchState=null,this.isSketchMode=!1,this.sketchPlane=null,this.notify())}handleResize(t,e){if(this.camera instanceof THREE.PerspectiveCamera)this.camera.aspect=t/e;else if(this.camera instanceof THREE.OrthographicCamera){const s=t/e,o=this.camera.top-this.camera.bottom;this.camera.left=-o*s/2,this.camera.right=o*s/2,this.camera.top=o/2,this.camera.bottom=-o/2}this.camera.updateProjectionMatrix()}updateControls(){this.controls&&this.controls.update()}onChange(t){this.listeners.push(t)}notify(){this.listeners.forEach(t=>t())}}