import*as THREE from"three";import{ParametricOperation}from"../core/parametric/ParametricOperation.js";export class LibraryManager{constructor(e){this.editor=e,this.libraryItems=[],this.categories=[],this.draggingItem=null,this.dragPreview=null,this.lastMousePosition=new THREE.Vector2,this.defaultSize=25,this.modelCache=new Map,this.loadingModels=new Map,this.libraryDataUrl="models/library.json",this.isDraggingSTL=!1,this.pendingSTLLoad=null,this.loadLibraryData()}async loadLibraryData(){console.log("Loading library data from:",this.libraryDataUrl);const e=await fetch(this.libraryDataUrl);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();console.log("Library data loaded:",t),this.categories=t.categories||[],this.processLibraryItems(t.items||[]),this.initLibraryUI(),this.initDragAndDrop(),console.log("Library initialized successfully:",this.libraryItems.length,"items")}processLibraryItems(e){this.libraryItems=e.map(e=>{const t={id:e.id,name:e.name,type:e.type,category:e.category,iconPath:e.iconPath,author:e.author||"",modelPath:e.modelPath,color:e.color?parseInt(e.color,16):9159498,loadedGeometry:null,isLoading:!1,loadError:!1,originalSize:null};return"primitive"===e.type?t.createFunction=t=>this.createPrimitive(e.id,t):"stl_model"!==e.type&&"components"!==e.type||(t.createFunction=t=>{const r=e.color?parseInt(e.color,16):9159498;return this.createSTLOperation(e.modelPath,e.name,t,r)}),t})}initLibraryUI(){this.renderFilterTabs(),this.renderLibraryGrid(),this.initSearch()}renderFilterTabs(){const e=document.querySelector(".filter-tabs");if(!e)return;e.innerHTML="";this.categories.filter(e=>!e.parent).forEach(t=>{const r=document.createElement("button");r.className="filter-btn","all"===t.id&&r.classList.add("active"),r.dataset.filter=t.filter||t.id,r.textContent=t.name,r.addEventListener("click",e=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active");const t=e.target.dataset.filter;this.renderLibraryGrid(t)}),e.appendChild(r)})}renderLibraryGrid(e="all"){const t=document.getElementById("libraryGrid");if(!t)return;t.innerHTML="";const r=this.filterLibraryItems(e);if(0===r.length){const e=document.createElement("div");return e.className="library-empty",e.innerHTML='\n                <i class="fas fa-box-open"></i>\n                <p>Нет элементов для отображения</p>\n                <small>Попробуйте другой фильтр</small>\n            ',void t.appendChild(e)}r.forEach(e=>{const r=this.createLibraryElement(e);t.appendChild(r)})}filterLibraryItems(e){return"all"===e?this.libraryItems:this.libraryItems.filter(t=>t.type===e)}createLibraryElement(e){const t=document.createElement("div");t.className="library-item",t.draggable=!0,t.dataset.itemId=e.id,t.dataset.itemType=e.type,t.title=`Перетащите в 3D окно или кликните для создания "${e.name}"`;let r="cube";"stl_model"===e.type||"components"===e.type?r="download":"basic"===e.category?r="cube":"shapes"===e.category&&(r="shapes");const i=this.getCategoryName(e.category);let a=`\n            <div class="library-item-icon">\n                ${e.iconPath?`<img src="${e.iconPath}" alt="${e.name}" class="library-item-img" draggable="false" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-${r}\\'></i>';">`:`<i class="fas fa-${r}"></i>`}\n            </div>\n            <div class="library-item-info">\n                <div class="library-item-name">${e.name}</div>\n                <div class="library-item-category">${i}</div>\n        `;return e.author&&""!==e.author.trim()&&(a+=`<div class="library-item-author">Автор: ${e.author}</div>`),"stl_model"!==e.type&&"components"!==e.type||!e.loadedGeometry?"stl_model"!==e.type&&"components"!==e.type||!e.isLoading?"stl_model"!==e.type&&"components"!==e.type||!e.loadError||(a+='<div class="library-item-status error"><i class="fas fa-exclamation-circle"></i> Ошибка</div>'):a+='<div class="library-item-status"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>':a+='<div class="library-item-status"><i class="fas fa-check-circle"></i> Готово</div>',a+=`\n            </div>\n            <div class="library-item-badge">\n                <i class="fas fa-${"stl_model"===e.type||"components"===e.type?"download":"cube"}"></i>\n            </div>\n        `,t.innerHTML=a,t.addEventListener("dragstart",t=>this.onDragStart(t,e)),t.addEventListener("dragend",e=>this.onDragEnd(e)),"stl_model"!==e.type&&"components"!==e.type||t.addEventListener("mouseenter",()=>{e.loadedGeometry||e.isLoading||e.loadError||this.preloadModel(e)}),t.addEventListener("click",t=>{"BUTTON"===t.target.tagName||t.target.closest("button")||this.onItemClick(e)}),t}getCategoryName(e){const t=this.categories.find(t=>t.id===e);if(t)return t.name;return{basic:"Базовые",shapes:"Формы",mechanical:"Механика",components:"Электронные компоненты",KontrBugTech:"КонтрБагТех",fasteners:"Крепеж"}[e]||e}initSearch(){const e=document.getElementById("librarySearch");e&&e.addEventListener("input",e=>{const t=e.target.value.toLowerCase().trim();this.filterLibrary(t)})}filterLibrary(e){const t=document.getElementById("libraryGrid"),r=document.querySelectorAll(".library-item");t&&r.length&&(e?r.forEach(t=>{const r=t.querySelector(".library-item-name")?.textContent.toLowerCase()||"",i=t.querySelector(".library-item-category")?.textContent.toLowerCase()||"",a=t.querySelector(".library-item-author")?.textContent.toLowerCase()||"";r.includes(e)||i.includes(e)||a.includes(e)?t.style.display="flex":t.style.display="none"}):r.forEach(e=>e.style.display="flex"))}initDragAndDrop(){const e=document.getElementById("viewport");e&&(e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",this.lastMousePosition.set(e.clientX,e.clientY),this.dragPreview&&this.draggingItem&&this.updateDragPreview()}),e.addEventListener("drop",e=>{if(e.preventDefault(),!this.draggingItem)return;const t=this.getDropPosition(e);t&&("primitive"===this.draggingItem.type?this.createPrimitive(this.draggingItem.id,t):"stl_model"!==this.draggingItem.type&&"components"!==this.draggingItem.type||(this.draggingItem.loadedGeometry?this.createSTLOperation(this.draggingItem.modelPath,this.draggingItem.name,t,this.draggingItem.color):this.preloadModel(this.draggingItem).then(()=>{this.createSTLOperation(this.draggingItem.modelPath,this.draggingItem.name,t,this.draggingItem.color)}))),this.clearDragPreview(),this.draggingItem=null,this.isDraggingSTL=!1,this.pendingSTLLoad=null}),e.addEventListener("dragleave",()=>{this.clearDragPreview()}))}async onDragStart(e,t){if(console.log("Drag start for item:",t),this.draggingItem=t,e.dataTransfer.setData("text/plain",t.id),e.dataTransfer.effectAllowed="copy",e.target.classList.add("dragging"),"stl_model"!==t.type&&"components"!==t.type||t.loadedGeometry)this.createDragPreview(t);else{this.isDraggingSTL=!0,this.createDragPreview(t);try{await this.loadModelForPreview(t),t.loadedGeometry&&this.dragPreview&&this.updateDragPreviewWithModel(t,t.loadedGeometry)}catch(e){console.error("Failed to load model during drag:",e)}}}onDragEnd(e){e.target?.classList?.remove("dragging"),this.clearDragPreview(),this.draggingItem=null,this.isDraggingSTL=!1,this.pendingSTLLoad=null}async onItemClick(e){if("stl_model"!==e.type&&"components"!==e.type||e.loadedGeometry){const t=this.getCenterViewPosition();"primitive"===e.type?this.createPrimitive(e.id,t):"stl_model"!==e.type&&"components"!==e.type||this.createSTLOperation(e.modelPath,e.name,t,e.color)}else{this.editor.showStatus(`Загрузка модели "${e.name}"...`,"info");try{if(await this.loadModelForPreview(e),e.loadedGeometry){const t=this.getCenterViewPosition();this.createSTLOperation(e.modelPath,e.name,t,e.color)}}catch(e){console.error("Failed to load model on click:",e)}}}createPrimitive(e,t){const r=new ParametricOperation("create_primitive",{type:e,size:this.defaultSize,color:this.getPrimitiveColor(e),position:t.toArray()},[]),i=this.editor.parametricModel.addOperation(r);return this.editor.showStatus(`Создан примитив: ${e}`,"success"),i[0]}createSTLOperation(e,t,r,i,a=null){const o={filePath:e,color:i,position:r.toArray()};a&&(o.geometryData=a);const s=new ParametricOperation("import_stl",o,[]),n=this.editor.parametricModel.addOperation(s);return this.editor.showStatus(`Модель "${t}" загружена`,"success"),n[0]}getPrimitiveColor(e){return{cube:5025616,sphere:2201331,cylinder:16750592,cone:15277667,torus:10233776,plane:6323595,pyramid:48340,wedge:16733986,tube:7951688}[e]||11184810}async createDragPreview(e){let t;this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null);const r=this.defaultSize;t="stl_model"!==e.type&&"components"!==e.type||!e.loadedGeometry?this.createGeometryForPrimitive(e.id,r):e.loadedGeometry.clone(),t.computeBoundingBox();const i=t.boundingBox,a=i.max.y-i.min.y;let o;o="primitive"===e.type?this.getPrimitiveColor(e.id):"stl_model"===e.type||"components"===e.type?e.color||9159498:2201331;const s=new THREE.MeshPhongMaterial({color:o,transparent:!0,opacity:.6,side:THREE.DoubleSide,wireframe:!1});this.dragPreview=new THREE.Mesh(t,s),this.dragPreview.visible=!1,this.dragPreview.userData.isDragPreview=!0,this.dragPreview.userData.height=a,this.dragPreview.userData.color=o,this.editor.scene.add(this.dragPreview)}async preloadModel(e){if(e.modelPath&&!e.isLoading&&!e.loadError&&!e.loadedGeometry){if(this.modelCache.has(e.modelPath)){const t=this.modelCache.get(e.modelPath);return e.loadedGeometry=t.geometry,e.originalSize=t.originalSize,void this.updateLibraryItemUI(e.id)}e.isLoading=!0,this.updateLibraryItemUI(e.id);try{const t=await this.loadSTLGeometryForPreview(e.modelPath);if(e.loadedGeometry=t.geometry,e.originalSize=t.originalSize,e.loadError=!1,this.modelCache.set(e.modelPath,{geometry:t.geometry,originalSize:t.originalSize}),console.log("Model preloaded:",e.name,"Original size:",e.originalSize),this.draggingItem&&this.draggingItem.id===e.id&&this.dragPreview){this.dragPreview.material.color.clone();this.updateDragPreviewWithModel(e,t.geometry),this.dragPreview.visible&&this.updateDragPreview()}}catch(t){console.error("Failed to preload model:",t),e.loadError=!0}finally{e.isLoading=!1,this.updateLibraryItemUI(e.id)}}}async loadModelForPreview(e){return this.preloadModel(e)}updateLibraryItemUI(e){const t=document.querySelector(`.library-item[data-item-id="${e}"]`);if(!t)return;const r=this.libraryItems.find(t=>t.id===e);if(!r)return;const i=this.createLibraryElement(r);t.replaceWith(i)}async loadSTLGeometryForPreview(e){return new Promise((t,r)=>{console.log("Loading STL for preview:",e);const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.timeout=1e4,i.onload=()=>{if(200===i.status||0===i.status){const e=i.response;try{const r=this.processSTLGeometryForPreview(e);t(r)}catch(e){r(e)}}else r(new Error(`HTTP error: ${i.status}`))},i.onerror=()=>r(new Error("Network error loading STL")),i.ontimeout=()=>r(new Error("Timeout loading STL")),i.send()})}processSTLGeometryForPreview(e){if(!this.editor.importManager)throw new Error("importManager не инициализирован");return this.editor.importManager.loadSTLGeometry(e)}updateDragPreviewWithModel(e,t){if(!this.dragPreview||!t)return;const r=this.dragPreview.material,i=r.color.clone(),a=r.opacity,o=this.dragPreview.position.clone(),s=this.dragPreview.visible;this.editor.scene.remove(this.dragPreview);const n=t.clone();n.computeBoundingBox();const l=n.boundingBox,d=l.max.y-l.min.y,c=new THREE.MeshPhongMaterial({color:i,transparent:!0,opacity:a,side:THREE.DoubleSide,wireframe:!1});this.dragPreview=new THREE.Mesh(n,c),this.dragPreview.position.copy(o),this.dragPreview.visible=s,this.dragPreview.userData.isDragPreview=!0,this.dragPreview.userData.height=d,this.dragPreview.userData.color=i.getHex(),this.editor.scene.add(this.dragPreview)}updateDragPreview(){if(!this.dragPreview||!this.draggingItem)return;const e=new MouseEvent("mousemove",{clientX:this.lastMousePosition.x,clientY:this.lastMousePosition.y}),t=this.getDropPosition(e);t&&(t.y+=this.dragPreview.userData.height/2,this.dragPreview.position.copy(t),this.dragPreview.visible=!0,"plane"===this.draggingItem.id?this.dragPreview.rotation.x=-Math.PI/2:this.dragPreview.rotation.set(0,0,0))}getDropPosition(e){const t=this.editor.renderer.domElement.getBoundingClientRect(),r=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),i=new THREE.Raycaster;i.setFromCamera(r,this.editor.camera);const a=new THREE.Plane(new THREE.Vector3(0,1,0),0),o=new THREE.Vector3;return i.ray.intersectPlane(a,o)?o:null}getCenterViewPosition(){const e=new THREE.Vector2(0,0),t=new THREE.Raycaster;t.setFromCamera(e,this.editor.camera);const r=new THREE.Plane(new THREE.Vector3(0,1,0),0),i=new THREE.Vector3;if(t.ray.intersectPlane(r,i))return i;const a=new THREE.Vector3(0,0,-1);a.applyQuaternion(this.editor.camera.quaternion);const o=this.editor.camera.position.clone().add(a.multiplyScalar(100)),s=-o.y/a.y;return o.clone().add(a.multiplyScalar(s))}clearDragPreview(){this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null)}createGeometryForPrimitive(e,t){switch(e){case"cube":default:return new THREE.BoxGeometry(t,t,t);case"sphere":return new THREE.SphereGeometry(t/2,16,16);case"cylinder":return new THREE.CylinderGeometry(t/2,t/2,t,16);case"cone":return new THREE.ConeGeometry(t/2,t,16);case"torus":return new THREE.TorusGeometry(t/1.66,t/5,8,16);case"plane":return new THREE.PlaneGeometry(t,t);case"pyramid":return new THREE.ConeGeometry(t/2,t,4);case"tube":return new THREE.CylinderGeometry(t/2,t/2,t,16,1,!0)}}serializeGeometry(e){const t=e.attributes.position.array,r=e.index?e.index.array:null;return{positions:Array.from(t),indices:r?Array.from(r):null,boundingBox:e.boundingBox?{min:e.boundingBox.min.toArray(),max:e.boundingBox.max.toArray()}:null}}addCustomSTLModel(e,t){const r=new FileReader,i=(e.name.replace(/\.stl$/i,""),"file://"+e.name);r.onload=r=>{const a=r.target.result;if(this.editor.importManager.importFromBuffer(a,e.name,t,9159498).length>0)try{const{geometry:e,originalSize:t}=this.editor.importManager.loadSTLGeometry(a);this.modelCache.set(i,{geometry:e.clone(),originalSize:t})}catch(e){console.warn("Не удалось кэшировать модель",e)}},r.onerror=()=>{this.editor.showStatus("Ошибка чтения файла","error")},r.readAsArrayBuffer(e)}refreshLibrary(){this.modelCache.clear(),this.loadingModels.clear(),this.loadLibraryData()}}