import*as THREE from"three";export class ThreadGenerator{constructor(){this.threadStandards={metric:{name:"Метрическая",standards:{M3:{diameter:3,pitch:.5,minorDiameter:2.459,threadAngle:60},M4:{diameter:4,pitch:.7,minorDiameter:3.242,threadAngle:60},M5:{diameter:5,pitch:.8,minorDiameter:4.134,threadAngle:60},M6:{diameter:6,pitch:1,minorDiameter:4.917,threadAngle:60},M8:{diameter:8,pitch:1.25,minorDiameter:6.647,threadAngle:60},M10:{diameter:10,pitch:1.5,minorDiameter:8.376,threadAngle:60},M12:{diameter:12,pitch:1.75,minorDiameter:10.106,threadAngle:60},M14:{diameter:14,pitch:2,minorDiameter:11.835,threadAngle:60},M16:{diameter:16,pitch:2,minorDiameter:13.835,threadAngle:60},M20:{diameter:20,pitch:2.5,minorDiameter:17.294,threadAngle:60},M24:{diameter:24,pitch:3,minorDiameter:20.752,threadAngle:60}}},inch:{name:"Дюймовая (UNC)",standards:{"1/4-20":{diameter:6.35,pitch:1.27,minorDiameter:5.08,threadAngle:60},"5/16-18":{diameter:7.94,pitch:1.41,minorDiameter:6.48,threadAngle:60},"3/8-16":{diameter:9.53,pitch:1.59,minorDiameter:7.94,threadAngle:60},"1/2-13":{diameter:12.7,pitch:1.95,minorDiameter:10.92,threadAngle:60},"3/4-10":{diameter:19.05,pitch:2.54,minorDiameter:16.41,threadAngle:60},"1-8":{diameter:25.4,pitch:3.18,minorDiameter:22.23,threadAngle:60}}},trapezoidal:{name:"Трапецеидальная",standards:{"Tr8x1.5":{diameter:8,pitch:1.5,minorDiameter:6.2,threadAngle:30},Tr10x2:{diameter:10,pitch:2,minorDiameter:7.5,threadAngle:30},Tr12x3:{diameter:12,pitch:3,minorDiameter:8.5,threadAngle:30},Tr16x4:{diameter:16,pitch:4,minorDiameter:11.5,threadAngle:30},Tr20x4:{diameter:20,pitch:4,minorDiameter:15.5,threadAngle:30},Tr24x5:{diameter:24,pitch:5,minorDiameter:18.5,threadAngle:30}}},pipe:{name:"Трубная (BSP)",standards:{"G1/8":{diameter:9.73,pitch:.907,minorDiameter:8.85,threadAngle:55},"G1/4":{diameter:13.16,pitch:1.337,minorDiameter:11.89,threadAngle:55},"G3/8":{diameter:16.66,pitch:1.337,minorDiameter:15.39,threadAngle:55},"G1/2":{diameter:20.96,pitch:1.814,minorDiameter:19.17,threadAngle:55},"G3/4":{diameter:26.44,pitch:1.814,minorDiameter:24.65,threadAngle:55},G1:{diameter:33.25,pitch:2.309,minorDiameter:30.92,threadAngle:55}}},custom:{name:"Произвольная",standards:{}}},this.defaultParams={type:"metric",standard:"M10",diameter:10,pitch:1.5,minorDiameter:8.376,threadAngle:60,length:30,direction:"right",threadType:"external",chamfer:!1,chamferAngle:45,segmentsPerTurn:32,quality:"medium"}}generateThreadProfile(e){const t=[],r=THREE.MathUtils.degToRad(e.threadAngle/2),a=(e.diameter-e.minorDiameter)/2,n=e.pitch/2;if("metric"===e.type||"inch"===e.type){const h=.125*e.pitch;t.push(new THREE.Vector2(-n,-a/2));const i=n-h;t.push(new THREE.Vector2(-h,-a/2+i*Math.tan(r))),t.push(new THREE.Vector2(h,a/2)),t.push(new THREE.Vector2(n-h,-a/2+i*Math.tan(r))),t.push(new THREE.Vector2(n,-a/2))}else if("trapezoidal"===e.type){const r=.25*e.pitch,h=.25*e.pitch,i=.25*e.pitch*Math.tan(THREE.MathUtils.degToRad(15));t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(-n+h,-a/2)),t.push(new THREE.Vector2(-r/2,a/2-i)),t.push(new THREE.Vector2(-r/2,a/2)),t.push(new THREE.Vector2(r/2,a/2)),t.push(new THREE.Vector2(r/2,a/2-i)),t.push(new THREE.Vector2(n-h,-a/2)),t.push(new THREE.Vector2(n,-a/2))}else if("pipe"===e.type){const e=.25*a,r=12;t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(-n+e,-a/2));for(let n=1;n<r;n++){const h=n/(r-1),i=Math.PI*h,s=e*Math.cos(i),o=a/2-e+e*Math.sin(i);t.push(new THREE.Vector2(s,o))}t.push(new THREE.Vector2(n-e,-a/2)),t.push(new THREE.Vector2(n,-a/2))}else t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(0,a/2)),t.push(new THREE.Vector2(n,-a/2));return{points:t,height:a}}createExternalThreadGeometry(e){const t={low:{segmentsPerTurn:16,radialSegments:8},medium:{segmentsPerTurn:32,radialSegments:16},high:{segmentsPerTurn:64,radialSegments:32}},r=t[e.quality]||t.medium,a=this.generateThreadProfile(e),n=a.points,h=a.height,i=Math.ceil(e.length/e.pitch),s=e.diameter/2,o=e.minorDiameter/2,m=e.length,d=new THREE.BufferGeometry,p=[],c=[],l=[],u=[],g=n.length,E=i*r.segmentsPerTurn,T="right"===e.direction?1:-1;for(let t=0;t<=E;t++){const r=t/E,a=r*i*Math.PI*2,s=r*e.length;for(let e=0;e<g;e++){const r=n[e],i=o+(r.y+h/2),m=Math.cos(a*T)*i,d=s+r.x,l=Math.sin(a*T)*i;p.push(m,d,l);const M=new THREE.Vector3(Math.cos(a*T),0,Math.sin(a*T)).normalize();c.push(M.x,M.y,M.z),u.push(t/E,e/(g-1))}}for(let e=0;e<E;e++)for(let t=0;t<g-1;t++){const r=e*g+t,a=e*g+(t+1),n=(e+1)*g+t,h=(e+1)*g+(t+1);l.push(r,a,h),l.push(r,h,n)}return this.addSpiralEndCap(d,p,c,l,u,o,s,m,r.radialSegments,n,h,i,T,"top",e.pitch),this.addSpiralEndCap(d,p,c,l,u,o,s,0,r.radialSegments,n,h,i,T,"bottom",e.pitch),d.setAttribute("position",new THREE.Float32BufferAttribute(p,3)),d.setAttribute("normal",new THREE.Float32BufferAttribute(c,3)),d.setAttribute("uv",new THREE.Float32BufferAttribute(u,2)),d.setIndex(l),d.computeVertexNormals(),d.computeBoundingBox(),d.computeBoundingSphere(),d}addSpiralEndCap(e,t,r,a,n,h,i,s,o,m,d,p,c,l,u){const g=o,E="top"===l,T=s,M=t.length/3;for(let e=0;e<=g;e++){const a=e/g*Math.PI*2,i=Math.cos(a)*h,s=Math.sin(a)*h,o=T;t.push(i,o,s),r.push(0,E?1:-1,0),n.push(e/g,0)}const f=t.length/3;for(let e=0;e<=g;e++){const a=e/g*Math.PI*2,i=h+(m[Math.floor(e/g*(m.length-1))].y+d/2),s=Math.cos(a)*i,o=Math.sin(a)*i;let p=T;if(E){p=T-a/(2*Math.PI)*u}else{p=a/(2*Math.PI)*u}t.push(s,p,o),r.push(0,E?1:-1,0),n.push(e/g,.5)}const A=t.length/3;for(let e=0;e<=g;e++){const a=e/g*Math.PI*2,h=Math.cos(a)*i,s=Math.sin(a)*i,o=T;t.push(h,o,s),r.push(0,E?1:-1,0),n.push(e/g,1)}for(let e=0;e<g;e++){const t=M+e,r=M+e+1,n=f+e,h=f+e+1;E?(a.push(t,n,r),a.push(r,n,h)):(a.push(t,r,n),a.push(r,h,n))}for(let e=0;e<g;e++){const t=f+e,r=f+e+1,n=A+e,h=A+e+1;E?(a.push(t,n,r),a.push(r,n,h)):(a.push(t,r,n),a.push(r,h,n))}}createInternalThreadGeometry(e){const t={low:{segmentsPerTurn:16,radialSegments:8},medium:{segmentsPerTurn:32,radialSegments:16},high:{segmentsPerTurn:64,radialSegments:32}},r=t[e.quality]||t.medium,a=this.generateThreadProfile(e),n=a.points,h=a.height,i=Math.ceil(e.length/e.pitch),s=e.diameter/2,o=(e.minorDiameter,1.5*s),m=e.length,d=new THREE.BufferGeometry,p=[],c=[],l=[],u=[],g=n.length,E=i*r.segmentsPerTurn,T="right"===e.direction?1:-1,M=r.radialSegments,f=p.length/3;for(let e=0;e<=M;e++){const t=e/M*Math.PI*2,r=Math.cos(t)*o,a=Math.sin(t)*o;p.push(r,m,a),c.push(Math.cos(t),0,Math.sin(t)),u.push(e/M,1),p.push(r,0,a),c.push(Math.cos(t),0,Math.sin(t)),u.push(e/M,0)}for(let e=0;e<M;e++){const t=f+2*e,r=f+2*e+1,a=f+2*(e+1),n=f+2*(e+1)+1;l.push(t,a,r),l.push(r,a,n)}const A=p.length/3;for(let t=0;t<=E;t++){const r=t/E,a=r*i*Math.PI*2,o=r*e.length;for(let e=0;e<g;e++){const r=n[e],i=s-(r.y+h/2),m=Math.cos(a*T)*i,d=o+r.x,l=Math.sin(a*T)*i;p.push(m,d,l);const M=new THREE.Vector3(-Math.cos(a*T),0,-Math.sin(a*T)).normalize();c.push(M.x,M.y,M.z),u.push(t/E,e/(g-1))}}for(let e=0;e<E;e++)for(let t=0;t<g-1;t++){const r=A+e*g+t,a=A+e*g+(t+1),n=A+(e+1)*g+t,h=A+(e+1)*g+(t+1);l.push(r,h,a),l.push(r,n,h)}return this.addInternalSpiralEndCap(d,p,c,l,u,o,s,m,r.radialSegments,n,h,i,T,"top",e.pitch),this.addInternalSpiralEndCap(d,p,c,l,u,o,s,0,r.radialSegments,n,h,i,T,"bottom",e.pitch),d.setAttribute("position",new THREE.Float32BufferAttribute(p,3)),d.setAttribute("normal",new THREE.Float32BufferAttribute(c,3)),d.setAttribute("uv",new THREE.Float32BufferAttribute(u,2)),d.setIndex(l),d.computeVertexNormals(),d.computeBoundingBox(),d.computeBoundingSphere(),d}addInternalSpiralEndCap(e,t,r,a,n,h,i,s,o,m,d,p,c,l,u){const g=o,E="top"===l,T=s,M=t.length/3;for(let e=0;e<=g;e++){const a=e/g*Math.PI*2,i=Math.cos(a)*h,s=Math.sin(a)*h,o=T;t.push(i,o,s),r.push(0,E?1:-1,0),n.push(e/g,1)}const f=t.length/3;for(let e=0;e<=g;e++){const a=e/g*Math.PI*2,h=i-(m[Math.floor(e/g*(m.length-1))].y+d/2),s=Math.cos(a)*h,o=Math.sin(a)*h;let p=T;if(E){p=T-a/(2*Math.PI)*u}else{p=a/(2*Math.PI)*u}t.push(s,p,o),r.push(0,E?1:-1,0),n.push(e/g,.5)}for(let e=0;e<g;e++){const t=M+e,r=M+e+1,n=f+e,h=f+e+1;E?(a.push(t,n,r),a.push(r,n,h)):(a.push(t,r,n),a.push(r,h,n))}}createThread(e={}){const t={...this.defaultParams,...e};let r,a;r="external"===t.threadType?this.createExternalThreadGeometry(t):this.createInternalThreadGeometry(t),a=new THREE.MeshStandardMaterial({color:"external"===t.threadType?12632256:8421504,roughness:.5,metalness:"external"===t.threadType?.6:.3,side:THREE.FrontSide,flatShading:!1});const n=new THREE.Mesh(r,a);return n.castShadow=!0,n.receiveShadow=!0,n.position.y=t.length/2,n.userData={type:"thread",threadType:t.threadType,threadParams:t,name:`${"external"===t.threadType?"Наружная":"Внутренняя"} резьба ${t.standard||t.diameter+"мм"}`,createdAt:(new Date).toISOString()},n}}