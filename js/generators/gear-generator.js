class GearGenerator{constructor(t){this.editor=t,this.defaultParams={teeth:20,module:2,pressureAngle:20,faceWidth:10,hubDiameter:20,boreDiameter:8,backlash:.1,quality:"medium",type:"simple"},this.toothSettings={toothToGapRatio:.6,topFlatness:.2,involuteQuality:16,riseRatio:.5,topRatio:.12,fallRatio:.58}}calculateGearParams(t){const e=t.teeth,o=t.module,a=THREE.MathUtils.degToRad(t.pressureAngle),s=e*o,h=o,i=1.25*o,r=s+2*h,n=s-2*i,l=s*Math.cos(a);return{teeth:e,module:o,pressureAngle:a,pitchDiameter:s,addendum:h,dedendum:i,outerDiameter:r,rootDiameter:n,baseDiameter:l,pitchRadius:s/2,outerRadius:r/2,rootRadius:n/2,baseRadius:l/2,angularPitch:2*Math.PI/e,fullToothAngle:2*Math.PI/e}}involutePoint(t,e){const o=Math.cos(e),a=Math.sin(e);return new THREE.Vector2(t*(o+e*a),t*(a-e*o))}involuteAngle(t,e){return Math.sqrt(Math.max(0,Math.pow(t/e,2)-1))}createToothProfile(t){const e=[],o=this.toothSettings.involuteQuality,a=t.baseRadius,s=t.rootRadius,h=t.outerRadius,i=this.involuteAngle(Math.max(s,a),a),r=this.involuteAngle(h,a),n=t.angularPitch*this.toothSettings.toothToGapRatio/2,l=-n;if(e.push(new THREE.Vector2(s*Math.cos(l),s*Math.sin(l))),s<a){const t=a*Math.cos(l),o=a*Math.sin(l);e.push(new THREE.Vector2(t,o))}for(let t=0;t<=o;t++){const s=i+t/o*(r-i),h=this.involutePoint(a,s),n=h.x*Math.cos(l)-h.y*Math.sin(l),c=h.x*Math.sin(l)+h.y*Math.cos(l);e.push(new THREE.Vector2(n,c))}const c=n*this.toothSettings.topFlatness;for(let t=1;t<=2;t++){const o=l+c*t;e.push(new THREE.Vector2(h*Math.cos(o),h*Math.sin(o)))}for(let t=o;t>=0;t--){const s=i+t/o*(r-i),h=this.involutePoint(a,-s),n=h.x*Math.cos(-l)-h.y*Math.sin(-l),c=h.x*Math.sin(-l)+h.y*Math.cos(-l);e.push(new THREE.Vector2(n,c))}if(s<a){const t=a*Math.cos(-l),o=a*Math.sin(-l);e.push(new THREE.Vector2(t,o))}return e.push(new THREE.Vector2(s*Math.cos(-l),s*Math.sin(-l))),e}createGearProfile(t){const e=new THREE.Shape;for(let o=0;o<t.teeth;o++){const a=o*t.fullToothAngle;if(this.createToothProfile(t).forEach((t,s)=>{const h=t.x*Math.cos(a)-t.y*Math.sin(a),i=t.x*Math.sin(a)+t.y*Math.cos(a);0===o&&0===s?e.moveTo(h,i):e.lineTo(h,i)}),o<t.teeth-1){const o=t.fullToothAngle*(1-this.toothSettings.toothToGapRatio);for(let s=1;s<=4;s++){const h=s/4,i=a+t.fullToothAngle*this.toothSettings.toothToGapRatio+h*o,r=t.rootRadius*Math.cos(i),n=t.rootRadius*Math.sin(i);e.lineTo(r,n)}}}const o=(t.teeth-1)*t.fullToothAngle,a=t.fullToothAngle*(1-this.toothSettings.toothToGapRatio);for(let s=1;s<=4;s++){const h=s/4,i=o+t.fullToothAngle*this.toothSettings.toothToGapRatio+h*a,r=t.rootRadius*Math.cos(i),n=t.rootRadius*Math.sin(i);e.lineTo(r,n)}return e}createGear(t={}){const e={...this.defaultParams,...t};return"simple"===e.type?this.createSimpleGear(e):this.createPrecisionGear(e)}createPrecisionGear(t){const e=this.calculateGearParams(t);try{const o=this.createGearProfile(e);if(t.boreDiameter>0){const e=new THREE.Path;e.absarc(0,0,t.boreDiameter/2,0,2*Math.PI,!0),o.holes.push(e)}let a=32;switch(t.quality){case"low":a=Math.max(16,e.teeth);break;case"high":a=Math.max(64,4*e.teeth);break;default:a=Math.max(32,2*e.teeth)}const s={depth:t.faceWidth,bevelEnabled:!1,curveSegments:a,steps:1},h=new THREE.ExtrudeGeometry(o,s);h.rotateX(-Math.PI/2),h.translate(0,t.faceWidth/2,0);const i=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3,side:THREE.DoubleSide}),r=new THREE.Mesh(h,i);return r.castShadow=!0,r.receiveShadow=!0,r.userData={type:"gear",gearParams:t,name:`Шестерня ${t.teeth}z M${t.module}`,createdAt:(new Date).toISOString(),precision:!0},r}catch(e){return console.error("Ошибка создания прецизионной шестерни:",e),this.createSimpleGear(t)}}createSimpleGear(t){const e=this.calculateGearParams(t),o=new THREE.Shape;let a;switch(t.quality){case"low":a=12*e.teeth;break;case"high":a=128*e.teeth;break;default:a=32*e.teeth}const s=e.fullToothAngle*this.toothSettings.toothToGapRatio,h=e.fullToothAngle*(1-this.toothSettings.toothToGapRatio);for(let t=0;t<e.teeth;t++){const i=t*e.fullToothAngle,r=Math.floor(a/e.teeth),n=Math.floor(r*(1-this.toothSettings.toothToGapRatio));for(let a=0;a<=n;a++){const s=i+a/n*h,r=Math.cos(s)*e.rootRadius,l=Math.sin(s)*e.rootRadius;0===t&&0===a?o.moveTo(r,l):o.lineTo(r,l)}const l=Math.floor(r*this.toothSettings.toothToGapRatio*this.toothSettings.riseRatio);for(let t=1;t<=l;t++){const a=t/l,r=i+h+a*(s*this.toothSettings.riseRatio),n=Math.sin(a*Math.PI/2),c=e.rootRadius+(e.outerRadius-e.rootRadius)*n,u=Math.cos(r)*c,M=Math.sin(r)*c;o.lineTo(u,M)}const c=Math.max(2,Math.floor(r*this.toothSettings.toothToGapRatio*this.toothSettings.topRatio));for(let t=1;t<=c;t++){const a=t/c,r=i+h+s*this.toothSettings.riseRatio+a*(s*this.toothSettings.topRatio),n=Math.cos(r)*e.outerRadius,l=Math.sin(r)*e.outerRadius;o.lineTo(n,l)}const u=Math.floor(r*this.toothSettings.toothToGapRatio*this.toothSettings.fallRatio);for(let t=1;t<=u;t++){const a=t/u,r=i+h+s*(this.toothSettings.riseRatio+this.toothSettings.topRatio)+a*(s*this.toothSettings.fallRatio),n=Math.cos(a*Math.PI/2),l=e.rootRadius+(e.outerRadius-e.rootRadius)*n,c=Math.cos(r)*l,M=Math.sin(r)*l;o.lineTo(c,M)}}if(o.closePath(),t.boreDiameter>0){const e=new THREE.Path;e.absarc(0,0,t.boreDiameter/2,0,2*Math.PI,!0),o.holes.push(e)}const i={depth:t.faceWidth,bevelEnabled:!1,curveSegments:Math.max(32,2*e.teeth)},r=new THREE.ExtrudeGeometry(o,i);r.rotateX(-Math.PI/2),r.translate(0,t.faceWidth/2,0);const n=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3}),l=new THREE.Mesh(r,n);return l.castShadow=!0,l.receiveShadow=!0,l.userData={type:"gear",gearParams:t,name:`Шестерня ${t.teeth}z M${t.module}`,createdAt:(new Date).toISOString(),simplified:!0},l}}