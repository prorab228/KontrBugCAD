class SketchTools{constructor(e){this.editor=e,this.currentTool="line",this.isDrawing=!1,this.currentPlane=null,this.sketches=[],this.currentSketch=null,this.elements=[],this.selectedElements=[],this.tempElement=null,this.tempGeometry=null,this.dimensionObjects=[],this.polylinePoints=[],this.dimensionInput=null,this.inputField1=null,this.inputField2=null,this.inputField3=null,this.isInputActive=!1,this.currentWidth=0,this.currentHeight=0,this.currentDiameter=0,this.currentSides=6,this.currentText="Текст",this.fontSize=20,this.snapEnabled=!0,this.snapGrid=1,this.sketchColor=1118481,this.highlightColor=16776960,this.dimensionColor=51283,this.history=[],this.historyIndex=-1,this.mouseDownHandler=null,this.mouseMoveHandler=null,this.mouseUpHandler=null,this.keyDownHandler=null,this.gridVisible=!0,this.grid=null,this.initialize()}initialize(){this.createDimensionInput(),this.updateToolButtons()}createSketchGrid(){if(this.removeSketchGrid(),!this.currentPlane||!this.gridVisible)return;const e=new THREE.Vector3(0,0,1).applyQuaternion(this.currentPlane.quaternion);let t,i;Math.abs(e.y)>.9?(t=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,0,1)):Math.abs(e.z)>.9?(t=new THREE.Vector3(1,0,0),i=new THREE.Vector3(0,1,0)):(t=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,0,1)),t.applyQuaternion(this.currentPlane.quaternion.inverse()),i.applyQuaternion(this.currentPlane.quaternion.inverse());const n=50,s=50,o=11184810,l=5592405;for(let e=-50;e<=s;e++){const r=new THREE.BufferGeometry,a=[],h=t.clone().multiplyScalar(e*n/s),m=i.clone().multiplyScalar(-50),c=i.clone().multiplyScalar(n),p=(new THREE.Vector3).addVectors(h,m).add(new THREE.Vector3(0,0,.05)),d=(new THREE.Vector3).addVectors(h,c).add(new THREE.Vector3(0,0,.05));a.push(p.x,p.y,p.z),a.push(d.x,d.y,d.z),r.setAttribute("position",new THREE.Float32BufferAttribute(a,3));const u=0===e?l:o,E=new THREE.LineBasicMaterial({color:u,linewidth:1,transparent:!0,opacity:.6}),y=new THREE.Line(r,E);y.userData.isGrid=!0,this.currentPlane.add(y),this.grid||(this.grid=[]),this.grid.push(y)}for(let e=-50;e<=s;e++){const r=new THREE.BufferGeometry,a=[],h=i.clone().multiplyScalar(e*n/s),m=t.clone().multiplyScalar(-50),c=t.clone().multiplyScalar(n),p=(new THREE.Vector3).addVectors(h,m).add(new THREE.Vector3(0,0,.05)),d=(new THREE.Vector3).addVectors(h,c).add(new THREE.Vector3(0,0,.05));a.push(p.x,p.y,p.z),a.push(d.x,d.y,d.z),r.setAttribute("position",new THREE.Float32BufferAttribute(a,3));const u=0===e?l:o,E=new THREE.LineBasicMaterial({color:u,linewidth:1,transparent:!0,opacity:.6}),y=new THREE.Line(r,E);y.userData.isGrid=!0,this.currentPlane.add(y),this.grid||(this.grid=[]),this.grid.push(y)}}removeSketchGrid(){this.grid&&(this.grid.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.grid=null)}toggleGrid(){this.gridVisible=!this.gridVisible,this.gridVisible?this.createSketchGrid():this.removeSketchGrid()}createDimensionInput(){const e=document.getElementById("sketchDimensionInput");e&&e.remove(),this.dimensionInput=document.createElement("div"),this.dimensionInput.id="sketchDimensionInput",this.dimensionInput.className="dimension-input-overlay",this.dimensionInput.style.cssText="\n            position: fixed;\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 8px 12px;\n            border-radius: 4px;\n            font-family: 'Segoe UI', Arial, sans-serif;\n            font-size: 12px;\n            z-index: 10000;\n            pointer-events: none;\n            opacity: 0;\n            transition: opacity 0.2s;\n            border: 1px solid #00c853;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);\n        ",this.dimensionInput.innerHTML='\n            <div style="display: flex; flex-direction: column; gap: 6px; min-width: 150px;">\n                <div class="input-row" id="inputRow1" style="display: flex; align-items: center; gap: 8px;">\n                    <label style="min-width: 40px; color: #aaa;">Длина:</label>\n                    <input type="number" id="dimensionInput1" style="width: 80px; padding: 4px 6px; background: #333; color: white; border: 1px solid #666; border-radius: 3px; outline: none;">\n                    <span style="color: #aaa;">мм</span>\n                </div>\n                <div class="input-row" id="inputRow2" style="display: none; align-items: center; gap: 8px;">\n                    <label style="min-width: 40px; color: #aaa;">Высота:</label>\n                    <input type="number" id="dimensionInput2" style="width: 80px; padding: 4px 6px; background: #333; color: white; border: 1px solid #666; border-radius: 3px; outline: none;">\n                    <span style="color: #aaa;">мм</span>\n                </div>\n                <div class="input-row" id="inputRow3" style="display: none; align-items: center; gap: 8px;">\n                    <label style="min-width: 40px; color: #aaa;">Стороны:</label>\n                    <input type="number" id="dimensionInput3" style="width: 80px; padding: 4px 6px; background: #333; color: white; border: 1px solid #666; border-radius: 3px; outline: none;">\n                    <span style="color: #aaa;">шт</span>\n                </div>\n                <div class="input-hint" style="font-size: 10px; color: #888; margin-top: 4px;">\n                    Enter - применить, Esc - отмена\n                </div>\n            </div>\n        ',document.body.appendChild(this.dimensionInput),this.inputField1=document.getElementById("dimensionInput1"),this.inputField2=document.getElementById("dimensionInput2"),this.inputField3=document.getElementById("dimensionInput3"),this.setupInputListeners()}setupInputListeners(){[this.inputField1,this.inputField2,this.inputField3].forEach((e,t)=>{e&&(e.addEventListener("keydown",e=>this.handleInputKeyDown(e,t+1)),e.addEventListener("input",e=>this.handleInputChange(e,t+1)))}),this.dimensionInput.addEventListener("click",e=>{e.stopPropagation(),this.inputField1&&this.inputField1.focus()}),document.addEventListener("mousedown",e=>{this.dimensionInput&&"1"===this.dimensionInput.style.opacity&&!this.dimensionInput.contains(e.target)&&this.applyDimensionInput()})}showDimensionInput(e,t,i="single",n={}){if(this.dimensionInput){this.dimensionInput.style.left=`${e+15}px`,this.dimensionInput.style.top=t-10+"px",this.dimensionInput.style.opacity="1",this.dimensionInput.style.pointerEvents="auto";for(let e=1;e<=3;e++){const t=document.getElementById(`inputRow${e}`);t&&(t.style.display="none")}switch(i){case"single":document.getElementById("inputRow1").style.display="flex",document.querySelector("#inputRow1 label").textContent="Длина:",this.inputField1.type="number",this.inputField1.value=n.value1||"",this.inputField1.focus(),this.inputField1.select();break;case"rectangle":document.getElementById("inputRow1").style.display="flex",document.getElementById("inputRow2").style.display="flex",document.querySelector("#inputRow1 label").textContent="Ширина:",document.querySelector("#inputRow2 label").textContent="Высота:",this.inputField1.value=n.value1||"",this.inputField2.value=n.value2||"",this.inputField1.focus(),this.inputField1.select();break;case"circle":document.getElementById("inputRow1").style.display="flex",document.querySelector("#inputRow1 label").textContent="Диаметр:",this.inputField1.value=n.value1||"",this.inputField1.focus(),this.inputField1.select();break;case"polygon":document.getElementById("inputRow1").style.display="flex",document.getElementById("inputRow3").style.display="flex",document.querySelector("#inputRow1 label").textContent="Диаметр:",document.querySelector("#inputRow3 label").textContent="Стороны:",this.inputField1.value=n.value1||"",this.inputField3.value=n.value3||this.currentSides,this.inputField1.focus(),this.inputField1.select();break;case"text":document.getElementById("inputRow1").style.display="flex",document.querySelector("#inputRow1 label").textContent="Текст:",this.inputField1.type="text",this.inputField1.value=n.value1||this.currentText,this.inputField1.focus(),this.inputField1.select()}this.isInputActive=!0}}hideDimensionInput(){this.dimensionInput&&(this.dimensionInput.style.opacity="0",this.dimensionInput.style.pointerEvents="none",this.isInputActive=!1,this.inputField1&&(this.inputField1.type="number"))}handleInputKeyDown(e,t){switch(e.stopPropagation(),e.key){case"Enter":this.tempElement&&this.tempElement.type,this.applyDimensionInput(),e.preventDefault();break;case"Escape":this.hideDimensionInput(),this.cancelCurrentOperation(),e.preventDefault();break;case"Tab":e.preventDefault(),this.focusNextInput(t)}}handleInputChange(e,t){if(!this.tempElement)return;const i=parseFloat(e.target.value)||0;switch(this.tempElement.type){case"line":i>0&&this.updateLineLength(i);break;case"rectangle":1===t&&this.updateRectangleWidth(i),2===t&&this.updateRectangleHeight(i);break;case"circle":i>0&&this.updateCircleDiameter(i);break;case"polygon":1===t&&this.updatePolygonDiameter(i),3===t&&this.updatePolygonSides(Math.max(3,Math.min(50,Math.round(i))))}}focusNextInput(e){const t=[this.inputField1,this.inputField2,this.inputField3],i=e%t.length;t[i]&&"none"!==t[i].style.display&&(t[i].focus(),t[i].select())}applyDimensionInput(){if(!this.tempElement)return void this.hideDimensionInput();if("text"===this.tempElement.type){const e=this.inputField1.value.trim();if(e){const t={type:"text",position:this.tempElement.position.clone(),content:e,fontSize:this.fontSize,points:this.calculateTextPoints(this.tempElement.position,e,this.fontSize),color:this.sketchColor,textMesh:null};this.createTextGeometry(t),this.addElement(t)}return this.hideDimensionInput(),void this.clearTempOperation()}let e=parseFloat(this.inputField1.value),t=this.inputField2&&"none"!==this.inputField2.style.display?parseFloat(this.inputField2.value):null,i=this.inputField3&&"none"!==this.inputField3.style.display?parseInt(this.inputField3.value):null;switch(this.tempElement.type){case"line":e>0&&this.updateLineLength(e);break;case"rectangle":e>0&&t>0&&this.updateRectangleSize(e,t);break;case"circle":e>0&&this.updateCircleDiameter(e);break;case"polygon":e>0&&(this.updatePolygonDiameter(e),i>2&&this.updatePolygonSides(i))}this.hideDimensionInput(),this.addElement(this.tempElement),this.clearTempOperation()}editExistingSketch(e){e&&("sketch_plane"===e.userData.type||"work_plane"===e.userData.type?(this.collectSketchElements(e),this.currentPlane=e,this.currentSketch={id:e.userData.sketchId||"sketch_"+Date.now(),name:e.userData.name||"Чертеж",planeId:e.uuid,elements:this.elements,created:e.userData.createdAt||(new Date).toISOString()},this.attachMouseHandlers(),this.orientCameraToPlane(e),this.gridVisible&&this.createSketchGrid(),this.editor.showStatus("Режим редактирования скетча","success")):this.editor.showStatus("Выберите плоскость скетча для редактирования","error"))}collectSketchElements(e){return this.elements=[],this.selectedElements=[],e.children.forEach(e=>{if(e.userData&&"sketch_element"===e.userData.type){const t={type:e.userData.elementType,mesh:e,originalColor:e.userData.originalColor||new THREE.Color(this.sketchColor),color:e.userData.originalColor||this.sketchColor,localPoints:e.userData.localPoints,localPosition:e.userData.localPosition,content:e.userData.content,fontSize:e.userData.fontSize||this.fontSize,isClosed:e.userData.isClosed,sketchPlaneId:e.userData.sketchPlaneId,userData:e.userData};this.elements.push(t)}}),this.elements.length}startSketchOnPlane(e){e&&(this.currentPlane=e,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:e.uuid,elements:[],created:(new Date).toISOString()},this.elements=[],this.selectedElements=[],this.clearTempGeometry(),this.clearDimensionObjects(),this.setCurrentTool("line"),this.attachMouseHandlers(),this.orientCameraToPlane(e),this.createSketchGrid())}orientCameraToPlane(e){const t=new THREE.Vector3(0,0,1);t.applyQuaternion(e.quaternion);const i=(new THREE.Box3).setFromObject(e),n=new THREE.Vector3;i.getSize(n);const s=Math.max(n.x,n.y,n.z)/2,o=new THREE.Vector3;i.getCenter(o);const l=o.clone().add(t.clone().multiplyScalar(s));this.editor.camera.position.copy(l),this.editor.camera.lookAt(o),this.editor.controls.target.copy(o),this.editor.controls.update()}exitSketchMode(){this.currentPlane=null,this.currentSketch=null,this.elements=[],this.selectedElements=[],this.currentTool="line",this.tempElement=null,this.isDrawing=!1,this.clearTempGeometry(),this.clearDimensionObjects(),this.hideDimensionInput(),this.detachMouseHandlers(),this.removeSketchGrid(),this.editor.controls.enableRotate=!0,this.editor.controls.enablePan=!0,this.editor.controls.enableZoom=!0,this.updateToolButtons(),this.editor.showStatus("Режим чертежа завершен","info")}attachMouseHandlers(){const e=this.editor.renderer.domElement;this.mouseDownHandler=e=>this.onMouseDown(e),this.mouseMoveHandler=e=>this.onMouseMove(e),this.mouseUpHandler=e=>this.onMouseUp(e),this.keyDownHandler=e=>this.onKeyDown(e),e.addEventListener("mousedown",this.mouseDownHandler),e.addEventListener("mousemove",this.mouseMoveHandler),e.addEventListener("mouseup",this.mouseUpHandler),document.addEventListener("keydown",this.keyDownHandler),this.initDoubleClickHandler()}detachMouseHandlers(){const e=this.editor.renderer.domElement;this.mouseDownHandler&&e.removeEventListener("mousedown",this.mouseDownHandler),this.mouseMoveHandler&&e.removeEventListener("mousemove",this.mouseMoveHandler),this.mouseUpHandler&&e.removeEventListener("mouseup",this.mouseUpHandler),this.keyDownHandler&&document.removeEventListener("keydown",this.keyDownHandler)}onMouseDown(e){if(0!==e.button||this.isInputActive)return;const t=this.getPointOnPlane(e);if(t){if("select"===this.currentTool||e.ctrlKey||e.metaKey){const i=this.getElementAtPoint(t);if(i)return void(e.ctrlKey||e.metaKey?this.toggleElementSelection(i):this.selectElement(i));e.ctrlKey||e.metaKey||this.clearSelection()}switch(this.isDrawing=!0,this.currentTool){case"line":this.startLine(t,e);break;case"rectangle":this.startRectangle(t,e);break;case"circle":this.startCircle(t,e);break;case"polyline":this.tempElement&&"polyline"===this.tempElement.type?(this.tempElement.points.push(t.clone()),this.polylinePoints.push(t.clone()),this.updateTempGeometry(),this.editor.showStatus(`Точка ${this.tempElement.points.length} добавлена`,"info")):this.startPolyline(t);break;case"polygon":this.startPolygon(t,e);break;case"text":this.startText(t,e)}}}onMouseMove(e){const t=this.getPointOnPlane(e);t&&(this.updateCoordinates(t),this.isDrawing&&this.tempElement&&this.updateTempElement(t,e),this.showCursorPreview(t))}onMouseUp(e){if(0!==e.button||!this.isDrawing)return;const t=this.getPointOnPlane(e);t&&(this.tempElement&&"text"===this.tempElement.type&&!this.isDrawing||this.tempElement&&"polyline"===this.tempElement.type||(this.tempElement&&!["polyline","text"].includes(this.tempElement.type)&&this.finishDrawing(t,e),this.isDrawing=!1))}onKeyDown(e){if(this.isInputActive)return;const t=e.key.toLowerCase();switch(t){case"escape":this.cancelCurrentOperation();break;case"enter":this.tempElement&&("polyline"===this.tempElement.type?this.completePolyline():this.showDimensionInputForElement());break;case"backspace":this.tempElement&&["polyline"].includes(this.tempElement.type)&&this.removeLastPoint();break;case"delete":this.deleteSelectedElements();break;case"a":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.selectAllElements())}(t>="0"&&t<="9"||"."===t||","===t)&&this.handleNumericInput(t.replace(",","."))}startLine(e,t){this.tempElement={type:"line",start:e.clone(),end:e.clone(),length:0,points:[e.clone(),e.clone()],color:this.sketchColor},this.createTempGeometry(),this.createDimensionLine(this.tempElement.start,this.tempElement.end)}updateLineLength(e){if(!this.tempElement||"line"!==this.tempElement.type)return;this.tempElement.length=e;const t=(new THREE.Vector3).subVectors(this.tempElement.end,this.tempElement.start).normalize();0===t.length()&&t.set(1,0,0),this.tempElement.end=this.tempElement.start.clone().add(t.multiplyScalar(e)),this.tempElement.points[1]=this.tempElement.end.clone(),this.updateTempGeometry(),this.updateDimensionLine(this.tempElement.start,this.tempElement.end)}startRectangle(e,t){this.tempElement={type:"rectangle",start:e.clone(),end:e.clone(),width:0,height:0,points:this.calculateRectanglePoints(e,e),color:this.sketchColor},this.createTempGeometry(),this.createRectangleDimensions(this.tempElement.start,this.tempElement.end)}updateRectangleWidth(e){this.tempElement&&"rectangle"===this.tempElement.type&&(this.tempElement.width=e,this.updateRectangleSize())}updateRectangleHeight(e){this.tempElement&&"rectangle"===this.tempElement.type&&(this.tempElement.height=e,this.updateRectangleSize())}updateRectangleSize(e,t){this.tempElement&&"rectangle"===this.tempElement.type&&(void 0!==e&&(this.tempElement.width=e),void 0!==t&&(this.tempElement.height=t),this.tempElement.end.x=this.tempElement.start.x+this.tempElement.width,this.tempElement.end.y=this.tempElement.start.y+this.tempElement.height,this.tempElement.points=this.calculateRectanglePoints(this.tempElement.start,this.tempElement.end),this.updateTempGeometry(),this.updateRectangleDimensions(this.tempElement.start,this.tempElement.end))}startCircle(e,t){this.tempElement={type:"circle",center:e.clone(),diameter:0,radius:0,segments:32,points:this.calculateCirclePoints(e,0,32),color:this.sketchColor},this.createTempGeometry(),this.createCircleDimensions(this.tempElement.center,0)}updateCircleDiameter(e){this.tempElement&&"circle"===this.tempElement.type&&(this.tempElement.diameter=e,this.tempElement.radius=e/2,this.tempElement.points=this.calculateCirclePoints(this.tempElement.center,this.tempElement.radius,32),this.updateTempGeometry(),this.updateCircleDimensions(this.tempElement.center,this.tempElement.radius))}startPolygon(e,t){this.tempElement={type:"polygon",center:e.clone(),diameter:0,radius:0,sides:this.currentSides,points:this.calculatePolygonPoints(e,0,this.currentSides),color:this.sketchColor},this.createTempGeometry(),this.createPolygonDimensions(this.tempElement.center,0,this.currentSides)}updatePolygonDiameter(e){this.tempElement&&"polygon"===this.tempElement.type&&(this.tempElement.diameter=e,this.tempElement.radius=e/2,this.tempElement.points=this.calculatePolygonPoints(this.tempElement.center,this.tempElement.radius,this.tempElement.sides),this.updateTempGeometry(),this.updatePolygonDimensions(this.tempElement.center,this.tempElement.radius,this.tempElement.sides))}updatePolygonSides(e){this.tempElement&&"polygon"===this.tempElement.type&&(this.tempElement.sides=Math.max(3,Math.min(50,e)),this.tempElement.points=this.calculatePolygonPoints(this.tempElement.center,this.tempElement.radius,this.tempElement.sides),this.updateTempGeometry(),this.updatePolygonDimensions(this.tempElement.center,this.tempElement.radius,this.tempElement.sides))}startPolyline(e){this.polylinePoints=[e.clone()],this.tempElement={type:"polyline",points:[e.clone()],color:this.sketchColor,isComplete:!1},this.createTempGeometry()}completePolyline(){if(!this.tempElement||"polyline"!==this.tempElement.type)return;if(this.tempElement.points.length<2)return this.cancelCurrentOperation(),void this.editor.showStatus("Полилиния должна содержать минимум 2 точки","warning");const e=this.tempElement.points[this.tempElement.points.length-1],t=this.tempElement.points[this.tempElement.points.length-2];e.distanceTo(t)<.1&&this.tempElement.points.pop(),this.addElement(this.tempElement),this.clearTempOperation(),this.polylinePoints=[],this.editor.showStatus("Полилиния создана","success")}initDoubleClickHandler(){const e=this.editor.renderer.domElement;let t=0,i=null;e.addEventListener("click",e=>{0===e.button&&(t++,1===t?i=setTimeout(()=>{t=0},300):2===t&&(clearTimeout(i),t=0,"polyline"===this.currentTool&&this.tempElement&&"polyline"===this.tempElement.type&&this.completePolyline()))})}createTextGeometry(e){if(!this.currentPlane)return;const t=document.createElement("canvas"),i=t.getContext("2d");t.width=512,t.height=128,i.clearRect(0,0,t.width,t.height),i.font=`bold ${e.fontSize}px Arial`,i.fillStyle="#AAAAAA",i.textAlign="left",i.textBaseline="top",i.fillText(e.content,10,10);const n=new THREE.CanvasTexture(t);n.minFilter=THREE.LinearFilter;const s=new THREE.SpriteMaterial({map:n,transparent:!0}),o=new THREE.Sprite(s),l=this.currentPlane.worldToLocal(e.position.clone());o.position.set(l.x,l.y,.1),o.scale.set(50,12.5,1),e.textMesh=o,this.tempGeometry&&(this.currentPlane.remove(this.tempGeometry),this.tempGeometry.material&&this.tempGeometry.material.dispose(),this.tempGeometry.material.map&&this.tempGeometry.material.map.dispose()),this.tempGeometry=o,this.currentPlane.add(o)}startText(e,t){this.editor.renderer.domElement.getBoundingClientRect();this.tempElement={type:"text",position:e.clone(),content:this.currentText,fontSize:this.fontSize,color:this.sketchColor,isDrawing:!1},this.showDimensionInput(t.clientX,t.clientY,"text",{value1:this.currentText}),setTimeout(()=>{this.inputField1&&(this.inputField1.focus(),this.inputField1.select())},50)}updateTextContent(e){this.tempElement&&"text"===this.tempElement.type&&(this.tempElement.content=e,this.updateTextProperties())}updateTextProperties(){this.tempElement&&"text"===this.tempElement.type&&(this.tempElement.fontSize=this.fontSize,this.updateTempGeometry())}updateTempElement(e,t){if(this.tempElement){switch(this.tempElement.type){case"line":if(this.tempElement.end=e.clone(),this.tempElement.points[1]=e.clone(),this.tempElement.length=this.tempElement.start.distanceTo(e),this.updateDimensionLine(this.tempElement.start,this.tempElement.end),t&&this.isDrawing){const e=this.tempElement.length;this.editor.renderer.domElement.getBoundingClientRect();this.showDimensionInput(t.clientX,t.clientY,"single",{value1:e.toFixed(1)})}break;case"rectangle":if(this.tempElement.end=e.clone(),this.tempElement.width=Math.abs(e.x-this.tempElement.start.x),this.tempElement.height=Math.abs(e.y-this.tempElement.start.y),this.tempElement.points=this.calculateRectanglePoints(this.tempElement.start,e),this.updateRectangleDimensions(this.tempElement.start,e),t&&this.isDrawing){this.editor.renderer.domElement.getBoundingClientRect();this.showDimensionInput(t.clientX,t.clientY,"rectangle",{value1:this.tempElement.width.toFixed(1),value2:this.tempElement.height.toFixed(1)})}break;case"circle":if(this.tempElement.radius=this.tempElement.center.distanceTo(e),this.tempElement.diameter=2*this.tempElement.radius,this.tempElement.points=this.calculateCirclePoints(this.tempElement.center,this.tempElement.radius,32),this.updateCircleDimensions(this.tempElement.center,this.tempElement.radius),t&&this.isDrawing){this.editor.renderer.domElement.getBoundingClientRect();this.showDimensionInput(t.clientX,t.clientY,"circle",{value1:this.tempElement.diameter.toFixed(1)})}break;case"polygon":if(this.tempElement.radius=this.tempElement.center.distanceTo(e),this.tempElement.diameter=2*this.tempElement.radius,this.tempElement.points=this.calculatePolygonPoints(this.tempElement.center,this.tempElement.radius,this.tempElement.sides),this.updatePolygonDimensions(this.tempElement.center,this.tempElement.radius,this.tempElement.sides),t&&this.isDrawing){this.editor.renderer.domElement.getBoundingClientRect();this.showDimensionInput(t.clientX,t.clientY,"polygon",{value1:this.tempElement.diameter.toFixed(1),value3:this.tempElement.sides})}break;case"polyline":1===this.tempElement.points.length?this.tempElement.points=[this.tempElement.points[0],e.clone()]:this.tempElement.points.length>1&&(this.tempElement.points[this.tempElement.points.length-1]=e.clone())}this.updateTempGeometry()}}finishDrawing(e,t){this.tempElement&&(this.updateTempElement(e,t),this.isInputActive||["polyline","text"].includes(this.tempElement.type)||this.showDimensionInputForElement())}showDimensionInputForElement(){if(!this.tempElement)return;const e=this.editor.renderer.domElement.getBoundingClientRect(),t=this.editor.mouse,i=e.left+(t.x+1)*e.width/2,n=e.top+(1-t.y)*e.height/2;switch(this.tempElement.type){case"line":this.showDimensionInput(i,n,"single",{value1:this.tempElement.length.toFixed(1)});break;case"rectangle":this.showDimensionInput(i,n,"rectangle",{value1:this.tempElement.width.toFixed(1),value2:this.tempElement.height.toFixed(1)});break;case"circle":this.showDimensionInput(i,n,"circle",{value1:this.tempElement.diameter.toFixed(1)});break;case"polygon":this.showDimensionInput(i,n,"polygon",{value1:this.tempElement.diameter.toFixed(1),value3:this.tempElement.sides})}}calculateRectanglePoints(e,t){if(!this.currentPlane)return[];const i=this.currentPlane.worldToLocal(e.clone()),n=this.currentPlane.worldToLocal(t.clone()),s=Math.min(i.x,n.x),o=Math.max(i.x,n.x),l=Math.min(i.y,n.y),r=Math.max(i.y,n.y);return[new THREE.Vector3(s,l,0),new THREE.Vector3(o,l,0),new THREE.Vector3(o,r,0),new THREE.Vector3(s,r,0),new THREE.Vector3(s,l,0)].map(e=>this.currentPlane.localToWorld(e))}calculateCirclePoints(e,t,i=32){if(!this.currentPlane)return[];const n=this.currentPlane.worldToLocal(e.clone()),s=[];for(let e=0;e<=i;e++){const o=e/i*Math.PI*2,l=n.x+Math.cos(o)*t,r=n.y+Math.sin(o)*t;s.push(this.currentPlane.localToWorld(new THREE.Vector3(l,r,0)))}return s}calculatePolygonPoints(e,t,i){if(!this.currentPlane)return[];const n=this.currentPlane.worldToLocal(e.clone()),s=[];for(let e=0;e<=i;e++){const o=e/i*Math.PI*2,l=n.x+Math.cos(o)*t,r=n.y+Math.sin(o)*t;s.push(this.currentPlane.localToWorld(new THREE.Vector3(l,r,0)))}return s}calculateTextPoints(e,t,i){const n=.6*i,s=t.length*n,o=i,l=this.currentPlane.worldToLocal(e.clone());return[new THREE.Vector3(l.x,l.y,0),new THREE.Vector3(l.x+s,l.y,0),new THREE.Vector3(l.x+s,l.y+o,0),new THREE.Vector3(l.x,l.y+o,0),new THREE.Vector3(l.x,l.y,0)].map(e=>this.currentPlane.localToWorld(e))}createDimensionLine(e,t){if(this.clearDimensionObjects(),!this.currentPlane)return;const i=this.currentPlane.worldToLocal(e.clone()),n=this.currentPlane.worldToLocal(t.clone()),s=n.x-i.x,o=n.y-i.y,l=Math.sqrt(s*s+o*o),r=new THREE.Vector3(s,o,0).normalize(),a=new THREE.Vector3(-r.y,r.x,0).normalize(),h=new THREE.Vector3(i.x+10*a.x,i.y+10*a.y,.1),m=new THREE.Vector3(n.x+10*a.x,n.y+10*a.y,.1),c=(new THREE.BufferGeometry).setFromPoints([h,m]),p=new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:2}),d=new THREE.Line(c,p),u=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x,i.y,.1),h]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),E=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(n.x,n.y,.1),m]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),y=(new THREE.Vector3).addVectors(h,m).multiplyScalar(.5).add(new THREE.Vector3(5*-a.y,5*a.x,.1));this.createDimensionText(y,`${l.toFixed(1)} мм`),[d,u,E].forEach(e=>{e.userData.isDimension=!0,this.currentPlane.add(e),this.dimensionObjects.push(e)})}updateDimensionLine(e,t){this.clearDimensionObjects(),this.createDimensionLine(e,t)}createRectangleDimensions(e,t){if(this.clearDimensionObjects(),!this.currentPlane)return;const i=this.currentPlane.worldToLocal(e.clone()),n=this.currentPlane.worldToLocal(t.clone()),s=Math.min(i.x,n.x),o=Math.max(i.x,n.x),l=Math.min(i.y,n.y),r=Math.max(i.y,n.y),a=o-s,h=r-l,m=new THREE.Vector3(s,l-10,.1),c=new THREE.Vector3(o,l-10,.1),p=(new THREE.BufferGeometry).setFromPoints([m,c]),d=new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:2}),u=new THREE.Line(p,d),E=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(s,l,.1),new THREE.Vector3(s,l-10,.1)]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),y=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(o,l,.1),new THREE.Vector3(o,l-10,.1)]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),w=new THREE.Vector3(s+a/2,l-15,.1);this.createDimensionText(w,`${a.toFixed(1)} мм`);const g=new THREE.Vector3(o+10,l,.1),T=new THREE.Vector3(o+10,r,.1),x=(new THREE.BufferGeometry).setFromPoints([g,T]),f=new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:2}),R=new THREE.Line(x,f),H=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(o,l,.1),new THREE.Vector3(o+10,l,.1)]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),P=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(o,r,.1),new THREE.Vector3(o+10,r,.1)]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),D=new THREE.Vector3(o+15,l+h/2,.1);this.createDimensionText(D,`${h.toFixed(1)} мм`),[u,E,y,R,H,P].forEach(e=>{e.userData.isDimension=!0,this.currentPlane.add(e),this.dimensionObjects.push(e)})}updateRectangleDimensions(e,t){this.clearDimensionObjects(),this.createRectangleDimensions(e,t)}createCircleDimensions(e,t){if(this.clearDimensionObjects(),!this.currentPlane)return;const i=this.currentPlane.worldToLocal(e.clone()),n=new THREE.Vector3(i.x-t,i.y,.1),s=new THREE.Vector3(i.x+t,i.y,.1),o=(new THREE.BufferGeometry).setFromPoints([n,s]),l=new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:2}),r=new THREE.Line(o,l),a=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x-t,i.y-5,.1),new THREE.Vector3(i.x-t,i.y+5,.1)]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),h=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x+t,i.y-5,.1),new THREE.Vector3(i.x+t,i.y+5,.1)]),new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:1})),m=new THREE.Vector3(i.x,i.y-10,.1);this.createDimensionText(m,`Ø${(2*t).toFixed(1)}`),[r,a,h].forEach(e=>{e.userData.isDimension=!0,this.currentPlane.add(e),this.dimensionObjects.push(e)})}updateCircleDimensions(e,t){this.clearDimensionObjects(),this.createCircleDimensions(e,t)}createPolygonDimensions(e,t,i){if(this.clearDimensionObjects(),!this.currentPlane)return;const n=this.currentPlane.worldToLocal(e.clone()),s=new THREE.Vector3(n.x+t,n.y,.1),o=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(n.x,n.y,.1),s]),l=new THREE.LineBasicMaterial({color:this.dimensionColor,linewidth:2}),r=new THREE.Line(o,l),a=new THREE.Vector3(n.x,n.y-10,.1);this.createDimensionText(a,`${i}-угольник`),r.userData.isDimension=!0,this.currentPlane.add(r),this.dimensionObjects.push(r)}updatePolygonDimensions(e,t,i){this.clearDimensionObjects(),this.createPolygonDimensions(e,t,i)}createDimensionText(e,t){const i=document.createElement("canvas"),n=i.getContext("2d");i.width=256,i.height=64,n.clearRect(0,0,i.width,i.height),n.font="bold 16px Arial",n.fillStyle="#00C853",n.textAlign="center",n.textBaseline="middle",n.fillText(t,i.width/2,i.height/2);const s=new THREE.CanvasTexture(i);s.minFilter=THREE.LinearFilter;const o=new THREE.SpriteMaterial({map:s,transparent:!0}),l=new THREE.Sprite(o);l.position.copy(e),l.scale.set(20,5,1),l.userData.isDimension=!0,this.currentPlane.add(l),this.dimensionObjects.push(l)}clearDimensionObjects(){this.dimensionObjects.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()}),this.dimensionObjects=[]}getPointOnPlane(e){if(!this.currentPlane)return null;const t=this.editor.renderer.domElement.getBoundingClientRect(),i=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1);this.editor.raycaster.setFromCamera(i,this.editor.camera);const n=new THREE.Vector3(0,0,1);n.applyQuaternion(this.currentPlane.quaternion);const s=this.currentPlane.position,o=new THREE.Plane;o.setFromNormalAndCoplanarPoint(n,s);const l=new THREE.Vector3;if(this.editor.raycaster.ray.intersectPlane(o,l)){const e=this.currentPlane.worldToLocal(l.clone());return e.z=0,this.snapEnabled&&(e.x=Math.round(e.x/this.snapGrid)*this.snapGrid,e.y=Math.round(e.y/this.snapGrid)*this.snapGrid),this.currentPlane.localToWorld(e)}return null}createTempGeometry(){if(this.clearTempGeometry(),this.tempElement&&this.tempElement.points)if("text"===this.tempElement.type){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=512,e.height=128,t.clearRect(0,0,e.width,e.height),t.font=`bold ${this.fontSize}px Arial`,t.fillStyle="#AAAAAA",t.textAlign="left",t.textBaseline="top",t.fillText(this.tempElement.content,10,10);const i=new THREE.CanvasTexture(e);i.minFilter=THREE.LinearFilter;const n=new THREE.SpriteMaterial({map:i,transparent:!0}),s=new THREE.Sprite(n),o=this.currentPlane.worldToLocal(this.tempElement.position.clone());s.position.set(o.x,o.y,.1),s.scale.set(50,12.5,1),this.tempGeometry=s,this.currentPlane.add(s),this.tempElement.textMesh=s}else{const e=[];this.tempElement.points.forEach(t=>{const i=this.currentPlane.worldToLocal(t.clone());e.push(i.x,i.y,0)});const t=new THREE.BufferGeometry;let i;t.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),i=["rectangle","circle","polygon"].includes(this.tempElement.type)?new THREE.LineLoop(t,new THREE.LineBasicMaterial({color:this.tempElement.color,linewidth:2})):new THREE.Line(t,new THREE.LineBasicMaterial({color:this.tempElement.color,linewidth:2})),this.tempGeometry=i,this.currentPlane.add(i)}}updateTempGeometry(){if(this.tempGeometry&&this.tempElement)if("text"===this.tempElement.type&&this.tempElement.textMesh){const e=document.createElement("canvas"),t=e.getContext("2d");e.width=512,e.height=128,t.clearRect(0,0,e.width,e.height),t.font=`bold ${this.fontSize}px Arial`,t.fillStyle="#AAAAAA",t.textAlign="left",t.textBaseline="top",t.fillText(this.tempElement.content,10,10),this.tempElement.textMesh.material.map.dispose();const i=new THREE.CanvasTexture(e);i.minFilter=THREE.LinearFilter,this.tempElement.textMesh.material.map=i,this.tempElement.textMesh.material.needsUpdate=!0}else{const e=[];this.tempElement.points.forEach(t=>{const i=this.currentPlane.worldToLocal(t.clone());e.push(i.x,i.y,0)}),this.tempGeometry.geometry.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.tempGeometry.geometry.attributes.position.needsUpdate=!0}}clearTempGeometry(){this.tempGeometry&&(this.tempGeometry.parent&&this.tempGeometry.parent.remove(this.tempGeometry),this.tempGeometry.geometry&&this.tempGeometry.geometry.dispose(),this.tempGeometry.material&&this.tempGeometry.material.dispose(),this.tempGeometry=null)}addElement(e){if(!e||!e.points||"text"!==e.type&&e.points.length<2)this.editor.showStatus("Элемент не может быть создан: недостаточно точек","error");else{if("text"===e.type){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=512,t.height=128,i.clearRect(0,0,t.width,t.height),i.font=`bold ${e.fontSize}px Arial`,i.fillStyle="#AAAAAA",i.textAlign="left",i.textBaseline="top",i.fillText(e.content,10,10);const n=new THREE.CanvasTexture(t);n.minFilter=THREE.LinearFilter;const s=new THREE.SpriteMaterial({map:n,transparent:!0}),o=new THREE.Sprite(s),l=this.currentPlane.worldToLocal(e.position.clone());o.position.set(l.x,l.y,.1),o.scale.set(50,12.5,1),o.userData={type:"sketch_element",sketchId:this.currentSketch?.id,elementType:e.type,isClosed:!1,originalColor:new THREE.Color(e.color),sketchPlaneId:this.currentPlane?.uuid,localPosition:l,content:e.content,fontSize:e.fontSize,createdAt:(new Date).toISOString()},this.currentPlane.add(o),e.mesh=o,this.elements.push(e)}else{const t=e.points.map(e=>this.currentPlane.worldToLocal(e.clone())),i=["rectangle","circle","polygon"].includes(e.type),n=new THREE.BufferGeometry,s=[];let o;t.forEach(e=>{s.push(e.x,e.y,0)}),n.setAttribute("position",new THREE.Float32BufferAttribute(s,3)),o=i?new THREE.LineLoop(n,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchColor),linewidth:2})):new THREE.Line(n,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchColor),linewidth:2})),o.userData={type:"sketch_element",sketchId:this.currentSketch?.id,elementType:e.type,isClosed:i,originalColor:new THREE.Color(e.color||this.sketchColor),sketchPlaneId:this.currentPlane?.uuid,localPoints:t,createdAt:(new Date).toISOString()},this.currentPlane.add(o),e.mesh=o,this.elements.push(e)}this.saveToHistory(),this.editor.showStatus(`Добавлен элемент: ${this.getToolName(e.type)}`,"success")}}removeLastPoint(){this.tempElement&&["polyline"].includes(this.tempElement.type)&&(this.tempElement.points.length>2?(this.tempElement.points.pop(),this.polylinePoints.pop(),this.updateTempGeometry(),this.editor.showStatus("Последняя точка удалена","info")):2===this.tempElement.points.length&&(this.cancelCurrentOperation(),this.editor.showStatus("Полилиния отменена","info")))}clearTempOperation(){this.tempElement=null,this.clearTempGeometry(),this.clearDimensionObjects(),this.hideDimensionInput(),this.polylinePoints=[]}cancelCurrentOperation(){this.isDrawing=!1,this.clearTempOperation(),this.editor.showStatus("Операция отменена","info")}updateCoordinates(e){if(!e||!this.currentPlane)return;const t=this.currentPlane.worldToLocal(e.clone()),i=document.getElementById("coords");i&&(i.textContent=`X: ${t.x.toFixed(1)}, Y: ${t.y.toFixed(1)}, Z: ${t.z.toFixed(1)}`)}showCursorPreview(e){}setCurrentTool(e){this.currentTool=e,this.clearSelection(),this.cancelCurrentOperation(),this.updateToolButtons()}getToolName(e){return{select:"Выделение",line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polyline:"Полилиния",polygon:"Многоугольник",text:"Текст"}[e]||e}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.sketchTool===this.currentTool&&e.classList.add("active")})}handleNumericInput(e){if(this.tempElement&&!this.isInputActive)return document.activeElement&&document.activeElement.id.startsWith("dimensionInput")?(document.activeElement.value+=e,void document.activeElement.dispatchEvent(new Event("input"))):void(this.isInputActive||(this.showDimensionInputForElement(),setTimeout(()=>{this.inputField1&&(this.inputField1.value=e,this.inputField1.focus())},10)))}getElementAtPoint(e){if(!this.currentPlane)return null;const t=this.currentPlane.worldToLocal(e.clone());for(let e=this.elements.length-1;e>=0;e--){const i=this.elements[e];if(i.mesh)if("text"===i.type){const e=i.mesh.position,n=i.mesh.scale,s=n.x/2,o=n.y/2;if(Math.abs(t.x-e.x)<=s&&Math.abs(t.y-e.y)<=o)return i}else{let e=i.mesh.userData?.localPoints||i.localPoints||[];0===e.length&&i.points&&(e=i.points.map(e=>this.currentPlane.worldToLocal(e.clone())));for(let n=0;n<e.length-1;n++){const s=e[n],o=e[n+1];if(this.pointToLineDistance(t,s,o)<=5)return i}}}return null}pointToLineDistance(e,t,i){const n=e.x-t.x,s=e.y-t.y,o=i.x-t.x,l=i.y-t.y,r=o*o+l*l;let a,h,m=-1;0!==r&&(m=(n*o+s*l)/r),m<0?(a=t.x,h=t.y):m>1?(a=i.x,h=i.y):(a=t.x+m*o,h=t.y+m*l);const c=e.x-a,p=e.y-h;return Math.sqrt(c*c+p*p)}selectElement(e){this.clearSelection(),this.selectedElements=[e],this.highlightElement(e),this.editor.showStatus(`Выбран элемент: ${this.getToolName(e.type)}`,"info")}toggleElementSelection(e){const t=this.selectedElements.indexOf(e);t>-1?(this.unhighlightElement(e),this.selectedElements.splice(t,1)):(this.selectedElements.push(e),this.highlightElement(e)),this.editor.showStatus(`Выбрано элементов: ${this.selectedElements.length}`,"info")}selectAllElements(){this.clearSelection(),this.selectedElements=[...this.elements],this.selectedElements.forEach(e=>this.highlightElement(e)),this.editor.showStatus(`Выбрано всех элементов: ${this.selectedElements.length}`,"info")}clearSelection(){this.selectedElements.forEach(e=>this.unhighlightElement(e)),this.selectedElements=[]}highlightElement(e){e.mesh&&e.mesh.material&&(e.originalColor||(e.mesh.material.color?e.originalColor=e.mesh.material.color.clone():e.originalColor=new THREE.Color(this.sketchColor)),e.mesh.material.color&&(e.mesh.material.color.set(this.highlightColor),e.mesh.material.needsUpdate=!0),void 0!==e.mesh.material.linewidth&&(e.mesh.material.linewidth=4,e.mesh.material.needsUpdate=!0),"text"===e.type&&e.mesh.scale&&(e.originalScale=e.mesh.scale.clone(),e.mesh.scale.multiplyScalar(1.2)))}unhighlightElement(e){e.mesh&&e.mesh.material&&e.originalColor&&(e.mesh.material.color.copy(e.originalColor),e.mesh.material.needsUpdate=!0,void 0!==e.mesh.material.linewidth&&(e.mesh.material.linewidth=2,e.mesh.material.needsUpdate=!0),"text"===e.type&&e.originalScale&&e.mesh.scale&&e.mesh.scale.copy(e.originalScale))}deleteSelectedElements(){if(0===this.selectedElements.length)return void this.editor.showStatus("Нет выделенных элементов для удаления","warning");if(!confirm(`Удалить ${this.selectedElements.length} элементов?`))return;const e=[...this.selectedElements];e.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose(),e.mesh.map&&e.mesh.map.dispose());const t=this.elements.indexOf(e);t>-1&&this.elements.splice(t,1)}),this.selectedElements=[],this.saveToHistory(),this.editor.showStatus(`Удалено элементов: ${e.length}`,"success")}deleteAllElements(){0!==this.elements.length&&confirm("Очистить весь чертеж?")&&(this.elements.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose(),e.mesh.map&&e.mesh.map.dispose())}),this.elements=[],this.selectedElements=[],this.clearTempGeometry(),this.saveToHistory(),this.editor.showStatus("Чертеж очищен","success"))}saveToHistory(){this.history=this.history.slice(0,this.historyIndex+1),this.history.push({elements:JSON.parse(JSON.stringify(this.elements.map(e=>({...e,mesh:null,textMesh:null})))),timestamp:Date.now()}),this.historyIndex=this.history.length-1}undo(){if(this.historyIndex<=0)return;this.historyIndex--;const e=this.history[this.historyIndex];this.restoreState(e),this.editor.showStatus("Отменено последнее действие","info")}redo(){if(this.historyIndex>=this.history.length-1)return;this.historyIndex++;const e=this.history[this.historyIndex];this.restoreState(e),this.editor.showStatus("Повторено последнее действие","info")}restoreState(e){this.elements.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose(),e.mesh.map&&e.mesh.map.dispose())}),this.elements=[],this.selectedElements=[],e&&e.elements&&e.elements.forEach(e=>{const t={...e};this.addElement(t)})}setSketchTool(e){this.setCurrentTool(e)}deleteSelected(){this.deleteSelectedElements()}clearSketch(){this.deleteAllElements()}}