class SketchHistoryHandler{constructor(e,t){this.historyManager=e,this.sketchSerializer=t,this.editor=e.editor}enhanceSketchAction(e){if(e.sketchPlaneId&&this.editor.objectsManager){const t=this.editor.findObjectByUuid(e.sketchPlaneId);t&&t.userData&&(t.userData.hasSketch||"sketch_plane"===t.userData.type)&&(e.newSketchState=this.sketchSerializer.serializeSketchState(t))}return e.elements&&Array.isArray(e.elements)&&(e.elements=e.elements.map(e=>{if(e.data)return e;const t=this.editor.findObjectByUuid(e.uuid);return t?{uuid:t.uuid,data:this.sketchSerializer.serializeSketchElement(t)}:e})),e}undoSketchAdd(e){if(console.log("Undoing sketch add action"),e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{const t=this.editor.findObjectByUuid(e.uuid);t&&(this.editor.sketchManager?.elementManager&&this.editor.sketchManager.elementManager.removeElementFromArrays(t),this.removeSketchElement(t))}),e.previousSketchState&&this.sketchSerializer.restoreSketchState(e.previousSketchState),e.sketchPlaneId&&this.editor.sketchManager){this.editor.findObjectByUuid(e.sketchPlaneId)&&(this.editor.sketchManager.elementManager.updateElementsFromPlane(),this.editor.sketchManager.elementManager.clearSelection())}return this.editor.sketchManager.onUndoRedo(),!0}redoSketchAdd(e){if(console.log("Redoing sketch add action"),e.elements&&Array.isArray(e.elements)){let t=0;return e.elements.forEach(r=>{if(r.data&&e.sketchPlaneId){const o=this.editor.findObjectByUuid(e.sketchPlaneId);if(o){this.sketchSerializer.restoreSketchElement(o,r.data)&&t++}}}),this.editor.sketchManager.onUndoRedo(),t>0}return!1}undoSketchDelete(e){console.log("Undoing sketch delete action");const t=this.editor.findObjectByUuid(e.sketchPlaneId);if(!t)return console.error("Plane not found for undo:",e.sketchPlaneId),!1;let r=0;return e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{if(e.data){this.sketchSerializer.restoreSketchElement(t,e.data)&&r++}}),this.editor.sketchManager?.elementManager&&this.editor.sketchManager.elementManager.updateElementsFromPlane(),this.editor.sketchManager&&this.editor.sketchManager.onUndoRedo(),console.log(`Restored ${r} sketch elements`),r>0}redoSketchDelete(e){if(console.log("Redoing sketch delete action"),e.elements&&Array.isArray(e.elements)){let t=0;return e.elements.forEach(e=>{const r=this.editor.findObjectByUuid(e.uuid);r&&(this.editor.sketchManager?.elementManager&&this.editor.sketchManager.elementManager.removeElementFromArrays(r),this.removeSketchElement(r),t++)}),this.editor.sketchManager.onUndoRedo(),t>0}return!1}undoSketchMove(e){return console.log("Undoing sketch move action"),e.previousSketchState?this.sketchSerializer.restoreSketchState(e.previousSketchState):(console.error("No previous sketch state for undo"),!1)}redoSketchMove(e){return console.log("Redoing sketch move action"),e.newSketchState?this.sketchSerializer.restoreSketchState(e.newSketchState):(console.error("No new sketch state for redo"),!1)}undoSketchRotate(e){return console.log("Undoing sketch rotate action"),e.previousSketchState?this.sketchSerializer.restoreSketchState(e.previousSketchState):(console.error("No previous sketch state for undo"),!1)}redoSketchRotate(e){return console.log("Redoing sketch rotate action"),e.newSketchState?this.sketchSerializer.restoreSketchState(e.newSketchState):(console.error("No new sketch state for redo"),!1)}removeSketchElement(e){e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}}