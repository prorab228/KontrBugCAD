class ProjectManager{constructor(e){this.editor=e,this.exportManager=e.exportManager,this.sketchSerializer=new SketchSerializer(this.editor),this.currentProject={name:"Новый проект",description:"",created:(new Date).toISOString(),modified:(new Date).toISOString()}}newProject(){this.editor.objects.length>0&&!confirm("Создать новый проект? Несохраненные изменения будут потеряны.")||(this.safeClearScene(),this.currentProject={name:"Новый проект",description:"",created:(new Date).toISOString(),modified:(new Date).toISOString()},document.getElementById("projectName").textContent="Новый проект",this.editor.objectsManager&&(this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList()),this.editor.updateStatus(),this.editor.showStatus("Создан новый проект","info"),localStorage.removeItem("cad_last_project"))}safeClearScene(){if([...this.editor.objects].forEach(e=>{e.parent&&e.parent.remove(e),this.safeDisposeObject(e)}),this.editor.objectsGroup)for(;this.editor.objectsGroup.children.length>0;){const e=this.editor.objectsGroup.children[0];this.editor.objectsGroup.remove(e),this.safeDisposeObject(e)}if(this.editor.sketchGroup)for(;this.editor.sketchGroup.children.length>0;){const e=this.editor.sketchGroup.children[0];this.editor.sketchGroup.remove(e),this.safeDisposeObject(e)}if(this.editor.objects=[],this.editor.workPlanes=[],this.editor.sketchPlanes=[],this.editor.selectedObjects=[],this.editor.toolManager){const e=this.editor.toolManager.getCurrentTool();e&&e.isTransformTool&&e.detach&&e.detach()}this.editor.history&&this.editor.history.clear()}safeDisposeObject(e){if(e)try{if(e.geometry&&"function"==typeof e.geometry.dispose&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}):"function"==typeof e.material.dispose&&e.material.dispose()),e.children&&e.children.length>0)for(let t=e.children.length-1;t>=0;t--)this.safeDisposeObject(e.children[t])}catch(e){console.warn("Ошибка при освобождении ресурсов объекта:",e)}}cloneObject(e){if(!e)return null;const t=this.serializeObject(e);return t?(t.uuid=THREE.MathUtils.generateUUID(),this.deserializeObject(t)):null}showSaveModal(){document.getElementById("saveModal").classList.add("active"),document.getElementById("saveHistoryCheckbox").checked=!1}saveProject(){const e=document.getElementById("projectNameInput").value||"Без названия",t=document.getElementById("projectDescription").value,r=document.getElementById("saveHistoryCheckbox").checked;this.currentProject={metadata:{version:"4.0",type:"cad-project",generator:"КонтрБагCAD",createdAt:(new Date).toISOString(),appVersion:this.editor.APP_VERSION},name:e,description:t,scene:this.serializeScene(),modified:(new Date).toISOString()},r&&this.editor.history&&(this.currentProject.history=this.editor.history.exportHistory());try{this.downloadProjectFile(this.currentProject),document.getElementById("projectName").textContent=e,document.getElementById("saveModal").classList.remove("active"),this.editor.showStatus(`Проект "${e}" сохранен в файл`,"success"),this.simpleAutoSave()}catch(e){console.error("Ошибка сохранения:",e),this.editor.showStatus("Ошибка сохранения: "+e.message,"error")}}serializeScene(){const e={objects:[],sketches:[]};return this.editor.objects.forEach(t=>{try{const r=t.userData||{};if("sketch_element"===r.type||"sketch_plane"===r.type||"work_plane"===r.type||r.elementType)return;const a=this.serializeObject(t);a&&e.objects.push(a)}catch(e){console.warn("Ошибка сериализации объекта:",e,t)}}),this.editor.sketchManager&&this.sketchSerializer&&(e.sketches=this.sketchSerializer.serializeAllSketches()),e}serializeObject(e){if(!e||!e.userData)return null;if(console.log("Serializing object:",{type:e.userData.type,elementType:e.userData.elementType,uuid:e.uuid,objectType:e.type}),"group"===e.userData.type||e.isGroup)return this.serializeGroup(e);if(("Line"===e.type||"LineLoop"===e.type||e.userData.elementType||"sketch_element"===e.userData.type)&&this.editor.sketchManager&&this.sketchSerializer)return this.sketchSerializer.serializeSketchElement(e);const t={uuid:e.uuid,type:e.type,userData:this.cleanUserData(e.userData),position:e.position.toArray(),rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:e.scale.toArray(),visible:e.visible,castShadow:e.castShadow,receiveShadow:e.receiveShadow};let r=e.userData.originalMaterial||e.material;if(e.userData.currentColor&&!e.userData.originalMaterial&&(r=new THREE.MeshPhongMaterial({color:new THREE.Color(e.userData.currentColor),transparent:void 0!==e.userData.currentOpacity?e.userData.currentOpacity<1:e.material?.transparent||!1,opacity:e.userData.currentOpacity||1})),r&&(t.material=this.serializeMaterial(r)),e.geometry&&(t.geometry=this.serializeGeometry(e.geometry),console.log("Geometry serialized:",t.geometry?.type),"Line"!==e.type&&"LineLoop"!==e.type||(t.geometry.isLine=!0)),"sketch_plane"===e.userData.type||"work_plane"===e.userData.type){t.userData.hasSketch=e.userData.hasSketch||!1,t.userData.sketchElementsCount=e.userData.sketchElementsCount||0;const r=e=>e?Array.isArray(e)?e:e.isVector3?[e.x,e.y,e.z]:[0,0,1]:[0,0,1];t.userData.normal=r(e.userData.normal),t.userData.up=r(e.userData.up),t.userData.right=r(e.userData.right)}if("image"===e.userData.type&&(t.userData.imageURL=e.userData.imageURL,t.userData.imageSize=e.userData.imageSize,t.userData.imageDepth=e.userData.imageDepth,t.userData.keepAspectRatio=e.userData.keepAspectRatio,t.userData.isTransparent=e.userData.isTransparent,t.userData.opacity=e.userData.opacity,t.userData.rotation=e.userData.rotation,t.userData.dimensions=e.userData.dimensions,e.material&&e.material.map)){const r=document.createElement("canvas");r.width=e.material.map.image.width,r.height=e.material.map.image.height;r.getContext("2d").drawImage(e.material.map.image,0,0),t.userData.textureDataURL=r.toDataURL()}return"stl"===e.userData.type&&(t.userData.filename=e.userData.filename,t.userData.originalGeometry=null),"boolean_result"===e.userData.type&&(t.userData.operation=e.userData.operation,t.userData.sourceObjects=e.userData.sourceObjects||[]),t}serializeGroup(e){const t={uuid:e.uuid,type:"Group",userData:this.cleanUserData(e.userData),position:e.position.toArray(),rotation:[e.rotation.x,e.rotation.y,e.rotation.z],scale:e.scale.toArray(),visible:e.visible,children:[]};return e.children.forEach(r=>{if(r!==e){const e=this.serializeObject(r);e&&t.children.push(e)}}),t.userData.type||(t.userData.type="group"),t}cleanUserData(e){if(!e)return{};const t={};for(const r in e){const a=e[r];"function"!=typeof a&&(a&&(a.isObject3D||a.isMaterial||a.isBufferGeometry||a.isTexture)||(a&&a.isVector3&&a.toArray&&"function"==typeof a.toArray?t[r]=a.toArray():a&&a.isEuler?t[r]=[a.x,a.y,a.z]:a&&a.isColor?t[r]=a.getHex():null!==a&&"string"!=typeof a&&"number"!=typeof a&&"boolean"!=typeof a?Array.isArray(a)?t[r]=a.map(e=>e&&e.isVector3&&e.toArray&&"function"==typeof e.toArray?e.toArray():e&&e.isEuler?[e.x,e.y,e.z]:e&&e.isColor?e.getHex():e):"object"==typeof a&&(t[r]=this.cleanUserData(a)):t[r]=a))}return!t.type&&e.type&&(t.type=e.type),t}serializeMaterial(e){if(!e)return null;try{const t={type:e.type,uuid:e.uuid||THREE.MathUtils.generateUUID(),color:8421504,opacity:void 0!==e.opacity?e.opacity:1,transparent:e.transparent||!1,side:e.side};if(e.color)try{if(e.color.isColor)t.color=e.color.getHex();else if("number"==typeof e.color)t.color=e.color;else if(Array.isArray(e.color)){const[r,a,o]=e.color,i=new THREE.Color(r,a,o);t.color=i.getHex()}}catch(e){console.warn("Не удалось сериализовать цвет материала:",e),t.color=8421504}return void 0!==e.polygonOffset&&(t.polygonOffset=e.polygonOffset),void 0!==e.polygonOffsetFactor&&(t.polygonOffsetFactor=e.polygonOffsetFactor),void 0!==e.polygonOffsetUnits&&(t.polygonOffsetUnits=e.polygonOffsetUnits),void 0!==e.depthWrite&&(t.depthWrite=e.depthWrite),"LineBasicMaterial"===e.type?(t.linewidth=e.linewidth||1,("number"!=typeof t.linewidth||isNaN(t.linewidth))&&(t.linewidth=1)):"LineDashedMaterial"===e.type&&(t.linewidth=e.linewidth||1,t.dashSize=e.dashSize||3,t.gapSize=e.gapSize||1,["linewidth","dashSize","gapSize"].forEach(e=>{("number"!=typeof t[e]||isNaN(t[e]))&&(t[e]="linewidth"===e?1:"dashSize"===e?3:1)})),t.opacity&&("number"!=typeof t.opacity||isNaN(t.opacity))&&(t.opacity=1),t}catch(t){return console.error("Error serializing material:",t),e&&"LineBasicMaterial"===e.type?{type:"LineBasicMaterial",color:1118481,linewidth:2,transparent:!1}:{type:"MeshPhongMaterial",color:8421504,opacity:1,transparent:!1}}}serializeGeometry(e){if(!e)return null;try{if(e.isBufferGeometry){const t=e.attributes.position,r=e.attributes.normal,a=e.index;if(!t)return console.warn("Geometry has no position attribute"),null;const o={type:"BufferGeometry",uuid:e.uuid||THREE.MathUtils.generateUUID(),positions:Array.from(t.array),normals:r?Array.from(r.array):[],indices:a?Array.from(a.array):[]};if(e.userData&&e.userData.isLine){const e=[];for(let r=0;r<t.array.length;r+=3)e.push([t.array[r],t.array[r+1],t.array[r+2]]);o.points=e}return e.boundingBox&&(o.boundingBox={min:e.boundingBox.min.toArray(),max:e.boundingBox.max.toArray()}),e.boundingSphere&&(o.boundingSphere={center:e.boundingSphere.center.toArray(),radius:e.boundingSphere.radius}),o}if(e.parameters)return{type:e.type,uuid:e.uuid||THREE.MathUtils.generateUUID(),parameters:this.cleanParameters(e.parameters)}}catch(e){console.error("Error serializing geometry:",e)}return null}cleanParameters(e){const t={};for(const r in e){const a=e[r];"function"!=typeof a&&(a&&a.isVector3?t[r]=a.toArray():null!==a&&"string"!=typeof a&&"number"!=typeof a&&"boolean"!=typeof a?Array.isArray(a)?t[r]=a.map(e=>e&&e.isVector3?e.toArray():e):"object"==typeof a&&(t[r]=this.cleanParameters(a)):t[r]=a)}return t}openProject(){const e=document.createElement("input");e.type="file",e.accept=".cadproj,.json,.cad,.kbcad",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const r=new FileReader;r.onload=e=>{try{const t=JSON.parse(e.target.result);this.loadProject(t)}catch(e){alert("Ошибка при загрузке проекта: "+e.message)}},r.readAsText(t)},e.click()}loadProject(e){if(!e||!e.scene)return void alert("Неверный формат проекта");this.newProject();let t=0,r=0;e.scene.objects&&Array.isArray(e.scene.objects)&&e.scene.objects.forEach(e=>{try{const r=e.userData||{};if("sketch_element"===r.type||"sketch_plane"===r.type||"work_plane"===r.type||r.elementType)return void console.log("Skipping sketch-related object:",r.type);const a=this.deserializeObject(e);a&&(this.editor.objectsGroup.add(a),this.editor.objects.push(a),t++)}catch(t){console.error("Ошибка при загрузке объекта:",t,e),r++}}),e.scene.sketches&&Array.isArray(e.scene.sketches)&&(console.log("Loading sketches from project..."),this.editor.sketchManager&&this.sketchSerializer&&this.sketchSerializer.restoreAllSketches(e.scene.sketches)),e.history&&this.editor.history&&this.editor.history.importHistory(e.history),this.currentProject=e,document.getElementById("projectName").textContent=e.name||"Проект",this.editor.objectsManager&&(this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList()),this.editor.updateStatus();const a=`Проект "${e.name||"Проект"}" загружен (${t} объектов`;r>0?this.editor.showStatus(`${a}, ошибок: ${r})`,"warning"):this.editor.showStatus(`${a})`,"success")}deserializeObject(e){if(!e||!e.userData)return console.warn("Invalid object data for deserialization:",e),null;if(console.log("Deserializing object:",{type:e.type,elementType:e.userData.elementType,uuid:e.uuid}),"group"===e.userData.type||"Group"===e.type)return this.deserializeGroup(e);if(("Line"===e.type||"LineLoop"===e.type||e.userData.elementType||"sketch_element"===e.userData.type)&&this.editor.sketchManager&&this.sketchSerializer)return this.sketchSerializer.deserializeSketchElement(e);if(e.userData&&"image"===e.userData.type)return this.deserializeImage(e);let t=null,r=null,a=null;if(e.material)r=this.deserializeMaterial(e.material),a=r.clone();else{const t=e.userData.materialColor||e.userData.color||8421504,o=e.userData.currentOpacity||e.userData.opacity||1;r=new THREE.MeshPhongMaterial({color:new THREE.Color(t),transparent:o<1,opacity:o,shininess:30,specular:new THREE.Color(1118481)}),a=r.clone()}if(e.geometry&&(t=this.deserializeGeometry(e.geometry)),t&&"BufferGeometry"!==t.type||!e.userData.geometryType||!e.userData.geometryParams||(console.log("Creating geometry from userData parameters:",e.userData.geometryType),t=this.createGeometryFromParameters({type:e.userData.geometryType,parameters:e.userData.geometryParams})),t||(t=this.createDefaultGeometry(e.userData.type)),!t||!r)return console.error("Failed to create object:",e.userData.type),null;const o=new THREE.Mesh(t,r);o.uuid=e.uuid||THREE.MathUtils.generateUUID(),e.position&&o.position.fromArray(e.position),e.scale&&o.scale.fromArray(e.scale),e.rotation&&3===e.rotation.length&&o.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]),o.userData={...e.userData};const i=e=>e?e.isVector3?e:Array.isArray(e)&&e.length>=3?new THREE.Vector3(e[0],e[1],e[2]):new THREE.Vector3(0,0,1):new THREE.Vector3(0,0,1);return o.userData.normal&&(o.userData.normal=i(o.userData.normal)),o.userData.up&&(o.userData.up=i(o.userData.up)),o.userData.right&&(o.userData.right=i(o.userData.right)),o.userData.localPoints&&Array.isArray(o.userData.localPoints)&&(o.userData.localPoints=o.userData.localPoints.map(e=>Array.isArray(e)?(new THREE.Vector3).fromArray(e):e)),a&&(o.userData.originalMaterial=a),e.userData.currentColor&&(o.userData.currentColor=e.userData.currentColor),e.userData.currentOpacity&&(o.userData.currentOpacity=e.userData.currentOpacity),void 0!==e.visible&&(o.visible=e.visible),void 0!==e.castShadow&&(o.castShadow=e.castShadow),void 0!==e.receiveShadow&&(o.receiveShadow=e.receiveShadow),console.log("Mesh deserialized with userData:",o.userData),o}deserializeImage(e){if(!e.userData)return console.warn("Invalid image data for deserialization"),null;const t=e.userData.dimensions||{width:50,height:50},r=e.userData.imageDepth||.1,a=new THREE.BoxGeometry(t.width,t.height,r);let o,i=null;if(e.userData.imageURL||e.userData.textureDataURL){const t=e.userData.imageURL||e.userData.textureDataURL;i=(new THREE.TextureLoader).load(t,e=>{e.needsUpdate=!0})}o=i?new THREE.MeshStandardMaterial({map:i,side:THREE.DoubleSide,transparent:e.userData.isTransparent||!1,opacity:e.userData.opacity||1}):new THREE.MeshStandardMaterial({color:8947848,side:THREE.DoubleSide,transparent:e.userData.isTransparent||!1,opacity:e.userData.opacity||1});const s=new THREE.Mesh(a,o);return s.uuid=e.uuid||THREE.MathUtils.generateUUID(),e.position&&s.position.fromArray(e.position),e.rotation&&3===e.rotation.length?s.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]):void 0!==e.userData.rotation&&(s.rotation.y=e.userData.rotation),e.scale&&s.scale.fromArray(e.scale),s.userData={...e.userData},s.userData.type="image",s.userData.isEditable=!0,s.userData.originalMaterial=o.clone(),void 0!==e.visible&&(s.visible=e.visible),void 0!==e.castShadow&&(s.castShadow=e.castShadow),void 0!==e.receiveShadow&&(s.receiveShadow=e.receiveShadow),s}deserializeGroup(e){const t=new THREE.Group;return t.uuid=e.uuid||THREE.MathUtils.generateUUID(),e.position&&t.position.fromArray(e.position),e.scale&&t.scale.fromArray(e.scale),e.rotation&&3===e.rotation.length&&t.rotation.set(e.rotation[0],e.rotation[1],e.rotation[2]),void 0!==e.visible&&(t.visible=e.visible),t.userData={...e.userData},t.userData.type||(t.userData.type="group"),e.children&&Array.isArray(e.children)&&e.children.forEach(e=>{const r=this.deserializeObject(e);r&&t.add(r)}),t}deserializeGeometry(e){if(!e)return console.warn("No geometry data provided"),this.createBoxGeometry();console.log("Deserializing geometry:",e.type,e.isLine?"(line)":"");try{if("BufferGeometry"===e.type){const t=new THREE.BufferGeometry;if(e.positions&&e.positions.length>0){const r=new Float32Array(e.positions);t.setAttribute("position",new THREE.BufferAttribute(r,3))}else{if(!(e.points&&e.points.length>0))return console.warn("No positions in geometry data"),this.createBoxGeometry();{const r=[];e.points.forEach(e=>{r.push(...e)}),t.setAttribute("position",new THREE.Float32BufferAttribute(r,3))}}if(!e.isLine&&e.normals&&e.normals.length>0){const r=new Float32Array(e.normals);t.setAttribute("normal",new THREE.BufferAttribute(r,3))}else e.isLine||t.computeVertexNormals();if(e.indices&&e.indices.length>0){const r=new Uint32Array(e.indices);t.setIndex(new THREE.BufferAttribute(r,1))}return e.boundingBox?t.boundingBox=new THREE.Box3((new THREE.Vector3).fromArray(e.boundingBox.min),(new THREE.Vector3).fromArray(e.boundingBox.max)):t.computeBoundingBox(),e.boundingSphere?t.boundingSphere=new THREE.Sphere((new THREE.Vector3).fromArray(e.boundingSphere.center),e.boundingSphere.radius):t.computeBoundingSphere(),t}return this.createGeometryFromParameters(e)}catch(e){return console.error("Error deserializing geometry:",e),this.createBoxGeometry()}}createGeometryFromParameters(e){if(!e.parameters)return console.warn("No parameters in geometry data"),this.createBoxGeometry();const t=e.parameters;switch(e.type){case"BoxGeometry":return new THREE.BoxGeometry(t.width||25,t.height||25,t.depth||25,t.widthSegments||1,t.heightSegments||1,t.depthSegments||1);case"SphereGeometry":return new THREE.SphereGeometry(t.radius||12.5,t.widthSegments||32,t.heightSegments||32,t.phiStart||0,t.phiLength||2*Math.PI,t.thetaStart||0,t.thetaLength||Math.PI);case"CylinderGeometry":return new THREE.CylinderGeometry(t.radiusTop||12.5,t.radiusBottom||12.5,t.height||25,t.radialSegments||32,t.heightSegments||1,t.openEnded||!1,t.thetaStart||0,t.thetaLength||2*Math.PI);case"ConeGeometry":return new THREE.ConeGeometry(t.radius||12.5,t.height||25,t.radialSegments||32,t.heightSegments||1,t.openEnded||!1,t.thetaStart||0,t.thetaLength||2*Math.PI);case"TorusGeometry":return new THREE.TorusGeometry(t.radius||25,t.tube||5,t.radialSegments||16,t.tubularSegments||100,t.arc||2*Math.PI);case"PlaneGeometry":return new THREE.PlaneGeometry(t.width||100,t.height||100,t.widthSegments||1,t.heightSegments||1);case"CircleGeometry":return new THREE.CircleGeometry(t.radius||10,t.segments||32,t.thetaStart||0,t.thetaLength||2*Math.PI);case"TorusKnotGeometry":return new THREE.TorusKnotGeometry(t.radius||10,t.tube||3,t.tubularSegments||64,t.radialSegments||8,t.p||2,t.q||3);default:return console.warn("Unknown geometry type:",e.type),this.createBoxGeometry()}}createDefaultGeometry(e){if(!e)return this.createBoxGeometry();switch(e.toLowerCase()){case"cube":case"box":return this.createBoxGeometry();case"sphere":return this.createSphereGeometry();case"cylinder":return this.createCylinderGeometry();case"cone":return this.createConeGeometry();case"torus":return this.createTorusGeometry();case"stl":case"boolean":case"boolean_result":const t=this.createBoxGeometry();return t.userData={fallback:!0,originalType:e},t;default:return console.warn("Unknown geometry type for default:",e),this.createBoxGeometry()}}createBoxGeometry(e=25,t=25,r=25){const a=new THREE.BoxGeometry(e,t,r);return a.computeBoundingBox(),a.computeBoundingSphere(),a}createSphereGeometry(e=12.5,t=32){const r=new THREE.SphereGeometry(e,t,t);return r.computeBoundingBox(),r.computeBoundingSphere(),r}createCylinderGeometry(e=12.5,t=12.5,r=25,a=32){const o=new THREE.CylinderGeometry(e,t,r,a);return o.computeBoundingBox(),o.computeBoundingSphere(),o}createConeGeometry(e=12.5,t=25,r=32){const a=new THREE.ConeGeometry(e,t,r);return a.computeBoundingBox(),a.computeBoundingSphere(),a}createTorusGeometry(e=25,t=5,r=16,a=100){const o=new THREE.TorusGeometry(e,t,r,a);return o.computeBoundingBox(),o.computeBoundingSphere(),o}deserializeMaterial(e){if(!e)return null;let t;try{switch(e.type){case"MeshBasicMaterial":t=new THREE.MeshBasicMaterial;break;case"MeshPhongMaterial":default:t=new THREE.MeshPhongMaterial;break;case"MeshStandardMaterial":t=new THREE.MeshStandardMaterial;break;case"LineBasicMaterial":t=new THREE.LineBasicMaterial;break;case"LineDashedMaterial":t=new THREE.LineDashedMaterial}const r=e=>{if("number"==typeof e)return new THREE.Color(e);if(Array.isArray(e)){if(e.length>=3)return new THREE.Color(e[0],e[1],e[2]);if(e[0]>1||e[1]>1||e[2]>1)return new THREE.Color(e[0]/255,e[1]/255,e[2]/255)}else if(e&&e.isColor)return e;return new THREE.Color(8421504)};if(void 0!==e.color)try{t.color=r(e.color)}catch(e){console.warn("Error setting material color:",e),t.color=new THREE.Color(8421504)}else t.color=new THREE.Color(8421504);if(void 0!==e.opacity){const r=parseFloat(e.opacity);t.opacity=isNaN(r)?1:Math.max(0,Math.min(1,r))}else t.opacity=1;if(void 0!==e.transparent&&(t.transparent=Boolean(e.transparent)),void 0!==e.polygonOffset&&(t.polygonOffset=Boolean(e.polygonOffset)),void 0!==e.polygonOffsetFactor&&(t.polygonOffsetFactor=parseFloat(e.polygonOffsetFactor)),void 0!==e.polygonOffsetUnits&&(t.polygonOffsetUnits=parseFloat(e.polygonOffsetUnits)),void 0!==e.depthWrite&&(t.depthWrite=Boolean(e.depthWrite)),void 0!==e.side&&("number"==typeof e.side?t.side=e.side:"front"===e.side?t.side=THREE.FrontSide:"back"===e.side?t.side=THREE.BackSide:"double"===e.side&&(t.side=THREE.DoubleSide)),t instanceof THREE.LineBasicMaterial||t instanceof THREE.LineDashedMaterial){if(void 0!==e.linewidth){const r=parseFloat(e.linewidth);t.linewidth=isNaN(r)?1:Math.max(.1,r)}if(void 0!==e.dashSize){const r=parseFloat(e.dashSize);t.dashSize=isNaN(r)?1:Math.max(.1,r)}if(void 0!==e.gapSize){const r=parseFloat(e.gapSize);t.gapSize=isNaN(r)?1:Math.max(.1,r)}}if(t instanceof THREE.MeshPhongMaterial){if(void 0!==e.shininess){const r=parseFloat(e.shininess);t.shininess=isNaN(r)?30:Math.max(0,r)}if(void 0!==e.specular)try{t.specular=r(e.specular)}catch(e){t.specular=new THREE.Color(1118481)}}if(t instanceof THREE.MeshStandardMaterial){if(void 0!==e.metalness){const r=parseFloat(e.metalness);t.metalness=isNaN(r)?.5:Math.max(0,Math.min(1,r))}if(void 0!==e.roughness){const r=parseFloat(e.roughness);t.roughness=isNaN(r)?.5:Math.max(0,Math.min(1,r))}}return t.needsUpdate=!0,t}catch(t){return console.error("Error deserializing material:",t),e&&"LineBasicMaterial"===e.type?new THREE.LineBasicMaterial({color:1118481,linewidth:2}):new THREE.MeshPhongMaterial({color:8421504,shininess:30,specular:new THREE.Color(1118481)})}}downloadProjectFile(e){const t=JSON.stringify(e,null,2),r=new Blob([t],{type:"application/json"}),a=`${e.name.replace(/[^a-z0-9а-яё\s]/gi,"_").toLowerCase()}.kbcad`;this.exportManager.downloadFile(r,a)}findObjectByUuid(e){return this.editor.objects.find(t=>t.uuid===e)||null}simpleAutoSave(){if(this.editor.autoSaveEnabled&&0!==this.editor.objects.length)try{const e={name:this.currentProject.name||"Автосохраненный проект",scene:this.serializeScene(),modified:(new Date).toISOString()},t=JSON.stringify(e),r=t.length/1048576;if(r>6)return console.warn(`Проект слишком большой для автосохранения: ${r.toFixed(2)} МБ`),void this.editor.showStatus("Проект слишком велик для автосохранения","warning");localStorage.setItem("cad_last_project",t),console.log(`Автосохранено: ${r.toFixed(2)} МБ`)}catch(e){console.warn("Не удалось автосохранить:",e),this.editor.showStatus("Не удалось автосохранить","warning"),"QuotaExceededError"===e.name&&(localStorage.removeItem("cad_last_project"),console.log("Удалено старое автосохранение:"),this.editor.showStatus("Места недостаточно, автосохранение отключено","error"),this.editor.autoSaveEnabled=!1,document.getElementById("autoSaveCheckbox")&&(document.getElementById("autoSaveCheckbox").checked=!1))}}checkAutoSave(){try{const e=localStorage.getItem("cad_last_project");return e?JSON.parse(e):null}catch(e){return console.warn("Ошибка проверки автосохранения:",e),null}}serializeObjectForHistory(e){return this.serializeObject(e)}deserializeObjectOptimized(e){return this.deserializeObject(e)}}