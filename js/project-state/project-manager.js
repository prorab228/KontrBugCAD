class ProjectManager{constructor(e){this.editor=e,this.exportManager=e.exportManager,this.legacyConverter=new LegacyProjectConverter(this.editor),this.currentProject={name:"Новый проект",description:"",created:(new Date).toISOString(),modified:(new Date).toISOString()}}newProject(){this.editor.parametricModel.operations.length>0&&!confirm("Создать новый проект? Несохраненные изменения будут потеряны.")||(this.editor.parametricModel.clear(),this.currentProject={name:"Новый проект",description:"",created:(new Date).toISOString(),modified:(new Date).toISOString()},document.getElementById("projectName").textContent="Новый проект",this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updateStatus(),this.editor.showStatus("Создан новый проект","info"),localStorage.removeItem("cad_last_project"))}showSaveModal(){document.getElementById("saveModal").classList.add("active"),document.getElementById("saveHistoryCheckbox").checked=!1}saveProject(){const e=document.getElementById("projectNameInput").value||"Без названия",t=document.getElementById("projectDescription").value;this.currentProject={metadata:{version:"5.0",type:"parametric-cad-project",generator:"КонтрБагCAD",createdAt:(new Date).toISOString(),appVersion:this.editor.APP_VERSION},name:e,description:t,operations:this.editor.parametricModel.serialize(),modified:(new Date).toISOString()};try{this.downloadProjectFile(this.currentProject),document.getElementById("projectName").textContent=e,document.getElementById("saveModal").classList.remove("active"),this.editor.showStatus(`Проект "${e}" сохранен в файл`,"success"),this.simpleAutoSave()}catch(e){console.error("Ошибка сохранения:",e),this.editor.showStatus("Ошибка сохранения: "+e.message,"error")}}openProject(){const e=document.createElement("input");e.type="file",e.accept=".cadproj,.json,.cad,.kbcad",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=e=>{try{const t=JSON.parse(e.target.result);this.loadProject(t)}catch(e){alert("Ошибка при загрузке проекта: "+e.message)}},o.readAsText(t)},e.click()}async loadProject(e){if(!e)return void alert("Неверный формат проекта");const t=e.metadata?.version||"1.0";let o=null,r=e.name||"Проект",a=e.description||"";if("5.0"===t)o=e.operations;else{alert("Вы открываете файл созданный в старой версии редактора, проект будет сконвертирован");const t=this.legacyConverter.convert(e);if(!t)return void this.editor.showStatus("Не удалось сконвертировать проект","error");o=t.operations,r=t.name,a=t.description}if(!o)return void alert("Проект не содержит операций");o.some(e=>"boolean_union"===e.type||"boolean_subtract"===e.type||"boolean_intersect"===e.type)&&this.editor.booleanOps&&(this.editor.showStatus("Ожидание загрузки модуля булевых операций...","info"),await this.editor.booleanOps.waitForReady(),await new Promise(e=>setTimeout(e,100)));const i=o.filter(e=>"import_stl"===e.type&&!e.parameters.geometryData).map(e=>e.parameters.filePath).filter((e,t,o)=>o.indexOf(e)===t);if(i.length>0){this.editor.showStatus("Загрузка STL моделей...","info");try{await Promise.all(i.map(e=>this._ensureSTLLoaded(e)))}catch(e){console.error("Ошибка загрузки STL:",e),this.editor.showStatus("Не удалось загрузить некоторые STL модели","warning")}}const n=o.filter(e=>"text3d"===e.type),s=[...new Set(n.map(e=>e.parameters.fontName))];s.length>0&&(this.editor.showStatus(`Ожидание загрузки шрифтов: ${s.join(", ")}`,"info"),await this.editor.fontManager.waitForFonts(s)),this.editor.parametricModel.deserialize(o),this.currentProject={name:r,description:a,created:e.metadata?.createdAt||(new Date).toISOString(),modified:e.modified||(new Date).toISOString()},document.getElementById("projectName").textContent=this.currentProject.name,this.editor.showStatus(`Проект загружен (${o.length} операций)`,"success")}async _ensureSTLLoaded(e){const t=this.editor.libraryManager;if(t.modelCache.has(e))return;const o=t.libraryItems.find(t=>t.modelPath===e);if(o)o.loadedGeometry||await t.preloadModel(o);else try{const o=await t.loadSTLGeometryForPreview(e);t.modelCache.set(e,{geometry:o.geometry,originalSize:o.originalSize})}catch(t){throw console.warn(`Не удалось загрузить STL по пути ${e}`,t),t}}downloadProjectFile(e){const t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),r=`${e.name.replace(/[^a-z0-9а-яё\s]/gi,"_").toLowerCase()}.kbcad`;this.exportManager.downloadFile(o,r)}simpleAutoSave(){if(this.editor.autoSaveEnabled&&0!==this.editor.parametricModel.operations.length)try{const e={metadata:{version:"5.0",type:"parametric-cad-project",generator:"КонтрБагCAD"},name:this.currentProject.name||"Автосохраненный проект",operations:this.editor.parametricModel.serialize(),modified:(new Date).toISOString()},t=JSON.stringify(e),o=t.length/1048576;if(o>6)return console.warn(`Проект слишком большой для автосохранения: ${o.toFixed(2)} МБ`),void this.editor.showStatus("Проект слишком велик для автосохранения","warning");localStorage.setItem("cad_last_project",t),console.log(`Автосохранено: ${o.toFixed(2)} МБ`)}catch(e){console.warn("Не удалось автосохранить:",e),this.editor.showStatus("Не удалось автосохранить","warning"),"QuotaExceededError"===e.name&&(localStorage.removeItem("cad_last_project"),this.editor.showStatus("Места недостаточно, автосохранение отключено","error"),this.editor.autoSaveEnabled=!1,document.getElementById("autoSaveCheckbox")&&(document.getElementById("autoSaveCheckbox").checked=!1))}}checkAutoSave(){try{const e=localStorage.getItem("cad_last_project");return e?JSON.parse(e):null}catch(e){return console.warn("Ошибка проверки автосохранения:",e),null}}}