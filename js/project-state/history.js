class HistoryManager{constructor(t,e=50){this.editor=t,this.sketchHistoryHandler=new SketchHistoryHandler(this,this.editor.projectManager.sketchSerializer),this.history=[],this.currentIndex=-1,this.maxSize=e}addAction(t){console.log("=== History addAction ===",t.type,t),this.currentIndex<this.history.length-1&&(this.history=this.history.slice(0,this.currentIndex+1));const e={...this.enhanceActionData(t),id:"act_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),timestamp:(new Date).toISOString()};return this.history.push(e),this.history.length>this.maxSize?this.history.shift():this.currentIndex=this.history.length-1,console.log("History state:",{index:this.currentIndex,total:this.history.length,lastAction:e.type}),this.updateHistoryUI(),e}enhanceActionData(t){switch(t.type){case"create":return this.enhanceCreateAction(t);case"delete":return this.enhanceDeleteAction(t);case"boolean":return this.enhanceBooleanAction(t);case"modify_position":case"modify_scale":case"modify_rotation":case"modify_size":return this.enhanceModifyAction(t);case"modify_position_multiple":return this.enhanceMultipleModifyAction(t);case"import":return this.enhanceImportAction(t);case"group":return this.enhanceGroupAction(t);case"ungroup":return this.enhanceUngroupAction(t);case"paste":return this.enhancePasteAction(t);case"create_image":return this.enhanceCreateImageAction(t);case"sketch_add":case"sketch_delete":case"sketch_move":case"sketch_rotate":return this.enhanceSketchAction(t);default:return t}}enhanceSketchAction(t){return this.editor.sketchManager&&this.sketchHistoryHandler?this.sketchHistoryHandler.enhanceSketchAction(t):t}enhancePasteAction(t){if(!t.objects||!Array.isArray(t.objects))return t;const e=t.objects.map(t=>{const e=this.editor.findObjectByUuid(t.uuid);return e&&this.editor.projectManager?{uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)}:t});return{...t,objects:e}}enhanceCreateImageAction(t){const e=this.editor.findObjectByUuid(t.object);return e&&this.editor.projectManager?{...t,data:this.editor.projectManager.serializeObjectForHistory(e)}:t}enhanceMultipleModifyAction(t){if(!t.objects||!Array.isArray(t.objects))return t;const e=t.objects.map(t=>{const e=this.editor.findObjectByUuid(t.uuid);if(!e)return t;const o={...t};return o.previousPosition||(o.previousPosition=e.position.toArray()),o});return{...t,objects:e}}enhanceCreateAction(t){const e=this.editor.findObjectByUuid(t.object);return e&&this.editor.projectManager?{...t,data:this.editor.projectManager.serializeObjectForHistory(e)}:t}enhanceDeleteAction(t){if(!t.objects||!Array.isArray(t.objects))return t;const e=t.objects.map(t=>{const e=this.editor.findObjectByUuid(t.uuid);if(e&&this.editor.projectManager){const t={uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)};return"sketch_plane"===e.userData.type&&this.editor.sketchManager&&this.editor.projectManager.sketchSerializer&&(t.sketchState=this.editor.projectManager.sketchSerializer.serializeSketchState(e)),t}return t});return{...t,objects:e}}enhanceBooleanAction(t){if(console.log("=== Enhancing boolean action ==="),t.sourceObjects&&!t.originalObjects&&(t.originalObjects=t.sourceObjects.map(t=>{const e=this.editor.findObjectByUuid(t);if(e&&this.editor.projectManager){console.log("Saving original object:",e.uuid,e.userData?.type);const t=this.editor.projectManager.serializeObjectForHistory(e);return{uuid:e.uuid,data:t}}return null}).filter(t=>null!==t)),!t.resultData&&t.result){const e=this.editor.findObjectByUuid(t.result);e&&this.editor.projectManager&&(t.resultData=this.editor.projectManager.serializeObjectForHistory(e))}return t}enhanceModifyAction(t){const e=this.editor.findObjectByUuid(t.object);if(!e)return t;if(t.data.previousPosition||"modify_position"!==t.type||(t.data.previousPosition=e.position.toArray()),t.data.previousScale||"modify_scale"!==t.type||(t.data.previousScale=e.scale.toArray()),!t.data.previousRotation&&"modify_rotation"===t.type){const o=(new THREE.Euler).setFromQuaternion(e.quaternion,"XYZ");t.data.previousRotation=[o.x,o.y,o.z]}if(!t.data.previousWorldDimensions&&"modify_size"===t.type){let o;if(this.editor.toolManager&&this.editor.toolManager.getCurrentTool()instanceof ScaleTool)o=this.editor.toolManager.getCurrentTool().getWorldDimensions(e);else{const t=(new THREE.Box3).setFromObject(e),r=new THREE.Vector3;t.getSize(r),o=r}t.data.previousWorldDimensions=o.toArray()}return t.data.previousScale||"modify_size"!==t.type||(t.data.previousScale=e.scale.toArray()),t}enhanceImportAction(t){const e=this.editor.findObjectByUuid(t.object);return e&&this.editor.projectManager?{...t,data:this.editor.projectManager.serializeObjectForHistory(e)}:t}enhanceGroupAction(t){const e=this.editor.findObjectByUuid(t.groupUuid);if(e){const o={userData:{...e.userData},position:e.position.toArray(),rotation:e.rotation.toArray(),scale:e.scale.toArray()},r=[];return e.children.forEach(t=>{t!==e&&r.push({uuid:t.uuid})}),{...t,groupData:o,originalObjects:r}}return t}enhanceUngroupAction(t){const e=this.editor.findObjectByUuid(t.groupUuid);if(e){const o=[];return e.children.forEach(t=>{if(t!==e){const e=new THREE.Vector3;t.getWorldPosition(e),o.push({uuid:t.uuid,worldPosition:e.toArray()})}}),{...t,childrenData:o}}return t}undo(){if(this.currentIndex<0)return!1;const t=this.history[this.currentIndex];console.log("=== History undo ===",t.type);try{return this.applyAction(t,!0),this.currentIndex--,this.updateHistoryUI(),!0}catch(t){return console.error("Undo failed:",t),!1}}redo(){if(this.currentIndex>=this.history.length-1)return!1;this.currentIndex++;const t=this.history[this.currentIndex];console.log("=== History redo ===",t.type);try{return this.applyAction(t,!1),this.updateHistoryUI(),!0}catch(t){return console.error("Redo failed:",t),this.currentIndex--,!1}}applyAction(t,e){switch(console.log("Applying action:",{type:t.type,isUndo:e}),t.type){case"create":case"create_image":return e?this.undoCreate(t):this.redoCreate(t);case"delete":return e?this.undoDelete(t):this.redoDelete(t);case"boolean":return e?this.undoBoolean(t):this.redoBoolean(t);case"modify_position":return this.applyModifyPosition(t,e);case"modify_scale":return this.applyModifyScale(t,e);case"modify_rotation":return this.applyModifyRotation(t,e);case"modify_size":return this.applyModifySize(t,e);case"modify_color":return this.applyModifyColor(t,e);case"modify_opacity":return this.applyModifyOpacity(t,e);case"modify_position_multiple":return this.applyModifyPositionMultiple(t,e);case"import":return e?this.undoImport(t):this.redoImport(t);case"group":return e?this.undoGroup(t):this.redoGroup(t);case"ungroup":return e?this.undoUngroup(t):this.redoUngroup(t);case"paste":return e?this.undoPaste(t):this.redoPaste(t);case"sketch_add":return e?this.undoSketchAdd(t):this.redoSketchAdd(t);case"sketch_delete":return e?this.undoSketchDelete(t):this.redoSketchDelete(t);case"sketch_move":return e?this.undoSketchMove(t):this.redoSketchMove(t);case"sketch_rotate":return e?this.undoSketchRotate(t):this.redoSketchRotate(t);default:return console.warn("Unknown action type:",t.type),!1}}undoSketchAdd(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.undoSketchAdd(t)}redoSketchAdd(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.redoSketchAdd(t)}undoSketchDelete(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.undoSketchDelete(t)}redoSketchDelete(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.redoSketchDelete(t)}undoSketchMove(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.undoSketchMove(t)}redoSketchMove(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.redoSketchMove(t)}undoSketchRotate(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.undoSketchRotate(t)}redoSketchRotate(t){return!(!this.editor.sketchManager||!this.sketchHistoryHandler)&&this.sketchHistoryHandler.redoSketchRotate(t)}undoPaste(t){if(console.log("Undoing paste action"),!t.objects||!Array.isArray(t.objects))return!1;let e=0;return t.objects.forEach(t=>{const o=this.editor.findObjectByUuid(t.uuid);o&&(this.removeObjectFromScene(o),e++)}),e>0}redoPaste(t){if(console.log("Redoing paste action"),!t.objects||!Array.isArray(t.objects))return!1;let e=0;return t.objects.forEach(t=>{if(t.data&&this.editor.projectManager){const o=this.editor.projectManager.deserializeObject(t.data);o&&(this.addObjectToScene(o,!1),e++)}}),e>0}applyModifyPositionMultiple(t,e){if(!t.objects||!Array.isArray(t.objects))return!1;let o=0;return t.objects.forEach(t=>{const r=this.editor.findObjectByUuid(t.uuid);r&&(e?r.position.fromArray(t.previousPosition||[0,0,0]):r.position.fromArray(t.position||[0,0,0]),o++)}),this.editor.updatePropertiesPanel(),o>0}undoCreate(t){const e=this.editor.findObjectByUuid(t.object);return!!e&&(this.removeObjectFromScene(e),!0)}redoCreate(t){if(!t.data||!this.editor.projectManager)return!1;const e=this.editor.projectManager.deserializeObject(t.data);return!!e&&(this.addObjectToScene(e,!0),!0)}undoDelete(t){if(!t.objects||!Array.isArray(t.objects))return!1;let e=0;return t.objects.forEach(t=>{if(!t.data||!this.editor.projectManager)return;const o=this.editor.projectManager.deserializeObject(t.data);o&&(this.addObjectToScene(o,!1),e++,t.sketchState&&this.editor.projectManager.sketchSerializer&&this.editor.projectManager.sketchSerializer.restoreSketchState(t.sketchState))}),e>0}redoDelete(t){if(!t.objects||!Array.isArray(t.objects))return!1;let e=0;return t.objects.forEach(t=>{const o=this.editor.findObjectByUuid(t.uuid);o&&(this.removeObjectFromScene(o),e++)}),e>0}undoBoolean(t){console.log("Undoing boolean operation:",t.operation);const e=this.editor.findObjectByUuid(t.result);return e&&this.removeObjectFromScene(e),t.originalObjects&&Array.isArray(t.originalObjects)&&t.originalObjects.forEach(t=>{if(!t.data||!this.editor.projectManager)return;const e=this.editor.projectManager.deserializeObject(t.data);e&&this.addObjectToScene(e,!1)}),!0}redoBoolean(t){if(console.log("Redoing boolean operation:",t.operation),t.sourceObjects&&Array.isArray(t.sourceObjects)&&t.sourceObjects.forEach(t=>{const e=this.editor.findObjectByUuid(t);e&&this.removeObjectFromScene(e)}),t.resultData&&this.editor.projectManager){const e=this.editor.projectManager.deserializeObject(t.resultData);if(e)return this.addObjectToScene(e,!0),this.editor.selectSingleObject(e),!0}return!1}applyModifyPosition(t,e){const o=this.editor.findObjectByUuid(t.object);return!!o&&(e?o.position.fromArray(t.data.previousPosition):o.position.fromArray(t.data.position),this.editor.updatePropertiesPanel(),!0)}applyModifyScale(t,e){const o=this.editor.findObjectByUuid(t.object);return!!o&&(e?o.scale.fromArray(t.data.previousScale):o.scale.fromArray(t.data.scale),this.editor.updatePropertiesPanel(),!0)}applyModifyRotation(t,e){const o=this.editor.findObjectByUuid(t.object);return!!o&&(e?o.rotation.fromArray(t.data.previousRotation):o.rotation.fromArray(t.data.rotation),this.editor.updatePropertiesPanel(),!0)}applyModifySize(t,e){const o=this.editor.findObjectByUuid(t.object);if(!o)return!1;const r=t.data;if(e){if(r.previousScale&&o.scale.fromArray(r.previousScale),r.previousDimensions&&!r.previousWorldDimensions){const t=o.userData.originalSize||this.getObjectDimensions(o),e=r.previousDimensions[0]/t.x,i=r.previousDimensions[1]/t.y,s=r.previousDimensions[2]/t.z;o.scale.set(e,i,s)}}else if(r.scale&&o.scale.fromArray(r.scale),r.dimensions&&!r.worldDimensions){const t=o.userData.originalSize||this.getObjectDimensions(o),e=r.dimensions[0]/t.x,i=r.dimensions[1]/t.y,s=r.dimensions[2]/t.z;o.scale.set(e,i,s)}return this.editor.updatePropertiesPanel(),this.editor.objectsManager.updateSceneStats(),!0}getObjectDimensions(t){if(!t)return new THREE.Vector3;const e=(new THREE.Box3).setFromObject(t),o=new THREE.Vector3;return e.getSize(o),o}applyModifyColor(t,e){const o=this.editor.findObjectByUuid(t.object);return!(!o||!o.material)&&(e?this.editor.setObjectColor(o,t.data.previousColor):this.editor.setObjectColor(o,t.data.color),this.editor.updatePropertiesPanel(),!0)}applyModifyOpacity(t,e){const o=this.editor.findObjectByUuid(t.object);return!(!o||!o.material)&&(e?this.editor.setObjectOpacity(o,t.data.previousOpacity):this.editor.setObjectOpacity(o,t.data.opacity),this.editor.updatePropertiesPanel(),!0)}undoImport(t){const e=this.editor.findObjectByUuid(t.object);return!!e&&(this.removeObjectFromScene(e),!0)}redoImport(t){if(!t.data||!this.editor.projectManager)return!1;const e=this.editor.projectManager.deserializeObject(t.data);return!!e&&(this.addObjectToScene(e,!0),this.editor.selectSingleObject(e),!0)}undoGroup(t){const e=this.editor.findObjectByUuid(t.groupUuid);if(!e)return!1;console.log("=== Undo Group ===",e.uuid,"children:",e.children.length);const o=[...e.children].filter(t=>t!==e);return o.forEach(t=>{t.updateMatrixWorld(!0);const o=new THREE.Matrix4;o.copy(t.matrixWorld),e.remove(t),this.editor.objectsGroup.add(t);const r=new THREE.Matrix4;if(e.parent){e.parent.matrixWorld;r.copy(o)}else r.copy(o);const i=new THREE.Vector3,s=new THREE.Quaternion,n=new THREE.Vector3;r.decompose(i,s,n),t.position.copy(i),t.quaternion.copy(s),t.scale.copy(n),t.updateMatrix(),t.updateMatrixWorld(!0),-1===this.editor.objects.indexOf(t)&&this.editor.objects.push(t),t.userData&&(delete t.userData.isPartOfGroup,t.userData.originalGroup&&delete t.userData.originalGroup)}),this.removeGroupFromScene(e),this.editor.clearSelection(),o.forEach(t=>{this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t)}),console.log("Extracted objects:",o.length),o.length>0}redoGroup(t){console.log("=== Redo Group ===",t.groupUuid);const e=new THREE.Group;e.uuid=t.groupUuid||THREE.MathUtils.generateUUID(),e.name=`Group_${Date.now()}`,t.groupData&&t.groupData.userData?e.userData={...t.groupData.userData}:e.userData={type:"group",id:`group_${Date.now()}`,name:"Группа",createdAt:(new Date).toISOString(),childCount:0,isGroup:!0,expanded:!0};let o=[];if(t.originalObjects&&Array.isArray(t.originalObjects)&&t.originalObjects.forEach(t=>{const e=this.editor.findObjectByUuid(t.uuid);e&&o.push(e)}),console.log("Collected objects for redo:",o.length),0===o.length)return console.error("No objects found for redo group"),!1;const r=new THREE.Vector3;return o.forEach(t=>{t.updateMatrixWorld(!0);const e=new THREE.Vector3;t.getWorldPosition(e),r.add(e)}),r.divideScalar(o.length),e.position.copy(r),o.forEach(t=>{t.parent&&t.parent.remove(t);const o=new THREE.Vector3;t.getWorldPosition(o);const i=o.clone().sub(r);e.add(t),t.position.copy(i)}),e.userData.childCount=o.length,e.userData.name=`Группа (${o.length} объектов)`,o.forEach(t=>{const e=this.editor.objects.indexOf(t);e>-1&&this.editor.objects.splice(e,1)}),this.editor.objectsGroup.add(e),this.editor.objects.push(e),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(e),this.editor.clearSelection(),this.editor.selectSingleObject(e),console.log("Redo group complete, group has children:",e.children.length),!0}undoUngroup(t){console.log("=== Undo Ungroup ===",t.groupUuid);const e=[];if(t.childrenData&&Array.isArray(t.childrenData)&&t.childrenData.forEach(t=>{const o=this.editor.findObjectByUuid(t.uuid);o&&e.push(o)}),0===e.length)return console.error("No objects found to regroup"),!1;const o=new THREE.Group;o.uuid=t.groupUuid||THREE.MathUtils.generateUUID(),o.name=`Group_${Date.now()}`;const r=new THREE.Vector3;return e.forEach(t=>{const e=new THREE.Vector3;t.getWorldPosition(e),r.add(e)}),r.divideScalar(e.length),o.position.copy(r),e.forEach(t=>{t.parent&&t.parent.remove(t);const e=new THREE.Vector3;t.getWorldPosition(e),o.add(t);const i=e.clone().sub(r);t.position.copy(i)}),o.userData={type:"group",id:`group_${Date.now()}`,name:`Группа (${e.length} объектов)`,createdAt:(new Date).toISOString(),childCount:e.length,isGroup:!0,expanded:!0},e.forEach(t=>{const e=this.editor.objects.indexOf(t);e>-1&&this.editor.objects.splice(e,1)}),this.editor.objectsGroup.add(o),this.editor.objects.push(o),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(o),this.editor.clearSelection(),this.editor.selectSingleObject(o),console.log("Undo ungroup complete, created group with",e.length,"objects"),!0}redoUngroup(t){console.log("=== Redo Ungroup ===",t.groupUuid);const e=this.editor.findObjectByUuid(t.groupUuid);if(!e)return console.error("Group not found for redo ungroup:",t.groupUuid),!1;const o=[];for(let t=e.children.length-1;t>=0;t--){const r=e.children[t];r!==e&&o.push(r)}return o.forEach(t=>{t.updateMatrixWorld(!0);const o=new THREE.Matrix4;o.copy(t.matrixWorld),e.remove(t),this.editor.objectsGroup.add(t);const r=new THREE.Matrix4;if(e.parent){e.parent.matrixWorld;r.copy(o)}else r.copy(o);const i=new THREE.Vector3,s=new THREE.Quaternion,n=new THREE.Vector3;r.decompose(i,s,n),t.position.copy(i),t.quaternion.copy(s),t.scale.copy(n),t.updateMatrix(),t.updateMatrixWorld(!0),-1===this.editor.objects.indexOf(t)&&this.editor.objects.push(t),t.userData&&(delete t.userData.isPartOfGroup,t.userData.originalGroup&&delete t.userData.originalGroup)}),this.removeGroupFromScene(e),this.editor.clearSelection(),o.forEach(t=>{this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t)}),console.log("Redo ungroup complete, extracted",o.length,"objects"),o.length>0}addGroupToScene(t){this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(t),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeGroupFromScene(t){t.parent&&t.parent.remove(t);const e=this.editor.objects.indexOf(t);if(e>-1&&this.editor.objects.splice(e,1),this.editor.groups){const e=this.editor.groups.indexOf(t);e>-1&&this.editor.groups.splice(e,1)}const o=this.editor.selectedObjects.indexOf(t);o>-1&&this.editor.selectedObjects.splice(o,1),this.editor.transformControls&&this.editor.transformControls.attachedObject===t&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}addObjectToScene(t,e=!1){this.editor.objectsGroup.add(t),this.editor.objects.push(t),"sketch_plane"===t.userData.type?this.editor.sketchPlanes.push(t):"work_plane"===t.userData.type?this.editor.workPlanes.push(t):"group"===t.userData.type&&(this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(t)),e&&this.editor.selectSingleObject(t),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeObjectFromScene(t){t.parent&&t.parent.remove(t);const e=this.editor.objects.indexOf(t);e>-1&&this.editor.objects.splice(e,1);const o=this.editor.selectedObjects.indexOf(t);if(o>-1&&this.editor.selectedObjects.splice(o,1),"sketch_plane"===t.userData.type){const e=this.editor.sketchPlanes.indexOf(t);e>-1&&this.editor.sketchPlanes.splice(e,1)}else if("work_plane"===t.userData.type){const e=this.editor.workPlanes.indexOf(t);e>-1&&this.editor.workPlanes.splice(e,1)}else if("group"===t.userData.type&&this.editor.groups){const e=this.editor.groups.indexOf(t);e>-1&&this.editor.groups.splice(e,1)}"group"===t.userData.type||t.isGroup?t.traverse(e=>{e!==t&&e.isMesh&&this.safeDisposeObject(e)}):this.safeDisposeObject(t),this.editor.transformControls&&this.editor.transformControls.attachedObject===t&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}safeDisposeObject(t){if(t)try{t.geometry&&"function"==typeof t.geometry.dispose&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(t=>{t&&"function"==typeof t.dispose&&t.dispose()}):"function"==typeof t.material.dispose&&t.material.dispose())}catch(t){console.warn("Error disposing object:",t)}}updateHistoryUI(){const t=document.getElementById("historyList");t&&(t.innerHTML="",this.history.forEach((e,o)=>{const r=this.createHistoryItem(e,o);t.appendChild(r)}),t.scrollTop=t.scrollHeight,this.updateUndoRedoButtons())}createHistoryItem(t,e){const o=document.createElement("div");o.className="history-item",o.dataset.index=e,e===this.currentIndex&&o.classList.add("active");const{icon:r,text:i,color:s}=this.getActionInfo(t),n=new Date(t.timestamp).toLocaleTimeString();return o.innerHTML=`\n            <div class="history-item-icon" style="color: ${s};">\n                <i class="${r}"></i>\n            </div>\n            <div class="history-item-content">\n                <div class="history-item-title">${i}</div>\n                <div class="history-item-time">${n}</div>\n            </div>\n        `,o.addEventListener("click",()=>{this.jumpToHistory(e)}),o}getActionInfo(t){return{create:{icon:"fas fa-plus-circle",text:"Создание объекта",color:"#4CAF50"},delete:{icon:"fas fa-trash",text:`Удалено объектов: ${t.objects?.length||1}`,color:"#F44336"},boolean:{icon:"fas fa-shapes",text:`Булева операция: ${t.operation}`,color:"#2196F3"},import:{icon:"fas fa-file-import",text:`Импорт: ${t.data?.userData?.filename||"файл"}`,color:"#FF9800"},modify_position:{icon:"fas fa-arrows-alt",text:"Перемещение",color:"#9C27B0"},modify_scale:{icon:"fas fa-expand-alt",text:"Масштабирование",color:"#3F51B5"},modify_rotation:{icon:"fas fa-sync-alt",text:"Вращение",color:"#00BCD4"},modify_size:{icon:"fas fa-ruler",text:"Изменение размеров",color:"#8BC34A"},modify_position_multiple:{icon:"fas fa-arrows-alt",text:`Перемещение (${t.objects?.length||0} объектов)`,color:"#9C27B0"},modify_color:{icon:"fas fa-palette",text:"Изменение цвета",color:"#E91E63"},modify_opacity:{icon:"fas fa-adjust",text:"Изменение прозрачности",color:"#795548"},sketch_add:{icon:"fas fa-drafting-compass",text:"Добавлен элемент скетча",color:"#FF9800"},sketch_delete:{icon:"fas fa-drafting-compass",text:`Удалено элементов скетча: ${t.elements?.length||1}`,color:"#F44336"},sketch_move:{icon:"fas fa-arrows-alt",text:"Перемещение скетча",color:"#9C27B0"},sketch_rotate:{icon:"fas fa-sync-alt",text:"Вращение скетча",color:"#00BCD4"},paste:{icon:"fas fa-paste",text:`Вставлено объектов: ${t.objects?.length||1}`,color:"#009688"},create_image:{icon:"fas fa-image",text:"Создано изображение",color:"#FF5722"}}[t.type]||{icon:"fas fa-history",text:t.type,color:"#757575"}}jumpToHistory(t){if(t!==this.currentIndex)if(console.log("Jumping to history index:",t),t<this.currentIndex)for(;this.currentIndex>t&&this.undo(););else for(;this.currentIndex<t&&this.redo(););}updateUndoRedoButtons(){const t=document.getElementById("undo"),e=document.getElementById("redo");t&&(t.disabled=this.currentIndex<0,t.title=this.currentIndex<0?"Нечего отменять":"Отменить"),e&&(e.disabled=this.currentIndex>=this.history.length-1,e.title=this.currentIndex>=this.history.length-1?"Нечего повторять":"Повторить")}clear(){this.history=[],this.currentIndex=-1,this.updateHistoryUI()}getStats(){return{totalActions:this.history.length,currentIndex:this.currentIndex,canUndo:this.currentIndex>=0,canRedo:this.currentIndex<this.history.length-1}}exportHistory(){return{history:this.history,currentIndex:this.currentIndex}}importHistory(t){return!(!t||!Array.isArray(t.history))&&(this.history=t.history,this.currentIndex=Math.min(t.currentIndex,this.history.length-1),this.updateHistoryUI(),!0)}}