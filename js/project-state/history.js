class HistoryManager{constructor(e,t=50){this.editor=e,this.history=[],this.currentIndex=-1,this.maxSize=t}addAction(e){console.log("=== History addAction ===",e.type,e),this.currentIndex<this.history.length-1&&(this.history=this.history.slice(0,this.currentIndex+1));const t={...this.enhanceActionData(e),id:"act_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),timestamp:(new Date).toISOString()};return this.history.push(t),this.history.length>this.maxSize?this.history.shift():this.currentIndex=this.history.length-1,console.log("History state:",{index:this.currentIndex,total:this.history.length,lastAction:t.type}),this.updateHistoryUI(),t}enhanceActionData(e){switch(e.type){case"create":return this.enhanceCreateAction(e);case"delete":return this.enhanceDeleteAction(e);case"boolean":return this.enhanceBooleanAction(e);case"modify_position":case"modify_scale":case"modify_rotation":case"modify_size":return this.enhanceModifyAction(e);case"modify_position_multiple":return this.enhanceMultipleModifyAction(e);case"import":return this.enhanceImportAction(e);case"group":return this.enhanceGroupAction(e);case"ungroup":return this.enhanceUngroupAction(e);case"sketch_add":case"sketch_delete":return this.enhanceSketchAction(e);case"paste":return this.enhancePasteAction(e);case"create_image":return this.enhanceCreateImageAction(e);default:return e}}enhancePasteAction(e){if(!e.objects||!Array.isArray(e.objects))return e;const t=e.objects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);return t&&this.editor.projectManager?{uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}:e});return{...e,objects:t}}enhanceCreateImageAction(e){const t=this.editor.findObjectByUuid(e.object);return t&&this.editor.projectManager?{...e,data:this.editor.projectManager.serializeObjectForHistory(t)}:e}enhanceSketchAction(e){if(e.sketchPlaneId&&this.editor.objectsManager){const t=this.editor.findObjectByUuid(e.sketchPlaneId);t&&t.userData&&(t.userData.hasSketch||"sketch_plane"===t.userData.type)&&(e.sketchData=this.serializeSketchState(t))}return e.elements&&Array.isArray(e.elements)&&this.editor.projectManager&&(e.elements=e.elements.map(e=>{if(e.data)return e;const t=this.editor.findObjectByUuid(e.uuid);return t?{uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}:e})),e}serializeSketchState(e){const t={planeId:e.uuid,planeData:this.editor.projectManager.serializeObject(e),elements:[]};return e.children.forEach(e=>{if(e.userData&&"sketch_element"===e.userData.type){const o=this.editor.projectManager.serializeObjectForHistory(e);o&&t.elements.push({uuid:e.uuid,data:o})}}),t}enhanceMultipleModifyAction(e){if(!e.objects||!Array.isArray(e.objects))return e;const t=e.objects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);if(!t)return e;const o={...e};return o.previousPosition||(o.previousPosition=t.position.toArray()),o});return{...e,objects:t}}enhanceCreateAction(e){const t=this.editor.findObjectByUuid(e.object);return t&&this.editor.projectManager?{...e,data:this.editor.projectManager.serializeObjectForHistory(t)}:e}enhanceDeleteAction(e){if(!e.objects||!Array.isArray(e.objects))return e;const t=e.objects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);if(t&&this.editor.projectManager){const e={uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)};return"sketch_plane"===t.userData.type&&(e.sketchState=this.serializeSketchState(t)),e}return e});return{...e,objects:t}}enhanceBooleanAction(e){if(console.log("=== Enhancing boolean action ==="),e.sourceObjects&&!e.originalObjects&&(e.originalObjects=e.sourceObjects.map(e=>{const t=this.editor.findObjectByUuid(e);if(t&&this.editor.projectManager){console.log("Saving original object:",t.uuid,t.userData?.type);const e=this.editor.projectManager.serializeObjectForHistory(t);return{uuid:t.uuid,data:e}}return null}).filter(e=>null!==e)),!e.resultData&&e.result){const t=this.editor.findObjectByUuid(e.result);t&&this.editor.projectManager&&(e.resultData=this.editor.projectManager.serializeObjectForHistory(t))}return e}enhanceModifyAction(e){const t=this.editor.findObjectByUuid(e.object);if(!t)return e;if(e.data.previousPosition||"modify_position"!==e.type||(e.data.previousPosition=t.position.toArray()),e.data.previousScale||"modify_scale"!==e.type||(e.data.previousScale=t.scale.toArray()),!e.data.previousRotation&&"modify_rotation"===e.type){const o=(new THREE.Euler).setFromQuaternion(t.quaternion,"XYZ");e.data.previousRotation=[o.x,o.y,o.z]}if(!e.data.previousDimensions&&"modify_size"===e.type){const o=this.editor.objectsManager.getObjectDimensions(t);e.data.previousDimensions={x:o.x,y:o.y,z:o.z}}return e}enhanceImportAction(e){const t=this.editor.findObjectByUuid(e.object);return t&&this.editor.projectManager?{...e,data:this.editor.projectManager.serializeObjectForHistory(t)}:e}enhanceGroupAction(e){const t=this.editor.findObjectByUuid(e.groupUuid);if(t){const o={userData:{...t.userData},position:t.position.toArray(),rotation:t.rotation.toArray(),scale:t.scale.toArray()},r=[];return t.children.forEach(e=>{e!==t&&r.push({uuid:e.uuid})}),{...e,groupData:o,originalObjects:r}}return e}enhanceUngroupAction(e){const t=this.editor.findObjectByUuid(e.groupUuid);if(t){const o=[];return t.children.forEach(e=>{if(e!==t){const t=new THREE.Vector3;e.getWorldPosition(t),o.push({uuid:e.uuid,worldPosition:t.toArray()})}}),{...e,childrenData:o}}return e}undo(){if(this.currentIndex<0)return!1;const e=this.history[this.currentIndex];console.log("=== History undo ===",e.type);try{return this.applyAction(e,!0),this.currentIndex--,this.updateHistoryUI(),!0}catch(e){return console.error("Undo failed:",e),!1}}redo(){if(this.currentIndex>=this.history.length-1)return!1;this.currentIndex++;const e=this.history[this.currentIndex];console.log("=== History redo ===",e.type);try{return this.applyAction(e,!1),this.updateHistoryUI(),!0}catch(e){return console.error("Redo failed:",e),this.currentIndex--,!1}}applyAction(e,t){switch(console.log("Applying action:",{type:e.type,isUndo:t}),e.type){case"create":case"create_image":return t?this.undoCreate(e):this.redoCreate(e);case"delete":return t?this.undoDelete(e):this.redoDelete(e);case"boolean":return t?this.undoBoolean(e):this.redoBoolean(e);case"modify_position":return this.applyModifyPosition(e,t);case"modify_scale":return this.applyModifyScale(e,t);case"modify_rotation":return this.applyModifyRotation(e,t);case"modify_size":return this.applyModifySize(e,t);case"modify_color":return this.applyModifyColor(e,t);case"modify_opacity":return this.applyModifyOpacity(e,t);case"modify_position_multiple":return this.applyModifyPositionMultiple(e,t);case"import":return t?this.undoImport(e):this.redoImport(e);case"group":return t?this.undoGroup(e):this.redoGroup(e);case"ungroup":return t?this.undoUngroup(e):this.redoUngroup(e);case"sketch_add":return t?this.undoSketchAdd(e):this.redoSketchAdd(e);case"sketch_delete":return t?this.undoSketchDelete(e):this.redoSketchDelete(e);case"paste":return t?this.undoPaste(e):this.redoPaste(e);default:return console.warn("Unknown action type:",e.type),!1}}undoPaste(e){if(console.log("Undoing paste action"),!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{const o=this.editor.findObjectByUuid(e.uuid);o&&(this.removeObjectFromScene(o),t++)}),t>0}redoPaste(e){if(console.log("Redoing paste action"),!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{if(e.data&&this.editor.projectManager){const o=this.editor.projectManager.deserializeObject(e.data);o&&(this.addObjectToScene(o,!1),t++)}}),t>0}undoSketchAdd(e){if(console.log("Undoing sketch add action"),e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{const t=this.editor.findObjectByUuid(e.uuid);t&&(this.editor.sketchManager&&this.editor.sketchManager.elementManager&&this.editor.sketchManager.elementManager.removeElementFromArrays(t),this.removeSketchElement(t))}),e.previousSketchState&&this.restoreSketchState(e.previousSketchState),e.sketchPlaneId&&this.editor.sketchManager){this.editor.findObjectByUuid(e.sketchPlaneId)&&(this.editor.sketchManager.elementManager.updateElementsFromPlane(),this.editor.sketchManager.elementManager.clearSelection())}return this.editor.sketchManager.onUndoRedo(),!0}redoSketchAdd(e){if(console.log("Redoing sketch add action"),e.elements&&Array.isArray(e.elements)){let t=0;return e.elements.forEach(o=>{if(o.data&&this.editor.projectManager){const r=this.editor.projectManager.deserializeObjectOptimized(o.data);if(r&&e.sketchPlaneId){const o=this.editor.findObjectByUuid(e.sketchPlaneId);if(o){if(o.add(r),this.editor.sketchManager&&this.editor.sketchManager.elementManager){const e={type:r.userData.elementType,mesh:r,originalColor:r.userData.originalColor,color:r.userData.originalColor,localPoints:r.userData.localPoints,localPosition:r.userData.localPosition,isClosed:r.userData.isClosed,sketchPlaneId:r.userData.sketchPlaneId,userData:r.userData};this.editor.sketchManager.elementManager.elements.push(e)}t++}}}}),this.editor.sketchManager.onUndoRedo(),t>0}return!1}undoSketchDelete(e){console.log("Undoing sketch delete action");const t=this.editor.findObjectByUuid(e.sketchPlaneId);if(!t)return console.error("Plane not found for undo:",e.sketchPlaneId),!1;let o=0;return e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{if(e.data&&this.editor.projectManager){this.editor.projectManager.restoreSketchElement(t,e.data)&&o++}}),this.editor.sketchManager?.elementManager&&this.editor.sketchManager.elementManager.updateElementsFromPlane(),this.editor.sketchManager&&this.editor.sketchManager.onUndoRedo(),console.log(`Restored ${o} sketch elements`),o>0}redoSketchDelete(e){if(console.log("Redoing sketch delete action"),e.elements&&Array.isArray(e.elements)){let t=0;return e.elements.forEach(e=>{const o=this.editor.findObjectByUuid(e.uuid);o&&(this.editor.sketchManager&&this.editor.sketchManager.elementManager&&this.editor.sketchManager.elementManager.removeElementFromArrays(o),this.removeSketchElement(o),t++)}),this.editor.sketchManager.onUndoRedo(),t>0}return!1}removeSketchElement(e){e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}restoreSketchState(e){if(!e||!e.planeId)return!1;const t=this.editor.findObjectByUuid(e.planeId);if(!t)return!1;for(let e=t.children.length-1;e>=0;e--){const o=t.children[e];o.userData&&"sketch_element"===o.userData.type&&(t.remove(o),o.geometry&&o.geometry.dispose(),o.material&&o.material.dispose())}return e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{if(e.data&&this.editor.projectManager){const o=this.editor.projectManager.deserializeObjectOptimized(e.data);o&&t.add(o)}}),!0}applyModifyPositionMultiple(e,t){if(!e.objects||!Array.isArray(e.objects))return!1;let o=0;return e.objects.forEach(e=>{const r=this.editor.findObjectByUuid(e.uuid);r&&(t?r.position.fromArray(e.previousPosition||[0,0,0]):r.position.fromArray(e.position||[0,0,0]),o++)}),this.editor.updatePropertiesPanel(),o>0}undoCreate(e){const t=this.editor.findObjectByUuid(e.object);return!!t&&(this.removeObjectFromScene(t),!0)}redoCreate(e){if(!e.data||!this.editor.projectManager)return!1;const t=this.editor.projectManager.deserializeObject(e.data);return!!t&&(this.addObjectToScene(t,!0),!0)}undoDelete(e){if(!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{if(!e.data||!this.editor.projectManager)return;const o=this.editor.projectManager.deserializeObject(e.data);o&&(this.addObjectToScene(o,!1),t++,e.sketchState&&this.restoreSketchState(e.sketchState))}),t>0}redoDelete(e){if(!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{const o=this.editor.findObjectByUuid(e.uuid);o&&(this.removeObjectFromScene(o),t++)}),t>0}undoBoolean(e){console.log("Undoing boolean operation:",e.operation);const t=this.editor.findObjectByUuid(e.result);return t&&this.removeObjectFromScene(t),e.originalObjects&&Array.isArray(e.originalObjects)&&e.originalObjects.forEach(e=>{if(!e.data||!this.editor.projectManager)return;const t=this.editor.projectManager.deserializeObject(e.data);t&&this.addObjectToScene(t,!1)}),!0}redoBoolean(e){if(console.log("Redoing boolean operation:",e.operation),e.sourceObjects&&Array.isArray(e.sourceObjects)&&e.sourceObjects.forEach(e=>{const t=this.editor.findObjectByUuid(e);t&&this.removeObjectFromScene(t)}),e.resultData&&this.editor.projectManager){const t=this.editor.projectManager.deserializeObject(e.resultData);if(t)return this.addObjectToScene(t,!0),this.editor.selectSingleObject(t),!0}return!1}applyModifyPosition(e,t){const o=this.editor.findObjectByUuid(e.object);return!!o&&(t?o.position.fromArray(e.data.previousPosition):o.position.fromArray(e.data.position),this.editor.updatePropertiesPanel(),!0)}applyModifyScale(e,t){const o=this.editor.findObjectByUuid(e.object);return!!o&&(t?o.scale.fromArray(e.data.previousScale):o.scale.fromArray(e.data.scale),this.editor.updatePropertiesPanel(),!0)}applyModifyRotation(e,t){const o=this.editor.findObjectByUuid(e.object);return!!o&&(t?o.rotation.fromArray(e.data.previousRotation):o.rotation.fromArray(e.data.rotation),this.editor.updatePropertiesPanel(),!0)}applyModifySize(e,t){const o=this.editor.findObjectByUuid(e.object);return!!o&&(this.editor.transformControls&&(t?this.editor.transformControls.updateObjectSizeDirect(o,e.data.previousDimensions):this.editor.transformControls.updateObjectSizeDirect(o,e.data.dimensions)),this.editor.updatePropertiesPanel(),this.editor.objectsManager.updateSceneStats(),!0)}applyModifyColor(e,t){const o=this.editor.findObjectByUuid(e.object);return!(!o||!o.material)&&(t?this.editor.setObjectColor(o,e.data.previousColor):this.editor.setObjectColor(o,e.data.color),this.editor.updatePropertiesPanel(),!0)}applyModifyOpacity(e,t){const o=this.editor.findObjectByUuid(e.object);return!(!o||!o.material)&&(t?this.editor.setObjectOpacity(o,e.data.previousOpacity):this.editor.setObjectOpacity(o,e.data.opacity),this.editor.updatePropertiesPanel(),!0)}undoImport(e){const t=this.editor.findObjectByUuid(e.object);return!!t&&(this.removeObjectFromScene(t),!0)}redoImport(e){if(!e.data||!this.editor.projectManager)return!1;const t=this.editor.projectManager.deserializeObject(e.data);return!!t&&(this.addObjectToScene(t,!0),this.editor.selectSingleObject(t),!0)}undoGroup(e){const t=this.editor.findObjectByUuid(e.groupUuid);if(!t)return!1;console.log("=== Undo Group ===",t.uuid,"children:",t.children.length);const o=[...t.children].filter(e=>e!==t);return o.forEach(e=>{e.updateMatrixWorld(!0);const o=new THREE.Matrix4;o.copy(e.matrixWorld),t.remove(e),this.editor.objectsGroup.add(e);const r=new THREE.Matrix4;if(t.parent){t.parent.matrixWorld;r.copy(o)}else r.copy(o);const i=new THREE.Vector3,s=new THREE.Quaternion,n=new THREE.Vector3;r.decompose(i,s,n),e.position.copy(i),e.quaternion.copy(s),e.scale.copy(n),e.updateMatrix(),e.updateMatrixWorld(!0),-1===this.editor.objects.indexOf(e)&&this.editor.objects.push(e),e.userData&&(delete e.userData.isPartOfGroup,e.userData.originalGroup&&delete e.userData.originalGroup)}),this.removeGroupFromScene(t),this.editor.clearSelection(),o.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),console.log("Extracted objects:",childrenToExtract.length),childrenToExtract.length>0}redoGroup(e){console.log("=== Redo Group ===",e.groupUuid);const t=new THREE.Group;t.uuid=e.groupUuid||THREE.MathUtils.generateUUID(),t.name=`Group_${Date.now()}`,e.groupData&&e.groupData.userData?t.userData={...e.groupData.userData}:t.userData={type:"group",id:`group_${Date.now()}`,name:"Группа",createdAt:(new Date).toISOString(),childCount:0,isGroup:!0,expanded:!0};let o=[];if(e.originalObjects&&Array.isArray(e.originalObjects)&&e.originalObjects.forEach(e=>{const t=this.editor.findObjectByUuid(e.uuid);t&&o.push(t)}),console.log("Collected objects for redo:",o.length),0===o.length)return console.error("No objects found for redo group"),!1;const r=new THREE.Vector3;return o.forEach(e=>{e.updateMatrixWorld(!0);const t=new THREE.Vector3;e.getWorldPosition(t),r.add(t)}),r.divideScalar(o.length),t.position.copy(r),o.forEach(e=>{e.parent&&e.parent.remove(e);const o=new THREE.Vector3;e.getWorldPosition(o);const i=o.clone().sub(r);t.add(e),e.position.copy(i)}),t.userData.childCount=o.length,t.userData.name=`Группа (${o.length} объектов)`,o.forEach(e=>{const t=this.editor.objects.indexOf(e);t>-1&&this.editor.objects.splice(t,1)}),this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(t),this.editor.clearSelection(),this.editor.selectSingleObject(t),console.log("Redo group complete, group has children:",t.children.length),!0}undoUngroup(e){console.log("=== Undo Ungroup ===",e.groupUuid);const t=[];if(e.childrenData&&Array.isArray(e.childrenData)&&e.childrenData.forEach(e=>{const o=this.editor.findObjectByUuid(e.uuid);o&&t.push(o)}),0===t.length)return console.error("No objects found to regroup"),!1;const o=new THREE.Group;o.uuid=e.groupUuid||THREE.MathUtils.generateUUID(),o.name=`Group_${Date.now()}`;const r=new THREE.Vector3;return t.forEach(e=>{const t=new THREE.Vector3;e.getWorldPosition(t),r.add(t)}),r.divideScalar(t.length),o.position.copy(r),t.forEach(e=>{e.parent&&e.parent.remove(e);const t=new THREE.Vector3;e.getWorldPosition(t),o.add(e);const i=t.clone().sub(r);e.position.copy(i)}),o.userData={type:"group",id:`group_${Date.now()}`,name:`Группа (${t.length} объектов)`,createdAt:(new Date).toISOString(),childCount:t.length,isGroup:!0,expanded:!0},t.forEach(e=>{const t=this.editor.objects.indexOf(e);t>-1&&this.editor.objects.splice(t,1)}),this.editor.objectsGroup.add(o),this.editor.objects.push(o),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(o),this.editor.clearSelection(),this.editor.selectSingleObject(o),console.log("Undo ungroup complete, created group with",t.length,"objects"),!0}redoUngroup(e){console.log("=== Redo Ungroup ===",e.groupUuid);const t=this.editor.findObjectByUuid(e.groupUuid);if(!t)return console.error("Group not found for redo ungroup:",e.groupUuid),!1;const o=[];for(let e=t.children.length-1;e>=0;e--){const r=t.children[e];r!==t&&o.push(r)}return o.forEach(e=>{e.updateMatrixWorld(!0);const o=new THREE.Matrix4;o.copy(e.matrixWorld),t.remove(e),this.editor.objectsGroup.add(e);const r=new THREE.Matrix4;if(t.parent){t.parent.matrixWorld;r.copy(o)}else r.copy(o);const i=new THREE.Vector3,s=new THREE.Quaternion,n=new THREE.Vector3;r.decompose(i,s,n),e.position.copy(i),e.quaternion.copy(s),e.scale.copy(n),e.updateMatrix(),e.updateMatrixWorld(!0),-1===this.editor.objects.indexOf(e)&&this.editor.objects.push(e),e.userData&&(delete e.userData.isPartOfGroup,e.userData.originalGroup&&delete e.userData.originalGroup)}),this.removeGroupFromScene(t),this.editor.clearSelection(),o.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),console.log("Redo ungroup complete, extracted",o.length,"objects"),o.length>0}addGroupToScene(e){this.editor.objectsGroup.add(e),this.editor.objects.push(e),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(e),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeGroupFromScene(e){e.parent&&e.parent.remove(e);const t=this.editor.objects.indexOf(e);if(t>-1&&this.editor.objects.splice(t,1),this.editor.groups){const t=this.editor.groups.indexOf(e);t>-1&&this.editor.groups.splice(t,1)}const o=this.editor.selectedObjects.indexOf(e);o>-1&&this.editor.selectedObjects.splice(o,1),this.editor.transformControls&&this.editor.transformControls.attachedObject===e&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}addObjectToScene(e,t=!1){this.editor.objectsGroup.add(e),this.editor.objects.push(e),"sketch_plane"===e.userData.type?this.editor.sketchPlanes.push(e):"work_plane"===e.userData.type?this.editor.workPlanes.push(e):"group"===e.userData.type&&(this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(e)),t&&this.editor.selectSingleObject(e),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeObjectFromScene(e){e.parent&&e.parent.remove(e);const t=this.editor.objects.indexOf(e);t>-1&&this.editor.objects.splice(t,1);const o=this.editor.selectedObjects.indexOf(e);if(o>-1&&this.editor.selectedObjects.splice(o,1),"sketch_plane"===e.userData.type){const t=this.editor.sketchPlanes.indexOf(e);t>-1&&this.editor.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.editor.workPlanes.indexOf(e);t>-1&&this.editor.workPlanes.splice(t,1)}else if("group"===e.userData.type&&this.editor.groups){const t=this.editor.groups.indexOf(e);t>-1&&this.editor.groups.splice(t,1)}"group"===e.userData.type||e.isGroup?e.traverse(t=>{t!==e&&t.isMesh&&this.safeDisposeObject(t)}):this.safeDisposeObject(e),this.editor.transformControls&&this.editor.transformControls.attachedObject===e&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}safeDisposeObject(e){if(e)try{e.geometry&&"function"==typeof e.geometry.dispose&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}):"function"==typeof e.material.dispose&&e.material.dispose())}catch(e){console.warn("Error disposing object:",e)}}updateHistoryUI(){const e=document.getElementById("historyList");e&&(e.innerHTML="",this.history.forEach((t,o)=>{const r=this.createHistoryItem(t,o);e.appendChild(r)}),e.scrollTop=e.scrollHeight,this.updateUndoRedoButtons())}createHistoryItem(e,t){const o=document.createElement("div");o.className="history-item",o.dataset.index=t,t===this.currentIndex&&o.classList.add("active");const{icon:r,text:i,color:s}=this.getActionInfo(e),n=new Date(e.timestamp).toLocaleTimeString();return o.innerHTML=`\n            <div class="history-item-icon" style="color: ${s};">\n                <i class="${r}"></i>\n            </div>\n            <div class="history-item-content">\n                <div class="history-item-title">${i}</div>\n                <div class="history-item-time">${n}</div>\n            </div>\n        `,o.addEventListener("click",()=>{this.jumpToHistory(t)}),o}getActionInfo(e){return{create:{icon:"fas fa-plus-circle",text:"Создание объекта",color:"#4CAF50"},delete:{icon:"fas fa-trash",text:`Удалено объектов: ${e.objects?.length||1}`,color:"#F44336"},boolean:{icon:"fas fa-shapes",text:`Булева операция: ${e.operation}`,color:"#2196F3"},import:{icon:"fas fa-file-import",text:`Импорт: ${e.data?.userData?.filename||"файл"}`,color:"#FF9800"},modify_position:{icon:"fas fa-arrows-alt",text:"Перемещение",color:"#9C27B0"},modify_scale:{icon:"fas fa-expand-alt",text:"Масштабирование",color:"#3F51B5"},modify_rotation:{icon:"fas fa-sync-alt",text:"Вращение",color:"#00BCD4"},modify_size:{icon:"fas fa-ruler",text:"Изменение размеров",color:"#8BC34A"},modify_position_multiple:{icon:"fas fa-arrows-alt",text:`Перемещение (${e.objects?.length||0} объектов)`,color:"#9C27B0"},modify_color:{icon:"fas fa-palette",text:"Изменение цвета",color:"#E91E63"},modify_opacity:{icon:"fas fa-adjust",text:"Изменение прозрачности",color:"#795548"},sketch_add:{icon:"fas fa-drafting-compass",text:"Добавлен элемент скетча",color:"#FF9800"},sketch_delete:{icon:"fas fa-drafting-compass",text:`Удалено элементов скетча: ${e.elements?.length||1}`,color:"#F44336"}}[e.type]||{icon:"fas fa-history",text:e.type,color:"#757575"}}jumpToHistory(e){if(e!==this.currentIndex)if(console.log("Jumping to history index:",e),e<this.currentIndex)for(;this.currentIndex>e&&this.undo(););else for(;this.currentIndex<e&&this.redo(););}updateUndoRedoButtons(){const e=document.getElementById("undo"),t=document.getElementById("redo");e&&(e.disabled=this.currentIndex<0,e.title=this.currentIndex<0?"Нечего отменять":"Отменить"),t&&(t.disabled=this.currentIndex>=this.history.length-1,t.title=this.currentIndex>=this.history.length-1?"Нечего повторять":"Повторить")}clear(){this.history=[],this.currentIndex=-1,this.updateHistoryUI()}getStats(){return{totalActions:this.history.length,currentIndex:this.currentIndex,canUndo:this.currentIndex>=0,canRedo:this.currentIndex<this.history.length-1}}exportHistory(){return{history:this.history,currentIndex:this.currentIndex}}importHistory(e){return!(!e||!Array.isArray(e.history))&&(this.history=e.history,this.currentIndex=Math.min(e.currentIndex,this.history.length-1),this.updateHistoryUI(),!0)}}