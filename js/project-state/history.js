class HistoryManager{constructor(e,t=50){this.editor=e,this.history=[],this.currentIndex=-1,this.maxSize=t}addAction(e){console.log("=== History addAction ===",e.type,e),this.currentIndex<this.history.length-1&&(this.history=this.history.slice(0,this.currentIndex+1));const t={...this.enhanceActionData(e),id:"act_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),timestamp:(new Date).toISOString()};return this.history.push(t),this.history.length>this.maxSize?this.history.shift():this.currentIndex=this.history.length-1,console.log("History state:",{index:this.currentIndex,total:this.history.length,lastAction:t.type}),this.updateHistoryUI(),t}enhanceActionData(e){switch(e.type){case"create":return this.enhanceCreateAction(e);case"delete":return this.enhanceDeleteAction(e);case"boolean":return this.enhanceBooleanAction(e);case"modify_position":case"modify_scale":case"modify_rotation":case"modify_size":return this.enhanceModifyAction(e);case"modify_position_multiple":return this.enhanceMultipleModifyAction(e);case"import":return this.enhanceImportAction(e);case"group":return this.enhanceGroupAction(e);case"ungroup":return this.enhanceUngroupAction(e);case"sketch_add":case"sketch_delete":return this.enhanceSketchAction(e);case"paste":return this.enhancePasteAction(e);default:return e}}enhancePasteAction(e){if(!e.objects||!Array.isArray(e.objects))return e;const t=e.objects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);return t&&this.editor.projectManager?{uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}:e});return{...e,objects:t}}enhanceSketchAction(e){if(e.sketchPlaneId&&this.editor.objectsManager){const t=this.editor.findObjectByUuid(e.sketchPlaneId);t&&t.userData&&(t.userData.hasSketch||"sketch_plane"===t.userData.type)&&(e.sketchData=this.serializeSketchState(t))}return e.elements&&Array.isArray(e.elements)&&this.editor.projectManager&&(e.elements=e.elements.map(e=>{if(e.data)return e;const t=this.editor.findObjectByUuid(e.uuid);return t?{uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}:e})),e}serializeSketchState(e){const t={planeId:e.uuid,planeData:this.editor.projectManager.serializeObject(e),elements:[]};return e.children.forEach(e=>{if(e.userData&&"sketch_element"===e.userData.type){const r=this.editor.projectManager.serializeObjectForHistory(e);r&&t.elements.push({uuid:e.uuid,data:r})}}),t}enhanceMultipleModifyAction(e){if(!e.objects||!Array.isArray(e.objects))return e;const t=e.objects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);if(!t)return e;const r={...e};return r.previousPosition||(r.previousPosition=t.position.toArray()),r});return{...e,objects:t}}enhanceCreateAction(e){const t=this.editor.findObjectByUuid(e.object);return t&&this.editor.projectManager?{...e,data:this.editor.projectManager.serializeObjectForHistory(t)}:e}enhanceDeleteAction(e){if(!e.objects||!Array.isArray(e.objects))return e;const t=e.objects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);if(t&&this.editor.projectManager){const e={uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)};return"sketch_plane"===t.userData.type&&(e.sketchState=this.serializeSketchState(t)),e}return e});return{...e,objects:t}}enhanceBooleanAction(e){if(console.log("=== Enhancing boolean action ==="),e.sourceObjects&&!e.originalObjects&&(e.originalObjects=e.sourceObjects.map(e=>{const t=this.editor.findObjectByUuid(e);if(t&&this.editor.projectManager){console.log("Saving original object:",t.uuid,t.userData?.type);const e=this.editor.projectManager.serializeObjectForHistory(t);return{uuid:t.uuid,data:e}}return null}).filter(e=>null!==e)),!e.resultData&&e.result){const t=this.editor.findObjectByUuid(e.result);t&&this.editor.projectManager&&(e.resultData=this.editor.projectManager.serializeObjectForHistory(t))}return e}enhanceModifyAction(e){const t=this.editor.findObjectByUuid(e.object);if(!t)return e;if(e.data.previousPosition||"modify_position"!==e.type||(e.data.previousPosition=t.position.toArray()),e.data.previousScale||"modify_scale"!==e.type||(e.data.previousScale=t.scale.toArray()),!e.data.previousRotation&&"modify_rotation"===e.type){const r=(new THREE.Euler).setFromQuaternion(t.quaternion,"XYZ");e.data.previousRotation=[r.x,r.y,r.z]}if(!e.data.previousDimensions&&"modify_size"===e.type){const r=this.editor.objectsManager.getObjectDimensions(t);e.data.previousDimensions={x:r.x,y:r.y,z:r.z}}return e}enhanceImportAction(e){const t=this.editor.findObjectByUuid(e.object);return t&&this.editor.projectManager?{...e,data:this.editor.projectManager.serializeObjectForHistory(t)}:e}enhanceGroupAction(e){const t=this.editor.findObjectByUuid(e.groupUuid);return t&&this.editor.projectManager?{...e,groupData:this.editor.projectManager.serializeObjectForHistory(t)}:e}enhanceUngroupAction(e){if(e.ungroupedObjects&&Array.isArray(e.ungroupedObjects)){const t=e.ungroupedObjects.map(e=>{const t=this.editor.findObjectByUuid(e.uuid);return t&&this.editor.projectManager?{...e,data:this.editor.projectManager.serializeObjectForHistory(t)}:e});return{...e,ungroupedObjects:t}}return e}undo(){if(this.currentIndex<0)return!1;const e=this.history[this.currentIndex];console.log("=== History undo ===",e.type);try{return this.applyAction(e,!0),this.currentIndex--,this.updateHistoryUI(),!0}catch(e){return console.error("Undo failed:",e),!1}}redo(){if(this.currentIndex>=this.history.length-1)return!1;this.currentIndex++;const e=this.history[this.currentIndex];console.log("=== History redo ===",e.type);try{return this.applyAction(e,!1),this.updateHistoryUI(),!0}catch(e){return console.error("Redo failed:",e),this.currentIndex--,!1}}applyAction(e,t){switch(console.log("Applying action:",{type:e.type,isUndo:t}),e.type){case"create":return t?this.undoCreate(e):this.redoCreate(e);case"delete":return t?this.undoDelete(e):this.redoDelete(e);case"boolean":return t?this.undoBoolean(e):this.redoBoolean(e);case"modify_position":return this.applyModifyPosition(e,t);case"modify_scale":return this.applyModifyScale(e,t);case"modify_rotation":return this.applyModifyRotation(e,t);case"modify_size":return this.applyModifySize(e,t);case"modify_color":return this.applyModifyColor(e,t);case"modify_opacity":return this.applyModifyOpacity(e,t);case"modify_position_multiple":return this.applyModifyPositionMultiple(e,t);case"import":return t?this.undoImport(e):this.redoImport(e);case"group":return t?this.undoGroup(e):this.redoGroup(e);case"ungroup":return t?this.undoUngroup(e):this.redoUngroup(e);case"sketch_add":return t?this.undoSketchAdd(e):this.redoSketchAdd(e);case"sketch_delete":return t?this.undoSketchDelete(e):this.redoSketchDelete(e);case"paste":return t?this.undoPaste(e):this.redoPaste(e);default:return console.warn("Unknown action type:",e.type),!1}}undoPaste(e){if(console.log("Undoing paste action"),!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{const r=this.editor.findObjectByUuid(e.uuid);r&&(this.removeObjectFromScene(r),t++)}),t>0}redoPaste(e){if(console.log("Redoing paste action"),!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{if(e.data&&this.editor.projectManager){const r=this.editor.projectManager.deserializeObject(e.data);r&&(this.addObjectToScene(r,!1),t++)}}),t>0}undoSketchAdd(e){if(console.log("Undoing sketch add action"),e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{const t=this.editor.findObjectByUuid(e.uuid);t&&(this.editor.sketchManager&&this.editor.sketchManager.elementManager&&this.editor.sketchManager.elementManager.removeElementFromArrays(t),this.removeSketchElement(t))}),e.previousSketchState&&this.restoreSketchState(e.previousSketchState),e.sketchPlaneId&&this.editor.sketchManager){this.editor.findObjectByUuid(e.sketchPlaneId)&&(this.editor.sketchManager.elementManager.updateElementsFromPlane(),this.editor.sketchManager.elementManager.clearSelection())}return this.editor.sketchManager.onUndoRedo(),!0}redoSketchAdd(e){if(console.log("Redoing sketch add action"),e.elements&&Array.isArray(e.elements)){let t=0;return e.elements.forEach(r=>{if(r.data&&this.editor.projectManager){const i=this.editor.projectManager.deserializeObjectOptimized(r.data);if(i&&e.sketchPlaneId){const r=this.editor.findObjectByUuid(e.sketchPlaneId);if(r){if(r.add(i),this.editor.sketchManager&&this.editor.sketchManager.elementManager){const e={type:i.userData.elementType,mesh:i,originalColor:i.userData.originalColor,color:i.userData.originalColor,localPoints:i.userData.localPoints,localPosition:i.userData.localPosition,isClosed:i.userData.isClosed,sketchPlaneId:i.userData.sketchPlaneId,userData:i.userData};this.editor.sketchManager.elementManager.elements.push(e)}t++}}}}),this.editor.sketchManager.onUndoRedo(),t>0}return!1}undoSketchDelete(e){console.log("Undoing sketch delete action");const t=this.editor.findObjectByUuid(e.sketchPlaneId);if(!t)return console.error("Plane not found for undo:",e.sketchPlaneId),!1;let r=0;return e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{if(e.data&&this.editor.projectManager){this.editor.projectManager.restoreSketchElement(t,e.data)&&r++}}),this.editor.sketchManager?.elementManager&&this.editor.sketchManager.elementManager.updateElementsFromPlane(),this.editor.sketchManager&&this.editor.sketchManager.onUndoRedo(),console.log(`Restored ${r} sketch elements`),r>0}redoSketchDelete(e){if(console.log("Redoing sketch delete action"),e.elements&&Array.isArray(e.elements)){let t=0;return e.elements.forEach(e=>{const r=this.editor.findObjectByUuid(e.uuid);r&&(this.editor.sketchManager&&this.editor.sketchManager.elementManager&&this.editor.sketchManager.elementManager.removeElementFromArrays(r),this.removeSketchElement(r),t++)}),this.editor.sketchManager.onUndoRedo(),t>0}return!1}removeSketchElement(e){e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}restoreSketchState(e){if(!e||!e.planeId)return!1;const t=this.editor.findObjectByUuid(e.planeId);if(!t)return!1;for(let e=t.children.length-1;e>=0;e--){const r=t.children[e];r.userData&&"sketch_element"===r.userData.type&&(t.remove(r),r.geometry&&r.geometry.dispose(),r.material&&r.material.dispose())}return e.elements&&Array.isArray(e.elements)&&e.elements.forEach(e=>{if(e.data&&this.editor.projectManager){const r=this.editor.projectManager.deserializeObjectOptimized(e.data);r&&t.add(r)}}),!0}applyModifyPositionMultiple(e,t){if(!e.objects||!Array.isArray(e.objects))return!1;let r=0;return e.objects.forEach(e=>{const i=this.editor.findObjectByUuid(e.uuid);i&&(t?i.position.fromArray(e.previousPosition||[0,0,0]):i.position.fromArray(e.position||[0,0,0]),r++)}),this.editor.updatePropertiesPanel(),r>0}undoCreate(e){const t=this.editor.findObjectByUuid(e.object);return!!t&&(this.removeObjectFromScene(t),!0)}redoCreate(e){if(!e.data||!this.editor.projectManager)return!1;const t=this.editor.projectManager.deserializeObject(e.data);return!!t&&(this.addObjectToScene(t,!0),!0)}undoDelete(e){if(!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{if(!e.data||!this.editor.projectManager)return;const r=this.editor.projectManager.deserializeObject(e.data);r&&(this.addObjectToScene(r,!1),t++,e.sketchState&&this.restoreSketchState(e.sketchState))}),t>0}redoDelete(e){if(!e.objects||!Array.isArray(e.objects))return!1;let t=0;return e.objects.forEach(e=>{const r=this.editor.findObjectByUuid(e.uuid);r&&(this.removeObjectFromScene(r),t++)}),t>0}undoBoolean(e){console.log("Undoing boolean operation:",e.operation);const t=this.editor.findObjectByUuid(e.result);return t&&this.removeObjectFromScene(t),e.originalObjects&&Array.isArray(e.originalObjects)&&e.originalObjects.forEach(e=>{if(!e.data||!this.editor.projectManager)return;const t=this.editor.projectManager.deserializeObject(e.data);t&&this.addObjectToScene(t,!1)}),!0}redoBoolean(e){if(console.log("Redoing boolean operation:",e.operation),e.sourceObjects&&Array.isArray(e.sourceObjects)&&e.sourceObjects.forEach(e=>{const t=this.editor.findObjectByUuid(e);t&&this.removeObjectFromScene(t)}),e.resultData&&this.editor.projectManager){const t=this.editor.projectManager.deserializeObject(e.resultData);if(t)return this.addObjectToScene(t,!0),this.editor.selectSingleObject(t),!0}return!1}applyModifyPosition(e,t){const r=this.editor.findObjectByUuid(e.object);return!!r&&(t?r.position.fromArray(e.data.previousPosition):r.position.fromArray(e.data.position),this.editor.updatePropertiesPanel(),!0)}applyModifyScale(e,t){const r=this.editor.findObjectByUuid(e.object);return!!r&&(t?r.scale.fromArray(e.data.previousScale):r.scale.fromArray(e.data.scale),this.editor.updatePropertiesPanel(),!0)}applyModifyRotation(e,t){const r=this.editor.findObjectByUuid(e.object);return!!r&&(t?r.rotation.fromArray(e.data.previousRotation):r.rotation.fromArray(e.data.rotation),this.editor.updatePropertiesPanel(),!0)}applyModifySize(e,t){const r=this.editor.findObjectByUuid(e.object);return!!r&&(this.editor.transformControls&&(t?this.editor.transformControls.updateObjectSizeDirect(r,e.data.previousDimensions):this.editor.transformControls.updateObjectSizeDirect(r,e.data.dimensions)),this.editor.updatePropertiesPanel(),this.editor.objectsManager.updateSceneStats(),!0)}applyModifyColor(e,t){const r=this.editor.findObjectByUuid(e.object);return!(!r||!r.material)&&(t?this.editor.setObjectColor(r,e.data.previousColor):this.editor.setObjectColor(r,e.data.color),this.editor.updatePropertiesPanel(),!0)}applyModifyOpacity(e,t){const r=this.editor.findObjectByUuid(e.object);return!(!r||!r.material)&&(t?this.editor.setObjectOpacity(r,e.data.previousOpacity):this.editor.setObjectOpacity(r,e.data.opacity),this.editor.updatePropertiesPanel(),!0)}undoImport(e){const t=this.editor.findObjectByUuid(e.object);return!!t&&(this.removeObjectFromScene(t),!0)}redoImport(e){if(!e.data||!this.editor.projectManager)return!1;const t=this.editor.projectManager.deserializeObject(e.data);return!!t&&(this.addObjectToScene(t,!0),this.editor.selectSingleObject(t),!0)}undoGroup(e){const t=this.editor.findObjectByUuid(e.groupUuid);t&&this.removeGroupFromScene(t);let r=0;return e.originalObjects&&Array.isArray(e.originalObjects)&&e.originalObjects.forEach(e=>{if(e.data&&this.editor.projectManager){const t=this.editor.projectManager.deserializeObject(e.data);if(t){if(e.parentUuid){const r=this.editor.findObjectByUuid(e.parentUuid);r?r.add(t):this.editor.objectsGroup.add(t)}else this.editor.objectsGroup.add(t);this.editor.objects.push(t),r++}}}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),r>0}redoGroup(e){if(e.originalObjects&&Array.isArray(e.originalObjects)&&e.originalObjects.forEach(e=>{const t=this.editor.findObjectByUuid(e.uuid);t&&this.removeObjectFromScene(t)}),e.groupData&&this.editor.projectManager){const t=this.editor.projectManager.deserializeObject(e.groupData);if(t)return this.addGroupToScene(t),!0}return!1}undoUngroup(e){e.ungroupedObjects&&Array.isArray(e.ungroupedObjects)&&e.ungroupedObjects.forEach(e=>{const t=this.editor.findObjectByUuid(e.uuid);t&&this.removeObjectFromScene(t)});let t=!1;if(e.groupData&&this.editor.projectManager){const r=this.editor.projectManager.deserializeObject(e.groupData);r&&(this.addGroupToScene(r),r.traverse(e=>{e!==r&&e instanceof THREE.Object3D&&e.updateMatrixWorld(!0)}),t=!0)}return this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),t}redoUngroup(e){const t=this.editor.findObjectByUuid(e.groupUuid);t&&this.removeGroupFromScene(t);let r=0;return e.ungroupedObjects&&Array.isArray(e.ungroupedObjects)&&e.ungroupedObjects.forEach(e=>{if(e.data&&this.editor.projectManager){const t=this.editor.projectManager.deserializeObject(e.data);t&&(this.addObjectToScene(t,!1),r++)}}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),r>0}addGroupToScene(e){this.editor.objectsGroup.add(e),this.editor.objects.push(e),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(e),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeGroupFromScene(e){e.parent&&e.parent.remove(e);const t=this.editor.objects.indexOf(e);if(t>-1&&this.editor.objects.splice(t,1),this.editor.groups){const t=this.editor.groups.indexOf(e);t>-1&&this.editor.groups.splice(t,1)}const r=this.editor.selectedObjects.indexOf(e);r>-1&&this.editor.selectedObjects.splice(r,1),this.editor.transformControls&&this.editor.transformControls.attachedObject===e&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}addObjectToScene(e,t=!1){this.editor.objectsGroup.add(e),this.editor.objects.push(e),"sketch_plane"===e.userData.type?this.editor.sketchPlanes.push(e):"work_plane"===e.userData.type?this.editor.workPlanes.push(e):"group"===e.userData.type&&(this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(e)),t&&this.editor.selectSingleObject(e),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeObjectFromScene(e){e.parent&&e.parent.remove(e);const t=this.editor.objects.indexOf(e);t>-1&&this.editor.objects.splice(t,1);const r=this.editor.selectedObjects.indexOf(e);if(r>-1&&this.editor.selectedObjects.splice(r,1),"sketch_plane"===e.userData.type){const t=this.editor.sketchPlanes.indexOf(e);t>-1&&this.editor.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.editor.workPlanes.indexOf(e);t>-1&&this.editor.workPlanes.splice(t,1)}else if("group"===e.userData.type&&this.editor.groups){const t=this.editor.groups.indexOf(e);t>-1&&this.editor.groups.splice(t,1)}"group"===e.userData.type||e.isGroup?e.traverse(t=>{t!==e&&t.isMesh&&this.safeDisposeObject(t)}):this.safeDisposeObject(e),this.editor.transformControls&&this.editor.transformControls.attachedObject===e&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}safeDisposeObject(e){if(e)try{e.geometry&&"function"==typeof e.geometry.dispose&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}):"function"==typeof e.material.dispose&&e.material.dispose())}catch(e){console.warn("Error disposing object:",e)}}updateHistoryUI(){const e=document.getElementById("historyList");e&&(e.innerHTML="",this.history.forEach((t,r)=>{const i=this.createHistoryItem(t,r);e.appendChild(i)}),e.scrollTop=e.scrollHeight,this.updateUndoRedoButtons())}createHistoryItem(e,t){const r=document.createElement("div");r.className="history-item",r.dataset.index=t,t===this.currentIndex&&r.classList.add("active");const{icon:i,text:o,color:s}=this.getActionInfo(e),a=new Date(e.timestamp).toLocaleTimeString();return r.innerHTML=`\n            <div class="history-item-icon" style="color: ${s};">\n                <i class="${i}"></i>\n            </div>\n            <div class="history-item-content">\n                <div class="history-item-title">${o}</div>\n                <div class="history-item-time">${a}</div>\n            </div>\n        `,r.addEventListener("click",()=>{this.jumpToHistory(t)}),r}getActionInfo(e){return{create:{icon:"fas fa-plus-circle",text:"Создание объекта",color:"#4CAF50"},delete:{icon:"fas fa-trash",text:`Удалено объектов: ${e.objects?.length||1}`,color:"#F44336"},boolean:{icon:"fas fa-shapes",text:`Булева операция: ${e.operation}`,color:"#2196F3"},import:{icon:"fas fa-file-import",text:`Импорт: ${e.data?.userData?.filename||"файл"}`,color:"#FF9800"},modify_position:{icon:"fas fa-arrows-alt",text:"Перемещение",color:"#9C27B0"},modify_scale:{icon:"fas fa-expand-alt",text:"Масштабирование",color:"#3F51B5"},modify_rotation:{icon:"fas fa-sync-alt",text:"Вращение",color:"#00BCD4"},modify_size:{icon:"fas fa-ruler",text:"Изменение размеров",color:"#8BC34A"},modify_position_multiple:{icon:"fas fa-arrows-alt",text:`Перемещение (${e.objects?.length||0} объектов)`,color:"#9C27B0"},modify_color:{icon:"fas fa-palette",text:"Изменение цвета",color:"#E91E63"},modify_opacity:{icon:"fas fa-adjust",text:"Изменение прозрачности",color:"#795548"},sketch_add:{icon:"fas fa-drafting-compass",text:"Добавлен элемент скетча",color:"#FF9800"},sketch_delete:{icon:"fas fa-drafting-compass",text:`Удалено элементов скетча: ${e.elements?.length||1}`,color:"#F44336"}}[e.type]||{icon:"fas fa-history",text:e.type,color:"#757575"}}jumpToHistory(e){if(e!==this.currentIndex)if(console.log("Jumping to history index:",e),e<this.currentIndex)for(;this.currentIndex>e&&this.undo(););else for(;this.currentIndex<e&&this.redo(););}updateUndoRedoButtons(){const e=document.getElementById("undo"),t=document.getElementById("redo");e&&(e.disabled=this.currentIndex<0,e.title=this.currentIndex<0?"Нечего отменять":"Отменить"),t&&(t.disabled=this.currentIndex>=this.history.length-1,t.title=this.currentIndex>=this.history.length-1?"Нечего повторять":"Повторить")}clear(){this.history=[],this.currentIndex=-1,this.updateHistoryUI()}getStats(){return{totalActions:this.history.length,currentIndex:this.currentIndex,canUndo:this.currentIndex>=0,canRedo:this.currentIndex<this.history.length-1}}exportHistory(){return{history:this.history,currentIndex:this.currentIndex}}importHistory(e){return!(!e||!Array.isArray(e.history))&&(this.history=e.history,this.currentIndex=Math.min(e.currentIndex,this.history.length-1),this.updateHistoryUI(),!0)}}