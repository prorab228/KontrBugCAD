import*as THREE from"three";import{LegacyProjectConverter}from"./LegacyProjectConverter.js";import{ParametricOperation}from"../core/parametric/ParametricOperation.js";export class ProjectManager{constructor(e){this.editor=e,this.exportManager=e.exportManager,this.legacyConverter=new LegacyProjectConverter(this.editor),this.currentProject={name:"Новый проект",description:"",created:(new Date).toISOString(),modified:(new Date).toISOString()}}newProject(){this.editor.parametricModel.operations.length>0&&!confirm("Создать новый проект? Несохраненные изменения будут потеряны.")||(this.editor.parametricModel.clear(),this.currentProject={name:"Новый проект",description:"",created:(new Date).toISOString(),modified:(new Date).toISOString()},document.getElementById("projectName").textContent="Новый проект",this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updateStatus(),this.editor.showStatus("Создан новый проект","info"),localStorage.removeItem("cad_last_project"))}showSaveModal(){document.getElementById("saveModal").classList.add("active"),document.getElementById("saveHistoryCheckbox").checked=!1}saveProject(){const e=document.getElementById("projectNameInput").value||"Без названия",t=document.getElementById("projectDescription").value;this.currentProject={metadata:{version:"5.0",type:"parametric-cad-project",generator:"КонтрБагCAD",createdAt:(new Date).toISOString(),appVersion:this.editor.APP_VERSION},name:e,description:t,operations:this.editor.parametricModel.serialize(),modified:(new Date).toISOString()};try{this.downloadProjectFile(this.currentProject),document.getElementById("projectName").textContent=e,document.getElementById("saveModal").classList.remove("active"),this.editor.showStatus(`Проект "${e}" сохранен в файл`,"success"),this.simpleAutoSave()}catch(e){console.error("Ошибка сохранения:",e),this.editor.showStatus("Ошибка сохранения: "+e.message,"error")}}openProject(){const e=document.createElement("input");e.type="file",e.accept=".cadproj,.json,.cad,.kbcad",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const r=new FileReader;r.onload=e=>{try{const t=JSON.parse(e.target.result);this.loadProject(t)}catch(e){alert("Ошибка при загрузке проекта: "+e.message)}},r.readAsText(t)},e.click()}async loadProject(e){if(!e)return void alert("Неверный формат проекта");const t=e.metadata?.version||"1.0";let r=null,o=e.name||"Проект",a=e.description||"";if("5.0"===t)r=e.operations;else{alert("Вы открываете файл созданный в старой версии редактора, проект будет сконвертирован");const t=this.legacyConverter.convert(e);if(!t)return void this.editor.showStatus("Не удалось сконвертировать проект","error");r=t.operations,o=t.name,a=t.description}if(!r)return void alert("Проект не содержит операций");r.some(e=>"boolean_union"===e.type||"boolean_subtract"===e.type||"boolean_intersect"===e.type)&&this.editor.booleanOps&&(this.editor.showStatus("Ожидание загрузки модуля булевых операций...","info"),await this.editor.booleanOps.waitForReady(),await new Promise(e=>setTimeout(e,100)));const i=r.filter(e=>"import_stl"===e.type&&!e.parameters.geometryData).map(e=>e.parameters.filePath).filter((e,t,r)=>r.indexOf(e)===t);if(i.length>0){this.editor.showStatus("Загрузка STL моделей...","info");try{await Promise.all(i.map(e=>this._ensureSTLLoaded(e)))}catch(e){console.error("Ошибка загрузки STL:",e),this.editor.showStatus("Не удалось загрузить некоторые STL модели","warning")}}const s=r.filter(e=>"text3d"===e.type),n=[...new Set(s.map(e=>e.parameters.fontName))];n.length>0&&(this.editor.showStatus(`Ожидание загрузки шрифтов: ${n.join(", ")}`,"info"),await this.editor.fontManager.waitForFonts(n)),this.editor.parametricModel.deserialize(r),this.currentProject={name:o,description:a,created:e.metadata?.createdAt||(new Date).toISOString(),modified:e.modified||(new Date).toISOString()},document.getElementById("projectName").textContent=this.currentProject.name,this.editor.showStatus(`Проект загружен (${r.length} операций)`,"success")}importProject(){const e=document.createElement("input");e.type="file",e.accept=".cadproj,.json,.cad,.kbcad",e.onchange=e=>{const t=e.target.files[0];if(!t)return;const r=new FileReader;r.onload=async e=>{try{const t=JSON.parse(e.target.result);await this.mergeProject(t)}catch(e){alert("Ошибка при импорте проекта: "+e.message)}},r.readAsText(t)},e.click()}async mergeProject(e){if(!e)return void alert("Неверный формат проекта");const t=e.metadata?.version||"1.0";let r=null,o=e.name||"Импортированный проект";if("5.0"===t)r=e.operations;else{alert("Вы импортируете проект старой версии, будет выполнена конвертация");const t=this.legacyConverter.convert(e);if(!t)return void this.editor.showStatus("Не удалось сконвертировать проект","error");r=t.operations,o=t.name}if(!r||0===r.length)return void alert("Проект не содержит операций");r.some(e=>"boolean_union"===e.type||"boolean_subtract"===e.type||"boolean_intersect"===e.type)&&this.editor.booleanOps&&(this.editor.showStatus("Ожидание загрузки модуля булевых операций...","info"),await this.editor.booleanOps.waitForReady(),await new Promise(e=>setTimeout(e,100)));const a=r.filter(e=>"import_stl"===e.type&&!e.parameters.geometryData).map(e=>e.parameters.filePath).filter((e,t,r)=>r.indexOf(e)===t);if(a.length>0){this.editor.showStatus("Загрузка STL моделей...","info");try{await Promise.all(a.map(e=>this._ensureSTLLoaded(e)))}catch(e){console.error("Ошибка загрузки STL:",e),this.editor.showStatus("Не удалось загрузить некоторые STL модели","warning")}}const i=r.filter(e=>"text3d"===e.type),s=[...new Set(i.map(e=>e.parameters.fontName))];s.length>0&&(this.editor.showStatus(`Ожидание загрузки шрифтов: ${s.join(", ")}`,"info"),await this.editor.fontManager.waitForFonts(s));const n=new Set;r.forEach(e=>{e.outputs&&Array.isArray(e.outputs)&&e.outputs.forEach(e=>n.add(e)),e.inputs&&Array.isArray(e.inputs)&&e.inputs.forEach(e=>n.add(e))});const c=new Map;n.forEach(e=>{c.set(e,crypto.randomUUID())});const d=[];for(const e of r){const t={...e};t.id=crypto.randomUUID(),t.outputs&&Array.isArray(t.outputs)&&(t.outputs=t.outputs.map(e=>c.get(e)||e)),t.inputs&&Array.isArray(t.inputs)&&(t.inputs=t.inputs.map(e=>c.get(e)||e)),t.parameters=this._replaceUuidsInObject(t.parameters,c),d.push(t)}for(const e of d){const t=ParametricOperation.deserialize(e);this.editor.parametricModel.addOperation(t,!1)}this.editor.showStatus(`Импортировано ${d.length} операций из проекта "${o}"`,"success")}_replaceUuidsInObject(e,t){if("string"==typeof e)return t.has(e)?t.get(e):e;if(Array.isArray(e))return e.map(e=>this._replaceUuidsInObject(e,t));if(e&&"object"==typeof e){const r={};for(const[o,a]of Object.entries(e))r[o]=this._replaceUuidsInObject(a,t);return r}return e}async _ensureSTLLoaded(e){const t=this.editor.libraryManager;if(t.modelCache.has(e))return;const r=t.libraryItems.find(t=>t.modelPath===e);if(r)r.loadedGeometry||await t.preloadModel(r);else try{const r=await t.loadSTLGeometryForPreview(e);t.modelCache.set(e,{geometry:r.geometry,originalSize:r.originalSize})}catch(t){throw console.warn(`Не удалось загрузить STL по пути ${e}`,t),t}}downloadProjectFile(e){const t=JSON.stringify(e,null,2),r=new Blob([t],{type:"application/json"}),o=`${e.name.replace(/[^a-z0-9а-яё\s]/gi,"_").toLowerCase()}.kbcad`;this.exportManager.downloadFile(r,o)}simpleAutoSave(){if(this.editor.autoSaveEnabled&&0!==this.editor.parametricModel.operations.length)try{const e={metadata:{version:"5.0",type:"parametric-cad-project",generator:"КонтрБагCAD"},name:this.currentProject.name||"Автосохраненный проект",operations:this.editor.parametricModel.serialize(),modified:(new Date).toISOString()},t=JSON.stringify(e),r=t.length/1048576;if(r>6)return console.warn(`Проект слишком большой для автосохранения: ${r.toFixed(2)} МБ`),void this.editor.showStatus("Проект слишком велик для автосохранения","warning");localStorage.setItem("cad_last_project",t),console.log(`Автосохранено: ${r.toFixed(2)} МБ`)}catch(e){console.warn("Не удалось автосохранить:",e),this.editor.showStatus("Не удалось автосохранить","warning"),"QuotaExceededError"===e.name&&(localStorage.removeItem("cad_last_project"),this.editor.showStatus("Места недостаточно, автосохранение отключено","error"),this.editor.autoSaveEnabled=!1,document.getElementById("autoSaveCheckbox")&&(document.getElementById("autoSaveCheckbox").checked=!1))}}checkAutoSave(){try{const e=localStorage.getItem("cad_last_project");return e?JSON.parse(e):null}catch(e){return console.warn("Ошибка проверки автосохранения:",e),null}}}