class ExportManager{constructor(e){this.editor=e}showExportModal(){document.getElementById("exportModal").classList.add("active"),document.getElementById("exportFileName").value=document.getElementById("projectName").textContent.replace(/\s+/g,"_")}exportModel(){const e=document.getElementById("exportFormat").value,t=document.getElementById("exportSelected").checked,o=document.getElementById("exportFileName").value||"model",r=document.getElementById("exportMaterials")?.checked||!1;let s;if(s=t&&this.editor.selectedObjects.length>0?this.editor.selectedObjects:this.editor.objects.filter(e=>"sketch_plane"!==e.userData.type&&"work_plane"!==e.userData.type&&"sketch_element"!==e.userData.type),0!==s.length){switch(e){case"stl":case"stl-ascii":this.exportSTL(s,o,"stl-ascii"===e);break;case"obj":this.exportOBJ(s,o,r);break;case"ply":this.exportPLY(s,o,r);break;case"dae":this.exportDAE(s,o,r);break;case"gltf":this.exportGLTF(s,o,r);break;case"3mf":this.export3MF(s,o);break;default:this.editor.showStatus("Формат не поддерживается","error")}document.getElementById("exportModal").classList.remove("active")}else alert("Нет объектов для экспорта!")}collectMeshes(e){const t=[],o=e=>{e.isMesh&&t.push(e),e.children&&e.children.forEach(e=>o(e))};return e.forEach(e=>o(e)),t}createExportGroup(e,t=!0){const o=new THREE.Group;return e.forEach(e=>{const r=e.clone();t&&(e.updateMatrixWorld(!0),r.geometry=r.geometry.clone(),r.geometry.applyMatrix4(e.matrixWorld),r.position.set(0,0,0),r.rotation.set(0,0,0),r.scale.set(1,1,1),r.updateMatrix()),o.add(r)}),o.rotation.x=Math.PI/2,o.updateMatrixWorld(!0),o}downloadFile(e,t){const o=document.createElement("a");o.href=URL.createObjectURL(e),o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o)}exportSTL(e,t,o=!1){try{const r=new THREE.STLExporter,s=this.collectMeshes(e);if(0===s.length)throw new Error("Нет мешей");const n=this.createExportGroup(s,!0),l=r.parse(n,{binary:!o}),i=new Blob([l],{type:o?"text/plain":"application/octet-stream"});this.downloadFile(i,t+".stl"),this.editor.showStatus(`Экспорт STL завершен (${s.length} мешей)`,"success")}catch(e){console.error("STL export error:",e),this.editor.showStatus("Ошибка экспорта STL","error")}}exportOBJ(e,t,o){try{if(void 0===THREE.OBJExporter)throw new Error("OBJExporter не найден");const r=new THREE.OBJExporter,s=this.collectMeshes(e);if(0===s.length)throw new Error("Нет мешей");const n=this.createExportGroup(s,!0),l=r.parse(n);let i="# Экспортировано из КонтрБагCAD\n";if(o&&(i+=`mtllib ${t}.mtl\n\n`),i+=l,o){const e=new JSZip;e.file(`${t}.obj`,i),e.file(`${t}.mtl`,this.createMTLContent(s)),e.generateAsync({type:"blob"}).then(e=>this.downloadFile(e,`${t}.zip`)).catch(e=>{console.warn("ZIP creation failed, saving OBJ only",e);const o=new Blob([i],{type:"text/plain"});this.downloadFile(o,t+".obj")})}else{const e=new Blob([i],{type:"text/plain"});this.downloadFile(e,t+".obj")}this.editor.showStatus("Экспорт OBJ завершен","success")}catch(e){console.error("OBJ export error:",e),this.editor.showStatus("Ошибка экспорта OBJ","error")}}createMTLContent(e){return"# Material file for CAD export\nnewmtl default\nKa 0.2 0.2 0.2\nKd 0.8 0.8 0.8\nKs 0.5 0.5 0.5\nNs 32\nd 1.0\nillum 2\n"}exportPLY(e,t,o){try{if(void 0===THREE.PLYExporter)throw new Error("PLYExporter не найден");const o=new THREE.PLYExporter,r=this.collectMeshes(e);if(0===r.length)throw new Error("Нет мешей");const s=this.createExportGroup(r,!0),n=o.parse(s,{binary:!1}),l=new Blob([n],{type:"text/plain"});this.downloadFile(l,t+".ply"),this.editor.showStatus("Экспорт PLY завершен","success")}catch(e){console.error("PLY export error:",e),this.editor.showStatus("Ошибка экспорта PLY","error")}}exportDAE(e,t,o){try{if(void 0===THREE.ColladaExporter)throw new Error("ColladaExporter не найден");const r=new THREE.ColladaExporter,s=this.collectMeshes(e);if(0===s.length)throw new Error("Нет мешей");const n=this.createExportGroup(s,!0),l=r.parse(n,{version:"1.4.1",author:"КонтрБагCAD",textureDirectory:"textures",upAxis:"Z_UP",unitName:"millimeter",unitMeter:.001});if(o&&l.textures&&Object.keys(l.textures).length>0){const e=new JSZip;e.file(`${t}.dae`,l.data),Object.entries(l.textures).forEach(([t,o])=>{e.file(`textures/${t}`,o)}),e.generateAsync({type:"blob"}).then(e=>this.downloadFile(e,`${t}.zip`)).catch(e=>{console.warn("ZIP failed, saving DAE only",e);const o=new Blob([l.data],{type:"application/xml"});this.downloadFile(o,t+".dae")})}else{const e=new Blob([l.data],{type:"application/xml"});this.downloadFile(e,t+".dae")}this.editor.showStatus("Экспорт Collada завершен","success")}catch(e){console.error("DAE export error:",e),this.editor.showStatus("Ошибка экспорта Collada","error")}}exportGLTF(e,t,o){try{if(void 0===THREE.GLTFExporter)throw new Error("GLTFExporter не найден");const o=new THREE.GLTFExporter,r=this.collectMeshes(e);if(0===r.length)throw new Error("Нет мешей");const s=this.createExportGroup(r,!0);o.parse(s,e=>{const o=JSON.stringify(e,null,2),r=new Blob([o],{type:"application/json"});this.downloadFile(r,t+".gltf"),this.editor.showStatus("Экспорт GLTF завершен","success")},{binary:!1,trs:!0,onlyVisible:!0,includeCustomExtensions:!0})}catch(e){console.error("GLTF export error:",e),this.editor.showStatus("Ошибка экспорта GLTF","error")}}export3MF(e,t){try{const o=this.collectMeshes(e);if(0===o.length)return void this.editor.showStatus("Нет мешей для экспорта","error");const r=[],s=[];let n=0;if(o.forEach(e=>{e.updateMatrixWorld(!0);const t=e.geometry.clone();if(t.applyMatrix4(e.matrixWorld),!t.attributes.position)return;const o=t.attributes.position.array.slice();for(let e=0;e<o.length;e+=3){const t=o[e],r=o[e+1],s=o[e+2];o[e]=t,o[e+1]=-s,o[e+2]=r}let l;if(r.push(...o),t.index)l=Array.from(t.index.array);else{l=[];for(let e=0;e<o.length/3;e++)l.push(e)}l.forEach(e=>s.push(e+n)),n+=o.length/3}),0===r.length)return void this.editor.showStatus("Нет вершин для экспорта","error");const l=this.generate3MFXML(r,s),i=new JSZip;i.file("[Content_Types].xml",this.getContentTypesXml()),i.file("_rels/.rels",this.getRelsXml()),i.file("3D/3dmodel.model",l),i.generateAsync({type:"blob"}).then(e=>this.downloadFile(e,t+".3mf")).catch(e=>{console.error("Ошибка создания 3MF архива:",e),this.editor.showStatus("Ошибка создания 3MF","error")}),this.editor.showStatus("Экспорт 3MF завершен","success")}catch(e){console.error("3MF export error:",e),this.editor.showStatus("Ошибка экспорта 3MF","error")}}generate3MFXML(e,t){let o="";for(let t=0;t<e.length;t+=3)o+=`<vertex x="${e[t].toFixed(6)}" y="${e[t+1].toFixed(6)}" z="${e[t+2].toFixed(6)}" />\n`;let r="";for(let e=0;e<t.length;e+=3)r+=`<triangle v1="${t[e]}" v2="${t[e+1]}" v3="${t[e+2]}" />\n`;return`<?xml version="1.0" encoding="UTF-8"?>\n<model unit="millimeter" xml:lang="en" xmlns="http://schemas.microsoft.com/3dmanufacturing/core/2015/02">\n  <resources>\n    <object id="1" type="model">\n      <mesh>\n        <vertices>\n          ${o}\n        </vertices>\n        <triangles>\n          ${r}\n        </triangles>\n      </mesh>\n    </object>\n  </resources>\n  <build>\n    <item objectid="1" />\n  </build>\n</model>`}getContentTypesXml(){return'<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml" />\n  <Default Extension="model" ContentType="application/vnd.ms-package.3dmanufacturing-3dmodel+xml" />\n</Types>'}getRelsXml(){return'<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Target="/3D/3dmodel.model" Id="rel0" Type="http://schemas.microsoft.com/3dmanufacturing/2013/01/3dmodel" />\n</Relationships>'}}