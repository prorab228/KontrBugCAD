class ExportManager{constructor(e){this.editor=e}showExportModal(){document.getElementById("exportModal").classList.add("active"),document.getElementById("exportFileName").value=document.getElementById("projectName").textContent.replace(/\s+/g,"_")}exportModel(){const e=document.getElementById("exportFormat").value,t=document.getElementById("exportSelected").checked,o=document.getElementById("exportFileName").value||"model";let s;if(s=t&&this.editor.selectedObjects.length>0?this.editor.selectedObjects:this.editor.objects.filter(e=>"sketch_plane"!==e.userData.type&&"work_plane"!==e.userData.type&&"sketch_element"!==e.userData.type),0!==s.length){switch(e){case"stl":case"stl-ascii":this.exportSTL(s,o,"stl-ascii"===e);break;case"json":this.exportJSON(s,o)}document.getElementById("exportModal").classList.remove("active")}else alert("Нет объектов для экспорта!")}exportSTL(e,t,o=!1){const s=new THREE.STLExporter,a=[],r=e=>{e.isMesh&&a.push(e),e.children&&e.children.length>0&&e.children.forEach(t=>{t!==e&&r(t)})};if(e.forEach(e=>{r(e)}),0===a.length)return void this.editor.showStatus("Нет мешей для экспорта","error");const i=new THREE.Group;a.forEach(e=>{const t=e.clone();e.updateMatrixWorld(!0),t.geometry=t.geometry.clone(),t.geometry.applyMatrix4(e.matrixWorld),t.position.set(0,0,0),t.rotation.set(0,0,0),t.scale.set(1,1,1),t.updateMatrix(),i.add(t)}),i.rotation.x=Math.PI/2,i.updateMatrixWorld(!0);const n=s.parse(i,{binary:!o}),l=new Blob([n],{type:o?"text/plain":"application/octet-stream"});this.downloadFile(l,t+".stl"),this.editor.showStatus(`Экспорт STL завершен (${a.length} мешей)`,"success")}exportJSON(e,t){const o={metadata:{version:"4.0",type:"cad-export",exportDate:(new Date).toISOString(),appVersion:this.editor.APP_VERSION},name:t,objects:e.map(e=>this.editor.projectManager.serializeObject(e)).filter(e=>e)},s=JSON.stringify(o,null,2),a=new Blob([s],{type:"application/json"});this.downloadFile(a,t+".json"),this.editor.showStatus("Экспорт JSON завершен","success")}exportSVG(){this.editor.showStatus("Экспорт SVG в разработке","info")}downloadFile(e,t){const o=document.createElement("a");o.href=URL.createObjectURL(e),o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o)}}