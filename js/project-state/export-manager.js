class ExportManager{constructor(e){this.editor=e}showExportModal(){document.getElementById("exportModal").classList.add("active"),document.getElementById("exportFileName").value=document.getElementById("projectName").textContent.replace(/\s+/g,"_")}exportModel(){const e=document.getElementById("exportFormat").value,t=document.getElementById("exportSelected").checked,o=document.getElementById("exportFileName").value||"model";let r;if(r=t&&this.editor.selectedObjects.length>0?this.editor.selectedObjects:this.editor.objects.filter(e=>"sketch_plane"!==e.userData.type&&"work_plane"!==e.userData.type&&"sketch_element"!==e.userData.type),0!==r.length){switch(e){case"stl":case"stl-ascii":this.exportSTL(r,o,"stl-ascii"===e);break;case"obj":this.exportOBJ(r,o)}document.getElementById("exportModal").classList.remove("active")}else alert("Нет объектов для экспорта!")}fixNormalsAndOrientation(e){(e=e.clone()).index||(e=THREE.BufferGeometryUtils.mergeVertices(e,.01)),e.computeVertexNormals();const t=e.index?e.index.array:null,o=e.attributes.position.array,r=e.attributes.normal.array;let n=0,a=0;if(t){a=t.length/3;for(let e=0;e<t.length;e+=3){const a=3*t[e],s=3*t[e+1],l=3*t[e+2],c=new THREE.Vector3(o[a],o[a+1],o[a+2]),i=new THREE.Vector3(o[s],o[s+1],o[s+2]),d=new THREE.Vector3(o[l],o[l+1],o[l+2]),E=(new THREE.Vector3).subVectors(i,c),p=(new THREE.Vector3).subVectors(d,c),m=(new THREE.Vector3).crossVectors(E,p).normalize(),h=(new THREE.Vector3).add(c).add(i).add(d).multiplyScalar(1/3),u=new THREE.Vector3(r[a],r[a+1],r[a+2]),w=new THREE.Vector3(r[s],r[s+1],r[s+2]),x=new THREE.Vector3(r[l],r[l+1],r[l+2]),y=(new THREE.Vector3).add(u).add(w).add(x).multiplyScalar(1/3).normalize(),T=m.dot(y),V=m.dot(h.normalize());(T<-.5||V>0)&&([t[e+1],t[e+2]]=[t[e+2],t[e+1]],n++)}e.index&&(e.index.needsUpdate=!0)}else{a=o.length/9;for(let e=0;e<o.length;e+=9){const t=new THREE.Vector3(o[e],o[e+1],o[e+2]),a=new THREE.Vector3(o[e+3],o[e+4],o[e+5]),s=new THREE.Vector3(o[e+6],o[e+7],o[e+8]),l=(new THREE.Vector3).subVectors(a,t),c=(new THREE.Vector3).subVectors(s,t),i=(new THREE.Vector3).crossVectors(l,c).normalize(),d=(new THREE.Vector3).add(t).add(a).add(s).multiplyScalar(1/3),E=new THREE.Vector3(r[e],r[e+1],r[e+2]),p=new THREE.Vector3(r[e+3],r[e+4],r[e+5]),m=new THREE.Vector3(r[e+6],r[e+7],r[e+8]),h=(new THREE.Vector3).add(E).add(p).add(m).multiplyScalar(1/3).normalize(),u=i.dot(h),w=i.dot(d.normalize());if(u<-.5||w>0){const t=o[e+3],a=o[e+4],s=o[e+5];o[e+3]=o[e+6],o[e+4]=o[e+7],o[e+5]=o[e+8],o[e+6]=t,o[e+7]=a,o[e+8]=s;const l=r[e+3],c=r[e+4],i=r[e+5];r[e+3]=r[e+6],r[e+4]=r[e+7],r[e+5]=r[e+8],r[e+6]=l,r[e+7]=c,r[e+8]=i,n++}}e.attributes.position.needsUpdate=!0,e.attributes.normal.needsUpdate=!0}return console.log(`Исправлено ${n} из ${a} треугольников`),e.computeVertexNormals(),e}exportSTL(e,t,o=!1){const r=new THREE.STLExporter,n=[],a=e=>{e.isMesh&&n.push(e),e.children&&e.children.length>0&&e.children.forEach(t=>{t!==e&&a(t)})};if(e.forEach(e=>{a(e)}),0===n.length)return void this.editor.showStatus("Нет мешей для экспорта","error");const s=new THREE.Group;n.forEach(e=>{const t=e.clone();e.updateMatrixWorld(!0),t.geometry=t.geometry.clone(),t.geometry.applyMatrix4(e.matrixWorld),t.position.set(0,0,0),t.rotation.set(0,0,0),t.scale.set(1,1,1),t.updateMatrix(),s.add(t)}),s.rotation.x=Math.PI/2,s.updateMatrixWorld(!0);const l=r.parse(s,{binary:!o}),c=new Blob([l],{type:o?"text/plain":"application/octet-stream"});this.downloadFile(c,t+".stl"),this.editor.showStatus(`Экспорт STL завершен (${n.length} мешей)`,"success")}exportOBJ(e,t){try{if(void 0===THREE.OBJExporter)return void this.editor.showStatus("OBJExporter не найден. Подключите three/examples/jsm/exporters/OBJExporter.js","error");const o=new THREE.OBJExporter,r=new THREE.Group;e.forEach(e=>{const t=e.clone();t.isMesh&&(t.geometry=t.geometry.clone(),t.geometry.applyMatrix4(t.matrixWorld),t.position.set(0,0,0),t.rotation.set(0,0,0),t.scale.set(1,1,1),t.updateMatrix()),r.add(t)}),r.rotation.x=Math.PI/2,r.updateMatrixWorld(!0);const n=o.parse(r),a=this.createMTLContent(),s=`# Экспортировано из CAD приложения\nmtllib ${t}.mtl\n\n`+n,l=new JSZip;l.file(`${t}.obj`,s),l.file(`${t}.mtl`,a),l.generateAsync({type:"blob"}).then(e=>{this.downloadFile(e,`${t}.zip`),this.editor.showStatus("Экспорт OBJ завершен (включая материалы)","success")}).catch(e=>{console.error("Ошибка создания ZIP:",e);const o=new Blob([s],{type:"text/plain"});this.downloadFile(o,t+".obj"),this.editor.showStatus("Экспорт OBJ завершен (без материалов)","success")})}catch(e){console.error("Ошибка экспорта OBJ:",e),this.editor.showStatus("Ошибка экспорта OBJ","error")}}createMTLContent(){return"# Material file for CAD export\nnewmtl Material\nKa 0.2 0.2 0.2\nKd 0.8 0.8 0.8\nKs 0.5 0.5 0.5\nNs 32\nd 1.0\nillum 2\n"}exportSVG(){this.editor.showStatus("Экспорт SVG в разработке","info")}downloadFile(e,t){const o=document.createElement("a");o.href=URL.createObjectURL(e),o.download=t,document.body.appendChild(o),o.click(),document.body.removeChild(o)}}