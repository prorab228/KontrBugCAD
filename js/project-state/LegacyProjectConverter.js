class LegacyProjectConverter{constructor(e){this.editor=e,this.uuidMap=new Map}convert(e){console.log("Конвертация старого проекта..."),this.editor.parametricModel.clear(),this.uuidMap.clear();let t=0;if(e.scene&&e.scene.objects)for(const r of e.scene.objects)try{this._convertObject(r),t++}catch(e){console.error("Ошибка конвертации объекта:",e,r)}if(e.scene&&e.scene.sketches)for(const r of e.scene.sketches)try{this._convertSketch(r),t++}catch(e){console.error("Ошибка конвертации скетча:",e,r)}return console.log(`Конвертировано объектов: ${t}`),setTimeout(()=>{const e=this.editor.parametricModel.sceneGroup;console.log(`Объектов в parametricModel.sceneGroup: ${e.children.length}`),e.children.forEach(e=>{if(e.isMesh){const t=e.geometry,r=t.attributes.position,o=t.index,a=r?r.count:0,i=o&&o.count>0?o.count/3:a/3;console.log(`Меш ${e.uuid}: вершин=${a}, треугольников=${i}, позиция=${e.position.toArray()}`)}else console.log(`Объект ${e.uuid} (тип ${e.type})`)}),this.editor.objectsManager&&(this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList()),this.editor.updatePropertiesPanel&&this.editor.updatePropertiesPanel()},100),t>0}_convertObject(e){const t=(e.userData||{}).type;"sketch_plane"!==t&&"work_plane"!==t?"stl"===t?this._convertSTL(e):"image"===t?this._convertImage(e):"boolean_result"===t?this._convertBooleanResult(e):"Group"===e.type?this._convertGroup(e):this._convertPrimitiveOrMesh(e):this._convertPlane(e)}_convertPlane(e){const t=e.userData||{};let r,o;if(e.rotation&&3===e.rotation.length){const t=(new THREE.Quaternion).setFromEuler(new THREE.Euler(e.rotation[0],e.rotation[1],e.rotation[2]));r=new THREE.Vector3(0,0,1).applyQuaternion(t).toArray(),o=new THREE.Vector3(0,1,0).applyQuaternion(t).toArray()}else r=this._extractVector3(t.normal)||[0,0,1],o=this._extractVector3(t.up)||[0,1,0];const a={position:e.position||[0,0,0],normal:r,up:o,name:t.name||("sketch_plane"===t.type?"Плоскость скетча":"Рабочая плоскость"),planeType:t.type||"work_plane"},i=new ParametricOperation("create_workplane",a,[]);if(this.editor.parametricModel.addOperation(i),i.outputs&&i.outputs[0]){const r=i.outputs[0];this.uuidMap.set(e.uuid,r);const o=this.editor.parametricModel.objectMap.get(r);o&&o.userData&&(o.userData.type=t.type||"work_plane")}}_convertSTL(e){const t=(e.userData||{}).filename||"";let r=e.geometry||null;if(!t&&!r)return void console.warn("STL объект не содержит ни filename, ни геометрии, пропускаем",e);r&&r.indices&&0===r.indices.length&&delete r.indices;const o={filePath:t,position:e.position||[0,0,0],rotation:e.rotation||[0,0,0],scale:e.scale||[1,1,1],visible:!1!==e.visible,castShadow:e.castShadow||!1,receiveShadow:e.receiveShadow||!1};r&&(o.geometryData=r),e.material&&(o.color=this._extractColor(e.material));const a=new ParametricOperation("import_stl",o,[]);this.editor.parametricModel.addOperation(a),a.outputs&&a.outputs[0]&&this.uuidMap.set(e.uuid,a.outputs[0])}_convertImage(e){const t={imageURL:e.userData.imageURL||e.userData.textureDataURL||"",dimensions:e.userData.dimensions||{width:50,height:50},depth:e.userData.imageDepth||.1,keepAspectRatio:e.userData.keepAspectRatio||!1,transparent:e.userData.isTransparent||!1,opacity:e.userData.opacity||1,position:e.position||[0,0,0],rotation:e.rotation||[0,0,0],scale:e.scale||[1,1,1],visible:!1!==e.visible},r=new ParametricOperation("create_image",t,[]);this.editor.parametricModel.addOperation(r),r.outputs&&r.outputs[0]&&this.uuidMap.set(e.uuid,r.outputs[0])}_convertBooleanResult(e){const t=e.userData||{},r=(t.sourceObjects||[]).map(e=>this.uuidMap.get(e)).filter(e=>void 0!==e);if(r.length>=2){let o="boolean_union";"subtract"===t.operation?o="boolean_subtract":"intersect"===t.operation&&(o="boolean_intersect");const a={operation:t.operation||"union",sources:r,position:e.position||[0,0,0],rotation:e.rotation||[0,0,0],scale:e.scale||[1,1,1],visible:!1!==e.visible},i=new ParametricOperation(o,a,r);return this.editor.parametricModel.addOperation(i),void(i.outputs&&i.outputs[0]&&this.uuidMap.set(e.uuid,i.outputs[0]))}if(e.geometry)return console.warn("Булев результат не имеет исходных объектов, импортируем как меш",e.uuid),void this._convertMesh(e);console.warn("Не удалось конвертировать булев результат: нет ни исходных объектов, ни геометрии",e)}_convertGroup(e){const t=[];if(e.children)for(const r of e.children){this._convertObject(r);const e=this.uuidMap.get(r.uuid);e&&t.push(e)}const r={children:t,position:e.position||[0,0,0],rotation:e.rotation||[0,0,0],scale:e.scale||[1,1,1],visible:!1!==e.visible,name:e.userData?.name||"Группа"},o=new ParametricOperation("create_group",r,t);this.editor.parametricModel.addOperation(o),o.outputs&&o.outputs[0]&&this.uuidMap.set(e.uuid,o.outputs[0])}_convertPrimitiveOrMesh(e){let t=(e.userData||{}).geometryType||this._detectGeometryType(e);t&&this._isPrimitiveType(t)?this._convertPrimitive(e,t):this._convertMesh(e)}_detectGeometryType(e){return e.geometry&&e.geometry.type?e.geometry.type:e.userData.geometryType?e.userData.geometryType:null}_isPrimitiveType(e){return["BoxGeometry","SphereGeometry","CylinderGeometry","ConeGeometry","TorusGeometry","PlaneGeometry","CircleGeometry","TorusKnotGeometry"].includes(e)}_convertPrimitive(e,t){let r=this._extractPrimitiveParams(e,t);r.position=e.position||[0,0,0],r.rotation=e.rotation||[0,0,0],r.scale=e.scale||[1,1,1],r.visible=!1!==e.visible,r.castShadow=e.castShadow||!1,r.receiveShadow=e.receiveShadow||!1,e.material&&(r.color=this._extractColor(e.material),r.opacity=e.material.opacity,r.transparent=e.material.transparent);const o=new ParametricOperation("create_primitive",r,[]);this.editor.parametricModel.addOperation(o),o.outputs&&o.outputs[0]&&this.uuidMap.set(e.uuid,o.outputs[0])}_extractPrimitiveParams(e,t){const r={type:t};let o=null;if(e.geometry&&e.geometry.parameters?o=e.geometry.parameters:e.userData.geometryParams&&(o=e.userData.geometryParams),o)for(const[e,t]of Object.entries(o))t&&t.isVector3?r[e]=t.toArray():Array.isArray(t)?r[e]=t:"number"!=typeof t&&"boolean"!=typeof t&&"string"!=typeof t||(r[e]=t);else switch(t){case"BoxGeometry":r.width=25,r.height=25,r.depth=25;break;case"SphereGeometry":r.radius=12.5;break;case"CylinderGeometry":r.radiusTop=12.5,r.radiusBottom=12.5,r.height=25;break;case"ConeGeometry":r.radius=12.5,r.height=25;break;case"TorusGeometry":r.radius=25,r.tube=5;break;case"PlaneGeometry":r.width=100,r.height=100;break;case"CircleGeometry":r.radius=10;break;case"TorusKnotGeometry":r.radius=10,r.tube=3}return r}_convertMesh(e){if(!e.geometry)return void console.warn("Объект не содержит геометрии, пропускаем",e);e.geometry.indices&&0===e.geometry.indices.length&&delete e.geometry.indices;const t={geometryData:e.geometry,position:e.position||[0,0,0],rotation:e.rotation||[0,0,0],scale:e.scale||[1,1,1],visible:!1!==e.visible,castShadow:e.castShadow||!1,receiveShadow:e.receiveShadow||!1};e.material&&(t.material=e.material,t.color=this._extractColor(e.material),t.opacity=e.material.opacity,t.transparent=e.material.transparent);const r=new ParametricOperation("import_mesh",t,[]);this.editor.parametricModel.addOperation(r),r.outputs&&r.outputs[0]&&this.uuidMap.set(e.uuid,r.outputs[0])}_extractColor(e){if(!e)return 8421504;if("number"==typeof e.color)return e.color;if(e.color&&"object"==typeof e.color){if(Array.isArray(e.color))return e.color[0]<<16|e.color[1]<<8|e.color[2];if(void 0!==e.color.r)return e.color.r<<16|e.color.g<<8|e.color.b}return 8421504}_convertSketch(e){let t=null;if(e.planeId&&(t=this.uuidMap.get(e.planeId)),!t&&e.planeData&&(t=this._createWorkplaneFromData(e.planeData),e.planeId&&t&&this.uuidMap.set(e.planeId,t)),!t)return void console.warn("Не удалось определить плоскость для скетча, пропускаем",e);const r=[];if(e.elements)for(const t of e.elements){const e=this._convertSketchElement(t);e&&r.push(e)}if(0===r.length)return;const o=new ParametricOperation("sketch",{planeId:t,elements:r,name:e.name||"Чертеж"},[]);this.editor.parametricModel.addOperation(o)}_createWorkplaneFromData(e){const t=e.userData||{};let r,o;if(e.rotation&&3===e.rotation.length){const t=(new THREE.Quaternion).setFromEuler(new THREE.Euler(e.rotation[0],e.rotation[1],e.rotation[2]));r=new THREE.Vector3(0,0,1).applyQuaternion(t).toArray(),o=new THREE.Vector3(0,1,0).applyQuaternion(t).toArray()}else r=this._extractVector3(t.normal)||[0,0,1],o=this._extractVector3(t.up)||[0,1,0];const a={position:e.position||[0,0,0],normal:r,up:o,name:t.name||"Плоскость скетча",planeType:t.type||"work_plane"},i=new ParametricOperation("create_workplane",a,[]);if(this.editor.parametricModel.addOperation(i),i.outputs&&i.outputs[0]){const e=i.outputs[0],r=this.editor.parametricModel.objectMap.get(e);return r&&r.userData&&(r.userData.type=t.type||"work_plane"),e}return null}_convertSketchElement(e){if(!e.userData)return null;const t=e.userData.localPoints||[];if(0===t.length)return null;const r=t.map(e=>Array.isArray(e)?[e[0],e[1]]:e&&void 0!==e.x?[e.x,e.y]:[0,0]),o={type:e.userData.elementType||"line",points:r,color:e.userData.originalColor||1118481,closed:e.userData.isClosed||!1,dashed:e.userData.dashed||!1};if(e.userData.dashSize&&(o.dashSize=e.userData.dashSize),e.userData.gapSize&&(o.gapSize=e.userData.gapSize),"circle"===o.type&&e.userData.center&&e.userData.radius){let t=e.userData.center;Array.isArray(t)?o.center=[t[0],t[1]]:void 0!==t.x&&(o.center=[t.x,t.y]),o.radius=e.userData.radius}return o}_extractVector3(e){return e?Array.isArray(e)&&e.length>=3?[e[0],e[1],e[2]]:e.isVector3||void 0!==e.x&&void 0!==e.y&&void 0!==e.z?[e.x,e.y,e.z]:null:null}}