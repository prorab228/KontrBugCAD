import*as THREE from"three";import{STLExporter}from"three/addons/exporters/STLExporter.js";import{OBJExporter}from"three/addons/exporters/OBJExporter.js";import{PLYExporter}from"three/addons/exporters/PLYExporter.js";import{GLTFExporter}from"three/addons/exporters/GLTFExporter.js";import JSZip from"jszip";export class ExportManager{constructor(e){this.editor=e}showExportModal(){document.getElementById("exportModal").classList.add("active"),document.getElementById("exportFileName").value=document.getElementById("projectName").textContent.replace(/\s+/g,"_")}exportModel(){const e=document.getElementById("exportFormat").value,t=document.getElementById("exportSelected").checked,r=document.getElementById("exportFileName").value||"model",o=document.getElementById("exportMaterials")?.checked||!1;let s;if(s=t&&this.editor.selectedObjects.length>0?this.editor.selectedObjects:this.editor.objects.filter(e=>"sketch_plane"!==e.userData.type&&"work_plane"!==e.userData.type&&"sketch_element"!==e.userData.type),0!==s.length){switch(e){case"stl":case"stl-ascii":this.exportSTL(s,r,"stl-ascii"===e);break;case"obj":this.exportOBJ(s,r,o);break;case"ply":this.exportPLY(s,r,o);break;case"gltf":this.exportGLTF(s,r,o);break;case"3mf":this.export3MF(s,r);break;default:this.editor.showStatus("Формат не поддерживается","error")}document.getElementById("exportModal").classList.remove("active")}else alert("Нет объектов для экспорта!")}collectMeshes(e){const t=[],r=e=>{e.isMesh&&t.push(e),e.children&&e.children.forEach(e=>r(e))};return e.forEach(e=>r(e)),t}createExportGroup(e,t=!0){const r=new THREE.Group;return e.forEach(e=>{const o=e.clone();t&&(e.updateMatrixWorld(!0),o.geometry=o.geometry.clone(),o.geometry.applyMatrix4(e.matrixWorld),o.position.set(0,0,0),o.rotation.set(0,0,0),o.scale.set(1,1,1),o.updateMatrix()),r.add(o)}),r.rotation.x=Math.PI/2,r.updateMatrixWorld(!0),r}downloadFile(e,t){const r=document.createElement("a");r.href=URL.createObjectURL(e),r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)}exportSTL(e,t,r=!1){try{const o=new STLExporter,s=this.collectMeshes(e);if(0===s.length)throw new Error("Нет мешей");const n=this.createExportGroup(s,!0),i=o.parse(n,{binary:!r}),l=new Blob([i],{type:r?"text/plain":"application/octet-stream"});this.downloadFile(l,t+".stl"),this.editor.showStatus(`Экспорт STL завершен (${s.length} мешей)`,"success")}catch(e){console.error("STL export error:",e),this.editor.showStatus("Ошибка экспорта STL","error")}}exportOBJ(e,t,r){try{if(void 0===OBJExporter)throw new Error("OBJExporter не найден");const o=new OBJExporter,s=this.collectMeshes(e);if(0===s.length)throw new Error("Нет мешей");const n=this.createExportGroup(s,!0),i=o.parse(n);let l="# Экспортировано из КонтрБагCAD\n";if(r&&(l+=`mtllib ${t}.mtl\n\n`),l+=i,r){const e=new JSZip;e.file(`${t}.obj`,l),e.file(`${t}.mtl`,this.createMTLContent(s)),e.generateAsync({type:"blob"}).then(e=>this.downloadFile(e,`${t}.zip`)).catch(e=>{console.warn("ZIP creation failed, saving OBJ only",e);const r=new Blob([l],{type:"text/plain"});this.downloadFile(r,t+".obj")})}else{const e=new Blob([l],{type:"text/plain"});this.downloadFile(e,t+".obj")}this.editor.showStatus("Экспорт OBJ завершен","success")}catch(e){console.error("OBJ export error:",e),this.editor.showStatus("Ошибка экспорта OBJ","error")}}createMTLContent(e){return"# Material file for CAD export\nnewmtl default\nKa 0.2 0.2 0.2\nKd 0.8 0.8 0.8\nKs 0.5 0.5 0.5\nNs 32\nd 1.0\nillum 2\n"}exportPLY(e,t,r){try{if(void 0===PLYExporter)throw new Error("PLYExporter не найден");const r=new PLYExporter,o=this.collectMeshes(e);if(0===o.length)throw new Error("Нет мешей");const s=this.createExportGroup(o,!0),n=r.parse(s,{binary:!1}),i=new Blob([n],{type:"text/plain"});this.downloadFile(i,t+".ply"),this.editor.showStatus("Экспорт PLY завершен","success")}catch(e){console.error("PLY export error:",e),this.editor.showStatus("Ошибка экспорта PLY","error")}}exportGLTF(e,t,r){try{if(void 0===GLTFExporter)throw new Error("GLTFExporter не найден");const r=new GLTFExporter,o=this.collectMeshes(e);if(0===o.length)throw new Error("Нет мешей");const s=this.createExportGroup(o,!0);r.parse(s,e=>{const r=JSON.stringify(e,null,2),o=new Blob([r],{type:"application/json"});this.downloadFile(o,t+".gltf"),this.editor.showStatus("Экспорт GLTF завершен","success")},{binary:!1,trs:!0,onlyVisible:!0,includeCustomExtensions:!0})}catch(e){console.error("GLTF export error:",e),this.editor.showStatus("Ошибка экспорта GLTF","error")}}export3MF(e,t){try{const r=this.collectMeshes(e);if(0===r.length)return void this.editor.showStatus("Нет мешей для экспорта","error");const o=[],s=[];let n=0;if(r.forEach(e=>{e.updateMatrixWorld(!0);const t=e.geometry.clone();if(t.applyMatrix4(e.matrixWorld),!t.attributes.position)return;const r=t.attributes.position.array.slice();for(let e=0;e<r.length;e+=3){const t=r[e],o=r[e+1],s=r[e+2];r[e]=t,r[e+1]=-s,r[e+2]=o}let i;if(o.push(...r),t.index)i=Array.from(t.index.array);else{i=[];for(let e=0;e<r.length/3;e++)i.push(e)}i.forEach(e=>s.push(e+n)),n+=r.length/3}),0===o.length)return void this.editor.showStatus("Нет вершин для экспорта","error");const i=this.generate3MFXML(o,s),l=new JSZip;l.file("[Content_Types].xml",this.getContentTypesXml()),l.file("_rels/.rels",this.getRelsXml()),l.file("3D/3dmodel.model",i),l.generateAsync({type:"blob"}).then(e=>this.downloadFile(e,t+".3mf")).catch(e=>{console.error("Ошибка создания 3MF архива:",e),this.editor.showStatus("Ошибка создания 3MF","error")}),this.editor.showStatus("Экспорт 3MF завершен","success")}catch(e){console.error("3MF export error:",e),this.editor.showStatus("Ошибка экспорта 3MF","error")}}generate3MFXML(e,t){let r="";for(let t=0;t<e.length;t+=3)r+=`<vertex x="${e[t].toFixed(6)}" y="${e[t+1].toFixed(6)}" z="${e[t+2].toFixed(6)}" />\n`;let o="";for(let e=0;e<t.length;e+=3)o+=`<triangle v1="${t[e]}" v2="${t[e+1]}" v3="${t[e+2]}" />\n`;return`<?xml version="1.0" encoding="UTF-8"?>\n<model unit="millimeter" xml:lang="en" xmlns="http://schemas.microsoft.com/3dmanufacturing/core/2015/02">\n  <resources>\n    <object id="1" type="model">\n      <mesh>\n        <vertices>\n          ${r}\n        </vertices>\n        <triangles>\n          ${o}\n        </triangles>\n      </mesh>\n    </object>\n  </resources>\n  <build>\n    <item objectid="1" />\n  </build>\n</model>`}getContentTypesXml(){return'<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml" />\n  <Default Extension="model" ContentType="application/vnd.ms-package.3dmanufacturing-3dmodel+xml" />\n</Types>'}getRelsXml(){return'<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Target="/3D/3dmodel.model" Id="rel0" Type="http://schemas.microsoft.com/3dmanufacturing/2013/01/3dmodel" />\n</Relationships>'}}