class StorageManager{constructor(){this.storageKey="cad_projects",this.currentProjectKey="cad_current_project"}saveProject(t,e){const r=this.getProjects(),o=r.findIndex(e=>e.name===t);return o>-1?r[o]=e:r.push(e),localStorage.setItem(this.storageKey,JSON.stringify(r)),localStorage.setItem(this.currentProjectKey,JSON.stringify(e)),!0}getProjects(){try{const t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):[]}catch(t){return console.error("Ошибка при чтении проектов:",t),[]}}getProject(t){return this.getProjects().find(e=>e.name===t)}deleteProject(t){const e=this.getProjects().filter(e=>e.name!==t);return localStorage.setItem(this.storageKey,JSON.stringify(e)),!0}getCurrentProject(){try{const t=localStorage.getItem(this.currentProjectKey);return t?JSON.parse(t):null}catch(t){return console.error("Ошибка при чтении текущего проекта:",t),null}}clearStorage(){localStorage.removeItem(this.storageKey),localStorage.removeItem(this.currentProjectKey)}exportAllProjects(){const t=this.getProjects(),e={metadata:{version:"1.0",type:"cad-projects-backup",exportDate:(new Date).toISOString(),count:t.length},projects:t},r=JSON.stringify(e,null,2),o=new Blob([r],{type:"application/json"}),s=document.createElement("a");s.href=URL.createObjectURL(o),s.download=`cad_projects_backup_${(new Date).toISOString().split("T")[0]}.json`,s.click()}importProjects(t){return new Promise((e,r)=>{const o=new FileReader;o.onload=t=>{try{const r=JSON.parse(t.target.result);if(!r.projects||!Array.isArray(r.projects))throw new Error("Неверный формат файла");const o=this.getProjects(),s=new Set(o.map(t=>t.name));r.projects.forEach(t=>{if(s.has(t.name)){const e=o.findIndex(e=>e.name===t.name);o[e]=t}else o.push(t)}),localStorage.setItem(this.storageKey,JSON.stringify(o)),e({success:!0,imported:r.projects.length,total:o.length})}catch(t){r(new Error("Ошибка при импорте: "+t.message))}},o.onerror=()=>{r(new Error("Ошибка при чтении файла"))},o.readAsText(t)})}getStorageStats(){const t=this.getProjects();let e=0,r=0;return t.forEach(t=>{const o=JSON.stringify(t).length;e+=o,r+=t.scene?.objects?.length||0}),{projectCount:t.length,totalObjects:r,totalSize:e,formattedSize:this.formatBytes(e)}}formatBytes(t){if(0===t)return"0 Bytes";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(2))+" "+["Bytes","KB","MB","GB"][e]}}