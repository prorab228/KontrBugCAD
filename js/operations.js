class BooleanOperations{constructor(e){if(this.editor=e,"undefined"==typeof THREE||"undefined"==typeof THREE_BVH_CSG)return console.error("three-bvh-csg не загружена"),void this.showError("Библиотека three-bvh-csg не загружена");this.OPS=THREE_BVH_CSG,this.evaluator=new THREE_BVH_CSG.Evaluator,console.log("BooleanOperations (three-bvh-csg) инициализирован")}prepareObjectForCSG(e){if(!e||!e.geometry)return console.error("Объект не содержит geometry"),null;const t=e.clone(),r=this.repairGeometry(t.geometry),o=new THREE_BVH_CSG.Brush(r,t.material);return o.position.copy(e.position),o.rotation.copy(e.rotation),o.scale.copy(e.scale),o.updateMatrixWorld(),o}cleanGeometry(e){if(!e)return e;if(void 0===THREE.BufferGeometryUtils)return console.warn("BufferGeometryUtils.mergeVertices не доступен. Геометрия не очищена."),e;let t=e.clone();if(t=THREE.BufferGeometryUtils.mergeVertices(t,.01),console.log(`Сварка: вершин было ${e.attributes.position.count}, стало ${t.attributes.position.count}`),t.index){const e=t.attributes.position,r=t.index.array,o=[],n=new THREE.Vector3,i=new THREE.Vector3,s=new THREE.Vector3;for(let t=0;t<r.length;t+=3){n.fromBufferAttribute(e,r[t]),i.fromBufferAttribute(e,r[t+1]),s.fromBufferAttribute(e,r[t+2]);.5*i.clone().sub(n).cross(s.clone().sub(n)).length()<1e-9||o.push(r[t],r[t+1],r[t+2])}o.length<r.length&&(t.setIndex(o),console.log("Удалено вырожденных треугольников: "+(r.length-o.length)/3))}if(!t.index){const e=t.attributes.position.count;t.setIndex(Array.from({length:e},(e,t)=>t)),console.warn("Геометрия не имела индексов — созданы автоматически")}return t.computeVertexNormals(),t.attributes.uv&&t.deleteAttribute("uv"),t}performOperation(e,t){if(!e||e.length<2)return this.showError("Для операции нужно минимум 2 объекта"),null;const r=e.map(e=>this.prepareObjectForCSG(e)).filter(e=>e);if(r.length<2)return this.showError("Не удалось подготовить объекты для операции"),null;try{let o=r[0];for(let e=1;e<r.length;e++)o=this.evaluator.evaluate(o,r[e],t);const n=this.cleanGeometry(o.geometry);let i;o.geometry=n,e[0]?.material?(i=e[0].material.clone(),i.emissive=new THREE.Color(0),i.emissiveIntensity=0,i.transparent=!1,i.opacity=1,i.side=THREE.FrontSide):i=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide});const s=new THREE.Mesh(o.geometry,i);s.geometry.computeBoundingBox();const a=s.geometry.boundingBox,u=new THREE.Vector3;return a.getCenter(u),s.geometry.translate(-u.x,-u.y,-u.z),s.position.copy(u),s.rotation.set(0,0,0),s.scale.set(1,1,1),s.updateMatrixWorld(),s.castShadow=!0,s.receiveShadow=!0,s.userData={id:"csg_"+Date.now(),name:this.getOperationName(t),type:"boolean",operation:t,sourceObjects:e.map(e=>e.uuid)},s}catch(e){return console.error(`Ошибка операции ${t}:`,e),this.showError(`Ошибка ${this.getOperationName(t)}: ${e.message}`),null}}unionMultiple(e){return this.performOperation(e,this.OPS.ADDITION)}subtract(e,t){return this.performOperation([e,t],this.OPS.SUBTRACTION)}intersect(e,t){return this.performOperation([e,t],this.OPS.INTERSECTION)}canPerformOperation(e){if(!e||e.length<2)return{can:!1,reason:"Нужно минимум 2 объекта"};const t=[];for(const r of e)r.geometry?.attributes?.position||t.push(r.userData?.name||r.uuid);return t.length?{can:!1,reason:`Объекты [${t.join(", ")}] не содержат position`}:{can:!0,reason:""}}repairGeometry(e){const t=e.clone();if(t.attributes.normal||t.computeVertexNormals(),!t.attributes.uv){const e=t.attributes.position,r=new Float32Array(2*e.count);for(let t=0;t<e.count;t++)r[2*t]=.5*(e.getX(t)+1),r[2*t+1]=.5*(e.getY(t)+1);t.setAttribute("uv",new THREE.BufferAttribute(r,2))}return t}getOperationStats(e){if(!e?.geometry)return null;const t=e.geometry,r=t.attributes.position?.count||0,o=t.index?t.index.count/3:r/3;t.computeBoundingBox();const n=t.boundingBox?(new THREE.Vector3).subVectors(t.boundingBox.max,t.boundingBox.min):new THREE.Vector3;return{vertices:r,faces:o,volume:n.x*n.y*n.z,size:n}}getOperationName(e){return{union:"Объединение",subtract:"Вычитание",intersect:"Пересечение"}[e]||e}showError(e){this.editor?.showStatus?.(e,"error")||console.error("Boolean Error:",e)}showWarning(e){this.editor?.showStatus?.(e,"warning")||console.warn("Boolean Warning:",e)}}