import{ParametricExecutor}from"./ParametricExecutor.js";import*as THREE from"three";export class BooleanBaseExecutor extends ParametricExecutor{constructor(e,t){super(e),this.operationType=t}execute(e,t){const r=t.editor.booleanOps,a=new Set(e.inputs);e.parameters&&(e.parameters.baseUuids&&e.parameters.baseUuids.forEach(e=>a.add(e)),e.parameters.subtractUuids&&e.parameters.subtractUuids.forEach(e=>a.add(e)));const o=Array.from(a).map(e=>t.objectMap.get(e)).filter(e=>e);let s;switch(this.operationType){case"union":if(o.length<2)throw new Error("Boolean union: недостаточно объектов");s=r.unionMultiple(o,null,!0);break;case"subtract":{let a=[],u=[];if(e.parameters&&e.parameters.baseUuids&&e.parameters.subtractUuids)a=e.parameters.baseUuids.map(e=>t.objectMap.get(e)).filter(e=>e),u=e.parameters.subtractUuids.map(e=>t.objectMap.get(e)).filter(e=>e);else{if(o.length<2)throw new Error("Boolean subtract: недостаточно объектов");a=[o[0]],u=o.slice(1)}if(0===a.length)throw new Error("Boolean subtract: нет уменьшаемых объектов");if(0===u.length)throw new Error("Boolean subtract: нет вычитаемых объектов");const n=a.length>1,i=r.subtractMultiple(a,u,null,!0,n);if(Array.isArray(i)){const t=[];i.forEach((e,r)=>{e.uuid||(e.uuid=THREE.MathUtils.generateUUID()),t.push(e.uuid),e.userData={...e.userData,type:"boolean",operation:this.operationType}}),e.outputs=t,s=i}else s=i;break}case"intersect":if(o.length<2)throw new Error("Boolean intersect: недостаточно объектов");s=r.intersectMultiple(o,null,!0);break;default:throw new Error(`Неизвестная булева операция: ${this.operationType}`)}!Array.isArray(s)&&s&&(e.outputs.length>0?s.uuid=e.outputs[0]:(s.uuid=THREE.MathUtils.generateUUID(),e.outputs=[s.uuid]),s.userData={...s.userData,type:"boolean",operation:this.operationType});for(const e of o)e&&(t.sceneGroup.remove(e),t.objectMap.delete(e.uuid),e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()));return s}}export class BooleanUnionExecutor extends BooleanBaseExecutor{constructor(e){super(e,"union")}}export class BooleanSubtractExecutor extends BooleanBaseExecutor{constructor(e){super(e,"subtract")}}export class BooleanIntersectExecutor extends BooleanBaseExecutor{constructor(e){super(e,"intersect")}}