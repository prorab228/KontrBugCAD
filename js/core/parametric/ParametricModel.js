import*as THREE from"three";import{ParametricOperation}from"../parametric/ParametricOperation.js";import{CreatePrimitiveExecutor}from"./executors/CreatePrimitiveExecutor.js";import{ImportSTLExecutor}from"./executors/ImportSTLExecutor.js";import{MoveExecutor}from"./executors/MoveExecutor.js";import{RotateExecutor}from"./executors/RotateExecutor.js";import{ScaleExecutor}from"./executors/ScaleExecutor.js";import{DuplicateExecutor}from"./executors/DuplicateExecutor.js";import{ExtrudeExecutor}from"./executors/ExtrudeExecutor.js";import{RevolveExecutor}from"./executors/RevolveExecutor.js";import{BooleanUnionExecutor}from"./executors/BooleanBaseExecutor.js";import{BooleanSubtractExecutor}from"./executors/BooleanBaseExecutor.js";import{BooleanIntersectExecutor}from"./executors/BooleanBaseExecutor.js";import{CreateWorkplaneExecutor}from"./executors/CreateWorkplaneExecutor.js";import{GroupExecutor}from"./executors/GroupExecutor.js";import{UngroupExecutor}from"./executors/UngroupExecutor.js";import{SketchExecutor}from"./executors/SketchExecutor.js";import{MoveMultipleExecutor}from"./executors/MoveMultipleExecutor.js";import{ImportMeshExecutor}from"./executors/ImportMeshExecutor.js";import{DeleteExecutor}from"./executors/DeleteExecutor.js";import{MirrorExecutor}from"./executors/MirrorExecutor.js";import{SplitExecutor}from"./executors/SplitExecutor.js";import{ImageExecutor}from"./executors/ImageExecutor.js";import{Text3DExecutor}from"./executors/Text3DExecutor.js";import{DecimateExecutor}from"./executors/DecimateExecutor.js";import{RepairExecutor}from"./executors/RepairExecutor.js";import{FilletChamferExecutor}from"./executors/FilletChamferExecutor.js";import{ChangeColorExecutor}from"./executors/ChangeColorExecutor.js";import{ChangeOpacityExecutor}from"./executors/ChangeOpacityExecutor.js";import{ChangeVisibilityExecutor}from"./executors/ChangeVisibilityExecutor.js";import{GearExecutor}from"./executors/GearExecutor.js";import{ThreadExecutor}from"./executors/ThreadExecutor.js";import{SketchRegionManager}from"/js/tools/sketch/managers/sketch-region-manager.js";export class ParametricModel{constructor(e){this.editor=e,this.operations=[],this.currentIndex=-1,this.objectMap=new Map,this.sceneGroup=new THREE.Group,this.errors=[],this.executors=new Map,this._registerExecutors(),this.historyChangeCallbacks=[],this.modelRebuiltCallbacks=[]}_registerExecutors(){this.executors.set("create_primitive",new CreatePrimitiveExecutor(this.editor)),this.executors.set("import_stl",new ImportSTLExecutor(this.editor)),this.executors.set("move",new MoveExecutor(this.editor)),this.executors.set("rotate",new RotateExecutor(this.editor)),this.executors.set("scale",new ScaleExecutor(this.editor)),this.executors.set("duplicate",new DuplicateExecutor(this.editor)),this.executors.set("extrude",new ExtrudeExecutor(this.editor)),this.executors.set("revolve",new RevolveExecutor(this.editor)),this.executors.set("boolean_union",new BooleanUnionExecutor(this.editor)),this.executors.set("boolean_subtract",new BooleanSubtractExecutor(this.editor)),this.executors.set("boolean_intersect",new BooleanIntersectExecutor(this.editor)),this.executors.set("create_workplane",new CreateWorkplaneExecutor(this.editor)),this.executors.set("group",new GroupExecutor(this.editor)),this.executors.set("ungroup",new UngroupExecutor(this.editor)),this.executors.set("sketch",new SketchExecutor(this.editor)),this.executors.set("move_multiple",new MoveMultipleExecutor(this.editor)),this.executors.set("import_mesh",new ImportMeshExecutor(this.editor)),this.executors.set("delete",new DeleteExecutor(this.editor)),this.executors.set("mirror",new MirrorExecutor(this.editor)),this.executors.set("split",new SplitExecutor(this.editor)),this.executors.set("image",new ImageExecutor(this.editor)),this.executors.set("text3d",new Text3DExecutor(this.editor)),this.executors.set("decimate",new DecimateExecutor(this.editor)),this.executors.set("repair",new RepairExecutor(this.editor)),this.executors.set("filletChamfer",new FilletChamferExecutor(this.editor)),this.executors.set("change_color",new ChangeColorExecutor(this.editor)),this.executors.set("change_opacity",new ChangeOpacityExecutor(this.editor)),this.executors.set("change_visibility",new ChangeVisibilityExecutor(this.editor)),this.executors.set("gear",new GearExecutor(this.editor)),this.executors.set("thread",new ThreadExecutor(this.editor))}onHistoryChange(e){this.historyChangeCallbacks.push(e)}_triggerHistoryChange(){this.historyChangeCallbacks.forEach(e=>e())}onModelRebuilt(e){this.modelRebuiltCallbacks.push(e)}_triggerModelRebuilt(){this.modelRebuiltCallbacks.forEach(e=>e())}addOperation(e,t=!0){return console.log("addOperation parameters:",e.parameters),t?(this.operations=this.operations.slice(0,this.currentIndex+1),this.operations.push(e),this.currentIndex++,this._rebuildFrom(this.currentIndex)):(this.operations.splice(this.currentIndex+1,0,e),this.currentIndex++,this._clearFrom(this.currentIndex+1),this._executeOperation(this.currentIndex),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()),this._triggerHistoryChange(),e.outputs}insertOperation(e,t){return!(e<0||e>this.operations.length)&&(this.operations.splice(e,0,t),e<=this.currentIndex&&this.currentIndex++,this._rebuildRange(e,this.currentIndex),this._triggerHistoryChange(),!0)}removeOperation(e){if(e<0||e>=this.operations.length)return!1;for(const t of this.operations[e].outputs){const e=this.objectMap.get(t);e&&(this.sceneGroup.remove(e),this._disposeObject(e),this.objectMap.delete(t))}return this.operations.splice(e,1),e<this.currentIndex?this.currentIndex--:e===this.currentIndex&&(this.currentIndex=Math.max(-1,this.currentIndex-1)),e<this.operations.length?this._rebuildFrom(e):(this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()),this._triggerHistoryChange(),!0}_rebuild(){this.errors=[],this._clearScene(),this.objectMap.clear();for(let e=0;e<=this.currentIndex;e++)this._executeOperation(e);this._updateSceneGroup(),this._updateUI(),this._triggerModelRebuilt(),this._updateAllSketchRegions()}_rebuildFrom(e){if(!(e<0||e>=this.operations.length)){this.errors=[];for(let t=e;t<this.operations.length;t++)this._clearOperationOutputs(t);for(let t=e;t<this.operations.length;t++)this._executeOperation(t);this._updateUI(),this._triggerModelRebuilt(),this._updateAllSketchRegions()}}_rebuildRange(e,t){if(!(e<0||t>=this.operations.length||e>t)){this.errors=[];for(let r=e;r<=t;r++)this._clearOperationOutputs(r);for(let r=e;r<=t;r++)this._executeOperation(r);this._updateUI(),this._triggerModelRebuilt(),this._updateAllSketchRegions()}}_clearOperationOutputs(e){const t=this.operations[e];for(const e of t.outputs){const t=this.objectMap.get(e);t&&(this.sceneGroup.remove(t),this.objectMap.delete(e),this._disposeObject(t))}t.outputs=[]}_executeOperation(e){const t=this.operations[e],r=this.executors.get(t.type);if(!r){const r=`Нет исполнителя для типа операции: ${t.type}`;return console.error(r),this.errors.push({index:e,operationId:t.id,message:r,stack:""}),!1}try{const e=r.execute(t,this);if(e){const t=Array.isArray(e)?e:[e];for(const e of t)this.sceneGroup.add(e),this.objectMap.set(e.uuid,e)}return!0}catch(r){return console.error(`Ошибка выполнения операции ${t.type} (id: ${t.id}):`,r),this.errors.push({index:e,operationId:t.id,message:r.message,stack:r.stack}),!1}}_clearScene(){for(;this.sceneGroup.children.length;){const e=this.sceneGroup.children[0];this.sceneGroup.remove(e),this._disposeObject(e)}}_clearFrom(e){for(let t=e;t<this.operations.length;t++)this._clearOperationOutputs(t)}_updateSceneGroup(){this.editor.objectsGroup&&this.editor.scene.remove(this.editor.objectsGroup),this.editor.objectsGroup=this.sceneGroup,this.editor.scene.add(this.sceneGroup)}_updateUI(){this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}_disposeObject(e){e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}undo(){return!(this.currentIndex<0)&&(this.currentIndex--,this._rebuild(),this._triggerHistoryChange(),!0)}redo(){return!(this.currentIndex>=this.operations.length-1)&&(this.currentIndex++,this._rebuild(),this._triggerHistoryChange(),!0)}jumpTo(e){return!(e<0||e>=this.operations.length)&&(this.currentIndex=e,this._rebuild(),this._triggerHistoryChange(),!0)}clear(){this.operations=[],this.currentIndex=-1,this.errors=[],this._rebuild(),this._triggerHistoryChange()}deleteObjects(e){if(!e||0===e.length)return!1;const t=new ParametricOperation("delete",{targets:e},[]);return this.addOperation(t),!0}serialize(){return this.operations.map(e=>e.serialize())}deserialize(e){this.operations=e.map(e=>ParametricOperation.deserialize(e)),this.currentIndex=this.operations.length-1,this.errors=[],this._rebuild(),this._triggerHistoryChange()}_updateAllSketchRegions(){for(const e of this.objectMap.values())if(e.userData&&"sketch_plane"===e.userData.type){e.children.some(e=>e.userData&&"sketch_element"===e.userData.type)?(e.userData.regionManager||(e.userData.regionManager=new SketchRegionManager(this.editor,e)),e.userData.regionManager.updateRegions()):e.userData.regionManager&&(e.userData.regionManager.clear(),delete e.userData.regionManager)}}}