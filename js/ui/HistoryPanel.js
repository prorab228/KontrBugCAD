class HistoryPanel{constructor(e){this.editor=e,this.container=document.getElementById("historyList"),this.clearButton=document.getElementById("clearHistory"),this.init()}init(){this.clearButton&&this.clearButton.addEventListener("click",()=>{confirm("Очистить историю? Это действие нельзя отменить.")&&this.editor.parametricModel.clear()})}update(){if(!this.container)return;const e=this.editor.parametricModel.operations,t=this.editor.parametricModel.currentIndex,a=this.editor.parametricModel.errors||[];this.container.innerHTML="",e.forEach((e,i)=>{const s=a.find(t=>t.operationId===e.id),r=this.createHistoryItem(e,i,i===t,s);this.container.appendChild(r)}),t>=0&&this.container.children[t]&&this.container.children[t].scrollIntoView({behavior:"smooth",block:"nearest"})}createHistoryItem(e,t,a,i){const s=document.createElement("div");s.className="history-item",a&&s.classList.add("active"),i&&(s.classList.add("error"),s.title=`Ошибка: ${i.message}`),s.dataset.index=t;const{icon:r,text:o,color:n}=this.getOperationInfo(e);let c="";if(e.timestamp){c=new Date(e.timestamp).toLocaleTimeString()}s.innerHTML=`\n            <div class="history-item-icon" style="color: ${n};">\n                <i class="${r}"></i>\n            </div>\n            <div class="history-item-content">\n                <div class="history-item-title">${o}</div>\n                <div class="history-item-time">${c}</div>\n            </div>\n            <div class="history-item-actions">\n                ${i?'<span class="history-item-error-icon" title="Операция завершилась ошибкой"><i class="fas fa-exclamation-triangle"></i></span>':""}\n                <button class="history-item-delete" title="Удалить операцию">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </div>\n        `,s.addEventListener("click",e=>{e.target.closest(".history-item-actions")||this.editor.parametricModel.jumpTo(t)});return s.querySelector(".history-item-delete").addEventListener("click",e=>{e.stopPropagation(),confirm("Удалить эту операцию? Это действие нельзя отменить.")&&this.editor.parametricModel.removeOperation(t)}),s}getOperationInfo(e){const t=e.type,a=e.parameters;let i="fas fa-cube",s="#757575",r=t;switch(t){case"create_primitive":i="fas fa-cube",s="#4CAF50",r=`Создание примитива: ${a.type||"объект"}`;break;case"import_stl":i="fas fa-file-import",s="#FF9800",r=`Импорт STL: ${a.filePath?a.filePath.split("/").pop():"модель"}`;break;case"move":i="fas fa-arrows-alt",s="#9C27B0",r="Перемещение";break;case"extrude":i="fas fa-arrows-alt-v",s="#00BCD4",r=`Выдавливание: ${a.distance||0} мм`;break;case"boolean_union":i="fas fa-plus-circle",s="#2196F3",r=`Объединение (${e.inputs.length} объектов)`;break;case"boolean_subtract":i="fas fa-minus-circle",s="#F44336",r="Вычитание";break;case"boolean_intersect":i="fas fa-times-circle",s="#FF9800",r="Пересечение";break;case"group":i="fas fa-object-group",s="#8BC34A",r=`Группировка (${a.childIds?a.childIds.length:0} объектов)`;break;case"ungroup":i="fas fa-object-ungroup",s="#FF5722",r="Разгруппировка";break;case"create_workplane":i="fas fa-square",s="#607D8B",r="Создание рабочей плоскости";break;case"sketch":i="fas fa-drafting-compass",s="#FFC107",r=`Скетч (${a.elements?a.elements.length:0} элементов)`;break;case"import_mesh":i="fas fa-cube",s="#9E9E9E",r="Импорт объекта";break;case"delete":i="fas fa-trash",s="#F44336",r=`Удаление объектов (${a.targets?a.targets.length:0})`}return{icon:i,text:r,color:s}}}