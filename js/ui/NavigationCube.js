import*as THREE from"three";export class NavigationCube{constructor(e,t){this.cameraManager=e,this.themeManager=t,this.size=140,this.lastProjectionType=null,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.top="20px",this.container.style.left="20px",this.container.style.width=this.size+"px",this.container.style.zIndex="100",this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.alignItems="center",this.container.style.gap="8px",this.face_letters=["Право","Лево","Верх","Низ","Зад","Перед"],this.initRenderer(),this.initScene(),this.initCamera(),this.initCube(),this.initEvents(),this.initLights(),this.container.appendChild(this.renderer.domElement),document.getElementById("viewport").appendChild(this.container),this.createControls(),this.cameraManager.onChange(()=>this.update()),this.themeManager&&this.themeManager.onChange(()=>this.updateTheme())}initRenderer(){this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.outputColorSpace=THREE.SRGBColorSpace,this.renderer.toneMapping=THREE.CineonToneMapping,this.renderer.toneMappingExposure=1.5,this.renderer.setSize(this.size,this.size),this.renderer.setClearColor(0,0),this.renderer.setPixelRatio(window.devicePixelRatio)}initScene(){this.scene=new THREE.Scene}initCamera(){this.camera=new THREE.PerspectiveCamera(30,1,.1,10),this.camera.position.set(2.5,2,3),this.camera.lookAt(0,0,0),this.scene.add(this.camera)}initLights(){const e=new THREE.AmbientLight(16777215,2.5);this.scene.add(e)}getBackgroundColor(){return this.themeManager.isDark()?"#222222":"#CCCCCC"}getEdgeColor(){return this.themeManager.isDark()?"#aaaaaa":"#666666"}getLetterColor(e){return"x"===e?"#ff2222":"y"===e?"#22ff22":"z"===e?"#2222ff":"#ffffff"}createFaceTexture(e,t){const i=document.createElement("canvas");i.width=128,i.height=128;const r=i.getContext("2d"),s=this.getBackgroundColor(),n=this.getLetterColor(t);r.fillStyle=s,r.fillRect(0,0,i.width,i.height),r.font='Bold 30px "Segoe UI", "Arial", sans-serif',r.fillStyle=n,r.textAlign="center",r.textBaseline="middle",r.fillText(e,i.width/2,i.height/2),r.strokeStyle="#000000",r.lineWidth=2,r.strokeRect(1,1,i.width-2,i.height-2);const o=new THREE.CanvasTexture(i);return o.needsUpdate=!0,o}createOctagonGeometry(e=.2){const t=[new THREE.Vector2(.5-e,.5),new THREE.Vector2(.5,.5-e),new THREE.Vector2(.5,-.5+e),new THREE.Vector2(.5-e,-.5),new THREE.Vector2(-.5+e,-.5),new THREE.Vector2(-.5,-.5+e),new THREE.Vector2(-.5,.5-e),new THREE.Vector2(-.5+e,.5)],i=new THREE.Vector2(0,0),r=[],s=[],n=[];r.push(i.x,i.y,0),s.push(.5,.5);for(let e=0;e<t.length;e++){const i=t[e];r.push(i.x,i.y,0),s.push(i.x+.5,i.y+.5)}for(let e=0;e<t.length;e++){const i=(e+1)%t.length;n.push(0,e+1,i+1)}const o=new THREE.BufferGeometry;return o.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),o.setAttribute("uv",new THREE.Float32BufferAttribute(s,2)),o.setIndex(n),o.computeVertexNormals(),o}initCube(){this.cubeGroup&&this.scene.remove(this.cubeGroup),this.cubeGroup=new THREE.Group;const e=.3;[{dir:"+x",axis:"x",letter:this.face_letters[0],pos:[.5,0,0],rot:[0,Math.PI/2,0]},{dir:"-x",axis:"x",letter:this.face_letters[1],pos:[-.5,0,0],rot:[0,-Math.PI/2,0]},{dir:"+y",axis:"y",letter:this.face_letters[2],pos:[0,.5,0],rot:[-Math.PI/2,0,0]},{dir:"-y",axis:"y",letter:this.face_letters[3],pos:[0,-.5,0],rot:[Math.PI/2,0,0]},{dir:"+z",axis:"z",letter:this.face_letters[4],pos:[0,0,.5],rot:[0,0,0]},{dir:"-z",axis:"z",letter:this.face_letters[5],pos:[0,0,-.5],rot:[0,Math.PI,0]}].forEach(t=>{const i=this.createFaceTexture(t.letter,t.axis);i.colorSpace=THREE.SRGBColorSpace;const r=new THREE.MeshPhongMaterial({map:i,side:THREE.DoubleSide,emissive:2236962,transparent:!0,opacity:.95}),s=this.createOctagonGeometry(e),n=new THREE.Mesh(s,r);n.position.set(t.pos[0],t.pos[1],t.pos[2]),n.rotation.set(t.rot[0],t.rot[1],t.rot[2]),n.userData.direction=t.dir,n.userData.material=r,this.cubeGroup.add(n)});const t=new THREE.MeshPhongMaterial({color:this.getBackgroundColor(),emissive:2236962,side:THREE.DoubleSide,transparent:!0,opacity:.95}),i=new THREE.LineBasicMaterial({color:2236962});[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].forEach(r=>{const[s,n,o]=r,a=new THREE.Vector3(.5*s,.5*n,.5*o),c=a.clone().add(new THREE.Vector3(-s*e,0,0)),h=a.clone().add(new THREE.Vector3(0,-n*e,0)),l=a.clone().add(new THREE.Vector3(0,0,-o*e)),d=new THREE.BufferGeometry,m=new Float32Array([c.x,c.y,c.z,h.x,h.y,h.z,l.x,l.y,l.z]);d.setAttribute("position",new THREE.BufferAttribute(m,3)),d.setIndex([0,1,2]),d.computeVertexNormals();const p=new THREE.Mesh(d,t.clone());p.userData.direction="corner",p.userData.sign=r,p.userData.material=p.material,this.cubeGroup.add(p);const u=(new THREE.BufferGeometry).setFromPoints([c,h,l,c]),E=new THREE.Line(u,i);E.userData.isEdge=!0,this.cubeGroup.add(E)}),this.scene.add(this.cubeGroup)}createControls(){this.controlsDiv=document.createElement("div"),this.controlsDiv.style.display="flex",this.controlsDiv.style.justifyContent="center",this.controlsDiv.style.gap="8px",this.controlsDiv.style.marginTop="4px",this.homeBtn=document.createElement("button"),this.homeBtn.className="view-btn-compact home-btn",this.homeBtn.id="navCubeHome",this.homeBtn.title="Домой",this.homeBtn.innerHTML='<i class="fas fa-home"></i>',this.homeBtn.addEventListener("click",e=>{e.stopPropagation(),this.cameraManager.setView("home")}),this.projBtn=document.createElement("button"),this.projBtn.className="view-btn-compact",this.projBtn.id="navCubeProj",this.projBtn.title="Переключить проекцию (перспектива/ортогональ)",this.projBtn.innerHTML='<i class="fas fa-cube"></i>',this.projBtn.addEventListener("click",e=>{e.stopPropagation(),this.cameraManager.toggleProjection()}),this.controlsDiv.appendChild(this.homeBtn),this.controlsDiv.appendChild(this.projBtn),this.container.appendChild(this.controlsDiv)}initEvents(){this.renderer.domElement.addEventListener("mousedown",e=>this.onMouseDown(e)),this.renderer.domElement.addEventListener("mousemove",e=>this.onMouseMove(e)),this.renderer.domElement.addEventListener("mouseleave",()=>this.resetHighlight())}resetHighlight(){this.cubeGroup.children.forEach(e=>{e.isMesh&&e.material&&e.material.emissive&&e.material.emissive.setHex(2236962)})}onMouseMove(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),r=new THREE.Raycaster;r.setFromCamera(i,this.camera);const s=this.cubeGroup.children.filter(e=>e.isMesh),n=r.intersectObjects(s);if(this.resetHighlight(),n.length>0){const e=n[0].object;e.isMesh&&e.material&&e.material.emissive&&e.material.emissive.setHex(51283),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onMouseDown(e){e.stopPropagation();const t=this.renderer.domElement.getBoundingClientRect(),i=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),r=new THREE.Raycaster;r.setFromCamera(i,this.camera);const s=this.cubeGroup.children.filter(e=>e.isMesh),n=r.intersectObjects(s);if(n.length>0){const e=n[0].object,t=e.userData.direction,i=e.userData.sign;this.handleFaceClick(t,i)}}handleFaceClick(e,t){if("corner"===e&&t)return void this.cameraManager.setCornerView(t[0],t[1],t[2]);const i={"+x":"right","-x":"left","+y":"top","-y":"bottom","+z":"back","-z":"front"}[e];i&&this.cameraManager.setView(i)}update(){if(!this.cameraManager.camera)return;const e=this.cameraManager.camera,t=this.cameraManager.controls.target,i=(new THREE.Vector3).subVectors(e.position,t).normalize();this.camera.position.copy(i.multiplyScalar(3.5)),this.camera.up.copy(e.up),this.camera.lookAt(0,0,0),this.camera.updateProjectionMatrix();const r=this.cameraManager.getProjectionType();r!==this.lastProjectionType&&(this.lastProjectionType=r,this.projBtn.innerHTML="perspective"===r?'<i class="fas fa-cube"></i>':'<i class="fas fa-vector-square"></i>')}updateTheme(){this.initCube()}setLetters(e){this.face_letters=e,this.initCube()}render(){this.renderer.render(this.scene,this.camera)}dispose(){this.renderer.dispose(),this.scene.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()),e.texture&&e.texture.dispose()}),this.container.remove()}}