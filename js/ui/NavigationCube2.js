class NavigationCube{constructor(e,t){this.cameraManager=e,this.themeManager=t,this.size=150,this.container=document.createElement("div"),this.container.style.position="absolute",this.container.style.top="20px",this.container.style.left="20px",this.container.style.width=this.size+"px",this.container.style.zIndex="100",this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.alignItems="center",this.container.style.gap="8px",this.initRenderer(),this.initScene(),this.initCamera(),this.initCube(),this.initEvents(),this.initLights(),this.createControls(),this.container.appendChild(this.renderer.domElement),document.getElementById("viewport").appendChild(this.container),this.cameraManager.onChange(()=>this.update()),this.themeManager&&this.themeManager.onChange(()=>this.updateTheme())}initRenderer(){this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.size,this.size),this.renderer.setClearColor(0,0),this.renderer.setPixelRatio(window.devicePixelRatio)}initScene(){this.scene=new THREE.Scene}initCamera(){this.camera=new THREE.PerspectiveCamera(30,1,.1,10),this.camera.position.set(2.5,2,3),this.camera.lookAt(0,0,0),this.scene.add(this.camera)}initLights(){const e=new THREE.AmbientLight(16777215,.6);this.scene.add(e);const t=new THREE.DirectionalLight(16777215,1);t.position.set(1,2,1),this.scene.add(t)}getBackgroundColor(){return this.themeManager.isDark()?"#222222":"#DDDDDD"}getEdgeColor(){return this.themeManager.isDark()?"#aaaaaa":"#666666"}getLetterColor(e){return"x"===e?"#ff2222":"y"===e?"#22ff22":"z"===e?"#2222ff":"#ffffff"}createFaceTexture(e,t){const i=document.createElement("canvas");i.width=128,i.height=128;const s=i.getContext("2d"),r=this.getBackgroundColor(),n=this.getLetterColor(t);s.fillStyle=r,s.fillRect(0,0,i.width,i.height),s.font='Bold 30px "Segoe UI", "Arial", sans-serif',s.fillStyle=n,s.textAlign="center",s.textBaseline="middle",s.fillText(e,i.width/2,i.height/2),s.strokeStyle="#000000",s.lineWidth=2,s.strokeRect(1,1,i.width-2,i.height-2);const a=new THREE.CanvasTexture(i);return a.needsUpdate=!0,a}initCube(){this.cubeGroup&&this.scene.remove(this.cubeGroup),this.cubeGroup=new THREE.Group;const e=[{dir:"+x",letter:"Right",axis:"x",pos:[.5,0,0],rot:[0,Math.PI/2,0]},{dir:"-x",letter:"Left",axis:"x",pos:[-.5,0,0],rot:[0,-Math.PI/2,0]},{dir:"+y",letter:"Top",axis:"y",pos:[0,.5,0],rot:[-Math.PI/2,0,0]},{dir:"-y",letter:"Bottom",axis:"y",pos:[0,-.5,0],rot:[Math.PI/2,0,0]},{dir:"+z",letter:"Back",axis:"z",pos:[0,0,.5],rot:[0,0,0]},{dir:"-z",letter:"Front",axis:"z",pos:[0,0,-.5],rot:[0,Math.PI,0]}];e.forEach(e=>{const t=this.createFaceTexture(e.letter,e.axis),i=new THREE.MeshPhongMaterial({map:t,transparent:!0,opacity:.95,emissive:2236962,side:THREE.DoubleSide}),s=new THREE.BoxGeometry(1,1,.01),r=new THREE.Mesh(s,i);r.position.set(e.pos[0],e.pos[1],e.pos[2]),r.rotation.set(e.rot[0],e.rot[1],e.rot[2]),r.userData.direction=e.dir,r.userData.material=i,this.cubeGroup.add(r)});const t=new THREE.MeshPhongMaterial({color:8947848,emissive:2236962,side:THREE.DoubleSide});[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].forEach(e=>{const[i,s,r]=e,n=new THREE.Vector3(.5*i,.5*s,.5*r),a=n.clone().add(new THREE.Vector3(.2*-i,0,0)),o=n.clone().add(new THREE.Vector3(0,.2*-s,0)),h=n.clone().add(new THREE.Vector3(0,0,.2*-r)),c=new THREE.BufferGeometry,l=new Float32Array([a.x,a.y,a.z,o.x,o.y,o.z,h.x,h.y,h.z]);c.setAttribute("position",new THREE.BufferAttribute(l,3)),c.setIndex([0,1,2]),c.computeVertexNormals();const d=new THREE.Mesh(c,t.clone());d.userData.direction="corner",d.userData.sign=e,d.userData.material=d.material,this.cubeGroup.add(d)}),this.scene.add(this.cubeGroup)}createControls(){this.controlsDiv=document.createElement("div"),this.controlsDiv.style.display="flex",this.controlsDiv.style.justifyContent="center",this.controlsDiv.style.gap="8px",this.controlsDiv.style.marginTop="4px",this.homeBtn=document.createElement("button"),this.homeBtn.className="view-btn-compact home-btn",this.homeBtn.id="navCubeHome",this.homeBtn.title="Изометрический вид (домой)",this.homeBtn.innerHTML='<i class="fas fa-home"></i>',this.homeBtn.addEventListener("click",e=>{e.stopPropagation(),this.cameraManager.setView("home")}),this.projBtn=document.createElement("button"),this.projBtn.className="view-btn-compact",this.projBtn.id="navCubeProj",this.projBtn.title="Переключить проекцию (перспектива/ортогональ)",this.projBtn.innerHTML='<i class="fas fa-cube"></i>',this.projBtn.addEventListener("click",e=>{e.stopPropagation(),this.cameraManager.toggleProjection()}),this.controlsDiv.appendChild(this.homeBtn),this.controlsDiv.appendChild(this.projBtn),this.container.appendChild(this.controlsDiv)}initEvents(){this.renderer.domElement.addEventListener("mousedown",e=>this.onMouseDown(e)),this.renderer.domElement.addEventListener("mousemove",e=>this.onMouseMove(e)),this.renderer.domElement.addEventListener("mouseleave",()=>this.resetHighlight())}resetHighlight(){this.cubeGroup.children.forEach(e=>{e.isMesh&&e.material&&e.material.emissive&&e.material.emissive.setHex(2236962)})}onMouseMove(e){const t=this.renderer.domElement.getBoundingClientRect(),i=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),s=new THREE.Raycaster;s.setFromCamera(i,this.camera);const r=this.cubeGroup.children.filter(e=>e.isMesh),n=s.intersectObjects(r);if(this.resetHighlight(),n.length>0){const e=n[0].object;e.isMesh&&e.material&&e.material.emissive&&e.material.emissive.setHex(6710886),this.renderer.domElement.style.cursor="pointer"}else this.renderer.domElement.style.cursor="default"}onMouseDown(e){e.stopPropagation();const t=this.renderer.domElement.getBoundingClientRect(),i=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),s=new THREE.Raycaster;s.setFromCamera(i,this.camera);const r=this.cubeGroup.children.filter(e=>e.isMesh),n=s.intersectObjects(r);if(n.length>0){const e=n[0].object,t=e.userData.direction,i=e.userData.sign;this.handleFaceClick(t,i)}}handleFaceClick(e,t){if("corner"===e&&t){const[e,i,s]=t;return void this.cameraManager.setCornerView(e,i,s)}const i={"+x":"right","-x":"left","+y":"top","-y":"bottom","+z":"back","-z":"front"}[e];i&&this.cameraManager.setView(i)}update(){if(!this.cameraManager.camera)return;const e=this.cameraManager.camera,t=this.cameraManager.controls.target,i=(new THREE.Vector3).subVectors(e.position,t).normalize();this.camera.position.copy(i.multiplyScalar(3.5)),this.camera.up.copy(e.up),this.camera.lookAt(0,0,0),this.camera.updateProjectionMatrix();const s=this.cameraManager.getProjectionType();this.projBtn.innerHTML="perspective"===s?'<i class="fas fa-cube"></i>':'<i class="fas fa-vector-square"></i>'}updateTheme(){this.initCube()}render(){this.renderer.render(this.scene,this.camera)}dispose(){this.renderer.dispose(),this.scene.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose()),e.texture&&e.texture.dispose()}),this.container.remove()}}