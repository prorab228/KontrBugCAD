class LibraryManager{constructor(e){this.editor=e,this.libraryItems=[],this.draggingItem=null,this.dragPreview=null,this.lastMousePosition=new THREE.Vector2,this.defaultSize=25,this.initLibraryItems(),this.initLibraryUI(),this.initDragAndDrop()}initLibraryItems(){this.libraryItems=[{id:"cube",name:"Куб",type:"primitive",category:"basic",iconPath:"icons/cube.png",createFunction:e=>this.createPrimitive("cube",e)},{id:"sphere",name:"Сфера",type:"primitive",category:"basic",iconPath:"icons/sphere.png",createFunction:e=>this.createPrimitive("sphere",e)},{id:"cylinder",name:"Цилиндр",type:"primitive",category:"basic",iconPath:"icons/cylinder.png",createFunction:e=>this.createPrimitive("cylinder",e)},{id:"cone",name:"Конус",type:"primitive",category:"basic",iconPath:"icons/cone.png",createFunction:e=>this.createPrimitive("cone",e)},{id:"torus",name:"Тор",type:"primitive",category:"basic",iconPath:"icons/torus.png",createFunction:e=>this.createPrimitive("torus",e)},{id:"plane",name:"Плоскость",type:"primitive",category:"basic",iconPath:"icons/plane.png",createFunction:e=>this.createPrimitive("plane",e)},{id:"pyramid",name:"Пирамида",type:"primitive",category:"shapes",iconPath:"icons/pyramid.png",createFunction:e=>this.createPrimitive("pyramid",e)},{id:"tube",name:"Труба",type:"primitive",category:"shapes",iconPath:"icons/tube.png",createFunction:e=>this.createPrimitive("tube",e)},{id:"bob",name:"Боб",type:"stl_model",category:"mechanical",iconPath:"icons/bob.png",modelPath:"models/bob.stl",createFunction:e=>this.loadSTLModel("models/bob.stl","Боб",e)},{id:"zero",name:"КонтрБаг ZERO",type:"components",category:"KontrBugTech",iconPath:"icons/zero.png",modelPath:"models/zero.stl",createFunction:e=>this.loadSTLModel("models/zero.stl","zero",e)},{id:"nano1",name:"Нано",type:"components",category:"components",iconPath:"icons/nano1.png",modelPath:"models/nano1.stl",createFunction:e=>this.loadSTLModel("models/nano1.stl","Нано",e)},{id:"nano2",name:"Нано",type:"components",category:"components",iconPath:"icons/nano2.png",modelPath:"models/nano2.stl",createFunction:e=>this.loadSTLModel("models/nano2.stl","Нано",e)},{id:"uno",name:"Uno",type:"components",category:"components",iconPath:"icons/uno.png",modelPath:"models/uno.stl",createFunction:e=>this.loadSTLModel("models/uno.stl","Uno",e)}]}initLibraryUI(){this.renderLibraryGrid(),this.initSearch(),this.initFilters()}renderLibraryGrid(e="all"){const t=document.getElementById("libraryGrid");if(!t)return;t.innerHTML="";const r="all"===e?this.libraryItems:this.libraryItems.filter(t=>t.type===e);console.log(`Filter: ${e}, Filtered items: ${r.length}`),r.forEach(e=>{const r=this.createLibraryElement(e);t.appendChild(r)})}createLibraryElement(e){const t=document.createElement("div");t.className="library-item",t.draggable=!0,t.dataset.itemId=e.id,t.dataset.itemType=e.type;let r="cube";return"stl_model"===e.type?r="download":"basic"===e.category?r="cube":"shapes"===e.category&&(r="shapes"),t.innerHTML=`\n            <div class="library-item-icon">\n                ${e.iconPath?`<img src="${e.iconPath}" alt="${e.name}" class="library-item-img" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-${r}\\'></i>';">`:`<i class="fas fa-${r}"></i>`}\n            </div>\n            <div class="library-item-info">\n                <div class="library-item-name">${e.name}</div>\n                <div class="library-item-category">${this.getCategoryName(e.category)}</div>\n            </div>\n            <div class="library-item-badge">\n                <i class="fas fa-${"stl_model"===e.type?"download":"cube"}"></i>\n            </div>\n        `,t.addEventListener("dragstart",t=>this.onDragStart(t,e)),t.addEventListener("dragend",e=>this.onDragEnd(e)),t.addEventListener("click",()=>this.onItemClick(e)),t}getCategoryName(e){return{basic:"Базовые",shapes:"Формы",mechanical:"Механика",components:"Электронные компоненты",KontrBugTech:"КонтрБагТех",fasteners:"Крепеж"}[e]||e}initSearch(){const e=document.getElementById("librarySearch");e&&e.addEventListener("input",e=>{const t=e.target.value.toLowerCase();this.filterLibrary(t)})}initFilters(){document.querySelectorAll(".filter-btn").forEach(e=>{e.addEventListener("click",e=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active");const t=e.target.dataset.filter;console.log(`Applying filter: ${t}`),this.renderLibraryGrid(t)})})}filterLibrary(e){document.getElementById("libraryGrid");document.querySelectorAll(".library-item").forEach(t=>{const r=t.querySelector(".library-item-name").textContent.toLowerCase(),i=t.querySelector(".library-item-category").textContent.toLowerCase();r.includes(e)||i.includes(e)?t.style.display="flex":t.style.display="none"})}initDragAndDrop(){const e=document.getElementById("viewport");e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",this.lastMousePosition.set(e.clientX,e.clientY),this.dragPreview&&this.draggingItem&&this.updateDragPreview()}),e.addEventListener("drop",e=>{if(e.preventDefault(),!this.draggingItem)return;const t=this.getDropPosition(e);t&&this.createFromLibrary(this.draggingItem,t),this.clearDragPreview(),this.draggingItem=null}),e.addEventListener("dragleave",()=>{this.clearDragPreview()})}onDragStart(e,t){this.draggingItem=t,e.dataTransfer.setData("text/plain",t.id),e.dataTransfer.effectAllowed="copy",e.target.classList.add("dragging"),this.createDragPreview(t)}onDragEnd(e){e.target.classList.remove("dragging"),this.clearDragPreview(),this.draggingItem=null}onItemClick(e){const t=this.getCenterViewPosition();this.createFromLibrary(e,t)}createDragPreview(e){let t;this.dragPreview&&this.editor.scene.remove(this.dragPreview);const r=this.defaultSize;if("stl_model"===e.type)t=new THREE.BoxGeometry(r,r,r);else switch(e.id){case"cube":default:t=new THREE.BoxGeometry(r,r,r);break;case"sphere":t=new THREE.SphereGeometry(r/2,16,16);break;case"cylinder":t=new THREE.CylinderGeometry(r/2,r/2,r,16);break;case"cone":t=new THREE.ConeGeometry(r/2,r,16);break;case"torus":t=new THREE.TorusGeometry(r/1.66,r/5,8,16);break;case"plane":t=new THREE.PlaneGeometry(r,r);break;case"pyramid":t=new THREE.ConeGeometry(r/2,r,4);break;case"wedge":t=this.createWedgeGeometry(r,r,r);break;case"tube":t=new THREE.CylinderGeometry(r/2,r/2,r,16,1,!0)}const i=new THREE.MeshPhongMaterial({color:"stl_model"===e.type?9159498:2201331,transparent:!0,opacity:.6,side:THREE.DoubleSide,wireframe:!1});this.dragPreview=new THREE.Mesh(t,i),this.dragPreview.visible=!1,this.editor.scene.add(this.dragPreview)}updateDragPreview(){if(!this.dragPreview||!this.draggingItem)return;const e=new MouseEvent("mousemove",{clientX:this.lastMousePosition.x,clientY:this.lastMousePosition.y}),t=this.getDropPosition(e);t&&(this.dragPreview.position.copy(t),this.dragPreview.visible=!0,"plane"===this.draggingItem.id?this.dragPreview.rotation.x=-Math.PI/2:this.dragPreview.rotation.set(0,0,0))}getDropPosition(e){const t=this.editor.renderer.domElement.getBoundingClientRect(),r=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),i=new THREE.Raycaster;i.setFromCamera(r,this.editor.camera);const o=new THREE.Plane(new THREE.Vector3(0,1,0),0),a=new THREE.Vector3;return i.ray.intersectPlane(o,a)?(this.draggingItem&&"plane"===this.draggingItem.id||(a.y+=this.defaultSize/2),a):null}getCenterViewPosition(){const e=new THREE.Vector2(0,0),t=new THREE.Raycaster;t.setFromCamera(e,this.editor.camera);const r=new THREE.Plane(new THREE.Vector3(0,1,0),0),i=new THREE.Vector3;if(t.ray.intersectPlane(r,i))return i.y+=this.defaultSize/2,i;const o=new THREE.Vector3(0,0,-1);o.applyQuaternion(this.editor.camera.quaternion);const a=this.editor.camera.position.clone().add(o.multiplyScalar(100)),n=-a.y/o.y;return a.clone().add(o.multiplyScalar(n))}clearDragPreview(){this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null)}createFromLibrary(e,t){e.createFunction&&(e.createFunction(t),this.editor.showStatus(`Создан: ${e.name}`,"success"))}safeCloneParameters(e){const t={};for(const r in e){const i=e[r];i&&i.isVector3?t[r]=i.toArray():i&&i.isEuler?t[r]=[i.x,i.y,i.z]:i&&i.isColor?t[r]=i.getHex():"function"!=typeof i&&(t[r]=i)}return t}createPrimitive(e,t){let r;const i=this.defaultSize;switch(e){case"cube":default:r=new THREE.BoxGeometry(i,i,i);break;case"sphere":r=new THREE.SphereGeometry(i/2,32,32);break;case"cylinder":r=new THREE.CylinderGeometry(i/2,i/2,i,32);break;case"cone":r=new THREE.ConeGeometry(i/2,i,32);break;case"torus":r=new THREE.TorusGeometry(i/1.66,i/5,16,100);break;case"plane":r=new THREE.PlaneGeometry(i,i);break;case"pyramid":r=new THREE.ConeGeometry(i/2,i,4);break;case"wedge":r=this.createWedgeGeometry(i,i,i);break;case"tube":r=new THREE.CylinderGeometry(i/2,i/2,i,32,1,!0)}const o={cube:5025616,sphere:2201331,cylinder:16750592,cone:15277667,torus:10233776,plane:6323595,pyramid:48340,wedge:16733986,tube:7951688},a=new THREE.MeshPhongMaterial({color:o[e]||11184810,transparent:!0,opacity:1,side:THREE.DoubleSide}),n=new THREE.Mesh(r,a);n.castShadow=!0,n.receiveShadow=!0,t?n.position.copy(t):n.position.set(0,"plane"===e?0:i/2,0),"plane"===e&&(n.rotation.x=-Math.PI/2);const s=n.position.clone(),c=n.scale.clone();n.userData={id:`${e}_${Date.now()}`,name:this.getPrimitiveName(e),type:e,originalSize:{x:i,y:i,z:i},originalPosition:s.toArray(),originalScale:c.toArray(),geometryType:r.type,geometryParams:r.parameters?this.safeCloneParameters(r.parameters):{},materialColor:o[e]||11184810,createdAt:(new Date).toISOString(),unit:"mm",needsAnimation:!0};const l=a.clone();l.color.setHex(o[e]||11184810),n.userData.originalMaterial=l,this.editor.objectsGroup.add(n),this.editor.objects.push(n),this.editor.clearSelection(),this.editor.selectSingleObject(n),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList();const d=this.editor.projectManager.serializeObjectForHistory(n);return this.editor.history.addAction({type:"create",subtype:"library",object:n.uuid,data:d}),n}createWedgeGeometry(e,t,r){const i=new THREE.Shape;i.moveTo(-e/2,-r/2),i.lineTo(e/2,-r/2),i.lineTo(e/2,r/2),i.lineTo(-e/2,r/2);const o={depth:t,bevelEnabled:!1,steps:1},a=new THREE.ExtrudeGeometry(i,o);return a.rotateX(Math.PI/2),a.translate(0,t/2,0),a}getPrimitiveName(e){return{cube:"Куб",sphere:"Сфера",cylinder:"Цилиндр",cone:"Конус",torus:"Тор",plane:"Плоскость",pyramid:"Пирамида",wedge:"Клин",tube:"Труба"}[e]||"Объект"}loadSTLModel(e,t,r){console.log(`Loading STL: ${e}, ${t}`),this.editor.showStatus(`Загрузка модели: ${t}...`,"info");const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=()=>{if(200===i.status||0===i.status){const o=i.response;this.processSTLBuffer(o,t,r,e)}else console.error("Failed to load STL:",i.status),this.handleSTLLoadError(t,r,`HTTP ошибка: ${i.status}`)},i.onerror=()=>{console.error("XHR error loading STL"),this.handleSTLLoadError(t,r,"Ошибка сети")},setTimeout(()=>{4!==i.readyState&&(i.abort(),console.log("Trying fetch for STL..."),this.loadSTLWithFetch(e,t,r))},2e3),i.send()}async loadSTLWithFetch(e,t,r){try{console.log(`Fetching STL from: ${e}`);const i=await fetch(e);if(!i.ok)throw new Error(`HTTP ${i.status}`);const o=await i.arrayBuffer();this.processSTLBuffer(o,t,r,e)}catch(e){console.error("Fetch STL error:",e),this.handleSTLLoadError(t,r,e.message)}}processSTLBuffer(e,t,r,i){try{if(!e||0===e.byteLength)throw new Error("Пустой файл");if(console.log(`Processing STL buffer (${e.byteLength} bytes) for: ${t}`),!this.editor.projectManager)throw new Error("ProjectManager не инициализирован");const o=this.editor.projectManager.isBinarySTL(e);console.log("STL format:",o?"binary":"ascii");const a=o?this.editor.projectManager.parseBinarySTL(e):this.editor.projectManager.parseASCIISTL(e);if(!a)throw new Error("Не удалось создать геометрию из STL");console.log("STL geometry created, vertices:",a.attributes.position?.count||0),a.computeBoundingBox();const n=a.boundingBox,s=new THREE.Vector3;n.getCenter(s);const c=a.attributes.position.array;for(let e=0;e<c.length;e+=3)c[e]-=s.x,c[e+1]-=s.y,c[e+2]-=s.z;a.attributes.position.needsUpdate=!0,a.computeBoundingBox(),a.rotateX(-Math.PI/2);const l=new THREE.MeshPhongMaterial({color:9159498,transparent:!0,opacity:.9,side:THREE.DoubleSide,shininess:30}),d=new THREE.Mesh(a,l);if(d.castShadow=!0,d.receiveShadow=!0,r){d.position.copy(r),a.computeBoundingBox();const e=a.boundingBox,t=new THREE.Vector3;e.getSize(t),d.position.y+=t.y/2}else{a.computeBoundingBox();const e=a.boundingBox,t=new THREE.Vector3;e.getSize(t),d.position.y=t.y/2}const h=i?i.split("/").pop():"unknown.stl";d.userData={id:`stl_${Date.now()}`,name:t,type:"stl",createdAt:(new Date).toISOString(),unit:"mm",filename:h,vertexCount:a.attributes.position?.count||0,sourcePath:i,originalGeometry:a};const m=l.clone();d.userData.originalMaterial=m,this.editor.objectsGroup.add(d),this.editor.objects.push(d),this.editor.clearSelection(),this.editor.selectSingleObject(d),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList();const g=this.editor.projectManager.serializeObjectForHistory(d);this.editor.history.addAction({type:"import",format:"stl",object:d.uuid,data:g}),this.editor.showStatus(`Модель "${t}" загружена (${d.userData.vertexCount} вершин)`,"success")}catch(e){console.error("Ошибка обработки STL:",e),this.handleSTLLoadError(t,r,e.message)}}handleSTLLoadError(e,t,r){console.warn(`Не удалось загрузить STL ${e}: ${r}`);let i=`Ошибка загрузки ${e}: ${r}`;r.includes("CORS")||r.includes("NetworkError")?i="Проблема с CORS. Запустите через веб-сервер: npx http-server --cors":r.includes("404")&&(i="Файл не найден. Убедитесь что STL файлы есть в папке models/"),this.editor.showStatus(i,"error"),this.createSTLPlaceholder(e,t)}createSTLPlaceholder(e,t){const r=this.defaultSize,i=new THREE.BoxGeometry(r,r/4,r),o=new THREE.MeshPhongMaterial({color:16750592,transparent:!0,opacity:.8,side:THREE.DoubleSide,wireframe:!0}),a=new THREE.Mesh(i,o);return a.castShadow=!0,a.receiveShadow=!0,t&&(a.position.copy(t),a.position.y+=r/8),a.userData={id:`stl_placeholder_${Date.now()}`,name:`${e} (заглушка)`,type:"stl_placeholder",originalSize:{x:r,y:r/4,z:r},createdAt:(new Date).toISOString(),unit:"mm"},this.editor.objectsGroup.add(a),this.editor.objects.push(a),this.editor.clearSelection(),this.editor.selectSingleObject(a),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Создана заглушка для: ${e}`,"warning"),a}openSTLFileDialog(){const e=document.createElement("input");e.type="file",e.accept=".stl,.STL",e.multiple=!1,e.onchange=e=>{const t=e.target.files[0];if(!t)return;const r=new FileReader;r.onload=e=>{const r=e.target.result,i=t.name.replace(".stl","").replace(".STL",""),o=this.getCenterViewPosition();this.processSTLBuffer(r,i,o,t.name)},r.onerror=()=>{this.editor.showStatus("Ошибка чтения файла","error")},r.readAsArrayBuffer(t)},e.click()}addCustomSTLModel(e,t){const r=new FileReader,i=e.name.replace(".stl","").replace(".STL","");r.onload=r=>{const o=r.target.result;this.processSTLBuffer(o,i,t,e.name)},r.onerror=()=>{this.handleSTLLoadError(i,t,"Ошибка чтения файла")},r.readAsArrayBuffer(e)}}