class LibraryManager{constructor(e){this.editor=e,this.libraryItems=[],this.categories=[],this.draggingItem=null,this.dragPreview=null,this.lastMousePosition=new THREE.Vector2,this.defaultSize=25,this.modelCache=new Map,this.loadingModels=new Map,this.libraryDataUrl="models/library.json",this.loadLibraryData()}async loadLibraryData(){try{console.log("Loading library data from:",this.libraryDataUrl);const e=await fetch(this.libraryDataUrl);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();console.log("Library data loaded:",t),this.categories=t.categories||[],this.processLibraryItems(t.items||[]),this.initLibraryUI(),this.initDragAndDrop(),console.log("Library initialized successfully:",this.libraryItems.length,"items")}catch(e){console.error("Failed to load library data:",e),console.log("Using fallback library items"),this.categories=this.getFallbackCategories(),this.processLibraryItems(this.getFallbackItems()),this.initLibraryUI(),this.initDragAndDrop()}}getFallbackCategories(){return[{id:"all",name:"Все",filter:"all"},{id:"primitive",name:"Примитивы",filter:"primitive"},{id:"components",name:"Электронные компоненты",filter:"components"},{id:"stl_model",name:"STL модели",filter:"stl_model"},{id:"basic",name:"Базовые",parent:"primitive"},{id:"shapes",name:"Формы",parent:"primitive"},{id:"mechanical",name:"Механика",parent:"stl_model"},{id:"fasteners",name:"Крепеж",parent:"stl_model"}]}getFallbackItems(){return[{id:"cube",name:"Куб",type:"primitive",category:"basic",iconPath:"models/icons/cube.png",author:""},{id:"sphere",name:"Сфера",type:"primitive",category:"basic",iconPath:"models/icons/sphere.png",author:""},{id:"cylinder",name:"Цилиндр",type:"primitive",category:"basic",iconPath:"models/icons/cylinder.png",author:""},{id:"cone",name:"Конус",type:"primitive",category:"basic",iconPath:"models/icons/cone.png",author:""},{id:"torus",name:"Тор",type:"primitive",category:"basic",iconPath:"models/icons/torus.png",author:""},{id:"plane",name:"Плоскость",type:"primitive",category:"basic",iconPath:"models/icons/plane.png",author:""},{id:"pyramid",name:"Пирамида",type:"primitive",category:"shapes",iconPath:"models/icons/pyramid.png",author:""},{id:"tube",name:"Труба",type:"primitive",category:"shapes",iconPath:"models/icons/tube.png",author:""},{id:"bob",name:"Боб",type:"stl_model",category:"mechanical",iconPath:"models/icons/bob.png",modelPath:"models/bob.stl",author:"КонтрБагТех"},{id:"zero",name:"КонтрБаг ZERO",type:"components",category:"KontrBugTech",iconPath:"models/icons/zero.png",modelPath:"models/zero.stl",color:"0x77FF44",author:"КонтрБагТех"},{id:"nano1",name:"Нано",type:"components",category:"components",iconPath:"models/icons/nano1.png",modelPath:"models/nano1.stl",color:"0x5555FF",author:"КонтрБагТех"},{id:"nano2",name:"Нано",type:"components",category:"components",iconPath:"models/icons/nano2.png",modelPath:"models/nano2.stl",color:"0x5555FF",author:"КонтрБагТех"},{id:"uno",name:"Uno",type:"components",category:"components",iconPath:"models/icons/uno.png",modelPath:"models/uno.stl",color:"0x8BC3FF",author:"КонтрБагТех"},{id:"watersensor",name:"Датчик воды",type:"components",category:"components",iconPath:"models/icons/watersensor.png",modelPath:"models/watersensor.stl",color:"0x800000",author:"КонтрБагТех"}]}processLibraryItems(e){this.libraryItems=e.map(e=>{const t={id:e.id,name:e.name,type:e.type,category:e.category,iconPath:e.iconPath,author:e.author||"",modelPath:e.modelPath,color:e.color?parseInt(e.color,16):9159498,loadedGeometry:null,isLoading:!1,loadError:!1};return"primitive"===e.type?t.createFunction=t=>this.createPrimitive(e.id,t):"stl_model"!==e.type&&"components"!==e.type||(t.createFunction=t=>{const r=e.color?parseInt(e.color,16):9159498;return this.loadSTLModel(e.modelPath,e.name,t,r)}),t})}initLibraryUI(){this.renderFilterTabs(),this.renderLibraryGrid(),this.initSearch()}renderFilterTabs(){const e=document.querySelector(".filter-tabs");if(!e)return void console.error("Filter tabs container not found");e.innerHTML="";const t=this.categories.filter(e=>!e.parent);if(console.log("Main categories for filter tabs:",t),t.forEach(t=>{const r=document.createElement("button");r.className="filter-btn","all"===t.id&&r.classList.add("active"),r.dataset.filter=t.filter||t.id,r.textContent=t.name,r.title=`Показать ${t.name.toLowerCase()}`,r.addEventListener("click",e=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active");const t=e.target.dataset.filter;console.log(`Applying filter: ${t}`),this.renderLibraryGrid(t)}),e.appendChild(r)}),0===e.children.length){[{id:"all",name:"Все"},{id:"primitive",name:"Примитивы"},{id:"components",name:"Компоненты"},{id:"stl_model",name:"STL модели"}].forEach(t=>{const r=document.createElement("button");r.className="filter-btn","all"===t.id&&r.classList.add("active"),r.dataset.filter=t.id,r.textContent=t.name,r.addEventListener("click",e=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active"),this.renderLibraryGrid(e.target.dataset.filter)}),e.appendChild(r)})}}renderLibraryGrid(e="all"){const t=document.getElementById("libraryGrid");if(!t)return void console.error("Library grid element not found");t.innerHTML="";const r=this.filterLibraryItems(e);if(console.log(`Filter: ${e}, Filtered items: ${r.length}`),0===r.length){const e=document.createElement("div");return e.className="library-empty",e.innerHTML='\n                <i class="fas fa-box-open"></i>\n                <p>Нет элементов для отображения</p>\n                <small>Попробуйте другой фильтр или добавьте модели</small>\n            ',void t.appendChild(e)}r.forEach(e=>{const r=this.createLibraryElement(e);t.appendChild(r)})}filterLibraryItems(e){return"all"===e?this.libraryItems:this.libraryItems.filter(t=>"primitive"===e?"primitive"===t.type:"stl_model"===e?"stl_model"===t.type:"components"===e?"components"===t.type:t.type===e)}createLibraryElement(e){const t=document.createElement("div");t.className="library-item",t.draggable=!0,t.dataset.itemId=e.id,t.dataset.itemType=e.type,t.title=`Перетащите в 3D окно или кликните для создания "${e.name}"`;let r="cube";"stl_model"===e.type||"components"===e.type?r="download":"basic"===e.category?r="cube":"shapes"===e.category&&(r="shapes");const i=this.getCategoryName(e.category);let o=`\n            <div class="library-item-icon">\n                ${e.iconPath?`<img src="${e.iconPath}" alt="${e.name}" class="library-item-img" draggable="false" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-${r}\\'></i>';">`:`<i class="fas fa-${r}"></i>`}\n            </div>\n            <div class="library-item-info">\n                <div class="library-item-name">${e.name}</div>\n                <div class="library-item-category">${i}</div>\n        `;return e.author&&""!==e.author.trim()&&(o+=`<div class="library-item-author">Автор: ${e.author}</div>`),"stl_model"!==e.type&&"components"!==e.type||!e.loadedGeometry?"stl_model"!==e.type&&"components"!==e.type||!e.isLoading?"stl_model"!==e.type&&"components"!==e.type||!e.loadError||(o+='<div class="library-item-status error"><i class="fas fa-exclamation-circle"></i> Ошибка</div>'):o+='<div class="library-item-status"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>':o+='<div class="library-item-status"><i class="fas fa-check-circle"></i> Готово</div>',o+=`\n            </div>\n            <div class="library-item-badge">\n                <i class="fas fa-${"stl_model"===e.type||"components"===e.type?"download":"cube"}"></i>\n            </div>\n        `,t.innerHTML=o,t.addEventListener("dragstart",t=>this.onDragStart(t,e)),t.addEventListener("dragend",e=>this.onDragEnd(e)),t.addEventListener("click",t=>{"BUTTON"===t.target.tagName||t.target.closest("button")||this.onItemClick(e)}),t}getCategoryName(e){const t=this.categories.find(t=>t.id===e);if(t)return t.name;return{basic:"Базовые",shapes:"Формы",mechanical:"Механика",components:"Электронные компоненты",KontrBugTech:"КонтрБагТех",fasteners:"Крепеж"}[e]||e}initSearch(){const e=document.getElementById("librarySearch");e&&(e.addEventListener("input",e=>{const t=e.target.value.toLowerCase().trim();this.filterLibrary(t)}),e.insertAdjacentHTML("afterend",'<button id="clearSearch" class="search-clear" title="Очистить поиск"><i class="fas fa-times"></i></button>'),document.getElementById("clearSearch")?.addEventListener("click",()=>{e.value="",this.filterLibrary("")}))}filterLibrary(e){const t=document.getElementById("libraryGrid"),r=document.querySelectorAll(".library-item");t&&r.length&&(e?r.forEach(t=>{const r=t.querySelector(".library-item-name")?.textContent.toLowerCase()||"",i=t.querySelector(".library-item-category")?.textContent.toLowerCase()||"",o=t.querySelector(".library-item-author")?.textContent.toLowerCase()||"";r.includes(e)||i.includes(e)||o.includes(e)?t.style.display="flex":t.style.display="none"}):r.forEach(e=>{e.style.display="flex"}))}initDragAndDrop(){const e=document.getElementById("viewport");e&&(e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",this.lastMousePosition.set(e.clientX,e.clientY),this.dragPreview&&this.draggingItem&&this.updateDragPreview()}),e.addEventListener("drop",e=>{if(e.preventDefault(),!this.draggingItem)return;const t=this.getDropPosition(e);t&&this.createFromLibrary(this.draggingItem,t),this.clearDragPreview(),this.draggingItem=null}),e.addEventListener("dragleave",()=>{this.clearDragPreview()}))}onDragStart(e,t){this.draggingItem=t,e.dataTransfer.setData("text/plain",t.id),e.dataTransfer.effectAllowed="copy",e.target.classList.add("dragging"),this.createDragPreview(t),"stl_model"!==t.type&&"components"!==t.type||t.loadedGeometry||t.loadError||this.loadModelForPreview(t)}onDragEnd(e){e.target?.classList?.remove("dragging"),this.clearDragPreview(),this.draggingItem=null}onItemClick(e){const t=this.getCenterViewPosition();this.createFromLibrary(e,t)}async createDragPreview(e){let t;this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null);const r=this.defaultSize;if("stl_model"!==e.type&&"components"!==e.type||!e.loadedGeometry)t=this.createGeometryForPrimitive(e.id,r);else{t=e.loadedGeometry.clone();const i=(new THREE.Box3).setFromBufferAttribute(t.attributes.position),o=new THREE.Vector3;i.getSize(o);const a=r/Math.max(o.x,o.y,o.z);t.scale(a,a,a)}const i=new THREE.MeshPhongMaterial({color:"stl_model"===e.type||"components"===e.type?9159498:2201331,transparent:!0,opacity:.6,side:THREE.DoubleSide,wireframe:!1});this.dragPreview=new THREE.Mesh(t,i),this.dragPreview.visible=!1,this.dragPreview.userData.isDragPreview=!0,this.editor.scene.add(this.dragPreview)}async loadModelForPreview(e){if(e.modelPath&&!e.isLoading&&!e.loadError){if(this.modelCache.has(e.modelPath))return e.loadedGeometry=this.modelCache.get(e.modelPath),void this.updateLibraryItemUI(e.id);e.isLoading=!0,this.updateLibraryItemUI(e.id);try{const t=await this.loadSTLGeometryForPreview(e.modelPath);e.loadedGeometry=t,e.loadError=!1,this.modelCache.set(e.modelPath,t),this.draggingItem&&this.draggingItem.id===e.id&&this.dragPreview&&this.updateDragPreviewWithModel(e,t)}catch(t){console.error("Failed to load model for preview:",t),e.loadError=!0}finally{e.isLoading=!1,this.updateLibraryItemUI(e.id)}}}updateLibraryItemUI(e){const t=document.querySelector(`.library-item[data-item-id="${e}"]`);if(!t)return;const r=this.libraryItems.find(t=>t.id===e);if(!r)return;const i=this.createLibraryElement(r);t.replaceWith(i)}async loadSTLGeometryForPreview(e){return new Promise((t,r)=>{console.log("Loading STL for preview:",e);const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.timeout=1e4,i.onload=()=>{if(200===i.status||0===i.status){const e=i.response;try{const r=this.processSTLGeometryForPreview(e);t(r)}catch(e){console.error("Error processing STL geometry:",e),r(e)}}else r(new Error(`HTTP error: ${i.status}`))},i.onerror=()=>{r(new Error("Network error loading STL"))},i.ontimeout=()=>{r(new Error("Timeout loading STL"))},i.send()})}processSTLGeometryForPreview(e){if(!e||0===e.byteLength)throw new Error("Empty STL file");if(!this.editor.importManager)throw new Error("importManager не инициализирован");const t=this.editor.importManager.isBinarySTL(e)?this.editor.importManager.parseBinarySTL(e):this.editor.importManager.parseASCIISTL(e);if(!t)throw new Error("Не удалось создать геометрию из STL");t.computeBoundingBox();const r=t.boundingBox,i=new THREE.Vector3;r.getCenter(i);const o=t.attributes.position.array;for(let e=0;e<o.length;e+=3)o[e]-=i.x,o[e+1]-=i.y,o[e+2]-=i.z;return t.attributes.position.needsUpdate=!0,t.rotateX(-Math.PI/2),t}updateDragPreviewWithModel(e,t){if(!this.dragPreview||!t)return;const r=this.dragPreview.material,i=this.dragPreview.position.clone(),o=this.dragPreview.visible;this.editor.scene.remove(this.dragPreview);const a=t.clone(),s=this.defaultSize,n=(new THREE.Box3).setFromBufferAttribute(a.attributes.position),l=new THREE.Vector3;n.getSize(l);const c=s/Math.max(l.x,l.y,l.z);a.scale(c,c,c),this.dragPreview=new THREE.Mesh(a,r),this.dragPreview.position.copy(i),this.dragPreview.visible=o,this.dragPreview.userData.isDragPreview=!0,this.editor.scene.add(this.dragPreview)}createGeometryForPrimitive(e,t){switch(e){case"cube":default:return new THREE.BoxGeometry(t,t,t);case"sphere":return new THREE.SphereGeometry(t/2,16,16);case"cylinder":return new THREE.CylinderGeometry(t/2,t/2,t,16);case"cone":return new THREE.ConeGeometry(t/2,t,16);case"torus":return new THREE.TorusGeometry(t/1.66,t/5,8,16);case"plane":return new THREE.PlaneGeometry(t,t);case"pyramid":return new THREE.ConeGeometry(t/2,t,4);case"tube":return new THREE.CylinderGeometry(t/2,t/2,t,16,1,!0)}}updateDragPreview(){if(!this.dragPreview||!this.draggingItem)return;const e=new MouseEvent("mousemove",{clientX:this.lastMousePosition.x,clientY:this.lastMousePosition.y}),t=this.getDropPosition(e);t&&(this.dragPreview.position.copy(t),this.dragPreview.visible=!0,"plane"===this.draggingItem.id?this.dragPreview.rotation.x=-Math.PI/2:this.dragPreview.rotation.set(0,0,0))}getDropPosition(e){const t=this.editor.renderer.domElement.getBoundingClientRect(),r=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),i=new THREE.Raycaster;i.setFromCamera(r,this.editor.camera);const o=new THREE.Plane(new THREE.Vector3(0,1,0),0),a=new THREE.Vector3;return i.ray.intersectPlane(o,a)?(this.draggingItem&&"plane"===this.draggingItem.id||(a.y+=this.defaultSize/2),a):null}getCenterViewPosition(){const e=new THREE.Vector2(0,0),t=new THREE.Raycaster;t.setFromCamera(e,this.editor.camera);const r=new THREE.Plane(new THREE.Vector3(0,1,0),0),i=new THREE.Vector3;if(t.ray.intersectPlane(r,i))return i.y+=this.defaultSize/2,i;const o=new THREE.Vector3(0,0,-1);o.applyQuaternion(this.editor.camera.quaternion);const a=this.editor.camera.position.clone().add(o.multiplyScalar(100)),s=-a.y/o.y;return a.clone().add(o.multiplyScalar(s))}clearDragPreview(){this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null)}createFromLibrary(e,t){e.createFunction&&(e.createFunction(t),this.editor.showStatus(`Создан: ${e.name}`,"success"))}safeCloneParameters(e){const t={};for(const r in e){const i=e[r];i&&i.isVector3?t[r]=i.toArray():i&&i.isEuler?t[r]=[i.x,i.y,i.z]:i&&i.isColor?t[r]=i.getHex():"function"!=typeof i&&(t[r]=i)}return t}createPrimitive(e,t){let r;const i=this.defaultSize;switch(e){case"cube":default:r=new THREE.BoxGeometry(i,i,i);break;case"sphere":r=new THREE.SphereGeometry(i/2,32,32);break;case"cylinder":r=new THREE.CylinderGeometry(i/2,i/2,i,32);break;case"cone":r=new THREE.ConeGeometry(i/2,i,32);break;case"torus":r=new THREE.TorusGeometry(i/1.66,i/5,16,100);break;case"plane":r=new THREE.PlaneGeometry(i,i);break;case"pyramid":r=new THREE.ConeGeometry(i/2,i,4);break;case"wedge":r=this.createWedgeGeometry(i,i,i);break;case"tube":r=new THREE.CylinderGeometry(i/2,i/2,i,32,1,!0)}const o={cube:5025616,sphere:2201331,cylinder:16750592,cone:15277667,torus:10233776,plane:6323595,pyramid:48340,wedge:16733986,tube:7951688},a=new THREE.MeshPhongMaterial({color:o[e]||11184810,transparent:!0,opacity:1,side:THREE.DoubleSide}),s=new THREE.Mesh(r,a);s.castShadow=!0,s.receiveShadow=!0,t?s.position.copy(t):s.position.set(0,"plane"===e?0:i/2,0),"plane"===e&&(s.rotation.x=-Math.PI/2);const n=s.position.clone(),l=s.scale.clone();s.userData={id:`${e}_${Date.now()}`,name:this.getPrimitiveName(e),type:e,originalSize:{x:i,y:i,z:i},originalPosition:n.toArray(),originalScale:l.toArray(),geometryType:r.type,geometryParams:r.parameters?this.safeCloneParameters(r.parameters):{},materialColor:o[e]||11184810,createdAt:(new Date).toISOString(),unit:"mm",needsAnimation:!0};const c=a.clone();c.color.setHex(o[e]||11184810),s.userData.originalMaterial=c,this.editor.objectsGroup.add(s),this.editor.objects.push(s),this.editor.clearSelection(),this.editor.selectSingleObject(s),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList();const d=this.editor.projectManager.serializeObjectForHistory(s);return this.editor.history.addAction({type:"create",subtype:"library",object:s.uuid,data:d}),s}createWedgeGeometry(e,t,r){const i=new THREE.Shape;i.moveTo(-e/2,-r/2),i.lineTo(e/2,-r/2),i.lineTo(e/2,r/2),i.lineTo(-e/2,r/2);const o={depth:t,bevelEnabled:!1,steps:1},a=new THREE.ExtrudeGeometry(i,o);return a.rotateX(Math.PI/2),a.translate(0,t/2,0),a}getPrimitiveName(e){return{cube:"Куб",sphere:"Сфера",cylinder:"Цилиндр",cone:"Конус",torus:"Тор",plane:"Плоскость",pyramid:"Пирамида",wedge:"Клин",tube:"Труба"}[e]||"Объект"}loadSTLModel(e,t,r,i=9159498){console.log(`Loading STL: ${e}, ${t}`),this.editor.showStatus(`Загрузка модели: ${t}...`,"info");const o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer",o.onload=()=>{if(200===o.status||0===o.status){const a=o.response;this.processSTLBuffer(a,t,r,e,i)}else console.error("Failed to load STL:",o.status),this.handleSTLLoadError(t,r,`HTTP ошибка: ${o.status}`)},o.onerror=()=>{console.error("XHR error loading STL"),this.handleSTLLoadError(t,r,"Ошибка сети")},setTimeout(()=>{4!==o.readyState&&(o.abort(),console.log("Trying fetch for STL..."),this.loadSTLWithFetch(e,t,r,i))},2e3),o.send()}async loadSTLWithFetch(e,t,r,i=9159498){try{console.log(`Fetching STL from: ${e}`);const o=await fetch(e);if(!o.ok)throw new Error(`HTTP ${o.status}`);const a=await o.arrayBuffer();this.processSTLBuffer(a,t,r,e,i)}catch(e){console.error("Fetch STL error:",e),this.handleSTLLoadError(t,r,e.message)}}processSTLBuffer(e,t,r,i,o=9159498){try{if(!e||0===e.byteLength)throw new Error("Пустой файл");if(console.log(`Processing STL buffer (${e.byteLength} bytes) for: ${t}`),!this.editor.importManager)throw new Error("importManager не инициализирован");const a=this.editor.importManager.isBinarySTL(e);console.log("STL format:",a?"binary":"ascii");const s=a?this.editor.importManager.parseBinarySTL(e):this.editor.importManager.parseASCIISTL(e);if(!s)throw new Error("Не удалось создать геометрию из STL");console.log("STL geometry created, vertices:",s.attributes.position?.count||0),s.computeBoundingBox();const n=s.boundingBox,l=new THREE.Vector3;n.getCenter(l);const c=s.attributes.position.array;for(let e=0;e<c.length;e+=3)c[e]-=l.x,c[e+1]-=l.y,c[e+2]-=l.z;s.attributes.position.needsUpdate=!0,s.computeBoundingBox(),s.rotateX(-Math.PI/2);const d=new THREE.MeshPhongMaterial({color:o,transparent:!0,opacity:.9,side:THREE.DoubleSide,shininess:30}),m=new THREE.Mesh(s,d);if(m.castShadow=!0,m.receiveShadow=!0,r){m.position.copy(r),s.computeBoundingBox();const e=s.boundingBox,t=new THREE.Vector3;e.getSize(t),m.position.y+=t.y/2}else{s.computeBoundingBox();const e=s.boundingBox,t=new THREE.Vector3;e.getSize(t),m.position.y=t.y/2}const h=i?i.split("/").pop():"unknown.stl",p=this.libraryItems.find(e=>e.modelPath===i||e.name===t&&"stl_model"===e.type),y=p?.author||"";m.userData={id:`stl_${Date.now()}`,name:t,type:"stl",createdAt:(new Date).toISOString(),unit:"mm",filename:h,vertexCount:s.attributes.position?.count||0,sourcePath:i,author:y,originalGeometry:s};const g=d.clone();m.userData.originalMaterial=g,this.editor.objectsGroup.add(m),this.editor.objects.push(m),this.editor.clearSelection(),this.editor.selectSingleObject(m),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList();const u=this.editor.projectManager.serializeObjectForHistory(m);this.editor.history.addAction({type:"import",format:"stl",object:m.uuid,data:u}),this.editor.showStatus(`Модель "${t}" загружена (${m.userData.vertexCount} вершин)`,"success")}catch(e){console.error("Ошибка обработки STL:",e),this.handleSTLLoadError(t,r,e.message)}}handleSTLLoadError(e,t,r){console.warn(`Не удалось загрузить STL ${e}: ${r}`);let i=`Ошибка загрузки ${e}: ${r}`;r.includes("CORS")||r.includes("NetworkError")?i="Проблема с CORS. Запустите через веб-сервер: npx http-server --cors":r.includes("404")&&(i="Файл не найден. Убедитесь что STL файлы есть в папке models/"),this.editor.showStatus(i,"error"),this.createSTLPlaceholder(e,t)}createSTLPlaceholder(e,t){const r=this.defaultSize,i=new THREE.BoxGeometry(r,r/4,r),o=new THREE.MeshPhongMaterial({color:16750592,transparent:!0,opacity:.8,side:THREE.DoubleSide,wireframe:!0}),a=new THREE.Mesh(i,o);return a.castShadow=!0,a.receiveShadow=!0,t&&(a.position.copy(t),a.position.y+=r/8),a.userData={id:`stl_placeholder_${Date.now()}`,name:`${e} (заглушка)`,type:"stl_placeholder",originalSize:{x:r,y:r/4,z:r},createdAt:(new Date).toISOString(),unit:"mm"},this.editor.objectsGroup.add(a),this.editor.objects.push(a),this.editor.clearSelection(),this.editor.selectSingleObject(a),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Создана заглушка для: ${e}`,"warning"),a}refreshLibrary(){this.modelCache.clear(),this.loadingModels.clear(),this.loadLibraryData()}}