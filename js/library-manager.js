class LibraryManager{constructor(e){this.editor=e,this.libraryItems=[],this.categories=[],this.draggingItem=null,this.dragPreview=null,this.lastMousePosition=new THREE.Vector2,this.defaultSize=25,this.modelCache=new Map,this.loadingModels=new Map,this.libraryDataUrl="models/library.json",this.isDraggingSTL=!1,this.pendingSTLLoad=null,this.loadLibraryData()}async loadLibraryData(){try{console.log("Loading library data from:",this.libraryDataUrl);const e=await fetch(this.libraryDataUrl);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();console.log("Library data loaded:",t),this.categories=t.categories||[],this.processLibraryItems(t.items||[]),this.initLibraryUI(),this.initDragAndDrop(),console.log("Library initialized successfully:",this.libraryItems.length,"items")}catch(e){console.log("Using fallback library data"),this.categories=LibraryFallbackData.categories||[],this.processLibraryItems(LibraryFallbackData.items||[]),this.initLibraryUI(),this.initDragAndDrop()}}processLibraryItems(e){this.libraryItems=e.map(e=>{const t={id:e.id,name:e.name,type:e.type,category:e.category,iconPath:e.iconPath,author:e.author||"",modelPath:e.modelPath,color:e.color?parseInt(e.color,16):9159498,loadedGeometry:null,isLoading:!1,loadError:!1,originalSize:null};return"primitive"===e.type?t.createFunction=t=>this.createPrimitive(e.id,t):"stl_model"!==e.type&&"components"!==e.type||(t.createFunction=t=>{const r=e.color?parseInt(e.color,16):9159498;return this.loadSTLModel(e.modelPath,e.name,t,r)}),t})}initLibraryUI(){this.renderFilterTabs(),this.renderLibraryGrid(),this.initSearch()}renderFilterTabs(){const e=document.querySelector(".filter-tabs");if(!e)return void console.error("Filter tabs container not found");e.innerHTML="";this.categories.filter(e=>!e.parent).forEach(t=>{const r=document.createElement("button");r.className="filter-btn","all"===t.id&&r.classList.add("active"),r.dataset.filter=t.filter||t.id,r.textContent=t.name,r.title=`Показать ${t.name.toLowerCase()}`,r.addEventListener("click",e=>{document.querySelectorAll(".filter-btn").forEach(e=>e.classList.remove("active")),e.target.classList.add("active");const t=e.target.dataset.filter;console.log(`Applying filter: ${t}`),this.renderLibraryGrid(t)}),e.appendChild(r)})}renderLibraryGrid(e="all"){const t=document.getElementById("libraryGrid");if(!t)return void console.error("Library grid element not found");t.innerHTML="";const r=this.filterLibraryItems(e);if(console.log(`Filter: ${e}, Filtered items: ${r.length}`),0===r.length){const e=document.createElement("div");return e.className="library-empty",e.innerHTML='\n                <i class="fas fa-box-open"></i>\n                <p>Нет элементов для отображения</p>\n                <small>Попробуйте другой фильтр</small>\n            ',void t.appendChild(e)}r.forEach(e=>{const r=this.createLibraryElement(e);t.appendChild(r)})}filterLibraryItems(e){return"all"===e?this.libraryItems:this.libraryItems.filter(t=>"primitive"===e?"primitive"===t.type:"stl_model"===e?"stl_model"===t.type:"components"===e?"components"===t.type:t.type===e)}createLibraryElement(e){const t=document.createElement("div");t.className="library-item",t.draggable=!0,t.dataset.itemId=e.id,t.dataset.itemType=e.type,t.title=`Перетащите в 3D окно или кликните для создания "${e.name}"`;let r="cube";"stl_model"===e.type||"components"===e.type?r="download":"basic"===e.category?r="cube":"shapes"===e.category&&(r="shapes");const i=this.getCategoryName(e.category);let o=`\n            <div class="library-item-icon">\n                ${e.iconPath?`<img src="${e.iconPath}" alt="${e.name}" class="library-item-img" draggable="false" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-${r}\\'></i>';">`:`<i class="fas fa-${r}"></i>`}\n            </div>\n            <div class="library-item-info">\n                <div class="library-item-name">${e.name}</div>\n                <div class="library-item-category">${i}</div>\n        `;return e.author&&""!==e.author.trim()&&(o+=`<div class="library-item-author">Автор: ${e.author}</div>`),"stl_model"!==e.type&&"components"!==e.type||!e.loadedGeometry?"stl_model"!==e.type&&"components"!==e.type||!e.isLoading?"stl_model"!==e.type&&"components"!==e.type||!e.loadError||(o+='<div class="library-item-status error"><i class="fas fa-exclamation-circle"></i> Ошибка</div>'):o+='<div class="library-item-status"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>':o+='<div class="library-item-status"><i class="fas fa-check-circle"></i> Готово</div>',o+=`\n            </div>\n            <div class="library-item-badge">\n                <i class="fas fa-${"stl_model"===e.type||"components"===e.type?"download":"cube"}"></i>\n            </div>\n        `,t.innerHTML=o,t.addEventListener("dragstart",t=>this.onDragStart(t,e)),t.addEventListener("dragend",e=>this.onDragEnd(e)),"stl_model"!==e.type&&"components"!==e.type||t.addEventListener("mouseenter",()=>{e.loadedGeometry||e.isLoading||e.loadError||this.preloadModel(e)}),t.addEventListener("click",t=>{"BUTTON"===t.target.tagName||t.target.closest("button")||this.onItemClick(e)}),t}getCategoryName(e){const t=this.categories.find(t=>t.id===e);if(t)return t.name;return{basic:"Базовые",shapes:"Формы",mechanical:"Механика",components:"Электронные компоненты",KontrBugTech:"КонтрБагТех",fasteners:"Крепеж"}[e]||e}initSearch(){const e=document.getElementById("librarySearch");e&&e.addEventListener("input",e=>{const t=e.target.value.toLowerCase().trim();this.filterLibrary(t)})}filterLibrary(e){const t=document.getElementById("libraryGrid"),r=document.querySelectorAll(".library-item");t&&r.length&&(e?r.forEach(t=>{const r=t.querySelector(".library-item-name")?.textContent.toLowerCase()||"",i=t.querySelector(".library-item-category")?.textContent.toLowerCase()||"",o=t.querySelector(".library-item-author")?.textContent.toLowerCase()||"";r.includes(e)||i.includes(e)||o.includes(e)?t.style.display="flex":t.style.display="none"}):r.forEach(e=>{e.style.display="flex"}))}initDragAndDrop(){const e=document.getElementById("viewport");e&&(e.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",this.lastMousePosition.set(e.clientX,e.clientY),this.dragPreview&&this.draggingItem&&this.updateDragPreview()}),e.addEventListener("drop",e=>{if(e.preventDefault(),!this.draggingItem)return;const t=this.getDropPosition(e);t&&this.createFromLibrary(this.draggingItem,t),this.clearDragPreview(),this.draggingItem=null,this.isDraggingSTL=!1,this.pendingSTLLoad=null}),e.addEventListener("dragleave",()=>{this.clearDragPreview()}))}async onDragStart(e,t){if(console.log("Drag start for item:",t),this.draggingItem=t,e.dataTransfer.setData("text/plain",t.id),e.dataTransfer.effectAllowed="copy",e.target.classList.add("dragging"),"stl_model"!==t.type&&"components"!==t.type||t.loadedGeometry)this.createDragPreview(t);else{this.isDraggingSTL=!0,this.createDragPreview(t);try{await this.loadModelForPreview(t),t.loadedGeometry&&this.dragPreview&&this.updateDragPreviewWithModel(t,t.loadedGeometry)}catch(e){console.error("Failed to load model during drag:",e)}}}onDragEnd(e){e.target?.classList?.remove("dragging"),this.clearDragPreview(),this.draggingItem=null,this.isDraggingSTL=!1,this.pendingSTLLoad=null}async onItemClick(e){if("stl_model"!==e.type&&"components"!==e.type||e.loadedGeometry){const t=this.getCenterViewPosition(e.type);this.createFromLibrary(e,t)}else{this.editor.showStatus(`Загрузка модели "${e.name}"...`,"info");try{if(await this.loadModelForPreview(e),e.loadedGeometry){const t=this.getCenterViewPosition(e.type);this.createFromLibrary(e,t)}}catch(e){console.error("Failed to load model on click:",e)}}}async createDragPreview(e){let t;this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null);const r=this.defaultSize;t="stl_model"!==e.type&&"components"!==e.type||!e.loadedGeometry?this.createGeometryForPrimitive(e.id,r):e.loadedGeometry.clone(),t.computeBoundingBox();const i=t.boundingBox,o=i.max.y-i.min.y,a=new THREE.MeshPhongMaterial({color:"stl_model"===e.type||"components"===e.type?9159498:2201331,transparent:!0,opacity:.6,side:THREE.DoubleSide,wireframe:!1});this.dragPreview=new THREE.Mesh(t,a),this.dragPreview.visible=!1,this.dragPreview.userData.isDragPreview=!0,this.dragPreview.userData.height=o,this.editor.scene.add(this.dragPreview)}async preloadModel(e){if(e.modelPath&&!e.isLoading&&!e.loadError&&!e.loadedGeometry){if(this.modelCache.has(e.modelPath)){const t=this.modelCache.get(e.modelPath);return e.loadedGeometry=t.geometry,e.originalSize=t.originalSize,void this.updateLibraryItemUI(e.id)}e.isLoading=!0,this.updateLibraryItemUI(e.id);try{const t=await this.loadSTLGeometryForPreview(e.modelPath);if(e.loadedGeometry=t.geometry,e.originalSize=t.originalSize,e.loadError=!1,this.modelCache.set(e.modelPath,{geometry:t.geometry,originalSize:t.originalSize}),console.log("Model preloaded:",e.name,"Original size:",e.originalSize),this.draggingItem&&this.draggingItem.id===e.id&&this.dragPreview){t.geometry.computeBoundingBox();const r=t.geometry.boundingBox;r.max.y,r.min.y;this.updateDragPreviewWithModel(e,t.geometry),this.dragPreview.visible&&this.updateDragPreview()}}catch(t){console.error("Failed to preload model:",t),e.loadError=!0}finally{e.isLoading=!1,this.updateLibraryItemUI(e.id)}}}async loadModelForPreview(e){return this.preloadModel(e)}updateLibraryItemUI(e){const t=document.querySelector(`.library-item[data-item-id="${e}"]`);if(!t)return;const r=this.libraryItems.find(t=>t.id===e);if(!r)return;const i=this.createLibraryElement(r);t.replaceWith(i)}async loadSTLGeometryForPreview(e){return new Promise((t,r)=>{console.log("Loading STL for preview:",e);const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.timeout=1e4,i.onload=()=>{if(200===i.status||0===i.status){const e=i.response;try{const r=this.processSTLGeometryForPreview(e);t(r)}catch(e){console.error("Error processing STL geometry:",e),r(e)}}else r(new Error(`HTTP error: ${i.status}`))},i.onerror=()=>{r(new Error("Network error loading STL"))},i.ontimeout=()=>{r(new Error("Timeout loading STL"))},i.send()})}processSTLGeometryForPreview(e){if(!e||0===e.byteLength)throw new Error("Empty STL file");if(!this.editor.importManager)throw new Error("importManager не инициализирован");const t=this.editor.importManager.isBinarySTL(e)?this.editor.importManager.parseBinarySTL(e):this.editor.importManager.parseASCIISTL(e);if(!t)throw new Error("Не удалось создать геометрию из STL");t.computeBoundingBox();const r=t.boundingBox.clone(),i=new THREE.Vector3;r.getSize(i);const o=t.boundingBox,a=new THREE.Vector3;o.getCenter(a);const s=t.attributes.position.array;for(let e=0;e<s.length;e+=3)s[e]-=a.x,s[e+1]-=a.y,s[e+2]-=a.z;return t.attributes.position.needsUpdate=!0,t.computeBoundingBox(),t.rotateX(-Math.PI/2),{geometry:t,originalSize:i}}updateDragPreviewWithModel(e,t){if(!this.dragPreview||!t)return;const r=this.dragPreview.material,i=this.dragPreview.position.clone(),o=this.dragPreview.visible;this.editor.scene.remove(this.dragPreview);const a=t.clone();a.computeBoundingBox();const s=a.boundingBox,n=s.max.y-s.min.y;this.dragPreview=new THREE.Mesh(a,r),this.dragPreview.position.copy(i),this.dragPreview.visible=o,this.dragPreview.userData.isDragPreview=!0,this.dragPreview.userData.height=n,this.editor.scene.add(this.dragPreview)}updateDragPreview(){if(!this.dragPreview||!this.draggingItem)return;const e=new MouseEvent("mousemove",{clientX:this.lastMousePosition.x,clientY:this.lastMousePosition.y}),t=this.getDropPosition(e);t&&(t.y+=this.dragPreview.userData.height/2,this.dragPreview.position.copy(t),this.dragPreview.visible=!0,"plane"===this.draggingItem.id?this.dragPreview.rotation.x=-Math.PI/2:this.dragPreview.rotation.set(0,0,0))}getDropPosition(e){const t=this.editor.renderer.domElement.getBoundingClientRect(),r=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),i=new THREE.Raycaster;i.setFromCamera(r,this.editor.camera);const o=new THREE.Plane(new THREE.Vector3(0,1,0),0),a=new THREE.Vector3;return i.ray.intersectPlane(o,a)?a:null}getCenterViewPosition(){const e=new THREE.Vector2(0,0),t=new THREE.Raycaster;t.setFromCamera(e,this.editor.camera);const r=new THREE.Plane(new THREE.Vector3(0,1,0),0),i=new THREE.Vector3;if(t.ray.intersectPlane(r,i))return i;const o=new THREE.Vector3(0,0,-1);o.applyQuaternion(this.editor.camera.quaternion);const a=this.editor.camera.position.clone().add(o.multiplyScalar(100)),s=-a.y/o.y;return a.clone().add(o.multiplyScalar(s))}clearDragPreview(){this.dragPreview&&(this.editor.scene.remove(this.dragPreview),this.dragPreview=null)}createFromLibrary(e,t){e.createFunction&&(e.createFunction(t),this.editor.showStatus(`Создан: ${e.name}`,"success"))}createGeometryForPrimitive(e,t){switch(e){case"cube":default:return new THREE.BoxGeometry(t,t,t);case"sphere":return new THREE.SphereGeometry(t/2,16,16);case"cylinder":return new THREE.CylinderGeometry(t/2,t/2,t,16);case"cone":return new THREE.ConeGeometry(t/2,t,16);case"torus":return new THREE.TorusGeometry(t/1.66,t/5,8,16);case"plane":return new THREE.PlaneGeometry(t,t);case"pyramid":return new THREE.ConeGeometry(t/2,t,4);case"tube":return new THREE.CylinderGeometry(t/2,t/2,t,16,1,!0)}}createPrimitive(e,t){let r;const i=this.defaultSize;switch(e){case"cube":default:r=new THREE.BoxGeometry(i,i,i);break;case"sphere":r=new THREE.SphereGeometry(i/2,32,32);break;case"cylinder":r=new THREE.CylinderGeometry(i/2,i/2,i,32);break;case"cone":r=new THREE.ConeGeometry(i/2,i,32);break;case"torus":r=new THREE.TorusGeometry(i/1.66,i/5,16,100);break;case"plane":r=new THREE.PlaneGeometry(i,i);break;case"pyramid":r=new THREE.ConeGeometry(i/2,i,4);break;case"wedge":r=this.createWedgeGeometry(i,i,i);break;case"tube":r=new THREE.CylinderGeometry(i/2,i/2,i,32,1,!0)}r.computeBoundingBox();const o=r.boundingBox,a=o.max.y-o.min.y,s={cube:5025616,sphere:2201331,cylinder:16750592,cone:15277667,torus:10233776,plane:6323595,pyramid:48340,wedge:16733986,tube:7951688},n=new THREE.MeshPhongMaterial({color:s[e]||11184810,transparent:!0,opacity:1,side:THREE.DoubleSide}),l=new THREE.Mesh(r,n);l.castShadow=!0,l.receiveShadow=!0,t?(l.position.copy(t),"plane"!==e&&(l.position.y+=a/2)):"plane"===e?l.position.set(0,0,0):l.position.set(0,a/2,0),"plane"===e&&(l.rotation.x=-Math.PI/2);const d=l.position.clone(),c=l.scale.clone();l.userData={id:`${e}_${Date.now()}`,name:this.getPrimitiveName(e),type:e,originalSize:{x:i,y:i,z:i},boundingBox:{min:o.min.toArray(),max:o.max.toArray(),size:(new THREE.Vector3).subVectors(o.max,o.min).toArray(),center:o.getCenter(new THREE.Vector3).toArray()},originalPosition:d.toArray(),originalScale:c.toArray(),geometryType:r.type,geometryParams:this.safeCloneParameters(r.parameters||{}),materialColor:s[e]||11184810,createdAt:(new Date).toISOString(),unit:"mm",needsAnimation:!0};const h=n.clone();h.color.setHex(s[e]||11184810),l.userData.originalMaterial=h,this.editor.objectsGroup.add(l),this.editor.objects.push(l),this.editor.clearSelection(),this.editor.selectSingleObject(l),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList();const m=this.editor.projectManager.serializeObjectForHistory(l);return this.editor.history.addAction({type:"create",subtype:"library",object:l.uuid,data:m}),l}loadSTLModel(e,t,r,i=9159498){if(console.log(`Loading STL: ${e}, ${t}`),this.editor.showStatus(`Загрузка модели: ${t}...`,"info"),this.modelCache.has(e)){const o=this.modelCache.get(e);return console.log("Using cached geometry for:",t,"Original size:",o.originalSize),void this.createSTLFromGeometry(o.geometry,t,r,i,e,o.originalSize)}const o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="arraybuffer",o.onload=()=>{if(200===o.status||0===o.status){const a=o.response;this.processSTLBuffer(a,t,r,e,i)}else console.error("Failed to load STL:",o.status),this.handleSTLLoadError(t,r,`HTTP ошибка: ${o.status}`)},o.onerror=()=>{console.error("XHR error loading STL"),this.handleSTLLoadError(t,r,"Ошибка сети")},setTimeout(()=>{4!==o.readyState&&(o.abort(),console.log("Trying fetch for STL..."),this.loadSTLWithFetch(e,t,r,i))},2e3),o.send()}async loadSTLWithFetch(e,t,r,i=9159498){try{console.log(`Fetching STL from: ${e}`);const o=await fetch(e);if(!o.ok)throw new Error(`HTTP ${o.status}`);const a=await o.arrayBuffer();this.processSTLBuffer(a,t,r,e,i)}catch(e){console.error("Fetch STL error:",e),this.handleSTLLoadError(t,r,e.message)}}processSTLBuffer(e,t,r,i,o=9159498){try{if(!e||0===e.byteLength)throw new Error("Пустой файл");if(console.log(`Processing STL buffer (${e.byteLength} bytes) for: ${t}`),!this.editor.importManager)throw new Error("importManager не инициализирован");const a=this.editor.importManager.isBinarySTL(e);console.log("STL format:",a?"binary":"ascii");const s=a?this.editor.importManager.parseBinarySTL(e):this.editor.importManager.parseASCIISTL(e);if(!s)throw new Error("Не удалось создать геометрию из STL");s.computeBoundingBox();const n=s.boundingBox.clone(),l=new THREE.Vector3;n.getSize(l),console.log("Original STL size:",l);const d=s.boundingBox,c=new THREE.Vector3;d.getCenter(c);const h=s.attributes.position.array;for(let e=0;e<h.length;e+=3)h[e]-=c.x,h[e+1]-=c.y,h[e+2]-=c.z;s.attributes.position.needsUpdate=!0,s.computeBoundingBox(),s.rotateX(-Math.PI/2),this.modelCache.set(i,{geometry:s.clone(),originalSize:l}),this.createSTLFromGeometry(s,t,r,o,i,l)}catch(e){console.error("Ошибка обработки STL:",e),this.handleSTLLoadError(t,r,e.message)}}createSTLFromGeometry(e,t,r,i,o,a){console.log("Creating STL from geometry. Original size:",a);const s=new THREE.MeshPhongMaterial({color:i,transparent:!0,opacity:.9,side:THREE.DoubleSide,shininess:30}),n=new THREE.Mesh(e,s);n.castShadow=!0,n.receiveShadow=!0,e.computeBoundingBox();const l=e.boundingBox,d=new THREE.Vector3;if(l.getSize(d),console.log("Current geometry size after transformations:",d),console.log("Original size (before centering):",a),r){n.position.copy(r);const e=d.y>0?d.y:a.y;n.position.y+=e/2,console.log(`Model positioned at: ${n.position.x}, ${n.position.y}, ${n.position.z}`),console.log(`Model height: ${e}, Lift amount: ${e/2}`)}const c=o?o.split("/").pop():"unknown.stl",h=this.libraryItems.find(e=>e.modelPath===o||e.name===t&&("stl_model"===e.type||"components"===e.type)),m=h?.author||"";n.userData={id:`stl_${Date.now()}`,name:t,type:"stl",createdAt:(new Date).toISOString(),unit:"mm",filename:c,vertexCount:e.attributes.position?.count||0,sourcePath:o,author:m,originalGeometry:e,originalSize:a,boundingBox:{min:l.min.toArray(),max:l.max.toArray(),size:d.toArray(),center:l.getCenter(new THREE.Vector3).toArray()},needsAnimation:!0};const g=s.clone();n.userData.originalMaterial=g,this.editor.objectsGroup.add(n),this.editor.objects.push(n),this.editor.clearSelection(),this.editor.selectSingleObject(n),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList();const y=this.editor.projectManager.serializeObjectForHistory(n);this.editor.history.addAction({type:"import",format:"stl",object:n.uuid,data:y}),this.editor.showStatus(`Модель "${t}" загружена (${n.userData.vertexCount} вершин)`,"success")}handleSTLLoadError(e,t,r){console.warn(`Не удалось загрузить STL ${e}: ${r}`);let i=`Ошибка загрузки ${e}: ${r}`;r.includes("CORS")||r.includes("NetworkError")?i="Проблема с CORS. Запустите через веб-сервер: npx http-server --cors":r.includes("404")&&(i="Файл не найден. Убедитесь что STL файлы есть в папке models/"),this.editor.showStatus(i,"error"),this.createSTLPlaceholder(e,t)}createSTLPlaceholder(e,t){const r=this.defaultSize,i=new THREE.BoxGeometry(r,r/4,r),o=new THREE.MeshPhongMaterial({color:16750592,transparent:!0,opacity:.8,side:THREE.DoubleSide,wireframe:!0}),a=new THREE.Mesh(i,o);return a.castShadow=!0,a.receiveShadow=!0,t&&a.position.copy(t),a.userData={id:`stl_placeholder_${Date.now()}`,name:`${e} (заглушка)`,type:"stl_placeholder",originalSize:{x:r,y:r/4,z:r},createdAt:(new Date).toISOString(),unit:"mm"},this.editor.objectsGroup.add(a),this.editor.objects.push(a),this.editor.clearSelection(),this.editor.selectSingleObject(a),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Создана заглушка для: ${e}`,"warning"),a}createWedgeGeometry(e,t,r){const i=new THREE.Shape;i.moveTo(-e/2,-r/2),i.lineTo(e/2,-r/2),i.lineTo(e/2,r/2),i.lineTo(-e/2,r/2);const o={depth:t,bevelEnabled:!1,steps:1},a=new THREE.ExtrudeGeometry(i,o);return a.rotateX(Math.PI/2),a.translate(0,t/2,0),a}getPrimitiveName(e){return{cube:"Куб",sphere:"Сфера",cylinder:"Цилиндр",cone:"Конус",torus:"Тор",plane:"Плоскость",pyramid:"Пирамида",wedge:"Клин",tube:"Труба"}[e]||"Объект"}safeCloneParameters(e){const t={};for(const r in e){const i=e[r];i&&i.isVector3?t[r]=i.toArray():i&&i.isEuler?t[r]=[i.x,i.y,i.z]:i&&i.isColor?t[r]=i.getHex():"function"!=typeof i&&(t[r]=i)}return t}addCustomSTLModel(e,t){const r=new FileReader,i=e.name.replace(".stl","").replace(".STL","");r.onload=r=>{const o=r.target.result;this.processSTLBuffer(o,i,t,e.name)},r.onerror=()=>{this.handleSTLLoadError(i,t,"Ошибка чтения файла")},r.readAsArrayBuffer(e)}refreshLibrary(){this.modelCache.clear(),this.loadingModels.clear(),this.loadLibraryData()}}