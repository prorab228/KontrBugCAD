class ManifoldBooleanOperations{constructor(e){this.editor=e,this.manifold=null,this.isReady=!1,this.pendingQueue=[],this.OPS={ADDITION:"union",SUBTRACTION:"difference",INTERSECTION:"intersection"},this._initManifold(),window.booleanOps=this}async _initManifold(){let e;try{e=await import("https://cdn.jsdelivr.net/npm/manifold-3d@3.3.2/+esm")}catch(t){console.warn("‚ö†Ô∏è CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é...",t);try{e=await import("./lib/manifold-3d.js")}catch(e){return console.error("‚ùå –õ–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª–∞—Å—å:",e),void this.showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Manifold (CDN –∏ –ª–æ–∫–∞–ª—å–Ω–æ)")}}try{const t=await e.default();t.setup(),this.manifold=t,window.manifold=t,this.isReady=!0,console.log("‚úÖ Manifold 3.3.2 –∑–∞–≥—Ä—É–∂–µ–Ω"),this._processPendingQueue()}catch(e){console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Manifold:",e),this.showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Manifold")}}_processPendingQueue(){for(;this.pendingQueue.length;){const{resolve:e,reject:t,operation:r,objects:o}=this.pendingQueue.shift();try{e(this._performOperationSync(o,r))}catch(e){t(e)}}}_repairGeometry(e){let t=e.clone();if(THREE.BufferGeometryUtils?.mergeVertices&&(t=THREE.BufferGeometryUtils.mergeVertices(t,.001),console.log("  ‚Üí –°–≤–∞—Ä–∫–∞ –≤–µ—Ä—à–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")),t.index){const e=t.attributes.position,r=t.index.array,o=[];for(let t=0;t<r.length;t+=3){const n=(new THREE.Vector3).fromBufferAttribute(e,r[t]),i=(new THREE.Vector3).fromBufferAttribute(e,r[t+1]),s=(new THREE.Vector3).fromBufferAttribute(e,r[t+2]);.5*i.clone().sub(n).cross(s.clone().sub(n)).length()>1e-8&&o.push(r[t],r[t+1],r[t+2])}o.length<r.length&&(t.setIndex(o),console.log("  ‚Üí –£–¥–∞–ª–µ–Ω–æ –≤—ã—Ä–æ–∂–¥–µ–Ω–Ω—ã—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: "+(r.length-o.length)))}return t.computeVertexNormals(),t}_applyObjectTransform(e,t){const r=e.clone();return r.applyMatrix4(t.matrixWorld),r}_threeGeometryToManifold(e){let t=e;if(!e.userData?.isPrimitive)if(window.geometryRepair)try{t=window.geometryRepair.repair(e,{mergeDistance:1e-4,removeDegenerate:!0,removeDuplicates:!0,removeIsolated:!0,removeSmallComponents:!1,closeHoles:!1,fixNormals:!0,checkInfinity:!0,verbose:!0,maxIterations:2})}catch(r){console.warn("–û—à–∏–±–∫–∞ GeometryRepair, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback",r),t=this._repairGeometry(e)}else t=this._repairGeometry(e);const r=t.attributes.position.array;let o,n,i;if(t.index)o=t.index.array;else{o=new Uint32Array(r.length/3);for(let e=0;e<o.length;e++)o[e]=e}if(t.groups&&t.groups.length>0){const e=t.groups.map(e=>e.start),r=t.groups.map(e=>e.materialIndex||0),o=Array.from(e.keys());o.sort((t,r)=>e[t]-e[r]),n=new Uint32Array(o.map(t=>e[t])),i=new Uint32Array(o.map(e=>r[e]))}else n=new Uint32Array([0]),i=new Uint32Array([0]);const s=new this.manifold.Mesh({numProp:3,vertProperties:r,triVerts:o,runIndex:n,runOriginalID:i});if(s.merge(),0===s.numTri)throw new Error(`Mesh –ø—É—Å—Ç–æ–π: ${s.numVert} –≤–µ—Ä—à–∏–Ω, ${s.numTri} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`);let a;try{a=this.manifold.Manifold(s)}catch(e){if("ManifoldError"!==e.name||"Not manifold"!==e.message)throw e;console.warn("  ‚ö†Ô∏è –ì–µ–æ–º–µ—Ç—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞–Ω–∏—Ñ–æ–ª–¥–Ω–æ–π. –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏...");try{a=this.manifold.Manifold(r,o)}catch(t){throw console.error("  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∞–Ω–∏—Ñ–æ–ª–¥:",t),new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é: ${e.message}. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥—ã—Ä—ã, —Å–∞–º–æ–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏–ª–∏ –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏.`)}}return a}_manifoldToThreeGeometry(e){const t=e.getMesh(),r=t.vertProperties,o=t.triVerts,n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.BufferAttribute(r instanceof Float32Array?r:new Float32Array(r),3)),n.setIndex(new THREE.BufferAttribute(o instanceof Uint32Array?o:new Uint32Array(o),1)),n.computeVertexNormals(),n}_validateGeometry(e,t){if(!e||!e.attributes?.position)throw new Error(`–û–±—ä–µ–∫—Ç ${t}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—è`);const r=e.attributes.position.count;if(0===r)throw new Error(`–û–±—ä–µ–∫—Ç ${t}: 0 –≤–µ—Ä—à–∏–Ω`);if(r<3)throw new Error(`–û–±—ä–µ–∫—Ç ${t}: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—à–∏–Ω (${r})`)}_getManifoldStatus(e){try{if("function"==typeof e.status){const t=e.status();return"number"==typeof t?t:t&&"object"==typeof t?t.value||t.toString()||"unknown":t}return"N/A"}catch(e){return"unknown"}}_checkIntersection(e,t){const r=(new THREE.Box3).setFromObject(e),o=(new THREE.Box3).setFromObject(t);return r.intersectsBox(o)}_performOperationSync(e,t,r=!1){if(!this.manifold)throw new Error("Manifold –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");if(!e||e.length<2)throw new Error("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –æ–±—ä–µ–∫—Ç–∞");console.log(`\n=== Manifold: ${this.getOperationName(t)} ===\n`);for(let t=0;t<e.length-1;t++)for(let r=t+1;r<e.length;r++)this._checkIntersection(e[t],e[r]);const o=e.map((e,t)=>{const r=e.userData?.name||e.name||`–û–±—ä–µ–∫—Ç ${t}`;if(console.log(`\nüì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞: ${r}`),!e.geometry)throw new Error(`–û–±—ä–µ–∫—Ç ${r} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç geometry`);this._validateGeometry(e.geometry,r);const o=this._applyObjectTransform(e.geometry,e);let n=this._threeGeometryToManifold(o);if(0===n.numTri())throw new Error(`–û–±—ä–µ–∫—Ç ${r}: Manifold –ø—É—Å—Ç–æ–π (0 —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤)`);"function"==typeof n.clean&&(n=n.clean());const i=this._getManifoldStatus(n);return console.log(`  ‚úì –ì–æ—Ç–æ–≤: ${n.numTri()} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤, —Å—Ç–∞—Ç—É—Å=${i}`),n});let n;if(t===this.OPS.ADDITION)n=this.manifold.Manifold.union(o);else if(t===this.OPS.SUBTRACTION){n=o[0];for(let e=1;e<o.length;e++)n=this.manifold.Manifold.difference(n,o[e])}else if(t===this.OPS.INTERSECTION){n=o[0];for(let e=1;e<o.length;e++)n=this.manifold.Manifold.intersection(n,o[e])}if("function"!=typeof n.numTri)throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏");const i=n.numTri();if(0===i)throw new Error("–†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è –ø—É—Å—Ç–∞ (0 —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç—ã.");let s=this._manifoldToThreeGeometry(n),a=new THREE.Vector3;if(r){s.computeBoundingBox();const e=s.boundingBox;if(!e)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–µ–ø–∏–ø–µ–¥");e.getCenter(a);const t=s.attributes.position,r=t.array;for(let e=0;e<r.length;e+=3)r[e]-=a.x,r[e+1]-=a.y,r[e+2]-=a.z;t.needsUpdate=!0,s.computeBoundingBox(),s.computeVertexNormals()}let l=e[0].material;e[0].userData&&e[0].userData.originalMaterial&&(l=e[0].userData.originalMaterial);const f=l?l.clone():new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide,flatShading:!0});f.flatShading=!0;const c=new THREE.Mesh(s,f);return r?c.position.copy(a):c.position.set(0,0,0),c.rotation.set(0,0,0),c.scale.set(1,1,1),c.castShadow=!0,c.receiveShadow=!0,c.userData={id:"manifold_"+Date.now(),name:this.getOperationName(t),type:"boolean_manifold",operation:t,originalMaterial:f,sourceObjects:e.map(e=>e.uuid),stats:{triangles:i,vertices:n.numVert?n.numVert():0,status:this._getManifoldStatus(n),volume:n.volume?n.volume():null}},c}simplify(e,t){if(!this.isReady)throw new Error("Manifold –Ω–µ –≥–æ—Ç–æ–≤");if(!e)throw new Error("–ì–µ–æ–º–µ—Ç—Ä–∏—è –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞");if(console.log("\n=== Manifold: –£–ø—Ä–æ—â–µ–Ω–∏–µ –≥–µ–æ–º–µ—Ç—Ä–∏–∏ ===\n"),!e.attributes?.position)throw new Error("–ì–µ–æ–º–µ—Ç—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–∑–∏—Ü–∏–π");const r=this._getTriangleCount(e);if(r<4)return console.log("–°–ª–∏—à–∫–æ–º –º–∞–ª–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è"),e.clone();let o=Math.max(4,Math.floor(r*(1-t)));console.log(`–ò—Å—Ö–æ–¥–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: ${r}, —Ü–µ–ª–µ–≤–æ–µ: ${o}`);let n=this._threeGeometryToManifold(e);if("function"!=typeof n.simplify)throw new Error("Manifold –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–ø—Ä–æ—â–µ–Ω–∏–µ (simplify)");let i=null,s=0;let a=o;for(;s<10;){try{if(i=n.simplify(a),i&&i.numTri()>0){console.log(`‚úÖ –£–ø—Ä–æ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ ${s+1}: ${i.numTri()} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ (—Ü–µ–ª—å ${a})`);break}console.warn(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ ${s+1}: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π –¥–ª—è —Ü–µ–ª–∏ ${a}`)}catch(e){console.warn(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ ${s+1}: –æ—à–∏–±–∫–∞ —É–ø—Ä–æ—â–µ–Ω–∏—è –¥–ª—è —Ü–µ–ª–∏ ${a}: ${e.message}`)}if(a=Math.min(r-1,Math.floor(.95*r+5*s)),a>=r)break;s++}if(!i||0===i.numTri())throw new Error("–£–ø—Ä–æ—â–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.");return console.log(`–£–ø—Ä–æ—â–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: ${i.numTri()} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`),this._manifoldToThreeGeometry(i)}_getTriangleCount(e){return e.index?e.index.count/3:e.attributes.position?e.attributes.position.count/3:0}unionMultiple(e,t=!0){if(!this.isReady)throw new Error("Manifold –Ω–µ –≥–æ—Ç–æ–≤");return this._performOperationSync(e,this.OPS.ADDITION,t)}subtract(e,t,r=!0){if(!this.isReady)throw new Error("Manifold –Ω–µ –≥–æ—Ç–æ–≤");return this._performOperationSync([e,t],this.OPS.SUBTRACTION,r)}intersect(e,t,r=!0){if(!this.isReady)throw new Error("Manifold –Ω–µ –≥–æ—Ç–æ–≤");return this._performOperationSync([e,t],this.OPS.INTERSECTION,r)}async performOperation(e,t){return this.isReady?this._performOperationSync(e,t):new Promise((r,o)=>{this.pendingQueue.push({resolve:r,reject:o,operation:t,objects:[...e]})})}canPerformOperation(e){if(!e||e.length<2)return{can:!1,reason:"–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –æ–±—ä–µ–∫—Ç–∞"};if(!this.isReady)return{can:!1,reason:"Manifold –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è"};for(const t of e){if(!t.geometry?.attributes?.position)return{can:!1,reason:`–û–±—ä–µ–∫—Ç ${t.name||t.uuid} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–µ–æ–º–µ—Ç—Ä–∏–∏`};if(t.geometry.attributes.position.count<3)return{can:!1,reason:`–û–±—ä–µ–∫—Ç ${t.name||t.uuid} –∏–º–µ–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—à–∏–Ω`}}return{can:!0,reason:""}}getOperationStats(e){return e?.userData?.stats||null}getOperationName(e){return{union:"–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",difference:"–í—ã—á–∏—Ç–∞–Ω–∏–µ",subtract:"–í—ã—á–∏—Ç–∞–Ω–∏–µ",intersection:"–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ"}[e]||e}showError(e){this.editor?.showStatus?this.editor.showStatus(e,"error"):console.error("Manifold Error:",e)}async waitForReady(){if(this.isReady&&this.manifold)try{const e=new THREE.BoxGeometry(1,1,1);new THREE.Mesh(e);if(this._threeGeometryToManifold(e).numTri()>0)return}catch(e){console.warn("–¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ")}for(;!this.isReady||!this.manifold;)await new Promise(e=>setTimeout(e,20));await new Promise(e=>setTimeout(e,0))}}const BooleanOperations=ManifoldBooleanOperations;