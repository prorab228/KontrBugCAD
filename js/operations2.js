class ManifoldBooleanOperations{constructor(e){this.editor=e,this.manifold=null,this.isReady=!1,this.pendingQueue=[],this.OPS={ADDITION:"union",SUBTRACTION:"difference",INTERSECTION:"intersection"},this._initManifold(),window.booleanOps=this}async _initManifold(){let e;try{e=await import("https://cdn.jsdelivr.net/npm/manifold-3d@3.3.2/+esm")}catch(o){console.warn("‚ö†Ô∏è CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é...",o);try{e=await import("./lib/manifold-3d.js")}catch(e){return console.error("‚ùå –õ–æ–∫–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–∂–µ –Ω–µ —É–¥–∞–ª–∞—Å—å:",e),void this.showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Manifold (CDN –∏ –ª–æ–∫–∞–ª—å–Ω–æ)")}}try{const o=await e.default();o.setup(),this.manifold=o,window.manifold=o,this.isReady=!0,console.log("‚úÖ Manifold 3.3.2 –∑–∞–≥—Ä—É–∂–µ–Ω"),this._processPendingQueue()}catch(e){console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Manifold:",e),this.showError("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É Manifold")}}_processPendingQueue(){for(;this.pendingQueue.length;){const{resolve:e,reject:o,operation:t,objects:n}=this.pendingQueue.shift();try{e(this._performOperationSync(n,t))}catch(e){o(e)}}}_repairGeometry(e){let o=e.clone();if(THREE.BufferGeometryUtils?.mergeVertices&&(o=THREE.BufferGeometryUtils.mergeVertices(o,.001),console.log("  ‚Üí –°–≤–∞—Ä–∫–∞ –≤–µ—Ä—à–∏–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")),o.index){const e=o.attributes.position,t=o.index.array,n=[];for(let o=0;o<t.length;o+=3){const r=(new THREE.Vector3).fromBufferAttribute(e,t[o]),i=(new THREE.Vector3).fromBufferAttribute(e,t[o+1]),s=(new THREE.Vector3).fromBufferAttribute(e,t[o+2]);.5*i.clone().sub(r).cross(s.clone().sub(r)).length()>1e-8&&n.push(t[o],t[o+1],t[o+2])}n.length<t.length&&(o.setIndex(n),console.log("  ‚Üí –£–¥–∞–ª–µ–Ω–æ –≤—ã—Ä–æ–∂–¥–µ–Ω–Ω—ã—Ö —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: "+(t.length-n.length)))}return o.computeVertexNormals(),o}_applyObjectTransform(e,o){const t=e.clone();return t.applyMatrix4(o.matrixWorld),console.log("  ‚Üí –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –≥–µ–æ–º–µ—Ç—Ä–∏–∏"),console.log(`    –ü–æ–∑–∏—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞: [${o.position.x.toFixed(2)}, ${o.position.y.toFixed(2)}, ${o.position.z.toFixed(2)}]`),console.log(`    –ü–æ–≤–æ—Ä–æ—Ç –æ–±—ä–µ–∫—Ç–∞: [${o.rotation.x.toFixed(2)}, ${o.rotation.y.toFixed(2)}, ${o.rotation.z.toFixed(2)}]`),console.log(`    –ú–∞—Å—à—Ç–∞–± –æ–±—ä–µ–∫—Ç–∞: [${o.scale.x.toFixed(2)}, ${o.scale.y.toFixed(2)}, ${o.scale.z.toFixed(2)}]`),t}_threeGeometryToManifold(e){let o=e;if(!e.userData?.isPrimitive)if(window.geometryRepair)try{o=window.geometryRepair.repair(e,{mergeDistance:1e-4,removeDegenerate:!0,removeDuplicates:!0,removeIsolated:!0,removeSmallComponents:!1,closeHoles:!1,fixNormals:!0,checkInfinity:!0,verbose:!0,maxIterations:2})}catch(t){console.warn("–û—à–∏–±–∫–∞ GeometryRepair, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback",t),o=this._repairGeometry(e)}else o=this._repairGeometry(e);const t=o.attributes.position.array;let n,r,i;if(console.log(`  ‚Üí vertProperties.length: ${t.length}`),o.index)n=o.index.array;else{n=new Uint32Array(t.length/3);for(let e=0;e<n.length;e++)n[e]=e}if(console.log(`  ‚Üí triVerts.length: ${n.length}`),o.groups&&o.groups.length>0){const e=o.groups.map(e=>e.start),t=o.groups.map(e=>e.materialIndex||0),n=Array.from(e.keys());n.sort((o,t)=>e[o]-e[t]),r=new Uint32Array(n.map(o=>e[o])),i=new Uint32Array(n.map(e=>t[e]))}else r=new Uint32Array([0]),i=new Uint32Array([0]);console.log(`  ‚Üí runIndex: [${r.join(", ")}]`),console.log(`  ‚Üí runOriginalID: [${i.join(", ")}]`);const s=new this.manifold.Mesh({numProp:3,vertProperties:t,triVerts:n,runIndex:r,runOriginalID:i});if(console.log(`  ‚Üí Mesh —Å–æ–∑–¥–∞–Ω: ${s.numVert} –≤–µ—Ä—à–∏–Ω, ${s.numTri} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`),s.merge(),console.log(`  ‚Üí –ü–æ—Å–ª–µ merge(): ${s.numVert} –≤–µ—Ä—à–∏–Ω, ${s.numTri} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`),0===s.numTri)throw new Error(`Mesh –ø—É—Å—Ç–æ–π: ${s.numVert} –≤–µ—Ä—à–∏–Ω, ${s.numTri} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`);let a;try{a=this.manifold.Manifold(s)}catch(e){if("ManifoldError"!==e.name||"Not manifold"!==e.message)throw e;console.warn("  ‚ö†Ô∏è  –ì–µ–æ–º–µ—Ç—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞–Ω–∏—Ñ–æ–ª–¥–Ω–æ–π."),console.warn("  ‚Üí –ü–æ–ø—ã—Ç–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏...");try{a=this.manifold.Manifold({vertPos:new Float32Array(t),triVerts:new Uint32Array(n)})}catch(o){throw console.error("  ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–∞–Ω–∏—Ñ–æ–ª–¥:",o),new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é: ${e.message}. –ú–æ–¥–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥—ã—Ä—ã, —Å–∞–º–æ–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏–ª–∏ –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ –≥—Ä–∞–Ω–∏.`)}}return console.log(`  ‚Üí Manifold —Å–æ–∑–¥–∞–Ω: ${a.numTri()} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤, ${a.numVert()} –≤–µ—Ä—à–∏–Ω`),a}_manifoldToThreeGeometry(e){const o=e.getMesh(),t=o.vertProperties,n=o.triVerts,r=new THREE.BufferGeometry;return r.setAttribute("position",new THREE.BufferAttribute(t instanceof Float32Array?t:new Float32Array(t),3)),r.setIndex(new THREE.BufferAttribute(n instanceof Uint32Array?n:new Uint32Array(n),1)),r.computeVertexNormals(),r}_validateGeometry(e,o){if(!e||!e.attributes?.position)throw new Error(`–û–±—ä–µ–∫—Ç ${o}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≥–µ–æ–º–µ—Ç—Ä–∏—è`);const t=e.attributes.position.count;if(0===t)throw new Error(`–û–±—ä–µ–∫—Ç ${o}: 0 –≤–µ—Ä—à–∏–Ω`);if(t<3)throw new Error(`–û–±—ä–µ–∫—Ç ${o}: –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—à–∏–Ω (${t})`);console.log(`  ‚úì –í–∞–ª–∏–¥–∞—Ü–∏—è: ${t} –≤–µ—Ä—à–∏–Ω`)}_getManifoldStatus(e){try{if("function"==typeof e.status){const o=e.status();return"number"==typeof o?o:o&&"object"==typeof o?o.value||o.toString()||"unknown":o}return"N/A"}catch(e){return console.warn("  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–∞–Ω–∏—Ñ–æ–ª–¥–∞:",e),"unknown"}}_checkIntersection(e,o){const t=(new THREE.Box3).setFromObject(e),n=(new THREE.Box3).setFromObject(o),r=t.intersectsBox(n);return r?console.log("  ‚úì –û–±—ä–µ–∫—Ç—ã –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è"):(console.warn("  ‚ö†Ô∏è  –û–±—ä–µ–∫—Ç—ã –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è!"),console.warn(`     Box1: min=${t.min.toArray()}, max=${t.max.toArray()}`),console.warn(`     Box2: min=${n.min.toArray()}, max=${n.max.toArray()}`)),r}_performOperationSync(e,o){if(!this.manifold)throw new Error("Manifold –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");if(!e||e.length<2)throw new Error("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –æ–±—ä–µ–∫—Ç–∞");console.log(`\n=== Manifold: ${this.getOperationName(o)} ===\n`),console.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤:");for(let o=0;o<e.length-1;o++)for(let t=o+1;t<e.length;t++)this._checkIntersection(e[o],e[t]);const t=e.map((e,o)=>{const t=e.userData?.name||e.name||`–û–±—ä–µ–∫—Ç ${o}`;if(console.log(`\nüì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞: ${t}`),!e.geometry)throw new Error(`–û–±—ä–µ–∫—Ç ${t} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç geometry`);this._validateGeometry(e.geometry,t);const n=this._applyObjectTransform(e.geometry,e);let r=this._threeGeometryToManifold(n);if(0===r.numTri())throw new Error(`–û–±—ä–µ–∫—Ç ${t}: Manifold –ø—É—Å—Ç–æ–π (0 —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤)`);"function"==typeof r.clean?(r=r.clean(),console.log(`  ‚Üí clean() –≤—ã–ø–æ–ª–Ω–µ–Ω: ${r.numTri()} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`)):console.warn("  ‚Üí –ú–µ—Ç–æ–¥ clean() –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");const i=this._getManifoldStatus(r);return console.log(`  ‚úì –ì–æ—Ç–æ–≤: ${r.numTri()} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤, —Å—Ç–∞—Ç—É—Å=${i}`),console.log(`    –û–±—ä–µ–º: ${r.volume?r.volume().toFixed(2):"N/A"}`),r});let n;if(o===this.OPS.ADDITION)console.log(`\nüîó –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ${t.length} –æ–±—ä–µ–∫—Ç–æ–≤...\n`),n=this.manifold.Manifold.union(t);else if(o===this.OPS.SUBTRACTION){console.log(`\nüîó –í—ã—á–∏—Ç–∞–Ω–∏–µ ${t.length-1} –æ–±—ä–µ–∫—Ç–æ–≤ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ...\n`),n=t[0];for(let e=1;e<t.length;e++){console.log(`  ‚Üí –í—ã—á–∏—Ç–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ${e}...`);const o=n.numTri();n=this.manifold.Manifold.difference(n,t[e]);const r=n.numTri();console.log(`    –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: ${o} ‚Üí ${r} (${r-o})`)}}else if(o===this.OPS.INTERSECTION){console.log(`\nüîó –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ ${t.length} –æ–±—ä–µ–∫—Ç–æ–≤...\n`),n=t[0];for(let e=1;e<t.length;e++)console.log(`  ‚Üí –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å –æ–±—ä–µ–∫—Ç–æ–º ${e}...`),n=this.manifold.Manifold.intersection(n,t[e])}if(console.log("\n‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"),"function"!=typeof n.numTri)throw console.error("‚ùå –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º Manifold!"),new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏");const r=n.numTri(),i=n.numVert?n.numVert():0,s=this._getManifoldStatus(n);if(console.log(`   –°—Ç–∞—Ç—É—Å: ${s}`),console.log(`   –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: ${r}`),console.log(`   –í–µ—Ä—à–∏–Ω: ${i}`),console.log(`   –û–±—ä–µ–º: ${n.volume?n.volume().toFixed(2):"N/A"}`),0===r)throw console.warn("‚ö†Ô∏è  –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π (0 —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤)"),new Error("–†–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∞—è –≥–µ–æ–º–µ—Ç—Ä–∏—è –ø—É—Å—Ç–∞ (0 —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç—ã.");0!==s&&"N/A"!==s&&"unknown"!==s&&console.warn(`‚ö†Ô∏è  Manifold —Å—Ç–∞—Ç—É—Å: ${s} (–Ω–µ 0 = –æ—à–∏–±–∫–∞)`);const a=this._manifoldToThreeGeometry(n);a.computeBoundingBox();const l=a.boundingBox;if(!l)throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–π –ø–∞—Ä–∞–ª–ª–µ–ª–µ–ø–∏–ø–µ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞");const c=new THREE.Vector3;l.getCenter(c);const u=a.attributes.position,f=u.array;for(let e=0;e<f.length;e+=3)f[e]-=c.x,f[e+1]-=c.y,f[e+2]-=c.z;u.needsUpdate=!0,a.computeBoundingBox(),a.computeVertexNormals();const m=e[0]?.material?e[0].material.clone():new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide,flatShading:!0});m.flatShading=!0;const h=new THREE.Mesh(a,m);return h.position.copy(c),h.rotation.set(0,0,0),h.scale.set(1,1,1),h.updateMatrixWorld(),h.castShadow=!0,h.receiveShadow=!0,h.userData={id:"manifold_"+Date.now(),name:this.getOperationName(o),type:"boolean_manifold",operation:o,sourceObjects:e.map(e=>e.uuid),stats:{triangles:r,vertices:i,status:s,volume:n.volume?n.volume():null}},h}unionMultiple(e){if(!this.isReady)throw new Error("Manifold –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");return this._performOperationSync(e,this.OPS.ADDITION)}subtract(e,o){if(!this.isReady)throw new Error("Manifold –Ω–µ –≥–æ—Ç–æ–≤");return this._performOperationSync([e,o],this.OPS.SUBTRACTION)}intersect(e,o){if(!this.isReady)throw new Error("Manifold –Ω–µ –≥–æ—Ç–æ–≤");return this._performOperationSync([e,o],this.OPS.INTERSECTION)}async performOperation(e,o){return this.isReady?this._performOperationSync(e,o):new Promise((t,n)=>{this.pendingQueue.push({resolve:t,reject:n,operation:o,objects:[...e]})})}canPerformOperation(e){if(!e||e.length<2)return{can:!1,reason:"–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –æ–±—ä–µ–∫—Ç–∞"};if(!this.isReady)return{can:!1,reason:"Manifold –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è"};for(const o of e){if(!o.geometry?.attributes?.position)return{can:!1,reason:`–û–±—ä–µ–∫—Ç ${o.name||o.uuid} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≥–µ–æ–º–µ—Ç—Ä–∏–∏`};if(o.geometry.attributes.position.count<3)return{can:!1,reason:`–û–±—ä–µ–∫—Ç ${o.name||o.uuid} –∏–º–µ–µ—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—à–∏–Ω`}}return{can:!0,reason:""}}getOperationStats(e){return e?.userData?.stats||null}getOperationName(e){return{union:"–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",difference:"–í—ã—á–∏—Ç–∞–Ω–∏–µ",subtract:"–í—ã—á–∏—Ç–∞–Ω–∏–µ",intersection:"–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ"}[e]||e}showError(e){this.editor?.showStatus?this.editor.showStatus(e,"error"):console.error("Manifold Error:",e)}}const BooleanOperations=ManifoldBooleanOperations;