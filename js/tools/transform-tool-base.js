import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"./tool.js";export class TransformToolBase extends Tool{constructor(t,e,i){super(t,e,i),this.gizmoGroup=new THREE.Group,this.editor.scene.add(this.gizmoGroup),this.attachedObject=null,this.isDragging=!1,this.currentAxis=null,this.startPosition=new THREE.Vector3,this.startRotation=new THREE.Quaternion,this.startScale=new THREE.Vector3,this.startMouse=new THREE.Vector2,this.axisColors={x:16729156,y:4521796,z:4474111},this.snapEnabled=!0,this.moveSnapValue=1,this.sizeSnapValue=1,this.rotateSnapValue=5,this.moveDelta=new THREE.Vector3,this.sizeDelta=new THREE.Vector3,this.propertiesElement=null,this.lastMousePosition=new THREE.Vector2,this.gizmoBaseSize=20}initGizmo(){}onActivate(){super.onActivate(),this.createPropertiesSection(),1===this.editor.selectedObjects.length?this.attachToObject(this.editor.selectedObjects[0]):this.editor.showStatus(`Выберите объект для ${this.name}`,"info")}onDeactivate(){super.onDeactivate(),this.removePropertiesSection(),this.detach(),this.gizmoGroup.visible=!1}createPropertiesSection(){const t=document.getElementById("propertiesContent");if(!t)return;const e=t.querySelector(`.property-group[data-tool="${this.name}"]`);e&&e.remove(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool",this.name),this.propertiesElement.innerHTML=this.getPropertiesHTML(),t.appendChild(this.propertiesElement),this.bindPropertiesEvents()}removePropertiesSection(){this.propertiesElement&&this.propertiesElement.parentNode&&this.propertiesElement.parentNode.removeChild(this.propertiesElement),this.propertiesElement=null}getPropertiesHTML(){return""}bindPropertiesEvents(){}attachToObject(t){t&&this.canTransformObject(t)&&(this.attachedObject=t,this.updateGizmoPosition(),this.gizmoGroup.visible=!0,this.updatePropertiesValues())}detach(){this.attachedObject=null,this.gizmoGroup.visible=!1}updateGizmoPosition(){if(!this.attachedObject)return;const t=new THREE.Vector3;this.attachedObject.getWorldPosition(t),this.gizmoGroup.position.copy(t),this.useLocalCoordinates?this.gizmoGroup.quaternion.copy(this.attachedObject.quaternion):this.gizmoGroup.quaternion.identity();const e=(new THREE.Box3).setFromObject(this.attachedObject),i=new THREE.Vector3;e.getSize(i);const s=Math.max(i.x,i.y,i.z),o=Math.max(10,1.5*s);this.gizmoGroup.scale.setScalar(o/15)}updatePropertiesValues(){}onMouseDown(t){if(0!==t.button)return!1;this.snapEnabled=!t.ctrlKey,this.editor.updateMousePosition(t),this.lastMousePosition.copy(this.editor.mouse),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=[];this.gizmoGroup.traverse(t=>{t instanceof THREE.Mesh&&e.push(t)});const i=this.editor.raycaster.intersectObjects(e,!0);if(i.length>0){let e=null,s=i[0].object;for(;s&&!e;){if(s.userData&&s.userData.axis){e=s.userData.axis;break}s=s.parent}if(e)return this.startDragging(e,t),!0}const s=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);if(s.length>0){const t=this.editor.objectsManager.findTopParent(s[0].object);if(this.canTransformObject(t))return this.editor.selectSingleObject(t),this.attachToObject(t),!0}return!1}startDragging(t,e){this.currentAxis=t,this.isDragging=!0,this.startMouse.set(e.clientX,e.clientY),this.attachedObject&&(this.startPosition.copy(this.attachedObject.position),this.startRotation.copy(this.attachedObject.quaternion),this.startScale.copy(this.attachedObject.scale),this.attachedObject.userData.transformStartState={position:this.attachedObject.position.clone(),rotation:this.attachedObject.quaternion.clone(),scale:this.attachedObject.scale.clone()})}onMouseMove(t){if(!this.isDragging||!this.attachedObject)return;this.snapEnabled=!t.ctrlKey;const e=t.clientX-this.startMouse.x,i=t.clientY-this.startMouse.y;this.handleTransform(e,i),this.updateGizmoPosition(),this.updatePropertiesValues()}handleTransform(t,e){}onMouseUp(t){this.isDragging&&this.attachedObject&&this.saveToHistory(),this.isDragging=!1,this.currentAxis=null}saveToHistory(){if(!this.attachedObject||!this.attachedObject.userData.transformStartState)return;const t=this.createHistoryAction();t&&this.editor.history.addAction(t),delete this.attachedObject.userData.transformStartState}createHistoryAction(){}canTransformObject(t){return!0}update(){this.attachedObject&&this.gizmoGroup.visible&&this.updateGizmoPosition()}getGizmoScreenPosition(){if(!this.attachedObject)return null;const t=new THREE.Vector3;this.attachedObject.getWorldPosition(t),t.project(this.editor.camera);const e=this.editor.renderer.domElement.clientWidth,i=this.editor.renderer.domElement.clientHeight;return{x:(.5*t.x+.5)*e,y:(.5*-t.y+.5)*i}}}