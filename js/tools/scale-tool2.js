class ScaleTool extends TransformToolBase{constructor(e){super("scale","fa-expand-alt",e),this.sizeStartDimensions=new THREE.Vector3,this.startScale=new THREE.Vector3,this.uniformScaling=!1,this.percentageMode=!1,this.lastMousePosition=new THREE.Vector2,this.accumulatedScale=1,this.initGizmo()}initGizmo(){for(;this.gizmoGroup.children.length>0;){const e=this.gizmoGroup.children[0];e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),this.gizmoGroup.remove(e)}this.createScaleGizmo(),this.gizmoGroup.visible=!1}createScaleGizmo(){this.createBaseRectangle(20,20,1,.2),this.createVerticalRectangle(20,20,1,.2),this.createCenterSphere()}createBaseRectangle(e,t,s,i){const a=e/2,n=t/2,r=[[-a,-a,-n],[a,-a,-n],[-a,-a,n],[a,-a,n],[-a,-a,-n],[-a,-a,n],[a,-a,-n],[a,-a,n]],o=new THREE.BufferGeometry,c=new Float32Array(r.flat());o.setAttribute("position",new THREE.BufferAttribute(c,3));const l=new THREE.LineBasicMaterial({color:16777215,linewidth:2,transparent:!0,opacity:.7}),h=new THREE.LineSegments(o,l);h.userData.type="scale",h.userData.plane="base",this.gizmoGroup.add(h);[{pos:[0,-a,-n],axis:"z",color:this.axisColors.z},{pos:[0,-a,n],axis:"z",color:this.axisColors.z},{pos:[-a,-a,0],axis:"x",color:this.axisColors.x},{pos:[a,-a,0],axis:"x",color:this.axisColors.x}].forEach((e,t)=>{this.createHandleCube(e.pos,e.axis,e.color,s,`base_${e.axis}_${t}`)})}createVerticalRectangle(e,t,s,i){const a=e/2,n=t/2,r=[[-a,-a,a],[-a,n,a],[a,-a,a],[a,n,a],[-a,-a,a],[a,-a,a],[-a,n,a],[a,n,a]],o=new THREE.BufferGeometry,c=new Float32Array(r.flat());o.setAttribute("position",new THREE.BufferAttribute(c,3));const l=new THREE.LineBasicMaterial({color:16777215,linewidth:2,transparent:!0,opacity:.7}),h=new THREE.LineSegments(o,l);h.userData.type="scale",h.userData.plane="vertical",this.gizmoGroup.add(h);[{pos:[-a,0,a],axis:"x",color:this.axisColors.y},{pos:[a,0,a],axis:"x",color:this.axisColors.y},{pos:[0,-a,a],axis:"y",color:this.axisColors.x},{pos:[0,n,a],axis:"y",color:this.axisColors.x}].forEach((e,t)=>{this.createHandleCube(e.pos,e.axis,e.color,s,`vertical_${e.axis}_${t}`)})}createHandleCube(e,t,s,i,a){const n=new THREE.BoxGeometry(i,i,i),r=new THREE.MeshBasicMaterial({color:s,transparent:!0,opacity:.9}),o=new THREE.Mesh(n,r);return o.position.set(...e),o.name=`scale_handle_${a}`,o.userData.type="scale",o.userData.axis=t,o.userData.handle=!0,this.gizmoGroup.add(o),o}createCenterSphere(){const e=new THREE.SphereGeometry(.3,16,16),t=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.9}),s=new THREE.Mesh(e,t);s.name="scale_center",s.userData.type="scale",s.userData.axis="uniform",this.gizmoGroup.add(s)}getPropertiesHTML(){return console.log("ScaleTool: создание HTML свойств"),`\n            <div class="property-group" data-type="scale-size">\n                <h4><i class="fas fa-ruler"></i> Размеры</h4>\n\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="uniformScaling" ${this.uniformScaling?"checked":""}>\n                        Равномерное изменение размера\n                    </label>\n                </div>\n\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="percentageMode" ${this.percentageMode?"checked":""}>\n                        Режим процентов\n                    </label>\n                </div>\n\n                <div class="property-row">\n                    <label>Локальные координаты:</label>\n                    <input type="checkbox" id="localCoordinates" ${this.useLocalCoordinates?"checked":""}>\n                </div>\n\n                <div id="scaleAbsoluteControls" style="${this.percentageMode?"display: none;":""}">\n                    <div class="property-row">\n                        <label>Ширина (X):</label>\n                        <input type="number" id="scaleX" step="0.1" min="0.1" value="25">\n                        <span>мм</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Высота (Y):</label>\n                        <input type="number" id="scaleY" step="0.1" min="0.1" value="25">\n                        <span>мм</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Глубина (Z):</label>\n                        <input type="number" id="scaleZ" step="0.1" min="0.1" value="25">\n                        <span>мм</span>\n                    </div>\n                </div>\n\n                <div id="scalePercentageControls" style="${this.percentageMode?"":"display: none;"}">\n                    <div class="property-row">\n                        <label>Ширина (X):</label>\n                        <input type="number" id="scalePercentX" step="1" min="1" value="100">\n                        <span>%</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Высота (Y):</label>\n                        <input type="number" id="scalePercentY" step="1" min="1" value="100">\n                        <span>%</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Глубина (Z):</label>\n                        <input type="number" id="scalePercentZ" step="1" min="1" value="100">\n                        <span>%</span>\n                    </div>\n                    <div class="property-row">\n                        <button id="applyScalePercentage" class="btn-small">\n                            <i class="fas fa-check"></i> Применить масштаб\n                        </button>\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <button id="applyScale" class="btn-small" style="${this.percentageMode?"display: none;":""}">\n                        <i class="fas fa-check"></i> Применить размеры\n                    </button>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return void console.log("ScaleTool: propertiesElement отсутствует");console.log("ScaleTool: привязка событий");const e=this.propertiesElement.querySelector("#scaleX"),t=this.propertiesElement.querySelector("#scaleY"),s=this.propertiesElement.querySelector("#scaleZ"),i=this.propertiesElement.querySelector("#applyScale"),a=this.propertiesElement.querySelector("#uniformScaling"),n=this.propertiesElement.querySelector("#percentageMode"),r=this.propertiesElement.querySelector("#localCoordinates");e&&(e.addEventListener("change",e=>this.onSizeChange("x",e)),e.addEventListener("input",e=>this.onSizeChange("x",e))),t&&(t.addEventListener("change",e=>this.onSizeChange("y",e)),t.addEventListener("input",e=>this.onSizeChange("y",e))),s&&(s.addEventListener("change",e=>this.onSizeChange("z",e)),s.addEventListener("input",e=>this.onSizeChange("z",e))),i&&i.addEventListener("click",()=>this.applySizeFromInputs()),a&&a.addEventListener("change",e=>{this.uniformScaling=e.target.checked}),n&&n.addEventListener("change",e=>{this.percentageMode=e.target.checked,this.updatePropertiesUI()});const o=this.propertiesElement.querySelector("#scalePercentX"),c=this.propertiesElement.querySelector("#scalePercentY"),l=this.propertiesElement.querySelector("#scalePercentZ"),h=this.propertiesElement.querySelector("#applyScalePercentage");o&&(o.addEventListener("change",e=>this.onPercentChange("x",e)),o.addEventListener("input",e=>this.onPercentChange("x",e))),c&&(c.addEventListener("change",e=>this.onPercentChange("y",e)),c.addEventListener("input",e=>this.onPercentChange("y",e))),l&&(l.addEventListener("change",e=>this.onPercentChange("z",e)),l.addEventListener("input",e=>this.onPercentChange("z",e))),h&&h.addEventListener("click",()=>this.applyPercentageScale()),r&&(r.checked=this.useLocalCoordinates,r.addEventListener("change",e=>{this.useLocalCoordinates=e.target.checked,this.updateGizmoPosition()}))}updateGizmoPosition(){if(!this.attachedObject)return;const e=new THREE.Vector3;this.attachedObject.getWorldPosition(e),this.gizmoGroup.position.copy(e),this.useLocalCoordinates?this.gizmoGroup.quaternion.copy(this.attachedObject.quaternion):this.gizmoGroup.quaternion.identity();const t=(new THREE.Box3).setFromObject(this.attachedObject),s=new THREE.Vector3;t.getSize(s);const i=Math.max(s.x,s.y,s.z),a=Math.max(.5,i/15);this.gizmoGroup.scale.setScalar(a)}updatePropertiesUI(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#scaleAbsoluteControls"),t=this.propertiesElement.querySelector("#scalePercentageControls"),s=this.propertiesElement.querySelector("#applyScale");this.percentageMode?(e&&(e.style.display="none"),t&&(t.style.display="block"),s&&(s.style.display="none")):(e&&(e.style.display="block"),t&&(t.style.display="none"),s&&(s.style.display="block"))}onSizeChange(e,t){if(!this.attachedObject||this.percentageMode)return;const s=parseFloat(t.target.value);if(isNaN(s)||s<.1)return;const i=this.getObjectDimensions(this.attachedObject);if(i[e]=s,this.uniformScaling){const t=s/i[e];i.x*=t,i.y*=t,i.z*=t;const a=this.propertiesElement.querySelector("#scaleX"),n=this.propertiesElement.querySelector("#scaleY"),r=this.propertiesElement.querySelector("#scaleZ");a&&(a.value=i.x.toFixed(2)),n&&(n.value=i.y.toFixed(2)),r&&(r.value=i.z.toFixed(2))}this.updateObjectSize(i,!1)}onPercentChange(e,t){if(!this.attachedObject||!this.percentageMode)return;const s=parseFloat(t.target.value);if(!(isNaN(s)||s<1)&&this.uniformScaling){const e=this.propertiesElement.querySelector("#scalePercentX"),t=this.propertiesElement.querySelector("#scalePercentY"),i=this.propertiesElement.querySelector("#scalePercentZ");e&&(e.value=s),t&&(t.value=s),i&&(i.value=s)}}applyPercentageScale(){if(!this.propertiesElement||!this.attachedObject||!this.percentageMode)return;const e=parseFloat(this.propertiesElement.querySelector("#scalePercentX").value),t=parseFloat(this.propertiesElement.querySelector("#scalePercentY").value),s=parseFloat(this.propertiesElement.querySelector("#scalePercentZ").value);if(isNaN(e)||isNaN(t)||isNaN(s)||e<1||t<1||s<1)return void this.editor.showStatus("Некорректные значения процентов","error");const i=this.attachedObject.userData.originalSize||this.getObjectDimensions(this.attachedObject),a=new THREE.Vector3(i.x*(e/100),i.y*(t/100),i.z*(s/100)),n=this.getObjectDimensions(this.attachedObject);this.updateObjectSize(a,!1),this.editor.history.addAction({type:"modify_size",object:this.attachedObject.uuid,data:{dimensions:a.toArray(),previousDimensions:n.toArray()}}),this.editor.showStatus(`Масштаб установлен: X:${e}%, Y:${t}%, Z:${s}%`,"success")}applySizeFromInputs(){if(!this.propertiesElement||!this.attachedObject||this.percentageMode)return;const e=parseFloat(this.propertiesElement.querySelector("#scaleX").value),t=parseFloat(this.propertiesElement.querySelector("#scaleY").value),s=parseFloat(this.propertiesElement.querySelector("#scaleZ").value);if(isNaN(e)||isNaN(t)||isNaN(s)||e<.1||t<.1||s<.1)return void this.editor.showStatus("Некорректные значения размеров","error");const i=this.getObjectDimensions(this.attachedObject),a=new THREE.Vector3(e,t,s);this.updateObjectSize(a,!0),this.editor.history.addAction({type:"modify_size",object:this.attachedObject.uuid,data:{dimensions:a.toArray(),previousDimensions:i.toArray()}}),this.editor.showStatus(`Размеры установлены: ${e}x${t}x${s} мм`,"success")}updatePropertiesValues(){if(!this.propertiesElement||!this.attachedObject)return;const e=this.getObjectDimensions(this.attachedObject),t=this.propertiesElement.querySelector("#scaleX"),s=this.propertiesElement.querySelector("#scaleY"),i=this.propertiesElement.querySelector("#scaleZ"),a=this.propertiesElement.querySelector("#scalePercentX"),n=this.propertiesElement.querySelector("#scalePercentY"),r=this.propertiesElement.querySelector("#scalePercentZ");t&&(t.value=e.x.toFixed(2)),s&&(s.value=e.y.toFixed(2)),i&&(i.value=e.z.toFixed(2));const o=this.attachedObject.userData.originalSize||e;a&&(a.value=Math.round(e.x/o.x*100)),n&&(n.value=Math.round(e.y/o.y*100)),r&&(r.value=Math.round(e.z/o.z*100))}startDragging(e,t){if(super.startDragging(e,t),this.attachedObject){this.editor.renderer.domElement.getBoundingClientRect();this.startMouse.set(t.clientX,t.clientY),this.lastMousePosition.copy(this.startMouse),this.accumulatedScale=1,this.sizeStartDimensions=this.getObjectDimensions(this.attachedObject),this.startScale.copy(this.attachedObject.scale),this.moveDelta.set(0,0,0),"uniform"!==e||this.attachedObject.userData.originalSize||(this.attachedObject.userData.originalSize=this.sizeStartDimensions.clone())}}handleTransform(e,t){if(!this.attachedObject||!this.currentAxis)return;const s=this.startMouse.x+e,i=this.startMouse.y+t,a=s-this.lastMousePosition.x,n=i-this.lastMousePosition.y;this.lastMousePosition.set(s,i);const r=Math.abs(a)>Math.abs(n)?a:n;let o=r;"y"===this.currentAxis&&(o=-r);const c=1+.005*o;this.accumulatedScale*=c;let l=new THREE.Vector3;"uniform"===this.currentAxis||this.uniformScaling?(l.x=this.sizeStartDimensions.x*this.accumulatedScale,l.y=this.sizeStartDimensions.y*this.accumulatedScale,l.z=this.sizeStartDimensions.z*this.accumulatedScale):"x"===this.currentAxis?(l.x=this.sizeStartDimensions.x*this.accumulatedScale,l.y=this.sizeStartDimensions.y,l.z=this.sizeStartDimensions.z):"y"===this.currentAxis?(l.x=this.sizeStartDimensions.x,l.y=this.sizeStartDimensions.y*this.accumulatedScale,l.z=this.sizeStartDimensions.z):"z"===this.currentAxis&&(l.x=this.sizeStartDimensions.x,l.y=this.sizeStartDimensions.y,l.z=this.sizeStartDimensions.z*this.accumulatedScale),this.snapEnabled&&!this.editor.spacePressed&&(l.x=Math.round(l.x/this.sizeSnapValue)*this.sizeSnapValue,l.y=Math.round(l.y/this.sizeSnapValue)*this.sizeSnapValue,l.z=Math.round(l.z/this.sizeSnapValue)*this.sizeSnapValue);l.x=Math.max(.1,l.x),l.y=Math.max(.1,l.y),l.z=Math.max(.1,l.z),this.updateObjectSize(l,!1)}updateObjectSize(e,t=!0){if(!this.attachedObject)return;let s;this.attachedObject.userData.originalSize?s=this.attachedObject.userData.originalSize:(s=this.getObjectDimensions(this.attachedObject),this.attachedObject.userData.originalSize=s.clone());const i=e.x/s.x,a=e.y/s.y,n=e.z/s.z;this.attachedObject.scale.set(i,a,n),this.updateGizmoPosition(),this.attachedObject.userData.currentSize=e.clone(),this.updatePropertiesValues(),t&&this.attachedObject.userData.transformStartState&&this.saveToHistory()}getObjectDimensions(e){if(!e)return new THREE.Vector3;if(e.userData.currentSize)return e.userData.currentSize.clone();const t=(new THREE.Box3).setFromObject(e),s=new THREE.Vector3;return t.getSize(s),s}getTooltipContent(){if(!this.attachedObject)return"";const e=this.getObjectDimensions(this.attachedObject),t=this.percentageMode?Math.round(e.x/(this.attachedObject.userData.originalSize?.x||e.x)*100):0;return`\n            <div style="font-weight: 600; margin-bottom: 6px; color: #fff;">${this.percentageMode?"Масштаб":"Размеры"} (мм):</div>\n            ${this.percentageMode?`\n                <div style="color: #ffd43b; font-size: 16px; text-align: center;">\n                    ${t}%\n                </div>\n            `:`\n                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">\n                    <div style="color: #ff6b6b;">\n                        <div style="font-size: 10px; opacity: 0.8;">Ширина (X)</div>\n                        <div>${e.x.toFixed(1)}</div>\n                    </div>\n                    <div style="color: #51cf66;">\n                        <div style="font-size: 10px; opacity: 0.8;">Высота (Y)</div>\n                        <div>${e.y.toFixed(1)}</div>\n                    </div>\n                    <div style="color: #339af0;">\n                        <div style="font-size: 10px; opacity: 0.8;">Глубина (Z)</div>\n                        <div>${e.z.toFixed(1)}</div>\n                    </div>\n                </div>\n            `}\n            <div style="margin-top: 8px; font-size: 10px; opacity: 0.7; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 4px;">\n                Режим: ${this.uniformScaling?"равномерный":"по осям"} |\n                Ctrl: ${this.snapEnabled?"с привязкой":"без привязки"}\n            </div>\n        `}createHistoryAction(){return this.attachedObject&&this.attachedObject.userData.transformStartState?{type:"modify_scale",object:this.attachedObject.uuid,data:{scale:this.attachedObject.scale.toArray(),previousScale:this.attachedObject.userData.transformStartState.scale.toArray()}}:null}getHistoryActionType(){return"modify_size"}}