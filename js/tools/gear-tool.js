import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"./tool.js";export class GearTool extends Tool{constructor(e){super("gearGenerator","fa-cog",e),this.modal=null}onActivate(){this.showModal()}onDeactivate(){this.closeModal()}showModal(){if(this.modal)return;const e=this.getModalHTML(),t=document.createElement("div");t.innerHTML=e,this.modal=t.firstElementChild,document.body.appendChild(this.modal),this.bindModalEvents(),this.updateCalculations()}closeModal(){this.modal&&this.modal.parentNode&&this.modal.parentNode.removeChild(this.modal),this.modal=null}getModalHTML(){return'\n            <div class="modal-overlay active" id="gearModal">\n                <div class="modal-content" style="width: 500px;">\n                    <div class="modal-header">\n                        <h4><i class="fas fa-cog"></i> Генератор шестерён</h4>\n                        <button class="close-modal">&times;</button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-group">\n                            <label>Количество зубьев:</label>\n                            <input type="number" id="gearTeeth" min="6" max="200" value="20" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Модуль (мм):</label>\n                            <input type="number" id="gearModule" min="0.5" max="20" step="0.1" value="2" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Угол зацепления (°):</label>\n                            <input type="number" id="gearPressureAngle" min="14.5" max="30" step="0.5" value="20" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Ширина зуба (мм):</label>\n                            <input type="number" id="gearFaceWidth" min="1" max="100" value="10" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Диаметр отверстия (мм):</label>\n                            <input type="number" id="gearBoreDiameter" min="0" max="100" value="8" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Качество:</label>\n                            <select id="gearQuality" class="modal-select">\n                                <option value="low">Низкое (быстро)</option>\n                                <option value="medium" selected>Среднее</option>\n                                <option value="high">Высокое (медленно)</option>\n                            </select>\n                        </div>\n                        <div class="form-group">\n                            <label>Тип шестерни:</label>\n                            <select id="gearType" class="modal-select">\n                                <option value="simple">Упрощенная (рекомендуется)</option>\n                                <option value="precision">Прецизионная (эвольвента)</option>\n                            </select>\n                        </div>\n                        <div class="info-box">\n                            <strong>Расчетные параметры:</strong>\n                            <div id="gearCalculations" style="margin-top: 5px; color: #aaa; font-size: 12px;">\n                                Диаметр: 44мм, Высота зуба: 4.5мм\n                            </div>\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" id="cancelGear">Отмена</button>\n                        <button class="btn btn-primary" id="createGear">Создать</button>\n                    </div>\n                </div>\n            </div>\n        '}bindModalEvents(){if(!this.modal)return;const e=this.modal.querySelector(".close-modal"),t=this.modal.querySelector("#cancelGear"),a=this.modal.querySelector("#createGear");e.addEventListener("click",()=>this.closeModal()),t.addEventListener("click",()=>this.closeModal()),a.addEventListener("click",()=>{const e=this.collectParams();e&&(this.createGear(e),this.closeModal())});this.modal.querySelectorAll(".modal-input, #gearQuality, #gearType").forEach(e=>{e.addEventListener("input",()=>this.updateCalculations()),e.addEventListener("change",()=>this.updateCalculations())})}collectParams(){try{const e=parseInt(this.modal.querySelector("#gearTeeth").value),t=parseFloat(this.modal.querySelector("#gearModule").value),a=parseFloat(this.modal.querySelector("#gearPressureAngle").value),l=parseFloat(this.modal.querySelector("#gearFaceWidth").value),o=parseFloat(this.modal.querySelector("#gearBoreDiameter").value),i=this.modal.querySelector("#gearQuality").value,r=this.modal.querySelector("#gearType").value;return e<6?(this.editor.showStatus("Количество зубьев должно быть не менее 6","error"),null):t<=0?(this.editor.showStatus("Модуль должен быть положительным числом","error"),null):{teeth:e,module:t,pressureAngle:a,faceWidth:l,boreDiameter:o,quality:i,type:r}}catch(e){return this.editor.showStatus("Ошибка в параметрах","error"),null}}updateCalculations(){if(this.modal)try{const e=parseInt(this.modal.querySelector("#gearTeeth").value)||20,t=parseFloat(this.modal.querySelector("#gearModule").value)||2,a=parseFloat(this.modal.querySelector("#gearPressureAngle").value)||20,l=e*t,o=t,i=1.25*t,r=l+2*o,s=l-2*i,n=l*Math.cos(THREE.MathUtils.degToRad(a)),d=this.modal.querySelector("#gearCalculations");d&&(d.innerHTML=`\n                    <div>Диаметр вершин: ${r.toFixed(2)}мм</div>\n                    <div>Делительный диаметр: ${l.toFixed(2)}мм</div>\n                    <div>Диаметр впадин: ${s.toFixed(2)}мм</div>\n                    <div>Основной диаметр: ${n.toFixed(2)}мм</div>\n                    <div>Высота зуба: ${(o+i).toFixed(2)}мм</div>\n                `)}catch(e){}}createGear(e){const t=new ParametricOperation("gear",e,[]),a=this.editor.parametricModel.addOperation(t);this.editor.clearSelection(),a.forEach(e=>{const t=this.editor.parametricModel.objectMap.get(e);t&&(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.editor.showStatus("Шестерня создана","success")}}