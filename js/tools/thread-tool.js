import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"./tool.js";import{ThreadGenerator}from"/js/generators/thread-generator.js";export class ThreadTool extends Tool{constructor(e){super("threadGenerator","fa-screwdriver",e),this.generator=new ThreadGenerator(e),this.modal=null}onActivate(){this.showModal()}onDeactivate(){this.closeModal()}showModal(){if(this.modal)return;const e=this.getModalHTML(),t=document.createElement("div");t.innerHTML=e,this.modal=t.firstElementChild,document.body.appendChild(this.modal),this.populateStandards(),this.bindModalEvents(),this.updatePreview()}closeModal(){this.modal&&this.modal.parentNode&&this.modal.parentNode.removeChild(this.modal),this.modal=null}getModalHTML(){return'\n            <div class="modal-overlay active" id="threadModal">\n                <div class="modal-content" style="width: 550px;">\n                    <div class="modal-header">\n                        <h4><i class="fas fa-screwdriver"></i> Генератор резьбы</h4>\n                        <button class="close-modal">&times;</button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Тип резьбы:</label>\n                                <select id="threadType" class="modal-select">\n                                    <option value="metric">Метрическая</option>\n                                    <option value="inch">Дюймовая (UNC)</option>\n                                    <option value="trapezoidal">Трапецеидальная</option>\n                                    <option value="pipe">Трубная (BSP)</option>\n                                    <option value="custom">Произвольная</option>\n                                </select>\n                            </div>\n                            <div class="form-group" style="flex: 1;">\n                                <label>Стандарт:</label>\n                                <select id="threadStandard" class="modal-select">\n                                    \x3c!-- заполнится динамически --\x3e\n                                </select>\n                            </div>\n                        </div>\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Тип:</label>\n                                <select id="threadDirectionType" class="modal-select">\n                                    <option value="external">Наружная</option>\n                                    <option value="internal">Внутренняя</option>\n                                </select>\n                            </div>\n                            <div class="form-group" style="flex: 1;">\n                                <label>Направление:</label>\n                                <select id="threadDirection" class="modal-select">\n                                    <option value="right">Правая</option>\n                                    <option value="left">Левая</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Диаметр (мм):</label>\n                                <input type="number" id="threadDiameter" min="1" max="100" step="0.1" value="10" class="modal-input">\n                            </div>\n                            <div class="form-group" style="flex: 1;">\n                                <label>Шаг (мм):</label>\n                                <input type="number" id="threadPitch" min="0.1" max="10" step="0.1" value="1.5" class="modal-input">\n                            </div>\n                        </div>\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Длина (мм):</label>\n                                <input type="number" id="threadLength" min="1" max="200" value="30" class="modal-input">\n                            </div>\n                            <div class="form-group" style="flex: 1;">\n                                <label>Угол профиля (°):</label>\n                                <input type="number" id="threadAngle" min="10" max="80" value="60" class="modal-input">\n                            </div>\n                        </div>\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Качество:</label>\n                                <select id="threadQuality" class="modal-select">\n                                    <option value="low">Низкое</option>\n                                    <option value="medium" selected>Среднее</option>\n                                    <option value="high">Высокое</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="form-group">\n                            <div id="threadPreview" style="height: 200px; background: #2a2a2a; border-radius: 5px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #888;">\n                                <i class="fas fa-screwdriver fa-3x"></i>\n                            </div>\n                        </div>\n                        <div class="info-box" style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;">\n                            <strong>Справка:</strong>\n                            <ul style="margin: 5px 0; padding-left: 20px;">\n                                <li>Метрическая: ISO, DIN, ГОСТ</li>\n                                <li>Дюймовая: UNC (Unified National Coarse)</li>\n                                <li>Трапецеидальная: Tr, для ходовых винтов</li>\n                                <li>Трубная: BSP (British Standard Pipe)</li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" id="cancelThread">Отмена</button>\n                        <button class="btn btn-primary" id="createThread">Создать</button>\n                    </div>\n                </div>\n            </div>\n        '}populateStandards(){if(!this.modal)return;const e=this.modal.querySelector("#threadType"),t=this.modal.querySelector("#threadStandard"),a=e.value,r=this.generator.threadStandards[a]?.standards||{};if(t.innerHTML="","custom"===a){const e=document.createElement("option");e.value="custom",e.textContent="Произвольная",t.appendChild(e),this.enableManualInputs(!0)}else{this.enableManualInputs(!1);for(const e in r){const a=document.createElement("option");a.value=e,a.textContent=e,t.appendChild(a)}t.options.length>0&&(t.value=t.options[0].value,this.updateParamsFromStandard())}}enableManualInputs(e){if(!this.modal)return;const t=this.modal.querySelector("#threadDiameter"),a=this.modal.querySelector("#threadPitch"),r=this.modal.querySelector("#threadAngle");t.disabled=!e,a.disabled=!e,r.disabled=!e}updateParamsFromStandard(){if(!this.modal)return;const e=this.modal.querySelector("#threadType").value,t=this.modal.querySelector("#threadStandard").value;if("custom"===e||!t)return;const a=this.generator.threadStandards[e]?.standards[t];a&&(this.modal.querySelector("#threadDiameter").value=a.diameter.toFixed(2),this.modal.querySelector("#threadPitch").value=a.pitch.toFixed(2),this.modal.querySelector("#threadAngle").value=a.threadAngle||60,this.updatePreview())}bindModalEvents(){if(!this.modal)return;const e=this.modal.querySelector(".close-modal"),t=this.modal.querySelector("#cancelThread"),a=this.modal.querySelector("#createThread"),r=this.modal.querySelector("#threadType"),l=this.modal.querySelector("#threadStandard");e.addEventListener("click",()=>this.closeModal()),t.addEventListener("click",()=>this.closeModal()),a.addEventListener("click",()=>{const e=this.collectParams();e&&(this.createThread(e),this.closeModal())}),r.addEventListener("change",()=>{this.populateStandards(),this.updatePreview()}),l.addEventListener("change",()=>{this.updateParamsFromStandard(),this.updatePreview()});this.modal.querySelectorAll(".modal-input, #threadDirectionType, #threadDirection, #threadQuality").forEach(e=>{e.addEventListener("input",()=>this.updatePreview()),e.addEventListener("change",()=>this.updatePreview())})}collectParams(){try{const e=this.modal.querySelector("#threadType").value,t=this.modal.querySelector("#threadStandard").value,a=parseFloat(this.modal.querySelector("#threadDiameter").value),r=parseFloat(this.modal.querySelector("#threadPitch").value),l=parseFloat(this.modal.querySelector("#threadAngle").value),i=parseFloat(this.modal.querySelector("#threadLength").value),o=this.modal.querySelector("#threadDirection").value,n=this.modal.querySelector("#threadDirectionType").value,d=this.modal.querySelector("#threadQuality").value;if(a<=0||r<=0||i<=0)return this.editor.showStatus("Некорректные параметры","error"),null;let s;return s="metric"===e||"inch"===e?a-1.082532*r:"trapezoidal"===e?a-1.5*r:"pipe"===e?a-.960491*r:a-1.2*r,{type:e,standard:t,diameter:a,pitch:r,threadAngle:l,length:i,direction:o,threadType:n,quality:d,minorDiameter:s,chamfer:!1,chamferAngle:45}}catch(e){return this.editor.showStatus("Ошибка в параметрах","error"),null}}updatePreview(){if(!this.modal)return;const e=this.modal.querySelector("#threadPreview"),t=this.modal.querySelector("#threadDiameter").value,a=this.modal.querySelector("#threadPitch").value,r=this.modal.querySelector("#threadLength").value,l=this.modal.querySelector("#threadDirectionType").value;e.innerHTML=`\n            <div style="text-align: center; color: #ccc;">\n                <i class="fas fa-${"external"===l?"screwdriver":"circle"} fa-3x"></i><br>\n                <div style="margin-top: 10px;">\n                    <strong>${"external"===l?"Наружная":"Внутренняя"} резьба</strong><br>\n                    <small>Ø${t}мм, шаг ${a}мм, длина ${r}мм</small>\n                </div>\n            </div>\n        `}createThread(e){const t=new ParametricOperation("thread",e,[]),a=this.editor.parametricModel.addOperation(t);this.editor.clearSelection(),a.forEach(e=>{const t=this.editor.parametricModel.objectMap.get(e);t&&(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.editor.showStatus("Резьба создана","success")}}