class UngroupTool extends Tool{constructor(t){super("ungroup","fa-object-ungroup",t),this.requiresSelection=!0}onActivate(){if(!this.canActivate())return void this.editor.toolManager.restorePreviousTool();const t=this.editor.selectedObjects.filter(t=>"group"===t.userData?.type);if(0===t.length)return this.editor.showStatus("Для разгруппировки выберите группу","error"),void this.editor.toolManager.restorePreviousTool();this.performUngrouping(t),setTimeout(()=>{this.editor.toolManager.restorePreviousTool()},100)}performUngrouping(t){const e=[];t.forEach(t=>{this.addToHistory(t),t.updateMatrixWorld(!0);t.matrixWorld.clone();[...t.children].filter(e=>e!==t).forEach(o=>{o.updateMatrixWorld(!0);const r=new THREE.Matrix4;r.copy(o.matrixWorld),t.remove(o),this.editor.objectsGroup.add(o);const i=new THREE.Matrix4;if(t.parent){t.parent.matrixWorld;i.copy(r)}else i.copy(r);const s=new THREE.Vector3,a=new THREE.Quaternion,n=new THREE.Vector3;i.decompose(s,a,n),o.position.copy(s),o.quaternion.copy(a),o.scale.copy(n),o.updateMatrix(),o.updateMatrixWorld(!0),-1===this.editor.objects.indexOf(o)&&(this.editor.objects.push(o),e.push(o)),o.userData&&(delete o.userData.isPartOfGroup,o.userData.originalGroup&&delete o.userData.originalGroup)}),this.removeGroup(t)}),this.editor.clearSelection(),e.forEach(t=>{this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t)}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),this.editor.showStatus(`Разгруппировано ${t.length} групп (${e.length} объектов)`,"success")}addToHistory(t){const e={type:"ungroup",groupUuid:t.uuid,timestamp:(new Date).toISOString()};this.editor.history.addAction(e)}removeGroup(t){t.parent&&t.parent.remove(t);const e=this.editor.objects.indexOf(t);if(e>-1&&this.editor.objects.splice(e,1),this.editor.groups){const e=this.editor.groups.indexOf(t);e>-1&&this.editor.groups.splice(e,1)}const o=this.editor.selectedObjects.indexOf(t);o>-1&&this.editor.selectedObjects.splice(o,1)}onDeactivate(){}}