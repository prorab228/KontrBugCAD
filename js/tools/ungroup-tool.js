class UngroupTool extends Tool{constructor(e){super("ungroup","fa-object-ungroup",e),this.requiresSelection=!0}onActivate(){if(!this.canActivate())return void this.editor.toolManager.restorePreviousTool();const e=this.editor.selectedObjects.filter(e=>"group"===e.userData?.type);if(0===e.length)return this.editor.showStatus("Для разгруппировки выберите группу","error"),void this.editor.toolManager.restorePreviousTool();this.performUngrouping(e),setTimeout(()=>{this.editor.toolManager.restorePreviousTool()},100)}performUngrouping(e){const t=[];e.forEach(e=>{this.addToHistory(e),e.updateMatrixWorld(!0);e.matrixWorld.clone();[...e.children].filter(t=>t!==e).forEach(o=>{o.updateMatrixWorld(!0);const r=new THREE.Matrix4;r.copy(o.matrixWorld),e.remove(o),this.editor.objectsGroup.add(o);const i=new THREE.Matrix4;if(e.parent){e.parent.matrixWorld;i.copy(r)}else i.copy(r);const s=new THREE.Vector3,a=new THREE.Quaternion,n=new THREE.Vector3;i.decompose(s,a,n),o.position.copy(s),o.quaternion.copy(a),o.scale.copy(n),o.updateMatrix(),o.updateMatrixWorld(!0),-1===this.editor.objects.indexOf(o)&&(this.editor.objects.push(o),t.push(o)),o.userData&&(delete o.userData.isPartOfGroup,o.userData.originalGroup&&delete o.userData.originalGroup)}),this.removeGroup(e)}),this.editor.clearSelection(),t.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),this.editor.showStatus(`Разгруппировано ${e.length} групп (${t.length} объектов)`,"success")}addToHistory(e){const t=[];[...e.children].forEach(o=>{if(o===e)return;const r=o.clone();o.updateMatrixWorld(!0);const i=o.matrixWorld.clone(),s=new THREE.Vector3,a=new THREE.Quaternion,n=new THREE.Vector3;i.decompose(s,a,n),r.position.copy(s),r.quaternion.copy(a),r.scale.copy(n),r.userData={...o.userData},t.push({uuid:o.uuid,data:this.editor.projectManager.serializeObjectForHistory(r),originalParentUuid:o.parent?o.parent.uuid:null})});const o=this.editor.projectManager.serializeObjectForHistory(e),r={type:"ungroup",groupUuid:e.uuid,groupData:o,childrenData:t,timestamp:(new Date).toISOString()};this.editor.history.addAction(r)}removeGroup(e){e.parent&&e.parent.remove(e);const t=this.editor.objects.indexOf(e);if(t>-1&&this.editor.objects.splice(t,1),this.editor.groups){const t=this.editor.groups.indexOf(e);t>-1&&this.editor.groups.splice(t,1)}const o=this.editor.selectedObjects.indexOf(e);o>-1&&this.editor.selectedObjects.splice(o,1)}onDeactivate(){}}