class SketchViewManager{constructor(i){this.sketchManager=i,this.gridVisible=!0,this.gridStep=1,this.gridMaterial=null,this.gridMesh=null,this.backgroundPlane=null,this.gridSize=2e3}recreateGrid(){this.removeSketchGrid(),this.gridVisible&&(this.createBackgroundPlane(),this.createShaderGrid())}createBackgroundPlane(){if(!this.sketchManager.currentPlane)return;const i=new THREE.PlaneGeometry(2*this.gridSize,2*this.gridSize),e=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.4,side:THREE.DoubleSide,depthWrite:!1,depthTest:!0}),t=new THREE.Mesh(i,e);t.position.set(0,0,0),t.userData.isGridBackground=!0,t.raycast=()=>{},t.renderOrder=-2,this.sketchManager.currentPlane.add(t),this.backgroundPlane=t}createShaderGrid(){if(!this.sketchManager.currentPlane)return;const i=new THREE.PlaneGeometry(this.gridSize,this.gridSize),e=this.sketchManager.gridStep;this.gridMaterial=new THREE.ShaderMaterial({uniforms:{step:{value:e},color:{value:new THREE.Color(12303291)},axisColor:{value:new THREE.Color(11184810)},lineWidth:{value:.01},gridSize:{value:this.gridSize}},vertexShader:"\n                varying vec2 vUv;\n                varying vec3 vPosition;\n                void main() {\n                    vUv = uv;\n                    vPosition = position;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n                }\n            ",fragmentShader:"\n                precision highp float;\n                varying vec2 vUv;\n                varying vec3 vPosition;\n\n                uniform float step;\n                uniform vec3 color;\n                uniform vec3 axisColor;\n                uniform float lineWidth;\n                uniform float gridSize;\n\n                void main() {\n                    float x = vPosition.x;\n                    float y = vPosition.y;\n\n                    // Расстояние до ближайшей линии в мировых координатах\n                    float fx = fract(x / step);\n                    float fy = fract(y / step);\n                    float dx = min(fx, 1.0 - fx) * step;\n                    float dy = min(fy, 1.0 - fy) * step;\n                    float dist = min(dx, dy);\n\n                    // Производная расстояния (размер пикселя в мировых единицах)\n                    float w = fwidth(dist);\n\n                    // Минимальная толщина в пикселях (увеличена до 1.5 для стабильности)\n                    float minPixelWidth = 1.5;\n                    float adaptiveWidth = max(lineWidth, w * minPixelWidth);\n\n                    // Плавное затухание – используем smoothstep для мягкого края\n                    float alpha = 1.0 - smoothstep(0.0, adaptiveWidth, dist);\n\n                    // Определяем оси координат\n                    float axisX = abs(x);\n                    float axisY = abs(y);\n                    float axisThreshold = 0.01;\n                    float isAxis = 0.0;\n                    if (axisX < axisThreshold || axisY < axisThreshold) {\n                        isAxis = 1.0;\n                    }\n\n                    vec3 finalColor = mix(color, axisColor, isAxis);\n                    gl_FragColor = vec4(finalColor, alpha);\n                }\n            ",transparent:!0,side:THREE.DoubleSide,depthWrite:!1,depthTest:!0}),this.gridMesh=new THREE.Mesh(i,this.gridMaterial),this.gridMesh.position.set(0,0,-.5),this.gridMesh.userData.isGrid=!0,this.gridMesh.raycast=()=>{},this.gridMesh.renderOrder=-1,this.sketchManager.currentPlane.add(this.gridMesh)}removeSketchGrid(){this.backgroundPlane&&(this.backgroundPlane.parent?.remove(this.backgroundPlane),this.backgroundPlane.geometry?.dispose(),this.backgroundPlane.material?.dispose(),this.backgroundPlane=null),this.gridMesh&&(this.gridMesh.parent?.remove(this.gridMesh),this.gridMesh.geometry?.dispose(),this.gridMesh.material?.dispose(),this.gridMesh=null)}updateGrid(){this.gridVisible?this.recreateGrid():this.removeSketchGrid()}setGridStep(i){this.gridMaterial&&(this.gridMaterial.uniforms.step.value=i)}setGridVisible(i){this.gridVisible=i,this.updateGrid()}clear(){this.removeSketchGrid(),this.gridVisible=!0}}