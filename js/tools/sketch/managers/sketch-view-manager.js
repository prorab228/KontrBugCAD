class SketchViewManager{constructor(e){this.sketchManager=e,this.grid=null,this.gridVisible=!0,this.sketchManager.gridStep=1,this.sketchManager.gridUnit="mm",this.originalCamera=null,this.originalCameraPosition=new THREE.Vector3,this.originalCameraTarget=new THREE.Vector3,this.originalCameraUp=new THREE.Vector3(0,1,0),this.orthoCamera=null,this.frustumSize=50}createSketchGrid(){if(this.removeSketchGrid(),!this.sketchManager.currentPlane||!this.gridVisible)return;let e=this.sketchManager.gridStep;"inch"===this.sketchManager.editor.gridUnit&&(e*=25.4);const t=50,r=e,i=t/r,a=2236962,o=5592405;for(let e=1;e<=i;e++){const i=e*r;this.createGridLine(-50,i,t,i,0===e?o:a)}for(let e=0;e>=-i;e--){const i=e*r;this.createGridLine(-50,i,t,i,0===e?o:a)}for(let e=1;e<=i;e++){const i=e*r;this.createGridLine(i,-50,i,t,0===e?o:a)}for(let e=0;e>=-i;e--){const i=e*r;this.createGridLine(i,-50,i,t,0===e?o:a)}}createGridLine(e,t,r,i,a){const o=new THREE.Vector3(e,t,.05),s=new THREE.Vector3(r,i,.05),n=(new THREE.BufferGeometry).setFromPoints([o,s]),h=new THREE.LineBasicMaterial({color:a,linewidth:1,transparent:!0,opacity:.1}),c=new THREE.Line(n,h);c.userData.isGrid=!0,this.sketchManager.currentPlane.add(c),this.grid||(this.grid=[]),this.grid.push(c)}removeSketchGrid(){this.grid&&(this.grid.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.grid=null)}createOrthographicCamera(){const e=this.sketchManager.editor;this.originalCamera=e.camera,this.originalCameraPosition.copy(e.camera.position),this.originalCameraTarget.copy(e.controls.target),this.originalCameraUp.copy(e.camera.up);const t=e.renderer.domElement.width/e.renderer.domElement.height;this.orthoCamera=new THREE.OrthographicCamera(-this.frustumSize*t/2,this.frustumSize*t/2,this.frustumSize/2,-this.frustumSize/2,.1,1e3),this.orthoCamera.position.copy(this.originalCameraPosition),this.orthoCamera.up.copy(this.originalCameraUp),e.controls.object=this.orthoCamera,e.camera=this.orthoCamera,e.camera.updateProjectionMatrix(),console.log("Ортографическая камера создана для скетча")}restoreOriginalCamera(){if(!this.originalCamera)return;const e=this.sketchManager.editor;e.controls.object=this.originalCamera,e.camera=this.originalCamera,e.camera.position.copy(this.originalCameraPosition),e.controls.target.copy(this.originalCameraTarget),e.camera.up.copy(this.originalCameraUp),e.camera.updateProjectionMatrix(),e.controls.update(),this.orthoCamera=null,this.originalCamera=null,console.log("Оригинальная камера восстановлена")}adjustOrthoCameraToPlane(e){if(!this.orthoCamera)return;const t=this.sketchManager.editor,r=t.renderer.domElement.width/t.renderer.domElement.height,i=(new THREE.Box3).setFromObject(e),a=new THREE.Vector3;i.getSize(a);const o=.5*Math.max(a.x,50)/r,s=.5*Math.max(a.y,50);this.frustumSize=Math.max(o,s,30),this.orthoCamera.left=-this.frustumSize*r/2,this.orthoCamera.right=this.frustumSize*r/2,this.orthoCamera.top=this.frustumSize/2,this.orthoCamera.bottom=-this.frustumSize/2,this.orthoCamera.updateProjectionMatrix(),console.log(`Ортографическая камера настроена: frustumSize=${this.frustumSize.toFixed(1)}`)}orientCameraToPlane(e,t=!0){t&&(this.originalCameraUp.copy(this.sketchManager.editor.camera.up),this.originalCameraPosition.copy(this.sketchManager.editor.camera.position),this.originalCameraTarget.copy(this.sketchManager.editor.controls.target));const r=new THREE.Vector3(0,1,0).applyQuaternion(e.quaternion),i=new THREE.Vector3(0,0,1).applyQuaternion(e.quaternion),a=(new THREE.Box3).setFromObject(e),o=new THREE.Vector3;a.getSize(o);const s=Math.max(o.x,o.y,o.z),n=Math.max(s,100)/2,h=new THREE.Vector3;a.getCenter(h);const c=h.clone().add(i.clone().multiplyScalar(n)),m=this.sketchManager.editor.camera;m.position.copy(c),m.lookAt(h),m.up.copy(r),m.up.normalize(),this.sketchManager.editor.controls.target.copy(h),this.sketchManager.editor.controls.update(),this.orthoCamera&&this.adjustOrthoCameraToPlane(e)}setViewCameraToCurrentPlane(){this.sketchManager.currentPlane&&this.orientCameraToPlane(this.sketchManager.currentPlane,!1)}updateGrid(){this.gridVisible?this.createSketchGrid():this.removeSketchGrid()}setGridVisible(e){this.gridVisible=e,this.gridVisible?this.createSketchGrid():this.removeSketchGrid()}clear(){this.removeSketchGrid(),this.grid=null,this.gridVisible=!0,this.restoreOriginalCamera()}}