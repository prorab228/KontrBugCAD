class SketchContourManager{constructor(t){this.sketchManager=t,this.contourDetector=new ContourDetector,this.autoDetectContours=!1,this.contourVisualization=null}detectContours(){if(!this.sketchManager.currentPlane||!this.autoDetectContours)return;const t=[];this.sketchManager.currentPlane.traverse(e=>{e.userData&&"sketch_element"===e.userData.type&&t.push(e)}),this.detectContoursInSketch(this.sketchManager.currentPlane,t)}forceUpdateContours(){if(!this.sketchManager.currentPlane)return;this.removeContourVisualization();const t=[];this.sketchManager.currentPlane.traverse(e=>{e.userData&&"sketch_element"===e.userData.type&&t.push(e)}),this.contourDetector.updateElements(t);const e=this.contourDetector.findClosedContours();e.length>0&&this.updateFigureManagerWithContours(e),this.autoDetectContours&&this.visualizeContours(e)}detectContoursInSketch(t,e=null){if(t&&this.autoDetectContours)try{const n=e||[];if(0===n.length&&t.traverse(t=>{t.userData&&"sketch_element"===t.userData.type&&n.push(t)}),0===n.length)return;this.contourDetector.updateElements(n);const o=this.contourDetector.findClosedContours();if(o.length>0){const e=o.map((e,n)=>{if(!e.isValid||!e.points||e.points.length<3)return null;const o=Math.abs(this.calculatePolygonArea(e.points));if(o<.01)return null;const r=this.calculateContourCenter(e.points),s=this.calculateBoundingBox(e.points);return{elements:e.elements||[],points:e.points,area:o,center:r,boundingBox:s,type:"auto_detected",isClosed:!0,isClockwise:e.isClockwise||!1,source:"auto_detection",planeId:t.uuid}}).filter(t=>null!==t);e.length>0&&(this.updateFigureManagerWithContours(e,t.uuid),this.visualizeContours(e))}}catch(t){console.error("Ошибка детекции контуров:",t)}}updateFigureManagerWithContours(t=null,e=null){const n=this.sketchManager.editor.objectsManager.figureManager;if(!n)return void console.error("FigureManager не найден!");if(!t&&this.contourDetector&&(t=this.contourDetector.findClosedContours()),!t||0===t.length)return;let o=t;e&&(o=t.filter(t=>t.planeId===e||t.elements&&t.elements.some(t=>!(!t.parent||t.parent.uuid!==e)||!(!t.userData||t.userData.sketchPlaneId!==e)))),n.updateWithAutoContours(o)}visualizeContours(t){this.removeContourVisualization(),this.contourVisualization=new THREE.Group,this.contourVisualization.name="contour_debug",t.forEach((t,e)=>{if(!t.points||t.points.length<3)return;const n=[];t.points.forEach(t=>{n.push(t.x,t.y,.1)});const o=t.points[0];n.push(o.x,o.y,.1);const r=new THREE.BufferGeometry;r.setAttribute("position",new THREE.Float32BufferAttribute(n,3));const s=137.5*e%360,a=(new THREE.Color).setHSL(s/360,.8,.6),i=new THREE.LineBasicMaterial({color:a,linewidth:3,transparent:!0,opacity:.7}),u=new THREE.Line(r,i);u.userData.isContourDebug=!0,u.userData.contourId=t.id,this.contourVisualization.add(u)}),this.sketchManager.currentPlane&&this.sketchManager.currentPlane.add(this.contourVisualization)}removeContourVisualization(){this.contourVisualization&&this.sketchManager.currentPlane&&(this.sketchManager.currentPlane.remove(this.contourVisualization),this.contourVisualization.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.contourVisualization=null)}calculatePolygonArea(t){let e=0;const n=t.length;for(let o=0;o<n;o++){const r=(o+1)%n;e+=t[o].x*t[r].y,e-=t[r].x*t[o].y}return e/2}calculateContourCenter(t){const e=new THREE.Vector2(0,0);return t.forEach(t=>{e.x+=t.x,e.y+=t.y}),t.length>0&&(e.x/=t.length,e.y/=t.length),e}calculateBoundingBox(t){const e=new THREE.Vector2(1/0,1/0),n=new THREE.Vector2(-1/0,-1/0);return t.forEach(t=>{e.x=Math.min(e.x,t.x),e.y=Math.min(e.y,t.y),n.x=Math.max(n.x,t.x),n.y=Math.max(n.y,t.y)}),{min:e,max:n}}updateContoursFromElements(){if(!this.sketchManager.currentPlane||!this.sketchManager.elementManager.elements.length)return;const t=this.sketchManager.elementManager.elements.map(t=>t.mesh);this.contourDetector.updateElements(t);const e=this.contourDetector.findClosedContours();this.updateFigureManagerWithContours(e)}clear(){this.removeContourVisualization(),this.contourDetector.clear(),this.autoDetectContours=!1}}