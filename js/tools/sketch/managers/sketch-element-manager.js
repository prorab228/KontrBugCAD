class SketchElementManager{constructor(e,t){this.sketchManager=e,this.elements=[],this.clipboard=[],this.selectedElements=[],this.snapHelper=t}saveSketchState(){if(!this.sketchManager.currentPlane)return;const e=this.elements.map(e=>this._elementToData(e)),t=new ParametricOperation("sketch",{planeId:this.sketchManager.currentPlane.uuid,elements:e},[]);this.sketchManager.editor.parametricModel.addOperation(t,!1)}updateSketch(){this.saveSketchState(),this.snapHelper&&this.snapHelper.forceUpdate(),this.sketchManager.regionManager.updateRegions()}_elementToData(e){const t={type:e.type,points:e.points.map(e=>[e.x,e.y]),color:e.color,closed:e.isClosed||!1,dashed:e.dashed||!1};return void 0!==e.dashSize&&(t.dashSize=e.dashSize),void 0!==e.gapSize&&(t.gapSize=e.gapSize),void 0!==e.radius&&(t.radius=e.radius),void 0!==e.width&&(t.width=e.width),void 0!==e.height&&(t.height=e.height),e.center&&(t.center=[e.center.x,e.center.y]),t}loadSketchState(e){this.clearAllElementsFromPlane();for(const t of e){const e=t.points.map(e=>new THREE.Vector3(e[0],e[1],0)),s={type:t.type,points:e,color:t.color,isClosed:t.closed,dashed:t.dashed,dashSize:t.dashSize,gapSize:t.gapSize,radius:t.radius,width:t.width,height:t.height,center:t.center?new THREE.Vector3(t.center[0],t.center[1],0):void 0};this._addElementToPlane(s)}this.snapHelper.forceUpdate()}_addElementToPlane(e){const t=this.sketchManager.currentPlane;if(!t)return;const s=[];e.points.forEach(e=>s.push(e.x,e.y,.01));const i=new THREE.BufferGeometry;let n,a;i.setAttribute("position",new THREE.Float32BufferAttribute(s,3)),n=e.dashed?new THREE.LineDashedMaterial({color:e.color,dashSize:e.dashSize||2,gapSize:e.gapSize||2,linewidth:2}):new THREE.LineBasicMaterial({color:e.color,linewidth:2}),a=e.isClosed?new THREE.LineLoop(i,n):new THREE.Line(i,n),a.userData={type:"sketch_element",elementType:e.type,points:e.points.map(e=>e.clone()),closed:e.isClosed,dashed:e.dashed,originalColor:e.color,sketchPlaneId:t.uuid},e.dashed&&a.computeLineDistances(),a.frustumCulled=!1,t.add(a),this.elements.push({mesh:a,type:e.type,points:e.points,color:e.color,isClosed:e.isClosed,dashed:e.dashed,dashSize:e.dashSize,gapSize:e.gapSize,radius:e.radius,width:e.width,height:e.height,center:e.center})}addElement(e,t=!0){this._addElementToPlane(e),t&&this.saveSketchState(),this.snapHelper&&this.snapHelper.forceUpdate(),this.sketchManager.regionManager.updateRegions(),this.showSuccessMessage(e.type)}deleteSelectedElements(){if(0===this.selectedElements.length)return;const e=[...this.selectedElements];e.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose())}),this.elements=this.elements.filter(t=>!e.includes(t)),this.selectedElements=[],this.updateSketch(),this.sketchManager.editor.showStatus(`Удалено элементов: ${e.length}`,"success")}deleteAllElements(){0!==this.elements.length&&confirm("Очистить весь чертеж?")&&(this.elements.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose())}),this.elements=[],this.selectedElements=[],this.updateSketch(),this.sketchManager.editor.showStatus("Чертеж очищен","success"))}copySelectedElements(){0!==this.selectedElements.length?(this.clipboard=this.selectedElements.map(e=>this._elementToData(e)),this.sketchManager.regionManager.updateRegions(),this.sketchManager.editor.showStatus(`Скопировано элементов: ${this.selectedElements.length}`,"success")):this.sketchManager.editor.showStatus("Нет выделенных элементов для копирования","warning")}cutSelectedElements(){0!==this.selectedElements.length?(this.copySelectedElements(),this.deleteSelectedElements()):this.sketchManager.editor.showStatus("Нет выделенных элементов для вырезания","warning")}pasteElements(){if(0===this.clipboard.length)return void this.sketchManager.editor.showStatus("Буфер обмена пуст","warning");if(!this.sketchManager.currentPlane)return void this.sketchManager.editor.showStatus("Нет активного скетча для вставки","error");const e=[];this.clipboard.forEach(t=>{const s=JSON.parse(JSON.stringify(t));s.points&&(s.points=s.points.map(e=>[e[0]+5,e[1]+5]));const i=s.points.map(e=>new THREE.Vector3(e[0],e[1],0)),n={type:s.type,points:i,color:s.color,isClosed:s.closed,dashed:s.dashed,dashSize:s.dashSize,gapSize:s.gapSize,radius:s.radius,width:s.width,height:s.height,center:s.center?new THREE.Vector3(s.center[0],s.center[1],0):void 0};this._addElementToPlane(n),e.push(this.elements[this.elements.length-1])}),this.updateSketch(),this.clearSelection(),e.forEach(e=>{this.selectedElements.push(e),this.highlightElement(e)}),this.sketchManager.editor.showStatus(`Вставлено элементов: ${e.length}`,"success")}getCurrentSketchState(){return this.elements.map(e=>this._elementToData(e))}selectElement(e){this.clearSelection(),this.selectedElements=[e],this.highlightElement(e),this.sketchManager.editor.showStatus(`Выбран элемент: ${this.getToolName(e.type)}`,"info")}toggleElementSelection(e){const t=this.selectedElements.indexOf(e);t>-1?(this.unhighlightElement(e),this.selectedElements.splice(t,1)):(this.selectedElements.push(e),this.highlightElement(e)),this.sketchManager.editor.showStatus(`Выбрано элементов: ${this.selectedElements.length}`,"info")}selectAllElements(){this.clearSelection(),this.selectedElements=[...this.elements],this.selectedElements.forEach(e=>this.highlightElement(e)),this.sketchManager.editor.showStatus(`Выбрано всех элементов: ${this.selectedElements.length}`,"info")}clearSelection(){this.selectedElements.forEach(e=>this.unhighlightElement(e)),this.selectedElements=[]}highlightElement(e){e.mesh&&e.mesh.material&&(e.originalColor||(e.originalColor=e.mesh.material.color.clone(),void 0!==e.mesh.material.linewidth&&(e.originalLinewidth=e.mesh.material.linewidth)),e.mesh.material.color.set(this.sketchManager.highlightColor),e.mesh.material.needsUpdate=!0,void 0!==e.mesh.material.linewidth&&(e.mesh.material.linewidth=4,e.mesh.material.needsUpdate=!0),console.log("Highlight element",e.type,e.mesh.uuid,e.mesh.material.color.getHex()))}unhighlightElement(e){e.mesh&&e.mesh.material&&e.originalColor&&(e.mesh.material.color.copy(e.originalColor),e.mesh.material.needsUpdate=!0,void 0!==e.mesh.material.linewidth&&void 0!==e.originalLinewidth&&(e.mesh.material.linewidth=e.originalLinewidth,e.mesh.material.needsUpdate=!0,delete e.originalLinewidth),delete e.originalColor)}getElementAtPoint(e){if(!this.sketchManager.currentPlane)return null;for(let t=this.elements.length-1;t>=0;t--){const s=this.elements[t];if(!s.mesh)continue;const i=s.mesh.userData?.points||[];for(let t=0;t<i.length-1;t++){const n=i[t],a=i[t+1];if(!n||!a)continue;if(this.pointToLineDistance(e,n,a)<=.1)return s}if(i.length>=3&&s.isClosed){const t=i[i.length-1],n=i[0];if(t&&n){if(this.pointToLineDistance(e,t,n)<=.1)return s}}}return null}pointToLineDistance(e,t,s){const i=e.x-t.x,n=e.y-t.y,a=s.x-t.x,h=s.y-t.y,l=a*a+h*h;let r,o,c=-1;0!==l&&(c=(i*a+n*h)/l),c<0?(r=t.x,o=t.y):c>1?(r=s.x,o=s.y):(r=t.x+c*a,o=t.y+c*h);const d=e.x-r,m=e.y-o;return Math.sqrt(d*d+m*m)}updateElementGeometry(e){if(!e||!e.geometry||!e.userData.points)return;const t=[];e.userData.points.forEach(e=>t.push(e.x,e.y,0)),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),e.geometry.attributes.position.needsUpdate=!0,e.computeLineDistances&&e.computeLineDistances()}showSuccessMessage(e){this.sketchManager.editor.showStatus(`Добавлен элемент: ${{line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polygon:"Многоугольник",polyline:"Полилиния",arc:"Дуга",oval:"Овал",stadium:"Стадион",mirror:"Симметрия","dashed-line":"Пунктирная линия",dimension:"Размер"}[e]||e}`,"success")}getToolName(e){return{line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polygon:"Многоугольник",polyline:"Полилиния",arc:"Дуга",oval:"Овал",stadium:"Стадион",mirror:"Симметрия","dashed-line":"Пунктирная линия",dimension:"Размер"}[e]||e}collectSketchElements(e){return this.elements=[],this.selectedElements=[],e.children.forEach(e=>{if(e.userData&&"sketch_element"===e.userData.type){e.frustumCulled=!1;const t=e.userData.points||[],s={type:e.userData.elementType,mesh:e,points:t.map(e=>e.clone()),color:e.userData.originalColor||this.sketchManager.sketchColor,isClosed:e.userData.closed||!1,dashed:e.userData.dashed||!1,dashSize:e.userData.dashSize,gapSize:e.userData.gapSize,radius:e.userData.radius,width:e.userData.width,height:e.userData.height,center:e.userData.center?e.userData.center.clone():void 0};this.elements.push(s)}}),this.elements.length}clearAllElementsFromPlane(){const e=this.sketchManager.currentPlane;if(!e)return;const t=[];e.children.forEach(e=>{e.userData&&"sketch_element"===e.userData.type&&t.push(e)}),t.forEach(t=>{e.remove(t),t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.elements=[],this.selectedElements=[]}clear(){this.elements.forEach(e=>this.unhighlightElement(e)),this.elements=[],this.selectedElements=[]}}