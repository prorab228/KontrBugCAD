class SketchElementManager{constructor(e,t){this.sketchManager=e,this.elements=[],this.selectedElements=[],this.snapHelper=t}addElement(e){if(!e||!e.type)return;const t=this.getCurrentSketchState(),s=["rectangle","circle","polygon","oval","stadium","arc"].includes(e.type),i=this.createElementGeometry(e,s);if(!i)return;const a=this.createElementMesh(e,i,s);a.userData=this.createElementUserData(e,a,s),this.sketchManager.currentPlane.add(a),e.mesh=a,this.elements.push(e),this.sketchManager.editor.history&&this.sketchManager.editor.history.addAction({type:"sketch_add",sketchPlaneId:this.sketchManager.currentPlane.uuid,previousSketchState:t,elements:[{uuid:a.uuid,data:this.serializeSketchElement(a)}]}),this.snapHelper&&this.snapHelper.updateSnapPoints(),this.showSuccessMessage(e.type)}createElementGeometry(e,t){const s=e.points?e.points.map(e=>this.sketchManager.currentPlane.worldToLocal(e.clone())):[],i=[];s.forEach(e=>{i.push(e.x,e.y,.01)});const a=new THREE.BufferGeometry;return a.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),a}createElementMesh(e,t,s){let i;if("dashedline"===e.type){const s=new THREE.LineDashedMaterial({color:new THREE.Color(e.color||this.sketchManager.sketchColor),linewidth:2,dashSize:e.dashSize||1,gapSize:e.gapSize||1,scale:1});i=new THREE.Line(t,s),i.computeLineDistances()}else i=s?new THREE.LineLoop(t,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchManager.sketchColor),linewidth:2})):new THREE.Line(t,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchManager.sketchColor),linewidth:2}));return i}createElementUserData(e,t,s){const i={type:"sketch_element",elementType:e.type,isClosed:s,originalColor:new THREE.Color(e.color||this.sketchManager.sketchColor),sketchPlaneId:this.sketchManager.currentPlane.uuid,localPoints:e.points?e.points.map(e=>this.sketchManager.currentPlane.worldToLocal(e.clone())):[],createdAt:(new Date).toISOString()};return["center","radius","diameter","width","height","radiusX","radiusY","sides","dashSize","gapSize","startAngle","endAngle","start","end","length"].forEach(t=>{void 0!==e[t]&&(i[t]=e[t],("center"===t||"start"===t||"end"===t)&&e[t]&&this.sketchManager.currentPlane&&(i[`${t}Local`]=this.sketchManager.currentPlane.worldToLocal(e[t].clone())))}),i}showSuccessMessage(e){this.sketchManager.editor.showStatus(`Добавлен элемент: ${{line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polygon:"Многоугольник",polyline:"Полилиния",arc:"Дуга",oval:"Овал",stadium:"Стадион",mirror:"Симметрия","dashed-line":"Пунктирная линия",dimension:"Размер"}[e]||e}`,"success")}serializeSketchElement(e){return e?this.sketchManager.editor.projectManager?this.sketchManager.editor.projectManager.serializeObject(e):{uuid:e.uuid,type:e.type,userData:{...e.userData},geometry:e.geometry?{type:e.geometry.type,parameters:e.geometry.parameters||{},attributes:e.geometry.attributes?{position:Array.from(e.geometry.attributes.position.array)}:{}}:null,material:e.material?{type:e.material.type,color:e.material.color?e.material.color.getHex():0,linewidth:e.material.linewidth||2}:null}:null}getCurrentSketchState(){if(!this.sketchManager.currentPlane)return null;const e={planeId:this.sketchManager.currentPlane.uuid,elements:[]};return this.sketchManager.currentPlane.children.forEach(t=>{if(t.userData&&"sketch_element"===t.userData.type){const s=this.serializeSketchElement(t);s&&e.elements.push({uuid:t.uuid,data:s})}}),e}updateElementsFromPlane(){this.sketchManager.currentPlane&&(this.elements=[],this.selectedElements=[],this.sketchManager.currentPlane.children.forEach(e=>{if(e.userData&&"sketch_element"===e.userData.type){const t={type:e.userData.elementType,mesh:e,originalColor:e.userData.originalColor||new THREE.Color(this.sketchManager.sketchColor),color:e.userData.originalColor||this.sketchManager.sketchColor,localPoints:e.userData.localPoints,localPosition:e.userData.localPosition,isClosed:e.userData.isClosed,sketchPlaneId:e.userData.sketchPlaneId,userData:e.userData};this.elements.push(t)}}))}removeElementFromArrays(e){const t=e.mesh||e,s=this.elements.findIndex(e=>e.mesh===t);s>-1&&this.elements.splice(s,1);const i=this.selectedElements.findIndex(e=>e.mesh===t);i>-1&&this.selectedElements.splice(i,1)}getElementAtPoint(e){if(!this.sketchManager.currentPlane)return null;const t=this.sketchManager.currentPlane.worldToLocal(e.clone());for(let e=this.elements.length-1;e>=0;e--){const s=this.elements[e];if(!s.mesh)continue;const i=s.mesh.userData?.localPoints||[];for(let e=0;e<i.length-1;e++){const a=i[e],r=i[e+1];if(!a||!r)continue;if(this.pointToLineDistance(t,a,r)<=.1)return s}if(i.length>=3&&s.mesh.userData?.isClosed){const e=i[i.length-1],a=i[0];if(e&&a){if(this.pointToLineDistance(t,e,a)<=.1)return s}}}return null}pointToLineDistance(e,t,s){const i=e.x-t.x,a=e.y-t.y,r=s.x-t.x,l=s.y-t.y,n=r*r+l*l;let o,h,c=-1;0!==n&&(c=(i*r+a*l)/n),c<0?(o=t.x,h=t.y):c>1?(o=s.x,h=s.y):(o=t.x+c*r,h=t.y+c*l);const m=e.x-o,d=e.y-h;return Math.sqrt(m*m+d*d)}selectElement(e){this.clearSelection(),this.selectedElements=[e],this.highlightElement(e),console.log("select sketch Element",this.selectedElements),this.sketchManager.editor.showStatus(`Выбран элемент: ${this.getToolName(e.type)}`,"info")}toggleElementSelection(e){const t=this.selectedElements.indexOf(e);t>-1?(this.unhighlightElement(e),this.selectedElements.splice(t,1)):(this.selectedElements.push(e),this.highlightElement(e)),this.sketchManager.editor.showStatus(`Выбрано элементов: ${this.selectedElements.length}`,"info")}selectAllElements(){this.clearSelection(),this.selectedElements=[...this.elements],this.selectedElements.forEach(e=>this.highlightElement(e)),this.sketchManager.editor.showStatus(`Выбрано всех элементов: ${this.selectedElements.length}`,"info")}clearSelection(){this.selectedElements.forEach(e=>this.unhighlightElement(e)),this.selectedElements=[]}highlightElement(e){if(e.mesh&&e.mesh.material){if(!e.originalColor){if(e.mesh.material.color instanceof THREE.Color)e.originalColor=e.mesh.material.color.clone();else if(e.mesh.userData?.originalColor instanceof THREE.Color)e.originalColor=e.mesh.userData.originalColor.clone();else{let t=1118481;if(void 0!==e.mesh.material.color)if("number"==typeof e.mesh.material.color)t=e.mesh.material.color;else if("string"==typeof e.mesh.material.color)try{t=new THREE.Color(e.mesh.material.color).getHex()}catch(e){console.warn("Error parsing color string:",e)}e.originalColor=new THREE.Color(t)}void 0!==e.mesh.material.linewidth&&(e.originalLinewidth=e.mesh.material.linewidth)}e.mesh.material.color.set(this.sketchManager.highlightColor),e.mesh.material.needsUpdate=!0,void 0!==e.mesh.material.linewidth&&(e.mesh.material.linewidth=4,e.mesh.material.needsUpdate=!0)}}unhighlightElement(e){e.mesh&&e.mesh.material&&e.originalColor&&(e.originalColor instanceof THREE.Color?e.mesh.material.color.copy(e.originalColor):e.mesh.material.color.set(e.originalColor),e.mesh.material.needsUpdate=!0,void 0!==e.mesh.material.linewidth&&void 0!==e.originalLinewidth&&(e.mesh.material.linewidth=e.originalLinewidth,e.mesh.material.needsUpdate=!0,delete e.originalLinewidth),delete e.originalColor)}deleteSelectedElements(){if(0===this.selectedElements.length)return void this.sketchManager.editor.showStatus("Нет выделенных элементов для удаления","warning");if(!confirm(`Удалить ${this.selectedElements.length} элементов?`))return;const e=this.getCurrentSketchState(),t=[...this.selectedElements];this.sketchManager.editor.history&&this.sketchManager.editor.history.addAction({type:"sketch_delete",sketchPlaneId:this.sketchManager.currentPlane.uuid,previousSketchState:e,elements:t.map(e=>({uuid:e.mesh.uuid,data:this.serializeSketchElement(e.mesh)}))}),t.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose());const t=this.elements.indexOf(e);t>-1&&this.elements.splice(t,1)}),this.selectedElements=[],this.snapHelper&&this.snapHelper.updateSnapPoints(),this.sketchManager.editor.showStatus(`Удалено элементов: ${t.length}`,"success")}deleteAllElements(){if(0===this.elements.length)return;if(!confirm("Очистить весь чертеж?"))return;const e=this.getCurrentSketchState();this.sketchManager.editor.history&&this.sketchManager.editor.history.addAction({type:"sketch_delete",sketchPlaneId:this.sketchManager.currentPlane.uuid,previousSketchState:e,elements:this.elements.map(e=>({uuid:e.mesh.uuid,data:this.serializeSketchElement(e.mesh)}))}),this.elements.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose())}),this.elements=[],this.selectedElements=[],this.sketchManager.editor.showStatus("Чертеж очищен","success")}getToolName(e){return{line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polygon:"Многоугольник",polyline:"Полилиния",arc:"Дуга",oval:"Овал",stadium:"Стадион",mirror:"Симметрия","dashed-line":"Пунктирная линия",dimension:"Размер"}[e]||e}collectSketchElements(e){return this.elements=[],this.selectedElements=[],e.children.forEach(t=>{if(t.userData&&"sketch_element"===t.userData.type){const s={type:t.userData.elementType,mesh:t,originalColor:t.userData.originalColor||new THREE.Color(this.sketchManager.sketchColor),color:t.userData.originalColor||this.sketchManager.sketchColor,localPoints:t.userData.localPoints,localPosition:t.userData.localPosition,isClosed:t.userData.isClosed,sketchPlaneId:t.userData.sketchPlaneId,userData:t.userData};if(t.userData.centerLocal){let i=t.userData.centerLocal;i.isVector3||(i=new THREE.Vector3(i.x||0,i.y||0,i.z||0)),s.center=e.localToWorld(i)}void 0!==t.userData.radius&&(s.radius=t.userData.radius),void 0!==t.userData.width&&(s.width=t.userData.width),void 0!==t.userData.height&&(s.height=t.userData.height),this.elements.push(s)}}),this.elements.length}clear(){this.elements.forEach(e=>this.unhighlightElement(e)),this.elements=[],this.selectedElements=[]}}