class SketchTool extends Tool{constructor(e){super("sketch","fa-drafting-compass",e),this.sketchMode=null,this.currentSketchPlane=null,this.sketchManager=e.sketchManager,this.initSketchTools()}initSketchTools(){document.querySelectorAll(".sketch-tool-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sketchTool;console.log("sketch-tool-btn down",t),this.sketchManager&&this.sketchManager.toolManager.setCurrentTool(t)})}),document.getElementById("sketchDeleteBtn").addEventListener("click",()=>{this.sketchManager&&this.sketchManager.deleteSelected()}),document.getElementById("sketchClearBtn").addEventListener("click",()=>{this.sketchManager&&this.sketchManager.clearSketch()}),document.getElementById("exitSketchBtn").addEventListener("click",()=>{this.exitSketchMode()}),document.getElementById("toggleSketchGrid").addEventListener("click",()=>{this.sketchManager&&(this.sketchManager.toggleGrid(),this.editor.showStatus("Сетка скетча: "+(this.sketchManager.gridVisible?"вкл":"выкл"),"info"))})}openSketch(){if("drawing"!==this.sketchMode){if(1===this.editor.selectedObjects.length){const e=this.editor.selectedObjects[0];if("sketch_plane"===e.userData.type)return void this.editExistingSketch(e);if("work_plane"===e.userData.type)return void this.startSketchOnPlane(e)}this.editor.showStatus("Выберите плоскость для скетча (рабочую или скетч-плоскость)","error"),this.editor.toolManager.setCurrentTool("select")}else this.exitSketchMode()}editExistingSketch(e){this.sketchManager&&(this.sketchMode="drawing",this.sketchManager.editExistingSketch(e),document.getElementById("sketchToolsSection").style.display="flex",document.getElementById("workToolsSection").style.display="none",this.editor.clearSelection(),this.editor.showStatus("Режим редактирования скетча. Используйте инструменты рисования.","info"))}startSketchOnPlane(e){const t=this.editor.planesManager.createSketchPlaneObject();t.position.copy(e.position),t.quaternion.copy(e.quaternion),this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.sketchPlanes.push(t),this.currentSketchPlane=t,this.sketchMode="drawing",document.getElementById("sketchToolsSection").style.display="flex",document.getElementById("workToolsSection").style.display="none",this.sketchManager&&(this.sketchManager.startSketchOnPlane(t),this.sketchManager.toolManager.setCurrentTool("select")),e.visible=!1,this.editor.showStatus("Режим скетча: используйте инструменты рисования","info")}exitSketchMode(){null!==this.sketchMode&&(this.sketchMode=null,this.currentSketchPlane=null,document.getElementById("sketchToolsSection").style.display="none",document.getElementById("workToolsSection").style.display="flex",this.sketchManager&&this.sketchManager.exitSketchMode(),this.editor.toolManager.setCurrentTool("select"),this.editor.showStatus("Режим скетча завершен","info"))}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","sketch"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="sketch"]');e&&e.remove()}getPropertiesHTML(){this.editor.gridUnit,this.sketchManager.gridStep;return`\n            <div class="property-group" data-type="sketch-settings">\n                <h4>СКЕТЧ</h4>\n                <div class="property-row">\n                    <label>Обнаружение замкнутых контуров (экспериментальное):</label>\n                    <input type="checkbox" id="autoDetectContours" ${this.sketchManager.contourManager.autoDetectContours?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <h5>Настройки сетки</h5>\n                </div>\n                <div class="property-row">\n                    <label>Привязка к сетке:</label>\n                    <input type="checkbox" id="gridSnapEnabled" ${this.sketchManager.snapHelper.gridSnapEnabled?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Показывать сетку:</label>\n                    <input type="checkbox" id="gridVisible" ${this.sketchManager.viewManager.gridVisible?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Шаг сетки:</label>\n                    <select id="gridStep" style="width: 120px;">\n                        \x3c!-- Опции будут заполнены JavaScript --\x3e\n                    </select>\n                </div>\n                <div class="property-row">\n                    <label>Включить привязку к линиям:</label>\n                    <input type="checkbox" id="lineSnapEnabled" ${this.sketchManager.snapHelper.lineSnapEnabled?"checked":""}>\n                </div>\n            </div>\n        `}updateGridStepOptions(e=this.editor.gridUnit,t=this.sketchManager.gridStep){const s=this.propertiesElement.querySelector("#gridStep");if(s.innerHTML="","mm"===e){[.1,.2,.5,1,2,5,10].forEach(e=>{const n=document.createElement("option");n.value=e,n.textContent=`${e} мм`,Math.abs(e-t)<.001&&(n.selected=!0),s.appendChild(n)})}else{[{value:1/64,label:'1/64"'},{value:1/32,label:'1/32"'},{value:1/16,label:'1/16"'},{value:1/8,label:'1/8"'},{value:1/4,label:'1/4"'},{value:.5,label:'1/2"'},{value:1,label:'1"'}].forEach(e=>{const n=document.createElement("option");n.value=e.value,n.textContent=e.label,Math.abs(e.value-t)<.001&&(n.selected=!0),s.appendChild(n)})}}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#autoDetectContours");e&&(e.checked=this.sketchManager.contourManager.autoDetectContours,e.addEventListener("change",e=>{this.sketchManager.contourManager.autoDetectContours=e.target.checked}));const t=this.propertiesElement.querySelector("#gridSnapEnabled");t&&(t.checked=this.sketchManager.snapHelper.gridSnapEnabled,t.addEventListener("change",e=>{this.sketchManager.snapHelper.gridSnapEnabled=e.target.checked}));const s=this.propertiesElement.querySelector("#gridVisible");s&&(s.checked=this.sketchManager.viewManager.gridVisible,s.addEventListener("change",e=>{this.sketchManager.viewManager.setGridVisible(e.target.checked)}));const n=this.propertiesElement.querySelector("#gridStep");if(n){const e=this.editor.gridUnit||"mm",t=this.sketchManager.gridStep||1;this.updateGridStepOptions(e,t),n.addEventListener("change",e=>{const t=parseFloat(e.target.value);localStorage.setItem("cad-sketch-step",t),this.sketchManager.gridStep=t,this.sketchManager.viewManager.updateGrid();const s="mm"===this.editor.gridUnit?"мм":1===t?"дюйм":"дюйма";this.editor.showStatus(`Шаг сетки скетча: ${t} ${s}`,"info")})}const i=this.propertiesElement.querySelector("#lineSnapEnabled");i&&(i.checked=this.sketchManager.snapHelper.lineSnapEnabled,i.addEventListener("change",e=>{this.sketchManager.snapHelper.lineSnapEnabled=e.target.checked}))}onActivate(){this.openSketch(),this.createPropertiesSection()}onDeactivate(){this.exitSketchMode(),this.removePropertiesSection()}onMouseDown(e){return!("drawing"!==this.sketchMode||!this.sketchManager)&&this.sketchManager.onMouseDown(e)}onMouseMove(e){"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onMouseMove(e)}onMouseUp(e){"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onMouseUp(e)}onKeyDown(e){return!("drawing"!==this.sketchMode||!this.sketchManager)&&this.sketchManager.onKeyDown(e)}onKeyUp(e){return!("drawing"!==this.sketchMode||!this.sketchManager)&&this.sketchManager.onKeyUp(e)}}