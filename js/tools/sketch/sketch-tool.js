class SketchTool extends Tool{constructor(e){super("sketch","fa-drafting-compass",e),this.sketchMode=null,this.currentSketchPlane=null,this.sketchManager=e.sketchManager,this.initSketchTools(),this.sketchOnlyElements=[]}initSketchTools(){document.querySelectorAll(".sketch-tool-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sketchTool;console.log("sketch-tool-btn down",t),this.sketchManager&&this.sketchManager.toolManager.setCurrentTool(t)})}),document.getElementById("sketchDeleteBtn").addEventListener("click",()=>{this.sketchManager&&this.sketchManager.deleteSelected()}),document.getElementById("sketchClearBtn").addEventListener("click",()=>{this.sketchManager&&this.sketchManager.clearSketch()}),document.getElementById("exitSketchBtn").addEventListener("click",()=>{this.exitSketchMode()});const e=document.getElementById("importSketchSVG"),t=document.getElementById("exportSketchSVG");e&&(this.importHandler=()=>this.sketchManager.importSVG(),e.addEventListener("click",this.importHandler)),t&&(this.exportHandler=()=>this.sketchManager.exportSVG(),t.addEventListener("click",this.exportHandler))}openSketch(){if("drawing"!==this.sketchMode){if(1===this.editor.selectedObjects.length){const e=this.editor.selectedObjects[0];if("sketch_plane"===e.userData.type)return void this.editExistingSketch(e);if("work_plane"===e.userData.type)return void this.startSketchOnPlane(e)}this.editor.showStatus("Выберите плоскость для скетча (рабочую или скетч-плоскость)","error"),this.editor.toolManager.restorePreviousTool()}else this.exitSketchMode()}editExistingSketch(e){this.sketchManager&&(this.sketchMode="drawing",this.sketchManager.editExistingSketch(e),document.getElementById("sketchToolsSection").style.display="flex",document.getElementById("workToolsSection").style.display="none",this.editor.clearSelection(),this.editor.showStatus("Режим редактирования скетча. Используйте инструменты рисования.","info"))}startSketchOnPlane(e){const t=this.editor.planesManager.createSketchPlaneObject();t.position.copy(e.position),t.quaternion.copy(e.quaternion),this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.sketchPlanes.push(t),this.editor.history&&this.editor.history.addAction({type:"create",object:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}),this.currentSketchPlane=t,this.sketchMode="drawing",document.getElementById("sketchToolsSection").style.display="flex",document.getElementById("workToolsSection").style.display="none",this.sketchManager&&(this.sketchManager.startSketchOnPlane(t),this.sketchManager.toolManager.setCurrentTool("select")),e.visible=!1,this.editor.showStatus("Режим скетча: используйте инструменты рисования","info")}exitSketchMode(){null!==this.sketchMode&&(this.sketchMode=null,this.currentSketchPlane=null,document.getElementById("sketchToolsSection").style.display="none",document.getElementById("workToolsSection").style.display="flex",this.sketchManager&&this.sketchManager.exitSketchMode(),this.editor.toolManager.setCurrentTool("select"),this.editor.showStatus("Режим скетча завершен","info"))}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","sketch"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents(),console.log("createPropertiesSection"))}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="sketch"]');console.log("removePropertiesSection",e),e&&e.remove()}showSketchOnlyElements(){document.querySelectorAll(".sketch-only").forEach(e=>{e.style.display="block ",this.sketchOnlyElements.push(e)})}hideSketchOnlyElements(){this.sketchOnlyElements.forEach(e=>{e.style.display="none"}),this.sketchOnlyElements=[]}getPropertiesHTML(){this.editor.gridUnit,this.sketchManager.gridStep;const e=this.sketchManager.gridSize||this.sketchManager.viewManager.gridSize||50,t=this.sketchManager.getOutlineEnabled();return console.log("outlineEnabled",t),`\n            <div class="property-group" data-type="sketch-settings">\n                <h4>СКЕТЧ</h4>\n                <div class="property-row">\n                    <h5>Настройки сетки</h5>\n                </div>\n                <div class="property-row">\n                    <label>Привязка к сетке:</label>\n                    <input type="checkbox" id="gridSnapEnabled" ${this.sketchManager.snapHelper.gridSnapEnabled?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Показывать сетку:</label>\n                    <input type="checkbox" id="gridVisible" ${this.sketchManager.viewManager.gridVisible?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Шаг сетки:</label>\n                    <select id="gridStep" class="property-select">\n                        \x3c!-- Опции будут заполнены JavaScript --\x3e\n                    </select>\n                </div>\n                <div class="property-row">\n                    <label>Размер сетки (мм):</label>\n                    <input type="range" id="gridSize" min="10" max="500" step="10" value="${e}">\n                    <span id="gridSizeValue">${e}</span>\n                </div>\n                <div class="property-row">\n                    <label>Включить привязку к линиям:</label>\n                    <input type="checkbox" id="lineSnapEnabled" ${this.sketchManager.snapHelper.lineSnapEnabled?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Привязка к углам (⊥/∥):</label>\n                    <input type="checkbox" id="angleSnapEnabled" ${this.sketchManager.snapHelper.angleSnapEnabled?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <h5>Автообводка граней</h5>\n                </div>\n                <div class="property-row">\n                    <label>Автоматическая обводка граней:</label>\n                    <input type="checkbox" id="outlineEnabled" ${t?"checked":""}>\n                </div>\n                <p class="property-hint">\n                    При создании скетча на грани объекта автоматически добавляется ее контур.\n                </p>\n\n                <div class="property-row">\n                    <h5>Панорамирование</h5>\n                </div>\n                <div class="property-row">\n                    <label>Включить панорамирование:</label>\n                    <input type="checkbox" id="panningEnabled" ${this.sketchManager.panningEnabled?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Скорость панорамирования:</label>\n                    <input type="range" id="panSpeed" min="0.5" max="8" step="0.5" value="${this.sketchManager.panSpeed}">\n                    <span id="panSpeedValue" >${this.sketchManager.panSpeed}</span>\n                </div>\n                <div class="property-row">\n                    <label>Порог панорамирования:</label>\n                    <input type="range" id="panThreshold" min="10" max="100" step="10" value="${this.sketchManager.panEdgeThreshold}" >\n                    <span id="panThresholdValue" >${this.sketchManager.panEdgeThreshold}</span>\n                </div>\n            </div>\n        `}updateGridStepOptions(e=this.editor.gridUnit,t=this.sketchManager.gridStep){const n=this.propertiesElement.querySelector("#gridStep");if(n.innerHTML="","mm"===e){[.1,.2,.5,1,2,5,10].forEach(e=>{const s=document.createElement("option");s.value=e,s.textContent=`${e} мм`,Math.abs(e-t)<.001&&(s.selected=!0),n.appendChild(s)})}else{[{value:1/64,label:'1/64"'},{value:1/32,label:'1/32"'},{value:1/16,label:'1/16"'},{value:1/8,label:'1/8"'},{value:1/4,label:'1/4"'},{value:.5,label:'1/2"'},{value:1,label:'1"'}].forEach(e=>{const s=document.createElement("option");s.value=e.value,s.textContent=e.label,Math.abs(e.value-t)<.001&&(s.selected=!0),n.appendChild(s)})}}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#gridSnapEnabled");e&&(e.checked=this.sketchManager.snapHelper.gridSnapEnabled,e.addEventListener("change",e=>{this.sketchManager.snapHelper.gridSnapEnabled=e.target.checked}));const t=this.propertiesElement.querySelector("#gridVisible");t&&(t.checked=this.sketchManager.viewManager.gridVisible,t.addEventListener("change",e=>{this.sketchManager.viewManager.setGridVisible(e.target.checked)}));const n=this.propertiesElement.querySelector("#gridStep");if(n){const e=this.editor.gridUnit||"mm",t=this.sketchManager.gridStep||1;this.updateGridStepOptions(e,t),n.addEventListener("change",e=>{const t=parseFloat(e.target.value);localStorage.setItem("cad-sketch-step",t),this.sketchManager.gridStep=t,this.sketchManager.viewManager.updateGrid();const n="mm"===this.editor.gridUnit?"мм":1===t?"дюйм":"дюйма";this.editor.showStatus(`Шаг сетки скетча: ${t} ${n}`,"info")})}const s=this.propertiesElement.querySelector("#gridSize"),a=this.propertiesElement.querySelector("#gridSizeValue");if(s&&a){const e=this.sketchManager.gridSize||this.sketchManager.viewManager.gridSize||50;s.value=e,a.textContent=e,s.addEventListener("input",e=>{const t=parseInt(e.target.value);a.textContent=t}),s.addEventListener("change",e=>{const t=parseInt(e.target.value);this.sketchManager&&(this.sketchManager.gridSize=t,this.sketchManager.viewManager&&(this.sketchManager.viewManager.gridSize=t),this.sketchManager.viewManager.updateGrid()),this.editor.showStatus(`Размер сетки изменен: ${t} мм`,"info")})}const i=this.propertiesElement.querySelector("#lineSnapEnabled");i&&(i.checked=this.sketchManager.snapHelper.lineSnapEnabled,i.addEventListener("change",e=>{this.sketchManager.snapHelper.lineSnapEnabled=e.target.checked}));const r=this.propertiesElement.querySelector("#angleSnapEnabled");r&&(r.checked=this.sketchManager.snapHelper.angleSnapEnabled,r.addEventListener("change",e=>{this.sketchManager.snapHelper.angleSnapEnabled=e.target.checked,e.target.checked||(this.sketchManager.snapHelper.hidePerpendicularGuide(),this.sketchManager.snapHelper.perpendicularActive=!1,this.sketchManager.snapHelper.parallelActive=!1)}));const o=this.propertiesElement.querySelector("#outlineEnabled");o&&(o.checked=this.sketchManager.getOutlineEnabled(),o.addEventListener("change",e=>{const t=e.target.checked,n=this.sketchManager.setOutlineEnabled(t);this.editor.showStatus("Автообводка граней "+(n?"включена":"отключена"),"info")}));const h=this.propertiesElement.querySelector("#panningEnabled");h&&(h.checked=this.sketchManager.panningEnabled,h.addEventListener("change",e=>{const t=e.target.checked;this.sketchManager.togglePanning(t),this.editor.showStatus("Панорамирование у края экрана "+(t?"включено":"отключено"),"info")}));const l=this.propertiesElement.querySelector("#panSpeed"),c=this.propertiesElement.querySelector("#panSpeedValue");l&&c&&(l.value=this.sketchManager.panSpeed,c.textContent=this.sketchManager.panSpeed,l.addEventListener("input",e=>{const t=parseFloat(e.target.value);c.textContent=t}),l.addEventListener("change",e=>{const t=parseFloat(e.target.value);this.sketchManager.setPanSpeed(t),this.editor.showStatus(`Скорость панорамирования: ${t}`,"info")}));const d=this.propertiesElement.querySelector("#panThreshold"),p=this.propertiesElement.querySelector("#panThresholdValue");d&&p&&(d.value=this.sketchManager.panEdgeThreshold,p.textContent=this.sketchManager.panEdgeThreshold,d.addEventListener("input",e=>{const t=parseFloat(e.target.value);p.textContent=t}),d.addEventListener("change",e=>{const t=parseFloat(e.target.value);this.sketchManager.setPanThreshold(t),this.editor.showStatus(`Порог панорамирования: ${t}px`,"info")}))}onActivate(){this.createPropertiesSection(),this.showSketchOnlyElements(),this.openSketch(),this.editor.clearSelection(!1)}onDeactivate(){console.log("Sketch deactivate"),this.removePropertiesSection(),this.hideSketchOnlyElements(),this.exitSketchMode()}onMouseDown(e){return!("drawing"!==this.sketchMode||!this.sketchManager)&&this.sketchManager.onMouseDown(e)}onMouseMove(e){"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onMouseMove(e)}onMouseUp(e){"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onMouseUp(e)}onKeyDown(e){return!("drawing"!==this.sketchMode||!this.sketchManager)&&this.sketchManager.onKeyDown(e)}onKeyUp(e){return!("drawing"!==this.sketchMode||!this.sketchManager)&&this.sketchManager.onKeyUp(e)}}