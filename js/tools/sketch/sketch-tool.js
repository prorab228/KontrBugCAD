import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"../tool.js";export class SketchTool extends Tool{constructor(e){super("sketch","fa-drafting-compass",e),this.sketchMode=null,this.faceSelectionObject=null,this.tempSketchPlane=null,this.hoveredPlane=null,this.hoveredObject=null,this.currentIntersection=null,this.sketchManager=e.sketchManager,this.planesManager=e.planesManager,this.sketchOnlyElements=[],this.propertiesElement=null;const t=localStorage.getItem("cad-face-grouping");null!==t&&this.planesManager.setFaceGroupingEnabled("true"===t),this.originalPlaneOpacity=1,this.initSketchTools()}showSketchOnlyElements(){document.querySelectorAll(".sketch-only").forEach(e=>{e.style.display="block",this.sketchOnlyElements.push(e)})}hideSketchOnlyElements(){this.sketchOnlyElements.forEach(e=>{e.style.display="none"}),this.sketchOnlyElements=[]}initSketchTools(){document.querySelectorAll(".sketch-tool-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sketchTool;this.sketchManager&&"drawing"===this.sketchMode&&(this.sketchManager.toolManager.setCurrentTool(t),this.sketchManager.updateToolButtons())})});const e=document.getElementById("sketchDeleteBtn");e&&e.addEventListener("click",()=>{this.sketchManager&&"drawing"===this.sketchMode&&this.sketchManager.deleteSelected()});const t=document.getElementById("sketchClearBtn");t&&t.addEventListener("click",()=>{this.sketchManager&&"drawing"===this.sketchMode&&this.sketchManager.clearSketch()});const n=document.getElementById("exitSketchBtn");n&&n.addEventListener("click",()=>{this.exitSketchMode()});const r=document.getElementById("importSketchSVG");r&&(this.importHandler=()=>this.sketchManager?.importSVG(),r.addEventListener("click",this.importHandler));const a=document.getElementById("exportSketchSVG");a&&(this.exportHandler=()=>this.sketchManager?.exportSVG(),a.addEventListener("click",this.exportHandler))}startSketchSelection(){this.sketchMode="selecting",this.editor.basePlanes&&(this.editor.basePlanes.visible=!0),this.editor.showStatus("Выберите базовую плоскость, рабочую плоскость или грань любого объекта для создания скетча","info")}editExistingSketch(e,t=!1){this.sketchMode="drawing",this.currentSketchPlane=e,this.editor.clearSelection(!1),this.hideSketchPlane(),document.getElementById("sketchToolsSection").style.display="flex",document.getElementById("workToolsSection").style.display="none",this.sketchManager&&(t?this.sketchManager.startSketchOnPlane(e):this.sketchManager.editExistingSketch(e),this.sketchManager.toolManager.setCurrentTool("select")),this.editor.basePlanes&&(this.editor.basePlanes.visible=!1),this.resetPreviousHighlight(),this.editor.showStatus("Режим редактирования скетча. Используйте инструменты рисования.","info")}handleSelection(e){if(this.currentIntersection&&this.currentIntersection.face)return this.planesManager.enableFaceGrouping?this.createSketchOnFaceCenter(this.currentIntersection):this.createSketchAtIntersectionPoint(this.currentIntersection);this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=this.getAllSelectableObjects(),n=this.editor.raycaster.intersectObjects(t,!0);if(n.length>0){const e=n[0];return this.planesManager.enableFaceGrouping?this.createSketchOnFaceCenter(e):this.createSketchAtIntersectionPoint(e)}const r=this.editor.basePlanes?this.editor.basePlanes.children:[],a=this.editor.raycaster.intersectObjects(r);if(a.length>0){const e=a[0].object;return this.createSketchOnBasePlane(e)}const s=this.editor.objectsGroup.children.filter(e=>"work_plane"===e.userData?.type),i=this.editor.raycaster.intersectObjects(s);if(i.length>0){const e=i[0].object;return this.createSketchOnWorkPlane(e)}return!1}createSketchOnFaceCenter(e){const t=this.planesManager.createWorkPlaneOnFaceIntersection(e);if(!t)return!1;t.userData.type="sketch_plane",t.userData.name="Плоскость скетча (центр грани)";const n=new ParametricOperation("create_workplane",{position:t.position.toArray(),normal:t.userData.faceNormal.toArray(),up:t.userData.originalUp.toArray(),name:"Плоскость скетча (центр грани)",planeType:"sketch_plane",parentObject:e.object.uuid,faceIndex:e.faceIndex},[]),r=this.editor.parametricModel.addOperation(n);return setTimeout(()=>{const e=this.editor.parametricModel.objectMap.get(r[0]);e&&this.editExistingSketch(e,!0)},0),!0}createSketchAtIntersectionPoint(e){if(!e||!e.face)return!1;const t=e.object,n=e.point;let r=e.face.normal.clone();if(t.matrixWorld){const e=(new THREE.Matrix3).getNormalMatrix(t.matrixWorld);r.applyMatrix3(e).normalize()}let a=new THREE.Vector3(0,1,0);if(Math.abs(r.y)>.9)a=new THREE.Vector3(1,0,0);else{const e=a.clone().projectOnPlane(r).normalize();a=e.length()<.1?new THREE.Vector3(1,0,0).projectOnPlane(r).normalize():e}const s=new ParametricOperation("create_workplane",{position:n.toArray(),normal:r.toArray(),up:a.toArray(),name:"Плоскость скетча (точка указателя)",planeType:"sketch_plane",parentObject:t.uuid,faceIndex:e.faceIndex},[]),i=this.editor.parametricModel.addOperation(s);return setTimeout(()=>{const e=this.editor.parametricModel.objectMap.get(i[0]);e&&this.editExistingSketch(e,!0)},0),!0}createSketchOnBasePlane(e){const t=e.userData.normal?e.userData.normal:new THREE.Vector3(0,0,1),n=e.userData.up?e.userData.up:new THREE.Vector3(0,1,0),r=new ParametricOperation("create_workplane",{position:e.position.toArray(),normal:t.toArray(),up:n.toArray(),name:`Плоскость скетча на ${e.userData.planeType}`,planeType:"sketch_plane"},[]),a=this.editor.parametricModel.addOperation(r);return setTimeout(()=>{const e=this.editor.parametricModel.objectMap.get(a[0]);e&&this.editExistingSketch(e,!0)},0),!0}createSketchOnWorkPlane(e){const t=e.userData.normal?e.userData.normal:new THREE.Vector3(0,0,1),n=e.userData.up?e.userData.up:new THREE.Vector3(0,1,0),r=new ParametricOperation("create_workplane",{position:e.position.toArray(),normal:t.toArray(),up:n.toArray(),name:"Плоскость скетча на рабочей плоскости",planeType:"sketch_plane"},[]),a=this.editor.parametricModel.addOperation(r);return setTimeout(()=>{const e=this.editor.parametricModel.objectMap.get(a[0]);e&&this.editExistingSketch(e,!0)},0),!0}handleHighlight(e){this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),this.resetPreviousHighlight();let t=!1;const n=this.editor.basePlanes?this.editor.basePlanes.children:[],r=this.editor.raycaster.intersectObjects(n);if(r.length>0){t=!0;const e=r[0].object;return this.hoveredPlane=e,e.material.opacity=.4,void(document.body.style.cursor="pointer")}const a=this.editor.objectsGroup.children.filter(e=>"work_plane"===e.userData?.type),s=this.editor.raycaster.intersectObjects(a);if(s.length>0){t=!0;const e=s[0].object;return this.hoveredPlane=e,e.material.opacity=.4,void(document.body.style.cursor="pointer")}const i=this.getAllSelectableObjects(),o=this.editor.raycaster.intersectObjects(i,!0);if(o.length>0)return t=!0,this.currentIntersection=o[0],this.createOrUpdateTempSketchPlane(this.currentIntersection),void(document.body.style.cursor="pointer");t||(document.body.style.cursor="default",this.currentIntersection=null)}getAllSelectableObjects(){return this.faceSelectionObject?[this.faceSelectionObject]:this.editor.objectsGroup.children.filter(e=>{const t=e.userData?.type;return!("work_plane"===t||"sketch_plane"===t||"base_plane"===t)&&e.isMesh&&e.geometry})}createOrUpdateTempSketchPlane(e){if(!e||!e.face)return void(this.tempSketchPlane&&(this.editor.objectsGroup.remove(this.tempSketchPlane),this.tempSketchPlane.geometry.dispose(),this.tempSketchPlane.material.dispose(),this.tempSketchPlane=null));const t=e.object,n=e.point;let r,a=e.face.normal.clone();if(t.matrixWorld){const e=(new THREE.Matrix3).getNormalMatrix(t.matrixWorld);a.applyMatrix3(e).normalize()}r=this.planesManager.enableFaceGrouping?this.planesManager.getFaceCenter(t,e.faceIndex):n.clone();let s=new THREE.Vector3(0,1,0);if(Math.abs(a.y)>.9)s=new THREE.Vector3(1,0,0);else{const e=s.clone().projectOnPlane(a).normalize();s=e.length()<.1?new THREE.Vector3(1,0,0).projectOnPlane(a).normalize():e}if(!this.tempSketchPlane){const e=new THREE.PlaneGeometry(30,30),t=new THREE.MeshBasicMaterial({color:16777130,transparent:!0,opacity:.5,side:THREE.DoubleSide});this.tempSketchPlane=new THREE.Mesh(e,t),this.editor.objectsGroup.add(this.tempSketchPlane)}this.tempSketchPlane.position.copy(r);const i=new THREE.Vector3(0,0,1),o=(new THREE.Quaternion).setFromUnitVectors(i,a);this.tempSketchPlane.quaternion.copy(o);const c=a.clone().multiplyScalar(.01);this.tempSketchPlane.position.add(c)}resetPreviousHighlight(){this.hoveredPlane&&(this.hoveredPlane.material.opacity=.1,this.hoveredPlane=null),this.hoveredObject&&(this.editor.objectsManager.unhighlightObject(this.hoveredObject),this.hoveredObject=null),this.tempSketchPlane&&(this.editor.objectsGroup.remove(this.tempSketchPlane),this.tempSketchPlane.geometry.dispose(),this.tempSketchPlane.material.dispose(),this.tempSketchPlane=null)}hideSketchPlane(){this.currentSketchPlane&&(this.originalPlaneOpacity=this.currentSketchPlane.material.opacity,this.currentSketchPlane.material.opacity=0)}showSketchPlane(){this.currentSketchPlane&&(this.currentSketchPlane.material.opacity=this.originalPlaneOpacity)}exitSketchMode(){null!==this.sketchMode&&(this.showSketchPlane(),this.sketchMode=null,this.currentSketchPlane=null,this.faceSelectionObject=null,this.currentIntersection=null,document.getElementById("sketchToolsSection").style.display="none",document.getElementById("workToolsSection").style.display="flex",this.editor.basePlanes&&(this.editor.basePlanes.visible=!1),this.sketchManager&&this.sketchManager.exitSketchMode(),this.resetPreviousHighlight(),this.editor.toolManager.setCurrentTool("select"),this.editor.showStatus("Режим скетча завершен","info"))}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","sketch"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.updateGridStepOptions(),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="sketch"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){const e=this.planesManager.getFaceGroupingEnabled(),t=this.sketchManager?.snapHelper?.gridSnapEnabled??!0,n=this.sketchManager?.viewManager?.gridVisible??!0,r=this.sketchManager?.snapHelper?.lineSnapEnabled??!0,a=this.sketchManager?.snapHelper?.angleSnapEnabled??!0;return`\n            <div class="property-group" data-type="sketch-settings">\n                <h4>СКЕТЧ</h4>\n                <div class="property-row">\n                    <h5>Настройки создания на грани</h5>\n                </div>\n                <div class="property-row">\n                    <label>Центрировать по всей грани (группировка полигонов):</label>\n                    <input type="checkbox" id="faceGroupingEnabled" ${e?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <p style="font-size: 12px; color: #888; margin-top: 5px;">\n                        Если <strong>включено</strong>: плоскость создается по центру всей грани.<br>\n                        Если <strong>выключено</strong>: плоскость создается в точке указателя.\n                    </p>\n                </div>\n                <div class="property-row">\n                    <h5>Автообводка граней</h5>\n                </div>\n                <div class="property-row">\n                    <label>Автоматическая обводка граней:</label>\n                    <input type="checkbox" id="outlineEnabled" ${this.sketchManager?.getOutlineEnabled()??!1?"checked":""}>\n                </div>\n                <p class="property-hint">\n                    При создании скетча на грани объекта автоматически добавляется ее контур.\n                </p>\n                <div class="property-row">\n                    <h5>Настройки сетки</h5>\n                </div>\n                <div class="property-row">\n                    <label>Привязка к сетке:</label>\n                    <input type="checkbox" id="gridSnapEnabled" ${t?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Показывать сетку:</label>\n                    <input type="checkbox" id="gridVisible" ${n?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Шаг сетки:</label>\n                    <select id="gridStep" class="property-select"></select>\n                </div>\n                <div class="property-row">\n                    <label>Размер сетки (мм):</label>\n                    <input type="range" id="gridSize" min="10" max="500" step="10" value="50">\n                    <span id="gridSizeValue">50</span>\n                </div>\n                <div class="property-row">\n                    <label>Включить привязку к линиям:</label>\n                    <input type="checkbox" id="lineSnapEnabled" ${r?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Привязка к углам (⊥/∥):</label>\n                    <input type="checkbox" id="angleSnapEnabled" ${a?"checked":""}>\n                </div>\n\n            </div>\n        `}updateGridStepOptions(){const e=this.propertiesElement?.querySelector("#gridStep");if(!e)return;const t=this.editor.gridUnit||"mm",n=this.sketchManager?.gridStep??1;if(e.innerHTML="","mm"===t){[.1,.2,.5,1,2,5,10].forEach(t=>{const r=document.createElement("option");r.value=t,r.textContent=`${t} мм`,Math.abs(t-n)<.001&&(r.selected=!0),e.appendChild(r)})}else{[{value:1/64,label:'1/64"'},{value:1/32,label:'1/32"'},{value:1/16,label:'1/16"'},{value:1/8,label:'1/8"'},{value:1/4,label:'1/4"'},{value:.5,label:'1/2"'},{value:1,label:'1"'}].forEach(t=>{const r=document.createElement("option");r.value=t.value,r.textContent=t.label,Math.abs(t.value-n)<.001&&(r.selected=!0),e.appendChild(r)})}}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#faceGroupingEnabled");e&&e.addEventListener("change",e=>{const t=e.target.checked;this.planesManager.setFaceGroupingEnabled(t),localStorage.setItem("cad-face-grouping",t?"true":"false"),this.editor.showStatus("Центрирование по всей грани: "+(t?"ВКЛ":"ВЫКЛ"),"info")});const t=this.propertiesElement.querySelector("#gridSnapEnabled");t&&this.sketchManager?.snapHelper&&(t.checked=this.sketchManager.snapHelper.gridSnapEnabled,t.addEventListener("change",e=>{this.sketchManager.snapHelper.gridSnapEnabled=e.target.checked}));const n=this.propertiesElement.querySelector("#gridVisible");n&&this.sketchManager?.viewManager&&(n.checked=this.sketchManager.viewManager.gridVisible,n.addEventListener("change",e=>{this.sketchManager.viewManager.setGridVisible(e.target.checked)}));const r=this.propertiesElement.querySelector("#gridStep");r&&this.sketchManager&&r.addEventListener("change",e=>{const t=parseFloat(e.target.value);localStorage.setItem("cad-sketch-step",t),this.sketchManager.gridStep=t,this.sketchManager.viewManager.updateGrid();const n="mm"===this.editor.gridUnit?"мм":1===t?"дюйм":"дюйма";this.editor.showStatus(`Шаг сетки скетча: ${t} ${n}`,"info")});const a=this.propertiesElement.querySelector("#gridSize"),s=this.propertiesElement.querySelector("#gridSizeValue");if(a&&s&&this.sketchManager?.viewManager){const e=this.sketchManager.viewManager.gridSize||50;a.value=e,s.textContent=e,a.addEventListener("input",e=>{s.textContent=e.target.value}),a.addEventListener("change",e=>{const t=parseInt(e.target.value);this.sketchManager.viewManager&&(this.sketchManager.viewManager.gridSize=t,this.sketchManager.viewManager.updateGrid()),this.editor.showStatus(`Размер сетки изменен: ${t} мм`,"info")})}const i=this.propertiesElement.querySelector("#lineSnapEnabled");i&&this.sketchManager?.snapHelper&&(i.checked=this.sketchManager.snapHelper.lineSnapEnabled,i.addEventListener("change",e=>{this.sketchManager.snapHelper.lineSnapEnabled=e.target.checked}));const o=this.propertiesElement.querySelector("#angleSnapEnabled");o&&this.sketchManager?.snapHelper&&(o.checked=this.sketchManager.snapHelper.angleSnapEnabled,o.addEventListener("change",e=>{this.sketchManager.snapHelper.angleSnapEnabled=e.target.checked,e.target.checked||(this.sketchManager.snapHelper.hidePerpendicularGuide(),this.sketchManager.snapHelper.perpendicularActive=!1,this.sketchManager.snapHelper.parallelActive=!1)}));const c=this.propertiesElement.querySelector("#outlineEnabled");c&&this.sketchManager&&(c.checked=this.sketchManager.getOutlineEnabled(),c.addEventListener("change",e=>{const t=e.target.checked,n=this.sketchManager.setOutlineEnabled(t);this.editor.showStatus("Автообводка граней "+(n?"включена":"отключена"),"info")}))}onActivate(){if(this.createPropertiesSection(),this.showSketchOnlyElements(),1===this.editor.selectedObjects.length){const e=this.editor.selectedObjects[0];if(e.userData&&"sketch_plane"===e.userData.type)return void this.editExistingSketch(e)}this.startSketchSelection(),this.editor.clearSelection(!1)}onDeactivate(){this.removePropertiesSection(),this.hideSketchOnlyElements(),this.exitSketchMode()}onMouseDown(e){if("selecting"===this.sketchMode){if(this.handleSelection(e))return e.preventDefault(),e.stopPropagation(),!0}else if("drawing"===this.sketchMode&&this.sketchManager)return this.sketchManager.onMouseDown(e);return!1}onMouseMove(e){"selecting"===this.sketchMode?this.handleHighlight(e):"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onMouseMove(e)}onMouseUp(e){"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onMouseUp(e)}onKeyDown(e){if("selecting"===this.sketchMode){if("Escape"===e.key)return this.editor.toolManager.setCurrentTool("select"),!0}else if("drawing"===this.sketchMode&&this.sketchManager)return this.sketchManager.onKeyDown(e);return!1}onKeyUp(e){"drawing"===this.sketchMode&&this.sketchManager&&this.sketchManager.onKeyUp(e)}}