class RectangleSketchTool extends SketchToolBase{constructor(e){super(e,"rectangle","fa-vector-square"),this.width=10,this.height=10,this.directionX=1,this.directionY=1,this.dimensionFields=[{label:"Ширина",type:"number",value:this.width,unit:"мм",min:1,step:1},{label:"Высота",type:"number",value:this.height,unit:"мм",min:1,step:1}]}onMouseDown(e){if(this.sketchManager.dimensionManager.isInputActive)return this.sketchManager.dimensionManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.isDrawing=!0,this.tempElement={type:"rectangle",start:t.clone(),end:t.clone(),width:0,height:0,points:this.calculateRectanglePoints(t,t),color:this.sketchManager.sketchColor},this.directionX=1,this.directionY=1,this.createTempGeometry(),!0)}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);if(!t)return;this.tempElement.end=t.clone();const n=t.x-this.tempElement.start.x,i=t.y-this.tempElement.start.y;this.directionX=n>=0?1:-1,this.directionY=i>=0?1:-1,this.tempElement.width=Math.abs(n),this.tempElement.height=Math.abs(i),this.tempElement.points=this.calculateRectanglePoints(this.tempElement.start,t),this.updateTempGeometry(),this.updateRectangleDimensions(),this.sketchManager.dimensionManager.isInputActive&&this.updateInputFields()}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}onKeyDown(e){return!("Escape"!==e.key||!this.isDrawing)&&(this.onCancel(),!0)}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.dimensionManager.clearDimensionObjects(),this.sketchManager.dimensionManager.hideDimensionInput()}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.width.toFixed(1),t.fields[1].value=this.tempElement.height.toFixed(1),this.sketchManager.dimensionManager.showDimensionInput(e,t)}updateInputFields(){this.sketchManager.dimensionManager.isInputActive&&this.tempElement&&(this.sketchManager.dimensionManager.inputField1&&(this.sketchManager.dimensionManager.inputField1.value=this.tempElement.width.toFixed(1)),this.sketchManager.dimensionManager.inputField2&&(this.sketchManager.dimensionManager.inputField2.value=this.tempElement.height.toFixed(1)))}applyDimensions(e){if(!this.tempElement)return;e.value1&&e.value1>0&&(this.tempElement.width=e.value1),e.value2&&e.value2>0&&(this.tempElement.height=e.value2);const t=new THREE.Vector3(this.tempElement.start.x+this.tempElement.width*this.directionX,this.tempElement.start.y+this.tempElement.height*this.directionY,0);this.tempElement.end=t,this.tempElement.points=this.calculateRectanglePoints(this.tempElement.start,t),this.sketchManager.elementManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.dimensionManager.clearDimensionObjects(),this.tempElement=null}updateRectangleDimensions(){this.tempElement&&(this.sketchManager.dimensionManager.clearDimensionObjects(),this.createRectangleDimensions())}calculateRectanglePoints(e,t){const n=Math.min(e.x,t.x),i=Math.max(e.x,t.x),s=Math.min(e.y,t.y),a=Math.max(e.y,t.y);return[new THREE.Vector3(n,s,0),new THREE.Vector3(i,s,0),new THREE.Vector3(i,a,0),new THREE.Vector3(n,a,0),new THREE.Vector3(n,s,0)]}createRectangleDimensions(){if(!this.sketchManager.currentPlane||!this.tempElement)return;const e=Math.min(this.tempElement.start.x,this.tempElement.end.x),t=Math.max(this.tempElement.start.x,this.tempElement.end.x),n=Math.min(this.tempElement.start.y,this.tempElement.end.y),i=Math.max(this.tempElement.start.y,this.tempElement.end.y),s=t-e,a=i-n,r=new THREE.Vector3(e,n-10,.1),o=new THREE.Vector3(t,n-10,.1),h=(new THREE.BufferGeometry).setFromPoints([r,o]),m=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),l=new THREE.Line(h,m),c=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e,n,.1),new THREE.Vector3(e,n-10,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),E=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(t,n,.1),new THREE.Vector3(t,n-10,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),p=new THREE.Vector3(e+s/2,n-15,.1);this.createDimensionText(p,`${s.toFixed(1)} мм`);const d=new THREE.Vector3(t+10,n,.1),u=new THREE.Vector3(t+10,i,.1),g=(new THREE.BufferGeometry).setFromPoints([d,u]),w=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),M=new THREE.Line(g,w),T=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(t,n,.1),new THREE.Vector3(t+10,n,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),R=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(t,i,.1),new THREE.Vector3(t+10,i,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),H=new THREE.Vector3(t+15,n+a/2,.1);this.createDimensionText(H,`${a.toFixed(1)} мм`),[l,c,E,M,T,R].forEach(e=>{e.userData.isDimension=!0,this.sketchManager.currentPlane.add(e),this.sketchManager.dimensionObjects.push(e)})}createDimensionText(e,t){const n=document.createElement("canvas"),i=n.getContext("2d");n.width=256,n.height=64,i.clearRect(0,0,n.width,n.height),i.font="bold 16px Arial",i.fillStyle="#00C853",i.textAlign="center",i.textBaseline="middle",i.fillText(t,n.width/2,n.height/2);const s=new THREE.CanvasTexture(n);s.minFilter=THREE.LinearFilter;const a=new THREE.SpriteMaterial({map:s,transparent:!0}),r=new THREE.Sprite(a);r.position.copy(e),r.scale.set(20,5,1),r.userData.isDimension=!0,this.sketchManager.currentPlane.add(r),this.sketchManager.dimensionObjects.push(r)}createGeometry(e){const t=[];e.points.forEach(e=>{t.push(e.x,e.y,.01)});const n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),new THREE.LineLoop(n,new THREE.LineBasicMaterial({color:e.color,linewidth:2}))}updateGeometry(e,t){const n=[];t.points.forEach(e=>{n.push(e.x,e.y,.01)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),e.geometry.attributes.position.needsUpdate=!0}}