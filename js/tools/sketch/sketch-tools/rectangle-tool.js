class RectangleSketchTool extends SketchToolBase{constructor(e){super(e,"rectangle","fa-vector-square"),this.width=10,this.height=10,this.directionX=1,this.directionY=1,this.dimensionFields=[{label:"Ширина",type:"number",value:this.width,unit:"мм",min:1,step:1},{label:"Высота",type:"number",value:this.height,unit:"мм",min:1,step:1}]}onMouseDown(e){if(this.sketchManager.isInputActive)return this.sketchManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.isDrawing=!0,this.tempElement={type:"rectangle",start:t.clone(),end:t.clone(),width:0,height:0,points:this.calculateRectanglePoints(t,t),color:this.sketchManager.sketchColor},this.directionX=1,this.directionY=1,this.createTempGeometry(),!0)}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);if(!t)return;this.tempElement.end=t.clone();const n=t.x-this.tempElement.start.x,i=t.y-this.tempElement.start.y;this.directionX=n>=0?1:-1,this.directionY=i>=0?1:-1,this.tempElement.width=Math.abs(n),this.tempElement.height=Math.abs(i),this.tempElement.points=this.calculateRectanglePoints(this.tempElement.start,t),this.updateTempGeometry(),this.updateRectangleDimensions(),this.sketchManager.isInputActive&&this.updateInputFields()}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}onKeyDown(e){return!("Escape"!==e.key||!this.isDrawing)&&(this.onCancel(),!0)}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.clearDimensionObjects(),this.sketchManager.hideDimensionInput()}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.width.toFixed(1),t.fields[1].value=this.tempElement.height.toFixed(1),this.sketchManager.showDimensionInput(e,t)}updateInputFields(){this.sketchManager.isInputActive&&this.tempElement&&(this.sketchManager.inputField1&&(this.sketchManager.inputField1.value=this.tempElement.width.toFixed(1)),this.sketchManager.inputField2&&(this.sketchManager.inputField2.value=this.tempElement.height.toFixed(1)))}applyDimensions(e){this.tempElement&&(e.value1&&e.value1>0&&(this.tempElement.width=e.value1),e.value2&&e.value2>0&&(this.tempElement.height=e.value2),this.tempElement.end.x=this.tempElement.start.x+this.tempElement.width*this.directionX,this.tempElement.end.y=this.tempElement.start.y+this.tempElement.height*this.directionY,this.tempElement.points=this.calculateRectanglePoints(this.tempElement.start,this.tempElement.end),this.sketchManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.clearDimensionObjects(),this.tempElement=null)}updateRectangleDimensions(){this.tempElement&&(this.sketchManager.clearDimensionObjects(),this.createRectangleDimensions(this.tempElement.start,this.tempElement.end))}calculateRectanglePoints(e,t){if(!this.sketchManager.currentPlane)return[];const n=this.sketchManager.currentPlane.worldToLocal(e.clone()),i=this.sketchManager.currentPlane.worldToLocal(t.clone()),s=Math.min(n.x,i.x),a=Math.max(n.x,i.x),r=Math.min(n.y,i.y),o=Math.max(n.y,i.y);return[new THREE.Vector3(s,r,0),new THREE.Vector3(a,r,0),new THREE.Vector3(a,o,0),new THREE.Vector3(s,o,0),new THREE.Vector3(s,r,0)].map(e=>this.sketchManager.currentPlane.localToWorld(e))}createRectangleDimensions(e,t){if(!this.sketchManager.currentPlane)return;const n=this.sketchManager.currentPlane.worldToLocal(e.clone()),i=this.sketchManager.currentPlane.worldToLocal(t.clone()),s=Math.min(n.x,i.x),a=Math.max(n.x,i.x),r=Math.min(n.y,i.y),o=Math.max(n.y,i.y),h=a-s,l=o-r,c=new THREE.Vector3(s,r-10,.1),m=new THREE.Vector3(a,r-10,.1),E=(new THREE.BufferGeometry).setFromPoints([c,m]),p=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),u=new THREE.Line(E,p),d=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(s,r,.1),new THREE.Vector3(s,r-10,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),w=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(a,r,.1),new THREE.Vector3(a,r-10,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),g=new THREE.Vector3(s+h/2,r-15,.1);this.createDimensionText(g,`${h.toFixed(1)} мм`);const T=new THREE.Vector3(a+10,r,.1),M=new THREE.Vector3(a+10,o,.1),R=(new THREE.BufferGeometry).setFromPoints([T,M]),H=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),k=new THREE.Line(R,H),y=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(a,r,.1),new THREE.Vector3(a+10,r,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),f=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(a,o,.1),new THREE.Vector3(a+10,o,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),x=new THREE.Vector3(a+15,r+l/2,.1);this.createDimensionText(x,`${l.toFixed(1)} мм`),[u,d,w,k,y,f].forEach(e=>{e.userData.isDimension=!0,this.sketchManager.currentPlane.add(e),this.sketchManager.dimensionObjects.push(e)})}createDimensionText(e,t){const n=document.createElement("canvas"),i=n.getContext("2d");n.width=256,n.height=64,i.clearRect(0,0,n.width,n.height),i.font="bold 16px Arial",i.fillStyle="#00C853",i.textAlign="center",i.textBaseline="middle",i.fillText(t,n.width/2,n.height/2);const s=new THREE.CanvasTexture(n);s.minFilter=THREE.LinearFilter;const a=new THREE.SpriteMaterial({map:s,transparent:!0}),r=new THREE.Sprite(a);r.position.copy(e),r.scale.set(20,5,1),r.userData.isDimension=!0,this.sketchManager.currentPlane.add(r),this.sketchManager.dimensionObjects.push(r)}createGeometry(e){const t=[];e.points.forEach(e=>{const n=this.sketchManager.currentPlane.worldToLocal(e.clone());t.push(n.x,n.y,0)});const n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),new THREE.LineLoop(n,new THREE.LineBasicMaterial({color:e.color,linewidth:2}))}updateGeometry(e,t){const n=[];t.points.forEach(e=>{const t=this.sketchManager.currentPlane.worldToLocal(e.clone());n.push(t.x,t.y,0)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),e.geometry.attributes.position.needsUpdate=!0}}