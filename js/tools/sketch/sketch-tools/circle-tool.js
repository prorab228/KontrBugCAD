class CircleSketchTool extends SketchToolBase{constructor(e){super(e,"circle","fa-circle"),this.radius=0,this.diameter=0,this.segments=32,this.dimensionFields=[{label:"Диаметр",type:"number",value:10,unit:"мм",min:0,step:1},{label:"Сегменты",type:"number",value:this.segments,unit:"шт",min:8,max:64,step:4}]}onMouseDown(e){if(this.sketchManager.isInputActive)return this.sketchManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.isDrawing=!0,this.tempElement={type:"circle",center:t.clone(),diameter:0,radius:0,segments:this.segments,points:this.calculateCirclePoints(t,0,this.segments),color:this.sketchManager.sketchColor},this.createTempGeometry(),!0)}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);t&&(this.tempElement.radius=this.tempElement.center.distanceTo(t),this.tempElement.diameter=2*this.tempElement.radius,this.tempElement.points=this.calculateCirclePoints(this.tempElement.center,this.tempElement.radius,this.tempElement.segments),this.updateTempGeometry(),this.updateCircleDimensions(this.tempElement.center,this.tempElement.radius),this.sketchManager.isInputActive&&this.updateInputFields())}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.diameter.toFixed(1),t.fields[1].value=this.tempElement.segments,this.sketchManager.showDimensionInput(e,t)}updateInputFields(){this.sketchManager.isInputActive&&this.tempElement&&(this.sketchManager.inputField1&&(this.sketchManager.inputField1.value=this.tempElement.diameter.toFixed(1)),this.sketchManager.inputField2&&(this.sketchManager.inputField2.value=this.tempElement.segments))}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.clearDimensionObjects()}applyDimensions(e){this.tempElement&&(e.value1&&e.value1>0&&(this.tempElement.diameter=e.value1,this.tempElement.radius=e.value1/2),e.value2&&e.value2>=8&&(this.tempElement.segments=Math.min(64,Math.max(8,e.value2))),this.tempElement.points=this.calculateCirclePoints(this.tempElement.center,this.tempElement.radius,this.tempElement.segments),this.sketchManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.clearDimensionObjects(),this.tempElement=null)}updateCircleDimensions(e,t){this.sketchManager.clearDimensionObjects(),this.createCircleDimensions(e,t)}createCircleDimensions(e,t){if(!this.sketchManager.currentPlane)return;const i=this.sketchManager.currentPlane.worldToLocal(e.clone()),n=new THREE.Vector3(i.x-t,i.y,.1),s=new THREE.Vector3(i.x+t,i.y,.1),a=(new THREE.BufferGeometry).setFromPoints([n,s]),r=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),l=new THREE.Line(a,r),o=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x-t,i.y-5,.1),new THREE.Vector3(i.x-t,i.y+5,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),c=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x+t,i.y-5,.1),new THREE.Vector3(i.x+t,i.y+5,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),h=new THREE.Vector3(i.x,i.y-10,.1);this.createDimensionText(h,`Ø${(2*t).toFixed(1)}`),[l,o,c].forEach(e=>{e.userData.isDimension=!0,this.sketchManager.currentPlane.add(e),this.sketchManager.dimensionObjects.push(e)})}createDimensionText(e,t){const i=document.createElement("canvas"),n=i.getContext("2d");i.width=256,i.height=64,n.clearRect(0,0,i.width,i.height),n.font="bold 16px Arial",n.fillStyle="#00C853",n.textAlign="center",n.textBaseline="middle",n.fillText(t,i.width/2,i.height/2);const s=new THREE.CanvasTexture(i);s.minFilter=THREE.LinearFilter;const a=new THREE.SpriteMaterial({map:s,transparent:!0}),r=new THREE.Sprite(a);r.position.copy(e),r.scale.set(20,5,1),r.userData.isDimension=!0,this.sketchManager.currentPlane.add(r),this.sketchManager.dimensionObjects.push(r)}calculateCirclePoints(e,t,i){if(!this.sketchManager.currentPlane)return[];const n=this.sketchManager.currentPlane.worldToLocal(e.clone()),s=[];for(let e=0;e<=i;e++){const a=e/i*Math.PI*2,r=n.x+Math.cos(a)*t,l=n.y+Math.sin(a)*t;s.push(this.sketchManager.currentPlane.localToWorld(new THREE.Vector3(r,l,0)))}return s}createGeometry(e){const t=[];e.points.forEach(e=>{const i=this.sketchManager.currentPlane.worldToLocal(e.clone());t.push(i.x,i.y,0)});const i=new THREE.BufferGeometry;return i.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),new THREE.LineLoop(i,new THREE.LineBasicMaterial({color:e.color,linewidth:2}))}updateGeometry(e,t){const i=[];t.points.forEach(e=>{const t=this.sketchManager.currentPlane.worldToLocal(e.clone());i.push(t.x,t.y,0)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),e.geometry.attributes.position.needsUpdate=!0}}