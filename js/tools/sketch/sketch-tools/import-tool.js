class ImportSketchTool extends SketchToolBase{constructor(t){super(t,"import","fa-upload"),this.fileInput=null,this.supportedFormats={"image/svg+xml":"svg","application/dxf":"dxf","application/json":"json","text/xml":"svg","application/pdf":"pdf"}}onMouseDown(t){return this.showFileInput(),!0}showFileInput(){this.fileInput&&this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".svg,.dxf,.json,.pdf",this.fileInput.style.display="none",this.fileInput.multiple=!1,this.fileInput.onchange=t=>{const e=t.target.files[0];e&&this.processFile(e),this.fileInput.value=""},document.body.appendChild(this.fileInput),this.fileInput.click()}processFile(t){const e=t.name.split(".").pop().toLowerCase();t.type;this.sketchManager.editor.showStatus(`Загружается файл: ${t.name}`,"info");const r=new FileReader;r.onload=r=>{try{const s=r.target.result;switch(e){case"svg":this.importSVG(s,t.name);break;case"dxf":this.importDXF(s,t.name);break;case"json":this.importJSON(s,t.name);break;default:this.sketchManager.editor.showStatus(`Формат ${e} не поддерживается`,"error")}}catch(t){console.error("Ошибка при импорте файла:",t),this.sketchManager.editor.showStatus(`Ошибка импорта: ${t.message}`,"error")}},r.onerror=()=>{this.sketchManager.editor.showStatus("Ошибка чтения файла","error")},"svg"===e||"dxf"===e||"json"===e?r.readAsText(t):this.sketchManager.editor.showStatus(`Формат ${e} не поддерживается`,"error")}importSVG(t,e){try{const e=(new DOMParser).parseFromString(t,"image/svg+xml");if(e.querySelector("parsererror"))throw new Error("Некорректный SVG файл");const r=e.querySelectorAll("line, rect, circle, ellipse, polygon, polyline, path, text");if(0===r.length)return void this.sketchManager.editor.showStatus("SVG файл не содержит векторных элементов","warning");let s=0;const n=0,o=0;r.forEach((t,e)=>{const r=this.convertSVGToSketchElement(t,n,o);r&&(this.sketchManager.addElement(r),s++)}),this.sketchManager.editor.showStatus(`Импортировано ${s} элементов из SVG`,"success")}catch(t){console.error("Ошибка парсинга SVG:",t),this.sketchManager.editor.showStatus(`Ошибка импорта SVG: ${t.message}`,"error")}}convertSVGToSketchElement(t,e,r){const s=t.tagName.toLowerCase();try{switch(s){case"line":return this.convertSVGLine(t,e,r);case"rect":return this.convertSVGRect(t,e,r);case"circle":return this.convertSVGCircle(t,e,r);case"ellipse":return this.convertSVGEllipse(t,e,r);case"polygon":case"polyline":return this.convertSVGPoly(t,e,r,s);case"path":return this.convertSVGPath(t,e,r);case"text":return this.convertSVGText(t,e,r);default:return null}}catch(t){return console.warn(`Не удалось конвертировать элемент ${s}:`,t),null}}convertSVGLine(t,e,r){const s=parseFloat(t.getAttribute("x1")||0)+e,n=-parseFloat(t.getAttribute("y1")||0)+r,o=parseFloat(t.getAttribute("x2")||0)+e,c=-parseFloat(t.getAttribute("y2")||0)+r;return{type:"line",start:new THREE.Vector3(s,n,0),end:new THREE.Vector3(o,c,0),points:[new THREE.Vector3(s,n,0),new THREE.Vector3(o,c,0)],color:this.sketchManager.sketchColor}}convertSVGRect(t,e,r){const s=parseFloat(t.getAttribute("x")||0)+e,n=-parseFloat(t.getAttribute("y")||0)+r,o=parseFloat(t.getAttribute("width")||0),c=parseFloat(t.getAttribute("height")||0),a=[new THREE.Vector3(s,n-c,0),new THREE.Vector3(s+o,n-c,0),new THREE.Vector3(s+o,n,0),new THREE.Vector3(s,n,0),new THREE.Vector3(s,n-c,0)];return{type:"rectangle",start:a[0].clone(),end:a[2].clone(),width:o,height:c,points:a,color:this.sketchManager.sketchColor}}convertSVGCircle(t,e,r){const s=parseFloat(t.getAttribute("cx")||0)+e,n=-parseFloat(t.getAttribute("cy")||0)+r,o=parseFloat(t.getAttribute("r")||0);return{type:"circle",center:new THREE.Vector3(s,n,0),radius:o,diameter:2*o,segments:32,points:this.calculateCirclePoints(s,n,o,32),color:this.sketchManager.sketchColor}}convertSVGEllipse(t,e,r){const s=parseFloat(t.getAttribute("cx")||0)+e,n=-parseFloat(t.getAttribute("cy")||0)+r,o=parseFloat(t.getAttribute("rx")||0),c=parseFloat(t.getAttribute("ry")||0);return{type:"oval",center:new THREE.Vector3(s,n,0),radiusX:o,radiusY:c,segments:32,points:this.calculateOvalPoints(s,n,o,c,32),color:this.sketchManager.sketchColor}}convertSVGPoly(t,e,r,s){const n=t.getAttribute("points");if(!n)return null;const o=n.trim().split(/[\s,]+/),c=[];for(let t=0;t<o.length;t+=2){const s=parseFloat(o[t])+e,n=-parseFloat(o[t+1])+r;c.push(new THREE.Vector3(s,n,0))}return{type:"polygon"===s?"polygon":"polyline",points:c,color:this.sketchManager.sketchColor}}convertSVGPath(t,e,r){const s=t.getAttribute("d");if(!s)return null;const n=s.match(/[MLCQ][^MLCQ]*/gi);if(!n)return null;const o=[];return n.forEach(t=>{const s=t[0],n=t.substring(1).trim().split(/[\s,]+/).map(Number);switch(s.toUpperCase()){case"M":case"L":if(n.length>=2){const t=n[0]+e,s=-n[1]+r;o.push(new THREE.Vector3(t,s,0))}break;case"C":if(n.length>=6){const t=o[o.length-1]||new THREE.Vector3(0,0,0),s=new THREE.Vector3(n[0]+e,-n[1]+r,0),c=new THREE.Vector3(n[2]+e,-n[3]+r,0),a=new THREE.Vector3(n[4]+e,-n[5]+r,0),i=this.approximateBezier(t,s,c,a,10);o.push(...i.slice(1))}}}),o.length<2?null:{type:"polyline",points:o,color:this.sketchManager.sketchColor}}convertSVGText(t,e,r){const s=parseFloat(t.getAttribute("x")||0)+e,n=-parseFloat(t.getAttribute("y")||0)+r,o=t.textContent||t.text||"";if(!o.trim())return null;const c=(t.getAttribute("style")||"").match(/font-size:\s*([\d.]+)(mm|px|pt)/i);let a=5;return c&&(a=parseFloat(c[1]),"mm"===c[2]||("px"===c[2]?a*=.264583:"pt"===c[2]&&(a*=.352778))),{type:"text",position:new THREE.Vector3(s,n,0),content:o,fontSize:a,color:this.sketchManager.sketchColor,contours:this.generateSimpleTextContours(o,s,n,a)}}importDXF(t,e){try{const e=t.split("\n"),r=[];let s=null;for(let t=0;t<e.length;t++){const n=e[t].trim(),o=e[t+1]?e[t+1].trim():"";if("0"===n&&"LINE"===o)s&&r.push(s),s={type:"line",start:null,end:null};else if("0"===n&&"CIRCLE"===o)s&&r.push(s),s={type:"circle",center:null,radius:0};else if("0"===n&&"ARC"===o)s&&r.push(s),s={type:"arc",center:null,radius:0};else if("10"===n&&s){const t=parseFloat(o);"line"===s.type?s.start?s.end={x:t,y:s.end?.y||0}:s.start={x:t,y:0}:"circle"!==s.type&&"arc"!==s.type||s.center||(s.center={x:t,y:0})}else if("20"===n&&s){const t=parseFloat(o);"line"===s.type?s.start&&void 0===s.start.y?s.start.y=t:s.end&&(s.end.y=t):"circle"!==s.type&&"arc"!==s.type||s.center&&(s.center.y=t)}else"40"!==n||!s||"circle"!==s.type&&"arc"!==s.type||(s.radius=parseFloat(o))}s&&r.push(s);let n=0;r.forEach(t=>{const e=this.convertDXFToSketchElement(t);e&&(this.sketchManager.addElement(e),n++)}),this.sketchManager.editor.showStatus(`Импортировано ${n} элементов из DXF`,"success")}catch(t){console.error("Ошибка парсинга DXF:",t),this.sketchManager.editor.showStatus("Ошибка импорта DXF файла. Формат может быть неподдерживаемым.","error")}}convertDXFToSketchElement(t){switch(t.type){case"line":if(t.start&&t.end)return{type:"line",start:new THREE.Vector3(t.start.x,-t.start.y,0),end:new THREE.Vector3(t.end.x,-t.end.y,0),points:[new THREE.Vector3(t.start.x,-t.start.y,0),new THREE.Vector3(t.end.x,-t.end.y,0)],color:this.sketchManager.sketchColor};break;case"circle":if(t.center&&t.radius)return{type:"circle",center:new THREE.Vector3(t.center.x,-t.center.y,0),radius:t.radius,diameter:2*t.radius,segments:32,points:this.calculateCirclePoints(t.center.x,-t.center.y,t.radius,32),color:this.sketchManager.sketchColor}}return null}importJSON(t,e){try{const e=JSON.parse(t);if(!e.elements||!Array.isArray(e.elements))throw new Error("Некорректный формат JSON файла");let r=0;e.elements.forEach(t=>{const e=this.convertJSONToSketchElement(t);e&&(this.sketchManager.addElement(e),r++)}),e.name&&(this.sketchManager.currentSketch.name=e.name),this.sketchManager.editor.showStatus(`Импортировано ${r} элементов из JSON`,"success")}catch(t){console.error("Ошибка парсинга JSON:",t),this.sketchManager.editor.showStatus(`Ошибка импорта JSON: ${t.message}`,"error")}}convertJSONToSketchElement(t){const e={type:t.type,color:this.sketchManager.sketchColor};t.points&&Array.isArray(t.points)&&(e.points=t.points.map(t=>new THREE.Vector3(t.x,t.y,t.z||0))),t.start&&(e.start=new THREE.Vector3(t.start.x,t.start.y,t.start.z||0)),t.end&&(e.end=new THREE.Vector3(t.end.x,t.end.y,t.end.z||0)),t.center&&(e.center=new THREE.Vector3(t.center.x,t.center.y,t.center.z||0));return["radius","width","height","segments","sides","fontSize","cornerRadius"].forEach(r=>{void 0!==t[r]&&(e[r]=t[r])}),t.content&&(e.content=t.content),e}calculateCirclePoints(t,e,r,s){const n=[];for(let o=0;o<=s;o++){const c=o/s*Math.PI*2,a=t+Math.cos(c)*r,i=e+Math.sin(c)*r;n.push(new THREE.Vector3(a,i,0))}return n}calculateOvalPoints(t,e,r,s,n){const o=[];for(let c=0;c<=n;c++){const a=c/n*Math.PI*2,i=t+Math.cos(a)*r,l=e+Math.sin(a)*s;o.push(new THREE.Vector3(i,l,0))}return o}approximateBezier(t,e,r,s,n){const o=[];for(let c=0;c<=n;c++){const a=c/n,i=Math.pow(1-a,3)*t.x+3*Math.pow(1-a,2)*a*e.x+3*(1-a)*Math.pow(a,2)*r.x+Math.pow(a,3)*s.x,l=Math.pow(1-a,3)*t.y+3*Math.pow(1-a,2)*a*e.y+3*(1-a)*Math.pow(a,2)*r.y+Math.pow(a,3)*s.y;o.push(new THREE.Vector3(i,l,0))}return o}generateSimpleTextContours(t,e,r,s){const n=[],o=.6*s,c=.1*s;for(let a=0;a<t.length;a++){const t=e+a*(o+c),i=r,l=[new THREE.Vector3(t,i,0),new THREE.Vector3(t+o,i,0),new THREE.Vector3(t+o,i+s,0),new THREE.Vector3(t,i+s,0),new THREE.Vector3(t,i,0)];n.push(l)}return n}onCancel(){this.fileInput&&this.fileInput.parentNode&&(this.fileInput.parentNode.removeChild(this.fileInput),this.fileInput=null)}}