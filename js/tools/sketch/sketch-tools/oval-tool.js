class OvalSketchTool extends SketchToolBase{constructor(e){super(e,"oval","fa-circle-notch"),this.width=20,this.height=10,this.segments=32,this.directionX=1,this.directionY=1,this.dimensionFields=[{label:"Ширина",type:"number",value:this.width,unit:"мм",min:1,step:1},{label:"Высота",type:"number",value:this.height,unit:"мм",min:1,step:1},{label:"Сегменты",type:"number",value:this.segments,unit:"шт",min:8,max:64,step:4}]}onMouseDown(e){if(this.sketchManager.isInputActive)return this.sketchManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.isDrawing=!0,this.tempElement={type:"oval",start:t.clone(),end:t.clone(),width:0,height:0,radiusX:0,radiusY:0,segments:this.segments,points:this.calculateOvalPoints(t,t),color:this.sketchManager.sketchColor},this.directionX=1,this.directionY=1,this.createTempGeometry(),!0)}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);if(!t)return;this.tempElement.end=t.clone();const i=t.x-this.tempElement.start.x,n=t.y-this.tempElement.start.y;this.directionX=i>=0?1:-1,this.directionY=n>=0?1:-1,this.tempElement.width=Math.abs(i),this.tempElement.height=Math.abs(n),this.tempElement.radiusX=this.tempElement.width/2,this.tempElement.radiusY=this.tempElement.height/2;const s=this.tempElement.start.x+i/2,a=this.tempElement.start.y+n/2;this.tempElement.center=new THREE.Vector3(s,a,0),this.tempElement.points=this.calculateOvalPoints(this.tempElement.start,t),this.updateTempGeometry(),this.updateOvalDimensions(),this.sketchManager.isInputActive&&this.updateInputFields()}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.width.toFixed(1),t.fields[1].value=this.tempElement.height.toFixed(1),t.fields[2].value=this.tempElement.segments,this.sketchManager.showDimensionInput(e,t)}updateInputFields(){this.sketchManager.isInputActive&&this.tempElement&&(this.sketchManager.inputField1&&(this.sketchManager.inputField1.value=this.tempElement.width.toFixed(1)),this.sketchManager.inputField2&&(this.sketchManager.inputField2.value=this.tempElement.height.toFixed(1)),this.sketchManager.inputField3&&(this.sketchManager.inputField3.value=this.tempElement.segments))}applyDimensions(e){if(!this.tempElement)return;e.value1&&e.value1>0&&(this.tempElement.width=e.value1),e.value2&&e.value2>0&&(this.tempElement.height=e.value2),e.value3&&e.value3>=8&&(this.tempElement.segments=Math.min(64,Math.max(8,e.value3))),this.tempElement.radiusX=this.tempElement.width/2,this.tempElement.radiusY=this.tempElement.height/2,this.tempElement.end.x=this.tempElement.start.x+this.tempElement.width*this.directionX,this.tempElement.end.y=this.tempElement.start.y+this.tempElement.height*this.directionY;const t=this.tempElement.start.x+this.tempElement.width*this.directionX/2,i=this.tempElement.start.y+this.tempElement.height*this.directionY/2;this.tempElement.center=new THREE.Vector3(t,i,0),this.tempElement.points=this.calculateOvalPoints(this.tempElement.start,this.tempElement.end),this.sketchManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.clearDimensionObjects(),this.tempElement=null}updateOvalDimensions(){this.tempElement&&this.tempElement.center&&(this.sketchManager.clearDimensionObjects(),this.createOvalDimensions())}createOvalDimensions(){if(!this.sketchManager.currentPlane||!this.tempElement)return;const e=this.sketchManager.currentPlane.worldToLocal(this.tempElement.center.clone()),t=this.tempElement.radiusX,i=this.tempElement.radiusY,n=new THREE.Vector3(e.x-t,e.y,.1),s=new THREE.Vector3(e.x+t,e.y,.1),a=(new THREE.BufferGeometry).setFromPoints([n,s]),h=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),r=new THREE.Line(a,h),o=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e.x-t,e.y-5,.1),new THREE.Vector3(e.x-t,e.y+5,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),l=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e.x+t,e.y-5,.1),new THREE.Vector3(e.x+t,e.y+5,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),m=new THREE.Vector3(e.x,e.y-10,.1);this.createDimensionText(m,`Ширина: ${(2*t).toFixed(1)}`);const c=new THREE.Vector3(e.x,e.y-i,.1),E=new THREE.Vector3(e.x,e.y+i,.1),p=(new THREE.BufferGeometry).setFromPoints([c,E]),u=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),d=new THREE.Line(p,u),w=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e.x-5,e.y-i,.1),new THREE.Vector3(e.x+5,e.y-i,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),g=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e.x-5,e.y+i,.1),new THREE.Vector3(e.x+5,e.y+i,.1)]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),T=new THREE.Vector3(e.x+15,e.y,.1);this.createDimensionText(T,`Высота: ${(2*i).toFixed(1)}`),[r,o,l,d,w,g].forEach(e=>{e.userData.isDimension=!0,this.sketchManager.currentPlane.add(e),this.sketchManager.dimensionObjects.push(e)})}calculateOvalPoints(e,t){if(!this.sketchManager.currentPlane)return[];const i=this.sketchManager.currentPlane.worldToLocal(e.clone()),n=this.sketchManager.currentPlane.worldToLocal(t.clone()),s=Math.min(i.x,n.x),a=Math.max(i.x,n.x),h=Math.min(i.y,n.y),r=(a-s)/2,o=(Math.max(i.y,n.y)-h)/2,l=s+r,m=h+o,c=[];for(let e=0;e<=this.segments;e++){const t=e/this.segments*Math.PI*2,i=l+Math.cos(t)*r,n=m+Math.sin(t)*o;c.push(this.sketchManager.currentPlane.localToWorld(new THREE.Vector3(i,n,0)))}return c}createDimensionText(e,t){const i=document.createElement("canvas"),n=i.getContext("2d");i.width=256,i.height=64,n.clearRect(0,0,i.width,i.height),n.font="bold 16px Arial",n.fillStyle="#00C853",n.textAlign="center",n.textBaseline="middle",n.fillText(t,i.width/2,i.height/2);const s=new THREE.CanvasTexture(i);s.minFilter=THREE.LinearFilter;const a=new THREE.SpriteMaterial({map:s,transparent:!0}),h=new THREE.Sprite(a);h.position.copy(e),h.scale.set(25,5,1),h.userData.isDimension=!0,this.sketchManager.currentPlane.add(h),this.sketchManager.dimensionObjects.push(h)}createGeometry(e){const t=[];e.points.forEach(e=>{const i=this.sketchManager.currentPlane.worldToLocal(e.clone());t.push(i.x,i.y,0)});const i=new THREE.BufferGeometry;return i.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),new THREE.LineLoop(i,new THREE.LineBasicMaterial({color:e.color,linewidth:2}))}updateGeometry(e,t){const i=[];t.points.forEach(e=>{const t=this.sketchManager.currentPlane.worldToLocal(e.clone());i.push(t.x,t.y,0)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),e.geometry.attributes.position.needsUpdate=!0}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.clearDimensionObjects(),this.sketchManager.hideDimensionInput()}}