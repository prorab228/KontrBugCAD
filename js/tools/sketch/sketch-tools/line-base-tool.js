class LineBaseTool extends SketchToolBase{constructor(e,t,n){super(e,t,n),this.angle=0,this.length=10,this.showAngleIndicator=!0,this.angleIndicator=null,this.angleLabel=null}onMouseDown(e){if(this.sketchManager.dimensionManager.isInputActive)return this.sketchManager.dimensionManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);if(!t)return!1;this.isDrawing=!0,this.tempElement={type:this.name,start:t.clone(),end:t.clone(),length:0,angle:0,points:[t.clone(),t.clone()],color:this.sketchManager.sketchColor,startElement:null};const n=this.sketchManager.snapHelper;return n&&n.currentSnapPoint&&(this.tempElement.startElement=n.currentSnapPoint.element),this.createTempGeometry(),this.updateAngleIndicator(),!0}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);t&&(this.tempElement.originalEnd=t.clone(),this.tempElement.end=t.clone(),this.tempElement.points[1]=t.clone(),this.calculateLineProperties(),this.updateTempGeometry(),this.updateLineDimensions(),this.updateAngleIndicator(),this.sketchManager.dimensionManager.isInputActive&&(this.sketchManager.dimensionManager.isInputFocused||this.updateInputFields()))}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}calculateLineProperties(){if(!this.tempElement||!this.tempElement.start||!this.tempElement.end)return;const e=this.sketchManager.currentPlane.worldToLocal(this.tempElement.start.clone()),t=this.sketchManager.currentPlane.worldToLocal(this.tempElement.end.clone()),n=t.x-e.x,i=t.y-e.y;this.tempElement.length=Math.sqrt(n*n+i*i),this.tempElement.angle=THREE.MathUtils.radToDeg(Math.atan2(i,n)),this.tempElement.angle<0&&(this.tempElement.angle+=360),this.tempElement.angle=Math.round(10*this.tempElement.angle)/10}updateLineDimensions(){this.sketchManager.dimensionManager.clearDimensionObjects(),this.createLineDimension()}createLineDimension(){if(!this.sketchManager.currentPlane||!this.tempElement)return;const e=this.tempElement.start,t=this.tempElement.end,n=this.sketchManager.currentPlane.worldToLocal(e.clone()),i=this.sketchManager.currentPlane.worldToLocal(t.clone()),a=i.x-n.x,s=i.y-n.y,l=Math.sqrt(a*a+s*s),h=new THREE.Vector3(a,s,0).normalize(),r=new THREE.Vector3(-h.y,h.x,0).normalize(),o=new THREE.Vector3(n.x+10*r.x,n.y+10*r.y,.1),c=new THREE.Vector3(i.x+10*r.x,i.y+10*r.y,.1),m=(new THREE.BufferGeometry).setFromPoints([o,c]),d=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),g=new THREE.Line(m,d),p=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(n.x,n.y,.1),o]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),E=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x,i.y,.1),c]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),u=(new THREE.Vector3).addVectors(o,c).multiplyScalar(.5).add(new THREE.Vector3(5*-r.y,5*r.x,.1));this.createDimensionText(u,`${l.toFixed(1)} мм`),[g,p,E].forEach(e=>{e.userData.isDimension=!0,this.sketchManager.currentPlane.add(e),this.sketchManager.dimensionObjects.push(e)})}createDimensionText(e,t){const n=document.createElement("canvas"),i=n.getContext("2d");n.width=256,n.height=64,i.clearRect(0,0,n.width,n.height),i.font="bold 16px Arial",i.fillStyle="#00C853",i.textAlign="center",i.textBaseline="middle",i.fillText(t,n.width/2,n.height/2);const a=new THREE.CanvasTexture(n);a.minFilter=THREE.LinearFilter;const s=new THREE.SpriteMaterial({map:a,transparent:!0}),l=new THREE.Sprite(s);l.position.copy(e),l.scale.set(20,5,1),l.userData.isDimension=!0,this.sketchManager.currentPlane.add(l),this.sketchManager.dimensionObjects.push(l)}updateAngleIndicator(){if(!this.showAngleIndicator||!this.tempElement||!this.sketchManager.currentPlane||this.tempElement.length<1)return void this.hideAngleIndicator();const e=this.sketchManager.currentPlane,t=e.worldToLocal(this.tempElement.start.clone()),n=e.worldToLocal(this.tempElement.end.clone()),i=n.x-t.x,a=n.y-t.y;if(Math.sqrt(i*i+a*a)<1)return void this.hideAngleIndicator();let s=Math.atan2(a,i),l=THREE.MathUtils.radToDeg(s);l<0&&(l+=360);let h=!1;const r=Math.round(l);Math.abs(l-r)<.1&&(l=r,h=!0),(Math.abs(l-this.lastAngle)>.5||!this.angleIndicator)&&(this.lastAngle=l,this.hideAngleIndicator(),this.createAngleIndicator(t,n,l,h))}createAngleIndicator(e,t,n,i){const a=this.sketchManager.currentPlane,s=i?65280:7829503,l=t.x-e.x,h=t.y-e.y,r=Math.sqrt(l*l+h*h),o=Math.min(3,r/5);let c=Math.atan2(h,l);c<0&&(c+=2*Math.PI);const m=c,d=[];for(let t=0;t<=16;t++){const n=0+t/16*m,i=e.x+Math.cos(n)*o,a=e.y+Math.sin(n)*o;d.push(new THREE.Vector3(i,a,.05))}const g=(new THREE.BufferGeometry).setFromPoints(d),p=new THREE.LineBasicMaterial({color:s,linewidth:2,transparent:!0,opacity:.8});this.angleIndicator=new THREE.Line(g,p),this.angleIndicator.userData.isAngleIndicator=!0,this.createAngleLabel(e,c,o,n),a.add(this.angleIndicator)}createAngleLabel(e,t,n,i){const a=this.sketchManager.currentPlane,s=1.5*n;let l=t/2;t>Math.PI&&(l=t+(2*Math.PI-t)/2);const h=e.x+Math.cos(l)*s,r=e.y+Math.sin(l)*s,o=document.createElement("canvas"),c=o.getContext("2d");let m;o.width=300,o.height=90,c.clearRect(0,0,o.width,o.height),c.font="bold 34px Arial",c.fillStyle="#7777FF",c.textAlign="center",c.textBaseline="middle",m=Math.abs(i-0)<.1||Math.abs(i-360)<.1?"0° →":Math.abs(i-45)<.1?"45°":Math.abs(i-90)<.1?"90° ↑":Math.abs(i-135)<.1?"135°":Math.abs(i-180)<.1?"180° ←":Math.abs(i-225)<.1?"225°":Math.abs(i-270)<.1?"270° ↓":Math.abs(i-315)<.1?"315°":`${i.toFixed(1)}°`,c.fillText(m,o.width/2,o.height/2);const d=new THREE.CanvasTexture(o);d.minFilter=THREE.LinearFilter;const g=new THREE.SpriteMaterial({map:d,transparent:!0,opacity:.9});this.angleLabel=new THREE.Sprite(g);const p=new THREE.Vector3(h,r,.1);this.angleLabel.position.copy(p),this.angleLabel.scale.set(8,2,1),this.angleLabel.userData.isAngleLabel=!0,a.add(this.angleLabel)}hideAngleIndicator(){this.angleIndicator&&(this.angleIndicator.parent&&this.angleIndicator.parent.remove(this.angleIndicator),this.angleIndicator.geometry&&this.angleIndicator.geometry.dispose(),this.angleIndicator.material&&this.angleIndicator.material.dispose(),this.angleIndicator=null),this.angleLabel&&(this.angleLabel.parent&&this.angleLabel.parent.remove(this.angleLabel),this.angleLabel.material&&this.angleLabel.material.dispose(),this.angleLabel.material.map&&this.angleLabel.material.map.dispose(),this.angleLabel=null)}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();this.dimensionFields&&this.dimensionFields.length>0&&(this.dimensionFields[0]&&(this.dimensionFields[0].value=this.tempElement.length.toFixed(1)),this.dimensionFields[1]&&(this.dimensionFields[1].value=this.tempElement.angle.toFixed(1))),this.sketchManager.dimensionManager.showDimensionInput(e,t)}updateInputFields(){if(!this.sketchManager.dimensionManager.isInputActive||!this.tempElement)return;const e=[this.sketchManager.dimensionManager.inputField1,this.sketchManager.dimensionManager.inputField2,this.sketchManager.dimensionManager.inputField3];e[0]&&(e[0].value=this.tempElement.length.toFixed(1)),e[1]&&(e[1].value=this.tempElement.angle.toFixed(1))}applyDimensions(e){this.tempElement&&(e.value1&&e.value1>0&&this.updateLineLength(e.value1),void 0!==e.value2&&this.updateLineAngle(e.value2),this.sketchManager.elementManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.dimensionManager.clearDimensionObjects(),this.hideAngleIndicator(),this.tempElement=null)}updateLineLength(e){if(!this.tempElement)return;const t=THREE.MathUtils.degToRad(this.tempElement.angle);this.tempElement.end=this.tempElement.start.clone().add(new THREE.Vector3(Math.cos(t)*e,Math.sin(t)*e,0)),this.tempElement.points[1]=this.tempElement.end.clone(),this.tempElement.length=e,this.updateTempGeometry(),this.updateLineDimensions(),this.updateAngleIndicator()}updateLineAngle(e){if(!this.tempElement)return;this.tempElement.angle=e;const t=THREE.MathUtils.degToRad(e);this.tempElement.end=this.tempElement.start.clone().add(new THREE.Vector3(Math.cos(t)*this.tempElement.length,Math.sin(t)*this.tempElement.length,0)),this.tempElement.points[1]=this.tempElement.end.clone(),this.updateTempGeometry(),this.updateLineDimensions(),this.updateAngleIndicator()}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.hideAngleIndicator(),this.tempElement=null,this.sketchManager.dimensionManager.clearDimensionObjects()}clearTempGeometry(){super.clearTempGeometry(),this.hideAngleIndicator()}}