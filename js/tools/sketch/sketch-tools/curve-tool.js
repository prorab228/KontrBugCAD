class CurveSketchTool extends SketchToolBase{constructor(t){super(t,"curve","fa-wave-square"),this.controlPoints=[],this.segments=32,this.isDrawing=!1,this.dimensionFields=[{label:"Тип кривой",type:"select",options:["Квадратичная","Кубическая"],value:"Кубическая"},{label:"Сегменты",type:"number",value:this.segments,unit:"шт",min:8,max:100,step:4}]}onMouseDown(t){const e=this.getPointOnPlane(t);return!!e&&(this.controlPoints.push(e.clone()),1===this.controlPoints.length?(this.isDrawing=!0,this.tempElement={type:"curve",controlPoints:[e.clone()],curvePoints:[],segments:this.segments,curveType:"cubic",color:this.sketchManager.sketchColor},this.sketchManager.editor.showStatus("Добавлена первая точка. Добавьте контрольные точки (всего 4 для кубической кривой).","info"),this.createTempGeometry()):2===this.controlPoints.length?(this.tempElement.controlPoints.push(e.clone()),this.updateCurve(),this.sketchManager.editor.showStatus("Добавлена вторая точка. Добавьте еще точки для кривой.","info")):3===this.controlPoints.length?(this.tempElement.controlPoints.push(e.clone()),this.updateCurve(),this.sketchManager.editor.showStatus("Добавлена третья точка. Добавьте последнюю точку для кубической кривой.","info")):4===this.controlPoints.length&&(this.tempElement.controlPoints.push(e.clone()),this.updateCurve(),this.finishDrawing()),!0)}updateCurve(){if(!this.tempElement||this.tempElement.controlPoints.length<2)return;const t=this.tempElement.controlPoints.map(t=>{if(!this.sketchManager.currentPlane)return new THREE.Vector3;const e=this.sketchManager.currentPlane.worldToLocal(t.clone());return new THREE.Vector3(e.x,e.y,0)});let e;const n=t.length;2===n?e=new THREE.LineCurve(t[0],t[1]):3===n?(e=new THREE.QuadraticBezierCurve(t[0],t[1],t[2]),this.tempElement.curveType="quadratic"):n>=4&&(e=new THREE.CubicBezierCurve(t[0],t[1],t[2],t[3]),this.tempElement.curveType="cubic"),e&&(this.tempElement.curvePoints=e.getPoints(this.segments),this.tempElement.curvePoints=this.tempElement.curvePoints.map(t=>this.sketchManager.currentPlane?this.sketchManager.currentPlane.localToWorld(t):t),this.updateTempGeometry(),this.updateControlPointMarkers())}onMouseMove(t){if(!this.isDrawing||!this.tempElement)return;const e=this.getPointOnPlane(t);if(!e)return;const n=[...this.tempElement.controlPoints];if(1===n.length)this.tempElement.controlPoints=[n[0],e.clone()];else if(2===n.length)this.tempElement.controlPoints=[n[0],n[1],e.clone()];else if(3===n.length)this.tempElement.controlPoints=[n[0],n[1],n[2],e.clone()];else if(n.length>=4)return;this.updateCurve()}onKeyDown(t){return"Escape"===t.key&&this.isDrawing?(this.onCancel(),!0):"Enter"===t.key&&this.isDrawing&&this.controlPoints.length>=2?(this.finishDrawing(),!0):!!("Backspace"===t.key&&this.isDrawing&&this.controlPoints.length>1)&&(this.removeLastPoint(),!0)}onCancel(){this.controlPoints=[],this.isDrawing=!1,this.clearTempGeometry(),this.clearControlPointMarkers(),this.tempElement=null,this.sketchManager.editor.showStatus("Создание кривой отменено","info")}finishDrawing(){this.tempElement&&this.tempElement.curvePoints.length>=2?(this.sketchManager.elementManager.addElement(this.tempElement),this.sketchManager.editor.showStatus("Кривая создана","success")):this.sketchManager.editor.showStatus("Недостаточно точек для создания кривой","warning"),this.onCancel()}removeLastPoint(){!this.tempElement||this.controlPoints.length<=1?this.onCancel():(this.controlPoints.pop(),this.tempElement.controlPoints.pop(),0===this.controlPoints.length?this.onCancel():(this.updateCurve(),this.sketchManager.editor.showStatus("Последняя точка удалена","info")))}updateControlPointMarkers(){this.tempElement&&this.sketchManager.currentPlane&&(this.clearControlPointMarkers(),this.tempElement.controlPoints.forEach((t,e)=>{const n=this.sketchManager.currentPlane.worldToLocal(t.clone()),s=new THREE.BufferGeometry,o=new Float32Array([n.x-3,n.y,.1,n.x+3,n.y,.1,n.x,n.y-3,.1,n.x,n.y+3,.1]);s.setAttribute("position",new THREE.BufferAttribute(o,3));const i=new THREE.LineBasicMaterial({color:0===e||e===this.tempElement.controlPoints.length-1?16711680:65280,linewidth:2}),r=new THREE.LineSegments(s,i);r.userData={isControlPoint:!0,index:e},this.sketchManager.currentPlane.add(r),this.controlPointMarkers=this.controlPointMarkers||[],this.controlPointMarkers.push(r)}))}clearControlPointMarkers(){this.controlPointMarkers&&(this.controlPointMarkers.forEach(t=>{t.parent&&t.parent.remove(t),t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.controlPointMarkers=[])}createGeometry(t){if(!t.curvePoints||t.curvePoints.length<2)return null;const e=[];t.curvePoints.forEach(t=>{const n=this.sketchManager.currentPlane.worldToLocal(t.clone());e.push(n.x,n.y,0)});const n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),new THREE.Line(n,new THREE.LineBasicMaterial({color:t.color,linewidth:2}))}updateGeometry(t,e){if(!e.curvePoints||e.curvePoints.length<2)return;const n=[];e.curvePoints.forEach(t=>{const e=this.sketchManager.currentPlane.worldToLocal(t.clone());n.push(e.x,e.y,0)}),t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),t.geometry.attributes.position.needsUpdate=!0}clearTempGeometry(){super.clearTempGeometry(),this.clearControlPointMarkers()}}