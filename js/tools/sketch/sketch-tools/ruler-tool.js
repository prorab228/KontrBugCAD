class RulerSketchTool extends SketchToolBase{constructor(e){super(e,"ruler","fa-ruler"),this.measurements=[],this.currentMeasurement=null,this.dimensionFields=[{label:"Длина",type:"number",value:0,unit:"мм",min:0,step:.1}]}onMouseDown(e){if(this.sketchManager.isInputActive)return this.sketchManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.currentMeasurement?1===this.currentMeasurement.stage&&(this.currentMeasurement.end=t.clone(),this.currentMeasurement.length=this.currentMeasurement.start.distanceTo(t),this.currentMeasurement.stage=2,this.createMeasurementLine(),this.updateMeasurementDimension(),this.finalizeMeasurement(),!0):(this.currentMeasurement={id:"measure_"+Date.now(),start:t.clone(),end:t.clone(),length:0,line:null,dimension:null,color:3447003,stage:1},this.sketchManager.editor.showStatus("Установлена первая точка. Установите вторую точку.","info"),!0))}onMouseMove(e){if(!this.currentMeasurement||1!==this.currentMeasurement.stage)return;const t=this.getPointOnPlane(e);t&&(this.currentMeasurement.end=t.clone(),this.currentMeasurement.length=this.currentMeasurement.start.distanceTo(t),this.currentMeasurement.line?this.updateMeasurementLine():this.createMeasurementLine(),this.updateMeasurementDimension(),this.sketchManager.isInputActive&&this.updateInputFields())}onKeyDown(e){return"Escape"===e.key?(this.currentMeasurement?(this.clearCurrentMeasurement(),this.sketchManager.editor.showStatus("Измерение отменено","info")):this.clearAllMeasurements(),!0):"Enter"===e.key&&this.currentMeasurement&&1===this.currentMeasurement.stage?(this.currentMeasurement.stage=2,this.createMeasurementLine(),this.updateMeasurementDimension(),this.finalizeMeasurement(),!0):"Delete"===e.key&&(this.clearAllMeasurements(),!0)}onCancel(){this.clearCurrentMeasurement(),this.sketchManager.clearDimensionObjects()}onDeactivate(){this.clearAllMeasurements()}createMeasurementLine(){if(!this.currentMeasurement||!this.sketchManager.currentPlane)return;this.currentMeasurement.line&&(this.sketchManager.currentPlane.remove(this.currentMeasurement.line),this.currentMeasurement.line.geometry.dispose(),this.currentMeasurement.line.material.dispose());const e=this.currentMeasurement.start,t=this.currentMeasurement.end;if(e.distanceTo(t)>0){const r=(new THREE.BufferGeometry).setFromPoints([this.sketchManager.currentPlane.worldToLocal(e.clone()),this.sketchManager.currentPlane.worldToLocal(t.clone())]),n=new THREE.LineDashedMaterial({color:this.currentMeasurement.color,linewidth:2,dashSize:2,gapSize:1,scale:1});this.currentMeasurement.line=new THREE.Line(r,n),this.currentMeasurement.line.userData={isMeasurement:!0,measurementId:this.currentMeasurement.id},this.sketchManager.currentPlane.add(this.currentMeasurement.line),this.currentMeasurement.line.computeLineDistances()}}updateMeasurementLine(){if(!this.currentMeasurement||!this.currentMeasurement.line)return;const e=(new THREE.BufferGeometry).setFromPoints([this.sketchManager.currentPlane.worldToLocal(this.currentMeasurement.start.clone()),this.sketchManager.currentPlane.worldToLocal(this.currentMeasurement.end.clone())]);this.currentMeasurement.line.geometry.dispose(),this.currentMeasurement.line.geometry=e,this.currentMeasurement.line.computeLineDistances()}updateMeasurementDimension(){if(!this.currentMeasurement||this.currentMeasurement.length<=0)return;this.currentMeasurement.dimension&&this.currentMeasurement.dimension.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.currentMeasurement.dimension=[];const e=this.currentMeasurement.start,t=this.currentMeasurement.end;if(!this.sketchManager.currentPlane)return;const r=this.sketchManager.currentPlane.worldToLocal(e.clone()),n=this.sketchManager.currentPlane.worldToLocal(t.clone()),s=n.x-r.x,i=n.y-r.y,a=Math.sqrt(s*s+i*i),u=new THREE.Vector3(s,i,0).normalize(),c=new THREE.Vector3(-u.y,u.x,0).normalize(),o=new THREE.Vector3(r.x+8*c.x,r.y+8*c.y,.2),h=new THREE.Vector3(n.x+8*c.x,n.y+8*c.y,.2),m=(new THREE.BufferGeometry).setFromPoints([o,h]),l=new THREE.LineBasicMaterial({color:this.currentMeasurement.color,linewidth:2}),M=new THREE.Line(m,l),d=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(r.x,r.y,.2),o]),new THREE.LineBasicMaterial({color:this.currentMeasurement.color,linewidth:1})),p=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(n.x,n.y,.2),h]),new THREE.LineBasicMaterial({color:this.currentMeasurement.color,linewidth:1})),E=(new THREE.Vector3).addVectors(o,h).multiplyScalar(.5).add(new THREE.Vector3(4*-c.y,4*c.x,.2)),g=document.createElement("canvas"),w=g.getContext("2d");g.width=256,g.height=64,w.clearRect(0,0,g.width,g.height),w.font="bold 12px Arial",w.fillStyle="#3498db",w.textAlign="center",w.textBaseline="middle",w.fillText(`${a.toFixed(1)} мм`,g.width/2,g.height/2);const f=new THREE.CanvasTexture(g);f.minFilter=THREE.LinearFilter;const T=new THREE.SpriteMaterial({map:f,transparent:!0}),y=new THREE.Sprite(T);y.position.copy(E),y.scale.set(18,4,1),[M,d,p,y].forEach(e=>{e.userData={isMeasurement:!0,measurementId:this.currentMeasurement.id},this.sketchManager.currentPlane.add(e),this.currentMeasurement.dimension.push(e)})}finalizeMeasurement(){if(!this.currentMeasurement||this.currentMeasurement.length<=0)return void this.clearCurrentMeasurement();this.measurements.push({...this.currentMeasurement,finalized:!0});this.getDimensionConfig().fields[0].value=this.currentMeasurement.length.toFixed(1),this.sketchManager.editor.showStatus(`Измерение: ${this.currentMeasurement.length.toFixed(1)} мм. Нажмите Esc для удаления, Enter для нового измерения.`,"info"),this.currentMeasurement=null}clearCurrentMeasurement(){this.currentMeasurement&&(this.currentMeasurement.line&&(this.sketchManager.currentPlane.remove(this.currentMeasurement.line),this.currentMeasurement.line.geometry.dispose(),this.currentMeasurement.line.material.dispose()),this.currentMeasurement.dimension&&this.currentMeasurement.dimension.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()}),this.currentMeasurement=null)}clearAllMeasurements(){this.clearCurrentMeasurement(),this.measurements.forEach(e=>{e.line&&e.line.parent&&(e.line.parent.remove(e.line),e.line.geometry.dispose(),e.line.material.dispose()),e.dimension&&e.dimension.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()})}),this.measurements=[],this.sketchManager.editor.showStatus("Все измерения удалены","info")}updateInputFields(){this.sketchManager.isInputActive&&this.currentMeasurement&&this.sketchManager.inputField1&&(this.sketchManager.inputField1.value=this.currentMeasurement.length.toFixed(1))}applyDimensions(e){if(this.currentMeasurement){if(e.value1&&e.value1>0){this.currentMeasurement.length=e.value1;const t=(new THREE.Vector3).subVectors(this.currentMeasurement.end,this.currentMeasurement.start).normalize();0===t.length()&&t.set(1,0,0),this.currentMeasurement.end=this.currentMeasurement.start.clone().add(t.multiplyScalar(e.value1)),this.updateMeasurementLine(),this.updateMeasurementDimension()}this.finalizeMeasurement()}}}