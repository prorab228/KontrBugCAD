import*as THREE from"three";import{SketchToolBase}from"./sketch-tool-base.js";export class RulerSketchTool extends SketchToolBase{constructor(e){super(e,"ruler","fa-ruler"),this.measurements=[],this.currentMeasurement=null,this.dimensionFields=[{label:"Длина",type:"number",value:0,unit:"мм",min:0,step:.1}]}onMouseDown(e){if(this.sketchManager.dimensionManager.isInputActive)return this.sketchManager.dimensionManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.currentMeasurement?1===this.currentMeasurement.stage&&(this.currentMeasurement.end=t.clone(),this.currentMeasurement.length=this.currentMeasurement.start.distanceTo(t),this.currentMeasurement.stage=2,this.createMeasurementLine(),this.updateMeasurementDimension(),this.finalizeMeasurement(),!0):(this.currentMeasurement={id:"measure_"+Date.now(),start:t.clone(),end:t.clone(),length:0,line:null,dimension:null,color:3447003,stage:1},this.sketchManager.editor.showStatus("Установлена первая точка. Установите вторую точку.","info"),!0))}onMouseMove(e){if(!this.currentMeasurement||1!==this.currentMeasurement.stage)return;const t=this.getPointOnPlane(e);t&&(this.currentMeasurement.end=t.clone(),this.currentMeasurement.length=this.currentMeasurement.start.distanceTo(t),this.currentMeasurement.line?this.updateMeasurementLine():this.createMeasurementLine(),this.updateMeasurementDimension(),this.sketchManager.dimensionManager.isInputActive&&this.updateInputFields())}onKeyDown(e){return"Escape"===e.key?(this.currentMeasurement?(this.clearCurrentMeasurement(),this.sketchManager.editor.showStatus("Измерение отменено","info")):this.clearAllMeasurements(),!0):"Enter"===e.key&&this.currentMeasurement&&1===this.currentMeasurement.stage?(this.currentMeasurement.stage=2,this.createMeasurementLine(),this.updateMeasurementDimension(),this.finalizeMeasurement(),!0):"Delete"===e.key&&(this.clearAllMeasurements(),!0)}onCancel(){this.clearCurrentMeasurement(),this.sketchManager.dimensionManager.clearDimensionObjects()}onDeactivate(){this.clearAllMeasurements()}createMeasurementLine(){if(!this.currentMeasurement||!this.sketchManager.currentPlane)return;this.currentMeasurement.line&&(this.sketchManager.currentPlane.remove(this.currentMeasurement.line),this.currentMeasurement.line.geometry.dispose(),this.currentMeasurement.line.material.dispose());const e=this.currentMeasurement.start,t=this.currentMeasurement.end;if(e.distanceTo(t)>0){const n=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e.x,e.y,.01),new THREE.Vector3(t.x,t.y,.01)]),r=new THREE.LineDashedMaterial({color:this.currentMeasurement.color,linewidth:2,dashSize:2,gapSize:1,scale:1});this.currentMeasurement.line=new THREE.Line(n,r),this.currentMeasurement.line.userData={isMeasurement:!0,measurementId:this.currentMeasurement.id},this.sketchManager.currentPlane.add(this.currentMeasurement.line),this.currentMeasurement.line.computeLineDistances()}}updateMeasurementLine(){if(!this.currentMeasurement||!this.currentMeasurement.line)return;const e=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(this.currentMeasurement.start.x,this.currentMeasurement.start.y,.01),new THREE.Vector3(this.currentMeasurement.end.x,this.currentMeasurement.end.y,.01)]);this.currentMeasurement.line.geometry.dispose(),this.currentMeasurement.line.geometry=e,this.currentMeasurement.line.computeLineDistances()}updateMeasurementDimension(){if(!this.currentMeasurement||this.currentMeasurement.length<=0)return;this.currentMeasurement.dimension&&this.currentMeasurement.dimension.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.currentMeasurement.dimension=[];const e=this.currentMeasurement.start,t=this.currentMeasurement.end,n=t.x-e.x,r=t.y-e.y,s=Math.sqrt(n*n+r*r),i=new THREE.Vector3(n,r,0).normalize(),a=new THREE.Vector3(-i.y,i.x,0).normalize(),u=new THREE.Vector3(e.x+8*a.x,e.y+8*a.y,.2),m=new THREE.Vector3(t.x+8*a.x,t.y+8*a.y,.2),c=(new THREE.BufferGeometry).setFromPoints([u,m]),o=new THREE.LineBasicMaterial({color:this.currentMeasurement.color,linewidth:2}),h=new THREE.Line(c,o),l=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(e.x,e.y,.2),u]),new THREE.LineBasicMaterial({color:this.currentMeasurement.color,linewidth:1})),M=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(t.x,t.y,.2),m]),new THREE.LineBasicMaterial({color:this.currentMeasurement.color,linewidth:1})),d=(new THREE.Vector3).addVectors(u,m).multiplyScalar(.5).add(new THREE.Vector3(4*-a.y,4*a.x,.2)),E=document.createElement("canvas"),p=E.getContext("2d");E.width=256,E.height=64,p.clearRect(0,0,E.width,E.height),p.font="bold 12px Arial",p.fillStyle="#3498db",p.textAlign="center",p.textBaseline="middle",p.fillText(`${s.toFixed(1)} мм`,E.width/2,E.height/2);const g=new THREE.CanvasTexture(E);g.minFilter=THREE.LinearFilter;const w=new THREE.SpriteMaterial({map:g,transparent:!0}),f=new THREE.Sprite(w);f.position.copy(d),f.scale.set(18,4,1),[h,l,M,f].forEach(e=>{e.userData={isMeasurement:!0,measurementId:this.currentMeasurement.id},this.sketchManager.currentPlane.add(e),this.currentMeasurement.dimension.push(e)})}finalizeMeasurement(){if(!this.currentMeasurement||this.currentMeasurement.length<=0)return void this.clearCurrentMeasurement();this.measurements.push({...this.currentMeasurement,finalized:!0});this.getDimensionConfig().fields[0].value=this.currentMeasurement.length.toFixed(1),this.sketchManager.editor.showStatus(`Измерение: ${this.currentMeasurement.length.toFixed(1)} мм. Нажмите Esc для удаления, Enter для нового измерения.`,"info"),this.currentMeasurement=null}clearCurrentMeasurement(){this.currentMeasurement&&(this.currentMeasurement.line&&(this.sketchManager.currentPlane.remove(this.currentMeasurement.line),this.currentMeasurement.line.geometry.dispose(),this.currentMeasurement.line.material.dispose()),this.currentMeasurement.dimension&&this.currentMeasurement.dimension.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()}),this.currentMeasurement=null)}clearAllMeasurements(){this.clearCurrentMeasurement(),this.measurements.forEach(e=>{e.line&&e.line.parent&&(e.line.parent.remove(e.line),e.line.geometry.dispose(),e.line.material.dispose()),e.dimension&&e.dimension.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()})}),this.measurements=[],this.sketchManager.editor.showStatus("Все измерения удалены","info")}updateInputFields(){this.sketchManager.dimensionManager.isInputActive&&this.currentMeasurement&&this.sketchManager.dimensionManager.inputField1&&(this.sketchManager.dimensionManager.inputField1.value=this.currentMeasurement.length.toFixed(1))}applyDimensions(e){if(this.currentMeasurement){if(e.value1&&e.value1>0){this.currentMeasurement.length=e.value1;const t=(new THREE.Vector3).subVectors(this.currentMeasurement.end,this.currentMeasurement.start).normalize();0===t.length()&&t.set(1,0,0),this.currentMeasurement.end=this.currentMeasurement.start.clone().add(t.multiplyScalar(e.value1)),this.updateMeasurementLine(),this.updateMeasurementDimension()}this.finalizeMeasurement()}}}