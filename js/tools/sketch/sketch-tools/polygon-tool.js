import*as THREE from"three";import{SketchToolBase}from"./sketch-tool-base.js";export class PolygonSketchTool extends SketchToolBase{constructor(e){super(e,"polygon","fa-shapes"),this.radius=5,this.sides=6,this.dimensionFields=[{label:"Радиус опис. окр.",type:"number",value:this.radius,unit:"мм",min:1,step:1},{label:"Вершины",type:"number",value:this.sides,unit:"шт",min:3,max:20,step:1}]}onMouseDown(e){if(this.sketchManager.dimensionManager.isInputActive)return this.sketchManager.dimensionManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.isDrawing=!0,this.tempElement={type:"polygon",center:t.clone(),radius:0,sides:this.sides,points:this.calculatePolygonPoints(t,0,this.sides),color:this.sketchManager.sketchColor},this.createTempGeometry(),!0)}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);t&&(this.tempElement.radius=this.tempElement.center.distanceTo(t),this.tempElement.points=this.calculatePolygonPoints(this.tempElement.center,this.tempElement.radius,this.tempElement.sides),this.updateTempGeometry(),this.sketchManager.dimensionManager.isInputActive&&this.updateInputFields())}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.finishDrawing(e),this.isDrawing=!1}onKeyDown(e){return!("Escape"!==e.key||!this.isDrawing)&&(this.onCancel(),!0)}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.dimensionManager.clearDimensionObjects()}finishDrawing(e){const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.radius.toFixed(1),t.fields[1].value=this.tempElement.sides,this.sketchManager.dimensionManager.showDimensionInput(e,t)}updateInputFields(){this.sketchManager.dimensionManager.isInputActive&&this.tempElement&&(this.sketchManager.dimensionManager.inputField1&&(this.sketchManager.dimensionManager.inputField1.value=this.tempElement.radius.toFixed(1)),this.sketchManager.dimensionManager.inputField2&&(this.sketchManager.dimensionManager.inputField2.value=this.tempElement.sides))}applyDimensions(e){this.tempElement&&(e.value1&&e.value1>0&&(this.tempElement.radius=e.value1),e.value2&&e.value2>=3&&(this.tempElement.sides=Math.min(20,Math.max(3,e.value2))),this.tempElement.points=this.calculatePolygonPoints(this.tempElement.center,this.tempElement.radius,this.tempElement.sides),this.sketchManager.elementManager.addElement(this.tempElement),this.clearTempGeometry(),this.tempElement=null)}calculatePolygonPoints(e,t,i){const s=[];for(let n=0;n<=i;n++){const a=n/i*Math.PI*2,o=e.x+Math.cos(a)*t,r=e.y+Math.sin(a)*t;s.push(new THREE.Vector3(o,r,0))}return s}createGeometry(e){const t=[];e.points.forEach(e=>{t.push(e.x,e.y,.01)});const i=new THREE.BufferGeometry;return i.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),new THREE.LineLoop(i,new THREE.LineBasicMaterial({color:e.color,linewidth:2}))}updateGeometry(e,t){const i=[];t.points.forEach(e=>{i.push(e.x,e.y,.01)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),e.geometry.attributes.position.needsUpdate=!0}}