class LineSketchTool extends SketchToolBase{constructor(e){super(e,"line","fa-slash"),this.dimensionFields=[{label:"Длина",type:"number",value:10,unit:"мм",min:1,step:1}]}onMouseDown(e){if(console.log("line onMouseDown"),this.sketchManager.dimensionManager.isInputActive)return this.sketchManager.dimensionManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);if(!t)return!1;this.isDrawing=!0,this.tempElement={type:"line",start:t.clone(),end:t.clone(),length:0,points:[t.clone(),t.clone()],color:this.sketchManager.sketchColor,startElement:null};const n=this.sketchManager.snapHelper;return n&&n.currentSnapPoint&&(this.tempElement.startElement=n.currentSnapPoint.element),this.createTempGeometry(),!0}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);t&&(this.tempElement.originalEnd=t.clone(),this.tempElement.end=t.clone(),this.tempElement.points[1]=t.clone(),this.tempElement.length=this.tempElement.start.distanceTo(t),this.updateTempGeometry(),this.updateLineDimensions(this.tempElement.start,this.tempElement.end),this.sketchManager.dimensionManager.isInputActive&&(this.sketchManager.dimensionManager.isInputFocused||this.updateInputFields()))}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.length.toFixed(1),this.sketchManager.dimensionManager.showDimensionInput(e,t)}updateInputFields(){this.sketchManager.isInputActive&&this.tempElement&&this.sketchManager.inputField1&&(this.sketchManager.inputField1.value=this.tempElement.length.toFixed(1))}applyDimensions(e){this.tempElement&&(e.value1&&e.value1>0&&this.updateLineLength(e.value1),this.sketchManager.elementManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.dimensionManager.clearDimensionObjects(),this.tempElement=null)}updateLineLength(e){if(!this.tempElement)return;this.tempElement.length=e;const t=(new THREE.Vector3).subVectors(this.tempElement.end,this.tempElement.start).normalize();0===t.length()&&t.set(1,0,0),this.tempElement.end=this.tempElement.start.clone().add(t.multiplyScalar(e)),this.tempElement.points[1]=this.tempElement.end.clone(),this.updateTempGeometry(),this.updateLineDimensions(this.tempElement.start,this.tempElement.end)}updateLineDimensions(e,t){this.sketchManager.dimensionManager.clearDimensionObjects(),this.createLineDimension(e,t)}createLineDimension(e,t){if(!this.sketchManager.currentPlane)return;const n=this.sketchManager.currentPlane.worldToLocal(e.clone()),i=this.sketchManager.currentPlane.worldToLocal(t.clone()),s=i.x-n.x,a=i.y-n.y,r=Math.sqrt(s*s+a*a),o=new THREE.Vector3(s,a,0).normalize(),l=new THREE.Vector3(-o.y,o.x,0).normalize(),h=new THREE.Vector3(n.x+10*l.x,n.y+10*l.y,.1),c=new THREE.Vector3(i.x+10*l.x,i.y+10*l.y,.1),m=(new THREE.BufferGeometry).setFromPoints([h,c]),E=new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:2}),p=new THREE.Line(m,E),u=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(n.x,n.y,.1),h]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),d=new THREE.Line((new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(i.x,i.y,.1),c]),new THREE.LineBasicMaterial({color:this.sketchManager.dimensionColor,linewidth:1})),g=(new THREE.Vector3).addVectors(h,c).multiplyScalar(.5).add(new THREE.Vector3(5*-l.y,5*l.x,.1));this.createDimensionText(g,`${r.toFixed(1)} мм`),[p,u,d].forEach(e=>{e.userData.isDimension=!0,this.sketchManager.currentPlane.add(e),this.sketchManager.dimensionObjects.push(e)})}createDimensionText(e,t){const n=document.createElement("canvas"),i=n.getContext("2d");n.width=256,n.height=64,i.clearRect(0,0,n.width,n.height),i.font="bold 16px Arial",i.fillStyle="#00C853",i.textAlign="center",i.textBaseline="middle",i.fillText(t,n.width/2,n.height/2);const s=new THREE.CanvasTexture(n);s.minFilter=THREE.LinearFilter;const a=new THREE.SpriteMaterial({map:s,transparent:!0}),r=new THREE.Sprite(a);r.position.copy(e),r.scale.set(20,5,1),r.userData.isDimension=!0,this.sketchManager.currentPlane.add(r),this.sketchManager.dimensionObjects.push(r)}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.dimensionManager.clearDimensionObjects()}createGeometry(e){const t=[];e.points.forEach(e=>{const n=this.sketchManager.currentPlane.worldToLocal(e.clone());t.push(n.x,n.y,0)});const n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.Float32BufferAttribute(t,3)),new THREE.Line(n,new THREE.LineBasicMaterial({color:e.color,linewidth:2}))}updateGeometry(e,t){const n=[];t.points.forEach(e=>{const t=this.sketchManager.currentPlane.worldToLocal(e.clone());n.push(t.x,t.y,0)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),e.geometry.attributes.position.needsUpdate=!0}}