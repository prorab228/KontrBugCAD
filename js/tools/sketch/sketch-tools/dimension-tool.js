class DimensionSketchTool extends SketchToolBase{constructor(e){super(e,"dimension","fa-ruler-combined"),this.selectedElement=null,this.tempDimensionGroup=null}onMouseDown(e){const t=this.getPointOnPlane(e);if(!t)return!1;const n=this.sketchManager.elementManager.getElementAtPoint(t);return n?(this.showElementDimensions(n),!0):(this.clearTempDimensions(),this.selectedElement=null,!0)}onKeyDown(e){if("Escape"===e.key)return this.clearTempDimensions(),this.selectedElement=null,!0;if("d"===e.key||"в"===e.key){if(this.selectedElement&&this.tempDimensionGroup)return this.makeDimensionsPersistent(),!0}else if("Delete"===e.key)return this.deleteSelectedDimensions(),!0;return!1}onCancel(){this.clearTempDimensions(),this.selectedElement=null}showElementDimensions(e){if(e&&e.mesh){switch(this.clearTempDimensions(),this.selectedElement=e,this.tempDimensionGroup=new THREE.Group,this.tempDimensionGroup.name="temp_dimension_group",this.tempDimensionGroup.userData={type:"dimension_group",isTemporary:!0,elementId:e.mesh.uuid},e.type){case"line":this.createLineDimension(e);break;case"rectangle":this.createRectangleDimension(e);break;case"circle":this.createCircleDimension(e);break;case"oval":this.createOvalDimension(e);break;case"polygon":this.createPolygonDimension(e);break;case"arc":this.createArcDimension(e);break;default:return void this.sketchManager.editor.showStatus("Размеры для данного типа элемента не поддерживаются","warning")}this.tempDimensionGroup.children.length>0&&this.sketchManager.currentPlane.add(this.tempDimensionGroup),this.sketchManager.editor.showStatus("Показаны размеры элемента. Нажмите D чтобы сохранить, Esc чтобы отменить.","info")}}createLineDimension(e){if(!e.mesh||!e.mesh.geometry)return;const t=e.mesh.geometry.attributes.position;if(!t||t.count<2)return;const n=new THREE.Vector3(t.getX(0),t.getY(0),0),i=new THREE.Vector3(t.getX(1),t.getY(1),0),r=i.x-n.x,s=i.y-n.y,o=Math.sqrt(r*r+s*s);if(0===o)return;const a=new THREE.Vector3(r,s,0).normalize(),c=new THREE.Vector3(-a.y,a.x,0).normalize(),h=new THREE.Vector3(n.x+8*c.x,n.y+8*c.y,.2),m=new THREE.Vector3(i.x+8*c.x,i.y+8*c.y,.2),l=(new THREE.BufferGeometry).setFromPoints([h,m]),E=new THREE.LineBasicMaterial({color:3447003,linewidth:2}),u=new THREE.Line(l,E),d=this.createLine([new THREE.Vector3(n.x,n.y,.2),h],{color:3447003,linewidth:1}),w=this.createLine([new THREE.Vector3(i.x,i.y,.2),m],{color:3447003,linewidth:1}),p=(new THREE.Vector3).addVectors(h,m).multiplyScalar(.5).add(new THREE.Vector3(5*-c.y,5*c.x,.2));[u,d,w,this.createTextSprite(p,`${o.toFixed(1)} мм`,12)].forEach(e=>{e.userData.dimensionType="line",this.tempDimensionGroup.add(e)})}createRectangleDimension(e){if(!e.mesh||!e.mesh.geometry)return;const t=e.mesh.geometry.attributes.position;if(!t||t.count<4)return;const n=[];for(let e=0;e<Math.min(t.count,5);e++)n.push(new THREE.Vector3(t.getX(e),t.getY(e),0));if(n.length<3)return;let i=1/0,r=-1/0,s=1/0,o=-1/0;n.forEach(e=>{i=Math.min(i,e.x),r=Math.max(r,e.x),s=Math.min(s,e.y),o=Math.max(o,e.y)});const a=r-i,c=o-s,h=this.createLine([new THREE.Vector3(i,s-12,.2),new THREE.Vector3(r,s-12,.2)],{color:3447003,linewidth:2}),m=this.createLine([new THREE.Vector3(i,s,.2),new THREE.Vector3(i,s-12,.2)],{color:3447003,linewidth:1}),l=this.createLine([new THREE.Vector3(r,s,.2),new THREE.Vector3(r,s-12,.2)],{color:3447003,linewidth:1}),E=new THREE.Vector3(i+a/2,s-12-4,.2),u=this.createTextSprite(E,`${a.toFixed(1)} мм`,12),d=this.createLine([new THREE.Vector3(r+12,s,.2),new THREE.Vector3(r+12,o,.2)],{color:3447003,linewidth:2}),w=this.createLine([new THREE.Vector3(r,s,.2),new THREE.Vector3(r+12,s,.2)],{color:3447003,linewidth:1}),p=this.createLine([new THREE.Vector3(r,o,.2),new THREE.Vector3(r+12,o,.2)],{color:3447003,linewidth:1}),T=new THREE.Vector3(r+12+4,s+c/2,.2);[h,m,l,u,d,w,p,this.createTextSprite(T,`${c.toFixed(1)} мм`,12)].forEach(e=>{e.userData.dimensionType="rectangle",this.tempDimensionGroup.add(e)})}createCircleDimension(e){if(!e.mesh)return;let t,n;if(e.mesh.userData.center)t=e.mesh.userData.center,n=e.mesh.userData.radius||5;else{const i=e.mesh.geometry.attributes.position;if(!i)return;let r=0,s=0;const o=i.count;for(let e=0;e<o;e++)r+=i.getX(e),s+=i.getY(e);t=new THREE.Vector3(r/o,s/o,0);let a=0;for(let e=0;e<o;e++){a+=new THREE.Vector3(i.getX(e),i.getY(e),0).distanceTo(t)}n=a/o}if(n<=0)return;const i=2*n,r=this.createLine([new THREE.Vector3(t.x-n,t.y-8,.2),new THREE.Vector3(t.x+n,t.y-8,.2)],{color:3447003,linewidth:2}),s=this.createLine([new THREE.Vector3(t.x-n,t.y,.2),new THREE.Vector3(t.x-n,t.y-8,.2)],{color:3447003,linewidth:1}),o=this.createLine([new THREE.Vector3(t.x+n,t.y,.2),new THREE.Vector3(t.x+n,t.y-8,.2)],{color:3447003,linewidth:1}),a=new THREE.Vector3(t.x,t.y-8-4,.2);[r,s,o,this.createTextSprite(a,`Ø${i.toFixed(1)}`,12)].forEach(e=>{e.userData.dimensionType="circle",this.tempDimensionGroup.add(e)})}createOvalDimension(e){if(!e.mesh)return;let t,n,i;if(e.mesh.userData.center&&e.mesh.userData.width&&e.mesh.userData.height)t=e.mesh.userData.center,n=e.mesh.userData.width,i=e.mesh.userData.height;else{const r=e.mesh.geometry.attributes.position;if(!r)return;let s=1/0,o=-1/0,a=1/0,c=-1/0;for(let e=0;e<r.count;e++){const t=r.getX(e),n=r.getY(e);s=Math.min(s,t),o=Math.max(o,t),a=Math.min(a,n),c=Math.max(c,n)}t=new THREE.Vector3((s+o)/2,(a+c)/2,0),n=o-s,i=c-a}if(n<=0||i<=0)return;const r=this.createLine([new THREE.Vector3(t.x-n/2,t.y-8,.2),new THREE.Vector3(t.x+n/2,t.y-8,.2)],{color:3447003,linewidth:2}),s=this.createLine([new THREE.Vector3(t.x-n/2,t.y,.2),new THREE.Vector3(t.x-n/2,t.y-8,.2)],{color:3447003,linewidth:1}),o=this.createLine([new THREE.Vector3(t.x+n/2,t.y,.2),new THREE.Vector3(t.x+n/2,t.y-8,.2)],{color:3447003,linewidth:1}),a=new THREE.Vector3(t.x,t.y-8-4,.2),c=this.createTextSprite(a,`${n.toFixed(1)} мм`,12),h=this.createLine([new THREE.Vector3(t.x+8,t.y-i/2,.2),new THREE.Vector3(t.x+8,t.y+i/2,.2)],{color:3447003,linewidth:2}),m=this.createLine([new THREE.Vector3(t.x,t.y-i/2,.2),new THREE.Vector3(t.x+8,t.y-i/2,.2)],{color:3447003,linewidth:1}),l=this.createLine([new THREE.Vector3(t.x,t.y+i/2,.2),new THREE.Vector3(t.x+8,t.y+i/2,.2)],{color:3447003,linewidth:1}),E=new THREE.Vector3(t.x+8+4,t.y,.2);[r,s,o,c,h,m,l,this.createTextSprite(E,`${i.toFixed(1)} мм`,12)].forEach(e=>{e.userData.dimensionType="oval",this.tempDimensionGroup.add(e)})}createPolygonDimension(e){if(!e.mesh)return;let t,n;if(e.mesh.userData.center&&e.mesh.userData.radius)t=e.mesh.userData.center,n=e.mesh.userData.radius;else{const i=e.mesh.geometry.attributes.position;if(!i)return;let r=1/0,s=-1/0,o=1/0,a=-1/0;for(let e=0;e<i.count;e++){const t=i.getX(e),n=i.getY(e);r=Math.min(r,t),s=Math.max(s,t),o=Math.min(o,n),a=Math.max(a,n)}t=new THREE.Vector3((r+s)/2,(o+a)/2,0),n=0;for(let e=0;e<i.count;e++){const r=new THREE.Vector3(i.getX(e),i.getY(e),0);n=Math.max(n,r.distanceTo(t))}}if(n<=0)return;const i=2*n,r=this.createLine([new THREE.Vector3(t.x-n,t.y-8,.2),new THREE.Vector3(t.x+n,t.y-8,.2)],{color:3447003,linewidth:2}),s=this.createLine([new THREE.Vector3(t.x-n,t.y,.2),new THREE.Vector3(t.x-n,t.y-8,.2)],{color:3447003,linewidth:1}),o=this.createLine([new THREE.Vector3(t.x+n,t.y,.2),new THREE.Vector3(t.x+n,t.y-8,.2)],{color:3447003,linewidth:1}),a=e.mesh.userData.sides||6,c=new THREE.Vector3(t.x,t.y-8-4,.2);[r,s,o,this.createTextSprite(c,`Ø${i.toFixed(1)} (${a} уг.)`,12)].forEach(e=>{e.userData.dimensionType="polygon",this.tempDimensionGroup.add(e)})}createArcDimension(e){if(!e.mesh)return;const t=e.mesh.userData.center||new THREE.Vector3(0,0,0),n=e.mesh.userData.radius||5;if(n<=0)return;const i=this.createLine([new THREE.Vector3(t.x,t.y-8,.2),new THREE.Vector3(t.x+n,t.y-8,.2)],{color:3447003,linewidth:2}),r=new THREE.Vector3(t.x+n/2,t.y-8-4,.2);[i,this.createTextSprite(r,`R${n.toFixed(1)}`,12)].forEach(e=>{e.userData.dimensionType="arc",this.tempDimensionGroup.add(e)})}createLine(e,t={}){const n=(new THREE.BufferGeometry).setFromPoints(e),i=new THREE.LineBasicMaterial({color:t.color||3447003,linewidth:t.linewidth||1}),r=new THREE.Line(n,i);return r.userData.isDimension=!0,r.userData.isTemporary=!0,r}createTextSprite(e,t,n=12){const i=document.createElement("canvas"),r=i.getContext("2d");i.width=256,i.height=64,r.clearRect(0,0,i.width,i.height),r.font=`bold ${n}px Arial`,r.fillStyle="#3498db",r.textAlign="center",r.textBaseline="middle",r.fillText(t,i.width/2,i.height/2);const s=new THREE.CanvasTexture(i);s.minFilter=THREE.LinearFilter;const o=new THREE.SpriteMaterial({map:s,transparent:!0}),a=new THREE.Sprite(o);return a.position.copy(e),a.scale.set(20,5,1),a.userData.isDimension=!0,a.userData.isTemporary=!0,a}clearTempDimensions(){this.tempDimensionGroup&&this.tempDimensionGroup.parent&&(this.tempDimensionGroup.parent.remove(this.tempDimensionGroup),this.tempDimensionGroup.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()})),this.tempDimensionGroup=null}makeDimensionsPersistent(){if(!this.tempDimensionGroup||0===this.tempDimensionGroup.children.length)return void this.sketchManager.editor.showStatus("Нет размеров для сохранения","warning");const e=this.tempDimensionGroup.clone();e.name="dimension_group_"+Date.now(),e.userData.isTemporary=!1,e.userData.type="sketch_element",e.userData.elementType="dimension",e.userData.createdAt=(new Date).toISOString(),e.userData.dimensionForElement=this.selectedElement?.mesh?.uuid,this.sketchManager.currentPlane.add(e);const t={type:"dimension",mesh:e,color:3447003,userData:e.userData};this.sketchManager.elementManager.elements.push(t),this.sketchManager.editor.showStatus("Размеры сохранены как элемент","success"),this.clearTempDimensions(),this.selectedElement=null}deleteSelectedDimensions(){const e=this.sketchManager.elementManager.elements.filter(e=>"dimension"===e.type||e.mesh&&"dimension"===e.mesh.userData.elementType);0!==e.length?confirm(`Удалить все сохраненные размеры (${e.length} элементов)?`)&&(e.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()}));const t=this.sketchManager.elementManager.elements.indexOf(e);t>-1&&this.sketchManager.elementManager.elements.splice(t,1)}),this.sketchManager.editor.showStatus(`Удалено размеров: ${e.length}`,"success")):this.sketchManager.editor.showStatus("Нет сохраненных размеров","warning")}}