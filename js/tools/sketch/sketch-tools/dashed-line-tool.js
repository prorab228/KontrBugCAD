class DashedLineSketchTool extends SketchToolBase{constructor(e){super(e),this.name="dashed-line",this.icon="fa-grip-lines",this.dashSize=.5,this.gapSize=.5,this.dimensionFields=[{label:"Длина",type:"number",value:10,unit:"мм",min:1,step:1},{label:"Длина штриха",type:"number",value:this.dashSize,unit:"мм",min:.5,step:.5},{label:"Промежуток",type:"number",value:this.gapSize,unit:"мм",min:.5,step:.5}]}onMouseDown(e){if(this.sketchManager.isInputActive)return this.sketchManager.applyDimensionInput(),!0;const t=this.getPointOnPlane(e);return!!t&&(this.isDrawing=!0,this.tempElement={type:"dashed-line",start:t.clone(),end:t.clone(),length:0,dashSize:this.dashSize,gapSize:this.gapSize,points:[t.clone(),t.clone()],color:this.sketchManager.sketchColor},this.createTempGeometry(),!0)}onMouseMove(e){if(!this.isDrawing||!this.tempElement)return;const t=this.getPointOnPlane(e);t&&(this.tempElement.end=t.clone(),this.tempElement.points[1]=t.clone(),this.tempElement.length=this.tempElement.start.distanceTo(t),this.updateTempGeometry(),this.updateLineDimensions(this.tempElement.start,this.tempElement.end),this.sketchManager.isInputActive&&this.updateInputFields())}onMouseUp(e){if(!this.isDrawing)return;this.getPointOnPlane(e)&&this.tempElement&&this.finishDrawing(e),this.isDrawing=!1}updateLineDimensions(e,t){this.sketchManager.dimensionManager.clearDimensionObjects(),this.createLineDimension(e,t)}createLineDimension(e,t){new LineSketchTool(this.sketchManager).createLineDimension(e,t)}createGeometry(e){const t=[];e.points.forEach(e=>{const i=this.sketchManager.currentPlane.worldToLocal(e.clone());t.push(i.x,i.y,0)});const i=new THREE.BufferGeometry;i.setAttribute("position",new THREE.Float32BufferAttribute(t,3));const s=new THREE.LineDashedMaterial({color:e.color||this.sketchManager.sketchColor,linewidth:2,dashSize:e.dashSize||this.dashSize,gapSize:e.gapSize||this.gapSize,scale:1}),n=new THREE.Line(i,s);return n.computeLineDistances(),n}createTempGeometry(){if(this.clearTempGeometry(),!this.tempElement)return;const e={...this.tempElement};e.color=this.sketchManager.previewColor;const t=this.createGeometry(e);t&&(this.tempGeometry=t,this.sketchManager.currentPlane.add(this.tempGeometry))}updateTempGeometry(){if(!this.tempGeometry||!this.tempElement)return;const e=[];this.tempElement.points.forEach(t=>{const i=this.sketchManager.currentPlane.worldToLocal(t.clone());e.push(i.x,i.y,0)}),this.tempGeometry.geometry.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.tempGeometry.geometry.attributes.position.needsUpdate=!0,this.tempGeometry.material instanceof THREE.LineDashedMaterial&&(this.tempGeometry.material.dashSize=this.tempElement.dashSize||this.dashSize,this.tempGeometry.material.gapSize=this.tempElement.gapSize||this.gapSize,this.tempGeometry.material.needsUpdate=!0),this.tempGeometry.computeLineDistances()}updateGeometry(e,t){const i=[];t.points.forEach(e=>{const t=this.sketchManager.currentPlane.worldToLocal(e.clone());i.push(t.x,t.y,0)}),e.geometry.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),e.geometry.attributes.position.needsUpdate=!0,e.material instanceof THREE.LineDashedMaterial&&(e.material.dashSize=t.dashSize||this.dashSize,e.material.gapSize=t.gapSize||this.gapSize,e.material.needsUpdate=!0),e.computeLineDistances()}applyDimensions(e){this.tempElement&&(e.value1&&e.value1>0&&this.updateLineLength(e.value1),e.value2&&e.value2>0&&(this.tempElement.dashSize=e.value2,this.dashSize=e.value2),e.value3&&e.value3>0&&(this.tempElement.gapSize=e.value3,this.gapSize=e.value3),this.sketchManager.elementManager.addElement(this.tempElement),this.clearTempGeometry(),this.sketchManager.dimensionManager.clearDimensionObjects(),this.tempElement=null)}updateLineLength(e){if(!this.tempElement)return;this.tempElement.length=e;const t=(new THREE.Vector3).subVectors(this.tempElement.end,this.tempElement.start).normalize();0===t.length()&&t.set(1,0,0),this.tempElement.end=this.tempElement.start.clone().add(t.multiplyScalar(e)),this.tempElement.points[1]=this.tempElement.end.clone(),this.updateTempGeometry(),this.updateLineDimensions(this.tempElement.start,this.tempElement.end)}updateInputFields(){this.sketchManager.isInputActive&&this.tempElement&&(this.sketchManager.inputField1&&(this.sketchManager.inputField1.value=this.tempElement.length.toFixed(1)),this.sketchManager.inputField2&&(this.sketchManager.inputField2.value=(this.tempElement.dashSize||this.dashSize).toFixed(1)),this.sketchManager.inputField3&&(this.sketchManager.inputField3.value=(this.tempElement.gapSize||this.gapSize).toFixed(1)))}finishDrawing(e){if(!this.tempElement)return void this.onCancel();const t=this.getDimensionConfig();t.fields[0].value=this.tempElement.length.toFixed(1),t.fields[1].value=(this.tempElement.dashSize||this.dashSize).toFixed(1),t.fields[2].value=(this.tempElement.gapSize||this.gapSize).toFixed(1),this.sketchManager.dimensionManager.showDimensionInput(e,t)}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.sketchManager.dimensionManager.clearDimensionObjects()}}