import*as THREE from"three";import{SketchToolBase}from"./sketch-tool-base.js";export class TextSketchTool extends SketchToolBase{constructor(e){super(e,"text","fa-font"),this.fontSize=20,this.currentText="Текст",this.isWaitingForInput=!1,this.clickPosition=null,this.previewElement=null,this.dimensionFields=[{label:"Текст",type:"text",value:this.currentText,unit:"",placeholder:"Введите текст"},{label:"Размер",type:"number",value:this.fontSize,unit:"мм",min:5,max:100,step:1}]}onMouseDown(e){if(this.sketchManager.isInputActive)return!1;const t=this.getPointOnPlane(e);return t?(console.log("Текстовый инструмент: клик в позиции",t),this.clickPosition=t.clone(),this.isWaitingForInput=!0,this.createPositionMarker(t),setTimeout(()=>{const t=this.getDimensionConfig();console.log("Показываем поле ввода с конфигом:",t),this.sketchManager.dimensionManager.showDimensionInput(e,t)},10),!0):(console.warn("Не удалось определить позицию на плоскости"),!1)}applyDimensions(e){if(console.log("applyDimensions вызван с значениями:",e),!this.clickPosition)return console.error("Нет позиции для текста"),void this.onCancel();const t=e.value1||this.currentText,i=parseFloat(e.value2)||this.fontSize;if(!t.trim())return console.warn("Текст не может быть пустым"),void this.onCancel();const n={type:"text",position:this.clickPosition.clone(),content:t,fontSize:Math.max(5,Math.min(100,i)),color:this.sketchManager.sketchColor,contours:this.generateSimpleTextContours(t,this.clickPosition,i)};console.log("Создан текстовый элемент через applyDimensions:",n),this.sketchManager.elementManager.addElement(n),this.onCancel()}getDimensionConfig(){return{fields:this.dimensionFields,callback:e=>{console.log("Callback вызван с значениями:",e),this.applyDimensions(e)}}}createPositionMarker(e){this.clearTempGeometry();const t=new THREE.BufferGeometry,i=new Float32Array([e.x-5,e.y,.1,e.x+5,e.y,.1,e.x,e.y-5,.1,e.x,e.y+5,.1]);t.setAttribute("position",new THREE.BufferAttribute(i,3));const n=new THREE.LineBasicMaterial({color:16776960,linewidth:2}),o=new THREE.LineSegments(t,n),s=this.sketchManager.currentPlane.worldToLocal(e.clone());o.position.set(s.x,s.y,.1),this.tempGeometry=o,this.sketchManager.currentPlane.add(o),console.log("Маркер позиции создан в",e)}onMouseMove(e){if(this.isWaitingForInput&&!this.sketchManager.isInputActive&&this.clickPosition){const t=this.getPointOnPlane(e);t&&(this.clickPosition.copy(t),this.updatePositionMarker(t))}}updatePositionMarker(e){if(!this.tempGeometry)return;const t=new Float32Array([e.x-5,e.y,.1,e.x+5,e.y,.1,e.x,e.y-5,.1,e.x,e.y+5,.1]);this.tempGeometry.geometry.setAttribute("position",new THREE.BufferAttribute(t,3)),this.tempGeometry.geometry.attributes.position.needsUpdate=!0;const i=this.sketchManager.currentPlane.worldToLocal(e.clone());this.tempGeometry.position.set(i.x,i.y,.1)}onKeyDown(e){return"Escape"===e.key&&(this.onCancel(),!0)}applyDimensionInput(){if(console.log("Применение ввода текста"),!this.clickPosition)return console.error("Нет позиции для текста"),void this.onCancel();const e=this.sketchManager.inputField1?.value||this.currentText,t=parseFloat(this.sketchManager.inputField2?.value)||this.fontSize;if(!e.trim())return console.warn("Текст не может быть пустым"),void this.onCancel();const i={type:"text",position:this.clickPosition.clone(),content:e,fontSize:Math.max(5,Math.min(100,t)),color:this.sketchManager.sketchColor,contours:this.generateSimpleTextContours(e,this.clickPosition,t)};console.log("Создан текстовый элемент:",i),this.sketchManager.elementManager.addElement(i),this.onCancel()}generateSimpleTextContours(e,t,i){if(!e||!this.sketchManager.currentPlane)return console.warn("Невозможно сгенерировать контуры: нет текста или плоскости"),[];const n=[],o=.6*i,s=i,r=.1*i;for(let i=0;i<e.length;i++){e[i];const a=t.x+i*(o+r),l=t.y,c=[new THREE.Vector3(a,l,0),new THREE.Vector3(a+o,l,0),new THREE.Vector3(a+o,l+s,0),new THREE.Vector3(a,l+s,0),new THREE.Vector3(a,l,0)].map(e=>this.sketchManager.currentPlane.localToWorld(e));n.push(c)}return console.log(`Сгенерировано ${n.length} контуров для текста "${e}"`),n}handleInputChange(e,t){if(console.log(`Изменение поля ${e}:`,t),this.clickPosition)if(1===e)this.currentText=t||"",this.updatePreview();else if(2===e){const e=parseFloat(t)||this.fontSize;this.fontSize=Math.max(5,Math.min(100,e)),this.updatePreview()}}updatePreview(){if(this.previewElement&&this.previewElement.parent&&(this.previewElement.parent.remove(this.previewElement),this.previewElement.geometry&&this.previewElement.geometry.dispose(),this.previewElement.material&&this.previewElement.material.dispose()),this.currentText&&this.clickPosition){const e=this.generateSimpleTextContours(this.currentText,this.clickPosition,this.fontSize),t=new THREE.Group;e.forEach((e,i)=>{if(e.length<3)return;const n=[];e.forEach(e=>{const t=this.sketchManager.currentPlane.worldToLocal(e.clone());n.push(t.x,t.y,.1)});const o=new THREE.BufferGeometry;o.setAttribute("position",new THREE.Float32BufferAttribute(n,3));const s=new THREE.LineBasicMaterial({color:16776960,linewidth:2,transparent:!0,opacity:.7}),r=new THREE.LineLoop(o,s);t.add(r)}),this.previewElement=t,this.sketchManager.currentPlane.add(t)}}onCancel(){console.log("Отмена создания текста"),this.clearTempGeometry(),this.previewElement&&this.previewElement.parent&&(this.previewElement.parent.remove(this.previewElement),this.previewElement.geometry&&this.previewElement.geometry.dispose(),this.previewElement.material&&this.previewElement.material.dispose(),this.previewElement=null),this.clickPosition=null,this.isWaitingForInput=!1,this.sketchManager.dimensionManager.hideDimensionInput()}onDeactivate(){this.onCancel()}}