class PolylineSketchTool extends SketchToolBase{constructor(t){super(t,"polyline","fa-draw-polygon"),this.polylinePoints=[]}onMouseDown(t){const e=this.getPointOnPlane(t);return!!e&&(this.isDrawing=!0,this.tempElement&&"polyline"===this.tempElement.type?(this.tempElement.points.push(e.clone()),this.polylinePoints.push(e.clone()),this.updateTempGeometry(),this.sketchManager.editor.showStatus(`Точка ${this.tempElement.points.length} добавлена`,"info")):(this.polylinePoints=[e.clone()],this.tempElement={type:"polyline",points:[e.clone()],color:this.sketchManager.sketchColor,isComplete:!1},this.createTempGeometry()),!0)}onMouseMove(t){if(!this.isDrawing||!this.tempElement)return;const e=this.getPointOnPlane(t);e&&(1===this.tempElement.points.length?this.tempElement.points=[this.tempElement.points[0],e.clone()]:this.tempElement.points.length>1&&(this.tempElement.points[this.tempElement.points.length-1]=e.clone()),this.updateTempGeometry())}onMouseUp(t){}onKeyDown(t){return"Escape"===t.key&&this.isDrawing?(this.onCancel(),!0):"Enter"===t.key&&this.isDrawing?(this.completePolyline(),!0):!("Backspace"!==t.key||!this.isDrawing||!this.tempElement)&&(this.removeLastPoint(),!0)}onCancel(){this.isDrawing=!1,this.clearTempGeometry(),this.tempElement=null,this.polylinePoints=[],this.sketchManager.editor.showStatus("Создание полилинии отменено","info")}completePolyline(){if(!this.tempElement||this.tempElement.points.length<2)return this.onCancel(),void this.sketchManager.editor.showStatus("Полилиния должна содержать минимум 2 точки","warning");const t=this.tempElement.points[this.tempElement.points.length-1],e=this.tempElement.points[this.tempElement.points.length-2];t.distanceTo(e)<.1&&this.tempElement.points.pop(),this.sketchManager.addElement(this.tempElement),this.clearTempGeometry(),this.tempElement=null,this.polylinePoints=[],this.isDrawing=!1,this.sketchManager.editor.showStatus("Полилиния создана","success")}removeLastPoint(){!this.tempElement||this.tempElement.points.length<=2?this.onCancel():(this.tempElement.points.pop(),this.polylinePoints.pop(),this.updateTempGeometry(),this.sketchManager.editor.showStatus("Последняя точка удалена","info"))}createGeometry(t){const e=[];t.points.forEach(t=>{const n=this.sketchManager.currentPlane.worldToLocal(t.clone());e.push(n.x,n.y,0)});const n=new THREE.BufferGeometry;return n.setAttribute("position",new THREE.Float32BufferAttribute(e,3)),new THREE.Line(n,new THREE.LineBasicMaterial({color:t.color,linewidth:2}))}updateGeometry(t,e){const n=[];e.points.forEach(t=>{const e=this.sketchManager.currentPlane.worldToLocal(t.clone());n.push(e.x,e.y,0)}),t.geometry.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),t.geometry.attributes.position.needsUpdate=!0}}