class ExportSketchTool extends SketchToolBase{constructor(e){super(e,"export","fa-download")}onMouseDown(e){return!0}onActivate(){this.showExportMenu()}showExportMenu(){const e=document.createElement("div");e.className="export-menu",e.style.cssText="\n            position: fixed;\n            background: #2d2d2d;\n            border: 1px solid #444;\n            border-radius: 4px;\n            padding: 8px 0;\n            min-width: 200px;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.5);\n            z-index: 10000;\n            font-family: 'Segoe UI', Arial, sans-serif;\n            font-size: 14px;\n            left: 60vw;\n            top: 10vw;\n        ",e.innerHTML='\n            <div class="export-menu-header" style="padding: 8px 12px; border-bottom: 1px solid #444; color: #aaa;">\n                Экспорт чертежа\n            </div>\n            <div class="export-option" data-format="svg" style="padding: 10px 12px; cursor: pointer; color: white; border-bottom: 1px solid #333;">\n                <i class="fa fa-file-image" style="margin-right: 8px;"></i> SVG (векторный)\n            </div>\n            <div class="export-option" data-format="dxf" style="padding: 10px 12px; cursor: pointer; color: white; border-bottom: 1px solid #333;">\n                <i class="fa fa-file-code" style="margin-right: 8px;"></i> DXF (AutoCAD)\n            </div>\n            <div class="export-option" data-format="json" style="padding: 10px 12px; cursor: pointer; color: white; border-bottom: 1px solid #333;">\n                <i class="fa fa-file-alt" style="margin-right: 8px;"></i> JSON (структура)\n            </div>\n            <div class="export-option" data-format="pdf" style="padding: 10px 12px; cursor: pointer; color: white;">\n                <i class="fa fa-file-pdf" style="margin-right: 8px;"></i> PDF (печать)\n            </div>\n        ',document.body.appendChild(e),e.querySelectorAll(".export-option").forEach(t=>{t.addEventListener("click",n=>{const s=t.dataset.format;this.exportSketch(s),document.body.removeChild(e),n.stopPropagation()}),t.addEventListener("mouseenter",()=>{t.style.background="#3a3a3a"}),t.addEventListener("mouseleave",()=>{t.style.background="transparent"})});const t=n=>{e.contains(n.target)||(document.body.removeChild(e),document.removeEventListener("click",t))};setTimeout(()=>{document.addEventListener("click",t)},0)}exportSketch(e){if(this.sketchManager.currentSketch&&0!==this.sketchManager.elementManager.elements.length)switch(e){case"svg":this.exportToSVG();break;case"dxf":this.exportToDXF();break;case"json":this.exportToJSON();break;case"pdf":this.exportToPDF();break;default:this.sketchManager.editor.showStatus(`Формат ${e} не поддерживается`,"error")}else this.sketchManager.editor.showStatus("Нет данных для экспорта","warning")}exportToSVG(){const e=this.calculateBoundingBox();if(!e)return void this.sketchManager.editor.showStatus("Не удалось вычислить границы чертежа","error");const t={x:e.minX-10,y:e.minY-10,width:e.width+20,height:e.height+20};let n=`<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n<svg width="${t.width}mm" height="${t.height}mm" viewBox="${t.x} ${t.y} ${t.width} ${t.height}"\n     xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">\n\n    <title>Чертеж ${this.sketchManager.currentSketch.name}</title>\n    <desc>Экспортировано из CAD Editor</desc>\n\n    \x3c!-- Стили --\x3e\n    <style type="text/css">\n        .sketch-element {\n            stroke: #000000;\n            stroke-width: 0.2;\n            fill: none;\n            stroke-linecap: round;\n            stroke-linejoin: round;\n        }\n        .sketch-text {\n            font-family: Arial, sans-serif;\n            font-size: 5mm;\n            fill: #000000;\n        }\n    </style>\n\n    \x3c!-- Сетка (если видима) --\x3e\n    ${this.generateSVGGrid(t)}\n\n    \x3c!-- Элементы чертежа --\x3e\n    ${this.generateSVGElements()}\n\n</svg>`;this.downloadFile(n,`${this.sketchManager.currentSketch.name}.svg`,"image/svg+xml"),this.sketchManager.editor.showStatus("Чертеж экспортирован в SVG","success")}exportToDXF(){let e="0\nSECTION\n2\nHEADER\n9\n$ACADVER\n1\nAC1018\n9\n$INSUNITS\n70\n4\n0\nENDSEC\n0\nSECTION\n2\nTABLES\n0\nENDSEC\n0\nSECTION\n2\nBLOCKS\n0\nENDSEC\n0\nSECTION\n2\nENTITIES\n";this.sketchManager.elementManager.elements.forEach((t,n)=>{e+=this.generateDXFElement(t,n)}),e+="0\nENDSEC\n0\nEOF",this.downloadFile(e,`${this.sketchManager.currentSketch.name}.dxf`,"application/dxf"),this.sketchManager.editor.showStatus("Чертеж экспортирован в DXF","success")}exportToJSON(){const e={name:this.sketchManager.currentSketch.name,created:this.sketchManager.currentSketch.created,planeId:this.sketchManager.currentSketch.planeId,elements:this.sketchManager.elementManager.elements.map(e=>({type:e.type,color:e.color?e.color.getHexString():"000000",points:e.points?e.points.map(e=>({x:e.x,y:e.y,z:e.z})):[],start:e.start?{x:e.start.x,y:e.start.y,z:e.start.z}:null,end:e.end?{x:e.end.x,y:e.end.y,z:e.end.z}:null,center:e.center?{x:e.center.x,y:e.center.y,z:e.center.z}:null,radius:e.radius,width:e.width,height:e.height,segments:e.segments,sides:e.sides,content:e.content,fontSize:e.fontSize,cornerRadius:e.cornerRadius})),metadata:{exportedAt:(new Date).toISOString(),exporter:"CAD Editor",version:"1.0"}},t=JSON.stringify(e,null,2);this.downloadFile(t,`${this.sketchManager.currentSketch.name}.json`,"application/json"),this.sketchManager.editor.showStatus("Чертеж экспортирован в JSON","success")}exportToPDF(){if(void 0===window.jspdf)return void this.sketchManager.editor.showStatus("Библиотека jsPDF не найдена","error");const e=this.calculateBoundingBox();if(!e)return;const{jsPDF:t}=window.jspdf,n=new t({orientation:e.width>e.height?"landscape":"portrait",unit:"mm",format:"a4"}),s=n.internal.pageSize.getWidth(),i=n.internal.pageSize.getHeight(),a=.8*Math.min(s/e.width,i/e.height),r=(s-e.width*a)/2,o=(i-e.height*a)/2;n.setFontSize(12),n.text(`Чертеж: ${this.sketchManager.currentSketch.name}`,10,10),n.text(`Дата экспорта: ${(new Date).toLocaleDateString()}`,10,16),n.setDrawColor(0),n.setLineWidth(.1),this.sketchManager.elementManager.elements.forEach(t=>{if("line"===t.type&&t.start&&t.end){const s=r+(t.start.x-e.minX)*a,i=o+(t.start.y-e.minY)*a,c=r+(t.end.x-e.minX)*a,d=o+(t.end.y-e.minY)*a;n.line(s,i,c,d)}}),n.save(`${this.sketchManager.currentSketch.name}.pdf`),this.sketchManager.editor.showStatus("Чертеж экспортирован в PDF","success")}calculateBoundingBox(){if(0===this.sketchManager.elementManager.elements.length)return null;let e=1/0,t=1/0,n=-1/0,s=-1/0;return this.sketchManager.elementManager.elements.forEach(i=>{i.points&&i.points.length>0&&i.points.forEach(i=>{e=Math.min(e,i.x),t=Math.min(t,i.y),n=Math.max(n,i.x),s=Math.max(s,i.y)}),i.start&&(e=Math.min(e,i.start.x),t=Math.min(t,i.start.y),n=Math.max(n,i.start.x),s=Math.max(s,i.start.y)),i.end&&(e=Math.min(e,i.end.x),t=Math.min(t,i.end.y),n=Math.max(n,i.end.x),s=Math.max(s,i.end.y)),i.center&&i.radius&&(e=Math.min(e,i.center.x-i.radius),t=Math.min(t,i.center.y-i.radius),n=Math.max(n,i.center.x+i.radius),s=Math.max(s,i.center.y+i.radius))}),{minX:e,minY:t,maxX:n,maxY:s,width:n-e,height:s-t,centerX:(e+n)/2,centerY:(t+s)/2}}generateSVGGrid(e){if(!this.sketchManager.gridVisible)return"";let t="\x3c!-- Сетка --\x3e\n";t+='<g stroke="#cccccc" stroke-width="0.05" stroke-opacity="0.3">\n';for(let n=-50;n<=50;n++){const s=1*n,i=-50,a=50;s>=e.y&&s<=e.y+e.height&&(t+=`    <line x1="${i}" y1="${s}" x2="${a}" y2="${s}" />\n`)}for(let n=-50;n<=50;n++){const s=1*n,i=-50,a=50;s>=e.x&&s<=e.x+e.width&&(t+=`    <line x1="${s}" y1="${i}" x2="${s}" y2="${a}" />\n`)}return t+="</g>\n",t+='<g stroke="#666666" stroke-width="0.1">\n',t+=`    <line x1="${e.x}" y1="0" x2="${e.x+e.width}" y2="0" />\n`,t+=`    <line x1="0" y1="${e.y}" x2="0" y2="${e.y+e.height}" />\n`,t+="</g>\n",t}generateSVGElements(){let e="";return this.sketchManager.elementManager.elements.forEach((t,n)=>{const s=`element-${n}`;switch(t.type){case"line":t.start&&t.end&&(e+=`    <line id="${s}" class="sketch-element" x1="${t.start.x}" y1="${t.start.y}" x2="${t.end.x}" y2="${t.end.y}" />\n`);break;case"rectangle":if(t.points&&t.points.length>=4){const n=t.points.map(e=>`${e.x},${e.y}`).join(" ");e+=`    <polygon id="${s}" class="sketch-element" points="${n}" />\n`}break;case"circle":t.center&&void 0!==t.radius&&(e+=`    <circle id="${s}" class="sketch-element" cx="${t.center.x}" cy="${t.center.y}" r="${t.radius}" />\n`);break;case"polygon":case"polyline":if(t.points&&t.points.length>0){const n=t.points.map(e=>`${e.x},${e.y}`).join(" "),i="polygon"===t.type?"polygon":"polyline";e+=`    <${i} id="${s}" class="sketch-element" points="${n}" />\n`}break;case"oval":t.center&&void 0!==t.radiusX&&void 0!==t.radiusY&&(e+=`    <ellipse id="${s}" class="sketch-element" cx="${t.center.x}" cy="${t.center.y}" rx="${t.radiusX}" ry="${t.radiusY}" />\n`);break;case"text":t.position&&t.content&&(e+=`    <text id="${s}" class="sketch-text" x="${t.position.x}" y="${t.position.y+(t.fontSize||5)}">${t.content}</text>\n`);break;case"arc":if(t.points&&t.points.length>0){const n=t.points.map(e=>`${e.x},${e.y}`).join(" ");e+=`    <polyline id="${s}" class="sketch-element" points="${n}" />\n`}break;case"curve":if(t.curvePoints&&t.curvePoints.length>0){const n=t.curvePoints.map(e=>`${e.x},${e.y}`).join(" ");e+=`    <polyline id="${s}" class="sketch-element" points="${n}" />\n`}}}),e}generateDXFElement(e,t){let n="";switch(e.type){case"line":e.start&&e.end&&(n=`0\nLINE\n8\n0\n10\n${e.start.x}\n20\n${e.start.y}\n30\n0\n11\n${e.end.x}\n21\n${e.end.y}\n31\n0\n`);break;case"circle":e.center&&void 0!==e.radius&&(n=`0\nCIRCLE\n8\n0\n10\n${e.center.x}\n20\n${e.center.y}\n30\n0\n40\n${e.radius}\n`)}return n}downloadFile(e,t,n){const s=new Blob([e],{type:n}),i=URL.createObjectURL(s),a=document.createElement("a");a.href=i,a.download=t,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(i)}onCancel(){}}