class EnhancedSketchManager extends SketchManager{constructor(e){super(e),this.contourManager=new OptimizedSketchContourManager(this),this.elementManager=new EnhancedSketchElementManager(this,this.snapHelper,this.contourManager),this.performanceStats={contourDetectionTime:0,lastDetectionCount:0,averageDetectionTime:0,detectionCount:0},this.enableContourCaching=!0,this.debugMode=!1}onUndoRedo(){console.log("EnhancedSketchManager: обработка undo/redo"),this.elementManager.updateElementsFromPlane(),this.contourManager&&this.contourManager.clearContours(),this.contourManager.autoDetectContours&&this.contourManager.forceUpdate(),this.snapHelper&&this.snapHelper.forceUpdate()}startSketchOnPlane(e){super.startSketchOnPlane(e),this.contourManager&&(this.contourManager.enableIncremental=!0,this.contourManager.autoDetectContours=!0)}editExistingSketch(e){if(e&&"sketch_plane"===e.userData.type){if(console.log("EnhancedSketchManager: редактирование существующего скетча",e.uuid),this.elementManager.collectSketchElements(e),this.currentPlane=e,this.currentSketch={id:e.userData.sketchId||"sketch_"+Date.now(),name:e.userData.name||"Чертеж",planeId:e.uuid,elements:this.elementManager.elements,created:e.userData.createdAt||(new Date).toISOString()},this.contourManager.autoDetectContours){const e=performance.now();this.contourManager.detectContours();const t=performance.now();this.performanceStats.contourDetectionTime=t-e,this.performanceStats.lastDetectionCount=this.elementManager.elements.length,this.updatePerformanceStats()}this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.toolManager.setCurrentTool("select"),this.viewManager.gridVisible&&this.viewManager.createSketchGrid(),this.snapHelper&&this.snapHelper.forceUpdate(),console.log("EnhancedSketchManager: режим редактирования активирован"),this.editor.showStatus("Режим редактирования скетча","success")}else this.editor.showStatus("Выберите плоскость скетча для редактирования","error")}onKeyDown(e){if(this.debugMode)switch(e.key){case"F5":return e.preventDefault(),this.forceContourDetection(),!0;case"F6":return e.preventDefault(),this.toggleContourVisualization(),!0;case"F7":return e.preventDefault(),this.printPerformanceStats(),!0}return super.onKeyDown(e)}forceContourDetection(){if(this.contourManager){const e=performance.now();this.contourManager.forceUpdate();const t=performance.now();console.log(`Принудительное обнаружение контуров выполнено за ${(t-e).toFixed(2)}ms`),this.editor.showStatus(`Контуры обновлены за ${(t-e).toFixed(2)}ms`,"info")}}toggleContourVisualization(){this.contourManager&&(this.contourManager.autoDetectContours=!this.contourManager.autoDetectContours,this.contourManager.autoDetectContours?(this.contourManager.detectContours(),this.editor.showStatus("Визуализация контуров включена","success")):(this.contourManager.removeContourVisualization(),this.editor.showStatus("Визуализация контуров отключена","info")))}updatePerformanceStats(){const e=this.performanceStats;e.detectionCount++;e.averageDetectionTime=.1*e.contourDetectionTime+.9*e.averageDetectionTime}printPerformanceStats(){const e=this.performanceStats,t=this.contourManager?this.contourManager.getStats():{};console.group("=== Производительность SketchManager ==="),console.log(`Последнее обнаружение: ${e.contourDetectionTime.toFixed(2)}ms`),console.log(`Среднее время: ${e.averageDetectionTime.toFixed(2)}ms`),console.log(`Количество элементов: ${e.lastDetectionCount}`),console.log(`Всего обнаружений: ${e.detectionCount}`),console.log("--- Кэш контуров ---"),console.log(`Размер кэша: ${t.cacheSize||0}`),console.log(`Кэшированные контуры: ${t.cachedContours||0}`),console.log(`Вершин в графе: ${t.detectorStats?.vertices||0}`),console.log(`Ребер в графе: ${t.detectorStats?.edges||0}`),console.log(`Граней в графе: ${t.detectorStats?.faces||0}`),console.groupEnd();let o=`Производительность: ${e.averageDetectionTime.toFixed(2)}ms среднее<br>`;o+=`Элементов: ${e.lastDetectionCount}, Контуров: ${t.cachedContours||0}<br>`,o+=`Кэш: ${t.cacheSize||0} плоскостей`,this.editor.showStatus(o,"info",5e3)}exitSketchMode(){console.log("EnhancedSketchManager: выход из режима скетча"),this.debugMode&&this.printPerformanceStats(),super.exitSketchMode()}clear(){super.clear(),this.performanceStats={contourDetectionTime:0,lastDetectionCount:0,averageDetectionTime:0,detectionCount:0}}}