class SketchManager{constructor(n){this.editor=n,this.snapHelper=new SnapHelper(this),this.toolManager=new SketchToolManager(this),this.elementManager=new SketchElementManager(this,this.snapHelper),this.viewManager=new SketchViewManager(this),this.dimensionManager=new SketchDimensionManager(this),this.gridStep=1,this.sketchColor=1118481,this.highlightColor=16776960,this.dimensionColor=51283,this.previewColor=7829503,this.previewLineWidth=2,this.previewOpacity=.9,this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panningEnabled=!0,this.panEdgeThreshold=70,this.panSpeed=5,this.panning={x:0,y:0},this.panAnimationId=null,this.isPanningActive=!1,this.debugPanZone=!1,this.panZoneVisual=null,this.panningStartTime=0,this.panningStopTime=0,this.panningFadeDuration=200,this.initialize()}initialize(){this.toolManager.initTools(),this.dimensionManager.createDimensionInput(),this.updateToolButtons(),this.gridStep=localStorage.getItem("cad-sketch-step")||1,this.loadPanningSettings(),console.log("sketch initialized")}loadPanningSettings(){const n=localStorage.getItem("cad-sketch-panning");if(n){const e=JSON.parse(n);this.panningEnabled=void 0===e.enabled||e.enabled,this.panSpeed=e.speed||5,this.panEdgeThreshold=e.threshold||50}}savePanningSettings(){const n={enabled:this.panningEnabled,speed:this.panSpeed,threshold:this.panEdgeThreshold};localStorage.setItem("cad-sketch-panning",JSON.stringify(n))}checkEdgePanning(n,e){const t=this.toolManager.currentTool,i=t&&t.isDrawing;if(!this.panningEnabled||!this.currentPlane||!i)return this.panning={x:0,y:0},void(this.isPanningActive=!1);const a=this.editor.renderer.domElement.getBoundingClientRect(),s=a.width,o=a.height;if(this.panning={x:0,y:0},this.isPanningActive=!1,n<0||n>s||e<0||e>o)return;const r=this.panEdgeThreshold;n<r?(this.panning.x=this.panSpeed*(1-n/r),this.isPanningActive=!0):n>s-r&&(this.panning.x=-this.panSpeed*(1-(s-n)/r),this.isPanningActive=!0),e<r?(this.panning.y=-this.panSpeed*(1-e/r),this.isPanningActive=!0):e>o-r&&(this.panning.y=this.panSpeed*(1-(o-e)/r),this.isPanningActive=!0);const h=this.panSpeed;this.panning.x=Math.max(-h,Math.min(h,this.panning.x)),this.panning.y=Math.max(-h,Math.min(h,this.panning.y)),this.isPanningActive&&0===this.panningStartTime?(this.panningStartTime=Date.now(),this.panningStopTime=0):!this.isPanningActive&&0===this.panningStopTime&&this.panningStartTime>0&&(this.panningStopTime=Date.now())}getPanningSmoothFactor(){if(this.isPanningActive&&this.panningStartTime>0){const n=Date.now()-this.panningStartTime;return Math.min(1,n/this.panningFadeDuration)}if(!this.isPanningActive&&this.panningStopTime>0){const n=Date.now()-this.panningStopTime,e=1-Math.min(1,n/this.panningFadeDuration);return e<=0&&(this.panningStartTime=0,this.panningStopTime=0),e}return 1}startPanningAnimation(){this.panAnimationId&&cancelAnimationFrame(this.panAnimationId);const n=()=>{this.panningEnabled&&this.currentPlane&&this.viewManager.orthoCamera&&this.updatePanning(),this.panAnimationId=requestAnimationFrame(n)};this.panAnimationId=requestAnimationFrame(n)}stopPanningAnimation(){this.panAnimationId&&(cancelAnimationFrame(this.panAnimationId),this.panAnimationId=null),this.panning={x:0,y:0},this.isPanningActive=!1,this.panningStartTime=0,this.panningStopTime=0}updatePanning(){const n=this.toolManager.currentTool,e=n&&n.isDrawing;if(!this.panningEnabled||!this.currentPlane||!this.viewManager.orthoCamera||!this.isPanningActive&&0===this.panningStopTime||!e)return;const t=this.getPanningSmoothFactor();if(t<=0)return void(this.panning={x:0,y:0});const i=this.editor,a=this.viewManager.orthoCamera,s=i.controls,o=a.right-a.left,r=a.top-a.bottom,h=this.panSpeed*(o/70),l=this.panning.x/i.renderer.domElement.width*o*h*.1*t,c=this.panning.y/i.renderer.domElement.height*r*h*.1*t;a.position.x-=l,a.position.y-=c,s.target.x-=l,s.target.y-=c,a.updateProjectionMatrix(),s.update()}onUndoRedo(){console.log("SketchManager: обработка undo/redo"),this.snapHelper&&this.snapHelper.forceUpdate()}startSketchOnPlane(n){n&&(console.log("SketchManager: начало скетча на плоскости",n.uuid),this.currentPlane=n,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:n.uuid,elements:[],created:(new Date).toISOString()},this.viewManager.createOrthographicCamera(),this.viewManager.orientCameraToPlane(n),this.editor.SetGridVisible(!1),this.viewManager.createSketchGrid(),this.viewManager.gridVisible=!0,this.startPanningAnimation(),console.log("SketchManager: скетч начат, сетка создана, ортографическая камера установлена"),this.snapHelper&&this.snapHelper.forceUpdate())}editExistingSketch(n){if(!n||"sketch_plane"!==n.userData.type)return void this.editor.showStatus("Выберите плоскость скетча для редактирования","error");console.log("SketchManager: редактирование существующего скетча",n.uuid);const e=this.elementManager.collectSketchElements(n);console.log("SketchManager: найдено элементов",e),this.currentPlane=n,this.currentSketch={id:n.userData.sketchId||"sketch_"+Date.now(),name:n.userData.name||"Чертеж",planeId:n.uuid,elements:this.elementManager.elements,created:n.userData.createdAt||(new Date).toISOString()},this.viewManager.createOrthographicCamera(),this.viewManager.orientCameraToPlane(n),this.editor.SetGridVisible(!1),this.toolManager.setCurrentTool("select"),this.viewManager.gridVisible&&this.viewManager.createSketchGrid(),this.startPanningAnimation(),this.snapHelper&&this.snapHelper.forceUpdate(),console.log("SketchManager: режим редактирования активирован"),this.editor.showStatus("Режим редактирования скетча","success")}onMouseDown(n){return console.log("SketchManager: onMouseDown",n.button),this.dimensionManager.isInputActive?(this.dimensionManager.applyDimensionInput(),!0):!!this.toolManager.currentTool&&this.toolManager.onMouseDown(n)}onMouseMove(n){this.updateCoordinates(n);const e=this.editor.renderer.domElement.getBoundingClientRect(),t=n.clientX-e.left,i=n.clientY-e.top;if(this.checkEdgePanning(t,i),this.snapHelper){const e=this.getPointOnPlane(n);e&&this.snapHelper.handleMouseMove(n,e)}this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseMove(n)}onMouseUp(n){console.log("SketchManager: onMouseUp",n.button),this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&(this.toolManager.onMouseUp(n),this.panning={x:0,y:0},this.isPanningActive=!1,this.panningStopTime=Date.now())}onKeyDown(n){switch(console.log("SketchManager: onKeyDown",n),n.key){case"Enter":if(this.dimensionManager.isInputActive)return this.dimensionManager.applyDimensionInput(),n.preventDefault(),!0;break;case"Escape":if(this.dimensionManager.isInputActive)return this.dimensionManager.hideDimensionInput(),n.preventDefault(),!0;if(this.toolManager.currentTool)return this.toolManager.currentTool.onCancel(),n.preventDefault(),!0;break;case"Delete":return this.elementManager.deleteSelectedElements(),this.snapHelper&&this.snapHelper.forceUpdate(),!0}return!(!this.toolManager.currentTool||!this.toolManager.currentTool.onKeyDown)&&this.toolManager.currentTool.onKeyDown(n)}onKeyUp(n){console.log("SketchManager: onKeyUp",n)}exitSketchMode(){console.log("SketchManager: выход из режима скетча"),this.stopPanningAnimation(),this.toolManager.deactivateCurrentTool(),this.viewManager.restoreOriginalCamera(),this.editor.SetGridVisible(this.editor.gridVisible),this.viewManager.removeSketchGrid(),this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.currentPlane=null,this.currentSketch=null,this.clear(),this.editor.controls.enableRotate=!0,this.editor.controls.enablePan=!0,this.editor.controls.enableZoom=!0,this.updateToolButtons(),this.editor.showStatus("Режим скетча завершен","info")}updateCoordinates(n){const e="object"==typeof n?this.getPointOnPlane(n):n;if(!e||!this.currentPlane)return;const t=this.currentPlane.worldToLocal(e.clone()),i=document.getElementById("coords");i&&(i.textContent=`X: ${t.x.toFixed(1)}, Y: ${t.y.toFixed(1)}, Z: ${t.z.toFixed(1)}`)}getPointOnPlane(n){if(!this.currentPlane)return null;const e=this.editor.renderer.domElement.getBoundingClientRect(),t=new THREE.Vector2((n.clientX-e.left)/e.width*2-1,-(n.clientY-e.top)/e.height*2+1);this.editor.raycaster.setFromCamera(t,this.editor.camera);const i=new THREE.Vector3(0,0,1);i.applyQuaternion(this.currentPlane.quaternion);const a=this.currentPlane.position,s=new THREE.Plane;s.setFromNormalAndCoplanarPoint(i,a);const o=new THREE.Vector3;if(this.editor.raycaster.ray.intersectPlane(s,o)){const n=this.currentPlane.worldToLocal(o.clone());return this.currentPlane.localToWorld(n)}return null}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(n=>{n.classList.remove("active"),n.dataset.sketchTool===this.toolManager.currentToolName&&n.classList.add("active")})}setCurrentTool(n){this.toolManager.setCurrentTool(n)}deleteSelected(){this.elementManager.deleteSelectedElements()}clearSketch(){this.elementManager.deleteAllElements()}togglePanning(n){return this.panningEnabled=void 0!==n?n:!this.panningEnabled,this.panningEnabled||(this.panning={x:0,y:0},this.isPanningActive=!1),this.savePanningSettings(),this.panningEnabled}setPanSpeed(n){return this.panSpeed=Math.max(1,Math.min(20,n)),this.savePanningSettings(),this.panSpeed}setPanThreshold(n){return this.panEdgeThreshold=Math.max(10,Math.min(200,n)),this.savePanningSettings(),this.panEdgeThreshold}isDrawingActive(){const n=this.toolManager.currentTool;return n&&n.isDrawing}clear(){this.elementManager.clear(),this.stopPanningAnimation(),this.snapHelper&&this.snapHelper.clear(),this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panning={x:0,y:0},this.isPanningActive=!1,this.panningStartTime=0,this.panningStopTime=0}}