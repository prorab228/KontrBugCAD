class SketchManager{constructor(e){this.editor=e,this.currentTool="select",this.isDrawing=!1,this.currentPlane=null,this.currentSketch=null,this.elements=[],this.selectedElements=[],this.tempElement=null,this.tempGeometry=null,this.dimensionObjects=[],this.polylinePoints=[],this.dimensionInput=null,this.inputField1=null,this.inputField2=null,this.inputField3=null,this.isInputActive=!1,this.snapEnabled=!0,this.snapGrid=1,this.sketchColor=1118481,this.highlightColor=16776960,this.dimensionColor=51283,this.previewColor=7829503,this.previewLineWidth=2,this.previewOpacity=.9,this.mouseDownHandler=null,this.mouseMoveHandler=null,this.mouseUpHandler=null,this.keyDownHandler=null,this.gridVisible=!0,this.grid=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.originalCameraUp=new THREE.Vector3(0,1,0),this.originalCameraPosition=new THREE.Vector3,this.originalCameraTarget=new THREE.Vector3,this.tools={},this.activeTool=null,this.contourDetector=new ContourDetector,this.autoDetectContours=!1,this.snapHelper=new SnapHelper(this),this.initialize()}initialize(){this.initTools(),this.createDimensionInput(),this.updateToolButtons(),this.snapHelper&&this.snapHelper.updateSnapPoints()}initTools(){this.registerTool("select",new SelectSketchTool(this)),this.registerTool("line",new LineSketchTool(this)),this.registerTool("rectangle",new RectangleSketchTool(this)),this.registerTool("circle",new CircleSketchTool(this)),this.registerTool("polyline",new PolylineSketchTool(this)),this.registerTool("polygon",new PolygonSketchTool(this)),this.registerTool("curve",new CurveSketchTool(this)),this.registerTool("text",new TextSketchTool(this)),this.registerTool("mirror",new MirrorSketchTool(this)),this.registerTool("oval",new OvalSketchTool(this)),this.registerTool("stadium",new StadiumSketchTool(this)),this.registerTool("arc",new ArcSketchTool(this)),this.registerTool("export",new ExportSketchTool(this)),this.registerTool("import",new ImportSketchTool(this)),this.setCurrentTool("line")}registerTool(e,t){this.tools[e]=t}setCurrentTool(e){this.activeTool&&this.activeTool.onCancel(),this.currentTool=e,this.activeTool=this.tools[e],this.cursorCrossVisible="select"!==e&&"ruler"!==e,!this.cursorCrossVisible&&this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.updateToolButtons()}startSketchOnPlane(e){e&&(this.currentPlane=e,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:e.uuid,elements:[],created:(new Date).toISOString()},this.elements=[],this.selectedElements=[],this.clearDimensionObjects(),this.contourDetector.clear(),this.snapHelper.clear(),this.setCurrentTool("select"),this.attachMouseHandlers(),this.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.createSketchGrid(),this.snapHelper&&this.snapHelper.updateSnapPoints())}editExistingSketch(e){if(e)if("sketch_plane"===e.userData.type){if(this.collectSketchElements(e),this.currentPlane=e,this.currentSketch={id:e.userData.sketchId||"sketch_"+Date.now(),name:e.userData.name||"Чертеж",planeId:e.uuid,elements:this.elements,created:e.userData.createdAt||(new Date).toISOString()},this.autoDetectContours){const e=this.elements.map(e=>e.mesh);this.contourDetector.updateElements(e),this.updateFigureManagerWithContours()}this.attachMouseHandlers(),this.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.setCurrentTool("select"),this.gridVisible&&this.createSketchGrid(),this.snapHelper&&this.snapHelper.updateSnapPoints(),this.editor.showStatus("Режим редактирования скетча","success")}else this.editor.showStatus("Выберите плоскость скетча для редактирования","error")}updateContoursFromElements(){if(!this.currentPlane||0===this.elements.length)return;console.log("=== Автоматическое определение контуров ===");const e=this.elements.map(e=>e.mesh);this.contourDetector.updateElements(e);const t=this.contourDetector.findClosedContours();console.log(`Найдено замкнутых контуров: ${t.length}`),this.updateFigureManagerWithContours(t)}updateFigureManagerWithContours(e=null,t=null){const i=this.editor.objectsManager.figureManager;if(!i)return void console.error("FigureManager не найден!");if(!e&&this.contourDetector&&(e=this.contourDetector.findClosedContours()),!e||0===e.length)return;let s=e;t&&(s=e.filter(e=>e.planeId===t||e.elements&&e.elements.some(e=>!(!e.parent||e.parent.uuid!==t)||!(!e.userData||e.userData.sketchPlaneId!==t)))),console.log(`Обновление контуров: ${s.length} контуров для плоскости ${t}`),i.updateWithAutoContours(s)}collectSketchElements(e){return this.elements=[],this.selectedElements=[],e.children.forEach(e=>{if(e.userData&&"sketch_element"===e.userData.type){const t={type:e.userData.elementType,mesh:e,originalColor:e.userData.originalColor||new THREE.Color(this.sketchColor),color:e.userData.originalColor||this.sketchColor,localPoints:e.userData.localPoints,localPosition:e.userData.localPosition,content:e.userData.content,fontSize:e.userData.fontSize||20,isClosed:e.userData.isClosed,sketchPlaneId:e.userData.sketchPlaneId,userData:e.userData};this.elements.push(t)}}),this.elements.length}exitSketchMode(){this.restoreCamera(),this.removeContourVisualization(),this.editor.SetGridVisible(this.editor.gridVisible),this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.currentPlane=null,this.currentSketch=null,this.elements=[],this.selectedElements=[],this.setCurrentTool("select"),this.tempElement=null,this.isDrawing=!1,this.clearDimensionObjects(),this.hideDimensionInput(),this.detachMouseHandlers(),this.contourDetector.clear(),this.snapHelper.clear(),this.removeSketchGrid(),this.editor.controls.enableRotate=!0,this.editor.controls.enablePan=!0,this.editor.controls.enableZoom=!0,this.updateToolButtons(),this.editor.showStatus("Режим скетча завершен","info")}onMouseDown(e){return this.isInputActive?(this.dimensionInput.contains(e.target)||this.applyDimensionInput(),!1):!!this.activeTool&&this.activeTool.onMouseDown(e)}onMouseMove(e){const t=this.getPointOnPlane(e);if(t){let i=t;this.snapHelper&&this.snapHelper.snapEnabled&&(i=this.snapHelper.getCursorPosition(t)),this.updateCursorCross(i),this.updateCoordinates(i),this.snapHelper&&this.snapHelper.handleMouseMove(e,t)}this.isInputActive||this.activeTool&&this.activeTool.onMouseMove(e)}onMouseUp(e){this.activeTool&&this.activeTool.onMouseUp(e)}onKeyDown(e){return!!this.activeTool&&this.activeTool.onKeyDown(e)}getPointOnPlane(e){if(!this.currentPlane)return null;const t=this.editor.renderer.domElement.getBoundingClientRect(),i=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1);this.editor.raycaster.setFromCamera(i,this.editor.camera);const s=new THREE.Vector3(0,0,1);s.applyQuaternion(this.currentPlane.quaternion);const n=this.currentPlane.position,o=new THREE.Plane;o.setFromNormalAndCoplanarPoint(s,n);const r=new THREE.Vector3;if(this.editor.raycaster.ray.intersectPlane(o,r)){const e=this.currentPlane.worldToLocal(r.clone());return e.z=0,this.snapEnabled&&(e.x=Math.round(e.x/this.snapGrid)*this.snapGrid,e.y=Math.round(e.y/this.snapGrid)*this.snapGrid),this.currentPlane.localToWorld(e)}return null}updateCoordinates(e){const t=this.getPointOnPlane(e);if(!t||!this.currentPlane)return;const i=this.currentPlane.worldToLocal(t.clone()),s=document.getElementById("coords");s&&(s.textContent=`X: ${i.x.toFixed(1)}, Y: ${i.y.toFixed(1)}, Z: ${i.z.toFixed(1)}`)}createSketchGrid(){if(this.removeSketchGrid(),!this.currentPlane||!this.gridVisible)return;const e=11184810,t=5592405;for(let i=-50;i<=50;i++){const s=1*i,n=-50,o=50,r=new THREE.Vector3(n,s,.05),l=new THREE.Vector3(o,s,.05),a=(new THREE.BufferGeometry).setFromPoints([r,l]),h=new THREE.LineBasicMaterial({color:0===i?t:e,linewidth:1,transparent:!0,opacity:.3}),c=new THREE.Line(a,h);c.userData.isGrid=!0,this.currentPlane.add(c),this.grid||(this.grid=[]),this.grid.push(c)}for(let i=-50;i<=50;i++){const s=1*i,n=-50,o=50,r=new THREE.Vector3(s,n,.05),l=new THREE.Vector3(s,o,.05),a=(new THREE.BufferGeometry).setFromPoints([r,l]),h=new THREE.LineBasicMaterial({color:0===i?t:e,linewidth:1,transparent:!0,opacity:.3}),c=new THREE.Line(a,h);c.userData.isGrid=!0,this.currentPlane.add(c),this.grid||(this.grid=[]),this.grid.push(c)}}removeSketchGrid(){this.grid&&(this.grid.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.grid=null)}toggleGrid(){this.gridVisible=!this.gridVisible,this.snapEnabled=!this.snapEnabled,this.gridVisible?this.createSketchGrid():this.removeSketchGrid()}orientCameraToPlane(e){this.originalCameraUp.copy(this.editor.camera.up),this.originalCameraPosition.copy(this.editor.camera.position),this.originalCameraTarget.copy(this.editor.controls.target);new THREE.Vector3(1,0,0).applyQuaternion(e.quaternion);const t=new THREE.Vector3(0,1,0).applyQuaternion(e.quaternion),i=new THREE.Vector3(0,0,1).applyQuaternion(e.quaternion),s=(new THREE.Box3).setFromObject(e),n=new THREE.Vector3;s.getSize(n);const o=Math.max(n.x,n.y,n.z),r=Math.max(o,100)/2,l=new THREE.Vector3;s.getCenter(l);const a=l.clone().add(i.clone().multiplyScalar(r));this.editor.camera.position.copy(a),this.editor.camera.lookAt(l),this.editor.camera.up.copy(t),this.editor.camera.up.normalize(),this.editor.controls.target.copy(l),this.editor.controls.update()}restoreCamera(){this.editor.camera.up.copy(this.originalCameraUp),this.editor.camera.up.normalize(),this.editor.camera.position.copy(this.originalCameraPosition),this.editor.controls.target.copy(this.originalCameraTarget),this.editor.camera.lookAt(this.editor.controls.target),this.editor.controls.update()}createDimensionInput(){const e=document.getElementById("sketchDimensionInput");e&&e.remove(),this.dimensionInput=document.createElement("div"),this.dimensionInput.id="sketchDimensionInput",this.dimensionInput.className="dimension-input-overlay",this.dimensionInput.style.cssText="\n            position: fixed;\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 8px 12px;\n            border-radius: 4px;\n            font-family: 'Segoe UI', Arial, sans-serif;\n            font-size: 12px;\n            z-index: 10000;\n            pointer-events: none;\n            opacity: 0;\n            transition: opacity 0.2s;\n            border: 1px solid #00c853;\n            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);\n        ",this.dimensionInput.innerHTML='\n            <div style="display: flex; flex-direction: column; gap: 6px; min-width: 150px;">\n                <div class="input-row" id="inputRow1" style="display: none; align-items: center; gap: 8px;">\n                    <label style="min-width: 40px; color: #aaa;">Длина:</label>\n                    <input type="number" id="dimensionInput1" style="width: 80px; padding: 4px 6px; background: #333; color: white; border: 1px solid #666; border-radius: 3px; outline: none;">\n                    <span style="color: #aaa;">мм</span>\n                </div>\n                <div class="input-row" id="inputRow2" style="display: none; align-items: center; gap: 8px;">\n                    <label style="min-width: 40px; color: #aaa;">Высота:</label>\n                    <input type="number" id="dimensionInput2" style="width: 80px; padding: 4px 6px; background: #333; color: white; border: 1px solid #666; border-radius: 3px; outline: none;">\n                    <span style="color: #aaa;">мм</span>\n                </div>\n                <div class="input-row" id="inputRow3" style="display: none; align-items: center; gap: 8px;">\n                    <label style="min-width: 40px; color: #aaa;">Стороны:</label>\n                    <input type="number" id="dimensionInput3" style="width: 80px; padding: 4px 6px; background: #333; color: white; border: 1px solid #666; border-radius: 3px; outline: none;">\n                    <span style="color: #aaa;">шт</span>\n                </div>\n                <div class="input-hint" style="font-size: 10px; color: #888; margin-top: 4px;">\n                    Enter - применить, Esc - отмена\n                </div>\n            </div>\n        ',document.body.appendChild(this.dimensionInput),this.inputField1=document.getElementById("dimensionInput1"),this.inputField2=document.getElementById("dimensionInput2"),this.inputField3=document.getElementById("dimensionInput3"),this.setupInputListeners()}setupInputListeners(){[this.inputField1,this.inputField2,this.inputField3].forEach((e,t)=>{e&&(e.addEventListener("keydown",e=>this.handleInputKeyDown(e,t+1)),e.addEventListener("input",e=>this.handleInputChange(e,t+1)))}),this.dimensionInput.addEventListener("click",e=>{e.stopPropagation(),this.inputField1&&this.inputField1.focus()}),document.addEventListener("mousedown",e=>{this.dimensionInput&&"1"===this.dimensionInput.style.opacity&&!this.dimensionInput.contains(e.target)&&this.applyDimensionInput()})}showDimensionInput(e,t){if(!this.dimensionInput||!t)return;this.editor.renderer.domElement.getBoundingClientRect();this.dimensionInput.style.left=`${e.clientX+15}px`,this.dimensionInput.style.top=e.clientY-10+"px",this.dimensionInput.style.opacity="1",this.dimensionInput.style.pointerEvents="auto";for(let e=1;e<=3;e++){const t=document.getElementById(`inputRow${e}`);t&&(t.style.display="none")}t.fields&&Array.isArray(t.fields)&&t.fields.forEach((e,t)=>{const i=document.getElementById(`inputRow${t+1}`);if(i){i.style.display="flex";const t=i.querySelector("label"),s=i.querySelector("input"),n=i.querySelector("span");t&&(t.textContent=e.label+":"),s&&(s.type=e.type||"number",s.value=e.value||"",s.min=e.min||"",s.max=e.max||"",s.step=e.step||"1",s.placeholder=e.placeholder||""),n&&(n.textContent=e.unit||"")}}),this.inputField1&&(this.inputField1.focus(),this.inputField1.select()),this.isInputActive=!0}applyDimensionInput(){if(!this.activeTool||!this.activeTool.tempElement)return void this.hideDimensionInput();const e=this.activeTool,t={};for(let e=1;e<=3;e++){const i=document.getElementById(`inputRow${e}`);if(i&&"none"!==i.style.display){const s=i.querySelector("input");if(s){const i=`value${e}`;"number"===s.type?t[i]=parseFloat(s.value)||0:t[i]=s.value.trim()}}}e.applyDimensions&&e.applyDimensions(t),this.hideDimensionInput(),e.clearTempGeometry&&e.clearTempGeometry(),e.tempElement=null}hideDimensionInput(){this.dimensionInput&&(this.dimensionInput.style.opacity="0",this.dimensionInput.style.pointerEvents="none",this.isInputActive=!1)}handleInputKeyDown(e,t=""){if(e.stopPropagation(),"Tab"===e.key)e.preventDefault(),this.focusNextInput(t);this.onKeyDown(e)}onKeyDown(e){switch(e.key){case"Enter":return this.applyDimensionInput(),e.preventDefault(),!0;case"Escape":return this.hideDimensionInput(),this.activeTool&&this.activeTool.onCancel(),e.preventDefault(),!0;case"Delete":return this.deleteSelectedElements(),!0;case"z":case"я":return(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.shiftKey?this.editor.redo():this.editor.undo()),!0;case"y":case"н":return(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.editor.redo()),!0}return!1}handleInputChange(e,t){if(!this.activeTool||!this.activeTool.tempElement)return;const i=parseFloat(e.target.value)||0;this.activeTool&&this.activeTool.handleInputChange&&this.activeTool.handleInputChange(t,i)}focusNextInput(e){const t=[this.inputField1,this.inputField2,this.inputField3],i=e%t.length;t[i]&&"none"!==t[i].style.display&&(t[i].focus(),t[i].select())}addElement(e){if(!e)return;const t=this.getCurrentSketchState();if("text"===e.type){const t=new THREE.Group;e.contours&&e.contours.length>0&&e.contours.forEach((i,s)=>{if(i.length<3)return;const n=[];i.forEach(e=>{const t=this.currentPlane.worldToLocal(e.clone());n.push(t.x,t.y,0)});const o=new THREE.BufferGeometry;o.setAttribute("position",new THREE.Float32BufferAttribute(n,3));const r=new THREE.LineLoop(o,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchColor),linewidth:2}));r.userData={type:"sketch_element",elementType:"text_contour",contourIndex:s,totalContours:e.contours.length,originalColor:new THREE.Color(e.color||this.sketchColor),isClosed:!0},t.add(r)}),t.userData={type:"sketch_element",elementType:"text",isClosed:!0,isText:!0,originalColor:new THREE.Color(e.color||this.sketchColor),sketchPlaneId:this.currentPlane.uuid,content:e.content,fontSize:e.fontSize,localPosition:this.currentPlane.worldToLocal(e.position.clone()),createdAt:(new Date).toISOString()},this.currentPlane.add(t),e.mesh=t,this.elements.push(e)}else{const t=["line","polyline","rectangle","circle","polygon","oval","stadium"].includes(e.type),i=e.points?e.points.map(e=>this.currentPlane.worldToLocal(e.clone())):[],s=new THREE.BufferGeometry,n=[];let o;i.forEach(e=>{n.push(e.x,e.y,.01)}),s.setAttribute("position",new THREE.Float32BufferAttribute(n,3)),o=t?new THREE.LineLoop(s,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchColor),linewidth:2})):new THREE.Line(s,new THREE.LineBasicMaterial({color:new THREE.Color(e.color||this.sketchColor),linewidth:2})),o.userData={type:"sketch_element",elementType:e.type,isClosed:t,originalColor:new THREE.Color(e.color||this.sketchColor),sketchPlaneId:this.currentPlane.uuid,localPoints:i,createdAt:(new Date).toISOString()},this.currentPlane.add(o),e.mesh=o,this.elements.push(e)}this.editor.history&&this.editor.history.addAction({type:"sketch_add",sketchPlaneId:this.currentPlane.uuid,previousSketchState:t,elements:[{uuid:e.mesh.uuid,data:this.serializeSketchElement(e.mesh)}]}),this.snapHelper&&this.snapHelper.updateSnapPoints();this.editor.showStatus(`Добавлен элемент: ${{line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polygon:"Многоугольник",polyline:"Полилиния",curve:"Кривая",text:"Текст",oval:"Овал",stadium:"Стадион",arc:"Дуга",mirror:"Симметрия"}[e.type]||e.type}`,"success"),this.autoDetectContours&&this.detectContours()}serializeSketchElement(e){return e?this.editor.projectManager?this.editor.projectManager.serializeObject(e):{uuid:e.uuid,type:e.type,userData:{...e.userData},geometry:e.geometry?{type:e.geometry.type,parameters:e.geometry.parameters||{},attributes:e.geometry.attributes?{position:Array.from(e.geometry.attributes.position.array)}:{}}:null,material:e.material?{type:e.material.type,color:e.material.color?e.material.color.getHex():0,linewidth:e.material.linewidth||2}:null}:null}getCurrentSketchState(){if(!this.currentPlane)return null;const e={planeId:this.currentPlane.uuid,elements:[]};return this.currentPlane.children.forEach(t=>{if(t.userData&&"sketch_element"===t.userData.type){const i=this.serializeSketchElement(t);i&&e.elements.push({uuid:t.uuid,data:i})}}),e}visualizeContours(e){this.removeContourVisualization(),this.contourVisualization=new THREE.Group,this.contourVisualization.name="contour_debug",e.forEach((e,t)=>{if(!e.points||e.points.length<3)return;const i=[];e.points.forEach(e=>{i.push(e.x,e.y,.1)});const s=e.points[0];i.push(s.x,s.y,.1);const n=new THREE.BufferGeometry;n.setAttribute("position",new THREE.Float32BufferAttribute(i,3));const o=137.5*t%360,r=(new THREE.Color).setHSL(o/360,.8,.6),l=new THREE.LineBasicMaterial({color:r,linewidth:3,transparent:!0,opacity:.7}),a=new THREE.Line(n,l);a.userData.isContourDebug=!0,a.userData.contourId=e.id,this.contourVisualization.add(a)}),this.currentPlane&&this.currentPlane.add(this.contourVisualization)}removeContourVisualization(){this.contourVisualization&&this.currentPlane&&(this.currentPlane.remove(this.contourVisualization),this.contourVisualization.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.contourVisualization=null)}detectContoursInSketch(e,t=null){if(e&&this.autoDetectContours){console.log("=== Детекция контуров для скетча на плоскости ===",e.uuid);try{const i=t||[];if(0===i.length&&e.traverse(e=>{e.userData&&"sketch_element"===e.userData.type&&i.push(e)}),console.log(`Найдено элементов на плоскости: ${i.length}`),0===i.length)return void console.log("На плоскости нет элементов для детекции контуров");this.contourDetector.updateElements(i);const s=this.contourDetector.findClosedContours();if(console.log(`Найдено контуров: ${s.length}`),s.length>0){const t=s.map((t,i)=>{if(!t.isValid||!t.points||t.points.length<3)return null;const s=Math.abs(this.calculatePolygonArea(t.points));if(s<.01)return null;const n=this.calculateContourCenter(t.points),o=this.calculateBoundingBox(t.points);return{elements:t.elements||[],points:t.points,area:s,center:n,boundingBox:o,type:"auto_detected",isClosed:!0,isClockwise:t.isClockwise||!1,source:"auto_detection",planeId:e.uuid}}).filter(e=>null!==e);console.log(`Валидных контуров: ${t.length}`),t.length>0&&(this.editor.objectsManager.figureManager||(console.log("Создаем новый FigureManager"),this.editor.objectsManager.figureManager=new FigureManager(this.editor)),this.updateFigureManagerWithContours(t,e.uuid),this.visualizeContours(t))}}catch(e){console.error("Ошибка детекции контуров:",e)}}}detectContours(){if(!this.currentPlane||!this.autoDetectContours)return;const e=[];this.currentPlane.traverse(t=>{t.userData&&"sketch_element"===t.userData.type&&(e.includes(t)||e.push(t))}),this.detectContoursInSketch(this.currentPlane,e)}calculatePolygonArea(e){let t=0;const i=e.length;for(let s=0;s<i;s++){const n=(s+1)%i;t+=e[s].x*e[n].y,t-=e[n].x*e[s].y}return t/2}calculateContourCenter(e){const t=new THREE.Vector2(0,0);return e.forEach(e=>{t.x+=e.x,t.y+=e.y}),e.length>0&&(t.x/=e.length,t.y/=e.length),t}calculateBoundingBox(e){const t=new THREE.Vector2(1/0,1/0),i=new THREE.Vector2(-1/0,-1/0);return e.forEach(e=>{t.x=Math.min(t.x,e.x),t.y=Math.min(t.y,e.y),i.x=Math.max(i.x,e.x),i.y=Math.max(i.y,e.y)}),{min:t,max:i}}getElementAtPoint(e){if(!this.currentPlane)return null;const t=this.currentPlane.worldToLocal(e.clone());for(let e=this.elements.length-1;e>=0;e--){const i=this.elements[e];if(i.mesh)if("text"===i.type){const e=i.mesh.position,s=i.mesh.scale,n=s.x/2,o=s.y/2;if(Math.abs(t.x-e.x)<=n&&Math.abs(t.y-e.y)<=o)return i}else{const e=i.mesh.userData?.localPoints||[];for(let s=0;s<e.length-1;s++){const n=e[s],o=e[s+1];if(this.pointToLineDistance(t,n,o)<=5)return i}}}return null}pointToLineDistance(e,t,i){const s=e.x-t.x,n=e.y-t.y,o=i.x-t.x,r=i.y-t.y,l=o*o+r*r;let a,h,c=-1;0!==l&&(c=(s*o+n*r)/l),c<0?(a=t.x,h=t.y):c>1?(a=i.x,h=i.y):(a=t.x+c*o,h=t.y+c*r);const u=e.x-a,d=e.y-h;return Math.sqrt(u*u+d*d)}selectElement(e){this.clearSelection(),this.selectedElements=[e],this.highlightElement(e),this.editor.showStatus(`Выбран элемент: ${this.getToolName(e.type)}`,"info")}toggleElementSelection(e){const t=this.selectedElements.indexOf(e);t>-1?(this.unhighlightElement(e),this.selectedElements.splice(t,1)):(this.selectedElements.push(e),this.highlightElement(e)),this.editor.showStatus(`Выбрано элементов: ${this.selectedElements.length}`,"info")}selectAllElements(){this.clearSelection(),this.selectedElements=[...this.elements],this.selectedElements.forEach(e=>this.highlightElement(e)),this.editor.showStatus(`Выбрано всех элементов: ${this.selectedElements.length}`,"info")}clearSelection(){this.selectedElements.forEach(e=>this.unhighlightElement(e)),this.selectedElements=[]}highlightElement(e){e.mesh&&e.mesh.material&&(e.originalColor||(e.mesh.material.color?e.originalColor=e.mesh.material.color.clone():e.originalColor=new THREE.Color(this.sketchColor)),e.mesh.material.color&&(e.mesh.material.color.set(this.highlightColor),e.mesh.material.needsUpdate=!0),void 0!==e.mesh.material.linewidth&&(e.mesh.material.linewidth=4,e.mesh.material.needsUpdate=!0),"text"===e.type&&e.mesh.scale&&(e.originalScale=e.mesh.scale.clone(),e.mesh.scale.multiplyScalar(1.2)))}unhighlightElement(e){e.mesh&&e.mesh.material&&e.originalColor&&(e.mesh.material.color.copy(e.originalColor),e.mesh.material.needsUpdate=!0,void 0!==e.mesh.material.linewidth&&(e.mesh.material.linewidth=2,e.mesh.material.needsUpdate=!0),"text"===e.type&&e.originalScale&&e.mesh.scale&&e.mesh.scale.copy(e.originalScale))}deleteSelectedElements(){if(0===this.selectedElements.length)return void this.editor.showStatus("Нет выделенных элементов для удаления","warning");if(!confirm(`Удалить ${this.selectedElements.length} элементов?`))return;const e=this.getCurrentSketchState(),t=[...this.selectedElements];this.editor.history&&this.editor.history.addAction({type:"sketch_delete",sketchPlaneId:this.currentPlane.uuid,previousSketchState:e,elements:t.map(e=>({uuid:e.mesh.uuid,data:this.serializeSketchElement(e.mesh)}))}),t.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose(),e.mesh.map&&e.mesh.map.dispose());const t=this.elements.indexOf(e);t>-1&&this.elements.splice(t,1)}),this.selectedElements=[],this.snapHelper&&this.snapHelper.updateSnapPoints(),this.autoDetectContours&&this.detectContours(),this.editor.showStatus(`Удалено элементов: ${t.length}`,"success")}deleteAllElements(){if(0===this.elements.length)return;if(!confirm("Очистить весь чертеж?"))return;const e=this.getCurrentSketchState();this.editor.history&&this.editor.history.addAction({type:"sketch_delete",sketchPlaneId:this.currentPlane.uuid,previousSketchState:e,elements:this.elements.map(e=>({uuid:e.mesh.uuid,data:this.serializeSketchElement(e.mesh)}))}),this.elements.forEach(e=>{e.mesh&&e.mesh.parent&&(e.mesh.parent.remove(e.mesh),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose(),e.mesh.map&&e.mesh.map.dispose())}),this.elements=[],this.selectedElements=[],this.contourDetector.clear(),this.editor.showStatus("Чертеж очищен","success")}cancelCurrentOperation(){this.isDrawing=!1,this.activeTool&&this.activeTool.onCancel(),this.editor.showStatus("Операция отменена","info")}attachMouseHandlers(){const e=this.editor.renderer.domElement;this.mouseDownHandler=e=>this.onMouseDown(e),this.mouseMoveHandler=e=>this.onMouseMove(e),this.mouseUpHandler=e=>this.onMouseUp(e),this.keyDownHandler=e=>this.onKeyDown(e),e.addEventListener("mousedown",this.mouseDownHandler),e.addEventListener("mousemove",this.mouseMoveHandler),e.addEventListener("mouseup",this.mouseUpHandler),document.addEventListener("keydown",this.keyDownHandler),this.initDoubleClickHandler()}detachMouseHandlers(){const e=this.editor.renderer.domElement;this.mouseDownHandler&&e.removeEventListener("mousedown",this.mouseDownHandler),this.mouseMoveHandler&&e.removeEventListener("mousemove",this.mouseMoveHandler),this.mouseUpHandler&&e.removeEventListener("mouseup",this.mouseUpHandler),this.keyDownHandler&&document.removeEventListener("keydown",this.keyDownHandler)}initDoubleClickHandler(){const e=this.editor.renderer.domElement;let t=0,i=null;e.addEventListener("click",e=>{0===e.button&&(t++,1===t?i=setTimeout(()=>{t=0},300):2===t&&(clearTimeout(i),t=0,"polyline"===this.currentTool&&this.activeTool&&this.activeTool.tempElement&&"polyline"===this.activeTool.tempElement.type&&this.activeTool.completePolyline()))})}getToolName(e){return{select:"Выделение",line:"Линия",rectangle:"Прямоугольник",circle:"Окружность",polyline:"Полилиния",polygon:"Многоугольник",curve:"Кривая",text:"Текст"}[e]||e}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.sketchTool===this.currentTool&&e.classList.add("active")})}updateCursorCross(e){if(!this.currentPlane||!this.cursorCrossVisible)return;if(!this.cursorCross){const e=1,t=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(-e,0,.2),new THREE.Vector3(e,0,.2)]),i=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3(0,-e,.2),new THREE.Vector3(0,e,.2)]),s=new THREE.LineBasicMaterial({color:2237183,linewidth:4,transparent:!0,opacity:.7}),n=new THREE.Line(t,s),o=new THREE.Line(i,s);this.cursorCross=new THREE.Group,this.cursorCross.add(n,o),this.cursorCross.userData.isCursorCross=!0,this.currentPlane.add(this.cursorCross)}const t=this.currentPlane.worldToLocal(e.clone());this.cursorCross.position.set(t.x,t.y,0)}setSketchTool(e){this.setCurrentTool(e)}deleteSelected(){this.deleteSelectedElements()}clearSketch(){this.deleteAllElements()}clearDimensionObjects(){this.dimensionObjects.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),e.map&&e.map.dispose()}),this.dimensionObjects=[]}}