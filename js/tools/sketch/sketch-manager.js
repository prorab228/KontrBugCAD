class SketchManager{constructor(e){this.editor=e,this.currentPlaneId=null,this.snapHelper=new SnapHelper(this),this.outlineManager=new SketchOutlineManager(this),this.toolManager=new SketchToolManager(this),this.elementManager=new SketchElementManager(this,this.snapHelper),this.viewManager=new SketchViewManager(this),this.dimensionManager=new SketchDimensionManager(this),this.importManager=new SketchImportManager(this),this.exportManager=new SketchExportManager(this),this.regionManager=null,this.gridStep=1,this.sketchColor=1118481,this.highlightColor=11184640,this.dimensionColor=51283,this.previewColor=7829503,this.previewLineWidth=2,this.previewOpacity=1,this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panningEnabled=!0,this.panEdgeThreshold=70,this.panSpeed=2,this.panning={x:0,y:0},this.panAnimationId=null,this.isPanningActive=!1,this.lastPanTime=0,this.initialize()}initialize(){this.toolManager.initTools(),this.dimensionManager.createDimensionInput(),this.updateToolButtons(),this.gridStep=localStorage.getItem("cad-sketch-step")||1,this.importManager.init(),this.loadPanningSettings(),this.editor.parametricModel.onModelRebuilt(()=>this.onModelRebuilt()),console.log("sketch initialized")}onModelRebuilt(){if(!this.currentPlaneId)return;const e=this.editor.parametricModel.objectMap.get(this.currentPlaneId);e?(this.currentPlane!==e&&(console.log("SketchManager: плоскость пересоздана, обновляем ссылки"),this.currentPlane=e,e.userData.regionManager||(e.userData.regionManager=new SketchRegionManager(this.editor,e)),this.regionManager=e.userData.regionManager,this.elementManager.collectSketchElements(e),this.snapHelper.forceUpdate(),this.viewManager.recreateGrid()),this.regionManager&&this.regionManager.updateRegions()):this.exitSketchMode()}loadPanningSettings(){const e=localStorage.getItem("cad-sketch-panning");if(e){const t=JSON.parse(e);this.panningEnabled=void 0===t.enabled||t.enabled,this.panSpeed=t.speed||5,this.panEdgeThreshold=t.threshold||50}}savePanningSettings(){const e={enabled:this.panningEnabled,speed:this.panSpeed,threshold:this.panEdgeThreshold};localStorage.setItem("cad-sketch-panning",JSON.stringify(e))}checkEdgePanning(e,t){if(!this.panningEnabled||!this.currentPlane||!this.isDrawingActive())return this.panning={x:0,y:0},void(this.isPanningActive=!1);const n=this.editor.renderer.domElement.getBoundingClientRect(),i=n.width,a=n.height;if(e<0||e>i||t<0||t>a)return;const s=this.panEdgeThreshold;this.panning={x:0,y:0},this.isPanningActive=!1,e<s?(this.panning.x=-this.panSpeed*(1-e/s),this.isPanningActive=!0):e>i-s&&(this.panning.x=this.panSpeed*(1-(i-e)/s),this.isPanningActive=!0),t<s?(this.panning.y=this.panSpeed*(1-t/s),this.isPanningActive=!0):t>a-s&&(this.panning.y=-this.panSpeed*(1-(a-t)/s),this.isPanningActive=!0),this.panning.x=Math.max(-this.panSpeed,Math.min(this.panSpeed,this.panning.x)),this.panning.y=Math.max(-this.panSpeed,Math.min(this.panSpeed,this.panning.y))}startPanningAnimation(){this.panAnimationId&&cancelAnimationFrame(this.panAnimationId),this.lastPanTime=performance.now();const e=()=>{const t=performance.now(),n=Math.min(100,t-this.lastPanTime)/1e3;this.lastPanTime=t,this.panningEnabled&&this.currentPlane&&this.editor.cameraManager.camera&&this.updatePanning(n),this.panAnimationId=requestAnimationFrame(e)};this.panAnimationId=requestAnimationFrame(e)}stopPanningAnimation(){this.panAnimationId&&(cancelAnimationFrame(this.panAnimationId),this.panAnimationId=null),this.panning={x:0,y:0},this.isPanningActive=!1}updatePanning(e){if(!this.panningEnabled||!this.currentPlane||!this.editor.cameraManager.camera||!this.isPanningActive&&0===this.panning.x&&0===this.panning.y||!this.isDrawingActive())return;const t=this.panSpeed*e*10,n=this.panning.x*t,i=this.panning.y*t;this.editor.cameraManager.pan(n,i)}onUndoRedo(){console.log("SketchManager: обработка undo/redo"),this.snapHelper.forceUpdate(),this.regionManager.updateRegions()}startSketchOnPlane(e){e&&(console.log("SketchManager: начало скетча на плоскости",e.uuid),this.currentPlane=e,this.currentPlaneId=e.uuid,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:e.uuid,elements:[],created:(new Date).toISOString()},this.editor.cameraManager.enterSketchMode(e),this.editor.SetGridVisible(!1),this.viewManager.recreateGrid(),this.viewManager.gridVisible=!0,setTimeout(()=>this.addFaceOutlineToSketch(),50),this.startPanningAnimation(),this.elementManager.collectSketchElements(e),this.snapHelper.forceUpdate(),e.userData.regionManager||(e.userData.regionManager=new SketchRegionManager(this.editor,e)),this.regionManager=e.userData.regionManager,this.regionManager.updateRegions())}editExistingSketch(e){this.startSketchOnPlane(e),this.toolManager.setCurrentTool("select"),this.editor.showStatus("Режим редактирования скетча","success")}exitSketchMode(){console.log("SketchManager: выход из режима скетча"),this.stopPanningAnimation(),this.toolManager.deactivateCurrentTool(),this.editor.cameraManager.exitSketchMode(),this.editor.SetGridVisible(this.editor.gridVisible),this.viewManager.removeSketchGrid(),this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.currentPlaneId=null,this.currentPlane=null,this.currentSketch=null,this.elementManager.clearAllElementsFromPlane(),this.regionManager=null,this.updateToolButtons(),this.editor.showStatus("Режим скетча завершен","info")}onMouseDown(e){return this.dimensionManager.isInputActive?(this.dimensionManager.applyDimensionInput(),!0):!!this.toolManager.currentTool&&this.toolManager.onMouseDown(e)}onMouseMove(e){this.updateCoordinates(e);const t=this.editor.renderer.domElement.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;if(this.checkEdgePanning(n,i),this.snapHelper){const t=this.getPointOnPlane(e);t&&this.snapHelper.handleMouseMove(e,t)}this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseMove(e)}onMouseUp(e){0===e.button&&(this.panning={x:0,y:0},this.isPanningActive=!1),this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseUp(e)}onKeyDown(e){switch(e.key){case"Enter":if(this.dimensionManager.isInputActive)return this.dimensionManager.applyDimensionInput(),e.preventDefault(),!0;break;case"Escape":if(this.dimensionManager.isInputActive)return this.dimensionManager.hideDimensionInput(),e.preventDefault(),!0;if(this.toolManager.currentTool)return this.toolManager.currentTool.onCancel(),e.preventDefault(),!0;break;case"Delete":return this.elementManager.deleteSelectedElements(),this.snapHelper.forceUpdate(),!0;case"a":case"ф":if(e.ctrlKey||e.metaKey)return e.preventDefault(),this.elementManager.selectAllElements(),!0;break;case"c":case"с":if(e.ctrlKey||e.metaKey)return e.preventDefault(),this.elementManager.copySelectedElements(),!0;break;case"x":case"ч":if(e.ctrlKey||e.metaKey)return e.preventDefault(),this.elementManager.cutSelectedElements(),!0;break;case"v":case"м":if(e.ctrlKey||e.metaKey)return e.preventDefault(),this.elementManager.pasteElements(),!0;break;case"w":case"ц":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.toolManager.setCurrentTool("move"),e.preventDefault(),!0;break;case"r":case"к":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.toolManager.setCurrentTool("rotate"),e.preventDefault(),!0;break;case"m":case"ь":if(e.ctrlKey||e.metaKey)return this.toolManager.setCurrentTool("ruler"),e.preventDefault(),!0;break;case"d":case"в":if(e.ctrlKey||e.metaKey)return this.toolManager.setCurrentTool("dimension"),e.preventDefault(),!0}return!(!this.toolManager.currentTool||!this.toolManager.currentTool.onKeyDown)&&this.toolManager.currentTool.onKeyDown(e)}onKeyUp(e){this.toolManager.currentTool&&this.toolManager.currentTool.onKeyUp&&this.toolManager.currentTool.onKeyUp(e)}onDoubleClick(e){return!(!this.toolManager.currentTool||!this.toolManager.currentTool.onDoubleClick)&&this.toolManager.currentTool.onDoubleClick(e)}updateCoordinates(e){const t="object"==typeof e?this.getPointOnPlane(e):e;if(!t||!this.currentPlane)return;const n=document.getElementById("coords");n&&(n.textContent=`X: ${t.x.toFixed(1)}, Y: ${t.y.toFixed(1)}`)}getPointOnPlane(e){if(!this.currentPlane)return null;const t=this.editor.renderer.domElement.getBoundingClientRect(),n=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),i=this.editor.cameraManager.camera;this.editor.raycaster.setFromCamera(n,i);const a=new THREE.Vector3(0,0,1);a.applyQuaternion(this.currentPlane.quaternion);const s=this.currentPlane.position,r=new THREE.Plane;r.setFromNormalAndCoplanarPoint(a,s);const o=new THREE.Vector3;return this.editor.raycaster.ray.intersectPlane(r,o)?this.currentPlane.worldToLocal(o):null}getSnappedPointOnPlane(e,t=!0){const n=this.getPointOnPlane(e);return n&&t&&this.snapHelper?this.snapHelper.getSnappedPoint(n):n}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.sketchTool===this.toolManager.currentToolName&&e.classList.add("active")})}setCurrentTool(e){this.toolManager.setCurrentTool(e)}deleteSelected(){this.elementManager.deleteSelectedElements()}clearSketch(){this.elementManager.deleteAllElements()}importSVG(){return this.importManager.openImportDialog()}exportSVG(){return this.exportManager.exportToSVG()}togglePanning(e){return this.panningEnabled=void 0!==e?e:!this.panningEnabled,this.panningEnabled||(this.panning={x:0,y:0},this.isPanningActive=!1),this.savePanningSettings(),this.panningEnabled}setPanSpeed(e){return this.panSpeed=Math.max(1,Math.min(20,e)),this.savePanningSettings(),this.panSpeed}setPanThreshold(e){return this.panEdgeThreshold=Math.max(10,Math.min(200,e)),this.savePanningSettings(),this.panEdgeThreshold}isDrawingActive(){const e=this.toolManager.currentTool;return e&&e.isDrawing}addFaceOutlineToSketch(){this.currentPlane&&this.outlineManager&&this.outlineManager.addFaceOutlineToSketch()}setOutlineEnabled(e){return!!this.outlineManager&&this.outlineManager.setOutlineEnabled(e)}getOutlineEnabled(){return!!this.outlineManager&&this.outlineManager.outlineEnabled}clear(){this.elementManager.clear(),this.outlineManager&&this.outlineManager.clear(),this.stopPanningAnimation(),this.snapHelper&&this.snapHelper.clear(),this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panning={x:0,y:0},this.isPanningActive=!1,this.lastPanTime=0}}