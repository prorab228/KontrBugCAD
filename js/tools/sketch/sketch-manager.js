class SketchManager{constructor(e){this.editor=e,this.snapHelper=new SnapHelper(this),this.outlineManager=new SketchOutlineManager(this),this.toolManager=new SketchToolManager(this),this.elementManager=new SketchElementManager(this,this.snapHelper),this.viewManager=new SketchViewManager(this),this.dimensionManager=new SketchDimensionManager(this),this.importManager=new SketchImportManager(this),this.exportManager=new SketchExportManager(this),this.gridStep=1,this.sketchColor=1118481,this.highlightColor=11184640,this.dimensionColor=51283,this.previewColor=7829503,this.previewLineWidth=2,this.previewOpacity=.9,this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panningEnabled=!0,this.panEdgeThreshold=70,this.panSpeed=2,this.panning={x:0,y:0},this.panAnimationId=null,this.isPanningActive=!1,this.lastPanTime=0,this.initialize()}initialize(){this.toolManager.initTools(),this.dimensionManager.createDimensionInput(),this.updateToolButtons(),this.gridStep=localStorage.getItem("cad-sketch-step")||1,this.importManager.init(),this.loadPanningSettings(),console.log("sketch initialized")}loadPanningSettings(){const e=localStorage.getItem("cad-sketch-panning");if(e){const t=JSON.parse(e);this.panningEnabled=void 0===t.enabled||t.enabled,this.panSpeed=t.speed||5,this.panEdgeThreshold=t.threshold||50}}savePanningSettings(){const e={enabled:this.panningEnabled,speed:this.panSpeed,threshold:this.panEdgeThreshold};localStorage.setItem("cad-sketch-panning",JSON.stringify(e))}checkEdgePanning(e,t){if(!this.panningEnabled||!this.currentPlane||!this.isDrawingActive())return this.panning={x:0,y:0},void(this.isPanningActive=!1);const n=this.editor.renderer.domElement.getBoundingClientRect(),i=n.width,a=n.height;if(this.panning={x:0,y:0},this.isPanningActive=!1,e<0||e>i||t<0||t>a)return;const s=this.panEdgeThreshold;e<s?(this.panning.x=-this.panSpeed*(1-e/s),this.isPanningActive=!0):e>i-s&&(this.panning.x=this.panSpeed*(1-(i-e)/s),this.isPanningActive=!0),t<s?(this.panning.y=this.panSpeed*(1-t/s),this.isPanningActive=!0):t>a-s&&(this.panning.y=-this.panSpeed*(1-(a-t)/s),this.isPanningActive=!0);const r=this.panSpeed;this.panning.x=Math.max(-r,Math.min(r,this.panning.x)),this.panning.y=Math.max(-r,Math.min(r,this.panning.y))}startPanningAnimation(){this.panAnimationId&&cancelAnimationFrame(this.panAnimationId),this.lastPanTime=performance.now();const e=()=>{const t=performance.now(),n=Math.min(100,t-this.lastPanTime)/1e3;this.lastPanTime=t,this.panningEnabled&&this.currentPlane&&this.viewManager.orthoCamera&&this.updatePanning(n),this.panAnimationId=requestAnimationFrame(e)};this.panAnimationId=requestAnimationFrame(e)}stopPanningAnimation(){this.panAnimationId&&(cancelAnimationFrame(this.panAnimationId),this.panAnimationId=null),this.panning={x:0,y:0},this.isPanningActive=!1}updatePanning(e){if(!this.panningEnabled||!this.currentPlane||!this.viewManager.orthoCamera||!this.isPanningActive&&0===this.panning.x&&0===this.panning.y||!this.isDrawingActive())return;const t=this.editor,n=this.viewManager.orthoCamera,i=t.controls,a=this.panSpeed*e*10,s=new THREE.Vector3(1,0,0).applyQuaternion(n.quaternion),r=new THREE.Vector3(0,1,0).applyQuaternion(n.quaternion),o=(new THREE.Vector3).addScaledVector(s,this.panning.x*a).addScaledVector(r,this.panning.y*a);n.position.add(o),i.target.add(o),n.updateProjectionMatrix(),i.update()}onUndoRedo(){console.log("SketchManager: обработка undo/redo"),this.snapHelper&&this.snapHelper.forceUpdate()}addFaceOutlineToSketch(){this.currentPlane&&this.outlineManager&&this.outlineManager.addFaceOutlineToSketch()}setOutlineEnabled(e){return!!this.outlineManager&&this.outlineManager.setOutlineEnabled(e)}getOutlineEnabled(){return!!this.outlineManager&&this.outlineManager.outlineEnabled}startSketchOnPlane(e){e&&(console.log("SketchManager: начало скетча на плоскости",e.uuid),this.currentPlane=e,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:e.uuid,elements:[],created:(new Date).toISOString()},this.viewManager.createOrthographicCamera(),this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.viewManager.createSketchGrid(),this.viewManager.gridVisible=!0,setTimeout(()=>{this.addFaceOutlineToSketch()},50),this.startPanningAnimation(),console.log("SketchManager: скетч начат"),this.snapHelper&&this.snapHelper.forceUpdate())}editExistingSketch(e){if(!e||"sketch_plane"!==e.userData.type)return void this.editor.showStatus("Выберите плоскость скетча для редактирования","error");console.log("SketchManager: редактирование существующего скетча",e.uuid);const t=this.elementManager.collectSketchElements(e);console.log("SketchManager: найдено элементов",t),this.currentPlane=e,this.currentSketch={id:e.userData.sketchId||"sketch_"+Date.now(),name:e.userData.name||"Чертеж",planeId:e.uuid,elements:this.elementManager.elements,created:e.userData.createdAt||(new Date).toISOString()},this.viewManager.createOrthographicCamera(),this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.toolManager.setCurrentTool("select"),this.viewManager.gridVisible&&this.viewManager.createSketchGrid(),this.startPanningAnimation(),this.snapHelper&&this.snapHelper.forceUpdate(),console.log("SketchManager: режим редактирования активирован"),this.editor.showStatus("Режим редактирования скетча","success")}onMouseDown(e){return this.dimensionManager.isInputActive?(this.dimensionManager.applyDimensionInput(),!0):!!this.toolManager.currentTool&&this.toolManager.onMouseDown(e)}onMouseMove(e){this.updateCoordinates(e);const t=this.editor.renderer.domElement.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;if(this.checkEdgePanning(n,i),this.snapHelper){const t=this.getPointOnPlane(e);t&&this.snapHelper.handleMouseMove(e,t)}this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseMove(e)}onMouseUp(e){0===e.button&&(this.panning={x:0,y:0},this.isPanningActive=!1),this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseUp(e)}onKeyDown(e){switch(e.key){case"Enter":if(this.dimensionManager.isInputActive)return this.dimensionManager.applyDimensionInput(),e.preventDefault(),!0;break;case"Escape":if(this.dimensionManager.isInputActive)return this.dimensionManager.hideDimensionInput(),e.preventDefault(),!0;if(this.toolManager.currentTool)return this.toolManager.currentTool.onCancel(),e.preventDefault(),!0;break;case"Delete":return this.elementManager.deleteSelectedElements(),this.snapHelper&&this.snapHelper.forceUpdate(),!0;case"a":case"ф":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.elementManager.selectAllElements();break;case"w":case"ц":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.toolManager.setCurrentTool("move"),e.preventDefault(),!0;break;case"r":case"к":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.toolManager.setCurrentTool("rotate"),e.preventDefault(),!0;break;case"m":case"ь":if(e.ctrlKey||e.metaKey)return this.setCurrentTool("ruler"),e.preventDefault(),!0;break;case"d":case"в":if(e.ctrlKey||e.metaKey)return this.setCurrentTool("dimension"),e.preventDefault(),!0}return!(!this.toolManager.currentTool||!this.toolManager.currentTool.onKeyDown)&&this.toolManager.currentTool.onKeyDown(e)}onKeyUp(e){}exitSketchMode(){console.log("SketchManager: выход из режима скетча"),this.stopPanningAnimation(),this.toolManager.deactivateCurrentTool(),this.viewManager.restoreOriginalCamera(),this.editor.SetGridVisible(this.editor.gridVisible),this.viewManager.removeSketchGrid(),this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.currentPlane=null,this.currentSketch=null,this.clear(),this.editor.controls.enableRotate=!0,this.editor.controls.enablePan=!0,this.editor.controls.enableZoom=!0,this.updateToolButtons(),this.editor.showStatus("Режим скетча завершен","info")}updateCoordinates(e){const t="object"==typeof e?this.getPointOnPlane(e):e;if(!t||!this.currentPlane)return;const n=document.getElementById("coords");n&&(n.textContent=`X: ${t.x.toFixed(1)}, Y: ${t.y.toFixed(1)}`)}getPointOnPlane(e){if(!this.currentPlane)return null;const t=this.editor.renderer.domElement.getBoundingClientRect(),n=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1),i=this.viewManager.orthoCamera||this.editor.camera;this.editor.raycaster.setFromCamera(n,i);const a=new THREE.Vector3(0,0,1);a.applyQuaternion(this.currentPlane.quaternion);const s=this.currentPlane.position,r=new THREE.Plane;r.setFromNormalAndCoplanarPoint(a,s);const o=new THREE.Vector3;return this.editor.raycaster.ray.intersectPlane(r,o)?this.currentPlane.worldToLocal(o):null}getSnappedPointOnPlane(e,t=!0){const n=this.getPointOnPlane(e);return n&&t&&this.snapHelper?this.snapHelper.getSnappedPoint(n):n}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.sketchTool===this.toolManager.currentToolName&&e.classList.add("active")})}setCurrentTool(e){this.toolManager.setCurrentTool(e)}deleteSelected(){this.elementManager.deleteSelectedElements()}clearSketch(){this.elementManager.deleteAllElements()}importSVG(){return this.importManager.openImportDialog()}exportSVG(){return this.exportManager.exportToSVG()}togglePanning(e){return this.panningEnabled=void 0!==e?e:!this.panningEnabled,this.panningEnabled||(this.panning={x:0,y:0},this.isPanningActive=!1),this.savePanningSettings(),this.panningEnabled}setPanSpeed(e){return this.panSpeed=Math.max(1,Math.min(20,e)),this.savePanningSettings(),this.panSpeed}setPanThreshold(e){return this.panEdgeThreshold=Math.max(10,Math.min(200,e)),this.savePanningSettings(),this.panEdgeThreshold}isDrawingActive(){const e=this.toolManager.currentTool;return e&&e.isDrawing}clear(){this.elementManager.clear(),this.outlineManager&&this.outlineManager.clear(),this.stopPanningAnimation(),this.snapHelper&&this.snapHelper.clear(),this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panning={x:0,y:0},this.isPanningActive=!1,this.lastPanTime=0}}