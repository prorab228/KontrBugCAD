class SketchManager{constructor(e){this.editor=e,this.snapHelper=new SnapHelper(this),this.outlineManager=new SketchOutlineManager(this),this.toolManager=new SketchToolManager(this),this.elementManager=new SketchElementManager(this,this.snapHelper),this.viewManager=new SketchViewManager(this),this.dimensionManager=new SketchDimensionManager(this),this.gridStep=1,this.sketchColor=1118481,this.highlightColor=16776960,this.dimensionColor=51283,this.previewColor=7829503,this.previewLineWidth=2,this.previewOpacity=.9,this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panningEnabled=!0,this.panEdgeThreshold=70,this.panSpeed=2,this.panning={x:0,y:0},this.panAnimationId=null,this.isPanningActive=!1,this.lastPanTime=0,this.initialize()}initialize(){this.toolManager.initTools(),this.dimensionManager.createDimensionInput(),this.updateToolButtons(),this.gridStep=localStorage.getItem("cad-sketch-step")||1,this.loadPanningSettings(),console.log("sketch initialized")}loadPanningSettings(){const e=localStorage.getItem("cad-sketch-panning");if(e){const n=JSON.parse(e);this.panningEnabled=void 0===n.enabled||n.enabled,this.panSpeed=n.speed||5,this.panEdgeThreshold=n.threshold||50}}savePanningSettings(){const e={enabled:this.panningEnabled,speed:this.panSpeed,threshold:this.panEdgeThreshold};localStorage.setItem("cad-sketch-panning",JSON.stringify(e))}checkEdgePanning(e,n){if(!this.panningEnabled||!this.currentPlane||!this.isDrawingActive())return this.panning={x:0,y:0},void(this.isPanningActive=!1);const t=this.editor.renderer.domElement.getBoundingClientRect(),i=t.width,a=t.height;if(this.panning={x:0,y:0},this.isPanningActive=!1,e<0||e>i||n<0||n>a)return;const s=this.panEdgeThreshold;e<s?(this.panning.x=-this.panSpeed*(1-e/s),this.isPanningActive=!0):e>i-s&&(this.panning.x=this.panSpeed*(1-(i-e)/s),this.isPanningActive=!0),n<s?(this.panning.y=this.panSpeed*(1-n/s),this.isPanningActive=!0):n>a-s&&(this.panning.y=-this.panSpeed*(1-(a-n)/s),this.isPanningActive=!0);const o=this.panSpeed;this.panning.x=Math.max(-o,Math.min(o,this.panning.x)),this.panning.y=Math.max(-o,Math.min(o,this.panning.y))}startPanningAnimation(){this.panAnimationId&&cancelAnimationFrame(this.panAnimationId),this.lastPanTime=performance.now();const e=()=>{const n=performance.now(),t=Math.min(100,n-this.lastPanTime)/1e3;this.lastPanTime=n,this.panningEnabled&&this.currentPlane&&this.viewManager.orthoCamera&&this.updatePanning(t),this.panAnimationId=requestAnimationFrame(e)};this.panAnimationId=requestAnimationFrame(e)}stopPanningAnimation(){this.panAnimationId&&(cancelAnimationFrame(this.panAnimationId),this.panAnimationId=null),this.panning={x:0,y:0},this.isPanningActive=!1}updatePanning(e){if(!this.panningEnabled||!this.currentPlane||!this.viewManager.orthoCamera||!this.isPanningActive&&0===this.panning.x&&0===this.panning.y||!this.isDrawingActive())return;const n=this.editor,t=this.viewManager.orthoCamera,i=n.controls,a=this.panSpeed*e*10,s=new THREE.Vector3(1,0,0).applyQuaternion(t.quaternion),o=new THREE.Vector3(0,1,0).applyQuaternion(t.quaternion),r=(new THREE.Vector3).addScaledVector(s,this.panning.x*a).addScaledVector(o,this.panning.y*a);t.position.add(r),i.target.add(r),t.updateProjectionMatrix(),i.update()}onUndoRedo(){console.log("SketchManager: обработка undo/redo"),this.snapHelper&&this.snapHelper.forceUpdate()}addFaceOutlineToSketch(){this.currentPlane&&this.outlineManager&&this.outlineManager.addFaceOutlineToSketch()}setOutlineEnabled(e){return!!this.outlineManager&&this.outlineManager.setOutlineEnabled(e)}getOutlineEnabled(){return!!this.outlineManager&&this.outlineManager.outlineEnabled}startSketchOnPlane(e){e&&(console.log("SketchManager: начало скетча на плоскости",e.uuid),this.currentPlane=e,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:e.uuid,elements:[],created:(new Date).toISOString()},this.viewManager.createOrthographicCamera(),this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.viewManager.createSketchGrid(),this.viewManager.gridVisible=!0,setTimeout(()=>{this.addFaceOutlineToSketch()},500),this.startPanningAnimation(),console.log("SketchManager: скетч начат, сетка создана, ортографическая камера установлена"),this.snapHelper&&this.snapHelper.forceUpdate())}editExistingSketch(e){if(!e||"sketch_plane"!==e.userData.type)return void this.editor.showStatus("Выберите плоскость скетча для редактирования","error");console.log("SketchManager: редактирование существующего скетча",e.uuid);const n=this.elementManager.collectSketchElements(e);console.log("SketchManager: найдено элементов",n),this.currentPlane=e,this.currentSketch={id:e.userData.sketchId||"sketch_"+Date.now(),name:e.userData.name||"Чертеж",planeId:e.uuid,elements:this.elementManager.elements,created:e.userData.createdAt||(new Date).toISOString()},this.viewManager.createOrthographicCamera(),this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.toolManager.setCurrentTool("select"),this.viewManager.gridVisible&&this.viewManager.createSketchGrid(),this.startPanningAnimation(),this.snapHelper&&this.snapHelper.forceUpdate(),console.log("SketchManager: режим редактирования активирован"),this.editor.showStatus("Режим редактирования скетча","success")}onMouseDown(e){return console.log("SketchManager: onMouseDown",e.button),this.dimensionManager.isInputActive?(this.dimensionManager.applyDimensionInput(),!0):!!this.toolManager.currentTool&&this.toolManager.onMouseDown(e)}onMouseMove(e){this.updateCoordinates(e);const n=this.editor.renderer.domElement.getBoundingClientRect(),t=e.clientX-n.left,i=e.clientY-n.top;if(this.checkEdgePanning(t,i),this.snapHelper){const n=this.getPointOnPlane(e);n&&this.snapHelper.handleMouseMove(e,n)}this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseMove(e)}onMouseUp(e){console.log("SketchManager: onMouseUp",e.button),0===e.button&&(this.panning={x:0,y:0},this.isPanningActive=!1),this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseUp(e)}onKeyDown(e){switch(console.log("SketchManager: onKeyDown",e),e.key){case"Enter":if(this.dimensionManager.isInputActive)return this.dimensionManager.applyDimensionInput(),e.preventDefault(),!0;break;case"Escape":if(this.dimensionManager.isInputActive)return this.dimensionManager.hideDimensionInput(),e.preventDefault(),!0;if(this.toolManager.currentTool)return this.toolManager.currentTool.onCancel(),e.preventDefault(),!0;break;case"Delete":return this.elementManager.deleteSelectedElements(),this.snapHelper&&this.snapHelper.forceUpdate(),!0}return!(!this.toolManager.currentTool||!this.toolManager.currentTool.onKeyDown)&&this.toolManager.currentTool.onKeyDown(e)}onKeyUp(e){console.log("SketchManager: onKeyUp",e)}exitSketchMode(){console.log("SketchManager: выход из режима скетча"),this.stopPanningAnimation(),this.toolManager.deactivateCurrentTool(),this.viewManager.restoreOriginalCamera(),this.editor.SetGridVisible(this.editor.gridVisible),this.viewManager.removeSketchGrid(),this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.currentPlane=null,this.currentSketch=null,this.clear(),this.editor.controls.enableRotate=!0,this.editor.controls.enablePan=!0,this.editor.controls.enableZoom=!0,this.updateToolButtons(),this.editor.showStatus("Режим скетча завершен","info")}updateCoordinates(e){const n="object"==typeof e?this.getPointOnPlane(e):e;if(!n||!this.currentPlane)return;const t=this.currentPlane.worldToLocal(n.clone()),i=document.getElementById("coords");i&&(i.textContent=`X: ${t.x.toFixed(1)}, Y: ${t.y.toFixed(1)}, Z: ${t.z.toFixed(1)}`)}getPointOnPlane(e){if(!this.currentPlane)return null;const n=this.editor.renderer.domElement.getBoundingClientRect(),t=new THREE.Vector2((e.clientX-n.left)/n.width*2-1,-(e.clientY-n.top)/n.height*2+1);this.editor.raycaster.setFromCamera(t,this.editor.camera);const i=new THREE.Vector3(0,0,1);i.applyQuaternion(this.currentPlane.quaternion);const a=this.currentPlane.position,s=new THREE.Plane;s.setFromNormalAndCoplanarPoint(i,a);const o=new THREE.Vector3;if(this.editor.raycaster.ray.intersectPlane(s,o)){const e=this.currentPlane.worldToLocal(o.clone());return this.currentPlane.localToWorld(e)}return null}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.sketchTool===this.toolManager.currentToolName&&e.classList.add("active")})}setCurrentTool(e){this.toolManager.setCurrentTool(e)}deleteSelected(){this.elementManager.deleteSelectedElements()}clearSketch(){this.elementManager.deleteAllElements()}togglePanning(e){return this.panningEnabled=void 0!==e?e:!this.panningEnabled,this.panningEnabled||(this.panning={x:0,y:0},this.isPanningActive=!1),this.savePanningSettings(),this.panningEnabled}setPanSpeed(e){return this.panSpeed=Math.max(1,Math.min(20,e)),this.savePanningSettings(),this.panSpeed}setPanThreshold(e){return this.panEdgeThreshold=Math.max(10,Math.min(200,e)),this.savePanningSettings(),this.panEdgeThreshold}isDrawingActive(){const e=this.toolManager.currentTool;return e&&e.isDrawing}clear(){this.elementManager.clear(),this.outlineManager&&this.outlineManager.clear(),this.stopPanningAnimation(),this.snapHelper&&this.snapHelper.clear(),this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.panning={x:0,y:0},this.isPanningActive=!1,this.lastPanTime=0}}