class SketchManager{constructor(e){this.editor=e,this.snapHelper=new SnapHelper(this),this.toolManager=new SketchToolManager(this),this.elementManager=new SketchElementManager(this,this.snapHelper),this.viewManager=new SketchViewManager(this),this.dimensionManager=new SketchDimensionManager(this),this.gridStep=1,this.sketchColor=1118481,this.highlightColor=16776960,this.dimensionColor=51283,this.previewColor=7829503,this.previewLineWidth=2,this.previewOpacity=.9,this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[],this.initialize()}initialize(){this.toolManager.initTools(),this.dimensionManager.createDimensionInput(),this.updateToolButtons(),this.gridStep=localStorage.getItem("cad-sketch-step")||1,console.log("sketch initialized")}onUndoRedo(){console.log("SketchManager: обработка undo/redo"),this.snapHelper&&this.snapHelper.forceUpdate()}startSketchOnPlane(e){e&&(console.log("SketchManager: начало скетча на плоскости",e.uuid),this.currentPlane=e,this.currentSketch={id:"sketch_"+Date.now(),name:"Чертеж",planeId:e.uuid,elements:[],created:(new Date).toISOString()},this.toolManager.setCurrentTool("select"),this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.viewManager.createSketchGrid(),this.viewManager.gridVisible=!0,console.log("SketchManager: скетч начат, сетка создана"),this.snapHelper&&this.snapHelper.forceUpdate())}editExistingSketch(e){if(!e||"sketch_plane"!==e.userData.type)return void this.editor.showStatus("Выберите плоскость скетча для редактирования","error");console.log("SketchManager: редактирование существующего скетча",e.uuid);const t=this.elementManager.collectSketchElements(e);console.log("SketchManager: найдено элементов",t),this.currentPlane=e,this.currentSketch={id:e.userData.sketchId||"sketch_"+Date.now(),name:e.userData.name||"Чертеж",planeId:e.uuid,elements:this.elementManager.elements,created:e.userData.createdAt||(new Date).toISOString()},this.viewManager.orientCameraToPlane(e),this.editor.SetGridVisible(!1),this.toolManager.setCurrentTool("select"),this.viewManager.gridVisible&&this.viewManager.createSketchGrid(),this.snapHelper&&this.snapHelper.forceUpdate(),console.log("SketchManager: режим редактирования активирован"),this.editor.showStatus("Режим редактирования скетча","success")}onMouseDown(e){return console.log("SketchManager: onMouseDown",e.button),this.dimensionManager.isInputActive?(this.dimensionManager.applyDimensionInput(),!0):(console.log("SketchManager: currentTool",this.toolManager.currentTool),!!this.toolManager.currentTool&&this.toolManager.onMouseDown(e))}onMouseMove(e){if(this.updateCoordinates(e),this.snapHelper){const t=this.getPointOnPlane(e);t&&this.snapHelper.handleMouseMove(e,t)}this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseMove(e)}onMouseUp(e){console.log("SketchManager: onMouseUp",e.button),this.toolManager.currentTool&&!this.dimensionManager.isInputActive&&this.toolManager.onMouseUp(e)}onKeyDown(e){switch(console.log("SketchManager: onKeyDown",e),e.key){case"Enter":if(this.dimensionManager.isInputActive)return this.dimensionManager.applyDimensionInput(),e.preventDefault(),!0;break;case"Escape":if(this.dimensionManager.isInputActive)return this.dimensionManager.hideDimensionInput(),e.preventDefault(),!0;if(this.toolManager.currentTool)return this.toolManager.currentTool.onCancel(),e.preventDefault(),!0;break;case"Delete":return this.elementManager.deleteSelectedElements(),this.snapHelper&&this.snapHelper.forceUpdate(),!0}return!(!this.toolManager.currentTool||!this.toolManager.currentTool.onKeyDown)&&this.toolManager.currentTool.onKeyDown(e)}onKeyUp(e){console.log("SketchManager: onKeyUp",e)}exitSketchMode(){console.log("SketchManager: выход из режима скетча"),this.toolManager.deactivateCurrentTool(),this.viewManager.restoreCamera(),this.editor.SetGridVisible(this.editor.gridVisible),this.viewManager.removeSketchGrid(),this.cursorCross&&(this.currentPlane.remove(this.cursorCross),this.cursorCross=null),this.currentPlane=null,this.currentSketch=null,this.clear(),this.editor.controls.enableRotate=!0,this.editor.controls.enablePan=!0,this.editor.controls.enableZoom=!0,this.updateToolButtons(),this.editor.showStatus("Режим скетча завершен","info")}updateCoordinates(e){const t="object"==typeof e?this.getPointOnPlane(e):e;if(!t||!this.currentPlane)return;const n=this.currentPlane.worldToLocal(t.clone()),o=document.getElementById("coords");o&&(o.textContent=`X: ${n.x.toFixed(1)}, Y: ${n.y.toFixed(1)}, Z: ${n.z.toFixed(1)}`)}getPointOnPlane(e){if(!this.currentPlane)return null;const t=this.editor.renderer.domElement.getBoundingClientRect(),n=new THREE.Vector2((e.clientX-t.left)/t.width*2-1,-(e.clientY-t.top)/t.height*2+1);this.editor.raycaster.setFromCamera(n,this.editor.camera);const o=new THREE.Vector3(0,0,1);o.applyQuaternion(this.currentPlane.quaternion);const r=this.currentPlane.position,i=new THREE.Plane;i.setFromNormalAndCoplanarPoint(o,r);const s=new THREE.Vector3;if(this.editor.raycaster.ray.intersectPlane(i,s)){const e=this.currentPlane.worldToLocal(s.clone());return this.currentPlane.localToWorld(e)}return null}updateToolButtons(){document.querySelectorAll("[data-sketch-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.sketchTool===this.toolManager.currentToolName&&e.classList.add("active")})}setCurrentTool(e){this.toolManager.setCurrentTool(e)}deleteSelected(){this.elementManager.deleteSelectedElements()}clearSketch(){this.elementManager.deleteAllElements()}clear(){this.elementManager.clear(),this.snapHelper&&this.snapHelper.clear(),this.currentPlane=null,this.currentSketch=null,this.cursorCross=null,this.cursorCrossVisible=!1,this.dimensionObjects=[]}}