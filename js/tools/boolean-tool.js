class BooleanTool extends Tool{constructor(e,t){super(`boolean-${t}`,BooleanTool.getIcon(t),e),this.operation=t,this.requiresSelection=!0,this.minObjects=2}static getIcon(e){return{union:"fa-plus-circle",subtract:"fa-minus-circle",intersect:"fa-times-circle"}[e]||"fa-object-group"}getOperationName(){return{union:"объединения",subtract:"вычитания",intersect:"пересечения"}[this.operation]||this.operation}onActivate(){if(this.canActivate()){if(this.editor.selectedObjects.length<this.minObjects)return this.editor.showStatus(`Для ${this.getOperationName()} необходимо выбрать минимум ${this.minObjects} объекта`,"error"),void this.editor.toolManager.restorePreviousTool();this.performBooleanOperation(),setTimeout(()=>{this.editor.toolManager.restorePreviousTool()},100)}else this.editor.toolManager.restorePreviousTool()}performUnion(){return this.editor.booleanOps?this.editor.booleanOps.unionMultiple(this.editor.selectedObjects):null}performSubtract(){return!this.editor.booleanOps||this.editor.selectedObjects.length<2?null:this.editor.booleanOps.subtract(this.editor.selectedObjects[0],this.editor.selectedObjects[1])}performIntersect(){return!this.editor.booleanOps||this.editor.selectedObjects.length<2?null:this.editor.booleanOps.intersect(this.editor.selectedObjects[0],this.editor.selectedObjects[1])}addBooleanResult(e,t){if(console.log("=== addBooleanResult ==="),console.log("Operation:",t),console.log("Selected objects:",this.editor.selectedObjects.length),!e||!e.geometry)return void this.editor.showStatus("Ошибка: недопустимый результат булевой операции","error");this.editor.objectsGroup.add(e),this.editor.objects.push(e);const o=this.editor.projectManager.serializeObjectForHistory(e);console.log("Result data:",o);const s={type:"boolean",operation:t,result:e.uuid,sourceObjects:this.editor.selectedObjects.map(e=>e.uuid),resultData:o};console.log("Adding to history:",s),this.editor.history.addAction(s);const i=[...this.editor.selectedObjects];for(let e of i){this.editor.objectsGroup.remove(e);const t=this.editor.objects.indexOf(e);if(t>-1&&this.editor.objects.splice(t,1),"sketch_plane"===e.userData?.type){const t=this.editor.sketchPlanes.indexOf(e);t>-1&&this.editor.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData?.type){const t=this.editor.workPlanes.indexOf(e);t>-1&&this.editor.workPlanes.splice(t,1)}}this.editor.selectedObjects=[],this.editor.objectsManager.updateSceneList(),this.editor.selectSingleObject(e),this.editor.objectsManager.updateSceneStats(),this.editor.showStatus(`Операция "${t}" завершена`,"success")}showLoadingIndicator(e){let t=document.getElementById("boolLoadingIndicator");if(t)t.querySelector(".message").textContent=e,t.style.display="flex";else if(t=document.createElement("div"),t.id="boolLoadingIndicator",t.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: rgba(0, 0, 0, 0.8);\n                color: white;\n                padding: 20px 30px;\n                border-radius: 8px;\n                z-index: 10001;\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                font-family: Arial, sans-serif;\n            ",t.innerHTML=`\n                <div class="spinner" style="\n                    width: 24px;\n                    height: 24px;\n                    border: 3px solid rgba(255, 255, 255, 0.3);\n                    border-radius: 50%;\n                    border-top-color: #fff;\n                    animation: spin 1s linear infinite;\n                "></div>\n                <div class="message">${e}</div>\n            `,document.body.appendChild(t),!document.querySelector("#boolLoadingStyles")){const e=document.createElement("style");e.id="boolLoadingStyles",e.textContent="@keyframes spin { to { transform: rotate(360deg); } }",document.head.appendChild(e)}}hideLoadingIndicator(){const e=document.getElementById("boolLoadingIndicator");e&&(e.style.display="none")}performBooleanOperation(){if(!this.editor.booleanOps)return void this.editor.showStatus("Булевы операции не инициализированы","error");const e=this.editor.booleanOps.canPerformOperation("subtract"===this.operation||"intersect"===this.operation?this.editor.selectedObjects.slice(0,2):this.editor.selectedObjects);e.can?e.warning&&!confirm(`${e.reason}\nПродолжить операцию?`)||(this.showLoadingIndicator(`Выполняется ${this.getOperationName()}...`),setTimeout(()=>{try{let e;switch(this.operation){case"union":e=this.performUnion();break;case"subtract":e=this.performSubtract();break;case"intersect":e=this.performIntersect()}this.hideLoadingIndicator(),e?this.addBooleanResult(e,this.operation):this.editor.showStatus("Операция не дала результата","error")}catch(e){this.hideLoadingIndicator(),console.error(`${this.operation} error:`,e),this.editor.showStatus(`Ошибка ${this.getOperationName()}: ${e.message}`,"error")}},50)):this.editor.showStatus(e.reason,"error")}}class BooleanUnionTool extends BooleanTool{constructor(e){super(e,"union")}}class BooleanSubtractTool extends BooleanTool{constructor(e){super(e,"subtract")}}class BooleanIntersectTool extends BooleanTool{constructor(e){super(e,"intersect")}}