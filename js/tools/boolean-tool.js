import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"./tool.js";export class BooleanTool extends Tool{constructor(t,e){super(`boolean-${e}`,BooleanTool.getIcon(e),t),this.operation=e,this.minObjects=2,this.previewResult=null,this.previewGroup=new THREE.Group,this.editor.scene.add(this.previewGroup),this.originalMaterials=new Map,this.propertiesElement=null,this.baseObjects=[],this.subtractObjects=[]}static getIcon(t){return{union:"fa-plus-circle",subtract:"fa-minus-circle",intersect:"fa-times-circle"}[t]||"fa-object-group"}getOperationName(){return{union:"объединения",subtract:"вычитания",intersect:"пересечения"}[this.operation]||this.operation}async onActivate(){this.canActivate()?(this.createPropertiesSection(),"subtract"===this.operation?this._initSubtractFromSelection():this.editor.selectedObjects.length>=this.minObjects?this._startPreview():this.editor.showStatus(`Выберите объекты для ${this.getOperationName()}. Enter – подтвердить, Esc – отмена.`,"info")):this.editor.toolManager.restorePreviousTool()}_initSubtractFromSelection(){const t=this.editor.selectedObjects;1===t.length?(this.baseObjects=[t[0]],this.subtractObjects=[],this._setObjectsDim(this.baseObjects,{color:65280,opacity:.5,emissive:8704}),this.editor.showStatus("Кликните на объекты, которые хотите вычесть (ЛКМ). ПКМ – добавить/убрать уменьшаемые.","info")):t.length>=2?(this.baseObjects=t,this._updateSelectionAndPreview()):(this.baseObjects=[],this.subtractObjects=[],this.editor.clearSelection(!1),this.editor.showStatus("Выберите уменьшаемые (ПКМ) и вычитаемые (ЛКМ)","info")),this._updatePropertiesPanel()}onDeactivate(){this._exit(),this.removePropertiesSection(),this.editor.clearSelection(!1)}_startPreview(){this._getOperands().length<this.minObjects||this._updatePreview()}_updatePreview(){this._clearPreview();const t=this._getOperands();if(t.length<this.minObjects)return void this._updatePropertiesPanel();if("subtract"===this.operation&&(0===this.baseObjects.length||0===this.subtractObjects.length))return void this._updatePropertiesPanel();const e=this.editor.booleanOps.canPerformOperation(t);if(!e.can)return this.editor.showStatus(e.reason,"error"),void this._updatePropertiesPanel();this._setObjectsDim(t,{color:8947848,opacity:.2,emissive:0});try{let e;const s=new THREE.MeshStandardMaterial({color:16755200,transparent:!0,opacity:.6,flatShading:!0});"union"===this.operation?e=this.editor.booleanOps.unionMultiple(t,s):"subtract"===this.operation?e=this.editor.booleanOps.subtractMultiple(this.baseObjects,this.subtractObjects,s):"intersect"===this.operation&&(e=this.editor.booleanOps.intersectMultiple(t,s)),e&&(e.renderOrder=10,this.previewGroup.add(e),this.previewResult=e)}catch(t){console.error("Preview error:",t),this.editor.showStatus(`Ошибка предпросмотра: ${t.message}`,"error")}this._updatePropertiesPanel()}_clearPreview(){this.previewResult&&(this.previewGroup.remove(this.previewResult),this.previewResult.geometry&&this.previewResult.geometry.dispose(),this.previewResult.material&&(Array.isArray(this.previewResult.material)?this.previewResult.material.forEach(t=>t.dispose()):this.previewResult.material.dispose()),this.previewResult=null),this.originalMaterials.forEach((t,e)=>{this._restoreObjectMaterial(e,t)}),this.originalMaterials.clear()}_setObjectsDim(t,e={color:8947848,opacity:.3,emissive:0}){t.forEach(t=>{if(t&&t.material){if(!this.originalMaterials.has(t)){const e=Array.isArray(t.material)?t.material.map(t=>t.clone()):t.userData.originalMaterial?t.userData.originalMaterial.clone():t.material.clone();this.originalMaterials.set(t,e)}Array.isArray(t.material)?t.material.forEach(t=>{t.color.setHex(e.color),t.emissive&&t.emissive.setHex(e.emissive),t.opacity=e.opacity,t.transparent=!0,t.depthWrite=!1,t.needsUpdate=!0}):(t.material.color.setHex(e.color),t.material.emissive&&t.material.emissive.setHex(e.emissive),t.material.opacity=e.opacity,t.material.transparent=!0,t.material.depthWrite=!1,t.material.needsUpdate=!0)}})}_restoreObjectMaterial(t,e){t.material&&(Array.isArray(t.material)&&Array.isArray(e)?t.material.forEach((t,s)=>t.copy(e[s])):Array.isArray(t.material)||Array.isArray(e)||t.material.copy(e),t.material.needsUpdate=!0)}_getOperands(){return"subtract"===this.operation?[...this.baseObjects,...this.subtractObjects]:this.editor.selectedObjects}async _confirmOperation(){this._getOperands().length<this.minObjects?this.editor.showStatus(`Недостаточно объектов для ${this.getOperationName()}`,"error"):"subtract"!==this.operation||0!==this.baseObjects.length&&0!==this.subtractObjects.length?(this._clearPreview(),await this._performBooleanOperation(),this._exit(),this.editor.toolManager.restorePreviousTool()):this.editor.showStatus("Для вычитания нужны и уменьшаемые, и вычитаемые","error")}_exit(){this._clearPreview(),"subtract"===this.operation&&(this.baseObjects=[],this.subtractObjects=[])}_getRootObjectAtMouse(){const t=[];this.editor.scene.traverse(e=>{e.isMesh&&t.push(e)});const e=this.editor.raycaster.intersectObjects(t,!1);if(0===e.length)return null;for(const t of e){let e=t.object;for(;e;){if(this.editor.parametricModel.objectMap.has(e.uuid)){const t=e.userData?.type;if(!(e.userData?.isHelper||["grid","axis","grid_helper","axes_helper","base_plane"].includes(t))&&e.visible)return e}e=e.parent}}return null}onMouseDown(t){if(0!==t.button&&2!==t.button)return!1;this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this._getRootObjectAtMouse();return!!e&&("subtract"===this.operation?this._handleSubtractClick(e,t.button):0===t.button&&this._handleGenericClick(e,t.ctrlKey))}_handleGenericClick(t,e){return!!this.isActive&&(this.editor.toggleObjectSelection(t),this.editor.selectedObjects.length>=this.minObjects?this._startPreview():this._clearPreview(),this._updatePropertiesPanel(),!0)}_handleSubtractClick(t,e){if(!this.isActive)return!1;if(0===e){const e=this.baseObjects.indexOf(t),s=this.subtractObjects.indexOf(t);return-1!==e?this.baseObjects.splice(e,1):(-1!==s&&this.subtractObjects.splice(s,1),this.baseObjects.push(t)),this._updateSelectionAndPreview(),!0}if(2===e){const e=this.subtractObjects.indexOf(t),s=this.baseObjects.indexOf(t);return-1!==e?this.subtractObjects.splice(e,1):(-1!==s&&this.baseObjects.splice(s,1),this.subtractObjects.push(t)),this._updateSelectionAndPreview(),!0}return!1}_updateSelectionAndPreview(){this._clearPreview();const t=[...this.baseObjects,...this.subtractObjects];this.editor.clearSelection(!1),t.forEach(t=>{this.editor.selectedObjects.includes(t)||(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.baseObjects.length>0&&this._setObjectsDim(this.baseObjects,{color:65280,opacity:.5,emissive:8704}),this.subtractObjects.length>0&&this._setObjectsDim(this.subtractObjects,{color:16711680,opacity:.5,emissive:2228224}),this.baseObjects.length>0&&this.subtractObjects.length>0&&this._startPreview(),this._updatePropertiesPanel(),this.editor.objectsManager.updateSceneList(),this.editor.updateStatus()}onKeyDown(t){return"Escape"===t.key?(this._exit(),this.editor.toolManager.restorePreviousTool(),!0):"Enter"===t.key&&(this._confirmOperation(),!0)}async _performBooleanOperation(){if(!this.editor.booleanOps)return void this.editor.showStatus("Булевы операции не инициализированы","error");const t=this._getOperands(),e=this.editor.booleanOps.canPerformOperation(t);if(e.can){this.showLoadingIndicator(`Выполняется ${this.getOperationName()}...`);try{let e;if("subtract"===this.operation)e=new ParametricOperation("boolean_subtract",{baseUuids:this.baseObjects.map(t=>t.uuid),subtractUuids:this.subtractObjects.map(t=>t.uuid)},[]),e.inputs=[...this.baseObjects.map(t=>t.uuid),...this.subtractObjects.map(t=>t.uuid)];else{const s=`boolean_${this.operation}`,i=t.map(t=>t.uuid);e=new ParametricOperation(s,{},i)}this.editor.parametricModel.addOperation(e),this.hideLoadingIndicator(),this.editor.showStatus(`Операция "${this.getOperationName()}" завершена`,"success")}catch(t){this.hideLoadingIndicator(),console.error(`${this.operation} error:`,t),this.editor.showStatus(`Ошибка ${this.getOperationName()}: ${t.message}`,"error")}}else this.editor.showStatus(e.reason,"error")}createPropertiesSection(){const t=document.getElementById("propertiesContent");t&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","boolean-tool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),t.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const t=document.querySelector('.property-group[data-tool="boolean-tool"]');t&&t.remove(),this.propertiesElement=null}getPropertiesHTML(){const t=this.getOperationName();let e="",s="";if("subtract"===this.operation)e=0===this.baseObjects.length?"Выберите уменьшаемые (ПКМ)":0===this.subtractObjects.length?"Выберите вычитаемые (ЛКМ)":"Предпросмотр",s=`Уменьшаемых: ${this.baseObjects.length}, Вычитаемых: ${this.subtractObjects.length}`;else{e=`Выбрано объектов: ${this.editor.selectedObjects.length}`}return`\n            <div class="property-group" data-type="boolean-settings">\n                <h4>БУЛЕВА ОПЕРАЦИЯ: ${t.toUpperCase()}</h4>\n                <div class="property-row">\n                    <label>Статус:</label>\n                    <span id="booleanStage">${e}</span>\n                </div>\n                ${s?`<div class="property-row"><span id="booleanSelectedInfo">${s}</span></div>`:""}\n                <div class="property-buttons">\n                    <button id="booleanApplyBtn" class="btn-primary" ${this._getOperands().length<this.minObjects||"subtract"===this.operation&&(0===this.baseObjects.length||0===this.subtractObjects.length)?"disabled":""}>\n                        <i class="fas fa-check"></i> Применить\n                    </button>\n                    <button id="booleanCancelBtn" class="btn-secondary">\n                        <i class="fas fa-times"></i> Отмена\n                    </button>\n                </div>\n                <div class="property-hint">\n                    <p><i class="fas fa-info-circle"></i>\n                    ${"subtract"===this.operation?"ПКМ – уменьшаемые (зелёные), ЛКМ – вычитаемые (красные).":" Кликните на объекты для выбора (добавить/удалить)."}\n                    После выбора объектов будет показан предпросмотр.\n                    Подтвердите операцию кнопкой или клавишей Enter.</p>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return;const t=this.propertiesElement.querySelector("#booleanApplyBtn");t&&t.addEventListener("click",()=>this._confirmOperation());const e=this.propertiesElement.querySelector("#booleanCancelBtn");e&&e.addEventListener("click",()=>{this._exit(),this.editor.toolManager.restorePreviousTool()})}_updatePropertiesPanel(){if(!this.propertiesElement)return;const t=this.propertiesElement.querySelector("#booleanStage"),e=this.propertiesElement.querySelector("#booleanApplyBtn"),s=this.propertiesElement.querySelector("#booleanSelectedInfo");if("subtract"===this.operation){let e="";e=0===this.baseObjects.length?"Выберите уменьшаемые (ПКМ)":0===this.subtractObjects.length?"Выберите вычитаемые (ЛКМ)":"Предпросмотр",t&&(t.textContent=e),s&&(s.textContent=`Уменьшаемых: ${this.baseObjects.length}, Вычитаемых: ${this.subtractObjects.length}`)}else{const e=this.editor.selectedObjects.length;t&&(t.textContent=`Выбрано объектов: ${e}`),s&&s.remove()}if(e){const t="subtract"===this.operation?0===this.baseObjects.length||0===this.subtractObjects.length:this._getOperands().length<this.minObjects;e.disabled=t}}showLoadingIndicator(t){let e=document.getElementById("boolLoadingIndicator");if(e)e.querySelector(".message").textContent=t,e.style.display="flex";else if(e=document.createElement("div"),e.id="boolLoadingIndicator",e.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: rgba(0, 0, 0, 0.8);\n                color: white;\n                padding: 20px 30px;\n                border-radius: 8px;\n                z-index: 10001;\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                font-family: Arial, sans-serif;\n            ",e.innerHTML=`\n                <div class="spinner" style="\n                    width: 24px;\n                    height: 24px;\n                    border: 3px solid rgba(255, 255, 255, 0.3);\n                    border-radius: 50%;\n                    border-top-color: #fff;\n                    animation: spin 1s linear infinite;\n                "></div>\n                <div class="message">${t}</div>\n            `,document.body.appendChild(e),!document.querySelector("#boolLoadingStyles")){const t=document.createElement("style");t.id="boolLoadingStyles",t.textContent="@keyframes spin { to { transform: rotate(360deg); } }",document.head.appendChild(t)}}hideLoadingIndicator(){const t=document.getElementById("boolLoadingIndicator");t&&(t.style.display="none")}}export class BooleanUnionTool extends BooleanTool{constructor(t){super(t,"union")}}export class BooleanSubtractTool extends BooleanTool{constructor(t){super(t,"subtract")}}export class BooleanIntersectTool extends BooleanTool{constructor(t){super(t,"intersect")}}