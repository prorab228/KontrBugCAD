class ToolManager{constructor(e){this.editor=e,this.tools=new Map,this.currentTool=null,this.previousTool=null}initTools(){this.gearGenerator=new GearGenerator,this.threadGenerator=new ThreadGenerator,this.registerTool("select",new SelectTool(this.editor)),this.registerTool("move",new MoveTool(this.editor)),this.registerTool("rotate",new RotateTool(this.editor)),this.registerTool("scale",new ScaleTool(this.editor)),this.registerTool("sketch",new SketchTool(this.editor)),this.registerTool("extrude",new ExtrudeTool(this.editor)),this.registerTool("revolve",new RevolveTool(this.editor)),this.registerTool("workplane",new WorkPlaneTool(this.editor)),this.registerTool("rulerTool",new RulerTool(this.editor)),this.registerTool("gearGenerator",new GearTool(this.editor)),this.registerTool("threadGenerator",new ThreadTool(this.editor)),this.registerTool("split",new SplitTool(this.editor)),this.registerTool("mirror",new MirrorTool(this.editor)),this.registerTool("group",new GroupTool(this.editor)),this.registerTool("ungroup",new UngroupTool(this.editor)),this.registerTool("chamfer",new FilletChamferTool(this.editor)),this.registerTool("text3dTool",new Text3DTool(this.editor)),this.registerTool("boolean-union",new BooleanUnionTool(this.editor)),this.registerTool("boolean-subtract",new BooleanSubtractTool(this.editor)),this.registerTool("boolean-intersect",new BooleanIntersectTool(this.editor)),this.registerTool("repair",new RepairTool(this.editor)),this.registerTool("decimate",new DecimateTool(this.editor)),this.registerTool("imageTool",new ImageTool(this.editor)),this.setCurrentTool("select")}registerTool(e,o){this.tools.set(e,o);const t=document.querySelector(`[data-tool="${e}"]`);document.querySelector(`[data-tool="${e}"]`);return t&&(o.uiButton=t,t.addEventListener("click",o=>{o.preventDefault(),this.setCurrentTool(e)})),o}notifyModelRebuilt(){this.currentTool&&"function"==typeof this.currentTool.onModelRebuilt&&this.currentTool.onModelRebuilt()}setCurrentTool(e){if(console.log(`Setting current tool to: ${e}`),this.currentTool&&this.currentTool.name===e)return void console.log(`Tool ${e} is already active`);this.currentTool&&(console.log(`Deactivating current tool: ${this.currentTool.name}`),this.currentTool.deactivate(),this.previousTool=this.currentTool),"select"==e?this.editor.switchToTab("library"):this.editor.switchToTab("properties");const o=this.tools.get(e);if(o){if(console.log(`Activating tool: ${e}`),this.currentTool=o,o.requiresSelection&&0===this.editor.selectedObjects.length)return this.editor.showStatus(`Для ${o.name} необходимо выбрать объект`,"error"),void(this.previousTool?this.setCurrentTool(this.previousTool.name):this.setCurrentTool("select"));this.currentTool.activate(),this.editor.currentTool=e,this.updateToolUI(e),this.editor.updatePropertiesPanel()}else console.error(`Tool not found: ${e}`)}getTool(e){return this.tools.get(e)}getCurrentTool(){return this.currentTool}updateToolUI(e){document.querySelectorAll(".tool-btn").forEach(e=>{e.classList.remove("active")});document.querySelectorAll("[data-tool]").forEach(o=>{o.classList.remove("active"),o.dataset.tool===e&&o.classList.add("active")});if(document.querySelectorAll(".dropdown-menu a[data-tool]").forEach(o=>{o.classList.remove("active"),o.dataset.tool===e&&o.classList.add("active")}),["move","rotate","scale"].includes(e)){const e=document.querySelector('.dropdown-toggle[title="Трансформация"]');e&&e.classList.add("active")}}restorePreviousTool(){this.previousTool?this.setCurrentTool(this.previousTool.name):this.setCurrentTool("select")}handleMouseDown(e){if(this.currentTool&&this.currentTool.isActive){const o=this.currentTool.onMouseDown(e);return console.log(`Tool ${this.currentTool.name} handled mouse down: ${o}`),o}return!1}handleMouseMove(e){this.currentTool&&this.currentTool.isActive&&this.currentTool.onMouseMove(e)}handleMouseUp(e){if(this.currentTool&&this.currentTool.isActive){const o=this.currentTool.onMouseUp(e);console.log(`Tool ${this.currentTool.name} handled mouse up: ${o}`)}}handleKeyDown(e){if(this.currentTool&&this.currentTool.isActive){const o=this.currentTool.onKeyDown(e);if(console.log(`Tool ${this.currentTool.name} handled KeyDown: ${o}`),o)return!0}switch(e.key.toLowerCase()){case"escape":if(this.currentTool&&"sketch"!==this.currentTool.name)return this.setCurrentTool("select"),e.preventDefault(),!0;break;case"m":case"ь":if(e.ctrlKey||e.metaKey)return this.setCurrentTool("rulerTool"),e.preventDefault(),!0;break;case"m":case"ь":if(e.ctrlKey&&e.shiftKey)return this.setCurrentTool("mirror"),e.preventDefault(),!0;break;case"g":case"п":if(e.ctrlKey&&!e.shiftKey)return this.setCurrentTool("group"),e.preventDefault(),!0;if(e.ctrlKey&&e.shiftKey)return this.setCurrentTool("ungroup"),e.preventDefault(),!0;break;case"w":case"ц":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.setCurrentTool("move"),e.preventDefault(),!0;break;case"r":case"к":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.setCurrentTool("rotate"),e.preventDefault(),!0;break;case"s":case"ы":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.setCurrentTool("scale"),e.preventDefault(),!0}return!1}handleKeyUp(e){this.currentTool&&this.currentTool.isActive&&this.currentTool.onKeyUp(e)}handleDoubleClick(e){return!(!this.currentTool||!this.currentTool.isActive)&&this.currentTool.onDoubleClick(e)}}