class ToolManager{constructor(e){this.editor=e,this.tools=new Map,this.currentTool=null,this.previousTool=null}registerTool(e,t){this.tools.set(e,t);const o=document.querySelector(`[data-tool="${e}"]`);document.querySelector(`[data-tool="${e}"]`);return o&&(t.uiButton=o,o.addEventListener("click",t=>{t.preventDefault(),this.setCurrentTool(e)})),t}setCurrentTool(e){if(console.log(`Setting current tool to: ${e}`),this.currentTool&&this.currentTool.name===e)return void console.log(`Tool ${e} is already active`);this.currentTool&&(console.log(`Deactivating current tool: ${this.currentTool.name}`),this.currentTool.deactivate(),this.previousTool=this.currentTool),"select"==e?this.editor.switchToTab("library"):this.editor.switchToTab("properties");const t=this.tools.get(e);if(t){if(console.log(`Activating tool: ${e}`),this.currentTool=t,t.requiresSelection&&0===this.editor.selectedObjects.length)return this.editor.showStatus(`Для ${t.name} необходимо выбрать объект`,"error"),void(this.previousTool?this.setCurrentTool(this.previousTool.name):this.setCurrentTool("select"));this.currentTool.activate(),this.editor.currentTool=e,this.updateToolUI(e),this.editor.updatePropertiesPanel()}else console.error(`Tool not found: ${e}`)}getTool(e){return this.tools.get(e)}getCurrentTool(){return this.currentTool}updateToolUI(e){document.querySelectorAll(".tool-btn").forEach(e=>{e.classList.remove("active")});document.querySelectorAll("[data-tool]").forEach(t=>{t.classList.remove("active"),t.dataset.tool===e&&t.classList.add("active")});if(document.querySelectorAll(".dropdown-menu a[data-tool]").forEach(t=>{t.classList.remove("active"),t.dataset.tool===e&&t.classList.add("active")}),["move","rotate","scale"].includes(e)){const e=document.querySelector('.dropdown-toggle[title="Трансформация"]');e&&e.classList.add("active")}}restorePreviousTool(){this.previousTool?this.setCurrentTool(this.previousTool.name):this.setCurrentTool("select")}handleMouseDown(e){if(this.currentTool&&this.currentTool.isActive){const t=this.currentTool.onMouseDown(e);return console.log(`Tool ${this.currentTool.name} handled mouse down: ${t}`),t}return!1}handleMouseMove(e){this.currentTool&&this.currentTool.isActive&&this.currentTool.onMouseMove(e)}handleMouseUp(e){if(this.currentTool&&this.currentTool.isActive){const t=this.currentTool.onMouseUp(e);console.log(`Tool ${this.currentTool.name} handled mouse up: ${t}`)}}handleKeyDown(e){if(this.currentTool&&this.currentTool.isActive){const t=this.currentTool.onKeyDown(e);if(console.log(`Tool ${this.currentTool.name} handled KeyDown: ${t}`),t)return!0}switch(e.key.toLowerCase()){case"escape":if(this.currentTool&&"sketch"!==this.currentTool.name)return this.setCurrentTool("select"),e.preventDefault(),!0;break;case"m":case"ь":if(e.ctrlKey||e.metaKey)return this.setCurrentTool("rulerTool"),e.preventDefault(),!0;break;case"s":case"ы":if(e.ctrlKey&&e.shiftKey)return this.setCurrentTool("split"),e.preventDefault(),!0;break;case"m":case"ь":if(e.ctrlKey&&e.shiftKey)return this.setCurrentTool("mirror"),e.preventDefault(),!0;break;case"g":case"п":if(e.ctrlKey&&!e.shiftKey)return this.setCurrentTool("group"),e.preventDefault(),!0;if(e.ctrlKey&&e.shiftKey)return this.setCurrentTool("ungroup"),e.preventDefault(),!0;break;case"w":case"ц":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.setCurrentTool("move"),e.preventDefault(),!0;break;case"e":case"у":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.setCurrentTool("rotate"),e.preventDefault(),!0;break;case"r":case"к":if(!e.ctrlKey&&!e.shiftKey&&!e.altKey)return this.setCurrentTool("scale"),e.preventDefault(),!0}return!1}handleKeyUp(e){this.currentTool&&this.currentTool.isActive&&this.currentTool.onKeyUp(e)}handleDoubleClick(e){return!(!this.currentTool||!this.currentTool.isActive)&&this.currentTool.onDoubleClick(e)}}