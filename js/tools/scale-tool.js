class ScaleTool extends TransformToolBase{constructor(e){super("scale","fa-expand-alt",e),this.sizeStartDimensions=new THREE.Vector3,this.startScale=new THREE.Vector3,this.uniformScaling=!1,this.percentageMode=!1,this.lastMousePosition=new THREE.Vector2,this.currentHandle=null,this.startHandleWorldPosition=new THREE.Vector3,this.hoveredHandle=null,this._inputContainer=null,this._inputElement=null,this._unitElement=null,this._isInputFocused=!1,this._lastInputValue=100,this._isDragging=!1,this._currentDragAxis=null,this.initGizmo(),this.initScaleInput()}initScaleInput(){this._inputContainer=document.createElement("div"),this._inputContainer.className="distance-input-container",this._inputContainer.style.display="none",this._inputElement=document.createElement("input"),this._inputElement.type="number",this._inputElement.step="0.1",this._inputElement.value="0",this._inputContainer.appendChild(this._inputElement),this._unitElement=document.createElement("span"),this._unitElement.textContent="мм",this._unitElement.style.marginLeft="5px",this._inputContainer.appendChild(this._unitElement),document.body.appendChild(this._inputContainer),this._inputElement.addEventListener("focus",()=>{this._isInputFocused=!0}),this._inputElement.addEventListener("blur",()=>{this._isInputFocused=!1}),this._inputElement.addEventListener("input",e=>{const t=parseFloat(e.target.value);isNaN(t)||this.updateFromInput(t)})}updateInputUnit(){this._unitElement&&(this._unitElement.textContent=this.percentageMode?"%":"мм")}updateFromInput(e){if(!this.attachedObject||!this._currentDragAxis)return;this.attachedObject.userData.transformStartState||(this.attachedObject.userData.transformStartState={position:this.attachedObject.position.clone(),rotation:this.attachedObject.quaternion.clone(),scale:this.attachedObject.scale.clone()});let t=this.getObjectDimensions(this.attachedObject).clone();if(this.percentageMode){const i=e/100,s=this.attachedObject.userData.originalSize||this.getObjectDimensions(this.attachedObject);this.uniformScaling?(t.x=s.x*i,t.y=s.y*i,t.z=s.z*i):"x"===this._currentDragAxis?t.x=s.x*i:"y"===this._currentDragAxis?t.y=s.y*i:"z"===this._currentDragAxis&&(t.z=s.z*i)}else this.uniformScaling?t.set(e,e,e):"x"===this._currentDragAxis?t.x=e:"y"===this._currentDragAxis?t.y=e:"z"===this._currentDragAxis&&(t.z=e);this.updateObjectSize(t,!1),this.updateGizmoPosition()}initGizmo(){for(;this.gizmoGroup.children.length>0;){const e=this.gizmoGroup.children[0];e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),this.gizmoGroup.remove(e)}this.createScaleGizmo(),this.gizmoGroup.visible=!1}createScaleGizmo(){this.baseSize=10,this.halfSize=this.baseSize/2,this.createBaseRectangle(1.5,.1),this.createVerticalRectangle(1.5,.1)}createBaseRectangle(e,t){const i=this.halfSize,s=this.halfSize,n=[[-i,-i,-s],[i,-i,-s],[-i,-i,s],[i,-i,s],[-i,-i,-s],[-i,-i,s],[i,-i,-s],[i,-i,s]],a=new THREE.BufferGeometry,r=new Float32Array(n.flat());a.setAttribute("position",new THREE.BufferAttribute(r,3));const o=new THREE.LineBasicMaterial({color:16777215,linewidth:2,transparent:!0,opacity:.7}),c=new THREE.LineSegments(a,o);c.name="base_rectangle",c.userData.type="scale",c.userData.plane="base",this.gizmoGroup.add(c);const l=[{pos:[-i,-i,0],axis:"x",color:this.axisColors.x,direction:1},{pos:[i,-i,0],axis:"x",color:this.axisColors.x,direction:1},{pos:[0,-i,-s],axis:"z",color:this.axisColors.z,direction:1},{pos:[0,-i,s],axis:"z",color:this.axisColors.z,direction:1}];this.baseMiddleHandles=[],l.forEach((t,i)=>{const s=this.createHandleCube(t.pos,t.axis,t.color,e,`base_middle_${t.axis}_${i}`);s.userData.direction=t.direction,this.baseMiddleHandles.push(s)})}createVerticalRectangle(e,t){const i=this.halfSize,s=this.halfSize,n=[[0,-i,-i],[0,s,-i],[0,-i,i],[0,s,i],[0,-i,-i],[0,-i,i],[0,s,-i],[0,s,i]],a=new THREE.BufferGeometry,r=new Float32Array(n.flat());a.setAttribute("position",new THREE.BufferAttribute(r,3));const o=new THREE.LineBasicMaterial({color:16777215,linewidth:2,transparent:!0,opacity:.7}),c=new THREE.LineSegments(a,o);c.name="vertical_rectangle",c.userData.type="scale",c.userData.plane="vertical",this.gizmoGroup.add(c);const l=[{pos:[0,-i,0],axis:"y",color:this.axisColors.y,direction:1},{pos:[0,s,0],axis:"y",color:this.axisColors.y,direction:1},{pos:[0,0,-i],axis:"z",color:this.axisColors.z,direction:1},{pos:[0,0,i],axis:"z",color:this.axisColors.z,direction:1}];this.verticalMiddleHandles=[],l.forEach((t,i)=>{const s=this.createHandleCube(t.pos,t.axis,t.color,e,`vertical_middle_${t.axis}_${i}`);s.userData.direction=t.direction,this.verticalMiddleHandles.push(s)})}createHandleCube(e,t,i,s,n){const a=new THREE.BoxGeometry(s,s,s),r=new THREE.MeshBasicMaterial({color:i,transparent:!0,depthTest:!1,opacity:.9}),o=new THREE.Mesh(a,r);return o.renderOrder=1,o.position.set(...e),o.name=`scale_handle_${n}`,o.userData.type="scale",o.userData.axis=t,o.userData.handle=!0,this.gizmoGroup.add(o),o}updateGizmoPosition(){if(!this.attachedObject)return;const e=new THREE.Vector3;this.attachedObject.getWorldPosition(e),this.gizmoGroup.position.copy(e),this.useLocalCoordinates?this.gizmoGroup.quaternion.copy(this.attachedObject.quaternion):this.gizmoGroup.quaternion.identity();const t=this.getObjectDimensions(this.attachedObject),i=t.x/2+1,s=t.y/2+1,n=t.z/2+1;this.baseMiddleHandles&&this.baseMiddleHandles.length>=4&&(this.baseMiddleHandles[0].position.set(-i,-s,0),this.baseMiddleHandles[1].position.set(i,-s,0),this.baseMiddleHandles[2].position.set(0,-s,-n),this.baseMiddleHandles[3].position.set(0,-s,n)),this.verticalMiddleHandles&&this.verticalMiddleHandles.length>=4&&(this.verticalMiddleHandles[0].position.set(0,-s,0),this.verticalMiddleHandles[1].position.set(0,s,0),this.verticalMiddleHandles[2].position.set(0,0,-n),this.verticalMiddleHandles[3].position.set(0,0,n)),this.updateRectangleGeometries(i,s,n),this.updateHandleMaterials()}updateHandleMaterials(){this.baseMiddleHandles.forEach(e=>{const t=e===this.hoveredHandle,i=t?16776960:this.axisColors[e.userData.axis],s=t?1:.9;e.material&&(e.material.color.set(i),e.material.opacity=s)}),this.verticalMiddleHandles.forEach(e=>{const t=e===this.hoveredHandle,i=t?16776960:this.axisColors[e.userData.axis],s=t?1:.9;e.material&&(e.material.color.set(i),e.material.opacity=s)})}updateRectangleGeometries(e,t,i){const s=this.gizmoGroup.getObjectByName("base_rectangle");if(s&&s.geometry){const n=[-e,-t,-i,e,-t,-i,-e,-t,i,e,-t,i,-e,-t,-i,-e,-t,i,e,-t,-i,e,-t,i];s.geometry.attributes.position.array=new Float32Array(n),s.geometry.attributes.position.needsUpdate=!0}const n=this.gizmoGroup.getObjectByName("vertical_rectangle");if(n&&n.geometry){const e=[0,-t,-i,0,t,-i,0,-t,i,0,t,i,0,-t,-i,0,-t,i,0,t,-i,0,t,i];n.geometry.attributes.position.array=new Float32Array(e),n.geometry.attributes.position.needsUpdate=!0}}updateInputPosition(){if(!this._inputContainer||!this.currentHandle)return;const e=new THREE.Vector3;this.currentHandle.getWorldPosition(e);const t=this.worldToScreen(e,this.editor.camera,this.editor.renderer);this._inputContainer.style.left=t.x-60+"px",this._inputContainer.style.top=t.y-30+"px"}worldToScreen(e,t,i){const s=e.clone();s.project(t);return{x:(.5*s.x+.5)*i.domElement.clientWidth,y:(-.5*s.y+.5)*i.domElement.clientHeight}}onMouseDown(e){if(0!==e.button)return!1;this.snapEnabled=!e.ctrlKey,this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=[];this.gizmoGroup.traverse(e=>{e instanceof THREE.Mesh&&e.userData.handle&&t.push(e)});const i=this.editor.raycaster.intersectObjects(t,!0);if(i.length>0){const t=i[0].object;this.currentHandle=t;const s=t.userData.axis;return this.startHandleWorldPosition.copy(t.getWorldPosition(new THREE.Vector3)),this.startDragging(s,e),!0}const s=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);if(s.length>0){const e=this.editor.objectsManager.findTopParent(s[0].object);if(this.canTransformObject(e))return this.editor.selectSingleObject(e),this.attachToObject(e),!0}return!1}onMouseMove(e){if(super.onMouseMove(e),this.isDragging)return;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=[];this.gizmoGroup.traverse(e=>{e instanceof THREE.Mesh&&e.userData.handle&&t.push(e)});const i=this.editor.raycaster.intersectObjects(t,!0);if(this.hoveredHandle&&(this.hoveredHandle=null),i.length>0){const e=i[0].object;this.hoveredHandle=e}this.updateGizmoPosition()}startDragging(e,t){if(super.startDragging(e,t),this.attachedObject){this.editor.renderer.domElement.getBoundingClientRect();if(this.startMouse.set(t.clientX,t.clientY),this.lastMousePosition.copy(this.startMouse),this.sizeStartDimensions=this.getObjectDimensions(this.attachedObject),this.startScale.copy(this.attachedObject.scale),this.moveDelta.set(0,0,0),this._currentDragAxis=e,this._isDragging=!0,this.attachedObject.userData.originalSize||(this.attachedObject.userData.originalSize=this.sizeStartDimensions.clone()),this.attachedObject.userData.transformStartState={originalDimensions:this.getObjectDimensions(this.attachedObject).clone(),scale:this.attachedObject.scale.clone()},console.log("ScaleTool: Start dragging",{originalDimensions:this.attachedObject.userData.transformStartState.originalDimensions.toArray(),scale:this.attachedObject.scale.toArray()}),this._inputContainer){this._inputContainer.style.display="block",this.updateInputUnit();const t=this.getObjectDimensions(this.attachedObject);if(this.percentageMode){let i=100;const s=this.attachedObject.userData.originalSize||t;this.uniformScaling||"x"===e?i=t.x/s.x*100:"y"===e?i=t.y/s.y*100:"z"===e&&(i=t.z/s.z*100),this._inputElement.value=i.toFixed(1)}else this.uniformScaling||"x"===e?this._inputElement.value=t.x.toFixed(1):"y"===e?this._inputElement.value=t.y.toFixed(1):"z"===e&&(this._inputElement.value=t.z.toFixed(1));"x"===e?this._inputContainer.style.borderColor="#ff4444":"y"===e?this._inputContainer.style.borderColor="#44ff44":"z"===e&&(this._inputContainer.style.borderColor="#4444ff"),this.updateInputPosition()}}}handleTransform(e,t){if(!this.attachedObject||!this.currentAxis||!this.currentHandle)return;const i=this.startMouse.x+e,s=this.startMouse.y+t,n=this.editor.renderer.domElement.getBoundingClientRect(),a=new THREE.Vector2;a.x=(i-n.left)/n.width*2-1,a.y=-(s-n.top)/n.height*2+1,this.editor.raycaster.setFromCamera(a,this.editor.camera);const r=new THREE.Vector3;this.attachedObject.getWorldPosition(r);const o=new THREE.Vector3;o.copy(this.startHandleWorldPosition).sub(r).normalize();const c=this.editor.raycaster.ray.direction.clone(),l=(new THREE.Plane).setFromNormalAndCoplanarPoint(c,this.startHandleWorldPosition),h=new THREE.Vector3;if(this.editor.raycaster.ray.intersectPlane(l,h)){let e=1+.1*h.sub(this.startHandleWorldPosition).dot(o)*this.currentHandle.userData.direction;e=Math.max(.1,e);let t=new THREE.Vector3;if(this.percentageMode){const i=this.attachedObject.userData.originalSize||this.sizeStartDimensions;this.uniformScaling?(t.x=i.x*e,t.y=i.y*e,t.z=i.z*e):"x"===this.currentAxis?(t.x=i.x*e,t.y=i.y,t.z=i.z):"y"===this.currentAxis?(t.x=i.x,t.y=i.y*e,t.z=i.z):"z"===this.currentAxis&&(t.x=i.x,t.y=i.y,t.z=i.z*e)}else this.uniformScaling?(t.x=this.sizeStartDimensions.x*e,t.y=this.sizeStartDimensions.y*e,t.z=this.sizeStartDimensions.z*e):"x"===this.currentAxis?(t.x=this.sizeStartDimensions.x*e,t.y=this.sizeStartDimensions.y,t.z=this.sizeStartDimensions.z):"y"===this.currentAxis?(t.x=this.sizeStartDimensions.x,t.y=this.sizeStartDimensions.y*e,t.z=this.sizeStartDimensions.z):"z"===this.currentAxis&&(t.x=this.sizeStartDimensions.x,t.y=this.sizeStartDimensions.y,t.z=this.sizeStartDimensions.z*e);this.snapEnabled&&!this.editor.spacePressed&&(t.x=Math.round(t.x/this.sizeSnapValue)*this.sizeSnapValue,t.y=Math.round(t.y/this.sizeSnapValue)*this.sizeSnapValue,t.z=Math.round(t.z/this.sizeSnapValue)*this.sizeSnapValue);const i=.1;let s;if(t.x=Math.max(i,t.x),t.y=Math.max(i,t.y),t.z=Math.max(i,t.z),this.updateObjectSize(t,!1),this.percentageMode){const e=this.attachedObject.userData.originalSize||this.sizeStartDimensions;this.uniformScaling||"x"===this.currentAxis?s=t.x/e.x*100:"y"===this.currentAxis?s=t.y/e.y*100:"z"===this.currentAxis&&(s=t.z/e.z*100)}else this.uniformScaling||"x"===this.currentAxis?s=t.x:"y"===this.currentAxis?s=t.y:"z"===this.currentAxis&&(s=t.z);!this._isInputFocused&&this._inputElement&&(this._inputElement.value=s.toFixed(1)),this.updateInputPosition()}}onMouseUp(e){super.onMouseUp(e),this.currentHandle=null,this._isDragging=!1,this.hoveredHandle=null,this.updateGizmoPosition()}detach(){this._inputContainer&&(this._inputContainer.style.display="none"),this.hoveredHandle=null,this._currentDragAxis=null,this._isDragging=!1,super.detach()}onDeactivate(){this._inputContainer&&(this._inputContainer.style.display="none"),this.hoveredHandle=null,this._currentDragAxis=null,this._isDragging=!1,super.onDeactivate()}getPropertiesHTML(){return console.log("ScaleTool: создание HTML свойств"),`\n            <div class="property-group" data-type="scale-size">\n                <h4><i class="fas fa-ruler"></i> Размеры</h4>\n\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="uniformScaling" ${this.uniformScaling?"checked":""}>\n                        Равномерное изменение размера\n                    </label>\n                </div>\n\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="percentageMode" ${this.percentageMode?"checked":""}>\n                        Режим процентов\n                    </label>\n                </div>\n\n                <div class="property-row">\n                    <label>Локальные координаты:</label>\n                    <input type="checkbox" id="localCoordinates" ${this.useLocalCoordinates?"checked":""}>\n                </div>\n\n                <div id="scaleAbsoluteControls" style="${this.percentageMode?"display: none;":""}">\n                    <div class="property-row">\n                        <label>Ширина (X):</label>\n                        <input type="number" id="scaleX" step="0.1" min="0.1" value="25">\n                        <span>мм</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Высота (Y):</label>\n                        <input type="number" id="scaleY" step="0.1" min="0.1" value="25">\n                        <span>мм</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Глубина (Z):</label>\n                        <input type="number" id="scaleZ" step="0.1" min="0.1" value="25">\n                        <span>мм</span>\n                    </div>\n                </div>\n\n                <div id="scalePercentageControls" style="${this.percentageMode?"":"display: none;"}">\n                    <div class="property-row">\n                        <label>Ширина (X):</label>\n                        <input type="number" id="scalePercentX" step="1" min="1" value="100">\n                        <span>%</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Высота (Y):</label>\n                        <input type="number" id="scalePercentY" step="1" min="1" value="100">\n                        <span>%</span>\n                    </div>\n                    <div class="property-row">\n                        <label>Глубина (Z):</label>\n                        <input type="number" id="scalePercentZ" step="1" min="1" value="100">\n                        <span>%</span>\n                    </div>\n                    <div class="property-row">\n                        <button id="applyScalePercentage" class="btn-small">\n                            <i class="fas fa-check"></i> Применить масштаб\n                        </button>\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <button id="applyScale" class="btn-small" style="${this.percentageMode?"display: none;":""}">\n                        <i class="fas fa-check"></i> Применить размеры\n                    </button>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return void console.log("ScaleTool: propertiesElement отсутствует");console.log("ScaleTool: привязка событий");const e=this.propertiesElement.querySelector("#scaleX"),t=this.propertiesElement.querySelector("#scaleY"),i=this.propertiesElement.querySelector("#scaleZ"),s=this.propertiesElement.querySelector("#applyScale"),n=this.propertiesElement.querySelector("#uniformScaling"),a=this.propertiesElement.querySelector("#percentageMode"),r=this.propertiesElement.querySelector("#localCoordinates");e&&(e.addEventListener("change",e=>this.onSizeChange("x",e)),e.addEventListener("input",e=>this.onSizeChange("x",e))),t&&(t.addEventListener("change",e=>this.onSizeChange("y",e)),t.addEventListener("input",e=>this.onSizeChange("y",e))),i&&(i.addEventListener("change",e=>this.onSizeChange("z",e)),i.addEventListener("input",e=>this.onSizeChange("z",e))),s&&s.addEventListener("click",()=>this.applySizeFromInputs()),n&&(n.checked=this.uniformScaling,n.addEventListener("change",e=>{this.uniformScaling=e.target.checked,console.log("Равномерное масштабирование:",this.uniformScaling)})),a&&(a.checked=this.percentageMode,a.addEventListener("change",e=>{if(this.percentageMode=e.target.checked,this.updatePropertiesUI(),this.updateInputUnit(),this._inputContainer&&"block"===this._inputContainer.style.display&&this.attachedObject){const e=this.getObjectDimensions(this.attachedObject);if(this.percentageMode){const t=this.attachedObject.userData.originalSize||e;let i=100;this.uniformScaling?i=e.x/t.x*100:this._currentDragAxis&&("x"===this._currentDragAxis?i=e.x/t.x*100:"y"===this._currentDragAxis?i=e.y/t.y*100:"z"===this._currentDragAxis&&(i=e.z/t.z*100)),this._inputElement.value=i.toFixed(1)}else this.uniformScaling?this._inputElement.value=e.x.toFixed(1):this._currentDragAxis&&("x"===this._currentDragAxis?this._inputElement.value=e.x.toFixed(1):"y"===this._currentDragAxis?this._inputElement.value=e.y.toFixed(1):"z"===this._currentDragAxis&&(this._inputElement.value=e.z.toFixed(1)))}}));const o=this.propertiesElement.querySelector("#scalePercentX"),c=this.propertiesElement.querySelector("#scalePercentY"),l=this.propertiesElement.querySelector("#scalePercentZ"),h=this.propertiesElement.querySelector("#applyScalePercentage");o&&(o.addEventListener("change",e=>this.onPercentChange("x",e)),o.addEventListener("input",e=>this.onPercentChange("x",e))),c&&(c.addEventListener("change",e=>this.onPercentChange("y",e)),c.addEventListener("input",e=>this.onPercentChange("y",e))),l&&(l.addEventListener("change",e=>this.onPercentChange("z",e)),l.addEventListener("input",e=>this.onPercentChange("z",e))),h&&h.addEventListener("click",()=>this.applyPercentageScale()),r&&(r.checked=this.useLocalCoordinates,r.addEventListener("change",e=>{this.useLocalCoordinates=e.target.checked,this.updateGizmoPosition()}))}updatePropertiesUI(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#scaleAbsoluteControls"),t=this.propertiesElement.querySelector("#scalePercentageControls"),i=this.propertiesElement.querySelector("#applyScale");this.percentageMode?(e&&(e.style.display="none"),t&&(t.style.display="block"),i&&(i.style.display="none")):(e&&(e.style.display="block"),t&&(t.style.display="none"),i&&(i.style.display="block"))}onSizeChange(e,t){if(!this.attachedObject||this.percentageMode)return;const i=parseFloat(t.target.value);if(isNaN(i)||i<.1)return;const s=this.getObjectDimensions(this.attachedObject),n=s.clone();if(n[e]=i,this.uniformScaling){const t=i/s[e];n.x*=t,n.y*=t,n.z*=t;const a=this.propertiesElement.querySelector("#scaleX"),r=this.propertiesElement.querySelector("#scaleY"),o=this.propertiesElement.querySelector("#scaleZ");a&&(a.value=n.x.toFixed(2)),r&&(r.value=n.y.toFixed(2)),o&&(o.value=n.z.toFixed(2))}this.updateObjectSize(n,!1)}onPercentChange(e,t){if(!this.attachedObject||!this.percentageMode)return;const i=parseFloat(t.target.value);if(!(isNaN(i)||i<1)&&this.uniformScaling){const e=this.propertiesElement.querySelector("#scalePercentX"),t=this.propertiesElement.querySelector("#scalePercentY"),s=this.propertiesElement.querySelector("#scalePercentZ");e&&(e.value=i),t&&(t.value=i),s&&(s.value=i)}}applyPercentageScale(){if(!this.propertiesElement||!this.attachedObject||!this.percentageMode)return;const e=parseFloat(this.propertiesElement.querySelector("#scalePercentX").value),t=parseFloat(this.propertiesElement.querySelector("#scalePercentY").value),i=parseFloat(this.propertiesElement.querySelector("#scalePercentZ").value);if(isNaN(e)||isNaN(t)||isNaN(i)||e<1||t<1||i<1)return void this.editor.showStatus("Некорректные значения процентов","error");const s=this.attachedObject.userData.originalSize||this.getObjectDimensions(this.attachedObject),n=new THREE.Vector3(s.x*(e/100),s.y*(t/100),s.z*(i/100)),a=this.getObjectDimensions(this.attachedObject);this.updateObjectSize(n,!1),this.editor.history.addAction({type:"modify_size",object:this.attachedObject.uuid,data:{dimensions:n.toArray(),previousDimensions:a.toArray()}}),this.editor.showStatus(`Масштаб установлен: X:${e}%, Y:${t}%, Z:${i}%`,"success")}applySizeFromInputs(){if(!this.propertiesElement||!this.attachedObject||this.percentageMode)return;const e=parseFloat(this.propertiesElement.querySelector("#scaleX").value),t=parseFloat(this.propertiesElement.querySelector("#scaleY").value),i=parseFloat(this.propertiesElement.querySelector("#scaleZ").value);if(isNaN(e)||isNaN(t)||isNaN(i)||e<.1||t<.1||i<.1)return void this.editor.showStatus("Некорректные значения размеров","error");const s=this.getObjectDimensions(this.attachedObject),n=new THREE.Vector3(e,t,i);this.updateObjectSize(n,!0),this.editor.history.addAction({type:"modify_size",object:this.attachedObject.uuid,data:{dimensions:n.toArray(),previousDimensions:s.toArray()}}),this.editor.showStatus(`Размеры установлены: ${e}x${t}x${i} мм`,"success")}updatePropertiesValues(){if(!this.propertiesElement||!this.attachedObject)return;const e=this.getObjectDimensions(this.attachedObject),t=this.propertiesElement.querySelector("#scaleX"),i=this.propertiesElement.querySelector("#scaleY"),s=this.propertiesElement.querySelector("#scaleZ"),n=this.propertiesElement.querySelector("#scalePercentX"),a=this.propertiesElement.querySelector("#scalePercentY"),r=this.propertiesElement.querySelector("#scalePercentZ");t&&(t.value=e.x.toFixed(2)),i&&(i.value=e.y.toFixed(2)),s&&(s.value=e.z.toFixed(2));const o=this.attachedObject.userData.originalSize||e;n&&(n.value=Math.round(e.x/o.x*100)),a&&(a.value=Math.round(e.y/o.y*100)),r&&(r.value=Math.round(e.z/o.z*100))}updateObjectSize(e,t=!0){if(!this.attachedObject)return;const i=this.getObjectDimensions(this.attachedObject),s=e.x/i.x,n=e.y/i.y,a=e.z/i.z;if(this.attachedObject.scale.x*=s,this.attachedObject.scale.y*=n,this.attachedObject.scale.z*=a,this.attachedObject.userData.originalSize){const e=this.attachedObject.userData.originalSize;e.clone&&(this.attachedObject.userData.originalSize=e.clone().multiply(new THREE.Vector3(s,n,a)))}else this.attachedObject.userData.originalSize=e.clone();this.updateGizmoPosition(),this.updatePropertiesValues(),t&&this.attachedObject.userData.transformStartState&&this.saveToHistory()}saveToHistory(){if(!this.attachedObject||!this.attachedObject.userData.transformStartState)return;const e=this.getObjectDimensions(this.attachedObject),t=this.attachedObject.userData.transformStartState,i={type:"modify_size",object:this.attachedObject.uuid,data:{dimensions:e.toArray(),previousDimensions:t.originalDimensions.toArray()}};this.editor.history.addAction(i),delete this.attachedObject.userData.transformStartState}getObjectDimensions(e){if(!e)return new THREE.Vector3;if(e.userData&&e.userData.originalSize){if(Array.isArray(e.userData.originalSize)){return(new THREE.Vector3).fromArray(e.userData.originalSize).clone().multiply(e.scale)}if(e.userData.originalSize.clone)return e.userData.originalSize.clone().multiply(e.scale);if(void 0!==e.userData.originalSize.x){return new THREE.Vector3(e.userData.originalSize.x,e.userData.originalSize.y,e.userData.originalSize.z).multiply(e.scale)}}const t=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;return t.getSize(i),i}getTooltipContent(){if(!this.attachedObject)return"";const e=this.getObjectDimensions(this.attachedObject),t=this.attachedObject.userData.originalSize||e,i=this.percentageMode?Math.round(e.x/t.x*100):0;return`\n            <div style="font-weight: 600; margin-bottom: 6px; color: #fff;">${this.percentageMode?"Масштаб":"Размеры"} (мм):</div>\n            ${this.percentageMode?`\n                <div style="color: #ffd43b; font-size: 16px; text-align: center;">\n                    ${i}%\n                </div>\n            `:`\n                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">\n                    <div style="color: #ff6b6b;">\n                        <div style="font-size: 10px; opacity: 0.8;">Ширина (X)</div>\n                        <div>${e.x.toFixed(1)}</div>\n                    </div>\n                    <div style="color: #51cf66;">\n                        <div style="font-size: 10px; opacity: 0.8;">Высота (Y)</div>\n                        <div>${e.y.toFixed(1)}</div>\n                    </div>\n                    <div style="color: #339af0;">\n                        <div style="font-size: 10px; opacity: 0.8;">Глубина (Z)</div>\n                        <div>${e.z.toFixed(1)}</div>\n                    </div>\n                </div>\n            `}\n            <div style="margin-top: 8px; font-size: 10px; opacity: 0.7; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 4px;">\n                Режим: ${this.uniformScaling?"равномерный":"по осям"} |\n                Ctrl: ${this.snapEnabled?"с привязкой":"без привязки"}\n            </div>\n        `}createHistoryAction(){return this.attachedObject&&this.attachedObject.userData.transformStartState?{type:"modify_size",object:this.attachedObject.uuid,data:{dimensions:this.getObjectDimensions(this.attachedObject).toArray(),previousDimensions:this.attachedObject.userData.transformStartState.scale.toArray()}}:null}getHistoryActionType(){return"modify_size"}}