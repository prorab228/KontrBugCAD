class SelectTool extends Tool{constructor(t){super("select","fa-mouse-pointer",t),this.isDragging=!1,this.dragManager=t.dragManager,this.clickThreshold=5,this.clickStartPos=null,this.dragCandidate=null}onActivate(){this.editor.sketchMode&&this.editor.exitSketchMode(),this.editor.extrudeMode&&this.editor.extrudeManager.cancelExtrudeMode(),this.editor.workPlaneMode&&this.editor.planesManager.exitWorkPlaneMode()}onDeactivate(){this.isDragging&&this.endDrag(),this.dragManager&&this.dragManager.clearLinesAndInputs(),this.dragCandidate=null}ensureObjectSelected(t){t&&(this.editor.selectedObjects.includes(t)||this.editor.toggleObjectSelection(t))}getObjectAtMouse(){const t=[];this.editor.scene.traverse(e=>{e.isMesh&&t.push(e)});const e=this.editor.raycaster.intersectObjects(t,!1);if(0===e.length)return null;for(const t of e){let e=t.object;for(;e;){if(this.editor.parametricModel.objectMap.has(e.uuid)){const t=e.userData?.type;if(!(e.userData?.isHelper||["grid","axis","grid_helper","axes_helper","base_plane"].includes(t))&&e.visible)return e}e=e.parent}}return null}onMouseDown(t){if(0!==t.button)return!1;this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this.getObjectAtMouse();if(this.clickStartPos={x:t.clientX,y:t.clientY},this.dragCandidate=null,!e||!e.visible)return this.editor.clearSelection(),this.dragManager&&this.dragManager.resetDrag(),this.clickStartPos=null,!1;{const t=[];this.editor.scene.traverse(e=>{e.isMesh&&t.push(e)});const i=this.editor.raycaster.intersectObjects(t,!1).find(t=>{let i=t.object;for(;i;){if(i===e)return!0;i=i.parent}return!1}),s=i?i.point:new THREE.Vector3;this.dragCandidate={object:e,point:s}}return!0}onMouseMove(t){if(this.dragCandidate&&!this.isDragging&&this.clickStartPos){const e=Math.abs(t.clientX-this.clickStartPos.x),i=Math.abs(t.clientY-this.clickStartPos.y);if(Math.sqrt(e*e+i*i)>this.clickThreshold&&this.dragManager){const{object:e,point:i}=this.dragCandidate;this.ensureObjectSelected(e),this.dragManager.prepareDrag(e,i),this.startDrag(t)}}this.isDragging&&this.dragManager&&this.dragManager.onMouseMove(t)}onMouseUp(t){if(this.isDragging)this.endDrag();else if(this.dragCandidate){const{object:e}=this.dragCandidate;this.handleSelection(t,e)}this.isDragging=!1,this.clickStartPos=null,this.dragCandidate=null}startDrag(t){this.isDragging=!0,this.dragManager&&this.dragManager.startDrag(t),this.editor.showStatus("Перетаскивание объекта","info")}endDrag(){this.dragManager&&this.dragManager.finishDrag(),this.isDragging=!1,this.clickStartPos=null,this.dragCandidate=null}handleSelection(t,e){t.ctrlKey||t.shiftKey||t.metaKey?this.editor.selectSingleObject(e):this.editor.toggleObjectSelection(e),this.editor.updatePropertiesPanel(),this.editor.updateStatus()}onDoubleClick(t){if(0!==t.button)return!1;this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this.getObjectAtMouse();return!!e&&(this.editor.selectSingleObject(e),"sketch_plane"===e.userData.type?(this.editor.toolManager.setCurrentTool("sketch"),!0):(this.editor.focusCameraOnObject(e),!0))}onKeyDown(t){return!("Escape"!==t.key||!this.isDragging)&&(this.dragManager&&this.dragManager.cancelDrag(),this.isDragging=!1,this.clickStartPos=null,this.dragCandidate=null,!0)}}