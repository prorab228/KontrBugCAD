class SelectTool extends Tool{constructor(t){super("select","fa-mouse-pointer",t),this.isDragging=!1,this.dragManager=t.dragManager,this.clickThreshold=5,this.clickStartPos=null}onActivate(){this.editor.sketchMode&&this.editor.exitSketchMode(),this.editor.extrudeMode&&this.editor.extrudeManager.cancelExtrudeMode(),this.editor.workPlaneMode&&this.editor.planesManager.exitWorkPlaneMode()}onDeactivate(){this.isDragging&&this.endDrag(),this.dragManager&&this.dragManager.clearLinesAndInputs()}getObjectAtMouse(){const t=[];this.editor.scene.traverse(e=>{e.isMesh&&t.push(e)});const e=this.editor.raycaster.intersectObjects(t,!1);if(0===e.length)return null;for(const t of e){let e=t.object;for(;e;){if(this.editor.parametricModel.objectMap.has(e.uuid)){const t=e.userData?.type;if(!(e.userData?.isHelper||["grid","axis","grid_helper","axes_helper","base_plane"].includes(t))&&e.visible)return e}e=e.parent}}return null}onMouseDown(t){if(0!==t.button)return!1;this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this.getObjectAtMouse();if(this.clickStartPos={x:t.clientX,y:t.clientY},e){if(this.canDragObject(e)&&e.visible){const t=[];this.editor.scene.traverse(e=>{e.isMesh&&t.push(e)});const r=this.editor.raycaster.intersectObjects(t,!1).find(t=>{let r=t.object;for(;r;){if(r===e)return!0;r=r.parent}return!1}),i=r?r.point:new THREE.Vector3;return this.prepareDrag(e,i),!0}return this.handleSelection(t,e),!0}return this.editor.clearSelection(),!1}onMouseMove(t){if(this.clickStartPos&&!this.isDragging){const e=Math.abs(t.clientX-this.clickStartPos.x),r=Math.abs(t.clientY-this.clickStartPos.y);Math.sqrt(e*e+r*r)>this.clickThreshold&&this.dragManager&&this.startDrag(t)}this.isDragging&&this.dragManager&&this.dragManager.onMouseMove(t)}onMouseUp(t){this.isDragging?this.endDrag():this.clickStartPos&&this.handleClick(t),this.isDragging=!1,this.clickStartPos=null}prepareDrag(t,e){this.dragManager&&this.dragManager.prepareDrag(t,e)}startDrag(t){this.isDragging=!0,this.dragManager&&this.dragManager.startDrag(t),this.editor.showStatus("Перетаскивание объекта","info")}endDrag(){this.dragManager&&this.dragManager.finishDrag(),this.isDragging=!1,this.clickStartPos=null}handleSelection(t,e){t.ctrlKey||t.shiftKey||t.metaKey?this.editor.toggleObjectSelection(e):this.editor.selectSingleObject(e),this.editor.updatePropertiesPanel(),this.editor.updateStatus()}handleClick(t){this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this.getObjectAtMouse();e?this.handleSelection(t,e):(this.editor.clearSelection(),this.dragManager&&this.dragManager.resetDrag())}onDoubleClick(t){if(0!==t.button)return!1;this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this.getObjectAtMouse();return!!e&&("sketch_plane"===e.userData.type?(this.editor.toolManager.setCurrentTool("sketch"),!0):(this.editor.focusCameraOnObject(e),!0))}canDragObject(t){if(!t)return!1;const e=t.userData?.type;return"work_plane"!==e&&"sketch_plane"!==e&&"base_plane"!==e}onKeyDown(t){return!("Escape"!==t.key||!this.isDragging)&&(this.dragManager&&this.dragManager.cancelDrag(),this.isDragging=!1,this.clickStartPos=null,!0)}}