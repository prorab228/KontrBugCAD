class GearGenerator{constructor(t){this.editor=t,this.defaultParams={teeth:20,module:2,pressureAngle:20,faceWidth:10,hubDiameter:20,boreDiameter:8,backlash:.1,quality:"medium"},this.toothSettings={toothToGapRatio:.6,topFlatness:.2,involuteQuality:16,riseRatio:.5,topRatio:.12,fallRatio:.58}}calculateGearParams(t){const e=t.teeth,o=t.module,a=THREE.MathUtils.degToRad(t.pressureAngle),i=e*o,s=o,n=1.25*o,r=i+2*s,l=i-2*n,h=i*Math.cos(a);return{teeth:e,module:o,pressureAngle:a,pitchDiameter:i,addendum:s,dedendum:n,outerDiameter:r,rootDiameter:l,baseDiameter:h,pitchRadius:i/2,outerRadius:r/2,rootRadius:l/2,baseRadius:h/2,angularPitch:2*Math.PI/e,fullToothAngle:2*Math.PI/e}}involutePoint(t,e){const o=Math.cos(e),a=Math.sin(e);return new THREE.Vector2(t*(o+e*a),t*(a-e*o))}involuteAngle(t,e){return Math.sqrt(Math.pow(t/e,2)-1)}createToothProfile(t){const e=[],o=this.toothSettings.involuteQuality,a=t.baseRadius,i=t.rootRadius,s=t.outerRadius,n=this.involuteAngle(i,a),r=this.involuteAngle(s,a),l=t.angularPitch*this.toothSettings.toothToGapRatio/2,h=-l;e.push(new THREE.Vector2(i*Math.cos(h),i*Math.sin(h)));for(let t=0;t<=o;t++){const i=n+t/o*(r-n),s=this.involutePoint(a,i),l=s.x*Math.cos(h)-s.y*Math.sin(h),d=s.x*Math.sin(h)+s.y*Math.cos(h);e.push(new THREE.Vector2(l,d))}const d=l*this.toothSettings.topFlatness;for(let t=1;t<=2;t++){const o=h+d*t;e.push(new THREE.Vector2(s*Math.cos(o),s*Math.sin(o)))}for(let t=o;t>=0;t--){const i=n+t/o*(r-n),s=this.involutePoint(a,-i),l=s.x*Math.cos(-h)-s.y*Math.sin(-h),d=s.x*Math.sin(-h)+s.y*Math.cos(-h);e.push(new THREE.Vector2(l,d))}return e.push(new THREE.Vector2(i*Math.cos(-h),i*Math.sin(-h))),e}createGearProfile(t){const e=new THREE.Shape;for(let o=0;o<t.teeth;o++){const a=o*t.fullToothAngle;if(this.createToothProfile(t).forEach((t,i)=>{const s=t.x*Math.cos(a)-t.y*Math.sin(a),n=t.x*Math.sin(a)+t.y*Math.cos(a);0===o&&0===i?e.moveTo(s,n):e.lineTo(s,n)}),o<t.teeth-1){t.fullToothAngle;const o=t.fullToothAngle*(1-this.toothSettings.toothToGapRatio);for(let i=1;i<=4;i++){const s=i/4,n=a+t.fullToothAngle*this.toothSettings.toothToGapRatio+s*o,r=t.rootRadius*Math.cos(n),l=t.rootRadius*Math.sin(n);e.lineTo(r,l)}}}const o=(t.teeth-1)*t.fullToothAngle,a=t.fullToothAngle*(1-this.toothSettings.toothToGapRatio);for(let i=1;i<=4;i++){const s=i/4,n=o+t.fullToothAngle*this.toothSettings.toothToGapRatio+s*a,r=t.rootRadius*Math.cos(n),l=t.rootRadius*Math.sin(n);e.lineTo(r,l)}return e}createGear(t={}){const e={...this.defaultParams,...t},o=this.calculateGearParams(e),a=this.createGearProfile(o);if(e.boreDiameter>0){const t=new THREE.Path;t.absarc(0,0,e.boreDiameter/2,0,2*Math.PI,!0),a.holes.push(t)}let i=32;switch(e.quality){case"low":i=Math.max(16,o.teeth);break;case"high":i=Math.max(64,4*o.teeth);break;default:i=Math.max(32,2*o.teeth)}const s={depth:e.faceWidth,bevelEnabled:!1,curveSegments:i,steps:1};try{const t=new THREE.ExtrudeGeometry(a,s);t.rotateX(-Math.PI/2),t.translate(0,e.faceWidth/2,0);const o=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3,side:THREE.DoubleSide}),i=new THREE.Mesh(t,o);return i.castShadow=!0,i.receiveShadow=!0,i.userData={type:"gear",gearParams:e,name:`Шестерня ${e.teeth}z M${e.module} (прецизионная)`,createdAt:(new Date).toISOString(),precision:!0},i}catch(e){return console.error("Ошибка создания прецизионной шестерни:",e),this.editor.showStatus("Не удалось создать прецизионную шестерню, создается упрощенная версия","warning"),this.createSimpleGear(t)}}createSimpleGear(t={}){const e={...this.defaultParams,...t},o=this.calculateGearParams(e),a=new THREE.Shape;let i;switch(e.quality){case"low":i=12*o.teeth;break;case"high":i=128*o.teeth;break;default:i=32*o.teeth}const s=o.fullToothAngle*this.toothSettings.toothToGapRatio,n=o.fullToothAngle*(1-this.toothSettings.toothToGapRatio);for(let t=0;t<o.teeth;t++){const e=t*o.fullToothAngle,r=Math.floor(i/o.teeth),l=Math.floor(r*(1-this.toothSettings.toothToGapRatio));for(let i=0;i<=l;i++){const s=e+i/l*n,r=Math.cos(s)*o.rootRadius,h=Math.sin(s)*o.rootRadius;0===t&&0===i?a.moveTo(r,h):a.lineTo(r,h)}const h=Math.floor(r*this.toothSettings.toothToGapRatio*this.toothSettings.riseRatio);for(let t=1;t<=h;t++){const i=t/h,r=e+n+i*(s*this.toothSettings.riseRatio),l=Math.sin(i*Math.PI/2),d=o.rootRadius+(o.outerRadius-o.rootRadius)*l,c=Math.cos(r)*d,u=Math.sin(r)*d;a.lineTo(c,u)}const d=Math.max(2,Math.floor(r*this.toothSettings.toothToGapRatio*this.toothSettings.topRatio));for(let t=1;t<=d;t++){const i=t/d,r=e+n+s*this.toothSettings.riseRatio+i*(s*this.toothSettings.topRatio),l=Math.cos(r)*o.outerRadius,h=Math.sin(r)*o.outerRadius;a.lineTo(l,h)}const c=Math.floor(r*this.toothSettings.toothToGapRatio*this.toothSettings.fallRatio);for(let t=1;t<=c;t++){const i=t/c,r=e+n+s*(this.toothSettings.riseRatio+this.toothSettings.topRatio)+i*(s*this.toothSettings.fallRatio),l=Math.cos(i*Math.PI/2),h=o.rootRadius+(o.outerRadius-o.rootRadius)*l,d=Math.cos(r)*h,u=Math.sin(r)*h;a.lineTo(d,u)}}if(a.closePath(),e.boreDiameter>0){const t=new THREE.Path;t.absarc(0,0,e.boreDiameter/2,0,2*Math.PI,!0),a.holes.push(t)}const r={depth:e.faceWidth,bevelEnabled:!1,curveSegments:Math.max(32,2*o.teeth)},l=new THREE.ExtrudeGeometry(a,r);l.rotateX(-Math.PI/2),l.translate(0,e.faceWidth/2,0);const h=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3}),d=new THREE.Mesh(l,h);return d.castShadow=!0,d.receiveShadow=!0,d.userData={type:"gear",gearParams:e,name:`Шестерня ${e.teeth}z M${e.module}`,createdAt:(new Date).toISOString(),simplified:!0},d}showGearUI(){if(document.getElementById("gearModal"))return;const t=document.createElement("div");t.innerHTML='\n            <div class="modal-overlay active" id="gearModal">\n                <div class="modal-content" style="width: 500px;">\n                    <div class="modal-header">\n                        <h4><i class="fas fa-cog"></i> Генератор шестерён</h4>\n                        <button class="close-modal">&times;</button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-group">\n                            <label>Количество зубьев:</label>\n                            <input type="number" id="gearTeeth" min="6" max="200" value="20" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Модуль (мм):</label>\n                            <input type="number" id="gearModule" min="0.5" max="20" step="0.1" value="2" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Угол зацепления (°):</label>\n                            <input type="number" id="gearPressureAngle" min="14.5" max="30" step="0.5" value="20" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Ширина зуба (мм):</label>\n                            <input type="number" id="gearFaceWidth" min="1" max="100" value="10" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Диаметр отверстия (мм):</label>\n                            <input type="number" id="gearBoreDiameter" min="0" max="100" value="8" class="modal-input">\n                        </div>\n\n                        <div class="form-group">\n                            <label>Качество:</label>\n                            <select id="gearQuality" class="modal-select">\n                                <option value="low">Низкое (быстро)</option>\n                                <option value="medium" selected>Среднее</option>\n                                <option value="high">Высокое (медленно)</option>\n                            </select>\n                        </div>\n\n                        <div class="form-group">\n                            <label>Тип шестерни:</label>\n                            <select id="gearType" class="modal-select">\n                                <option value="simple">Упрощенная (рекомендуется)</option>\n                                <option value="precision">Прецизионная (эвольвента, ещё в разработке)</option>\n                            </select>\n                        </div>\n\n                        <div class="info-box">\n                            <strong>Расчетные параметры:</strong>\n                            <div id="gearCalculations" style="margin-top: 5px; color: #aaa; font-size: 12px;">\n                                Диаметр: 44мм, Высота зуба: 4.5мм\n                            </div>\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" id="cancelGear">Отмена</button>\n                        <button class="btn btn-primary" id="createGear">Создать</button>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(t),this.updateCalculations();const e=()=>{t&&t.parentNode&&t.parentNode.removeChild(t)};document.querySelector("#gearModal .close-modal").addEventListener("click",e),document.getElementById("cancelGear").addEventListener("click",e),document.getElementById("createGear").addEventListener("click",()=>{this.createGearFromUI(),e()});document.querySelectorAll("#gearModal .modal-input").forEach(t=>{t.addEventListener("input",()=>{this.updateCalculations()})}),document.getElementById("gearQuality").addEventListener("change",()=>{this.updateCalculations()}),document.getElementById("gearType").addEventListener("change",()=>{this.updateCalculations()})}updateCalculations(){try{const t=parseInt(document.getElementById("gearTeeth").value)||20,e=parseFloat(document.getElementById("gearModule").value)||2,o=parseFloat(document.getElementById("gearPressureAngle").value)||20,a=document.getElementById("gearType")?.value||"simple",i=t*e,s=e,n=1.25*e,r=i+2*s,l=i-2*n,h=i*Math.cos(THREE.MathUtils.degToRad(o)),d=document.getElementById("gearCalculations");if(d){let t="precision"===a?" (эвольвентная)":" (упрощенная)";d.innerHTML=`\n                    <div>Диаметр вершин: ${r.toFixed(2)}мм</div>\n                    <div>Делительный диаметр: ${i.toFixed(2)}мм</div>\n                    <div>Диаметр впадин: ${l.toFixed(2)}мм</div>\n                    <div>Основной диаметр: ${h.toFixed(2)}мм</div>\n                    <div>Высота зуба: ${(s+n).toFixed(2)}мм</div>\n                    <div>Тип: ${t}</div>\n                `}}catch(t){console.warn("Не удалось обновить расчеты:",t)}}createGearFromUI(){try{const t={teeth:parseInt(document.getElementById("gearTeeth").value)||20,module:parseFloat(document.getElementById("gearModule").value)||2,pressureAngle:parseFloat(document.getElementById("gearPressureAngle").value)||20,faceWidth:parseFloat(document.getElementById("gearFaceWidth").value)||10,boreDiameter:parseFloat(document.getElementById("gearBoreDiameter").value)||8,quality:document.getElementById("gearQuality").value||"medium"},e=document.getElementById("gearType").value;if(t.teeth<6)return void this.editor.showStatus("Количество зубьев должно быть не менее 6","error");if(t.module<=0)return void this.editor.showStatus("Модуль должен быть положительным числом","error");let o;if("precision"===e)o=this.createGear(t);else o=this.createSimpleGear(t);if(!o)return void this.editor.showStatus("Не удалось создать шестерню","error");this.editor.objectsGroup.add(o),this.editor.objects.push(o),this.editor.selectObject(o),this.editor.history.addAction({type:"create",object:o.uuid,data:this.editor.projectManager.serializeObjectForHistory(o)}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Шестерня создана: ${t.teeth} зубьев, модуль ${t.module}мм`,"success")}catch(t){console.error("Ошибка создания шестерни:",t),this.editor.showStatus(`Ошибка создания шестерни: ${t.message}`,"error")}}}