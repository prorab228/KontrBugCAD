class GearGenerator{constructor(e){this.editor=e,this.defaultParams={teeth:20,module:2,pressureAngle:20,faceWidth:10,hubDiameter:20,boreDiameter:8,backlash:.1,quality:"medium"}}calculateGearParams(e){const t=e.teeth,a=e.module,r=THREE.MathUtils.degToRad(e.pressureAngle),o=t*a,n=a,s=1.25*a,i=o+2*n,d=o-2*s,l=o*Math.cos(r);return{teeth:t,module:a,pressureAngle:r,pitchDiameter:o,addendum:n,dedendum:s,outerDiameter:i,rootDiameter:d,baseDiameter:l,pitchRadius:o/2,outerRadius:i/2,rootRadius:d/2,baseRadius:l/2,angularPitch:2*Math.PI/t,fullToothAngle:2*Math.PI/t}}createToothProfile(e){const t=[];return t.push(new THREE.Vector2(-e.angularPitch/4,e.rootRadius)),t.push(new THREE.Vector2(0,e.outerRadius)),t.push(new THREE.Vector2(e.angularPitch/8,e.outerRadius)),t.push(new THREE.Vector2(e.angularPitch/4,e.rootRadius)),t.push(new THREE.Vector2(e.angularPitch/2,e.rootRadius)),t}createGearProfile(e){const t=new THREE.Shape,a=this.createToothProfile(e);for(let r=0;r<e.teeth;r++){const o=r*e.fullToothAngle;a.forEach((e,a)=>{const n=e.x*Math.cos(o)-e.y*Math.sin(o),s=e.x*Math.sin(o)+e.y*Math.cos(o);0===r&&0===a?t.moveTo(n,s):t.lineTo(n,s)})}const r=a[0],o=r.x*Math.cos(0)-r.y*Math.sin(0),n=r.x*Math.sin(0)+r.y*Math.cos(0);return t.lineTo(o,n),t}createGear(e={}){const t={...this.defaultParams,...e},a=this.calculateGearParams(t),r=this.createGearProfile(a);if(t.boreDiameter>0){const e=new THREE.Path;e.absarc(0,0,t.boreDiameter/2,0,2*Math.PI,!0),r.holes.push(e)}const o={depth:t.faceWidth,bevelEnabled:!1,curveSegments:Math.max(32,2*a.teeth)},n=new THREE.ExtrudeGeometry(r,o);n.rotateX(-Math.PI/2),n.translate(0,t.faceWidth/2,0);const s=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3,side:THREE.DoubleSide}),i=new THREE.Mesh(n,s);return t.hubDiameter>t.boreDiameter&&this.addHub(i,t),i.castShadow=!0,i.receiveShadow=!0,i.userData={type:"gear",gearParams:t,name:`Шестерня ${t.teeth}z M${t.module}`,createdAt:(new Date).toISOString()},i}addHub(e,t){const a=new THREE.CylinderGeometry(t.hubDiameter/2,t.hubDiameter/2,t.faceWidth,32),r=new THREE.MeshStandardMaterial({color:6710886,roughness:.8,metalness:.2}),o=new THREE.Mesh(a,r);if(o.position.y=t.faceWidth/2,e.isGroup)e.add(o);else{const t=new THREE.Group;t.add(e),t.add(o),e=t}return e}createSimpleGear(e={}){const t={...this.defaultParams,...e},a=this.calculateGearParams(t),r=new THREE.Shape,o=8*t.teeth;for(let e=0;e<=o;e++){const t=e/o*Math.PI*2;let n;const s=t%a.fullToothAngle/a.fullToothAngle;n=s<.25?a.rootRadius+(a.outerRadius-a.rootRadius)*(s/.25):s<.5?a.outerRadius-(a.outerRadius-a.rootRadius)*((s-.25)/.25):a.rootRadius;const i=Math.cos(t)*n,d=Math.sin(t)*n;0===e?r.moveTo(i,d):r.lineTo(i,d)}if(t.boreDiameter>0){const e=new THREE.Path;e.absarc(0,0,t.boreDiameter/2,0,2*Math.PI,!0),r.holes.push(e)}const n={depth:t.faceWidth,bevelEnabled:!1,curveSegments:Math.max(32,2*t.teeth)},s=new THREE.ExtrudeGeometry(r,n);s.rotateX(-Math.PI/2),s.translate(0,t.faceWidth/2,0);const i=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3}),d=new THREE.Mesh(s,i);return t.hubDiameter>t.boreDiameter&&this.addHub(d,t),d.castShadow=!0,d.receiveShadow=!0,d.userData={type:"gear",gearParams:t,name:`Шестерня ${t.teeth}z M${t.module} (упрощ.)`,createdAt:(new Date).toISOString(),simplified:!0},d}createTestGear(e={}){const t={...this.defaultParams,...e},a=8*t.teeth,r=new THREE.CylinderGeometry(t.module*t.teeth/2+t.module,t.module*t.teeth/2+t.module,t.faceWidth,a),o=r.attributes.position;for(let e=0;e<o.count;e++){const a=o.getX(e),r=o.getZ(e),n=Math.atan2(r,a),s=Math.sqrt(a*a+r*r);if(Math.abs(o.getY(e))<t.faceWidth/2-.1){const i=(n+Math.PI)%(2*Math.PI/t.teeth),d=Math.abs(Math.sin(i*t.teeth*2)),l=(t.module*t.teeth/2+t.module*(.5+.5*d))/s;o.setX(e,a*l),o.setZ(e,r*l)}}r.computeVertexNormals(),r.rotateX(Math.PI/2);const n=new THREE.MeshStandardMaterial({color:8421504,roughness:.7,metalness:.3}),s=new THREE.Mesh(r,n);if(t.boreDiameter>0){const e=new THREE.CylinderGeometry(t.boreDiameter/2,t.boreDiameter/2,t.faceWidth+2,32);e.rotateX(Math.PI/2);const a=new THREE.MeshStandardMaterial({color:6316128,roughness:.8}),r=new THREE.Mesh(e,a);s.add(r)}return s.castShadow=!0,s.receiveShadow=!0,s.userData={type:"gear",gearParams:t,name:`Тестовая шестерня ${t.teeth}z`,createdAt:(new Date).toISOString(),test:!0},s}showGearUI(){if(document.getElementById("gearModal"))return;const e=document.createElement("div");e.innerHTML='\n            <div class="modal-overlay active" id="gearModal">\n                <div class="modal-content" style="width: 500px;">\n                    <div class="modal-header">\n                        <h4><i class="fas fa-cog"></i> Генератор шестерён</h4>\n                        <button class="close-modal">&times;</button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-group">\n                            <label>Количество зубьев:</label>\n                            <input type="number" id="gearTeeth" min="6" max="200" value="20" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Модуль (мм):</label>\n                            <input type="number" id="gearModule" min="0.5" max="20" step="0.1" value="2" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Ширина зуба (мм):</label>\n                            <input type="number" id="gearFaceWidth" min="1" max="100" value="10" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Диаметр ступицы (мм):</label>\n                            <input type="number" id="gearHubDiameter" min="5" max="200" value="20" class="modal-input">\n                        </div>\n                        <div class="form-group">\n                            <label>Диаметр отверстия (мм):</label>\n                            <input type="number" id="gearBoreDiameter" min="0" max="100" value="8" class="modal-input">\n                        </div>\n\n                        <div class="form-group">\n                            <label>Тип шестерни:</label>\n                            <select id="gearType" class="modal-select">\n                                <option value="simple">Упрощенная (рекомендуется)</option>\n                                <option value="test">Тестовая (быстрая)</option>\n                            </select>\n                        </div>\n\n                        <div class="info-box">\n                            <strong>Расчетные параметры:</strong>\n                            <div id="gearCalculations" style="margin-top: 5px; color: #aaa; font-size: 12px;">\n                                Диаметр: 40мм, Высота зуба: 2.5мм\n                            </div>\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" id="cancelGear">Отмена</button>\n                        <button class="btn btn-primary" id="createGear">Создать</button>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(e),this.updateCalculations();const t=()=>{e&&e.parentNode&&e.parentNode.removeChild(e)};document.querySelector("#gearModal .close-modal").addEventListener("click",t),document.getElementById("cancelGear").addEventListener("click",t),document.getElementById("createGear").addEventListener("click",()=>{this.createGearFromUI(),t()}),document.querySelectorAll("#gearModal .modal-input").forEach(e=>{e.addEventListener("input",()=>{this.updateCalculations()})})}updateCalculations(){try{const e=parseInt(document.getElementById("gearTeeth").value)||20,t=parseFloat(document.getElementById("gearModule").value)||2,a=e*t,r=t,o=1.25*t,n=a+2*r,s=a-2*o,i=document.getElementById("gearCalculations");i&&(i.innerHTML=`\n                    <div>Диаметр вершин: ${n.toFixed(2)}мм</div>\n                    <div>Делительный диаметр: ${a.toFixed(2)}мм</div>\n                    <div>Диаметр впадин: ${s.toFixed(2)}мм</div>\n                    <div>Высота зуба: ${(r+o).toFixed(2)}мм</div>\n                `)}catch(e){console.warn("Не удалось обновить расчеты:",e)}}createGearFromUI(){try{const e={teeth:parseInt(document.getElementById("gearTeeth").value)||20,module:parseFloat(document.getElementById("gearModule").value)||2,faceWidth:parseFloat(document.getElementById("gearFaceWidth").value)||10,hubDiameter:parseFloat(document.getElementById("gearHubDiameter").value)||20,boreDiameter:parseFloat(document.getElementById("gearBoreDiameter").value)||8},t=document.getElementById("gearType").value;if(e.teeth<6)return void this.editor.showStatus("Количество зубьев должно быть не менее 6","error");if(e.module<=0)return void this.editor.showStatus("Модуль должен быть положительным числом","error");let a;switch(e.boreDiameter>=e.hubDiameter&&e.hubDiameter>0&&this.editor.showStatus("Диаметр отверстия должен быть меньше диаметра ступицы","warning"),t){case"simple":default:a=this.createSimpleGear(e);break;case"test":a=this.createTestGear(e)}if(!a)return void this.editor.showStatus("Не удалось создать шестерню","error");this.editor.objectsGroup.add(a),this.editor.objects.push(a),this.editor.selectObject(a),this.editor.history.addAction({type:"create",object:a.uuid,data:this.editor.projectManager.serializeObjectForHistory(a)}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Шестерня создана: ${e.teeth} зубьев, модуль ${e.module}мм`,"success")}catch(e){console.error("Ошибка создания шестерни:",e),this.editor.showStatus(`Ошибка создания шестерни: ${e.message}`,"error")}}}