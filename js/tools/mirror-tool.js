import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"./tool.js";export class MirrorTool extends Tool{constructor(e){super("mirror","fa-expand-arrows-alt",e),this.requiresSelection=!0,this.mirrorPlane=null,this.mirrorAxis=null,this.propertiesElement=null,this.highlightedPlane=null,this.planes=[],this.previewGroup=null,this.mirrorMode="select"}onActivate(){if(this.canActivate())return this.planes=[],this.editor.scene.traverse(e=>{!e.userData||"work_plane"!==e.userData.type&&"sketch_plane"!==e.userData.type||this.planes.push(e)}),this.mirrorMode="select",this.mirrorPlane=null,this.mirrorAxis=null,this.previewGroup=null,this.createPropertiesSection(),document.body.style.cursor="crosshair",this.editor.showStatus("Выберите ось отражения в панели свойств ИЛИ кликните на плоскость","info"),!0;this.editor.toolManager.restorePreviousTool()}onDeactivate(){this.removePropertiesSection(),this.cleanup(),document.body.style.cursor="default"}onMouseDown(e){if(0!==e.button||!this.mirrorMode)return!1;if(this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),"select"===this.mirrorMode){const e=this.editor.raycaster.intersectObjects(this.planes,!0);if(e.length>0){const r=e[0].object;return this.mirrorPlane=r,this.mirrorAxis=null,this.mirrorMode="confirm",this.createPreview("plane",r),this.updateUI(),this.editor.showStatus('Плоскость выбрана. Нажмите "Применить" или Enter для отражения',"success"),!0}}return!1}onMouseMove(e){if("select"===this.mirrorMode&&!this.mirrorAxis){this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const r=this.editor.raycaster.intersectObjects(this.planes,!0);if(this.clearPlaneHighlight(),r.length>0&&!this.mirrorPlane){const e=r[0].object;this.highlightPlane(e)}}return!0}highlightPlane(e){this.clearPlaneHighlight();const r=new THREE.PlaneGeometry(50,50),t=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:.3,side:THREE.DoubleSide});this.highlightedPlane=new THREE.Mesh(r,t),this.highlightedPlane.position.copy(e.position),this.highlightedPlane.quaternion.copy(e.quaternion),this.highlightedPlane.userData.isHighlight=!0,this.highlightedPlane.renderOrder=999,this.editor.scene.add(this.highlightedPlane)}clearPlaneHighlight(){this.highlightedPlane&&(this.editor.scene.remove(this.highlightedPlane),this.highlightedPlane.geometry&&this.highlightedPlane.geometry.dispose(),this.highlightedPlane.material&&this.highlightedPlane.material.dispose(),this.highlightedPlane=null)}createPreview(e,r){if(this.clearPreview(),!this.editor.selectedObjects.length)return;const t=this.editor.selectedObjects.filter(t=>"plane"!==e||t!==r);0!==t.length&&(this.previewGroup=new THREE.Group,t.forEach(t=>{const i=t.clone(!0);if("axis"===e?this.reflectObjectByAxis(i,r):"plane"===e&&this.reflectObjectByPlane(i,r),i.material)if(Array.isArray(i.material))i.material=i.material.map(e=>{const r=e.clone();return r.transparent=!0,r.opacity=.5,r.depthWrite=!1,r});else{const e=i.material.clone();e.transparent=!0,e.opacity=.5,e.depthWrite=!1,i.material=e}i.castShadow=!1,i.receiveShadow=!1,i.userData.isPreview=!0,this.previewGroup.add(i)}),this.editor.scene.add(this.previewGroup))}reflectObjectByAxis(e,r){const t=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;t.getCenter(i);const s=e.position.clone().sub(i);switch(r){case"x":s.x=-s.x;break;case"y":s.y=-s.y;break;case"z":s.z=-s.z}e.position.copy(i).add(s)}reflectObjectByPlane(e,r){const t=new THREE.Vector3(0,0,1).applyQuaternion(r.quaternion).normalize(),i=r.position.clone(),s=e.position.clone().sub(i).dot(t),o=t.clone().multiplyScalar(-2*s);e.position.add(o)}clearPreview(){this.previewGroup&&(this.editor.scene.remove(this.previewGroup),this.previewGroup.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>e.dispose()):e.material.dispose())}),this.previewGroup=null)}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","mirrorTool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="mirrorTool"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="mirror-settings">\n                <h4>ОТРАЖЕНИЕ (ЗЕРКАЛО)</h4>\n\n                <div class="property-row">\n                    <label>Выбранные объекты:</label>\n                    <div style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px;">\n                        ${this.editor.selectedObjects.length} объект(ов)\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>Тип отражения:</label>\n                    <div id="mirrorTypeInfo" style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px; min-height: 36px;">\n                        ${this.mirrorAxis?`Ось: ${this.mirrorAxis.toUpperCase()}`:this.mirrorPlane?`Плоскость: ${this.mirrorPlane.userData?.name||"Плоскость"}`:"Не выбрано"}\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>Отражение по оси:</label>\n                    <div class="axis-buttons" style="display: flex; gap: 8px;">\n                        <button class="axis-btn" data-axis="x" style="flex: 1; padding: 8px 12px; background: rgba(255, 68, 68, 0.1); color: #ff4444; border: 1px solid #ff4444; border-radius: 4px; cursor: pointer;">X</button>\n                        <button class="axis-btn" data-axis="y" style="flex: 1; padding: 8px 12px; background: rgba(68, 255, 68, 0.1); color: #44ff44; border: 1px solid #44ff44; border-radius: 4px; cursor: pointer;">Y</button>\n                        <button class="axis-btn" data-axis="z" style="flex: 1; padding: 8px 12px; background: rgba(68, 68, 255, 0.1); color: #4444ff; border: 1px solid #4444ff; border-radius: 4px; cursor: pointer;">Z</button>\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>ИЛИ выберите плоскость кликом:</label>\n                    <div style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px;">\n                        Кликните на рабочую плоскость для отражения относительно нее\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>Действие:</label>\n                    <div style="display: flex; gap: 8px;">\n                        <button id="applyMirror" style="flex: 1; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;" ${this.mirrorAxis||this.mirrorPlane?"":"disabled"}>\n                            <i class="fas fa-check"></i> Применить\n                        </button>\n                        <button id="cancelMirror" style="flex: 1; padding: 8px 16px; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            <i class="fas fa-times"></i> Отмена\n                        </button>\n                    </div>\n                </div>\n\n                <div style="margin-top: 12px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 11px; color: var(--text-secondary);">\n                    <i class="fas fa-info-circle"></i>\n                    <div><strong>Инструкция:</strong></div>\n                    <div>1. Нажмите на кнопку оси (X, Y, Z) для отражения по оси</div>\n                    <div>2. ИЛИ кликните на рабочую плоскость для отражения относительно нее</div>\n                    <div>3. Нажмите "Применить" для выполнения</div>\n                    <div>4. Используйте ESC или кнопку "Отмена" для отмены</div>\n                </div>\n            </div>\n        `}updateUI(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#mirrorTypeInfo"),r=this.propertiesElement.querySelector("#applyMirror"),t=this.propertiesElement.querySelectorAll(".axis-btn");e&&(e.textContent=this.mirrorAxis?`Ось: ${this.mirrorAxis.toUpperCase()}`:this.mirrorPlane?`Плоскость: ${this.mirrorPlane.userData?.name||"Плоскость"}`:"Не выбрано"),r&&(r.disabled=!(this.mirrorAxis||this.mirrorPlane),r.style.opacity=this.mirrorAxis||this.mirrorPlane?"1":"0.5"),t&&t.forEach(e=>{e.dataset.axis===this.mirrorAxis?(e.style.background="x"===e.dataset.axis?"#ff4444":"y"===e.dataset.axis?"#44ff44":"#4444ff",e.style.color="white"):(e.style.background="x"===e.dataset.axis?"rgba(255, 68, 68, 0.1)":"y"===e.dataset.axis?"rgba(68, 255, 68, 0.1)":"rgba(68, 68, 255, 0.1)",e.style.color="x"===e.dataset.axis?"#ff4444":"y"===e.dataset.axis?"#44ff44":"#4444ff")})}bindPropertiesEvents(){if(!this.propertiesElement)return;this.propertiesElement.querySelectorAll(".axis-btn").forEach(e=>{e.addEventListener("click",()=>{this.mirrorAxis=e.dataset.axis,this.mirrorPlane=null,this.mirrorMode="confirm",this.clearPlaneHighlight(),this.createPreview("axis",this.mirrorAxis),this.updateUI(),this.editor.showStatus(`Выбрана ось отражения: ${this.mirrorAxis.toUpperCase()}`,"success")})});const e=this.propertiesElement.querySelector("#applyMirror");e&&e.addEventListener("click",()=>{this.applyMirror()});const r=this.propertiesElement.querySelector("#cancelMirror");r&&r.addEventListener("click",()=>{this.editor.toolManager.setCurrentTool("select")})}applyMirror(){if(!this.mirrorAxis&&!this.mirrorPlane)return void this.editor.showStatus("Не выбран тип отражения","error");this.clearPreview();const e=this.editor.selectedObjects.filter(e=>!this.mirrorPlane||e!==this.mirrorPlane).map(e=>e.uuid);if(0===e.length)return void this.editor.showStatus("Нет объектов для отражения","error");this.editor.clearSelection();const r={targets:e,mirrorType:this.mirrorPlane?"plane":"axis"};this.mirrorPlane?r.planeId=this.mirrorPlane.uuid:r.axis=this.mirrorAxis;const t=new ParametricOperation("mirror",r,e),i=this.editor.parametricModel.addOperation(t);this.editor.clearSelection(),i.forEach(e=>{const r=this.editor.parametricModel.objectMap.get(e);r&&(this.editor.selectedObjects.push(r),this.editor.objectsManager.highlightObject(r))}),this.editor.showStatus("Создана зеркальная копия","success"),this.cleanup(),this.editor.toolManager.setCurrentTool("select")}onKeyDown(e){return"Escape"===e.key?(this.cleanup(),this.editor.toolManager.setCurrentTool("select"),!0):"Enter"===e.key&&"confirm"===this.mirrorMode&&(this.applyMirror(),!0)}cleanup(){this.clearPlaneHighlight(),this.clearPreview(),this.planes=[],this.mirrorMode="select",this.mirrorPlane=null,this.mirrorAxis=null}canActivate(){return this.editor.selectedObjects.length>0}}