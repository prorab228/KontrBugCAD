class MirrorTool extends Tool{constructor(e){super("mirror","fa-expand-arrows-alt",e),this.requiresSelection=!0,this.mirrorPlane=null,this.mirrorAxis=null,this.propertiesElement=null,this.highlightedPlane=null,this.mirrorMode="select"}onActivate(){if(this.canActivate())return this.mirrorMode="select",this.mirrorPlane=null,this.mirrorAxis=null,this.createPropertiesSection(),document.body.style.cursor="crosshair",this.editor.showStatus("Выберите ось отражения в панели свойств ИЛИ кликните на плоскость","info"),!0;this.editor.toolManager.restorePreviousTool()}onDeactivate(){this.removePropertiesSection(),this.cleanup(),document.body.style.cursor="default"}onMouseDown(e){if(0!==e.button||!this.mirrorMode)return!1;if(this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),"select"===this.mirrorMode){const e=[...this.editor.workPlanes,...this.editor.sketchPlanes],t=this.editor.raycaster.intersectObjects(e,!0);if(t.length>0){const e=t[0].object;return this.mirrorPlane=e,this.mirrorMode="confirm",this.updateUI(),this.editor.showStatus('Плоскость выбрана. Нажмите "Применить" или Enter для отражения',"success"),!0}}return!1}onMouseMove(e){if("select"===this.mirrorMode&&!this.mirrorAxis){this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=[...this.editor.workPlanes,...this.editor.sketchPlanes],r=this.editor.raycaster.intersectObjects(t,!0);if(this.clearPlaneHighlight(),r.length>0&&!this.mirrorPlane){const e=r[0].object;this.highlightPlane(e)}}return!0}highlightPlane(e){this.clearPlaneHighlight();const t=new THREE.PlaneGeometry(50,50),r=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:.3,side:THREE.DoubleSide});this.highlightedPlane=new THREE.Mesh(t,r),this.highlightedPlane.position.copy(e.position),this.highlightedPlane.quaternion.copy(e.quaternion),this.highlightedPlane.userData.isHighlight=!0,this.highlightedPlane.renderOrder=999,this.editor.scene.add(this.highlightedPlane)}clearPlaneHighlight(){this.highlightedPlane&&(this.editor.scene.remove(this.highlightedPlane),this.highlightedPlane.geometry&&this.highlightedPlane.geometry.dispose(),this.highlightedPlane.material&&this.highlightedPlane.material.dispose(),this.highlightedPlane=null)}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","mirrorTool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="mirrorTool"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="mirror-settings">\n                <h4>ОТРАЖЕНИЕ (ЗЕРКАЛО)</h4>\n\n                <div class="property-row">\n                    <label>Выбранные объекты:</label>\n                    <div style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px;">\n                        ${this.editor.selectedObjects.length} объект(ов)\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>Тип отражения:</label>\n                    <div id="mirrorTypeInfo" style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px; min-height: 36px;">\n                        ${this.mirrorAxis?`Ось: ${this.mirrorAxis.toUpperCase()}`:this.mirrorPlane?`Плоскость: ${this.mirrorPlane.userData?.name||"Плоскость"}`:"Не выбрано"}\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>Отражение по оси:</label>\n                    <div class="axis-buttons" style="display: flex; gap: 8px;">\n                        <button class="axis-btn" data-axis="x" style="flex: 1; padding: 8px 12px; background: rgba(255, 68, 68, 0.1); color: #ff4444; border: 1px solid #ff4444; border-radius: 4px; cursor: pointer;">X</button>\n                        <button class="axis-btn" data-axis="y" style="flex: 1; padding: 8px 12px; background: rgba(68, 255, 68, 0.1); color: #44ff44; border: 1px solid #44ff44; border-radius: 4px; cursor: pointer;">Y</button>\n                        <button class="axis-btn" data-axis="z" style="flex: 1; padding: 8px 12px; background: rgba(68, 68, 255, 0.1); color: #4444ff; border: 1px solid #4444ff; border-radius: 4px; cursor: pointer;">Z</button>\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>ИЛИ выберите плоскость кликом:</label>\n                    <div style="padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 12px;">\n                        Кликните на рабочую плоскость для отражения относительно нее\n                    </div>\n                </div>\n\n                <div class="property-row">\n                    <label>Действие:</label>\n                    <div style="display: flex; gap: 8px;">\n                        <button id="applyMirror" style="flex: 1; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;" ${this.mirrorAxis||this.mirrorPlane?"":"disabled"}>\n                            <i class="fas fa-check"></i> Применить\n                        </button>\n                        <button id="cancelMirror" style="flex: 1; padding: 8px 16px; background: var(--danger-color); color: white; border: none; border-radius: 4px; cursor: pointer;">\n                            <i class="fas fa-times"></i> Отмена\n                        </button>\n                    </div>\n                </div>\n\n                <div style="margin-top: 12px; padding: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; font-size: 11px; color: var(--text-secondary);">\n                    <i class="fas fa-info-circle"></i> \n                    <div><strong>Инструкция:</strong></div>\n                    <div>1. Нажмите на кнопку оси (X, Y, Z) для отражения по оси</div>\n                    <div>2. ИЛИ кликните на рабочую плоскость для отражения относительно нее</div>\n                    <div>3. Нажмите "Применить" для выполнения</div>\n                    <div>4. Используйте ESC или кнопку "Отмена" для отмены</div>\n                </div>\n            </div>\n        `}updateUI(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#mirrorTypeInfo"),t=this.propertiesElement.querySelector("#applyMirror"),r=this.propertiesElement.querySelectorAll(".axis-btn");e&&(e.textContent=this.mirrorAxis?`Ось: ${this.mirrorAxis.toUpperCase()}`:this.mirrorPlane?`Плоскость: ${this.mirrorPlane.userData?.name||"Плоскость"}`:"Не выбрано"),t&&(t.disabled=!(this.mirrorAxis||this.mirrorPlane),t.style.opacity=this.mirrorAxis||this.mirrorPlane?"1":"0.5"),r&&r.forEach(e=>{e.dataset.axis===this.mirrorAxis?(e.style.background="x"===e.dataset.axis?"#ff4444":"y"===e.dataset.axis?"#44ff44":"#4444ff",e.style.color="white"):(e.style.background="x"===e.dataset.axis?"rgba(255, 68, 68, 0.1)":"y"===e.dataset.axis?"rgba(68, 255, 68, 0.1)":"rgba(68, 68, 255, 0.1)",e.style.color="x"===e.dataset.axis?"#ff4444":"y"===e.dataset.axis?"#44ff44":"#4444ff")})}bindPropertiesEvents(){if(!this.propertiesElement)return;this.propertiesElement.querySelectorAll(".axis-btn").forEach(e=>{e.addEventListener("click",()=>{this.mirrorAxis=e.dataset.axis,this.mirrorPlane=null,this.mirrorMode="confirm",this.clearPlaneHighlight(),this.updateUI(),this.editor.showStatus(`Выбрана ось отражения: ${this.mirrorAxis.toUpperCase()}`,"success")})});const e=this.propertiesElement.querySelector("#applyMirror");e&&e.addEventListener("click",()=>{this.applyMirror()});const t=this.propertiesElement.querySelector("#cancelMirror");t&&t.addEventListener("click",()=>{this.editor.toolManager.setCurrentTool("select")})}applyMirror(){this.mirrorAxis||this.mirrorPlane?this.mirrorPlane?this.applyMirrorRelativeToPlane():this.applyMirrorByAxis():this.editor.showStatus("Не выбран тип отражения","error")}applyMirrorByAxis(){const e=[...this.editor.selectedObjects];if(0===e.length)return void this.editor.showStatus("Нет объектов для отражения","error");this.unhighlightAllObjects();const t=[];e.forEach(e=>{const r=this.createMirroredObject(e);r&&(this.addObjectToScene(r),t.push(r))}),this.highlightOriginalObjects(),0!==t.length?(this.editor.clearSelection(),t.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),t.forEach(e=>{this.editor.history.addAction({type:"create",object:e.uuid})}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Создана зеркальная копия по оси ${this.mirrorAxis.toUpperCase()}`,"success"),this.cleanup(),this.editor.toolManager.setCurrentTool("select")):this.editor.showStatus("Не удалось создать зеркальные копии","error")}applyMirrorRelativeToPlane(){if(!this.mirrorPlane)return void this.editor.showStatus("Не выбрана рабочая плоскость","error");const e=this.editor.selectedObjects.filter(e=>e!==this.mirrorPlane);if(0===e.length)return void this.editor.showStatus("Нет объектов для отражения","error");this.unhighlightAllObjects();const t=this.mirrorPlane,r=[];e.forEach(e=>{const i=e.clone(!0);this.reflectObjectRelativeToPlane(i,t),i.material=this.createMaterialFromOriginal(e),this.setupUserData(i,e,!0),this.addObjectToScene(i),r.push(i)}),this.highlightOriginalObjects(),this.editor.clearSelection(),r.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),r.forEach(e=>{this.editor.history.addAction({type:"create",object:e.uuid})}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus("Создана зеркальная копия относительно рабочей плоскости","success"),this.cleanup(),this.editor.toolManager.setCurrentTool("select")}unhighlightAllObjects(){this.editor.selectedObjects.forEach(e=>{this.editor.objectsManager.unhighlightObject(e)})}highlightOriginalObjects(){this.editor.selectedObjects.forEach(e=>{this.editor.objectsManager.highlightObject(e)})}createMirroredObject(e){const t=e.clone(!0),r=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;r.getCenter(i);const o=e.position.clone().sub(i);switch(this.mirrorAxis){case"x":o.x=-o.x,this.reflectGeometry(t,"x"),this.reflectRotation(t,"x");break;case"y":o.y=-o.y,this.reflectGeometry(t,"y"),this.reflectRotation(t,"y");break;case"z":o.z=-o.z,this.reflectGeometry(t,"z"),this.reflectRotation(t,"z")}return t.position.copy(i).add(o),t.material=this.createMaterialFromOriginal(e),this.setupUserData(t,e,!1),t}reflectGeometry(e,t){if(!e.geometry)return;const r=e.geometry.clone(),i=r.attributes.position.array;for(let e=0;e<i.length;e+=3)switch(t){case"x":i[e]=-i[e];break;case"y":i[e+1]=-i[e+1];break;case"z":i[e+2]=-i[e+2]}if(r.attributes.position.needsUpdate=!0,r.computeVertexNormals(),r.index){const e=r.index.array;for(let t=0;t<e.length;t+=3){const r=e[t];e[t]=e[t+1],e[t+1]=r}r.index.needsUpdate=!0}e.geometry=r}reflectObjectRelativeToPlane(e,t){const r=new THREE.Vector3(0,0,1);r.applyQuaternion(t.quaternion).normalize();const i=t.position.clone(),o=e.position.clone().sub(i).dot(r),s=r.clone().multiplyScalar(-2*o);e.position.add(s),this.reflectGeometryByPlane(e,r)}reflectGeometryByPlane(e,t){if(!e.geometry)return;const r=e.geometry.clone(),i=r.attributes.position.array;for(let e=0;e<i.length;e+=3){const r=new THREE.Vector3(i[e],i[e+1],i[e+2]),o=r.dot(t);r.x-=2*o*t.x,r.y-=2*o*t.y,r.z-=2*o*t.z,i[e]=r.x,i[e+1]=r.y,i[e+2]=r.z}if(r.attributes.position.needsUpdate=!0,r.computeVertexNormals(),r.index){const e=r.index.array;for(let t=0;t<e.length;t+=3){const r=e[t];e[t]=e[t+1],e[t+1]=r}r.index.needsUpdate=!0}e.geometry=r}reflectRotation(e,t){const r=new THREE.Quaternion;switch(t){case"x":r.setFromEuler(new THREE.Euler(0,Math.PI,Math.PI));break;case"y":r.setFromEuler(new THREE.Euler(Math.PI,0,Math.PI));break;case"z":r.setFromEuler(new THREE.Euler(Math.PI,Math.PI,0))}e.quaternion.multiply(r),e.quaternion.normalize()}createMaterialFromOriginal(e){let t=null;if(e.userData&&e.userData.originalMaterial)try{t=e.userData.originalMaterial.clone()}catch(e){console.warn("Не удалось клонировать оригинальный материал из userData:",e),t=null}if(!t&&e.material)try{t=e.material.clone()}catch(e){console.warn("Не удалось клонировать текущий материал:",e),t=null}return t||(t=new THREE.MeshPhongMaterial({color:8421504,side:THREE.FrontSide,shininess:30,specular:new THREE.Color(1118481)})),t.color||(t.color=new THREE.Color(8421504)),t.color instanceof THREE.Color||("number"==typeof t.color?t.color=new THREE.Color(t.color):t.color.getHex?t.color=new THREE.Color(t.color.getHex()):t.color=new THREE.Color(8421504)),t.side=THREE.FrontSide,t.needsUpdate=!0,t}setupUserData(e,t,r){const i={};if(t.userData)for(const e in t.userData)if(t.userData.hasOwnProperty(e)){const r=t.userData[e];(null===r||"boolean"==typeof r||"number"==typeof r||"string"==typeof r||Array.isArray(r))&&(i[e]=r)}i.name=`${t.userData?.name||"Объект"} (зеркало)`,i.createdAt=(new Date).toISOString(),i.isMirrored=!0,i.originalObject=t.uuid,r?(i.mirrorType="plane",i.mirrorPlaneId=this.mirrorPlane.uuid):(i.mirrorType="axis",i.mirrorAxis=this.mirrorAxis),t.userData?.type?i.type=t.userData.type:i.type="mirrored",t.userData&&t.userData.originalMaterial?i.originalMaterial=t.userData.originalMaterial.clone():t.material&&(i.originalMaterial=t.material.clone()),e.userData=i}addObjectToScene(e){this.editor.objectsGroup.add(e),this.editor.objects.push(e),e.updateMatrixWorld(!0),e.visible=!0,e.castShadow=!0,e.receiveShadow=!0,e.geometry&&(e.geometry.computeBoundingBox(),e.geometry.computeBoundingSphere())}onKeyDown(e){return"Escape"===e.key?(this.cleanup(),this.editor.toolManager.setCurrentTool("select"),!0):"Enter"===e.key&&"confirm"===this.mirrorMode&&(this.applyMirror(),!0)}cleanup(){this.clearPlaneHighlight(),this.mirrorMode="select",this.mirrorPlane=null,this.mirrorAxis=null}canActivate(){return this.editor.selectedObjects.length>0}}