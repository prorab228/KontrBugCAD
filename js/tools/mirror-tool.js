class MirrorTool extends Tool{constructor(e){super("mirror","fa-expand-arrows-alt",e),this.requiresSelection=!0,this.mirrorPlane=null,this.mirrorAxis=null,this.modal=null,this.isModalActive=!1,this.initModal()}initModal(){this.modal=document.createElement("div"),this.modal.className="mirror-tool-modal",this.modal.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.5);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n            opacity: 0;\n            visibility: hidden;\n            transition: opacity 0.3s;\n        ",this.modal.innerHTML='\n            <div style="\n                background: var(--bg-surface, #2d2d2d);\n                border-radius: 8px;\n                width: 320px;\n                max-width: 90%;\n                border: 1px solid var(--border-color, #404040);\n                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n            ">\n                <div style="\n                    padding: 12px 16px;\n                    border-bottom: 1px solid var(--border-color, #404040);\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                ">\n                    <h3 style="margin: 0; font-size: 15px; color: var(--text-primary, #fff);">\n                        <i class="fas fa-expand-arrows-alt" style="color: var(--primary-color, #2196f3); margin-right: 6px;"></i>\n                        Отражение (зеркало)\n                    </h3>\n\n                </div>\n\n                <div style="padding: 16px;">\n                    <div style="margin-bottom: 15px;">\n                        <h4 style="margin: 0 0 8px 0; color: var(--text-primary, #fff); font-size: 13px;">\n                            Выберите ось отражения\n                        </h4>\n                        <p style="margin: 0 0 15px 0; color: var(--text-secondary, #aaa); font-size: 12px;">\n                            Будет создана зеркальная копия объекта\n                        </p>\n\n                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">\n                            <button class="axis-btn" data-axis="x" style="\n                                flex: 1;\n                                padding: 10px 6px;\n                                border: 2px solid #ff4444;\n                                background: rgba(255, 68, 68, 0.1);\n                                border-radius: 6px;\n                                cursor: pointer;\n                                transition: all 0.2s;\n                                display: flex;\n                                flex-direction: column;\n                                align-items: center;\n                                gap: 4px;\n                                color: #ff4444;\n                            ">\n                                <i class="fas fa-arrows-alt-h" style="font-size: 16px;"></i>\n                                <span style="font-weight: 500; font-size: 12px;">Ось X</span>\n                            </button>\n                            <button class="axis-btn" data-axis="y" style="\n                                flex: 1;\n                                padding: 10px 6px;\n                                border: 2px solid #44ff44;\n                                background: rgba(68, 255, 68, 0.1);\n                                border-radius: 6px;\n                                cursor: pointer;\n                                transition: all 0.2s;\n                                display: flex;\n                                flex-direction: column;\n                                align-items: center;\n                                gap: 4px;\n                                color: #44ff44;\n                            ">\n                                <i class="fas fa-arrows-alt-v" style="font-size: 16px;"></i>\n                                <span style="font-weight: 500; font-size: 12px;">Ось Y</span>\n                            </button>\n                            <button class="axis-btn" data-axis="z" style="\n                                flex: 1;\n                                padding: 10px 6px;\n                                border: 2px solid #4444ff;\n                                background: rgba(68, 68, 255, 0.1);\n                                border-radius: 6px;\n                                cursor: pointer;\n                                transition: all 0.2s;\n                                display: flex;\n                                flex-direction: column;\n                                align-items: center;\n                                gap: 4px;\n                                color: #4444ff;\n                            ">\n                                <i class="fas fa-arrows-alt" style="font-size: 16px;"></i>\n                                <span style="font-weight: 500; font-size: 12px;">Ось Z</span>\n                            </button>\n                        </div>\n\n                        <div style="border-top: 1px solid var(--border-color, #404040); padding-top: 12px;">\n                            <p style="margin: 0; font-size: 11px; color: var(--text-secondary, #aaa); font-style: italic;">\n                                Объект будет отражен относительно центра выделения\n                            </p>\n                        </div>\n                    </div>\n                </div>\n\n                <div style="\n                    padding: 12px 16px;\n                    border-top: 1px solid var(--border-color, #404040);\n                    text-align: center;\n                ">\n                    <button class="cancel-btn btn-secondary" >Отмена</button>\n                </div>\n            </div>\n        ',document.body.appendChild(this.modal),this.setupModalEvents()}setupModalEvents(){this.modal.querySelectorAll(".axis-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.axis;this.mirrorAxis=t,this.applyMirror(),this.closeModal()})}),this.modal.querySelector(".cancel-btn").addEventListener("click",()=>{this.closeModal(),this.editor.toolManager.setCurrentTool("select")}),this.modal.addEventListener("click",e=>{e.target===this.modal&&(this.closeModal(),this.editor.toolManager.setCurrentTool("select"))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isModalActive&&(this.closeModal(),this.editor.toolManager.setCurrentTool("select"))})}onActivate(){if(this.canActivate())return this.mirrorPlane=this.findWorkPlaneInSelection(),this.mirrorPlane?this.applyMirrorRelativeToPlane():this.showModal(),!0;this.editor.toolManager.restorePreviousTool()}onDeactivate(){this.cleanup(),this.closeModal()}findWorkPlaneInSelection(){return this.editor.selectedObjects.find(e=>"work_plane"===e.userData?.type||"sketch_plane"===e.userData?.type)}showModal(){this.isModalActive=!0,this.modal.style.opacity="1",this.modal.style.visibility="visible",this.editor.showStatus("Выберите ось для отражения","info")}closeModal(){this.isModalActive=!1,this.modal.style.opacity="0",this.modal.style.visibility="hidden"}applyMirror(){const e=this.mirrorPlane?this.editor.selectedObjects.filter(e=>e!==this.mirrorPlane):[...this.editor.selectedObjects];if(0===e.length)return this.editor.showStatus("Нет объектов для отражения","error"),void this.editor.toolManager.setCurrentTool("select");const t=[];if(e.forEach(e=>{const r=this.createMirroredObject(e);r&&(this.addObjectToScene(r),t.push(r))}),0===t.length)return this.editor.showStatus("Не удалось создать зеркальные копии","error"),void this.editor.toolManager.setCurrentTool("select");this.editor.clearSelection(),t.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),t.forEach(e=>{this.editor.history.addAction({type:"create",object:e.uuid})}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus(`Создана зеркальная копия по оси ${this.mirrorAxis.toUpperCase()}`,"success"),this.cleanup(),this.editor.toolManager.setCurrentTool("select")}applyMirrorRelativeToPlane(){const e=this.editor.selectedObjects.filter(e=>e!==this.mirrorPlane);if(0===e.length)return this.editor.showStatus("Нет объектов для отражения","error"),void this.editor.toolManager.setCurrentTool("select");const t=this.mirrorPlane,r=[];e.forEach(e=>{const o=e.clone(!0);this.reflectObjectRelativeToPlane(o,t),o.material=this.createMaterialFromOriginal(e),this.setupUserData(o,e,!0),this.addObjectToScene(o),r.push(o)}),this.editor.clearSelection(),r.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),r.forEach(e=>{this.editor.history.addAction({type:"create",object:e.uuid})}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.showStatus("Создана зеркальная копия относительно рабочей плоскости","success"),this.cleanup(),this.editor.toolManager.setCurrentTool("select")}reflectObjectRelativeToPlane(e,t){const r=new THREE.Vector3(0,0,1);r.applyQuaternion(t.quaternion).normalize();const o=t.position.clone(),i=e.position.clone().sub(o).dot(r),n=r.clone().multiplyScalar(-2*i);e.position.add(n),this.reflectGeometryByPlane(e,r)}createMirroredObject(e){const t=e.clone(!0),r=(new THREE.Box3).setFromObject(e),o=new THREE.Vector3;r.getCenter(o);const i=e.position.clone().sub(o);switch(this.mirrorAxis){case"x":i.x=-i.x,this.reflectGeometry(t,"x"),this.reflectRotation(t,"x");break;case"y":i.y=-i.y,this.reflectGeometry(t,"y"),this.reflectRotation(t,"y");break;case"z":i.z=-i.z,this.reflectGeometry(t,"z"),this.reflectRotation(t,"z")}return t.position.copy(o).add(i),t.material=this.createMaterialFromOriginal(e),this.setupUserData(t,e,!1),t}reflectGeometry(e,t){if(!e.geometry)return;const r=e.geometry.clone(),o=r.attributes.position.array;for(let e=0;e<o.length;e+=3)switch(t){case"x":o[e]=-o[e];break;case"y":o[e+1]=-o[e+1];break;case"z":o[e+2]=-o[e+2]}if(r.attributes.position.needsUpdate=!0,r.computeVertexNormals(),r.index){const e=r.index.array;for(let t=0;t<e.length;t+=3){const r=e[t];e[t]=e[t+1],e[t+1]=r}r.index.needsUpdate=!0}e.geometry=r}reflectGeometryByPlane(e,t){if(!e.geometry)return;const r=e.geometry.clone(),o=r.attributes.position.array;for(let e=0;e<o.length;e+=3){const r=new THREE.Vector3(o[e],o[e+1],o[e+2]),i=r.dot(t);r.x-=2*i*t.x,r.y-=2*i*t.y,r.z-=2*i*t.z,o[e]=r.x,o[e+1]=r.y,o[e+2]=r.z}if(r.attributes.position.needsUpdate=!0,r.computeVertexNormals(),r.index){const e=r.index.array;for(let t=0;t<e.length;t+=3){const r=e[t];e[t]=e[t+1],e[t+1]=r}r.index.needsUpdate=!0}e.geometry=r}reflectRotation(e,t){const r=new THREE.Quaternion;switch(t){case"x":r.setFromEuler(new THREE.Euler(0,Math.PI,Math.PI));break;case"y":r.setFromEuler(new THREE.Euler(Math.PI,0,Math.PI));break;case"z":r.setFromEuler(new THREE.Euler(Math.PI,Math.PI,0))}e.quaternion.multiply(r),e.quaternion.normalize()}createMaterialFromOriginal(e){let t=null;if(e.userData&&e.userData.originalMaterial)try{t=e.userData.originalMaterial.clone()}catch(e){console.warn("Не удалось клонировать оригинальный материал из userData:",e),t=null}if(!t&&e.material)try{t=e.material.clone()}catch(e){console.warn("Не удалось клонировать текущий материал:",e),t=null}return t||(t=new THREE.MeshPhongMaterial({color:8421504,side:THREE.FrontSide,shininess:30,specular:new THREE.Color(1118481)})),t.color||(t.color=new THREE.Color(8421504)),t.color instanceof THREE.Color||("number"==typeof t.color?t.color=new THREE.Color(t.color):t.color.getHex?t.color=new THREE.Color(t.color.getHex()):t.color=new THREE.Color(8421504)),t.side=THREE.FrontSide,t.needsUpdate=!0,t}setupUserData(e,t,r){const o={};if(t.userData)for(const e in t.userData)if(t.userData.hasOwnProperty(e)){const r=t.userData[e];(null===r||"boolean"==typeof r||"number"==typeof r||"string"==typeof r||Array.isArray(r))&&(o[e]=r)}o.name=`${t.userData?.name||"Объект"} (зеркало)`,o.createdAt=(new Date).toISOString(),o.isMirrored=!0,o.originalObject=t.uuid,r?(o.mirrorType="plane",o.mirrorPlaneId=this.mirrorPlane.uuid):(o.mirrorType="axis",o.mirrorAxis=this.mirrorAxis),t.userData?.type?o.type=t.userData.type:o.type="mirrored",t.userData&&t.userData.originalMaterial?o.originalMaterial=t.userData.originalMaterial.clone():t.material&&(o.originalMaterial=t.material.clone()),e.userData=o}addObjectToScene(e){this.editor.objectsGroup.add(e),this.editor.objects.push(e),e.updateMatrixWorld(!0),e.visible=!0,e.castShadow=!0,e.receiveShadow=!0,e.geometry&&(e.geometry.computeBoundingBox(),e.geometry.computeBoundingSphere())}cleanup(){this.closeModal(),this.mirrorPlane=null,this.mirrorAxis=null}canActivate(){return this.editor.selectedObjects.length>0}}