class GroupTool extends Tool{constructor(t){super("group","fa-object-group",t),this.requiresSelection=!0,this.minObjects=2}onActivate(){if(this.canActivate()){if(this.editor.selectedObjects.length<this.minObjects)return this.editor.showStatus(`Для группировки нужно выбрать минимум ${this.minObjects} объекта`,"error"),void this.editor.toolManager.restorePreviousTool();this.performGrouping(),setTimeout(()=>{this.editor.toolManager.restorePreviousTool()},100)}else this.editor.toolManager.restorePreviousTool()}performGrouping(){const t=this.editor.selectedObjects.slice().filter(t=>"group"!==t.userData?.type||(this.editor.showStatus("Объекты групп не могут быть сгруппированы","warning"),!1));if(t.length<2)return void this.editor.showStatus("Недостаточно объектов для группировки","error");const e=t.map(t=>{const e=new THREE.Vector3;return t.getWorldPosition(e),{object:t,worldPosition:e.clone(),originalParent:t.parent}}),o=new THREE.Vector3;e.forEach(t=>{o.add(t.worldPosition)}),o.divideScalar(e.length);const r=new THREE.Group;r.name=`Group_${Date.now()}`,r.position.copy(o),e.forEach(t=>{const e=t.object,i=t.worldPosition.clone().sub(o);e.parent&&e.parent.remove(e),r.add(e),e.position.copy(i)}),r.userData.type="group",r.userData.id=`group_${Date.now()}`,r.userData.name=`Группа (${t.length} объектов)`,r.userData.createdAt=(new Date).toISOString(),r.userData.childCount=t.length,r.userData.isGroup=!0,r.userData.expanded=!0,r.userData.originalObjects=e.map(t=>({uuid:t.object.uuid,worldPosition:t.worldPosition.toArray(),parentUuid:t.originalParent?t.originalParent.uuid:null})),r.updateMatrixWorld(!0),t.forEach(t=>{const e=this.editor.objects.indexOf(t);e>-1&&this.editor.objects.splice(e,1)}),this.editor.objectsGroup.add(r),this.editor.objects.push(r),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(r),this.addToHistory(t,r),this.editor.clearSelection(),this.editor.selectSingleObject(r),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),this.editor.showStatus(`Объекты сгруппированы (${t.length} шт.)`,"success")}addToHistory(t,e){const o=t.map(t=>{t.updateMatrixWorld(!0);const e=t.matrixWorld.clone(),o=t.clone(),r=new THREE.Vector3,i=new THREE.Quaternion,s=new THREE.Vector3;return e.decompose(r,i,s),o.position.copy(r),o.quaternion.copy(i),o.scale.copy(s),o.userData={...t.userData},{uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(o),parentUuid:t.parent?t.parent.uuid:null}}),r=this.editor.projectManager.serializeObjectForHistory(e),i={type:"group",groupUuid:e.uuid,groupData:r,originalObjects:o,timestamp:(new Date).toISOString()};this.editor.history.addAction(i)}onDeactivate(){}}