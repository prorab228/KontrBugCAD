class RepairTool extends Tool{constructor(e){super("repair","fa-tools",e),this.requiresSelection=!0}onActivate(){this.canActivate()?this.showConfirmationDialog():this.editor.toolManager.restorePreviousTool()}showConfirmationDialog(){const e=document.createElement("div");e.className="modal-overlay active",e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.7);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        ",e.innerHTML=`\n            <div class="modal-content" style="\n                background: white;\n                padding: 20px;\n                border-radius: 8px;\n                min-width: 300px;\n                max-width: 400px;\n                box-shadow: 0 5px 15px rgba(0,0,0,0.3);\n            ">\n                <h3 style="margin-top: 0;">Ремонт геометрии</h3>\n                <div style="margin: 20px 0;">\n                    <p>Будет выполнена проверка и исправление геометрии для ${this.editor.selectedObjects.length} выбранных объектов.</p>\n                    <p style="font-size: 12px; color: #666; margin-top: 10px;">\n                        Проверка включает: исправление NaN, удаление дублирующихся вершин,\n                        удаление вырожденных треугольников.\n                    </p>\n                </div>\n                <div style="display: flex; justify-content: flex-end; gap: 10px;">\n                    <button id="cancelRepair" style="\n                        padding: 8px 16px;\n                        background: #f0f0f0;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                    ">Отмена</button>\n                    <button id="applyRepair" style="\n                        padding: 8px 16px;\n                        background: #2196F3;\n                        color: white;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                    ">Применить</button>\n                </div>\n            </div>\n        `,document.body.appendChild(e),document.getElementById("cancelRepair").addEventListener("click",()=>{document.body.removeChild(e),this.editor.toolManager.restorePreviousTool()}),document.getElementById("applyRepair").addEventListener("click",()=>{document.body.removeChild(e),this.performRepair()})}async performRepair(){this.showLoadingIndicator("Ремонт геометрии...");try{let e=0,t=0,n=0;const o=[],r=[];for(const i of this.editor.selectedObjects)if(console.log(`Обработка объекта: ${i.uuid}, тип: ${i.type||"unknown"}`),this.canRepairObject(i))try{if(!this.hasGeometryIssues(i.geometry)){console.log(`Геометрия объекта ${i.uuid} не требует ремонта`),t++;continue}const s=this.cloneAndRepairObject(i);s?(o.push(i),r.push(s),e++):n++}catch(e){console.error(`Ошибка при ремонте объекта ${i.uuid}:`,e),n++}else console.log(`Пропуск объекта ${i.uuid}: неподдерживаемый тип или отсутствие геометрии`),t++;o.length>0&&this.applyRepairChanges(o,r),this.hideLoadingIndicator();let i="";e>0&&(i+=`Отремонтировано: ${e} объектов. `),t>0&&(i+=`Пропущено: ${t} объектов. `),n>0&&(i+=`Ошибок: ${n}. `),i&&(this.editor.showStatus(i,e>0?"success":"info"),this.editor.objectsManager.updateSceneStats())}catch(e){this.hideLoadingIndicator(),console.error("Общая ошибка ремонта:",e),this.editor.showStatus(`Ошибка ремонта: ${e.message}`,"error")}this.editor.toolManager.restorePreviousTool()}canRepairObject(e){if(!e||!e.isObject3D)return console.log("Объект не является Object3D"),!1;if(!e.geometry)return console.log("У объекта нет геометрии"),!1;if(!e.geometry.isBufferGeometry)return console.log("Геометрия не BufferGeometry"),!1;if(!e.geometry.attributes.position)return console.log("Нет атрибута position"),!1;const t=e.geometry.attributes.position.count;return!(t<3)||(console.log(`Слишком мало вершин: ${t}`),!1)}hasGeometryIssues(e){try{const t=e.attributes.position.array;for(let e=0;e<t.length;e++)if(isNaN(t[e])||!isFinite(t[e]))return console.log("Обнаружены NaN в позициях"),!0;if(e.index){const t=e.index.array;let n=0;for(let e=0;e<t.length;e+=3){const o=t[e],r=t[e+1],i=t[e+2];o!==r&&o!==i&&r!==i||n++}if(n>0)return console.log(`Обнаружено вырожденных треугольников: ${n}`),!0}try{if(e.computeBoundingBox(),!e.boundingBox||isNaN(e.boundingBox.min.x)||isNaN(e.boundingBox.max.x))return console.log("Некорректный bounding box"),!0}catch(e){return console.log("Ошибка при вычислении bounding box:",e),!0}return!1}catch(e){return console.log("Ошибка проверки геометрии:",e),!0}}cloneAndRepairObject(e){try{console.log(`Клонирование и ремонт объекта: ${e.uuid}`);const t=e.clone();t.uuid=THREE.MathUtils.generateUUID();const n=t.geometry;return this.fixNaNValues(n),this.mergeVertices(n,.001),this.removeDegenerateTriangles(n),n.attributes.normal||n.computeVertexNormals(),n.attributes.uv||this.createSimpleUVs(n),n.computeBoundingBox(),n.computeBoundingSphere(),e.userData&&(t.userData=JSON.parse(JSON.stringify(e.userData))),t.position.copy(e.position),t.rotation.copy(e.rotation),t.scale.copy(e.scale),e.material&&(t.material=e.material),console.log(`Успешно отремонтирован объект: ${t.uuid}`),t}catch(e){return console.error("Ошибка клонирования и ремонта:",e),null}}fixNaNValues(e){let t=!1;for(const n in e.attributes){const o=e.attributes[n],r=o.array;for(let e=0;e<r.length;e++)!isNaN(r[e])&&isFinite(r[e])||(r[e]=0,t=!0);t&&(o.needsUpdate=!0)}return t}mergeVertices(e,t=.001){if(!e.attributes.position)return!1;const n=e.attributes.position,o=n.count,r=new Map,i=[],s=new Array(o);for(let e=0;e<o;e++){const o=n.getX(e),a=n.getY(e),c=n.getZ(e),l=`${Math.round(o/t)},${Math.round(a/t)},${Math.round(c/t)}`;r.has(l)||(r.set(l,i.length),i.push({x:o,y:a,z:c,originalIndex:e})),s[e]=r.get(l)}return i.length!==o&&(console.log(`Объединение вершин: ${o} → ${i.length}`),this.rebuildGeometryWithUniqueVertices(e,i,s),!0)}rebuildGeometryWithUniqueVertices(e,t,n){const o=new Float32Array(3*t.length);if(t.forEach((e,t)=>{o[3*t]=e.x,o[3*t+1]=e.y,o[3*t+2]=e.z}),e.setAttribute("position",new THREE.BufferAttribute(o,3)),this.updateOtherAttributes(e,t,n),e.index){const t=e.index.array,o=new Uint32Array(t.length);for(let e=0;e<t.length;e++)o[e]=n[t[e]];e.setIndex(new THREE.BufferAttribute(o,1))}}updateOtherAttributes(e,t,n){if(e.attributes.normal){const n=e.attributes.normal,o=new Float32Array(3*t.length);for(let e=0;e<t.length;e++){const r=t[e].originalIndex;o[3*e]=n.getX(r),o[3*e+1]=n.getY(r),o[3*e+2]=n.getZ(r)}e.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(e.attributes.uv){const n=e.attributes.uv,o=new Float32Array(2*t.length);for(let e=0;e<t.length;e++){const r=t[e].originalIndex;o[2*e]=n.getX(r),o[2*e+1]=n.getY(r)}e.setAttribute("uv",new THREE.BufferAttribute(o,2))}}removeDegenerateTriangles(e){if(!e.index)return!1;const t=e.index.array,n=[];let o=0;for(let e=0;e<t.length;e+=3){const r=t[e],i=t[e+1],s=t[e+2];r!==i&&r!==s&&i!==s?n.push(r,i,s):o++}return o>0&&(console.log(`Удалено вырожденных треугольников: ${o}`),e.setIndex(new THREE.BufferAttribute(new Uint32Array(n),1)),!0)}createSimpleUVs(e){if(!e.attributes.position)return;const t=e.attributes.position,n=t.count,o=new Float32Array(2*n);e.computeBoundingBox();const r=e.boundingBox,i=new THREE.Vector3;r.getSize(i);for(let e=0;e<n;e++){const n=t.getX(e),s=t.getY(e),a=i.x>0?(n-r.min.x)/i.x:0,c=i.y>0?(s-r.min.y)/i.y:0;o[2*e]=isNaN(a)?0:a,o[2*e+1]=isNaN(c)?0:c}e.setAttribute("uv",new THREE.BufferAttribute(o,2))}applyRepairChanges(e,t){const n={type:"delete",objects:e.map(e=>({uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)}))},o={type:"create",objects:t.map(e=>({uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)}))};e.forEach(e=>{this.editor.removeObject(e)}),t.forEach(e=>{this.editor.addObject(e)});const r={type:"modify",deletedObjects:n.objects,createdObjects:o.objects,timestamp:(new Date).toISOString(),description:`Ремонт геометрии (${e.length} объектов)`};this.editor.historyManager.addAction(r),this.editor.clearSelection(),t.forEach(e=>{this.editor.selectObject(e,!0)})}showLoadingIndicator(e){const t=document.createElement("div");t.id="repairLoadingIndicator",t.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 20px 30px;\n            border-radius: 8px;\n            z-index: 10001;\n            font-size: 16px;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        ",t.innerHTML=`\n            <i class="fas fa-spinner fa-spin"></i>\n            <span>${e}</span>\n        `,document.body.appendChild(t)}hideLoadingIndicator(){const e=document.getElementById("repairLoadingIndicator");e&&document.body.removeChild(e)}}