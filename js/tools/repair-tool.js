import*as THREE from"three";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{Tool}from"./tool.js";export class RepairTool extends Tool{constructor(e){super("repair","fa-tools",e),this.requiresSelection=!0,this.fixOpenEdges=!0,this.removeIsolated=!0,this.createUVs=!1,this.removeSmallComponents=!0,this.minComponentSize=10,this.propertiesElement=null}onActivate(){if(this.canActivate()){if(0===this.editor.selectedObjects.length)return this.editor.showStatus("Нет выбранных объектов для ремонта","error"),void this.editor.toolManager.restorePreviousTool();this.createPropertiesSection(),this.editor.showStatus('Выберите параметры ремонта и нажмите "Применить"',"info")}else this.editor.toolManager.restorePreviousTool()}onDeactivate(){this.removePropertiesSection()}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","repair"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="repair"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="repair-settings">\n                <h4><i class="fas fa-tools"></i> РЕМОНТ ГЕОМЕТРИИ</h4>\n                <p style="margin-bottom: 10px; font-size: 12px; color: #888;">\n                    Объектов для ремонта: ${this.editor.selectedObjects.length}\n                </p>\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="fixOpenEdges" ${this.fixOpenEdges?"checked":""}>\n                        <span>Закрывать открытые грани (исправляет дыры)</span>\n                    </label>\n                </div>\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="removeIsolated" ${this.removeIsolated?"checked":""}>\n                        <span>Удалять изолированные вершины (очистка)</span>\n                    </label>\n                </div>\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="removeSmallComponents" ${this.removeSmallComponents?"checked":""}>\n                        <span>Удалять мелкие компоненты (менее 10 треугольников)</span>\n                    </label>\n                </div>\n                <div class="property-row">\n                    <label>\n                        <input type="checkbox" id="createUVs" ${this.createUVs?"checked":""}>\n                        <span>Создавать UV-координаты (для текстурирования)</span>\n                    </label>\n                </div>\n                <div class="property-buttons">\n                    <button id="applyRepairBtn" class="btn-primary" style="flex: 1;">\n                        <i class="fas fa-check"></i> Применить\n                    </button>\n                    <button id="cancelRepairBtn" class="btn-secondary">\n                        <i class="fas fa-times"></i> Отмена\n                    </button>\n                </div>\n                <div class="property-hint">\n                    <p><i class="fas fa-info-circle"></i> Будут созданы новые объекты с исправленной геометрией. Исходные объекты будут удалены.</p>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#fixOpenEdges"),t=this.propertiesElement.querySelector("#removeIsolated"),r=this.propertiesElement.querySelector("#removeSmallComponents"),s=this.propertiesElement.querySelector("#createUVs");e&&e.addEventListener("change",e=>{this.fixOpenEdges=e.target.checked}),t&&t.addEventListener("change",e=>{this.removeIsolated=e.target.checked}),r&&r.addEventListener("change",e=>{this.removeSmallComponents=e.target.checked}),s&&s.addEventListener("change",e=>{this.createUVs=e.target.checked});const i=this.propertiesElement.querySelector("#applyRepairBtn");i&&i.addEventListener("click",()=>this.applyRepair());const o=this.propertiesElement.querySelector("#cancelRepairBtn");o&&o.addEventListener("click",()=>{this.editor.toolManager.restorePreviousTool()})}applyRepair(){if(0===this.editor.selectedObjects.length)return void this.editor.showStatus("Нет выбранных объектов","warning");const e=this.editor.selectedObjects.map(e=>e.uuid),t={targets:e,fixOpenEdges:this.fixOpenEdges,removeIsolated:this.removeIsolated,removeSmallComponents:this.removeSmallComponents,createUVs:this.createUVs},r=new ParametricOperation("repair",t,e),s=this.editor.parametricModel.addOperation(r);this.editor.clearSelection(),s.forEach(e=>{const t=this.editor.parametricModel.objectMap.get(e);t&&(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.editor.showStatus("Ремонт завершён","success"),this.editor.toolManager.setCurrentTool("select")}}