import*as THREE from"three";import{TextGeometry}from"three/addons/geometries/TextGeometry.js";import{FontLoader}from"three/addons/loaders/FontLoader.js";import{ParametricOperation}from"/js/core/parametric/ParametricOperation.js";import{TTFConverter}from"/js/utils/font-converter.js";import{Tool}from"./tool.js";export class Text3DTool extends Tool{constructor(e){super("text3dTool","fa-font",e),this.text="КонтрБагCAD",this.fontSize=25,this.depth=2,this.fontColor=63571,this.materialType="standard",this.bevelEnabled=!1,this.bevelThickness=1,this.bevelSize=1,this.curveSegments=12,this.conversionQuality="medium",this.currentTextMesh=null,this.tempText=null,this.isPlacing=!1,this.textMaterials={standard:new THREE.MeshStandardMaterial({color:this.fontColor,roughness:.7,metalness:.2}),basic:new THREE.MeshBasicMaterial({color:this.fontColor}),phong:new THREE.MeshPhongMaterial({color:this.fontColor,shininess:100})},this.ttfConverter=new TTFConverter,this.currentFont="Roboto"}onActivate(){this.clear(),this.createPropertiesSection(),document.body.style.cursor="crosshair",this.editor.showStatus("3D Текст: кликните для размещения текста (ESC - отмена)","info")}onDeactivate(){this.clear(),this.removePropertiesSection(),document.body.style.cursor="default",this.clearTempText()}async loadTTFFont(e){if(e&&e.name.toLowerCase().endsWith(".ttf"))try{this.editor.showStatus("Конвертация TTF шрифта...","info");const t={low:{curveSegments:1,resolution:100},medium:{curveSegments:2,resolution:100},high:{curveSegments:4,resolution:100},veryhigh:{curveSegments:8,resolution:100}},i=t[this.conversionQuality]||t.medium,r=await this.ttfConverter.convertTTFtoThreeJS(e,{includeCyrillic:!0,includeLatin:!0,curveSegments:i.curveSegments,resolution:i.resolution});if(r.success){const e=r.fontData;e.conversionQuality=this.conversionQuality,e.conversionSettings=i,e.conversionDate=(new Date).toISOString(),this.editor.fontManager.addCustomFont(r.fontName,e),this.updateFontSelector(),this.editor.showStatus(`Шрифт "${r.fontName}" успешно загружен! (Качество: ${this.conversionQuality})`,"success")}else this.editor.showStatus(`Ошибка конвертации: ${r.error}`,"error")}catch(e){console.error("Ошибка загрузки TTF шрифта:",e),this.editor.showStatus("Ошибка загрузки шрифта","error")}else this.editor.showStatus("Пожалуйста, выберите файл .ttf","error")}onMouseDown(e){if(0!==e.button)return!1;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);let i;if(t.length>0)i=t[0].point.clone(),i.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(i=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,i))return!1;{const e=this.editor.gridStep;i.x=Math.round(i.x/e)*e,i.z=Math.round(i.z/e)*e}}return this.createFinalText(i),!0}onMouseMove(e){if(this.isPlacing)return;let t;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),this.clearTempText();const i=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);if(i.length>0)t=i[0].point.clone(),t.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(t=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,t))return this.hideTempText(),!1;{const e=this.editor.gridStep;t.x=Math.round(t.x/e)*e,t.z=Math.round(t.z/e)*e}}return this.showTextPreview(t),!0}onKeyDown(e){return"Delete"===e.key||"Backspace"===e.key?(this.clear(),!0):!("Enter"!==e.key||!this.currentTextMesh)&&(this.finishTextEditing(),!0)}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","text3dTool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents(),this.updateFontSelector())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="text3dTool"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="text3d-settings">\n                <h4>3D ТЕКСТ</h4>\n                <div class="property-row">\n                    <label>Текст:</label>\n                    <input type="text" id="text3dInput" value="${this.text}" style="width: 200px;">\n                </div>\n                <div class="property-row">\n                    <label>Шрифт:</label>\n                    <select id="text3dFont" class="property-select"></select>\n                </div>\n                <div class="property-row">\n                    <label>Размер:</label>\n                    <input type="number" id="text3dSize" value="${this.fontSize}" step="0.5" min="1" max="100" style="width: 80px;"> мм\n                </div>\n                <div class="property-row">\n                    <label>Глубина:</label>\n                    <input type="number" id="text3dDepth" value="${this.depth}" step="0.5" min="0.1" max="50" style="width: 80px;"> мм\n                </div>\n                <div class="property-row">\n                    <label>Цвет:</label>\n                    <input type="color" id="text3dColor" value="#${this.fontColor.toString(16).padStart(6,"0")}" style="width: 60px;">\n                </div>\n                <div class="property-row">\n                    <label>Материал:</label>\n                    <select id="text3dMaterial" class="property-select">\n                        <option value="standard">Standard</option>\n                        <option value="basic">Basic</option>\n                        <option value="phong">Phong</option>\n                    </select>\n                </div>\n                <div class="property-row">\n                    <label>Скошенные края:</label>\n                    <input type="checkbox" id="text3dBevel" ${this.bevelEnabled?"checked":""}>\n                </div>\n                <div class="property-subgroup" id="bevelSettings" style="${this.bevelEnabled?"":"display: none;"}">\n                    <div class="property-row">\n                        <label>Толщина скоса:</label>\n                        <input type="number" id="text3dBevelThickness" value="${this.bevelThickness}" step="0.05" min="0.05" max="1" style="width: 80px;"> мм\n                    </div>\n                    <div class="property-row">\n                        <label>Размер скоса:</label>\n                        <input type="number" id="text3dBevelSize" value="${this.bevelSize}" step="0.05" min="0.05" max="1" style="width: 80px;"> мм\n                    </div>\n                    <div class="property-row">\n                        <label>Детализация:</label>\n                        <select id="text3dCurveSegments" class="property-select">\n                            <option value="4">Низкая</option>\n                            <option value="8" selected>Средняя</option>\n                            <option value="12">Высокая</option>\n                            <option value="24">Очень высокая</option>\n                        </select>\n                    </div>\n                </div>\n                <div class="property-subgroup">\n                    <div class="property-row">\n                        <label>Качество конвертации TTF:</label>\n                        <select id="ttfConversionQuality" class="property-select">\n                            <option value="low">Низкое</option>\n                            <option value="medium" selected>Среднее</option>\n                            <option value="high">Высокое</option>\n                            <option value="veryhigh">Очень высокое</option>\n                        </select>\n                    </div>\n                    <div class="property-row">\n                        <input type="file" id="ttfUpload" accept=".ttf" style="display: none;">\n                        <button id="uploadTTFButton" class="btn-secondary" style="width: 100%;">\n                            <i class="fas fa-upload"></i> Загрузить TTF\n                        </button>\n                    </div>\n                </div>\n                <div class="property-row" style="margin-top: 20px;">\n                    <button id="text3dCreateBtn" class="btn-primary" style="width: 100%;">\n                        <i class="fas fa-plus"></i> Создать текст\n                    </button>\n                </div>\n            </div>\n        `}updateFontSelector(){const e=this.propertiesElement?.querySelector("#text3dFont");if(!e)return;const t=this.editor.fontManager.fonts,i=e.value;e.innerHTML="",this.editor.fontManager.availableFonts.forEach(i=>{const r=document.createElement("option");r.value=i.name,r.textContent=i.name,t[i.name]||(r.disabled=!0,r.textContent+=" (загрузка...)"),e.appendChild(r)});const r=Object.keys(t).filter(e=>!this.editor.fontManager.availableFonts.some(t=>t.name===e));if(r.length>0){const t=document.createElement("option");t.disabled=!0,t.textContent="──────────",e.appendChild(t),r.forEach(t=>{const i=document.createElement("option");i.value=t,i.textContent=`★ ${t}`,e.appendChild(i)})}if(i&&e.querySelector(`option[value="${i}"]:not([disabled])`))e.value=i;else{const t=e.querySelector("option:not([disabled])");t&&(e.value=t.value,this.currentFont=t.value)}}bindPropertiesEvents(){if(!this.propertiesElement)return;this.propertiesElement.querySelector("#text3dInput")?.addEventListener("input",e=>{this.text=e.target.value,this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dFont")?.addEventListener("change",e=>{this.currentFont=e.target.value,this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dSize")?.addEventListener("input",e=>{this.fontSize=parseFloat(e.target.value)||10,this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dDepth")?.addEventListener("input",e=>{this.depth=parseFloat(e.target.value)||2,this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dColor")?.addEventListener("input",e=>{const t=new THREE.Color(e.target.value);this.fontColor=t.getHex(),this.updateTextMaterial()}),this.propertiesElement.querySelector("#text3dMaterial")?.addEventListener("change",e=>{this.materialType=e.target.value,this.updateTextMaterial()});const e=this.propertiesElement.querySelector("#text3dBevel");e&&e.addEventListener("change",e=>{this.bevelEnabled=e.target.checked;const t=this.propertiesElement.querySelector("#bevelSettings");t&&(t.style.display=this.bevelEnabled?"block":"none"),this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dBevelThickness")?.addEventListener("input",e=>{this.bevelThickness=parseFloat(e.target.value)||.1,this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dBevelSize")?.addEventListener("input",e=>{this.bevelSize=parseFloat(e.target.value)||.05,this.updateTextPreview()}),this.propertiesElement.querySelector("#text3dCurveSegments")?.addEventListener("change",e=>{this.curveSegments=parseInt(e.target.value)||12,this.updateTextPreview()}),this.propertiesElement.querySelector("#ttfConversionQuality")?.addEventListener("change",e=>{this.conversionQuality=e.target.value});const t=this.propertiesElement.querySelector("#uploadTTFButton"),i=this.propertiesElement.querySelector("#ttfUpload");t&&i&&(t.addEventListener("click",()=>i.click()),i.addEventListener("change",async e=>{const t=e.target.files[0];t&&await this.loadTTFFont(t)})),this.propertiesElement.querySelector("#text3dCreateBtn")?.addEventListener("click",()=>{this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=new THREE.Plane(new THREE.Vector3(0,1,0),0),t=new THREE.Vector3;this.editor.raycaster.ray.intersectPlane(e,t)&&this.createFinalText(t)})}updateTextPreview(){if(this.tempText&&this.tempText.parent){const e=this.tempText.position.clone();this.clearTempText(),this.showTextPreview(e)}}updateTextMaterial(){const e=new THREE.Color(this.fontColor);Object.values(this.textMaterials).forEach(t=>t.color.copy(e)),this.tempText&&(this.tempText.material=this.textMaterials[this.materialType]),this.currentTextMesh&&(this.currentTextMesh.material=this.textMaterials[this.materialType])}showTextPreview(e){if(this.text&&this.editor.fontManager.fonts[this.currentFont]){this.clearTempText();try{const t=new TextGeometry(this.text,{font:this.editor.fontManager.fonts[this.currentFont],size:this.fontSize,depth:this.depth,curveSegments:this.curveSegments,bevelEnabled:this.bevelEnabled,bevelThickness:this.bevelThickness,bevelSize:this.bevelSize});t.computeBoundingBox();const i=new THREE.Vector3;t.boundingBox.getCenter(i),t.translate(-i.x,-i.y,-i.z/2);const r=this.textMaterials[this.materialType].clone();r.transparent=!0,r.opacity=.7,this.tempText=new THREE.Mesh(t,r),this.tempText.position.copy(e),this.editor.scene.add(this.tempText),this.updateCoordinates(e)}catch(e){console.error("Ошибка создания предпросмотра текста:",e),this.editor.showStatus("Ошибка создания текста","error")}}else this.hideTempText()}hideTempText(){this.tempText&&(this.tempText.visible=!1)}clearTempText(){this.tempText&&(this.editor.scene.remove(this.tempText),this.tempText.geometry&&this.tempText.geometry.dispose(),this.tempText=null)}createFinalText(e){if(this.text&&this.editor.fontManager.fonts[this.currentFont])try{const t=this.editor.fontManager.getFontData(this.currentFont);if(!t)return void this.editor.showStatus(`Данные шрифта "${this.currentFont}" не найдены`,"error");const i={text:this.text,fontName:this.currentFont,fontData:t,fontSize:this.fontSize,depth:this.depth,bevelEnabled:this.bevelEnabled,bevelThickness:this.bevelThickness,bevelSize:this.bevelSize,curveSegments:this.curveSegments,materialType:this.materialType,color:this.fontColor,position:e.toArray()},r=new ParametricOperation("text3d",i,[]),s=this.editor.parametricModel.addOperation(r);this.editor.clearSelection(),s.forEach(e=>{const t=this.editor.parametricModel.objectMap.get(e);t&&(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.editor.showStatus(`3D текст создан: "${this.text}"`,"success"),this.currentTextMesh=null}catch(e){console.error("Ошибка создания 3D текста:",e),this.editor.showStatus("Ошибка создания 3D текста","error")}else this.editor.showStatus("Введите текст и выберите доступный шрифт","error")}finishTextEditing(){this.currentTextMesh&&(this.currentTextMesh=null,this.editor.showStatus("Создание текста завершено. Кликните для нового текста","success"))}updateCoordinates(e){e&&(document.getElementById("coords").textContent=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}, Z: ${e.z.toFixed(2)}`)}clear(){this.clearTempText(),this.currentTextMesh=null,this.isPlacing=!1}}