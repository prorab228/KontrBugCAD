class Text3DTool extends Tool{constructor(e){super("text3dTool","fa-font",e),this.text="Текст",this.fontSize=10,this.depth=2,this.fontColor=4473924,this.materialType="standard",this.bevelEnabled=!1,this.bevelThickness=.1,this.bevelSize=.05,this.curveSegments=12,this.currentTextMesh=null,this.tempText=null,this.isPlacing=!1,this.textMaterials={standard:new THREE.MeshStandardMaterial({color:this.fontColor,roughness:.7,metalness:.2}),basic:new THREE.MeshBasicMaterial({color:this.fontColor}),phong:new THREE.MeshPhongMaterial({color:this.fontColor,shininess:100})},this.fonts={},this.availableFonts=[{name:"Roboto",file:"fonts/Roboto_Regular.json"},{name:"Arial",file:"fonts/helvetiker_regular.typeface.json"},{name:"Bold",file:"fonts/helvetiker_bold.typeface.json"},{name:"Optima",file:"fonts/optimer_regular.typeface.json"}],this.currentFont="Arial",this.loadFonts()}onActivate(){this.clear(),this.createPropertiesSection(),document.body.style.cursor="crosshair",this.editor.showStatus("3D Текст: кликните для размещения текста (ESC - отмена)","info")}onDeactivate(){this.clear(),this.removePropertiesSection(),document.body.style.cursor="default",this.clearTempText()}loadFonts(){const e=new THREE.FontLoader;this.availableFonts.forEach(t=>{e.load(t.file,e=>{this.fonts[t.name]=e,console.log(`Шрифт ${t.name} загружен`),this.propertiesElement&&this.updateFontSelector()},void 0,e=>{console.error(`Ошибка загрузки шрифта ${t.name}:`,e)})})}onMouseDown(e){if(0!==e.button)return!1;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);let i;if(t.length>0)i=t[0].point.clone(),i.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(i=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,i))return!1;{const e=this.editor.gridStep;i.x=Math.round(i.x/e)*e,i.z=Math.round(i.z/e)*e}}return this.createFinalText(i),!0}onMouseMove(e){if(this.isPlacing)return;let t;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),this.clearTempText();const i=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);if(i.length>0)t=i[0].point.clone(),t.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(t=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,t))return this.hideTempText(),!1;{const e=this.editor.gridStep;t.x=Math.round(t.x/e)*e,t.z=Math.round(t.z/e)*e}}return this.showTextPreview(t),!0}onKeyDown(e){return"Escape"===e.key?(this.editor.toolManager.setCurrentTool("select"),!0):"Delete"===e.key||"Backspace"===e.key?(this.clear(),!0):!("Enter"!==e.key||!this.currentTextMesh)&&(this.finishTextEditing(),!0)}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","text3dTool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents(),this.updateFontSelector())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="text3dTool"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="text3d-settings">\n                <h4>3D ТЕКСТ</h4>\n\n                <div class="property-row">\n                    <label>Текст:</label>\n                    <input type="text" id="text3dInput" value="${this.text}" style="width: 200px;">\n                </div>\n\n                <div class="property-row">\n                    <label>Шрифт:</label>\n                    <select id="text3dFont" style="width: 150px;">\n                        <option value="Arial">Arial</option>\n                        <option value="Bold">Bold</option>\n                        <option value="Optima">Optima</option>\n                    </select>\n                </div>\n\n                <div class="property-row">\n                    <label>Размер:</label>\n                    <input type="number" id="text3dSize" value="${this.fontSize}" step="0.5" min="1" max="100" style="width: 80px;">\n                    <span>мм</span>\n                </div>\n\n                <div class="property-row">\n                    <label>Глубина:</label>\n                    <input type="number" id="text3dDepth" value="${this.depth}" step="0.5" min="0.1" max="50" style="width: 80px;">\n                    <span>мм</span>\n                </div>\n\n                <div class="property-row">\n                    <label>Цвет:</label>\n                    <input type="color" id="text3dColor" value="#${this.fontColor.toString(16).padStart(6,"0")}" style="width: 60px;">\n                </div>\n\n                <div class="property-row">\n                    <label>Материал:</label>\n                    <select id="text3dMaterial" style="width: 120px;">\n                        <option value="standard">Standard</option>\n                        <option value="basic">Basic</option>\n                        <option value="phong">Phong</option>\n                    </select>\n                </div>\n\n                <div class="property-row">\n                    <label>Скошенные края:</label>\n                    <input type="checkbox" id="text3dBevel" ${this.bevelEnabled?"checked":""}>\n                </div>\n\n                <div class="property-subgroup" id="bevelSettings" style="${this.bevelEnabled?"":"display: none;"}">\n                    <div class="property-row">\n                        <label>Толщина скоса:</label>\n                        <input type="number" id="text3dBevelThickness" value="${this.bevelThickness}" step="0.05" min="0.05" max="1" style="width: 80px;">\n                        <span>мм</span>\n                    </div>\n\n                    <div class="property-row">\n                        <label>Размер скоса:</label>\n                        <input type="number" id="text3dBevelSize" value="${this.bevelSize}" step="0.05" min="0.05" max="1" style="width: 80px;">\n                        <span>мм</span>\n                    </div>\n\n                    <div class="property-row">\n                        <label>Детализация:</label>\n                        <select id="text3dCurveSegments" style="width: 80px;">\n                            <option value="4">Низкая</option>\n                            <option value="8" selected>Средняя</option>\n                            <option value="12">Высокая</option>\n                            <option value="24">Очень высокая</option>\n                        </select>\n                    </div>\n                </div>\n\n                <div class="property-row" style="margin-top: 20px;">\n                    <button id="text3dCreateBtn" class="btn-primary" style="width: 100%;">\n                        <i class="fas fa-plus"></i> Создать текст\n                    </button>\n                </div>\n            </div>\n        `}updateFontSelector(){const e=this.propertiesElement?.querySelector("#text3dFont");e&&(e.value=this.currentFont)}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#text3dInput");e&&e.addEventListener("input",e=>{this.text=e.target.value,this.updateTextPreview()});const t=this.propertiesElement.querySelector("#text3dFont");t&&t.addEventListener("change",e=>{this.currentFont=e.target.value,this.updateTextPreview()});const i=this.propertiesElement.querySelector("#text3dSize");i&&i.addEventListener("input",e=>{this.fontSize=parseFloat(e.target.value)||10,this.updateTextPreview()});const s=this.propertiesElement.querySelector("#text3dDepth");s&&s.addEventListener("input",e=>{this.depth=parseFloat(e.target.value)||2,this.updateTextPreview()});const r=this.propertiesElement.querySelector("#text3dColor");r&&r.addEventListener("input",e=>{const t=new THREE.Color(e.target.value);this.fontColor=t.getHex(),this.updateTextMaterial()});const n=this.propertiesElement.querySelector("#text3dMaterial");n&&(n.value=this.materialType,n.addEventListener("change",e=>{this.materialType=e.target.value,this.updateTextMaterial()}));const o=this.propertiesElement.querySelector("#text3dBevel");o&&o.addEventListener("change",e=>{this.bevelEnabled=e.target.checked;const t=this.propertiesElement.querySelector("#bevelSettings");t&&(t.style.display=this.bevelEnabled?"block":"none"),this.updateTextPreview()});const a=this.propertiesElement.querySelector("#text3dBevelThickness");a&&a.addEventListener("input",e=>{this.bevelThickness=parseFloat(e.target.value)||.1,this.updateTextPreview()});const l=this.propertiesElement.querySelector("#text3dBevelSize");l&&l.addEventListener("input",e=>{this.bevelSize=parseFloat(e.target.value)||.05,this.updateTextPreview()});const h=this.propertiesElement.querySelector("#text3dCurveSegments");h&&(h.value=this.curveSegments.toString(),h.addEventListener("change",e=>{this.curveSegments=parseInt(e.target.value)||12,this.updateTextPreview()}));const p=this.propertiesElement.querySelector("#text3dCreateBtn");p&&p.addEventListener("click",()=>{this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=new THREE.Plane(new THREE.Vector3(0,1,0),0),t=new THREE.Vector3;this.editor.raycaster.ray.intersectPlane(e,t)&&this.createFinalText(t)})}updateTextPreview(){if(this.tempText&&this.tempText.parent){const e=this.tempText.position.clone();this.clearTempText(),this.showTextPreview(e)}}updateTextMaterial(){const e=new THREE.Color(this.fontColor);Object.keys(this.textMaterials).forEach(t=>{this.textMaterials[t].color.copy(e),this.textMaterials[t].needsUpdate=!0}),this.tempText&&(this.tempText.material=this.textMaterials[this.materialType]),this.currentTextMesh&&(this.currentTextMesh.material=this.textMaterials[this.materialType])}showTextPreview(e){if(this.text&&this.fonts[this.currentFont]){this.clearTempText();try{const t=new THREE.TextGeometry(this.text,{font:this.fonts[this.currentFont],size:this.fontSize,height:this.depth,curveSegments:this.curveSegments,bevelEnabled:this.bevelEnabled,bevelThickness:this.bevelThickness,bevelSize:this.bevelSize});t.computeBoundingBox();const i=new THREE.Vector3;t.boundingBox.getCenter(i),t.translate(-i.x,-i.y,-i.z/2);const s=this.textMaterials[this.materialType];this.tempText=new THREE.Mesh(t,s),this.tempText.position.copy(e),this.tempText.material.transparent=!0,this.tempText.material.opacity=.7,this.editor.scene.add(this.tempText),this.updateCoordinates(e)}catch(e){console.error("Ошибка создания предварительного просмотра текста:",e),this.editor.showStatus("Ошибка создания текста","error")}}else this.hideTempText()}hideTempText(){this.tempText&&(this.tempText.visible=!1)}clearTempText(){this.tempText&&(this.editor.scene.remove(this.tempText),this.tempText.geometry&&this.tempText.geometry.dispose(),this.tempText=null)}createFinalText(e){if(this.text&&this.fonts[this.currentFont])try{this.clearTempText();const t=new THREE.TextGeometry(this.text,{font:this.fonts[this.currentFont],size:this.fontSize,height:this.depth,curveSegments:this.curveSegments,bevelEnabled:this.bevelEnabled,bevelThickness:this.bevelThickness,bevelSize:this.bevelSize});t.computeBoundingBox();const i=new THREE.Vector3;t.boundingBox.getCenter(i),t.translate(-i.x,-i.y,-i.z/2);const s=this.textMaterials[this.materialType].clone(),r=new THREE.Mesh(t,s);r.position.copy(e),r.userData.type="text3d",r.userData.text=this.text,r.userData.font=this.currentFont,r.userData.fontSize=this.fontSize,r.userData.depth=this.depth,r.userData.bevelEnabled=this.bevelEnabled,r.userData.bevelThickness=this.bevelThickness,r.userData.bevelSize=this.bevelSize,r.userData.curveSegments=this.curveSegments,r.userData.materialType=this.materialType,r.userData.color=this.fontColor,r.userData.isEditable=!0,this.editor.objectsGroup.add(r),this.editor.objects.push(r),this.editor.selectSingleObject(r),this.editor.history&&this.editor.history.addAction({type:"create",object:r.uuid,data:this.editor.projectManager.serializeObjectForHistory(r)}),this.editor.showStatus(`3D текст создан: "${this.text}"`,"success"),this.currentTextMesh=r}catch(e){console.error("Ошибка создания 3D текста:",e),this.editor.showStatus("Ошибка создания 3D текста","error")}else this.editor.showStatus("Введите текст и дождитесь загрузки шрифта","error")}finishTextEditing(){this.currentTextMesh&&(this.currentTextMesh=null,this.editor.showStatus("Создание текста завершено. Кликните для нового текста","success"))}updateCoordinates(e){e&&(document.getElementById("coords").textContent=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}, Z: ${e.z.toFixed(2)}`)}clear(){this.clearTempText(),this.currentTextMesh=null,this.isPlacing=!1}}