class DecimateTool extends Tool{constructor(e){super("decimate","fa-compress-alt",e),this.reductionFactor=.3,this.preserveBorders=!0,this.preserveNormals=!0,this.propertiesElement=null}onActivate(){if(this.canActivate()){if(!this.editor.booleanOps||!this.editor.booleanOps.isReady)return this.editor.showStatus("Manifold ещё не загружен, попробуйте позже","warning"),void this.editor.toolManager.restorePreviousTool();this.createPropertiesSection(),this.editor.showStatus("Выберите объекты и настройте параметры упрощения","info")}else this.editor.toolManager.restorePreviousTool()}onDeactivate(){this.removePropertiesSection()}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","decimate"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents(),this.updateApplyButtonState())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="decimate"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){const e=Math.round(100*this.reductionFactor);return`\n            <div class="property-group" data-type="decimate-settings">\n                <h4>УМЕНЬШЕНИЕ ПОЛИГОНОВ (MANIFOLD)</h4>\n                <div class="property-row">\n                    <label>Уровень уменьшения:</label>\n                    <div style="display: flex; align-items: center; gap: 8px;">\n                        <input type="range" id="decimateFactor" min="0.1" max="0.7" step="0.1"\n                               value="${this.reductionFactor}" style="flex: 1;">\n                        <span id="factorValue">${e}%</span>\n                    </div>\n                </div>\n                <div class="property-row">\n                    <label>Сохранять границы:</label>\n                    <input type="checkbox" id="preserveBorders" ${this.preserveBorders?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Пересчитать нормали:</label>\n                    <input type="checkbox" id="preserveNormals" ${this.preserveNormals?"checked":""}>\n                </div>\n                <div class="property-buttons">\n                    <button id="applyDecimateBtn" class="btn-primary" style="flex: 1;">\n                        <i class="fas fa-check"></i> Применить\n                    </button>\n                    <button id="resetDecimateBtn" class="btn-secondary">\n                        <i class="fas fa-undo"></i> Сброс\n                    </button>\n                </div>\n                <div class="property-hint">\n                    <p><i class="fas fa-info-circle"></i> Упрощение геометрии с сохранением формы.<br>Рекомендуется 20–40%.</p>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#decimateFactor"),t=this.propertiesElement.querySelector("#factorValue");e&&t&&e.addEventListener("input",e=>{this.reductionFactor=parseFloat(e.target.value),t.textContent=`${Math.round(100*this.reductionFactor)}%`});const r=this.propertiesElement.querySelector("#preserveBorders");r&&r.addEventListener("change",e=>{this.preserveBorders=e.target.checked});const s=this.propertiesElement.querySelector("#preserveNormals");s&&s.addEventListener("change",e=>{this.preserveNormals=e.target.checked});const i=this.propertiesElement.querySelector("#applyDecimateBtn");i&&i.addEventListener("click",()=>this.applyDecimation());const o=this.propertiesElement.querySelector("#resetDecimateBtn");o&&o.addEventListener("click",()=>this.resetParameters())}updateApplyButtonState(){const e=this.propertiesElement?.querySelector("#applyDecimateBtn");e&&(e.disabled=0===this.editor.selectedObjects.length)}resetParameters(){this.reductionFactor=.3,this.preserveBorders=!0,this.preserveNormals=!0;const e=this.propertiesElement?.querySelector("#decimateFactor"),t=this.propertiesElement?.querySelector("#factorValue");e&&(e.value=this.reductionFactor),t&&(t.textContent="30%");const r=this.propertiesElement?.querySelector("#preserveBorders");r&&(r.checked=!0);const s=this.propertiesElement?.querySelector("#preserveNormals");s&&(s.checked=!0),this.editor.showStatus("Параметры сброшены","info")}applyDecimation(){if(0===this.editor.selectedObjects.length)return void this.editor.showStatus("Нет выбранных объектов","warning");const e=this.editor.selectedObjects.map(e=>e.uuid),t={targets:e,reductionFactor:this.reductionFactor,preserveBorders:this.preserveBorders,preserveNormals:this.preserveNormals},r=new ParametricOperation("decimate",t,e),s=this.editor.parametricModel.addOperation(r);this.editor.clearSelection(),s.forEach(e=>{const t=this.editor.parametricModel.objectMap.get(e);t&&(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.editor.showStatus("Упрощение применено","success"),this.editor.toolManager.setCurrentTool("select")}}