class DecimateTool extends Tool{constructor(t){super("decimate","fa-compress-alt",t),this.requiresSelection=!0,this.reductionFactor=.3}onActivate(){this.canActivate()?this.showDecimateDialog():this.editor.toolManager.restorePreviousTool()}showDecimateDialog(){const t=document.createElement("div");t.className="modal-overlay active",t.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.7);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        ",t.innerHTML=`\n            <div class="modal-content" style="\n                background: white;\n                padding: 20px;\n                border-radius: 8px;\n                min-width: 300px;\n                max-width: 500px;\n                box-shadow: 0 5px 15px rgba(0,0,0,0.3);\n            ">\n                <h3 style="margin-top: 0;">Уменьшение полигонов</h3>\n                <div style="margin: 20px 0;">\n                    <label style="display: block; margin-bottom: 10px;">\n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                            <span>Уровень уменьшения:</span>\n                            <span id="factorValue">${Math.round(100*this.reductionFactor)}%</span>\n                        </div>\n                        <input type="range" id="decimateFactor" min="0.1" max="0.7" step="0.1"\n                               value="${this.reductionFactor}"\n                               style="width: 100%;">\n                    </label>\n\n                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">\n                        <strong>Информация:</strong>\n                        <ul style="margin: 5px 0 0 20px;">\n                            <li>Рекомендуется использовать значение 20-40%</li>\n                            <li>Значения выше 50% могут привести к потере деталей</li>\n                            <li>Объекты с малым количеством полигонов не будут изменены</li>\n                        </ul>\n                    </div>\n                </div>\n                <div style="display: flex; justify-content: flex-end; gap: 10px;">\n                    <button id="cancelDecimate" style="\n                        padding: 8px 16px;\n                        background: #f0f0f0;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                    ">Отмена</button>\n                    <button id="applyDecimate" style="\n                        padding: 8px 16px;\n                        background: #2196F3;\n                        color: white;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                    ">Применить</button>\n                </div>\n            </div>\n        `,document.body.appendChild(t);const e=document.getElementById("decimateFactor"),n=document.getElementById("factorValue");e.addEventListener("input",t=>{this.reductionFactor=parseFloat(t.target.value),n.textContent=`${Math.round(100*this.reductionFactor)}%`}),document.getElementById("cancelDecimate").addEventListener("click",()=>{document.body.removeChild(t),this.editor.toolManager.restorePreviousTool()}),document.getElementById("applyDecimate").addEventListener("click",()=>{document.body.removeChild(t),this.performDecimation()})}async performDecimation(){this.showLoadingIndicator("Уменьшение полигонов...");try{let t=0,e=0,n=0;const o=[],i=[];for(const r of this.editor.selectedObjects)if(console.log(`Обработка объекта: ${r.uuid}`),this.canDecimateObject(r))try{const a=this.cloneAndDecimateObject(r,this.reductionFactor);if(a){const s=this.getFaceCount(r.geometry),c=this.getFaceCount(a.geometry),d=Math.round(100*(1-c/s));if(d<5){console.log(`Слишком маленькое уменьшение (${d}%), пропускаем`),e++;continue}o.push(r),i.push(a),n+=d,t++}else e++}catch(t){console.error(`Ошибка при упрощении объекта ${r.uuid}:`,t),e++}else console.log(`Пропуск объекта ${r.uuid}: неподходящая геометрия`),e++;if(o.length>0&&this.applyDecimateChanges(o,i,n),this.hideLoadingIndicator(),t>0){const e=Math.round(n/t);this.editor.showStatus(`Уменьшено полигонов на ${e}% в ${t} объектах`,"success"),this.editor.objectsManager.updateSceneStats()}else this.editor.showStatus("Не удалось уменьшить полигоны","warning")}catch(t){this.hideLoadingIndicator(),console.error("Общая ошибка упрощения:",t),this.editor.showStatus(`Ошибка упрощения: ${t.message}`,"error")}this.editor.toolManager.restorePreviousTool()}canDecimateObject(t){if(!t||!t.isObject3D||!t.geometry)return!1;if(!t.geometry.isBufferGeometry)return!1;if(!t.geometry.attributes.position)return!1;const e=this.getFaceCount(t.geometry);if(e<100)return console.log(`Слишком мало полигонов для упрощения: ${e}`),!1;const n=t.geometry.attributes.position.array;for(let t=0;t<n.length;t++)if(isNaN(n[t])||!isFinite(n[t]))return console.log("Обнаружены NaN, требуется сначала ремонт геометрии"),!1;return!0}getFaceCount(t){return t?t.index?t.index.count/3:t.attributes.position?t.attributes.position.count/3:0:0}cloneAndDecimateObject(t,e){try{console.log(`Клонирование и упрощение объекта: ${t.uuid}`);const n=t.clone();n.uuid=THREE.MathUtils.generateUUID();const o=n.geometry,i=this.getFaceCount(o);if(i<100)return console.log(`Слишком мало полигонов: ${i}`),null;const r=Math.max(20,Math.floor(i*(1-e)));console.log(`Целевое количество полигонов: ${i} → ${r}`);let a=i,s=.001,c=0;const d=10;for(;a>r&&c<d;){const t=o.attributes.position.count;this.mergeVertices(o,s),this.removeDegenerateTriangles(o);const e=o.attributes.position.count;if(a=this.getFaceCount(o),s*=1.5,c++,console.log(`Итерация ${c}: вершины ${t} → ${e}, полигонов: ${a}`),Math.abs(t-e)<10)break}o.attributes.normal&&o.computeVertexNormals(),o.computeBoundingBox(),o.computeBoundingSphere(),t.userData&&(n.userData=JSON.parse(JSON.stringify(t.userData))),n.position.copy(t.position),n.rotation.copy(t.rotation),n.scale.copy(t.scale),n.material=t.material;const l=this.getFaceCount(o),u=Math.round(100*(1-l/i));return console.log(`Упрощение завершено: ${i} → ${l} (${u}%)`),n}catch(t){return console.error("Ошибка упрощения:",t),null}}mergeVertices(t,e=.001){if(!t.attributes.position)return!1;const n=t.attributes.position,o=n.count,i=new Map,r=[],a=new Array(o);for(let t=0;t<o;t++){const o=n.getX(t),s=n.getY(t),c=n.getZ(t),d=`${Math.round(o/e)},${Math.round(s/e)},${Math.round(c/e)}`;i.has(d)||(i.set(d,r.length),r.push({x:o,y:s,z:c,originalIndex:t})),a[t]=i.get(d)}return r.length!==o&&(this.rebuildGeometryWithUniqueVertices(t,r,a),!0)}rebuildGeometryWithUniqueVertices(t,e,n){const o=new Float32Array(3*e.length);if(e.forEach((t,e)=>{o[3*e]=t.x,o[3*e+1]=t.y,o[3*e+2]=t.z}),t.setAttribute("position",new THREE.BufferAttribute(o,3)),t.attributes.normal){const n=t.attributes.normal,o=new Float32Array(3*e.length);for(let t=0;t<e.length;t++){const i=e[t].originalIndex;o[3*t]=n.getX(i),o[3*t+1]=n.getY(i),o[3*t+2]=n.getZ(i)}t.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(t.attributes.uv){const n=t.attributes.uv,o=new Float32Array(2*e.length);for(let t=0;t<e.length;t++){const i=e[t].originalIndex;o[2*t]=n.getX(i),o[2*t+1]=n.getY(i)}t.setAttribute("uv",new THREE.BufferAttribute(o,2))}if(t.index){const e=t.index.array,o=new Uint32Array(e.length);for(let t=0;t<e.length;t++)o[t]=n[e[t]];t.setIndex(new THREE.BufferAttribute(o,1))}}removeDegenerateTriangles(t){if(!t.index)return!1;const e=t.index.array,n=[];let o=0;for(let t=0;t<e.length;t+=3){const i=e[t],r=e[t+1],a=e[t+2];i!==r&&i!==a&&r!==a?n.push(i,r,a):o++}return o>0&&(t.setIndex(new THREE.BufferAttribute(new Uint32Array(n),1)),!0)}applyDecimateChanges(t,e,n){const o={type:"delete",objects:t.map(t=>({uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}))},i={type:"create",objects:e.map(t=>({uuid:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}))};t.forEach(t=>{this.editor.removeObject(t)}),e.forEach(t=>{this.editor.addObject(t)}),this.editor.historyManager.addAction(o),this.editor.historyManager.addAction(i),this.editor.clearSelection(),e.forEach(t=>{this.editor.selectObject(t,!0)})}showLoadingIndicator(t){const e=document.createElement("div");e.id="decimateLoadingIndicator",e.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 20px 30px;\n            border-radius: 8px;\n            z-index: 10001;\n            font-size: 16px;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        ",e.innerHTML=`\n            <i class="fas fa-spinner fa-spin"></i>\n            <span>${t}</span>\n        `,document.body.appendChild(e)}hideLoadingIndicator(){const t=document.getElementById("decimateLoadingIndicator");t&&document.body.removeChild(t)}}