class DecimateTool extends Tool{constructor(e){super("decimate","fa-compress-alt",e),this.requiresSelection=!0,this.reductionFactor=.3}onActivate(){this.canActivate()?this.showDecimateDialog():this.editor.toolManager.restorePreviousTool()}showDecimateDialog(){const e=document.createElement("div");e.className="modal-overlay active",e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.7);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        ",e.innerHTML=`\n            <div class="modal-content" style="\n                background: white;\n                padding: 20px;\n                border-radius: 8px;\n                min-width: 300px;\n                max-width: 500px;\n                box-shadow: 0 5px 15px rgba(0,0,0,0.3);\n            ">\n                <h3 style="margin-top: 0;">Уменьшение полигонов</h3>\n                <div style="margin: 20px 0;">\n                    <label style="display: block; margin-bottom: 10px;">\n                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                            <span>Уровень уменьшения:</span>\n                            <span id="factorValue">${Math.round(100*this.reductionFactor)}%</span>\n                        </div>\n                        <input type="range" id="decimateFactor" min="0.1" max="0.7" step="0.1"\n                               value="${this.reductionFactor}"\n                               style="width: 100%;">\n                    </label>\n\n                    <div style="margin-bottom: 15px;">\n                        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">\n                            <input type="checkbox" id="preserveBorders" checked>\n                            <span>Сохранять границы объекта</span>\n                        </label>\n                        <label style="display: flex; align-items: center; gap: 8px;">\n                            <input type="checkbox" id="preserveNormals" checked>\n                            <span>Сохранять нормали</span>\n                        </label>\n                    </div>\n\n                    <div style="background: #f5f5f5; padding: 10px; border-radius: 4px; font-size: 12px;">\n                        <strong>Информация:</strong>\n                        <ul style="margin: 5px 0 0 20px;">\n                            <li>Рекомендуется использовать значение 20-40%</li>\n                            <li>Значения выше 50% могут привести к потере деталей</li>\n                            <li>Объекты с малым количеством полигонов не будут изменены</li>\n                            <li>Метод: Агрессивное объединение вершин</li>\n                        </ul>\n                    </div>\n                </div>\n                <div style="display: flex; justify-content: flex-end; gap: 10px;">\n                    <button id="cancelDecimate" style="\n                        padding: 8px 16px;\n                        background: #f0f0f0;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                    ">Отмена</button>\n                    <button id="applyDecimate" style="\n                        padding: 8px 16px;\n                        background: #2196F3;\n                        color: white;\n                        border: none;\n                        border-radius: 4px;\n                        cursor: pointer;\n                    ">Применить</button>\n                </div>\n            </div>\n        `,document.body.appendChild(e);const t=document.getElementById("decimateFactor"),n=document.getElementById("factorValue");t.addEventListener("input",e=>{this.reductionFactor=parseFloat(e.target.value),n.textContent=`${Math.round(100*this.reductionFactor)}%`}),document.getElementById("cancelDecimate").addEventListener("click",()=>{document.body.removeChild(e),this.editor.toolManager.restorePreviousTool()}),document.getElementById("applyDecimate").addEventListener("click",()=>{this.preserveBorders=document.getElementById("preserveBorders").checked,this.preserveNormals=document.getElementById("preserveNormals").checked,document.body.removeChild(e),this.performDecimation()})}async performDecimation(){this.showLoadingIndicator("Уменьшение полигонов...");try{let e=0,t=0,n=0;const o=[],i=[];for(const r of this.editor.selectedObjects)if(console.log(`Обработка объекта: ${r.uuid}`),this.canDecimateObject(r))try{const s=this.cloneAndDecimateObject(r,this.reductionFactor);if(s){const a=this.getFaceCount(r.geometry),c=this.getFaceCount(s.geometry),l=Math.round(100*(1-c/a));if(console.log(`Результат упрощения: ${a} → ${c} (${l}%)`),l<5){console.log(`Слишком маленькое уменьшение (${l}%), пропускаем`),t++;continue}o.push(r),i.push(s),n+=l,e++}else t++}catch(e){console.error(`Ошибка при упрощении объекта ${r.uuid}:`,e),t++}else console.log(`Пропуск объекта ${r.uuid}: неподходящая геометрия`),t++;if(o.length>0&&this.applyDecimateChanges(o,i,n),this.hideLoadingIndicator(),e>0){const t=Math.round(n/e);this.editor.showStatus(`Уменьшено полигонов на ${t}% в ${e} объектах`,"success"),this.editor.objectsManager.updateSceneStats()}else this.editor.showStatus("Не удалось уменьшить полигоны","warning")}catch(e){this.hideLoadingIndicator(),console.error("Общая ошибка упрощения:",e),this.editor.showStatus(`Ошибка упрощения: ${e.message}`,"error")}this.editor.toolManager.restorePreviousTool()}canDecimateObject(e){if(!e||!e.isObject3D||!e.geometry)return!1;if(!e.geometry.isBufferGeometry)return!1;if(!e.geometry.attributes.position)return!1;const t=this.getFaceCount(e.geometry);if(t<100)return console.log(`Слишком мало полигонов для упрощения: ${t}`),!1;const n=e.geometry.attributes.position.array;for(let e=0;e<n.length;e++)if(isNaN(n[e])||!isFinite(n[e]))return console.log("Обнаружены NaN, требуется сначала ремонт геометрии"),!1;return!0}getFaceCount(e){return e?e.index?e.index.count/3:e.attributes.position?e.attributes.position.count/3:0:0}cloneAndDecimateObject(e,t){try{console.log(`Клонирование и упрощение объекта: ${e.uuid}`);const n=e.clone();n.uuid=THREE.MathUtils.generateUUID();const o=n.geometry,i=this.getFaceCount(o);if(i<100)return console.log(`Слишком мало полигонов: ${i}`),null;const r=Math.max(20,Math.floor(i*(1-t)));console.log(`Целевое количество полигонов: ${i} → ${r}`),this.aggressiveDecimation(o,r),this.preserveNormals&&o.computeVertexNormals(),o.computeBoundingBox(),o.computeBoundingSphere(),this.copyObjectData(n,e);const s=this.getFaceCount(n.geometry),a=Math.round(100*(1-s/i));return console.log(`Упрощение завершено: ${i} → ${s} (${a}%)`),n}catch(e){return console.error("Ошибка упрощения:",e),null}}aggressiveDecimation(e,t){console.log("Агрессивная децимация");let n=this.getFaceCount(e);if(console.log(`Начальное количество полигонов: ${n}`),n<=t)return void console.log("Целевое количество уже достигнуто");e.index||(console.log("Геометрия не индексирована, создаем индексы"),this.triangulateGeometry(e),n=this.getFaceCount(e));let o=.001,i=0;for(;n>t&&i<20;){console.log(`Итерация ${i+1}, допуск: ${o}, полигонов: ${n}`);e.attributes.position&&e.attributes.position.count;this.mergeVertices(e,o),this.removeDegenerateTriangles(e),this.removeIsolatedVertices(e);const t=this.getFaceCount(e);if(t===n?(o*=2,console.log(`Количество не изменилось, увеличиваем допуск до ${o}`)):t<n&&console.log(`Успешно уменьшено: ${n} → ${t}`),n=t,i++,o>.5){console.log("Достигнут максимальный допуск, останавливаемся");break}}n>1.5*t&&(console.log("Все еще много полигонов, удаляем треугольники"),this.removeSmallestTriangles(e,t)),this.mergeVertices(e,.01),this.removeDegenerateTriangles(e),this.removeIsolatedVertices(e);const r=this.getFaceCount(e);console.log(`Итоговое количество полигонов: ${r}`)}removeSmallestTriangles(e,t){if(!e.index)return;const n=e.index.array,o=e.attributes.position,i=[];for(let e=0;e<n.length;e+=3){const t=n[e],r=n[e+1],s=n[e+2],a=this.calcTriangleArea(o.getX(t),o.getY(t),o.getZ(t),o.getX(r),o.getY(r),o.getZ(r),o.getX(s),o.getY(s),o.getZ(s));i.push({index:e/3,area:a,vertices:[t,r,s]})}i.sort((e,t)=>e.area-t.area);const r=Math.max(0,i.length-t);if(r<=0)return;const s=[],a=new Set;for(let e=r;e<i.length;e++)a.add(i[e].index);for(let e=0;e<n.length;e+=3){const t=e/3;a.has(t)&&s.push(n[e],n[e+1],n[e+2])}console.log(`Удалено ${r} самых маленьких треугольников`),e.setIndex(new THREE.BufferAttribute(new Uint32Array(s),1))}calcTriangleArea(e,t,n,o,i,r,s,a,c){const l=o-e,d=i-t,u=r-n,g=s-e,h=a-t,p=c-n,m=d*p-u*h,y=u*g-l*p,f=l*h-d*g;return.5*Math.sqrt(m*m+y*y+f*f)}triangulateGeometry(e){const t=e.attributes.position,n=t.count;if(n%3!=0){console.warn("Количество вершин не кратно 3, геометрия может быть некорректной");const o=3-n%3,i=new Float32Array(3*(n+o));i.set(t.array);for(let e=0;e<3*o;e++)i[3*n+e]=t.array[t.array.length-1];e.setAttribute("position",new THREE.BufferAttribute(i,3))}const o=e.attributes.position.count,i=new Uint32Array(o);for(let e=0;e<o;e++)i[e]=e;e.setIndex(new THREE.BufferAttribute(i,1))}mergeVertices(e,t=.001){if(!e.attributes.position)return!1;const n=e.attributes.position,o=n.count,i=new Map,r=[],s=new Array(o);for(let e=0;e<o;e++){const o=n.getX(e),a=n.getY(e),c=n.getZ(e),l=`${Math.round(o/t*10)/10},${Math.round(a/t*10)/10},${Math.round(c/t*10)/10}`;i.has(l)||(i.set(l,r.length),r.push({x:o,y:a,z:c,originalIndex:e})),s[e]=i.get(l)}return r.length!==o&&(console.log(`Объединение вершин: ${o} → ${r.length}`),this.rebuildGeometryWithUniqueVertices(e,r,s),!0)}rebuildGeometryWithUniqueVertices(e,t,n){const o=new Float32Array(3*t.length);if(t.forEach((e,t)=>{o[3*t]=e.x,o[3*t+1]=e.y,o[3*t+2]=e.z}),e.setAttribute("position",new THREE.BufferAttribute(o,3)),e.attributes.normal){const n=e.attributes.normal,o=new Float32Array(3*t.length);for(let e=0;e<t.length;e++){const i=t[e].originalIndex;o[3*e]=n.getX(i),o[3*e+1]=n.getY(i),o[3*e+2]=n.getZ(i)}e.setAttribute("normal",new THREE.BufferAttribute(o,3))}if(e.attributes.uv){const n=e.attributes.uv,o=new Float32Array(2*t.length);for(let e=0;e<t.length;e++){const i=t[e].originalIndex;o[2*e]=n.getX(i),o[2*e+1]=n.getY(i)}e.setAttribute("uv",new THREE.BufferAttribute(o,2))}if(e.index){const t=e.index.array,o=new Uint32Array(t.length);for(let e=0;e<t.length;e++)o[e]=n[t[e]];e.setIndex(new THREE.BufferAttribute(o,1))}}removeDegenerateTriangles(e){if(!e.index)return!1;const t=e.index.array,n=[];let o=0;for(let e=0;e<t.length;e+=3){const i=t[e],r=t[e+1],s=t[e+2];i!==r&&i!==s&&r!==s?n.push(i,r,s):o++}return o>0&&(console.log(`Удалено вырожденных треугольников: ${o}`),e.setIndex(new THREE.BufferAttribute(new Uint32Array(n),1)),!0)}removeIsolatedVertices(e){if(!e.index)return!1;const t=e.index.array,n=new Set;for(let e=0;e<t.length;e++)n.add(t[e]);const o=e.attributes.position,i=o.count;if(n.size===i)return!1;const r=new Array(i).fill(-1),s=[];let a=0;for(let e=0;e<i;e++)n.has(e)&&(r[e]=a++,s.push({x:o.getX(e),y:o.getY(e),z:o.getZ(e),originalIndex:e}));const c=new Uint32Array(t.length);for(let e=0;e<t.length;e++)c[e]=r[t[e]];return this.rebuildGeometryWithUniqueVertices(e,s,r),e.setIndex(new THREE.BufferAttribute(c,1)),console.log("Удалено изолированных вершин: "+(i-n.size)),!0}copyObjectData(e,t){t.userData&&(e.userData=JSON.parse(JSON.stringify(t.userData))),e.position.copy(t.position),e.rotation.copy(t.rotation),e.scale.copy(t.scale),t.material&&(e.material=t.material)}applyDecimateChanges(e,t,n){console.log("Применение изменений децимации: удаление",e.length,"объектов, создание",t.length,"объектов");const o={type:"modify",deletedObjects:e.map(e=>({uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)})),createdObjects:t.map(e=>({uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)})),timestamp:(new Date).toISOString(),description:`Упрощение геометрии (${e.length} объектов, уменьшение на ${Math.round(n/e.length)}%)`};e.forEach(e=>{this.removeObjectSilently(e)}),t.forEach(e=>{this.addObjectSilently(e)}),this.editor.history.addAction(o),this.editor.clearSelection(),t.forEach(e=>{this.editor.selectedObjects.push(e),this.editor.objectsManager.highlightObject(e)}),this.editor.updatePropertiesPanel(),this.editor.objectsManager.updateSceneList(),this.editor.updateStatus()}removeObjectSilently(e){if(!e)return;if(this.editor.selectedObjects.includes(e)){this.editor.objectsManager.unhighlightObject(e);const t=this.editor.selectedObjects.indexOf(e);t>-1&&this.editor.selectedObjects.splice(t,1)}e.parent&&e.parent.remove(e);const t=this.editor.objects.indexOf(e);if(t>-1&&this.editor.objects.splice(t,1),"sketch_plane"===e.userData.type){const t=this.editor.sketchPlanes.indexOf(e);t>-1&&this.editor.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.editor.workPlanes.indexOf(e);t>-1&&this.editor.workPlanes.splice(t,1)}else if("group"===e.userData.type){const t=this.editor.groups.indexOf(e);t>-1&&this.editor.groups.splice(t,1)}e.geometry&&"function"==typeof e.geometry.dispose&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(e=>{e&&"function"==typeof e.dispose&&e.dispose()}):"function"==typeof e.material.dispose&&e.material.dispose())}addObjectSilently(e){e&&e.geometry&&e.geometry.attributes&&e.geometry.attributes.position?(this.editor.objectsGroup.add(e),this.editor.objects.push(e),"sketch_plane"===e.userData.type?this.editor.sketchPlanes.push(e):"work_plane"===e.userData.type?this.editor.workPlanes.push(e):"group"===e.userData.type&&(this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(e)),console.log("Объект успешно добавлен:",e.uuid,"полигонов:",this.getFaceCount(e.geometry))):console.error("Попытка добавить пустой объект!")}showLoadingIndicator(e){const t=document.createElement("div");t.id="decimateLoadingIndicator",t.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 20px 30px;\n            border-radius: 8px;\n            z-index: 10001;\n            font-size: 16px;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        ",t.innerHTML=`\n            <i class="fas fa-spinner fa-spin"></i>\n            <span>${e}</span>\n        `,document.body.appendChild(t)}hideLoadingIndicator(){const e=document.getElementById("decimateLoadingIndicator");e&&document.body.removeChild(e)}}