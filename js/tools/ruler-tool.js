class RulerTool extends Tool{constructor(e){super("rulerTool","fa-ruler",e),this.points=[],this.allMeasurements=[],this.tempLine=null,this.measurementText=null,this.measurementGroup=null,this.lineMaterial=new THREE.LineBasicMaterial({color:65280,linewidth:2})}onActivate(){this.clear(),document.body.style.cursor="crosshair",this.editor.showStatus("Линейка: кликните первую точку измерения (ESC - отмена)","info")}onDeactivate(){this.clear(),document.body.style.cursor="default",this.clearAllMeasurements()}onMouseDown(e){if(0!==e.button)return!1;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);let s;if(t.length>0)s=t[0].point,(e.ctrlKey||e.metaKey)&&(s=this.snapToGeometry(t[0]));else{const t=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(s=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(t,s))return!1;(e.ctrlKey||e.metaKey)&&(s.x=Math.round(s.x),s.y=Math.round(s.y),s.z=Math.round(s.z))}return this.addPoint(s),!0}onMouseMove(e){if(0===this.points.length)return;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),s=new THREE.Vector3;this.editor.raycaster.ray.intersectPlane(t,s)&&this.updateTempLine(s)}onKeyDown(e){return"Escape"===e.key?(this.editor.toolManager.setCurrentTool("select"),!0):("Delete"===e.key||"Backspace"===e.key)&&(this.clear(),!0)}addPoint(e){this.points.push(e.clone()),1===this.points.length?this.editor.showStatus("Линейка: кликните вторую точку (ESC - отмена)","info"):2===this.points.length&&(this.createMeasurement(),setTimeout(()=>{this.points=[],this.tempLine&&(this.editor.scene.remove(this.tempLine),this.tempLine=null),this.editor.showStatus("Измерение завершено. Кликните для нового измерения (ESC - выход)","info")},100))}updateTempLine(e){if(0===this.points.length)return;this.tempLine&&this.editor.scene.remove(this.tempLine);const t=(new THREE.BufferGeometry).setFromPoints([this.points[0],e]);this.tempLine=new THREE.Line(t,this.lineMaterial),this.editor.scene.add(this.tempLine),this.showTempDistance(e)}showTempDistance(e){if(0===this.points.length)return;const t=this.points[0].distanceTo(e);document.getElementById("coords").textContent=`Расстояние: ${t.toFixed(2)} мм | X: ${e.x.toFixed(1)}, Y: ${e.y.toFixed(1)}, Z: ${e.z.toFixed(1)}`}createMeasurement(){if(2!==this.points.length)return;const e=this.points[0],t=this.points[1],s=e.distanceTo(t);this.measurementGroup=new THREE.Group,this.measurementGroup.userData.isRulerMeasurement=!0;const i=(new THREE.BufferGeometry).setFromPoints([e,t]),n=new THREE.Line(i,this.lineMaterial);this.measurementGroup.add(n);const o=new THREE.SphereGeometry(.2,8,8),r=new THREE.MeshBasicMaterial({color:16711680}),a=new THREE.Mesh(o,r);a.position.copy(e);const h=new THREE.Mesh(o,r);h.position.copy(t),this.measurementGroup.add(a),this.measurementGroup.add(h);const l=(new THREE.Vector3).addVectors(e,t).multiplyScalar(.5),m=this.createDistanceText(s,l);m&&this.measurementGroup.add(m),this.editor.scene.add(this.measurementGroup),this.allMeasurements.push(this.measurementGroup),this.editor.showStatus(`Измерение: ${s.toFixed(2)} мм`,"success")}createDistanceText(e,t){try{const s=document.createElement("canvas"),i=s.getContext("2d"),n=60,o=`${e.toFixed(2)} мм`;i.font=`${n}px Arial`;const r=i.measureText(o).width,a=n;s.width=r+20,s.height=a+10,i.font=`${n}px Arial`,i.fillStyle="#00ff00",i.textAlign="center",i.textBaseline="middle",i.fillText(o,s.width/2,s.height/2);const h=new THREE.CanvasTexture(s);h.needsUpdate=!0;const l=new THREE.SpriteMaterial({map:h,transparent:!0}),m=new THREE.Sprite(l);return m.position.copy(t),m.position.y+=5,m.scale.set(s.width/20,s.height/20,1),m}catch(e){return console.error("Ошибка создания текста:",e),null}}snapToGeometry(e){return e.point}clearAllMeasurements(){this.allMeasurements.forEach(e=>{e.parent&&e.parent.remove(e),e.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})}),this.allMeasurements=[],this.measurementGroup=null,this.tempLine&&(this.editor.scene.remove(this.tempLine),this.tempLine.geometry.dispose(),this.tempLine.material.dispose(),this.tempLine=null)}clear(){this.tempLine&&(this.editor.scene.remove(this.tempLine),this.tempLine.geometry.dispose(),this.tempLine.material.dispose(),this.tempLine=null),this.points=[],document.getElementById("coords").textContent="X: 0.00, Y: 0.00, Z: 0.00"}}