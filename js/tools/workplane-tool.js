class WorkPlaneTool extends Tool{constructor(e){super("workplane","fa-square",e),this.planesManager=e.planesManager,this.workPlaneMode=null,this.faceSelectionObject=null,this.tempWorkPlane=null,this.hoveredPlane=null,this.hoveredObject=null}createWorkPlane(){this.workPlaneMode="active",this.editor.basePlanes&&(this.editor.basePlanes.visible=!0),this.editor.showStatus("Выберите базовую плоскость (XY, XZ, YZ) или грань любого объекта для создания рабочей плоскости","info")}handleSelection(e){this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=this.editor.basePlanes?this.editor.basePlanes.children:[],s=this.editor.raycaster.intersectObjects(t);if(s.length>0){const e=s[0].object;return this.createWorkPlaneOnBasePlane(e)}const o=this.getAllSelectableObjects(),i=this.editor.raycaster.intersectObjects(o,!0);if(i.length>0){const e=i[0],t=this.getFaceWorldNormal(e);let s=e.object;for(;s.parent&&s.parent!==this.editor.objectsGroup&&"Scene"!==s.parent.type;)s=s.parent;const o=s.name||"объекте";return this.createWorkPlaneOnFace(e.point,t,`Плоскость на ${o}`)}return!1}handleHighlight(e){this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),this.resetPreviousHighlight();let t=!1;const s=this.editor.basePlanes?this.editor.basePlanes.children:[],o=this.editor.raycaster.intersectObjects(s);if(o.length>0){t=!0;const e=o[0].object;return this.hoveredPlane=e,e.material.opacity=.4,void(document.body.style.cursor="pointer")}const i=this.getAllSelectableObjects(),r=this.editor.raycaster.intersectObjects(i,!0);if(r.length>0){t=!0;const e=r[0],s=this.getFaceWorldNormal(e);this.createOrUpdateTempWorkPlane(e.point,s);let o=e.object;for(;o.parent&&o.parent!==this.editor.objectsGroup&&"Scene"!==o.parent.type;)o=o.parent;return this.hoveredObject=o,this.editor.objectsManager.highlightSingleObject(o),void(document.body.style.cursor="pointer")}t||(document.body.style.cursor="default")}getAllSelectableObjects(){return this.faceSelectionObject?[this.faceSelectionObject]:this.editor.objectsGroup.children.filter(e=>{const t=e.userData?.type;return"work_plane"!==t&&"sketch_plane"!==t&&"base_plane"!==t})}getFaceWorldNormal(e){const t=new THREE.Vector3;if(e.face){const s=e.face.normal.clone(),o=(new THREE.Matrix3).getNormalMatrix(e.object.matrixWorld);s.applyMatrix3(o).normalize(),t.copy(s)}else t.copy(e.normal||new THREE.Vector3(0,0,1));return t}createWorkPlaneOnBasePlane(e){const t=this.planesManager.createWorkPlaneObject(e.userData.planeType.toUpperCase());return t.position.copy(e.position),t.quaternion.copy(e.quaternion),this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.workPlanes.push(t),this.exitWorkPlaneMode(),this.editor.clearSelection(),this.editor.selectObject(t),this.editor.showStatus(`Создана рабочая плоскость на ${e.userData.planeType.toUpperCase()}`,"success"),!0}createWorkPlaneOnFace(e,t,s="Плоскость на грани"){const o=this.planesManager.createWorkPlaneObject(s,"face");o.position.copy(e);const i=t.clone().multiplyScalar(.01);o.position.add(i);const r=new THREE.Vector3(0,0,1);t.normalize();const a=new THREE.Quaternion,n=r.dot(t);if(Math.abs(n+1)<1e-4)a.setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI);else if(Math.abs(n-1)<1e-4)a.identity();else{const e=(new THREE.Vector3).crossVectors(r,t).normalize(),s=Math.acos(r.dot(t));a.setFromAxisAngle(e,s)}return o.quaternion.copy(a),this.editor.objectsGroup.add(o),this.editor.objects.push(o),this.editor.workPlanes.push(o),this.exitWorkPlaneMode(),this.editor.clearSelection(),this.editor.selectObject(o),this.editor.showStatus("Создана рабочая плоскость на грани объекта","success"),!0}createOrUpdateTempWorkPlane(e,t){if(!this.tempWorkPlane){const e=new THREE.PlaneGeometry(50,50),t=new THREE.MeshBasicMaterial({color:16750592,transparent:!0,opacity:.4,side:THREE.DoubleSide,depthWrite:!1,depthTest:!0});this.tempWorkPlane=new THREE.Mesh(e,t),this.editor.objectsGroup.add(this.tempWorkPlane)}this.tempWorkPlane.position.copy(e),t.normalize();const s=new THREE.Vector3(0,0,1),o=new THREE.Quaternion,i=s.dot(t);if(Math.abs(i+1)<1e-4)o.setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI);else if(Math.abs(i-1)<1e-4)o.identity();else{const e=(new THREE.Vector3).crossVectors(s,t).normalize(),i=Math.acos(s.dot(t));o.setFromAxisAngle(e,i)}this.tempWorkPlane.quaternion.copy(o);const r=t.clone().multiplyScalar(.01);this.tempWorkPlane.position.add(r)}resetPreviousHighlight(){this.hoveredPlane&&(this.hoveredPlane.material.opacity=.1,this.hoveredPlane=null),this.hoveredObject&&(this.editor.objectsManager.unhighlightObject(this.hoveredObject),this.hoveredObject=null),this.tempWorkPlane&&(this.editor.objectsGroup.remove(this.tempWorkPlane),this.tempWorkPlane.geometry.dispose(),this.tempWorkPlane.material.dispose(),this.tempWorkPlane=null)}exitWorkPlaneMode(){this.workPlaneMode=null,this.faceSelectionObject=null,this.editor.basePlanes&&(this.editor.basePlanes.visible=!1),this.resetPreviousHighlight(),this.editor.showStatus("Режим создания рабочей плоскости завершен","info")}startWorkPlaneFaceSelection(){return 1===this.editor.selectedObjects.length&&"work_plane"!==this.editor.selectedObjects[0].userData.type&&"sketch_plane"!==this.editor.selectedObjects[0].userData.type&&"base_plane"!==this.editor.selectedObjects[0].userData.type&&(this.faceSelectionObject=this.editor.selectedObjects[0],this.workPlaneMode="active",this.editor.basePlanes&&(this.editor.basePlanes.visible=!1),this.editor.showStatus("Выберите грань выделенного объекта для создания рабочей плоскости","info"),!0)}onActivate(){return 1===this.editor.selectedObjects.length&&"work_plane"!==this.editor.selectedObjects[0].userData.type&&"sketch_plane"!==this.editor.selectedObjects[0].userData.type&&"base_plane"!==this.editor.selectedObjects[0].userData.type?(this.faceSelectionObject=this.editor.selectedObjects[0],this.workPlaneMode="active",this.editor.basePlanes&&(this.editor.basePlanes.visible=!1),this.editor.showStatus("Выберите грань выделенного объекта для создания рабочей плоскости","info")):this.createWorkPlane(),!0}onDeactivate(){this.exitWorkPlaneMode()}onMouseDown(e){return!("active"!==this.workPlaneMode||!this.handleSelection(e))&&(this.editor.toolManager.setCurrentTool("select"),!0)}onMouseMove(e){"active"===this.workPlaneMode&&this.handleHighlight(e)}onKeyDown(e){return!("Escape"!==e.key||!this.workPlaneMode)&&(this.editor.toolManager.setCurrentTool("select"),!0)}}