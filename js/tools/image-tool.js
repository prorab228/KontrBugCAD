class ImageTool extends Tool{constructor(e){super("imageTool","fa-image",e),this.imageSize=50,this.imageDepth=.1,this.keepAspectRatio=!0,this.isTransparent=!1,this.opacity=1,this.rotation=0,this.currentImage=null,this.tempImage=null,this.isPlacing=!1,this.loadedImage=null,this.imageURL=null,this.imageMaterial=null,this.previewMaterial=null,this.createFileInput(),this.supportedFormats=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"]}onActivate(){this.clear(),this.createPropertiesSection(),document.body.style.cursor="crosshair",this.editor.showStatus('Загрузите изображение (кликните "Выбрать файл" или перетащите в окно)',"info")}onDeactivate(){this.clear(),this.removePropertiesSection(),this.clearTempImage(),document.body.style.cursor="default"}createFileInput(){this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="image/*",this.fileInput.style.display="none",this.fileInput.addEventListener("change",e=>this.handleFileSelect(e)),document.body.appendChild(this.fileInput)}handleFileSelect(e){const t=e.target.files[0];if(!t)return;if(!this.supportedFormats.includes(t.type))return void this.editor.showStatus(`Неподдерживаемый формат: ${t.type}. Используйте JPEG, PNG, GIF, BMP или WebP.`,"error");if(t.size>10485760)return void this.editor.showStatus("Файл слишком большой (максимум 10MB)","error");const i=new FileReader;i.onload=e=>{this.imageURL=e.target.result,this.loadImageTexture(this.imageURL,t.name),this.updateImageFileName(t.name)},i.onerror=()=>{this.editor.showStatus("Ошибка чтения файла","error")},i.readAsDataURL(t)}loadImageTexture(e,t){const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{this.loadedImage=i,this.createImageMaterial(i),this.editor.showStatus(`Изображение загружено: ${t} (${i.width}x${i.height})`,"success"),this.updateImagePreview()},i.onerror=()=>{this.editor.showStatus("Ошибка загрузки изображения","error")},i.src=e}createImageMaterial(e){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width,t.height=e.height,i.drawImage(e,0,0);const a=new THREE.CanvasTexture(t);a.needsUpdate=!0,this.imageMaterial=new THREE.MeshStandardMaterial({map:a,side:THREE.DoubleSide,transparent:this.isTransparent,opacity:this.opacity}),this.previewMaterial=this.imageMaterial.clone(),this.previewMaterial.transparent=!0,this.previewMaterial.opacity=.7}onMouseDown(e){if(0!==e.button)return!1;if(!this.loadedImage)return this.editor.showStatus("Сначала загрузите изображение","warning"),!1;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const t=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);let i;if(t.length>0)i=t[0].point.clone(),i.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(i=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,i))return!1;{const e=this.editor.gridStep;i.x=Math.round(i.x/e)*e,i.z=Math.round(i.z/e)*e}}return this.createFinalImage(i),!0}onMouseMove(e){if(!this.loadedImage)return;let t;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),this.clearTempImage();const i=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);if(i.length>0)t=i[0].point.clone(),t.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(t=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,t))return this.hideTempImage(),!1;{const e=this.editor.gridStep;t.x=Math.round(t.x/e)*e,t.z=Math.round(t.z/e)*e}}return this.showImagePreview(t),!0}onKeyDown(e){return("r"===e.key||"к"===e.key)&&(this.rotation+=Math.PI/2,this.updateImagePreview(),!0)}showImagePreview(e){if(this.loadedImage&&this.previewMaterial){this.clearTempImage();try{let t,i;if(this.keepAspectRatio){const e=this.loadedImage.width/this.loadedImage.height;e>=1?(t=this.imageSize,i=this.imageSize/e):(i=this.imageSize,t=this.imageSize*e)}else t=this.imageSize,i=this.imageSize;const a=new THREE.BoxGeometry(t,i,this.imageDepth);this.tempImage=new THREE.Mesh(a,this.previewMaterial),this.tempImage.position.copy(e),this.tempImage.rotation.y=this.rotation,this.editor.scene.add(this.tempImage),this.updateCoordinates(e)}catch(e){console.error("Ошибка создания предпросмотра изображения:",e),this.editor.showStatus("Ошибка создания предпросмотра","error")}}else this.hideTempImage()}hideTempImage(){this.tempImage&&(this.tempImage.visible=!1)}clearTempImage(){this.tempImage&&(this.editor.scene.remove(this.tempImage),this.tempImage.geometry&&this.tempImage.geometry.dispose(),this.tempImage=null)}createFinalImage(e){if(this.loadedImage&&this.imageMaterial)try{let t,i;if(this.clearTempImage(),this.keepAspectRatio){const e=this.loadedImage.width/this.loadedImage.height;e>=1?(t=this.imageSize,i=this.imageSize/e):(i=this.imageSize,t=this.imageSize*e)}else t=this.imageSize,i=this.imageSize;const a=new THREE.BoxGeometry(t,i,this.imageDepth),s=this.imageMaterial.clone(),r=new THREE.Mesh(a,s);r.position.copy(e),r.rotation.y=this.rotation,r.userData.type="image",r.userData.imageSize=this.imageSize,r.userData.imageDepth=this.imageDepth,r.userData.keepAspectRatio=this.keepAspectRatio,r.userData.isTransparent=this.isTransparent,r.userData.opacity=this.opacity,r.userData.rotation=this.rotation,r.userData.imageURL=this.imageURL,r.userData.dimensions={width:t,height:i},r.userData.isEditable=!0,this.editor.objectsGroup.add(r),this.editor.objects.push(r),this.editor.selectSingleObject(r),this.editor.history.addAction({type:"create_image",object:r.uuid,data:{imageURL:this.imageURL,imageSize:this.imageSize,imageDepth:this.imageDepth,keepAspectRatio:this.keepAspectRatio,isTransparent:this.isTransparent,opacity:this.opacity,rotation:this.rotation,position:e.clone(),dimensions:{width:t,height:i}}}),this.editor.showStatus(`Изображение размещено: ${t.toFixed(1)}x${i.toFixed(1)} мм`,"success"),this.currentImage=r}catch(e){console.error("Ошибка создания изображения:",e),this.editor.showStatus("Ошибка создания изображения","error")}else this.editor.showStatus("Сначала загрузите изображение","warning")}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","imageTool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="imageTool"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="image-settings">\n                <h4>ИЗОБРАЖЕНИЕ</h4>\n\n                <div class="property-row">\n                    <label>Файл изображения:</label>\n                    <button id="imageFileSelect" class="btn-secondary" >\n                        <i class="fas fa-folder-open"></i> Выбрать файл\n                    </button>\n                </div>\n                <div id="imageFileName" style="margin-top: 0; font-size: 12px; color: #888;">\n                    Файл не выбран\n                </div>\n\n                <div class="property-row">\n                    <label>Размер (мм):</label>\n                    <input type="number" id="imageSize" value="${this.imageSize}"\n                           step="1" min="1" max="1000" style="width: 80px;">\n                </div>\n\n                <div class="property-row">\n                    <label>Толщина (мм):</label>\n                    <input type="number" id="imageDepth" value="${this.imageDepth}"\n                           step="0.1" min="0.1" max="10" style="width: 80px;">\n                </div>\n\n                <div class="property-row">\n                    <label>Сохранять пропорции:</label>\n                    <input type="checkbox" id="keepAspectRatio" ${this.keepAspectRatio?"checked":""}>\n                </div>\n\n                <div class="property-row">\n                    <label>Прозрачный фон:</label>\n                    <input type="checkbox" id="isTransparent" ${this.isTransparent?"checked":""}>\n                </div>\n\n                <div class="property-row">\n                    <label>Прозрачность:</label>\n                    <input type="range" id="imageOpacity" min="0" max="100"\n                           value="${100*this.opacity}" style="width: 120px;">\n                    <span id="opacityValue">${Math.round(100*this.opacity)}%</span>\n                </div>\n\n                <div class="property-row">\n                    <label>Вращение:</label>\n                    <input type="range" id="imageRotation" min="0" max="360"\n                           value="${this.rotation*(180/Math.PI)}" style="width: 120px;">\n                    <span id="rotationValue">${Math.round(this.rotation*(180/Math.PI))}°</span>\n                </div>\n\n                <div class="property-row" style="margin-top: 20px;">\n                    <div style="display: flex; gap: 10px;">\n                        \x3c!--<button id="imageCreateBtn" class="btn-primary" style="flex: 1;" ${this.loadedImage?"":"disabled"}>--\x3e\n                        \x3c!--   <i class="fas fa-plus"></i> Разместить изображение--\x3e\n                       \x3c!-- </button>--\x3e\n                        <button id="imageClearBtn" class="btn-secondary">\n                            <i class="fas fa-times"></i> Очистить\n                        </button>\n                    </div>\n                </div>\n\n                <div class="property-row" style="margin-top: 10px;">\n                    <p style="font-size: 12px; color: #888; margin: 0;">\n                        <i class="fas fa-info-circle"></i> Поддерживаемые форматы: JPEG, PNG, GIF, BMP, WebP<br>\n                        Максимальный размер: 10MB<br>\n                        Горячие клавиши: R - вращение, ESC - отмена\n                    </p>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return;const e=this.propertiesElement.querySelector("#imageFileSelect");e&&e.addEventListener("click",()=>{this.fileInput.click()});const t=this.propertiesElement.querySelector("#imageSize");t&&t.addEventListener("input",e=>{this.imageSize=parseFloat(e.target.value)||50,this.updateImagePreview()});const i=this.propertiesElement.querySelector("#imageDepth");i&&i.addEventListener("input",e=>{this.imageDepth=parseFloat(e.target.value)||.1,this.updateImagePreview()});const a=this.propertiesElement.querySelector("#keepAspectRatio");a&&a.addEventListener("change",e=>{this.keepAspectRatio=e.target.checked,this.updateImagePreview()});const s=this.propertiesElement.querySelector("#isTransparent");s&&s.addEventListener("change",e=>{this.isTransparent=e.target.checked,this.imageMaterial&&(this.imageMaterial.transparent=this.isTransparent,this.imageMaterial.needsUpdate=!0),this.previewMaterial&&(this.previewMaterial.transparent=this.isTransparent,this.previewMaterial.needsUpdate=!0),this.updateImagePreview()});const r=this.propertiesElement.querySelector("#imageOpacity"),n=this.propertiesElement.querySelector("#opacityValue");r&&n&&r.addEventListener("input",e=>{this.opacity=parseInt(e.target.value)/100,n.textContent=`${e.target.value}%`,this.imageMaterial&&(this.imageMaterial.opacity=this.opacity,this.imageMaterial.needsUpdate=!0),this.previewMaterial&&(this.previewMaterial.opacity=.7*this.opacity,this.previewMaterial.needsUpdate=!0),this.updateImagePreview()});const o=this.propertiesElement.querySelector("#imageRotation"),h=this.propertiesElement.querySelector("#rotationValue");o&&h&&o.addEventListener("input",e=>{const t=parseInt(e.target.value);this.rotation=t*(Math.PI/180),h.textContent=`${t}°`,this.updateImagePreview()});const p=this.propertiesElement.querySelector("#imageClearBtn");p&&p.addEventListener("click",()=>{this.clear(),this.editor.showStatus("Изображение очищено","info")})}updateImagePreview(){if(this.tempImage&&this.tempImage.parent){const e=this.tempImage.position.clone();this.clearTempImage(),this.showImagePreview(e)}}updateImageFileName(e){const t=this.propertiesElement?.querySelector("#imageFileName");t&&(e?(t.textContent=e,t.style.color="#4CAF50"):(t.textContent="Файл не выбран",t.style.color="#888"))}updateCoordinates(e){e&&(document.getElementById("coords").textContent=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}, Z: ${e.z.toFixed(2)}`)}handleDrop(e){e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;if(t.length>0){const e=t[0];if(this.supportedFormats.includes(e.type)){const t=new FileReader;t.onload=t=>{this.imageURL=t.target.result,this.loadImageTexture(this.imageURL,e.name),this.updateImageFileName(e.name)},t.readAsDataURL(e)}else this.editor.showStatus(`Неподдерживаемый формат: ${e.type}`,"error")}}clear(){this.clearTempImage(),this.updateImageFileName(null),this.currentImage=null,this.currentImage=null,this.tempImage=null,this.isPlacing=!1,this.loadedImage=null,this.imageURL=null,this.isPlacing=!1}}