class ImageTool extends Tool{constructor(e){super("imageTool","fa-image",e),this.imageSize=50,this.imageDepth=.1,this.keepAspectRatio=!0,this.isTransparent=!1,this.opacity=1,this.rotation=0,this.currentImage=null,this.tempImage=null,this.isPlacing=!1,this.loadedImage=null,this.imageURL=null,this.isFixed=!1,this.imageMaterial=null,this.previewMaterial=null,this.createFileInput(),this.supportedFormats=["image/jpeg","image/jpg","image/png","image/gif","image/bmp","image/webp"]}onActivate(){this.clear(),this.createPropertiesSection(),document.body.style.cursor="crosshair",this.editor.showStatus('Загрузите изображение (кликните "Выбрать файл" или перетащите в окно)',"info")}onDeactivate(){this.clear(),this.removePropertiesSection(),this.clearTempImage(),document.body.style.cursor="default"}createFileInput(){this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept="image/*",this.fileInput.style.display="none",this.fileInput.addEventListener("change",e=>this.handleFileSelect(e)),document.body.appendChild(this.fileInput)}handleFileSelect(e){const t=e.target.files[0];if(!t)return;if(!this.supportedFormats.includes(t.type))return void this.editor.showStatus(`Неподдерживаемый формат: ${t.type}. Используйте JPEG, PNG, GIF, BMP или WebP.`,"error");if(t.size>10485760)return void this.editor.showStatus("Файл слишком большой (максимум 10MB)","error");const i=new FileReader;i.onload=e=>{this.imageURL=e.target.result,this.loadImageTexture(this.imageURL,t.name),this.updateImageFileName(t.name)},i.onerror=()=>{this.editor.showStatus("Ошибка чтения файла","error")},i.readAsDataURL(t)}loadImageTexture(e,t){const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{this.loadedImage=i,this.createImageMaterial(i),this.editor.showStatus(`Изображение загружено: ${t} (${i.width}x${i.height})`,"success"),this.isFixed=!1,this.updateImagePreview()},i.onerror=()=>{this.editor.showStatus("Ошибка загрузки изображения","error")},i.src=e}createImageMaterial(e){const t=document.createElement("canvas"),i=t.getContext("2d");t.width=e.width,t.height=e.height,i.drawImage(e,0,0);const a=new THREE.CanvasTexture(t);a.needsUpdate=!0,this.imageMaterial=new THREE.MeshStandardMaterial({map:a,side:THREE.DoubleSide,transparent:this.isTransparent,opacity:this.opacity}),this.previewMaterial=this.imageMaterial.clone(),this.previewMaterial.transparent=!0,this.previewMaterial.opacity=.7}onMouseDown(e){return 0===e.button&&(this.loadedImage?!this.isFixed&&(this.isFixed=!0,this.editor.showStatus('Изображение зафиксировано. Настройте параметры и нажмите "Применить"',"info"),this.updateApplyButtonState(),!0):(this.editor.showStatus("Сначала загрузите изображение","warning"),!1))}onMouseMove(e){if(!this.loadedImage||this.isFixed)return;let t;this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),this.clearTempImage();const i=this.editor.raycaster.intersectObjects(this.editor.objectsGroup.children,!0);if(i.length>0)t=i[0].point.clone(),t.y+=.1;else{const e=new THREE.Plane(new THREE.Vector3(0,1,0),0);if(t=new THREE.Vector3,!this.editor.raycaster.ray.intersectPlane(e,t))return this.hideTempImage(),!1;{const e=this.editor.gridStep;t.x=Math.round(t.x/e)*e,t.z=Math.round(t.z/e)*e}}return this.showImagePreview(t),!0}onKeyDown(e){return"r"===e.key||"к"===e.key?(this.rotation+=Math.PI/2,this.updateImagePreview(),!0):"Escape"===e.key&&(this.isFixed&&(this.isFixed=!1,this.editor.showStatus("Фиксация отменена","info"),this.updateApplyButtonState()),!0)}showImagePreview(e){if(this.loadedImage&&this.previewMaterial){this.clearTempImage();try{let t,i;if(this.keepAspectRatio){const e=this.loadedImage.width/this.loadedImage.height;e>=1?(t=this.imageSize,i=this.imageSize/e):(i=this.imageSize,t=this.imageSize*e)}else t=this.imageSize,i=this.imageSize;const a=new THREE.BoxGeometry(t,i,this.imageDepth);this.tempImage=new THREE.Mesh(a,this.previewMaterial),this.tempImage.position.copy(e),this.tempImage.rotation.y=this.rotation,this.editor.scene.add(this.tempImage),this.updateCoordinates(e)}catch(e){console.error("Ошибка создания предпросмотра изображения:",e),this.editor.showStatus("Ошибка создания предпросмотра","error")}}else this.hideTempImage()}hideTempImage(){this.tempImage&&(this.tempImage.visible=!1)}clearTempImage(){this.tempImage&&(this.editor.scene.remove(this.tempImage),this.tempImage.geometry&&this.tempImage.geometry.dispose(),this.tempImage=null)}createFinalImage(){if(this.loadedImage&&this.imageMaterial&&this.tempImage)try{let e,t;if(this.keepAspectRatio){const i=this.loadedImage.width/this.loadedImage.height;i>=1?(e=this.imageSize,t=this.imageSize/i):(t=this.imageSize,e=this.imageSize*i)}else e=this.imageSize,t=this.imageSize;const i={imageURL:this.imageURL,width:e,height:t,depth:this.imageDepth,position:this.tempImage.position.toArray(),rotation:[this.tempImage.rotation.x,this.tempImage.rotation.y,this.tempImage.rotation.z],opacity:this.opacity,transparent:this.isTransparent,color:16777215},a=new ParametricOperation("image",i,[]),s=this.editor.parametricModel.addOperation(a);this.editor.clearSelection(),s.forEach(e=>{const t=this.editor.parametricModel.objectMap.get(e);t&&(this.editor.selectedObjects.push(t),this.editor.objectsManager.highlightObject(t))}),this.editor.showStatus("Изображение размещено","success"),this.editor.toolManager.setCurrentTool("select")}catch(e){console.error("Ошибка создания изображения:",e),this.editor.showStatus("Ошибка создания изображения","error")}else this.editor.showStatus("Нет изображения для размещения","warning")}createPropertiesSection(){const e=document.getElementById("propertiesContent");e&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","imageTool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),e.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const e=document.querySelector('.property-group[data-tool="imageTool"]');e&&e.remove(),this.propertiesElement=null}getPropertiesHTML(){return`\n            <div class="property-group" data-type="image-settings">\n                <h4>ИЗОБРАЖЕНИЕ</h4>\n                <div class="property-row">\n                    <label>Файл изображения:</label>\n                    <button id="imageFileSelect" class="btn-secondary">\n                        <i class="fas fa-folder-open"></i> Выбрать файл\n                    </button>\n                </div>\n                <div id="imageFileName">Файл не выбран</div>\n                <div class="property-row">\n                    <label>Размер (мм):</label>\n                    <input type="number" id="imageSize" value="${this.imageSize}" step="1" min="1" max="1000">\n                </div>\n                <div class="property-row">\n                    <label>Толщина (мм):</label>\n                    <input type="number" id="imageDepth" value="${this.imageDepth}" step="0.1" min="0.1" max="10">\n                </div>\n                <div class="property-row">\n                    <label>Сохранять пропорции:</label>\n                    <input type="checkbox" id="keepAspectRatio" ${this.keepAspectRatio?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Прозрачный фон:</label>\n                    <input type="checkbox" id="isTransparent" ${this.isTransparent?"checked":""}>\n                </div>\n                <div class="property-row">\n                    <label>Прозрачность:</label>\n                    <input type="range" id="imageOpacity" min="0" max="100" value="${100*this.opacity}" style="width: 120px;">\n                    <span id="opacityValue">${Math.round(100*this.opacity)}%</span>\n                </div>\n                <div class="property-row">\n                    <label>Вращение:</label>\n                    <input type="range" id="imageRotation" min="0" max="360" value="${this.rotation*(180/Math.PI)}" style="width: 120px;">\n                    <span id="rotationValue">${Math.round(this.rotation*(180/Math.PI))}°</span>\n                </div>\n                <div class="property-buttons">\n                    <button id="imageCreateBtn" class="btn-primary" style="flex: 1;" disabled>\n                        <i class="fas fa-check"></i> Применить\n                    </button>\n                    <button id="imageClearBtn" class="btn-secondary">\n                        <i class="fas fa-times"></i> Сбросить\n                    </button>\n                </div>\n                <div class="property-hint">\n                    <p><i class="fas fa-info-circle"></i> Поддерживаемые форматы: JPEG, PNG, GIF, BMP, WebP<br>\n                    Максимальный размер: 10MB<br>\n                    Инструкция:<br>\n                    1. Загрузите изображение<br>\n                    2. Перемещайте изображение мышью<br>\n                    3. Кликните для фиксации позиции<br>\n                    4. Настройте параметры<br>\n                    5. Нажмите "Применить"<br>\n                    Горячие клавиши: R - вращение, ESC - отмена фиксации</p>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return;this.propertiesElement.querySelector("#imageFileSelect")?.addEventListener("click",()=>this.fileInput.click()),this.propertiesElement.querySelector("#imageSize")?.addEventListener("input",e=>{this.imageSize=parseFloat(e.target.value)||50,this.updateImagePreview()}),this.propertiesElement.querySelector("#imageDepth")?.addEventListener("input",e=>{this.imageDepth=parseFloat(e.target.value)||.1,this.updateImagePreview()}),this.propertiesElement.querySelector("#keepAspectRatio")?.addEventListener("change",e=>{this.keepAspectRatio=e.target.checked,this.updateImagePreview()}),this.propertiesElement.querySelector("#isTransparent")?.addEventListener("change",e=>{this.isTransparent=e.target.checked,this.imageMaterial&&(this.imageMaterial.transparent=this.isTransparent,this.imageMaterial.needsUpdate=!0),this.previewMaterial&&(this.previewMaterial.transparent=this.isTransparent,this.previewMaterial.needsUpdate=!0),this.updateImagePreview()});const e=this.propertiesElement.querySelector("#imageOpacity"),t=this.propertiesElement.querySelector("#opacityValue");e&&t&&e.addEventListener("input",e=>{this.opacity=parseInt(e.target.value)/100,t.textContent=`${e.target.value}%`,this.imageMaterial&&(this.imageMaterial.opacity=this.opacity,this.imageMaterial.needsUpdate=!0),this.previewMaterial&&(this.previewMaterial.opacity=.7*this.opacity,this.previewMaterial.needsUpdate=!0),this.updateImagePreview()});const i=this.propertiesElement.querySelector("#imageRotation"),a=this.propertiesElement.querySelector("#rotationValue");i&&a&&i.addEventListener("input",e=>{const t=parseInt(e.target.value);this.rotation=t*(Math.PI/180),a.textContent=`${t}°`,this.updateImagePreview()}),this.propertiesElement.querySelector("#imageCreateBtn")?.addEventListener("click",()=>this.createFinalImage()),this.propertiesElement.querySelector("#imageClearBtn")?.addEventListener("click",()=>{this.clear(),this.editor.showStatus("Изображение сброшено","info")})}updateImagePreview(){if(this.loadedImage&&this.isFixed&&this.tempImage){const e=this.tempImage.position.clone();this.clearTempImage(),this.showImagePreview(e)}}updateApplyButtonState(){const e=this.propertiesElement?.querySelector("#imageCreateBtn");e&&(e.disabled=!(this.isFixed&&this.loadedImage))}updateImageFileName(e){const t=this.propertiesElement?.querySelector("#imageFileName");t&&(e?(t.textContent=e,t.style.color="#4CAF50"):(t.textContent="Файл не выбран",t.style.color="#888"))}updateCoordinates(e){e&&(document.getElementById("coords").textContent=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}, Z: ${e.z.toFixed(2)}`)}handleDrop(e){e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;if(t.length>0){const e=t[0];if(this.supportedFormats.includes(e.type)){const t=new FileReader;t.onload=t=>{this.imageURL=t.target.result,this.loadImageTexture(this.imageURL,e.name),this.updateImageFileName(e.name)},t.readAsDataURL(e)}else this.editor.showStatus(`Неподдерживаемый формат: ${e.type}`,"error")}}clear(){this.clearTempImage(),this.updateImageFileName(null),this.currentImage=null,this.isPlacing=!1,this.loadedImage=null,this.imageURL=null,this.isFixed=!1,this.updateApplyButtonState()}}