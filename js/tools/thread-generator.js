class ThreadGenerator{constructor(e){this.editor=e,this.threadStandards={metric:{name:"Метрическая",standards:{M3:{diameter:3,pitch:.5,minorDiameter:2.459,threadAngle:60},M4:{diameter:4,pitch:.7,minorDiameter:3.242,threadAngle:60},M5:{diameter:5,pitch:.8,minorDiameter:4.134,threadAngle:60},M6:{diameter:6,pitch:1,minorDiameter:4.917,threadAngle:60},M8:{diameter:8,pitch:1.25,minorDiameter:6.647,threadAngle:60},M10:{diameter:10,pitch:1.5,minorDiameter:8.376,threadAngle:60},M12:{diameter:12,pitch:1.75,minorDiameter:10.106,threadAngle:60},M14:{diameter:14,pitch:2,minorDiameter:11.835,threadAngle:60},M16:{diameter:16,pitch:2,minorDiameter:13.835,threadAngle:60},M20:{diameter:20,pitch:2.5,minorDiameter:17.294,threadAngle:60},M24:{diameter:24,pitch:3,minorDiameter:20.752,threadAngle:60}}},inch:{name:"Дюймовая (UNC)",standards:{"1/4-20":{diameter:6.35,pitch:1.27,minorDiameter:5.08,threadAngle:60},"5/16-18":{diameter:7.94,pitch:1.41,minorDiameter:6.48,threadAngle:60},"3/8-16":{diameter:9.53,pitch:1.59,minorDiameter:7.94,threadAngle:60},"1/2-13":{diameter:12.7,pitch:1.95,minorDiameter:10.92,threadAngle:60},"3/4-10":{diameter:19.05,pitch:2.54,minorDiameter:16.41,threadAngle:60},"1-8":{diameter:25.4,pitch:3.18,minorDiameter:22.23,threadAngle:60}}},trapezoidal:{name:"Трапецеидальная",standards:{"Tr8x1.5":{diameter:8,pitch:1.5,minorDiameter:6.2,threadAngle:30},Tr10x2:{diameter:10,pitch:2,minorDiameter:7.5,threadAngle:30},Tr12x3:{diameter:12,pitch:3,minorDiameter:8.5,threadAngle:30},Tr16x4:{diameter:16,pitch:4,minorDiameter:11.5,threadAngle:30},Tr20x4:{diameter:20,pitch:4,minorDiameter:15.5,threadAngle:30},Tr24x5:{diameter:24,pitch:5,minorDiameter:18.5,threadAngle:30}}},pipe:{name:"Трубная (BSP)",standards:{"G1/8":{diameter:9.73,pitch:.907,minorDiameter:8.85,threadAngle:55},"G1/4":{diameter:13.16,pitch:1.337,minorDiameter:11.89,threadAngle:55},"G3/8":{diameter:16.66,pitch:1.337,minorDiameter:15.39,threadAngle:55},"G1/2":{diameter:20.96,pitch:1.814,minorDiameter:19.17,threadAngle:55},"G3/4":{diameter:26.44,pitch:1.814,minorDiameter:24.65,threadAngle:55},G1:{diameter:33.25,pitch:2.309,minorDiameter:30.92,threadAngle:55}}},custom:{name:"Произвольная",standards:{}}},this.defaultParams={type:"metric",standard:"M10",diameter:10,pitch:1.5,minorDiameter:8.376,threadAngle:60,length:30,direction:"right",threadType:"external",quality:"medium",wallThickness:5}}generateThreadProfile(e){const t=[],r=THREE.MathUtils.degToRad(e.threadAngle/2),a=(e.diameter-e.minorDiameter)/2,n=e.pitch/2;if("metric"===e.type||"inch"===e.type){const i=.125*e.pitch,d=n-i;t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(-i,-a/2+d*Math.tan(r))),t.push(new THREE.Vector2(i,a/2)),t.push(new THREE.Vector2(n-i,-a/2+d*Math.tan(r))),t.push(new THREE.Vector2(n,-a/2))}else if("trapezoidal"===e.type){const r=.25*e.pitch,i=.25*e.pitch,d=.25*e.pitch*Math.tan(THREE.MathUtils.degToRad(15));t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(-n+i,-a/2)),t.push(new THREE.Vector2(-r/2,a/2-d)),t.push(new THREE.Vector2(-r/2,a/2)),t.push(new THREE.Vector2(r/2,a/2)),t.push(new THREE.Vector2(r/2,a/2-d)),t.push(new THREE.Vector2(n-i,-a/2)),t.push(new THREE.Vector2(n,-a/2))}else if("pipe"===e.type){const e=.25*a,r=12;t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(-n+e,-a/2));for(let n=1;n<r;n++){const i=n/(r-1),d=Math.PI*i,o=e*Math.cos(d),l=a/2-e+e*Math.sin(d);t.push(new THREE.Vector2(o,l))}t.push(new THREE.Vector2(n-e,-a/2)),t.push(new THREE.Vector2(n,-a/2))}else t.push(new THREE.Vector2(-n,-a/2)),t.push(new THREE.Vector2(0,a/2)),t.push(new THREE.Vector2(n,-a/2));return{points:t,height:a}}createThread(e={}){const t={...this.defaultParams,...e},r={low:{segmentsPerTurn:16,radialSegments:8},medium:{segmentsPerTurn:32,radialSegments:16},high:{segmentsPerTurn:64,radialSegments:32}},a=r[t.quality]||r.medium,n=this.generateThreadProfile(t),i=n.points,d=n.height,o=t.diameter/2,l=t.minorDiameter/2;return"external"===t.threadType?this.createExternalThread(t,i,d,o,l,a):this.createInternalThread(t,i,d,o,l,a)}createExternalThread(e,t,r,a,n,i){const d=e.length,o=Math.ceil(d/e.pitch),l=o*i.segmentsPerTurn,s=t.length,h=[],c=[],m=[],u=[],p=[];for(let i=0;i<=l;i++){const h=i/l,m=h*o*Math.PI*2,g=h*d,y="right"===e.direction?1:-1;for(let e=0;e<s;e++){const d=t[e],o=n+(d.y+r/2)*((a-n)/r),h=Math.cos(m*y)*o,E=g+d.x,f=Math.sin(m*y)*o;c.push(h,E,f);const T=new THREE.Vector3(Math.cos(m*y),0,Math.sin(m*y)).normalize();u.push(T.x,T.y,T.z),p.push(i/l,e/(s-1))}}for(let e=0;e<l;e++)for(let t=0;t<s-1;t++){const r=e*s+t,a=e*s+(t+1),n=(e+1)*s+t,i=(e+1)*s+(t+1);m.push(r,a,i),m.push(r,i,n)}const g=new THREE.BufferGeometry;g.setAttribute("position",new THREE.Float32BufferAttribute(c,3)),g.setAttribute("normal",new THREE.Float32BufferAttribute(u,3)),g.setAttribute("uv",new THREE.Float32BufferAttribute(p,2)),g.setIndex(m),h.push(g);const y=this.createCylinderBufferGeometry(n,n,d,i.radialSegments,d/2);h.push(y);const E=this.createRingBufferGeometry(0,n,i.radialSegments,0,d,0,-Math.PI/2,0,0);h.push(E);const f=this.createRingBufferGeometry(0,n,i.radialSegments,0,0,0,Math.PI/2,0,0);h.push(f);const T=this.mergeGeometries(h),v=new THREE.MeshStandardMaterial({color:12632256,roughness:.5,metalness:.6,side:THREE.FrontSide,flatShading:!1}),b=new THREE.Mesh(T,v);return b.castShadow=!0,b.receiveShadow=!0,b.userData={type:"thread",threadType:"external",threadParams:e,name:`Наружная резьба ${e.standard||e.diameter+"мм"}`,createdAt:(new Date).toISOString(),isSingleMesh:!0},b}createInternalThread(e,t,r,a,n,i){const d=a+(e.wallThickness||5),o=e.length,l=Math.ceil(o/e.pitch),s=l*i.segmentsPerTurn,h=t.length,c=[],m=[],u=[],p=[],g=[];for(let i=0;i<=s;i++){const d=i/s,c=d*l*Math.PI*2,u=d*o,y="right"===e.direction?1:-1;for(let e=0;e<h;e++){const d=t[e],o=a+(d.y+r/2)*((n-a)/r),l=Math.cos(c*y)*o,E=u+d.x,f=Math.sin(c*y)*o;m.push(l,E,f);const T=new THREE.Vector3(-Math.cos(c*y),0,-Math.sin(c*y)).normalize();p.push(T.x,T.y,T.z),g.push(i/s,e/(h-1))}}for(let e=0;e<s;e++)for(let t=0;t<h-1;t++){const r=e*h+t,a=e*h+(t+1),n=(e+1)*h+t,i=(e+1)*h+(t+1);u.push(r,i,a),u.push(r,n,i)}const y=new THREE.BufferGeometry;y.setAttribute("position",new THREE.Float32BufferAttribute(m,3)),y.setAttribute("normal",new THREE.Float32BufferAttribute(p,3)),y.setAttribute("uv",new THREE.Float32BufferAttribute(g,2)),y.setIndex(u),c.push(y);const E=this.createCylinderBufferGeometry(d,d,o,i.radialSegments,o/2);c.push(E);const f=this.createCylinderBufferGeometry(n,n,o,i.radialSegments,o/2),T=f.attributes.normal.array;for(let e=0;e<T.length;e+=3)T[e]*=-1,T[e+1]*=-1,T[e+2]*=-1;c.push(f);const v=this.createRingBufferGeometry(n,d,i.radialSegments,0,o,0,-Math.PI/2,0,0);c.push(v);const b=this.createRingBufferGeometry(n,d,i.radialSegments,0,0,0,Math.PI/2,0,0);c.push(b);const w=this.mergeGeometries(c),M=new THREE.MeshStandardMaterial({color:8421504,roughness:.5,metalness:.3,side:THREE.DoubleSide,flatShading:!1}),x=new THREE.Mesh(w,M);return x.castShadow=!0,x.receiveShadow=!0,x.userData={type:"thread",threadType:"internal",threadParams:e,name:`Внутренняя резьба ${e.standard||e.diameter+"мм"}`,createdAt:(new Date).toISOString(),isSingleMesh:!0},x}createCylinderBufferGeometry(e,t,r,a,n=0){const i=new THREE.CylinderBufferGeometry(e,t,r,a),d=i.attributes.position.array;for(let e=0;e<d.length;e+=3)d[e+1]+=n;return i}createCircleBufferGeometry(e,t,r=0,a=0,n=0,i=0,d=0,o=0){const l=new THREE.CircleBufferGeometry(e,t),s=new THREE.Matrix4;return s.makeRotationFromEuler(new THREE.Euler(i,d,o)),s.setPosition(r,a,n),l.applyMatrix4(s),l}createRingBufferGeometry(e,t,r,a=0,n=0,i=0,d=0,o=0,l=0){const s=new THREE.RingBufferGeometry(e,t,r),h=new THREE.Matrix4;return h.makeRotationFromEuler(new THREE.Euler(d,o,l)),h.setPosition(a,n,i),s.applyMatrix4(h),s}mergeGeometries(e){const t=new THREE.BufferGeometry,r=[],a=[],n=[],i=[];let d=0;return e.forEach(e=>{if(!e||!e.attributes.position)return;const t=e.attributes.position.array;for(let e=0;e<t.length;e+=3)r.push(t[e],t[e+1],t[e+2]);const o=e.attributes.normal?e.attributes.normal.array:null;if(o)for(let e=0;e<o.length;e+=3)a.push(o[e],o[e+1],o[e+2]);else for(let e=0;e<t.length;e+=3)a.push(0,0,0);const l=e.attributes.uv?e.attributes.uv.array:null;if(l)for(let e=0;e<l.length;e+=2)n.push(l[e],l[e+1]);else for(let e=0;e<t.length/3;e++)n.push(0,0);if(e.index){const t=e.index.array;for(let e=0;e<t.length;e++)i.push(t[e]+d)}d+=t.length/3}),t.setAttribute("position",new THREE.Float32BufferAttribute(r,3)),t.setAttribute("normal",new THREE.Float32BufferAttribute(a,3)),t.setAttribute("uv",new THREE.Float32BufferAttribute(n,2)),i.length>0&&t.setIndex(i),t.computeVertexNormals(),t.computeBoundingBox(),t.computeBoundingSphere(),t}showThreadUI(){const e=document.createElement("div");e.innerHTML='\n            <div class="modal-overlay active" id="threadModal">\n                <div class="modal-content" style="width: 550px;">\n                    <div class="modal-header">\n                        <h4><i class="fas fa-screwdriver"></i> Генератор резьбы</h4>\n                        <button class="close-modal">&times;</button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Тип резьбы:</label>\n                                <select id="threadType" class="modal-select">\n                                    <option value="metric">Метрическая</option>\n                                    <option value="inch">Дюймовая (UNC)</option>\n                                    <option value="trapezoidal">Трапецеидальная</option>\n                                    <option value="pipe">Трубная (BSP)</option>\n                                    <option value="custom">Произвольная</option>\n                                </select>\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Стандарт:</label>\n                                <select id="threadStandard" class="modal-select">\n                                    \x3c!-- Заполнится динамически --\x3e\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Тип:</label>\n                                <select id="threadDirectionType" class="modal-select">\n                                    <option value="external">Наружная</option>\n                                    <option value="internal">Внутренняя</option>\n                                </select>\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Направление:</label>\n                                <select id="threadDirection" class="modal-select">\n                                    <option value="right">Правая</option>\n                                    <option value="left">Левая</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Диаметр (мм):</label>\n                                <input type="number" id="threadDiameter" min="1" max="100" step="0.1" value="10" class="modal-input">\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Шаг (мм):</label>\n                                <input type="number" id="threadPitch" min="0.1" max="10" step="0.1" value="1.5" class="modal-input">\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Длина (мм):</label>\n                                <input type="number" id="threadLength" min="1" max="200" value="30" class="modal-input">\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Угол профиля (°):</label>\n                                <input type="number" id="threadAngle" min="10" max="80" value="60" class="modal-input">\n                            </div>\n                        </div>\n\n                        <div class="form-row" id="wallThicknessRow" style="display: none;">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Толщина стенки (мм):</label>\n                                <input type="number" id="threadWallThickness" min="1" max="50" step="0.5" value="5" class="modal-input">\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Качество:</label>\n                                <select id="threadQuality" class="modal-select">\n                                    <option value="low">Низкое</option>\n                                    <option value="medium" selected>Среднее</option>\n                                    <option value="high">Высокое</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class="form-group">\n                            <div id="threadPreview" style="height: 200px; background: #2a2a2a; border-radius: 5px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #888;">\n                                <i class="fas fa-screwdriver fa-3x"></i>\n                            </div>\n                        </div>\n\n                        <div class="info-box" style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;">\n                            <strong>Справка:</strong>\n                            <ul style="margin: 5px 0; padding-left: 20px;">\n                                <li>Метрическая: ISO, DIN, ГОСТ</li>\n                                <li>Дюймовая: UNC (Unified National Coarse)</li>\n                                <li>Трапецеидальная: Tr, для ходовых винтов</li>\n                                <li>Трубная: BSP (British Standard Pipe)</li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" id="cancelThread">Отмена</button>\n                        <button class="btn btn-primary" id="createThread">Создать</button>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(e),this.populateThreadStandards(),document.querySelector("#threadModal .close-modal").addEventListener("click",()=>{document.querySelector("#threadModal").remove()}),document.getElementById("cancelThread").addEventListener("click",()=>{document.querySelector("#threadModal").remove()}),document.getElementById("createThread").addEventListener("click",()=>{this.createThreadFromUI()}),document.getElementById("threadDirectionType").addEventListener("change",()=>{const e="internal"===document.getElementById("threadDirectionType").value;document.getElementById("wallThicknessRow").style.display=e?"flex":"none",this.updateThreadPreview()}),document.getElementById("threadType").addEventListener("change",()=>{this.populateThreadStandards(),this.updateThreadParamsFromStandard()}),document.getElementById("threadStandard").addEventListener("change",()=>{this.updateThreadParamsFromStandard()}),document.querySelectorAll("#threadModal .modal-input, #threadModal .modal-select").forEach(e=>{e.addEventListener("change",()=>{this.updateThreadPreview()})}),this.updateThreadPreview()}populateThreadStandards(){const e=document.getElementById("threadType").value,t=document.getElementById("threadStandard");t.innerHTML="";const r=this.threadStandards[e].standards;if("custom"===e){const e=document.createElement("option");e.value="custom",e.textContent="Произвольная резьба",t.appendChild(e),document.querySelectorAll(".modal-input").forEach(e=>{e.disabled=!1})}else document.querySelectorAll(".modal-input").forEach(e=>{e.disabled=!1}),document.getElementById("threadDiameter").disabled=!0,document.getElementById("threadPitch").disabled=!0,document.getElementById("threadAngle").disabled=!0,Object.keys(r).forEach(e=>{const r=document.createElement("option");r.value=e,r.textContent=e,t.appendChild(r)}),Object.keys(r).length>0&&(t.value=Object.keys(r)[0],this.updateThreadParamsFromStandard())}updateThreadParamsFromStandard(){const e=document.getElementById("threadType").value,t=document.getElementById("threadStandard").value;if("custom"===e||!this.threadStandards[e].standards[t])return;const r=this.threadStandards[e].standards[t];document.getElementById("threadDiameter").value=r.diameter.toFixed(2),document.getElementById("threadPitch").value=r.pitch.toFixed(2),document.getElementById("threadAngle").value=r.threadAngle||60,this.updateThreadPreview()}createThreadFromUI(){const e={type:document.getElementById("threadType").value,standard:document.getElementById("threadStandard").value,diameter:parseFloat(document.getElementById("threadDiameter").value),pitch:parseFloat(document.getElementById("threadPitch").value),threadAngle:parseFloat(document.getElementById("threadAngle").value),length:parseFloat(document.getElementById("threadLength").value),direction:document.getElementById("threadDirection").value,threadType:document.getElementById("threadDirectionType").value,quality:document.getElementById("threadQuality").value,minorDiameter:0};if("internal"===e.threadType&&(e.wallThickness=parseFloat(document.getElementById("threadWallThickness").value)||5),"metric"===e.type||"inch"===e.type?e.minorDiameter=e.diameter-1.082532*e.pitch:"trapezoidal"===e.type?e.minorDiameter=e.diameter-1.5*e.pitch:"pipe"===e.type?e.minorDiameter=e.diameter-.960491*e.pitch:e.minorDiameter=e.diameter-1.2*e.pitch,e.diameter<=0||e.pitch<=0||e.length<=0)return void alert("Некорректные параметры резьбы");if(e.pitch>e.diameter/2&&!confirm("Шаг резьбы слишком большой для данного диаметра. Продолжить?"))return;const t=this.createThread(e);this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.selectObject(t),this.editor.history.addAction({type:"create",object:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),document.querySelector("#threadModal").remove();const r="external"===e.threadType?"наружную":"внутреннюю";this.editor.showStatus(`Создана ${r} резьба ${e.diameter}мм, шаг ${e.pitch}мм`,"success")}updateThreadPreview(){const e=document.getElementById("threadPreview"),t=document.getElementById("threadDiameter").value,r=document.getElementById("threadPitch").value,a=document.getElementById("threadLength").value,n="internal"===document.getElementById("threadDirectionType").value;let i="";if(n){i=`<br><small>Толщина стенки: ${document.getElementById("threadWallThickness")?.value||"5"}мм</small>`}e.innerHTML=`\n            <div style="text-align: center; color: #ccc;">\n                <i class="fas fa-${n?"circle":"screwdriver"} fa-3x"></i><br>\n                <div style="margin-top: 10px;">\n                    <strong>${n?"Внутренняя":"Наружная"} резьба</strong><br>\n                    <small>Ø${t}мм, шаг ${r}мм, длина ${a}мм${i}</small>\n                </div>\n            </div>\n        `}createThreadOnCylinder(e,t){const r={...t,diameter:2*e.geometry.parameters.radiusTop,length:e.geometry.parameters.height},a=this.createThread(r);return a.position.copy(e.position),a.rotation.copy(e.rotation),a}exportThreadSpecs(e){if(!e.userData||!e.userData.threadParams)return null;const t=e.userData.threadParams;return{type:t.type,standard:t.standard,diameter:t.diameter,pitch:t.pitch,minorDiameter:t.minorDiameter,length:t.length,direction:t.direction,threadType:t.threadType,quality:t.quality,volume:this.calculateThreadVolume(t)}}calculateThreadVolume(e){const t=Math.PI*Math.pow(e.diameter/2,2);Math.PI,Math.pow(e.minorDiameter/2,2);if("external"===e.threadType)return t*e.length;{const t=e.diameter/2+(e.wallThickness||5);return(Math.PI*Math.pow(t,2)-Math.PI*Math.pow(e.diameter/2,2))*e.length}}}