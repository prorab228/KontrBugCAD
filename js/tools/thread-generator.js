class ThreadGenerator{constructor(e){this.editor=e,this.threadStandards={metric:{name:"Метрическая",standards:{M3:{diameter:3,pitch:.5,minorDiameter:2.459,threadAngle:60},M4:{diameter:4,pitch:.7,minorDiameter:3.242,threadAngle:60},M5:{diameter:5,pitch:.8,minorDiameter:4.134,threadAngle:60},M6:{diameter:6,pitch:1,minorDiameter:4.917,threadAngle:60},M8:{diameter:8,pitch:1.25,minorDiameter:6.647,threadAngle:60},M10:{diameter:10,pitch:1.5,minorDiameter:8.376,threadAngle:60},M12:{diameter:12,pitch:1.75,minorDiameter:10.106,threadAngle:60},M14:{diameter:14,pitch:2,minorDiameter:11.835,threadAngle:60},M16:{diameter:16,pitch:2,minorDiameter:13.835,threadAngle:60},M20:{diameter:20,pitch:2.5,minorDiameter:17.294,threadAngle:60},M24:{diameter:24,pitch:3,minorDiameter:20.752,threadAngle:60}}},inch:{name:"Дюймовая (UNC)",standards:{"1/4-20":{diameter:6.35,pitch:1.27,minorDiameter:5.08,threadAngle:60},"5/16-18":{diameter:7.94,pitch:1.41,minorDiameter:6.48,threadAngle:60},"3/8-16":{diameter:9.53,pitch:1.59,minorDiameter:7.94,threadAngle:60},"1/2-13":{diameter:12.7,pitch:1.95,minorDiameter:10.92,threadAngle:60},"3/4-10":{diameter:19.05,pitch:2.54,minorDiameter:16.41,threadAngle:60},"1-8":{diameter:25.4,pitch:3.18,minorDiameter:22.23,threadAngle:60}}},trapezoidal:{name:"Трапецеидальная",standards:{"Tr8x1.5":{diameter:8,pitch:1.5,minorDiameter:6.2,threadAngle:30},Tr10x2:{diameter:10,pitch:2,minorDiameter:7.5,threadAngle:30},Tr12x3:{diameter:12,pitch:3,minorDiameter:8.5,threadAngle:30},Tr16x4:{diameter:16,pitch:4,minorDiameter:11.5,threadAngle:30},Tr20x4:{diameter:20,pitch:4,minorDiameter:15.5,threadAngle:30},Tr24x5:{diameter:24,pitch:5,minorDiameter:18.5,threadAngle:30}}},pipe:{name:"Трубная (BSP)",standards:{"G1/8":{diameter:9.73,pitch:.907,minorDiameter:8.85,threadAngle:55},"G1/4":{diameter:13.16,pitch:1.337,minorDiameter:11.89,threadAngle:55},"G3/8":{diameter:16.66,pitch:1.337,minorDiameter:15.39,threadAngle:55},"G1/2":{diameter:20.96,pitch:1.814,minorDiameter:19.17,threadAngle:55},"G3/4":{diameter:26.44,pitch:1.814,minorDiameter:24.65,threadAngle:55},G1:{diameter:33.25,pitch:2.309,minorDiameter:30.92,threadAngle:55}}},custom:{name:"Произвольная",standards:{}}},this.defaultParams={type:"metric",standard:"M10",diameter:10,pitch:1.5,minorDiameter:8.376,threadAngle:60,length:30,direction:"right",threadType:"external",chamfer:!1,chamferAngle:45,segmentsPerTurn:32,quality:"medium"}}generateThreadProfile(e){const t=[],a=THREE.MathUtils.degToRad(e.threadAngle/2),r=(e.diameter-e.minorDiameter)/2,n=e.pitch/2;if("metric"===e.type||"inch"===e.type){const i=.125*e.pitch;t.push(new THREE.Vector2(-n,-r/2));const d=n-i;t.push(new THREE.Vector2(-i,-r/2+d*Math.tan(a))),t.push(new THREE.Vector2(i,r/2)),t.push(new THREE.Vector2(n-i,-r/2+d*Math.tan(a))),t.push(new THREE.Vector2(n,-r/2))}else if("trapezoidal"===e.type){const a=.25*e.pitch,i=.25*e.pitch,d=.25*e.pitch*Math.tan(THREE.MathUtils.degToRad(15));t.push(new THREE.Vector2(-n,-r/2)),t.push(new THREE.Vector2(-n+i,-r/2)),t.push(new THREE.Vector2(-a/2,r/2-d)),t.push(new THREE.Vector2(-a/2,r/2)),t.push(new THREE.Vector2(a/2,r/2)),t.push(new THREE.Vector2(a/2,r/2-d)),t.push(new THREE.Vector2(n-i,-r/2)),t.push(new THREE.Vector2(n,-r/2))}else if("pipe"===e.type){const e=.25*r,a=12;t.push(new THREE.Vector2(-n,-r/2)),t.push(new THREE.Vector2(-n+e,-r/2));for(let n=1;n<a;n++){const i=n/(a-1),d=Math.PI*i,o=e*Math.cos(d),s=r/2-e+e*Math.sin(d);t.push(new THREE.Vector2(o,s))}t.push(new THREE.Vector2(n-e,-r/2)),t.push(new THREE.Vector2(n,-r/2))}else t.push(new THREE.Vector2(-n,-r/2)),t.push(new THREE.Vector2(0,r/2)),t.push(new THREE.Vector2(n,-r/2));return{points:t,height:r}}createExternalThreadGeometry(e){const t={low:{segmentsPerTurn:16,radialSegments:8},medium:{segmentsPerTurn:32,radialSegments:16},high:{segmentsPerTurn:64,radialSegments:32}},a=t[e.quality]||t.medium,r=this.generateThreadProfile(e),n=r.points,i=r.height,d=Math.ceil(e.length/e.pitch),o=e.diameter/2,s=e.minorDiameter/2,l=e.length,h=new THREE.BufferGeometry,c=[],m=[],u=[],p=[],g=n.length,y=d*a.segmentsPerTurn,E="right"===e.direction?1:-1;for(let t=0;t<=y;t++){const a=t/y,r=a*d*Math.PI*2,o=a*e.length;for(let e=0;e<g;e++){const a=n[e],d=s+(a.y+i/2),l=Math.cos(r*E)*d,h=o+a.x,u=Math.sin(r*E)*d;c.push(l,h,u);const v=new THREE.Vector3(Math.cos(r*E),0,Math.sin(r*E)).normalize();m.push(v.x,v.y,v.z),p.push(t/y,e/(g-1))}}for(let e=0;e<y;e++)for(let t=0;t<g-1;t++){const a=e*g+t,r=e*g+(t+1),n=(e+1)*g+t,i=(e+1)*g+(t+1);u.push(a,r,i),u.push(a,i,n)}return this.addExternalEndCaps(h,c,m,u,p,s,o,l,a.radialSegments,n,i),h.setAttribute("position",new THREE.Float32BufferAttribute(c,3)),h.setAttribute("normal",new THREE.Float32BufferAttribute(m,3)),h.setAttribute("uv",new THREE.Float32BufferAttribute(p,2)),h.setIndex(u),h.computeVertexNormals(),h.computeBoundingBox(),h.computeBoundingSphere(),h}createInternalThreadGeometry(e){const t={low:{segmentsPerTurn:16,radialSegments:8},medium:{segmentsPerTurn:32,radialSegments:16},high:{segmentsPerTurn:64,radialSegments:32}},a=t[e.quality]||t.medium,r=this.generateThreadProfile(e),n=r.points,i=r.height,d=Math.ceil(e.length/e.pitch),o=e.diameter/2,s=(e.minorDiameter,1.5*o),l=e.length,h=new THREE.BufferGeometry,c=[],m=[],u=[],p=[],g=n.length,y=d*a.segmentsPerTurn,E="right"===e.direction?1:-1;this.addCylinderSurface(h,c,m,u,p,s,l,a.radialSegments,!0);const v=c.length/3;for(let t=0;t<=y;t++){const a=t/y,r=a*d*Math.PI*2,s=a*e.length;for(let e=0;e<g;e++){const a=n[e],d=o-(a.y+i/2),l=Math.cos(r*E)*d,h=s+a.x,u=Math.sin(r*E)*d;c.push(l,h,u);const v=new THREE.Vector3(-Math.cos(r*E),0,-Math.sin(r*E)).normalize();m.push(v.x,v.y,v.z),p.push(t/y,e/(g-1))}}for(let e=0;e<y;e++)for(let t=0;t<g-1;t++){const a=v+e*g+t,r=v+e*g+(t+1),n=v+(e+1)*g+t,i=v+(e+1)*g+(t+1);u.push(a,i,r),u.push(a,n,i)}return this.addInternalEndCaps(h,c,m,u,p,s,o,l,a.radialSegments,n,i),h.setAttribute("position",new THREE.Float32BufferAttribute(c,3)),h.setAttribute("normal",new THREE.Float32BufferAttribute(m,3)),h.setAttribute("uv",new THREE.Float32BufferAttribute(p,2)),h.setIndex(u),h.computeVertexNormals(),h.computeBoundingBox(),h.computeBoundingSphere(),h}addCylinderSurface(e,t,a,r,n,i,d,o,s=!0){const l=o,h=t.length/3;for(let e=0;e<=l;e++){const r=e/l*Math.PI*2,o=Math.cos(r)*i,s=Math.sin(r)*i;t.push(o,d,s),a.push(Math.cos(r),0,Math.sin(r)),n.push(e/l,1),t.push(o,0,s),a.push(Math.cos(r),0,Math.sin(r)),n.push(e/l,0)}const c=h;for(let e=0;e<l;e++){const t=c+2*e,a=c+2*e+1,n=c+2*(e+1),i=c+2*(e+1)+1;s?(r.push(t,n,a),r.push(a,n,i)):(r.push(t,a,i),r.push(t,i,n))}}addExternalEndCaps(e,t,a,r,n,i,d,o,s,l,h){const c=s,m=t.length/3;for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,d=Math.cos(r)*i,s=Math.sin(r)*i,l=o;t.push(d,l,s),a.push(0,1,0),n.push(e/c,0)}for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,i=Math.cos(r)*d,s=Math.sin(r)*d,l=o;t.push(i,l,s),a.push(0,1,0),n.push(e/c,1)}for(let e=0;e<c;e++){const t=m+e,a=m+e+1,n=m+c+1+e,i=m+c+1+e+1;r.push(t,n,a),r.push(a,n,i)}const u=t.length/3;for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,d=Math.cos(r)*i,o=Math.sin(r)*i,s=0;t.push(d,s,o),a.push(0,-1,0),n.push(e/c,0)}for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,i=Math.cos(r)*d,o=Math.sin(r)*d,s=0;t.push(i,s,o),a.push(0,-1,0),n.push(e/c,1)}for(let e=0;e<c;e++){const t=u+e,a=u+e+1,n=u+c+1+e,i=u+c+1+e+1;r.push(t,a,n),r.push(a,i,n)}}addInternalEndCaps(e,t,a,r,n,i,d,o,s,l,h){const c=s,m=t.length/3;for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,d=Math.cos(r)*i,s=Math.sin(r)*i,l=o;t.push(d,l,s),a.push(0,1,0),n.push(e/c,1)}for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,i=Math.cos(r)*d,s=Math.sin(r)*d,l=o;t.push(i,l,s),a.push(0,1,0),n.push(e/c,0)}for(let e=0;e<c;e++){const t=m+e,a=m+e+1,n=m+c+1+e,i=m+c+1+e+1;r.push(t,n,a),r.push(a,n,i)}const u=t.length/3;for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,d=Math.cos(r)*i,o=Math.sin(r)*i,s=0;t.push(d,s,o),a.push(0,-1,0),n.push(e/c,1)}for(let e=0;e<=c;e++){const r=e/c*Math.PI*2,i=Math.cos(r)*d,o=Math.sin(r)*d,s=0;t.push(i,s,o),a.push(0,-1,0),n.push(e/c,0)}for(let e=0;e<c;e++){const t=u+e,a=u+e+1,n=u+c+1+e,i=u+c+1+e+1;r.push(t,a,n),r.push(a,i,n)}}createThread(e={}){const t={...this.defaultParams,...e};let a,r;a="external"===t.threadType?this.createExternalThreadGeometry(t):this.createInternalThreadGeometry(t),r=new THREE.MeshStandardMaterial({color:"external"===t.threadType?12632256:8421504,roughness:.5,metalness:"external"===t.threadType?.6:.3,side:THREE.FrontSide,flatShading:!1});const n=new THREE.Mesh(a,r);return n.castShadow=!0,n.receiveShadow=!0,n.position.y=t.length/2,n.userData={type:"thread",threadType:t.threadType,threadParams:t,name:`${"external"===t.threadType?"Наружная":"Внутренняя"} резьба ${t.standard||t.diameter+"мм"}`,createdAt:(new Date).toISOString()},n}showThreadUI(){const e=document.createElement("div");e.innerHTML='\n            <div class="modal-overlay active" id="threadModal">\n                <div class="modal-content" style="width: 550px;">\n                    <div class="modal-header">\n                        <h4><i class="fas fa-screwdriver"></i> Генератор резьбы</h4>\n                        <button class="close-modal">&times;</button>\n                    </div>\n                    <div class="modal-body">\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Тип резьбы:</label>\n                                <select id="threadType" class="modal-select">\n                                    <option value="metric">Метрическая</option>\n                                    <option value="inch">Дюймовая (UNC)</option>\n                                    <option value="trapezoidal">Трапецеидальная</option>\n                                    <option value="pipe">Трубная (BSP)</option>\n                                    <option value="custom">Произвольная</option>\n                                </select>\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Стандарт:</label>\n                                <select id="threadStandard" class="modal-select">\n                                    \x3c!-- Заполнится динамически --\x3e\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Тип:</label>\n                                <select id="threadDirectionType" class="modal-select">\n                                    <option value="external">Наружная</option>\n                                    <option value="internal">Внутренняя</option>\n                                </select>\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Направление:</label>\n                                <select id="threadDirection" class="modal-select">\n                                    <option value="right">Правая</option>\n                                    <option value="left">Левая</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Диаметр (мм):</label>\n                                <input type="number" id="threadDiameter" min="1" max="100" step="0.1" value="10" class="modal-input">\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Шаг (мм):</label>\n                                <input type="number" id="threadPitch" min="0.1" max="10" step="0.1" value="1.5" class="modal-input">\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Длина (мм):</label>\n                                <input type="number" id="threadLength" min="1" max="200" value="30" class="modal-input">\n                            </div>\n\n                            <div class="form-group" style="flex: 1;">\n                                <label>Угол профиля (°):</label>\n                                <input type="number" id="threadAngle" min="10" max="80" value="60" class="modal-input">\n                            </div>\n                        </div>\n\n                        <div class="form-row">\n                            <div class="form-group" style="flex: 1;">\n                                <label>Качество:</label>\n                                <select id="threadQuality" class="modal-select">\n                                    <option value="low">Низкое</option>\n                                    <option value="medium" selected>Среднее</option>\n                                    <option value="high">Высокое</option>\n                                </select>\n                            </div>\n                        </div>\n\n                        <div class="form-group">\n                            <div id="threadPreview" style="height: 200px; background: #2a2a2a; border-radius: 5px; margin: 10px 0; display: flex; align-items: center; justify-content: center; color: #888;">\n                                <i class="fas fa-screwdriver fa-3x"></i>\n                            </div>\n                        </div>\n\n                        <div class="info-box" style="background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;">\n                            <strong>Справка:</strong>\n                            <ul style="margin: 5px 0; padding-left: 20px;">\n                                <li>Метрическая: ISO, DIN, ГОСТ</li>\n                                <li>Дюймовая: UNC (Unified National Coarse)</li>\n                                <li>Трапецеидальная: Tr, для ходовых винтов</li>\n                                <li>Трубная: BSP (British Standard Pipe)</li>\n                            </ul>\n                        </div>\n                    </div>\n                    <div class="modal-footer">\n                        <button class="btn btn-secondary" id="cancelThread">Отмена</button>\n                        <button class="btn btn-primary" id="createThread">Создать</button>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(e),this.populateThreadStandards(),document.querySelector("#threadModal .close-modal").addEventListener("click",()=>{document.querySelector("#threadModal").remove()}),document.getElementById("cancelThread").addEventListener("click",()=>{document.querySelector("#threadModal").remove()}),document.getElementById("createThread").addEventListener("click",()=>{this.createThreadFromUI()}),document.getElementById("threadType").addEventListener("change",()=>{this.populateThreadStandards(),this.updateThreadParamsFromStandard()}),document.getElementById("threadStandard").addEventListener("change",()=>{this.updateThreadParamsFromStandard()}),document.getElementById("threadDirectionType").addEventListener("change",()=>{this.updateThreadPreview()}),document.querySelectorAll("#threadModal .modal-input, #threadModal .modal-select").forEach(e=>{e.addEventListener("change",()=>{this.updateThreadPreview()})}),this.updateThreadPreview()}populateThreadStandards(){const e=document.getElementById("threadType").value,t=document.getElementById("threadStandard");t.innerHTML="";const a=this.threadStandards[e].standards;if("custom"===e){const e=document.createElement("option");e.value="custom",e.textContent="Произвольная резьба",t.appendChild(e),document.querySelectorAll(".modal-input").forEach(e=>{e.disabled=!1})}else document.querySelectorAll(".modal-input").forEach(e=>{e.disabled=!1}),document.getElementById("threadDiameter").disabled=!0,document.getElementById("threadPitch").disabled=!0,document.getElementById("threadAngle").disabled=!0,Object.keys(a).forEach(e=>{const a=document.createElement("option");a.value=e,a.textContent=e,t.appendChild(a)}),Object.keys(a).length>0&&(t.value=Object.keys(a)[0],this.updateThreadParamsFromStandard())}updateThreadParamsFromStandard(){const e=document.getElementById("threadType").value,t=document.getElementById("threadStandard").value;if("custom"===e||!this.threadStandards[e].standards[t])return;const a=this.threadStandards[e].standards[t];document.getElementById("threadDiameter").value=a.diameter.toFixed(2),document.getElementById("threadPitch").value=a.pitch.toFixed(2),document.getElementById("threadAngle").value=a.threadAngle||60,this.updateThreadPreview()}createThreadFromUI(){const e={type:document.getElementById("threadType").value,standard:document.getElementById("threadStandard").value,diameter:parseFloat(document.getElementById("threadDiameter").value),pitch:parseFloat(document.getElementById("threadPitch").value),threadAngle:parseFloat(document.getElementById("threadAngle").value),length:parseFloat(document.getElementById("threadLength").value),direction:document.getElementById("threadDirection").value,threadType:document.getElementById("threadDirectionType").value,quality:document.getElementById("threadQuality").value,chamfer:!1,chamferAngle:45,minorDiameter:0};if("metric"===e.type||"inch"===e.type?e.minorDiameter=e.diameter-1.082532*e.pitch:"trapezoidal"===e.type?e.minorDiameter=e.diameter-1.5*e.pitch:"pipe"===e.type?e.minorDiameter=e.diameter-.960491*e.pitch:e.minorDiameter=e.diameter-1.2*e.pitch,e.diameter<=0||e.pitch<=0||e.length<=0)return void alert("Некорректные параметры резьбы");if(e.pitch>e.diameter/2&&!confirm("Шаг резьбы слишком большой для данного диаметра. Продолжить?"))return;const t=this.createThread(e);this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.selectSingleObject(t),this.editor.history.addAction({type:"create",object:t.uuid,data:this.editor.projectManager.serializeObjectForHistory(t)}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),document.querySelector("#threadModal").remove();const a="external"===e.threadType?"наружную":"внутреннюю";this.editor.showStatus(`Создана ${a} резьба ${e.diameter}мм, шаг ${e.pitch}мм`,"success")}updateThreadPreview(){const e=document.getElementById("threadPreview"),t=document.getElementById("threadDiameter").value,a=document.getElementById("threadPitch").value,r=document.getElementById("threadLength").value,n=document.getElementById("threadDirectionType").value;e.innerHTML=`\n            <div style="text-align: center; color: #ccc;">\n                <i class="fas fa-${"external"===n?"screwdriver":"circle"} fa-3x"></i><br>\n                <div style="margin-top: 10px;">\n                    <strong>${"external"===n?"Наружная":"Внутренняя"} резьба</strong><br>\n                    <small>Ø${t}мм, шаг ${a}мм, длина ${r}мм</small>\n                </div>\n            </div>\n        `}createThreadOnCylinder(e,t){const a={...t,diameter:2*e.geometry.parameters.radiusTop,length:e.geometry.parameters.height},r=this.createThread(a);return r.position.copy(e.position),r.rotation.copy(e.rotation),r}exportThreadSpecs(e){if(!e.userData||!e.userData.threadParams)return null;const t=e.userData.threadParams;return{type:t.type,standard:t.standard,diameter:t.diameter,pitch:t.pitch,minorDiameter:t.minorDiameter,length:t.length,direction:t.direction,threadType:t.threadType,quality:t.quality,volume:this.calculateThreadVolume(t)}}calculateThreadVolume(e){const t=Math.PI*Math.pow(e.diameter/2,2),a=Math.PI*Math.pow(e.minorDiameter/2,2);return"external"===e.threadType?(t-a)*e.length:t*e.length}}