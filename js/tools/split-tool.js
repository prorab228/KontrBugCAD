class SplitTool extends Tool{constructor(e){super("split","fa-cut",e),this.requiresSelection=!0,this.splitMode=null,this.selectedPlane=null,this.tempVisuals=[],this.splitPlane=null}onActivate(){if(!this.canActivate())return void this.editor.toolManager.restorePreviousTool();if(1!==this.editor.selectedObjects.length)return this.editor.showStatus("Для разрезания выберите ровно один объект","error"),void this.editor.toolManager.restorePreviousTool();const e=this.editor.selectedObjects[0];if("work_plane"===e.userData.type||"sketch_plane"===e.userData.type)return this.editor.showStatus("Нельзя разрезать плоскость","error"),void this.editor.toolManager.restorePreviousTool();this.splitMode="select_plane",this.selectedPlane=null,this.editor.showStatus("Выберите рабочую плоскость для разрезания (ESC - отмена)","info")}onDeactivate(){this.cleanup(),document.body.style.cursor="default"}onMouseDown(e){if(0!==e.button||!this.splitMode)return!1;if(this.editor.updateMousePosition(e),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera),"select_plane"===this.splitMode){const e=[...this.editor.workPlanes,...this.editor.sketchPlanes],t=this.editor.raycaster.intersectObjects(e,!0);if(t.length>0){const e=t[0].object;return this.selectedPlane=e,this.splitMode="confirm",this.createSplitVisualization(e),this.editor.showStatus("Нажмите Enter для разрезания, ESC для отмены","info"),!0}}return!1}createSplitVisualization(e){this.cleanupVisualization();const t=this.editor.selectedObjects[0],i=(new THREE.Box3).setFromObject(t),s=new THREE.Vector3;i.getSize(s);const o=new THREE.PlaneGeometry(1.5*s.x,1.5*s.y),r=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.3,side:THREE.DoubleSide});this.splitPlane=new THREE.Mesh(o,r),this.splitPlane.position.copy(e.position),this.splitPlane.quaternion.copy(e.quaternion),this.splitPlane.userData.isSplitPlane=!0,this.editor.scene.add(this.splitPlane),this.tempVisuals.push(this.splitPlane);const a=new THREE.EdgesGeometry(o),n=new THREE.LineBasicMaterial({color:16711680,linewidth:2}),l=new THREE.LineSegments(a,n);l.position.copy(e.position),l.quaternion.copy(e.quaternion),l.userData.isSplitHelper=!0,this.editor.scene.add(l),this.tempVisuals.push(l)}performSplit(){if(!this.selectedPlane||1!==this.editor.selectedObjects.length)return void this.editor.showStatus("Не выбрана плоскость для разрезания","error");const e=this.editor.selectedObjects[0],t=this.selectedPlane;try{const i=this.cutWithCSG(e,t);i&&i.positive&&i.negative?(this.removeObject(e),this.addObject(i.positive,"положительная часть"),this.addObject(i.negative,"отрицательная часть"),this.editor.history.addAction({type:"delete",objects:[{uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)}]}),this.editor.history.addAction({type:"create",object:i.positive.uuid,data:this.editor.projectManager.serializeObjectForHistory(i.positive)}),this.editor.history.addAction({type:"create",object:i.negative.uuid,data:this.editor.projectManager.serializeObjectForHistory(i.negative)}),this.editor.clearSelection(),this.editor.showStatus("Объект разрезан на 2 части","success")):this.editor.showStatus("Не удалось разрезать объект","error")}catch(e){console.error("Split error:",e),this.editor.showStatus(`Ошибка разрезания: ${e.message}`,"error")}finally{this.cleanup(),this.editor.toolManager.setCurrentTool("select")}}cutWithCSG(e,t){if(!this.editor.booleanOps)throw new Error("Библиотека булевых операций не загружена");const i=new THREE.Vector3(0,0,1).applyQuaternion(t.quaternion).normalize(),s=t.position.clone(),o=(new THREE.Box3).setFromObject(e),r=new THREE.Vector3;o.getSize(r);const a=Math.max(r.x,r.y,r.z),n=this.createHalfSpace(i,s,!0,a),l=this.createHalfSpace(i,s,!1,a),c=this.editor.booleanOps.intersect(e,n),h=this.editor.booleanOps.intersect(e,l);return n.geometry&&n.geometry.dispose(),l.geometry&&l.geometry.dispose(),{positive:c,negative:h}}createHalfSpace(e,t,i,s){const o=10*s,r=new THREE.BoxGeometry(o,o,o),a=new THREE.Mesh(r,new THREE.MeshBasicMaterial),n=e.clone().multiplyScalar(i?o/2:-o/2);return a.position.copy(t.clone().add(n)),a.lookAt(t.clone().add(e)),a}removeObject(e){this.editor.objectsGroup.remove(e);const t=this.editor.objects.indexOf(e);t>-1&&this.editor.objects.splice(t,1);const i=e.userData?.type;if("sketch_plane"===i){const t=this.editor.sketchPlanes.indexOf(e);t>-1&&this.editor.sketchPlanes.splice(t,1)}else if("work_plane"===i){const t=this.editor.workPlanes.indexOf(e);t>-1&&this.editor.workPlanes.splice(t,1)}}addObject(e,t){e.userData={...e.userData,name:`${e.userData?.name||"Объект"} (${t})`,isSplitPart:!0,createdAt:(new Date).toISOString()},this.editor.objectsGroup.add(e),this.editor.objects.push(e)}onKeyDown(e){return"Escape"===e.key?(this.cleanup(),this.editor.toolManager.setCurrentTool("select"),!0):"Enter"===e.key&&"confirm"===this.splitMode&&(this.performSplit(),!0)}cleanupVisualization(){this.tempVisuals.forEach(e=>{e.parent&&e.parent.remove(e),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.tempVisuals=[],this.splitPlane=null}cleanup(){this.cleanupVisualization(),this.splitMode=null,this.selectedPlane=null}}