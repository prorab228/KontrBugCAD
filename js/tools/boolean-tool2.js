class BooleanTool extends Tool{constructor(t,e){super(`boolean-${e}`,BooleanTool.getIcon(e),t),this.operation=e,this.minObjects=2,this.previewResult=null,this.previewGroup=new THREE.Group,this.editor.scene.add(this.previewGroup),this.originalMaterials=new Map,this.propertiesElement=null,this.subtractFirst=null,this.subtractSecond=null}static getIcon(t){return{union:"fa-plus-circle",subtract:"fa-minus-circle",intersect:"fa-times-circle"}[t]||"fa-object-group"}getOperationName(){return{union:"объединения",subtract:"вычитания",intersect:"пересечения"}[this.operation]||this.operation}async onActivate(){this.canActivate()?(this.createPropertiesSection(),"subtract"===this.operation?this._initSubtractFromSelection():this.editor.selectedObjects.length>=this.minObjects?this._startPreview():this.editor.showStatus(`Выберите объекты для ${this.getOperationName()}. Enter – подтвердить, Esc – отмена.`,"info")):this.editor.toolManager.restorePreviousTool()}_initSubtractFromSelection(){const t=this.editor.selectedObjects;1===t.length?(this.subtractFirst=t[0],this.subtractSecond=null,this._setObjectsDim([this.subtractFirst],{color:65280,opacity:.5,emissive:8704}),this.editor.showStatus("Кликните на объект, который хотите вычесть","info")):t.length>=2?(this.subtractFirst=t[0],this.subtractSecond=t[1],this.editor.clearSelection(!1),this.editor.selectSingleObject(this.subtractFirst),this.editor.toggleObjectSelection(this.subtractSecond),this._setObjectsDim([this.subtractFirst],{color:65280,opacity:.5,emissive:8704}),this._setObjectsDim([this.subtractSecond],{color:16711680,opacity:.5,emissive:2228224}),this._startPreview()):(this.subtractFirst=null,this.subtractSecond=null,this.editor.clearSelection(!1),this.editor.showStatus("Выберите уменьшаемое тело (кликните на объект)","info")),this._updatePropertiesPanel()}onDeactivate(){this._exit(),this.removePropertiesSection()}_startPreview(){this._getOperands().length<this.minObjects||this._updatePreview()}_updatePreview(){this._clearPreview();const t=this._getOperands();if(t.length<this.minObjects)return void this._updatePropertiesPanel();const e=this.editor.booleanOps.canPerformOperation("subtract"===this.operation||"intersect"===this.operation?t.slice(0,2):t);if(!e.can)return this.editor.showStatus(e.reason,"error"),void this._updatePropertiesPanel();this._setObjectsDim(t,{color:8947848,opacity:.2,emissive:0});try{let e;const i=new THREE.MeshStandardMaterial({color:16755200,transparent:!0,opacity:.6,flatShading:!0});"union"===this.operation?e=this.editor.booleanOps.unionMultiple(t,!1,i):"subtract"===this.operation?e=this.editor.booleanOps.subtract(t[0],t[1],!1,i):"intersect"===this.operation&&(e=this.editor.booleanOps.intersect(t[0],t[1],!1,i)),e&&(e.renderOrder=10,this.previewGroup.add(e),this.previewResult=e)}catch(t){console.error("Preview error:",t),this.editor.showStatus(`Ошибка предпросмотра: ${t.message}`,"error")}this._updatePropertiesPanel()}_clearPreview(){this.previewResult&&(this.previewGroup.remove(this.previewResult),this.previewResult.geometry&&this.previewResult.geometry.dispose(),this.previewResult.material&&(Array.isArray(this.previewResult.material)?this.previewResult.material.forEach(t=>t.dispose()):this.previewResult.material.dispose()),this.previewResult=null),this.originalMaterials.forEach((t,e)=>{this._restoreObjectMaterial(e,t)}),this.originalMaterials.clear()}_setObjectsDim(t,e={color:8947848,opacity:.3,emissive:0}){t.forEach(t=>{if(t&&t.material){if(!this.originalMaterials.has(t)){const e=Array.isArray(t.material)?t.material.map(t=>t.clone()):t.userData.originalMaterial.clone();this.originalMaterials.set(t,e)}Array.isArray(t.material)?t.material.forEach(t=>{t.color.setHex(e.color),t.emissive&&t.emissive.setHex(e.emissive),t.opacity=e.opacity,t.transparent=!0,t.depthWrite=!1,t.needsUpdate=!0}):(t.material.color.setHex(e.color),t.material.emissive&&t.material.emissive.setHex(e.emissive),t.material.opacity=e.opacity,t.material.transparent=!0,t.material.depthWrite=!1,t.material.needsUpdate=!0)}})}_restoreObjectMaterial(t,e){t.material&&(Array.isArray(t.material)&&Array.isArray(e)?t.material.forEach((t,i)=>t.copy(e[i])):Array.isArray(t.material)||Array.isArray(e)||t.material.copy(e),t.material.needsUpdate=!0)}_getOperands(){return"subtract"===this.operation?this.subtractFirst&&this.subtractSecond?[this.subtractFirst,this.subtractSecond]:[]:this.editor.selectedObjects}async _confirmOperation(){this._getOperands().length<this.minObjects?this.editor.showStatus(`Недостаточно объектов для ${this.getOperationName()}`,"error"):(await this._performBooleanOperation(),this._exit(),this.editor.toolManager.restorePreviousTool())}_exit(){this._clearPreview(),"subtract"===this.operation&&(this.subtractFirst=null,this.subtractSecond=null)}_getRootObjectAtMouse(){const t=[];this.editor.scene.traverse(e=>{e.isMesh&&t.push(e)});const e=this.editor.raycaster.intersectObjects(t,!1);if(0===e.length)return null;for(const t of e){let e=t.object;for(;e;){if(this.editor.parametricModel.objectMap.has(e.uuid)){const t=e.userData?.type;if(!(e.userData?.isHelper||["grid","axis","grid_helper","axes_helper","base_plane"].includes(t))&&e.visible)return e}e=e.parent}}return null}onMouseDown(t){if(0!==t.button)return!1;this.editor.updateMousePosition(t),this.editor.raycaster.setFromCamera(this.editor.mouse,this.editor.camera);const e=this._getRootObjectAtMouse();return!!e&&("subtract"===this.operation?this._handleSubtractClick(e):this._handleGenericClick(e,t.ctrlKey))}_handleGenericClick(t,e){return!!this.isActive&&(this.editor.toggleObjectSelection(t),this.editor.selectedObjects.length>=this.minObjects?this._startPreview():this._clearPreview(),this._updatePropertiesPanel(),!0)}_handleSubtractClick(t){return!!this.isActive&&(this.subtractFirst?t===this.subtractFirst?(this.editor.showStatus("Это уменьшаемое тело. Чтобы изменить его, начните заново (Esc)","warning"),!0):(this.subtractSecond=t,this.editor.clearSelection(!1),this.editor.selectSingleObject(this.subtractFirst),this.editor.toggleObjectSelection(this.subtractSecond),this._clearPreview(),this._setObjectsDim([this.subtractFirst],{color:65280,opacity:.5,emissive:8704}),this._setObjectsDim([this.subtractSecond],{color:16711680,opacity:.5,emissive:2228224}),this._startPreview(),this._updatePropertiesPanel(),!0):(this.subtractFirst=t,this.subtractSecond=null,this.editor.clearSelection(!1),this.editor.selectSingleObject(t),this._setObjectsDim([t],{color:65280,opacity:.5,emissive:8704}),this.editor.showStatus("Кликните на объект, который хотите вычесть","info"),this._updatePropertiesPanel(),!0))}onKeyDown(t){return"Escape"===t.key?(this._exit(),this.editor.toolManager.restorePreviousTool(),!0):"Enter"===t.key&&(this._confirmOperation(),!0)}async _performBooleanOperation(){if(!this.editor.booleanOps)return void this.editor.showStatus("Булевы операции не инициализированы","error");const t=this._getOperands(),e=this.editor.booleanOps.canPerformOperation("subtract"===this.operation||"intersect"===this.operation?t.slice(0,2):t);if(e.can){this.showLoadingIndicator(`Выполняется ${this.getOperationName()}...`);try{const e=`boolean_${this.operation}`,i=t.map(t=>t.uuid),s=new ParametricOperation(e,{},i);this.editor.parametricModel.addOperation(s),this.hideLoadingIndicator(),this.editor.showStatus(`Операция "${this.getOperationName()}" завершена`,"success")}catch(t){this.hideLoadingIndicator(),console.error(`${this.operation} error:`,t),this.editor.showStatus(`Ошибка ${this.getOperationName()}: ${t.message}`,"error")}}else this.editor.showStatus(e.reason,"error")}createPropertiesSection(){const t=document.getElementById("propertiesContent");t&&(this.removePropertiesSection(),this.propertiesElement=document.createElement("div"),this.propertiesElement.className="property-group",this.propertiesElement.setAttribute("data-tool","boolean-tool"),this.propertiesElement.innerHTML=this.getPropertiesHTML(),t.appendChild(this.propertiesElement),this.bindPropertiesEvents())}removePropertiesSection(){const t=document.querySelector('.property-group[data-tool="boolean-tool"]');t&&t.remove(),this.propertiesElement=null}getPropertiesHTML(){const t=this.getOperationName();let e="",i="";if("subtract"===this.operation){const t=(this.subtractFirst?1:0)+(this.subtractSecond?1:0);e=this.subtractFirst?this.subtractSecond?"Предпросмотр":"Выберите вычитаемое тело":"Выберите уменьшаемое тело",i=`Выбрано объектов: ${t}`}else{e=`Выбрано объектов: ${this.editor.selectedObjects.length}`,i=""}return`\n            <div class="property-group" data-type="boolean-settings">\n                <h4>БУЛЕВА ОПЕРАЦИЯ: ${t.toUpperCase()}</h4>\n                <div class="property-row">\n                    <label>Статус:</label>\n                    <span id="booleanStage">${e}</span>\n                </div>\n                ${i?`<div class="property-row"><span id="booleanSelectedInfo">${i}</span></div>`:""}\n                <div class="property-buttons">\n                    <button id="booleanApplyBtn" class="btn-primary"  ${this._getOperands().length<this.minObjects?"disabled":""}>\n                        <i class="fas fa-check"></i> Применить\n                    </button>\n                    <button id="booleanCancelBtn" class="btn-secondary">\n                        <i class="fas fa-times"></i> Отмена\n                    </button>\n                </div>\n                <div class="property-hint">\n                    <p><i class="fas fa-info-circle"></i>\n                    ${"subtract"===this.operation?" Кликните на объект, чтобы выбрать уменьшаемое, затем на другой — вычитаемое.":" Кликните на объекты для выбора (добавить/удалить)."}\n                    После выбора объектов будет показан предпросмотр.\n                    Подтвердите операцию кнопкой или клавишей Enter.</p>\n                </div>\n            </div>\n        `}bindPropertiesEvents(){if(!this.propertiesElement)return;const t=this.propertiesElement.querySelector("#booleanApplyBtn");t&&t.addEventListener("click",()=>this._confirmOperation());const e=this.propertiesElement.querySelector("#booleanCancelBtn");e&&e.addEventListener("click",()=>{this._exit(),this.editor.toolManager.restorePreviousTool()})}_updatePropertiesPanel(){if(!this.propertiesElement)return;const t=this.propertiesElement.querySelector("#booleanStage"),e=this.propertiesElement.querySelector("#booleanApplyBtn");if("subtract"===this.operation){let e="";e=this.subtractFirst?this.subtractSecond?"Предпросмотр":"Выберите вычитаемое тело":"Выберите уменьшаемое тело",t&&(t.textContent=e);const i=(this.subtractFirst?1:0)+(this.subtractSecond?1:0),s=this.propertiesElement.querySelector("#booleanSelectedInfo");s&&(s.textContent=`Выбрано объектов: ${i}`)}else{const e=this.editor.selectedObjects.length;t&&(t.textContent=`Выбрано объектов: ${e}`)}e&&(e.disabled=this._getOperands().length<this.minObjects)}showLoadingIndicator(t){let e=document.getElementById("boolLoadingIndicator");if(e)e.querySelector(".message").textContent=t,e.style.display="flex";else if(e=document.createElement("div"),e.id="boolLoadingIndicator",e.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: rgba(0, 0, 0, 0.8);\n                color: white;\n                padding: 20px 30px;\n                border-radius: 8px;\n                z-index: 10001;\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                font-family: Arial, sans-serif;\n            ",e.innerHTML=`\n                <div class="spinner" style="\n                    width: 24px;\n                    height: 24px;\n                    border: 3px solid rgba(255, 255, 255, 0.3);\n                    border-radius: 50%;\n                    border-top-color: #fff;\n                    animation: spin 1s linear infinite;\n                "></div>\n                <div class="message">${t}</div>\n            `,document.body.appendChild(e),!document.querySelector("#boolLoadingStyles")){const t=document.createElement("style");t.id="boolLoadingStyles",t.textContent="@keyframes spin { to { transform: rotate(360deg); } }",document.head.appendChild(t)}}hideLoadingIndicator(){const t=document.getElementById("boolLoadingIndicator");t&&(t.style.display="none")}}class BooleanUnionTool extends BooleanTool{constructor(t){super(t,"union")}}class BooleanSubtractTool extends BooleanTool{constructor(t){super(t,"subtract")}}class BooleanIntersectTool extends BooleanTool{constructor(t){super(t,"intersect")}}