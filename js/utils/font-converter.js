class TTFConverter{constructor(){"undefined"==typeof opentype&&this.loadOpenTypeLibrary(),this.isOpenTypeLoaded=!1,this.loadingPromise=null}loadOpenTypeLibrary(){return new Promise((e,t)=>{if("undefined"!=typeof opentype)return this.isOpenTypeLoaded=!0,void e(!0);const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/opentype.js@1.3.4/dist/opentype.min.js",o.onload=()=>{console.log("OpenType.js loaded successfully"),this.isOpenTypeLoaded=!0,e(!0)},o.onerror=e=>{console.error("Failed to load OpenType.js:",e),t(new Error("Failed to load OpenType.js library"))},document.head.appendChild(o)})}async convertTTFtoThreeJS(e,t={}){try{this.isOpenTypeLoaded||(this.loadingPromise||(this.loadingPromise=this.loadOpenTypeLibrary()),await this.loadingPromise);const o=await this.readFileAsArrayBuffer(e),n=await opentype.parse(o),s=this.parseFontToThreeFormat(n,t);return{success:!0,fontName:n.names.fontFamily.en||e.name.replace(".ttf","").replace(".TTF",""),fontData:s,glyphCount:Object.keys(s.glyphs).length}}catch(e){return console.error("Error converting TTF to Three.js format:",e),{success:!1,error:e.message}}}readFileAsArrayBuffer(e){return new Promise((t,o)=>{const n=new FileReader;n.onload=e=>t(e.target.result),n.onerror=e=>o(e),n.readAsArrayBuffer(e)})}parseFontToThreeFormat(e,t){const{includeCyrillic:o=!0,includeLatin:n=!0,curveSegments:s=4,resolution:r=100}=t;let a="";n&&(a+=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~"),o&&(a+="ЁёАБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯабвгдежзийклмнопрстуфхцчшщъыьэюя");const i=e.unitsPerEm||1e3,l=e.tables.hhea.ascender||e.tables.os2.sTypoAscender||800,c=e.tables.hhea.descender||e.tables.os2.sTypoDescender||-200,d=l-c,y=100/d;console.log(`Font metrics: unitsPerEm=${i}, ascender=${l}, descender=${c}, height=${d}, scaleFactor=${y}`);const g={glyphs:{},familyName:e.names.fontFamily.en||e.names.fontFamily[0]||"Custom Font",resolution:r,boundingBox:{yMin:c*y,yMax:l*y,xMin:-50,xMax:50},underlineThickness:(e.tables.post.underlineThickness||50)*y,underlinePosition:(e.tables.post.underlinePosition||-100)*y,conversionSettings:{curveSegments:s,resolution:r,includeCyrillic:o,includeLatin:n,originalUnitsPerEm:i,scaleFactor:y,fontHeight:d}};for(const t of a){const o=e.charToGlyph(t);if(0!==o.index){const e=o.getPath(0,0,i),n=this.convertPathToLinearSegments(e,y,s),r=o.advanceWidth*y,a=e.getBoundingBox(),l=a.x1*y,c=a.x2*y,d=a.y1*y,h=a.y2*y;g.glyphs[t]={x_min:l,x_max:c,y_min:d,y_max:h,ha:r,o:n}}}const h=e.charToGlyph(" ");return h&&(g.glyphs[" "]={x_min:0,x_max:0,y_min:0,y_max:0,ha:h.advanceWidth*y,o:""}),console.log(`Created font with ${Object.keys(g.glyphs).length} glyphs`),g}convertPathToLinearSegments(e,t,o){const n=[];let s=0,r=0;const a=Math.max(2,2*o);for(const o of e.commands)switch(o.type){case"M":s=o.x*t,r=-o.y*t,n.push(`m ${s.toFixed(2)} ${r.toFixed(2)}`);break;case"L":s=o.x*t,r=-o.y*t,n.push(`l ${s.toFixed(2)} ${r.toFixed(2)}`);break;case"C":this.subdivideCubicBezier(s,r,o.x1*t,-o.y1*t,o.x2*t,-o.y2*t,o.x*t,-o.y*t,a,n),s=o.x*t,r=-o.y*t;break;case"Q":this.subdivideQuadraticBezier(s,r,o.x1*t,-o.y1*t,o.x*t,-o.y*t,a,n),s=o.x*t,r=-o.y*t;break;case"Z":n.push("z")}return n.join(" ")}subdivideQuadraticBezier(e,t,o,n,s,r,a,i){for(let l=1;l<=a;l++){const c=l/a,d=1-c,y=d*d*e+2*d*c*o+c*c*s,g=d*d*t+2*d*c*n+c*c*r;i.push(`l ${y.toFixed(2)} ${g.toFixed(2)}`)}}subdivideCubicBezier(e,t,o,n,s,r,a,i,l,c){for(let d=1;d<=l;d++){const y=d/l,g=1-y,h=g*g*g*e+3*g*g*y*o+3*g*y*y*s+y*y*y*a,p=g*g*g*t+3*g*g*y*n+3*g*y*y*r+y*y*y*i;c.push(`l ${h.toFixed(2)} ${p.toFixed(2)}`)}}validateFontData(e){if(!e.glyphs||0===Object.keys(e.glyphs).length)throw new Error("Нет глифов в шрифте");const t=["A","a","B","C","H","M","O","S","Т","е","о","а"];for(const o of t)e.glyphs[o]||console.warn(`Отсутствует символ: ${o}`);const o=e.glyphs.H||e.glyphs.A||e.glyphs.a;if(o){const t=o.y_max-o.y_min;console.log(`Высота тестового символа: ${t.toFixed(2)} единиц`),e.conversionSettings?console.log(`Качество: ${e.conversionQuality||"не указано"}, ScaleFactor: ${e.conversionSettings.scaleFactor}`):console.log("conversionSettings отсутствуют в fontData"),(t<50||t>150)&&console.warn(`Высота шрифта (${t.toFixed(2)}) далека от ожидаемых 100 единиц`)}return!0}createThreeFont(e){return new THREE.Font(e)}saveFontToLocalStorage(e,t){try{const o=JSON.stringify(t),n=new Blob([o]).size,s=5242880;if(console.log(`Размер шрифта ${e}: ${n} байт`),n>s){console.warn(`Шрифт ${e} слишком большой (${n} байт). Сохранение пропущено.`);const o=this.optimizeFontData(t),r=new Blob([JSON.stringify(o)]).size;if(!(r<=s))return this.editor?.showStatus?.("Шрифт слишком большой для сохранения. Используется только в текущей сессии.","warning"),!1;console.log(`Оптимизированный размер: ${r} байт`),t=o}let r;try{r=JSON.parse(localStorage.getItem("custom_fonts")||"{}")}catch(e){r={}}let a=0;for(const[e,t]of Object.entries(r)){const e=JSON.stringify(t);a+=new Blob([e]).size}const i=new Blob([JSON.stringify(t)]).size;if(a+i>10485760){console.warn("Превышен общий лимит localStorage. Удалите старые шрифты."),this.cleanupOldFonts(5242880),a=0,r=JSON.parse(localStorage.getItem("custom_fonts")||"{}");for(const[e,t]of Object.entries(r)){const e=JSON.stringify(t);a+=new Blob([e]).size}if(a+i>10485760)return this.editor?.showStatus?.("Превышен лимит хранилища. Удалите старые шрифты.","error"),!1}return r[e]=t,localStorage.setItem("custom_fonts",JSON.stringify(r)),console.log(`Шрифт ${e} сохранен в localStorage (Качество: ${t.conversionQuality||"не указано"})`),!0}catch(e){return console.error("Error saving font to localStorage:",e),this.editor?.showStatus?.("Не удалось сохранить шрифт. Используется только в текущей сессии.","warning"),!1}}optimizeFontData(e){const t=JSON.parse(JSON.stringify(e));return Object.keys(t.glyphs).forEach(e=>{const o=t.glyphs[e];o.x_min=parseFloat(o.x_min.toFixed(1)),o.x_max=parseFloat(o.x_max.toFixed(1)),o.y_min=parseFloat(o.y_min.toFixed(1)),o.y_max=parseFloat(o.y_max.toFixed(1)),o.ha=parseFloat(o.ha.toFixed(1)),o.o&&o.o.length>100&&(o.o=o.o.replace(/(\d+\.\d\d)\d+/g,"$1"))}),t}cleanupOldFonts(e){try{let t=JSON.parse(localStorage.getItem("custom_fonts")||"{}");const o=Object.entries(t).map(([e,t])=>({name:e,data:t,size:new Blob([JSON.stringify(t)]).size,date:t.conversionDate||"1970-01-01T00:00:00.000Z"}));o.sort((e,t)=>new Date(e.date)-new Date(t.date));let n=o.reduce((e,t)=>e+t.size,0);const s=[];for(;n>e&&o.length>0;){const e=o.shift();delete t[e.name],n-=e.size,s.push(e.name),console.log(`Удален старый шрифт: ${e.name} (${e.size} байт)`)}localStorage.setItem("custom_fonts",JSON.stringify(t)),s.length>0&&console.log(`Удалено ${s.length} старых шрифтов: ${s.join(", ")}`)}catch(e){console.error("Error cleaning up old fonts:",e)}}loadFontsFromLocalStorage(){try{const e=JSON.parse(localStorage.getItem("custom_fonts")||"{}"),t={};for(const[o,n]of Object.entries(e))try{this.validateFontData(n),t[o]=n}catch(t){console.warn(`Шрифт ${o} поврежден, удаляем из localStorage`,t),delete e[o]}return Object.keys(e).length!==Object.keys(t).length&&localStorage.setItem("custom_fonts",JSON.stringify(e)),t}catch(e){return console.error("Error loading fonts from localStorage:",e),{}}}removeFontFromLocalStorage(e){try{const t=JSON.parse(localStorage.getItem("custom_fonts")||"{}");return delete t[e],localStorage.setItem("custom_fonts",JSON.stringify(t)),!0}catch(e){return console.error("Error removing font from localStorage:",e),!1}}}