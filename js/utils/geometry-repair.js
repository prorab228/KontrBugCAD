import*as THREE from"three";import*as BufferGeometryUtils from"three/addons/utils/BufferGeometryUtils.js";export class GeometryRepair{constructor(e=null){this.booleanOps=e,this.stats={}}repair(e,t={}){const o={mergeDistance:1e-4,minTriangleArea:1e-8,removeDegenerate:!0,removeDuplicates:!0,removeIsolated:!0,removeSmallComponents:!1,minComponentSize:10,closeHoles:!1,fixNormals:!0,checkInfinity:!0,verbose:!1,maxIterations:3,...t};let n=e.clone(),s=0,r=0;for(this.stats={iterations:0,verticesRemoved:0,trianglesRemoved:0,componentsRemoved:0,manifoldRepaired:!1};r<o.maxIterations;){if(r++,o.verbose&&console.log(`\nüîß –†–µ–º–æ–Ω—Ç: –∏—Ç–µ—Ä–∞—Ü–∏—è ${r}`),o.checkInfinity&&this._fixInfinity(n),n.attributes.position.count>0&&BufferGeometryUtils?.mergeVertices){const e=n.attributes.position.count;n=BufferGeometryUtils.mergeVertices(n,o.mergeDistance);const t=e-n.attributes.position.count;this.stats.verticesRemoved+=t,o.verbose&&t>0&&console.log(`  ‚Üí –°–≤–∞—Ä–∫–∞: —É–¥–∞–ª–µ–Ω–æ ${t} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`)}if(o.removeDegenerate&&n.index){const e=this._removeDegenerateTriangles(n,o.minTriangleArea);this.stats.trianglesRemoved+=e,o.verbose&&e>0&&console.log(`  ‚Üí –£–¥–∞–ª–µ–Ω–æ –≤—ã—Ä–æ–∂–¥–µ–Ω–Ω—ã—Ö: ${e}`)}if(o.removeDuplicates&&n.index){const e=this._removeDuplicateTriangles(n);this.stats.trianglesRemoved+=e,o.verbose&&e>0&&console.log(`  ‚Üí –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: ${e}`)}if(o.removeIsolated&&n.index){const e=this._removeIsolatedVertices(n);this.stats.verticesRemoved+=e,o.verbose&&e>0&&console.log(`  ‚Üí –£–¥–∞–ª–µ–Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–µ—Ä—à–∏–Ω: ${e}`)}if(o.removeSmallComponents&&n.index){const e=this._removeSmallComponents(n,o.minComponentSize);this.stats.componentsRemoved+=e,o.verbose&&e>0&&console.log(`  ‚Üí –£–¥–∞–ª–µ–Ω–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤: ${e}`)}const t=n.attributes.position.count;if(t===s){o.verbose&&console.log(`  ‚úÖ –ì–µ–æ–º–µ—Ç—Ä–∏—è —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å –Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ ${r}`);break}if(s=t,0===t)return console.error("  ‚ùå –ì–µ–æ–º–µ—Ç—Ä–∏—è —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π, —Ä–µ–º–æ–Ω—Ç –ø—Ä–µ—Ä–≤–∞–Ω"),e.clone()}if(o.closeHoles&&this.booleanOps&&this.booleanOps.manifold){o.verbose&&console.log("  üîÑ –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Manifold...");const e=this._repairWithManifold(n);e?(n=e,this.stats.manifoldRepaired=!0,o.verbose&&console.log(`  ‚úÖ Manifold –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª –≥–µ–æ–º–µ—Ç—Ä–∏—é: ${n.attributes.position.count} –≤–µ—Ä—à–∏–Ω, ${n.index?n.index.count/3:0} —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤`)):o.verbose&&console.warn("  ‚ö†Ô∏è Manifold –Ω–µ —Å–º–æ–≥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é")}else o.verbose&&o.closeHoles&&console.warn("  ‚ö†Ô∏è Manifold –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (this.booleanOps –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)");return o.fixNormals&&n.computeVertexNormals(),n.computeBoundingBox(),n.computeBoundingSphere(),this.stats.iterations=r,o.verbose&&(console.log(`\n‚úÖ –†–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à—ë–Ω –∑–∞ ${this.stats.iterations} –∏—Ç–µ—Ä–∞—Ü–∏–π`),console.log(`   –í–µ—Ä—à–∏–Ω: ${n.attributes.position.count}`),console.log("   –¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤: "+(n.index?n.index.count/3:0)),this.stats.manifoldRepaired&&console.log("   ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω Manifold")),n}_fixInfinity(e){const t=e.attributes.position;let o=0;for(let e=0;e<t.count;e++){let n=t.getX(e),s=t.getY(e),r=t.getZ(e);isFinite(n)&&!isNaN(n)||(n=0,o++),isFinite(s)&&!isNaN(s)||(s=0,o++),isFinite(r)&&!isNaN(r)||(r=0,o++),t.setXYZ(e,n,s,r)}return o}_removeDegenerateTriangles(e,t){if(!e.index)return 0;const o=e.attributes.position,n=e.index.array,s=[];let r=0;for(let e=0;e<n.length;e+=3){const i=n[e],a=n[e+1],l=n[e+2];if(i===a||i===l||a===l){r++;continue}const c=(new THREE.Vector3).fromBufferAttribute(o,i),f=(new THREE.Vector3).fromBufferAttribute(o,a),u=(new THREE.Vector3).fromBufferAttribute(o,l);.5*f.clone().sub(c).cross(u.clone().sub(c)).length()<t?r++:s.push(i,a,l)}return r>0&&e.setIndex(s),r}_removeDuplicateTriangles(e){if(!e.index)return 0;const t=e.index.array,o=new Set,n=[];let s=0;for(let e=0;e<t.length;e+=3){const r=[t[e],t[e+1],t[e+2]].sort((e,t)=>e-t).join(",");o.has(r)?s++:(o.add(r),n.push(t[e],t[e+1],t[e+2]))}return s>0&&e.setIndex(n),s}_removeIsolatedVertices(e){if(!e.index)return 0;const t=e.attributes.position,o=e.index.array,n=new Set(o),s=t.count;if(n.size===s)return 0;const r=t.array,i=[],a=new Map;let l=0;for(let e=0;e<s;e++)n.has(e)&&(a.set(e,l++),i.push(r[3*e],r[3*e+1],r[3*e+2]));const c=new Uint32Array(o.length);for(let e=0;e<o.length;e++)c[e]=a.get(o[e]);const f=new THREE.BufferGeometry;if(f.setAttribute("position",new THREE.Float32BufferAttribute(i,3)),f.setIndex(new THREE.BufferAttribute(c,1)),e.attributes.normal){const t=e.attributes.normal.array,o=[];for(let e=0;e<s;e++)n.has(e)&&o.push(t[3*e],t[3*e+1],t[3*e+2]);f.setAttribute("normal",new THREE.Float32BufferAttribute(o,3))}return e.dispose(),Object.assign(e,f),s-n.size}_removeSmallComponents(e,t){if(!e.index)return 0;const o=e.index.array,n=e.attributes.position,s=o.length/3,r=Array.from({length:s},()=>[]),i=new Map;for(let e=0;e<s;e++){[o[3*e],o[3*e+1],o[3*e+2]].forEach(t=>{i.has(t)||i.set(t,[]),i.get(t).push(e)})}for(let e=0;e<s;e++){const t=o[3*e],n=o[3*e+1],s=o[3*e+2];[[Math.min(t,n),Math.max(t,n)],[Math.min(n,s),Math.max(n,s)],[Math.min(s,t),Math.max(s,t)]].forEach(t=>{(i.get(t[0])?.filter(e=>{const n=o[3*e],s=o[3*e+1],r=o[3*e+2],i=Math.min(n,s),a=Math.max(n,s),l=Math.min(s,r),c=Math.max(s,r),f=Math.min(r,n),u=Math.max(r,n);return t[0]===i&&t[1]===a||t[0]===l&&t[1]===c||t[0]===f&&t[1]===u})||[]).forEach(t=>{t===e||r[e].includes(t)||r[e].push(t)})})}const a=new Array(s).fill(!1),l=[];for(let e=0;e<s;e++){if(a[e])continue;const t=[e];a[e]=!0;const o=[];for(;t.length;){const e=t.pop();o.push(e),r[e].forEach(e=>{a[e]||(a[e]=!0,t.push(e))})}l.push(o)}if(1===l.length&&l[0].length<t)return 0;const c=l.filter(e=>e.length>=t);if(l.length===c.length)return 0;const f=new Set;if(c.forEach(e=>e.forEach(e=>f.add(e))),0===f.size)return 0;const u=[],m=new Set;for(let e=0;e<s;e++)if(f.has(e)){const t=o[3*e],n=o[3*e+1],s=o[3*e+2];u.push(t,n,s),m.add(t),m.add(n),m.add(s)}const h=n.array,d=[],p=new Map;let g=0;for(let e=0;e<n.count;e++)m.has(e)&&(p.set(e,g++),d.push(h[3*e],h[3*e+1],h[3*e+2]));const b=new Uint32Array(u.length);for(let e=0;e<u.length;e++)b[e]=p.get(u[e]);const v=new THREE.BufferGeometry;if(v.setAttribute("position",new THREE.Float32BufferAttribute(d,3)),v.setIndex(new THREE.BufferAttribute(b,1)),e.attributes.normal){const t=e.attributes.normal.array,o=[];for(let e=0;e<n.count;e++)m.has(e)&&o.push(t[3*e],t[3*e+1],t[3*e+2]);v.setAttribute("normal",new THREE.Float32BufferAttribute(o,3))}return e.dispose(),Object.assign(e,v),l.length-c.length}_repairWithManifold(e){if(!this.booleanOps||"function"!=typeof this.booleanOps._threeGeometryToManifold||"function"!=typeof this.booleanOps._manifoldToThreeGeometry||!this.booleanOps.manifold)return console.warn("this.booleanOps –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–ª–∏ manifold"),null;try{const t=e.clone();let o=this.booleanOps._threeGeometryToManifold(t);if(!o||0===o.numTri())return console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Manifold"),null;if("function"==typeof o.clean&&(o=o.clean(),0===o.numTri()))return console.warn("Manifold.clean() –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç—É—é –≥–µ–æ–º–µ—Ç—Ä–∏—é"),null;const n=this.booleanOps._manifoldToThreeGeometry(o);return!n||n.attributes.position.count<3?(console.warn("–†–µ–∑—É–ª—å—Ç–∞—Ç Manifold —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–µ—Ä—à–∏–Ω"),null):n}catch(e){let t="Manifold repair failed";return e&&e.stack?t+=": "+e.stack:e&&e.message?t+=": "+e.message:t+=": unknown error (e = "+String(e)+")",console.warn(t),null}}}