class HistoryManager{constructor(t,e=50){this.editor=t,this.history=[],this.currentIndex=-1,this.maxSize=e}addAction(t){console.log("=== History addAction ===",t.type,t),this.currentIndex<this.history.length-1&&(this.history=this.history.slice(0,this.currentIndex+1));const e={...this.enhanceActionData(t),id:"act_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),timestamp:(new Date).toISOString()};return this.history.push(e),this.history.length>this.maxSize?this.history.shift():this.currentIndex=this.history.length-1,console.log("History state:",{index:this.currentIndex,total:this.history.length,lastAction:e.type}),this.updateHistoryUI(),e}enhanceActionData(t){switch(t.type){case"create":return this.enhanceCreateAction(t);case"delete":return this.enhanceDeleteAction(t);case"boolean":return this.enhanceBooleanAction(t);case"modify_position":case"modify_scale":case"modify_rotation":case"modify_size":return this.enhanceModifyAction(t);case"modify_position_multiple":return this.enhanceMultipleModifyAction(t);case"import":return this.enhanceImportAction(t);case"group":return this.enhanceGroupAction(t);case"ungroup":return this.enhanceUngroupAction(t);case"sketch_add":case"sketch_delete":return this.enhanceSketchAction(t);default:return t}}enhanceSketchAction(t){if(t.sketchPlaneId&&this.editor.objectsManager){const e=this.editor.findObjectByUuid(t.sketchPlaneId);e&&e.userData&&(e.userData.hasSketch||"sketch_plane"===e.userData.type)&&(t.sketchData=this.serializeSketchState(e))}return t.elements&&Array.isArray(t.elements)&&this.editor.projectManager&&(t.elements=t.elements.map(t=>{if(t.data)return t;const e=this.editor.findObjectByUuid(t.uuid);return e?{uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)}:t})),t}serializeSketchState(t){const e={planeId:t.uuid,planeData:this.editor.projectManager.serializeObject(t),elements:[]};return t.children.forEach(t=>{if(t.userData&&"sketch_element"===t.userData.type){const r=this.editor.projectManager.serializeObjectForHistory(t);r&&e.elements.push({uuid:t.uuid,data:r})}}),e}enhanceMultipleModifyAction(t){if(!t.objects||!Array.isArray(t.objects))return t;const e=t.objects.map(t=>{const e=this.editor.findObjectByUuid(t.uuid);if(!e)return t;const r={...t};return r.previousPosition||(r.previousPosition=e.position.toArray()),r});return{...t,objects:e}}enhanceCreateAction(t){const e=this.editor.findObjectByUuid(t.object);return e&&this.editor.projectManager?{...t,data:this.editor.projectManager.serializeObjectForHistory(e)}:t}enhanceDeleteAction(t){if(!t.objects||!Array.isArray(t.objects))return t;const e=t.objects.map(t=>{const e=this.editor.findObjectByUuid(t.uuid);return e&&this.editor.projectManager?{uuid:e.uuid,data:this.editor.projectManager.serializeObjectForHistory(e)}:t});return{...t,objects:e}}enhanceBooleanAction(t){if(console.log("=== Enhancing boolean action ==="),t.sourceObjects&&!t.originalObjects&&(t.originalObjects=t.sourceObjects.map(t=>{const e=this.editor.findObjectByUuid(t);if(e&&this.editor.projectManager){console.log("Saving original object:",e.uuid,e.userData?.type);const t=this.editor.projectManager.serializeObjectForHistory(e);return{uuid:e.uuid,data:t}}return null}).filter(t=>null!==t)),!t.resultData&&t.result){const e=this.editor.findObjectByUuid(t.result);e&&this.editor.projectManager&&(t.resultData=this.editor.projectManager.serializeObjectForHistory(e))}return t}enhanceModifyAction(t){const e=this.editor.findObjectByUuid(t.object);if(!e)return t;if(t.data.previousPosition||"modify_position"!==t.type||(t.data.previousPosition=e.position.toArray()),t.data.previousScale||"modify_scale"!==t.type||(t.data.previousScale=e.scale.toArray()),!t.data.previousRotation&&"modify_rotation"===t.type){const r=(new THREE.Euler).setFromQuaternion(e.quaternion,"XYZ");t.data.previousRotation=[r.x,r.y,r.z]}if(!t.data.previousDimensions&&"modify_size"===t.type){const r=this.editor.objectsManager.getObjectDimensions(e);t.data.previousDimensions={x:r.x,y:r.y,z:r.z}}return t}enhanceImportAction(t){const e=this.editor.findObjectByUuid(t.object);return e&&this.editor.projectManager?{...t,data:this.editor.projectManager.serializeObjectForHistory(e)}:t}enhanceGroupAction(t){const e=this.editor.findObjectByUuid(t.groupUuid);return e&&this.editor.projectManager?{...t,groupData:this.editor.projectManager.serializeObjectForHistory(e)}:t}enhanceUngroupAction(t){if(t.ungroupedObjects&&Array.isArray(t.ungroupedObjects)){const e=t.ungroupedObjects.map(t=>{const e=this.editor.findObjectByUuid(t.uuid);return e&&this.editor.projectManager?{...t,data:this.editor.projectManager.serializeObjectForHistory(e)}:t});return{...t,ungroupedObjects:e}}return t}undo(){if(this.currentIndex<0)return!1;const t=this.history[this.currentIndex];console.log("=== History undo ===",t.type);try{return this.applyAction(t,!0),this.currentIndex--,this.updateHistoryUI(),!0}catch(t){return console.error("Undo failed:",t),!1}}redo(){if(this.currentIndex>=this.history.length-1)return!1;this.currentIndex++;const t=this.history[this.currentIndex];console.log("=== History redo ===",t.type);try{return this.applyAction(t,!1),this.updateHistoryUI(),!0}catch(t){return console.error("Redo failed:",t),this.currentIndex--,!1}}applyAction(t,e){switch(console.log("Applying action:",{type:t.type,isUndo:e}),t.type){case"create":return e?this.undoCreate(t):this.redoCreate(t);case"delete":return e?this.undoDelete(t):this.redoDelete(t);case"boolean":return e?this.undoBoolean(t):this.redoBoolean(t);case"modify_position":return this.applyModifyPosition(t,e);case"modify_scale":return this.applyModifyScale(t,e);case"modify_rotation":return this.applyModifyRotation(t,e);case"modify_size":return this.applyModifySize(t,e);case"modify_color":return this.applyModifyColor(t,e);case"modify_opacity":return this.applyModifyOpacity(t,e);case"modify_position_multiple":return this.applyModifyPositionMultiple(t,e);case"import":return e?this.undoImport(t):this.redoImport(t);case"group":return e?this.undoGroup(t):this.redoGroup(t);case"ungroup":return e?this.undoUngroup(t):this.redoUngroup(t);case"sketch_add":return e?this.undoSketchAdd(t):this.redoSketchAdd(t);case"sketch_delete":return e?this.undoSketchDelete(t):this.redoSketchDelete(t);default:return console.warn("Unknown action type:",t.type),!1}}undoSketchAdd(t){if(console.log("Undoing sketch add action"),t.elements&&Array.isArray(t.elements)&&t.elements.forEach(t=>{const e=this.editor.findObjectByUuid(t.uuid);e&&this.removeSketchElement(e)}),t.previousSketchState&&this.restoreSketchState(t.previousSketchState),t.sketchPlaneId&&this.editor.sketchManager){const e=this.editor.findObjectByUuid(t.sketchPlaneId);e&&this.editor.sketchManager.detectContoursInSketch(e)}return!0}redoSketchAdd(t){if(console.log("Redoing sketch add action"),t.elements&&Array.isArray(t.elements)){let e=0;if(t.elements.forEach(r=>{if(r.data&&this.editor.projectManager){const i=this.editor.projectManager.deserializeObjectOptimized(r.data);if(i&&t.sketchPlaneId){const r=this.editor.findObjectByUuid(t.sketchPlaneId);r&&(r.add(i),e++)}}}),t.sketchPlaneId&&this.editor.sketchManager&&e>0){const e=this.editor.findObjectByUuid(t.sketchPlaneId);e&&this.editor.sketchManager.detectContoursInSketch(e)}return e>0}return!1}undoSketchDelete(t){if(console.log("Undoing sketch delete action"),t.elements&&Array.isArray(t.elements)){let e=0;if(t.elements.forEach(r=>{if(r.data&&this.editor.projectManager){const i=this.editor.projectManager.deserializeObjectOptimized(r.data);if(i&&t.sketchPlaneId){const r=this.editor.findObjectByUuid(t.sketchPlaneId);r&&(r.add(i),e++)}}}),t.sketchPlaneId&&this.editor.sketchManager&&e>0){const e=this.editor.findObjectByUuid(t.sketchPlaneId);e&&this.editor.sketchManager.detectContoursInSketch(e)}return e>0}return!1}redoSketchDelete(t){if(console.log("Redoing sketch delete action"),t.elements&&Array.isArray(t.elements)){let e=0;if(t.elements.forEach(t=>{const r=this.editor.findObjectByUuid(t.uuid);r&&(this.removeSketchElement(r),e++)}),t.sketchPlaneId&&this.editor.sketchManager&&e>0){const e=this.editor.findObjectByUuid(t.sketchPlaneId);e&&this.editor.sketchManager.detectContoursInSketch(e)}return e>0}return!1}removeSketchElement(t){t.parent&&t.parent.remove(t),t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}restoreSketchState(t){if(!t||!t.planeId)return!1;const e=this.editor.findObjectByUuid(t.planeId);if(!e)return!1;for(let t=e.children.length-1;t>=0;t--){const r=e.children[t];r.userData&&"sketch_element"===r.userData.type&&(e.remove(r),r.geometry&&r.geometry.dispose(),r.material&&r.material.dispose())}return t.elements&&Array.isArray(t.elements)&&t.elements.forEach(t=>{if(t.data&&this.editor.projectManager){const r=this.editor.projectManager.deserializeObjectOptimized(t.data);r&&e.add(r)}}),!0}applyModifyPositionMultiple(t,e){if(!t.objects||!Array.isArray(t.objects))return!1;let r=0;return t.objects.forEach(t=>{const i=this.editor.findObjectByUuid(t.uuid);i&&(e?i.position.fromArray(t.previousPosition||[0,0,0]):i.position.fromArray(t.position||[0,0,0]),r++)}),this.editor.updatePropertiesPanel(),r>0}undoCreate(t){const e=this.editor.findObjectByUuid(t.object);return!!e&&(this.removeObjectFromScene(e),!0)}redoCreate(t){if(!t.data||!this.editor.projectManager)return!1;const e=this.editor.projectManager.deserializeObject(t.data);return!!e&&(this.addObjectToScene(e,!0),!0)}undoDelete(t){if(!t.objects||!Array.isArray(t.objects))return!1;let e=0;return t.objects.forEach(t=>{if(!t.data||!this.editor.projectManager)return;const r=this.editor.projectManager.deserializeObject(t.data);r&&(this.addObjectToScene(r,!1),e++)}),e>0}redoDelete(t){if(!t.objects||!Array.isArray(t.objects))return!1;let e=0;return t.objects.forEach(t=>{const r=this.editor.findObjectByUuid(t.uuid);r&&(this.removeObjectFromScene(r),e++)}),e>0}undoBoolean(t){console.log("Undoing boolean operation:",t.operation);const e=this.editor.findObjectByUuid(t.result);return e&&this.removeObjectFromScene(e),t.originalObjects&&Array.isArray(t.originalObjects)&&t.originalObjects.forEach(t=>{if(!t.data||!this.editor.projectManager)return;const e=this.editor.projectManager.deserializeObject(t.data);e&&this.addObjectToScene(e,!1)}),!0}redoBoolean(t){if(console.log("Redoing boolean operation:",t.operation),t.sourceObjects&&Array.isArray(t.sourceObjects)&&t.sourceObjects.forEach(t=>{const e=this.editor.findObjectByUuid(t);e&&this.removeObjectFromScene(e)}),t.resultData&&this.editor.projectManager){const e=this.editor.projectManager.deserializeObject(t.resultData);if(e)return this.addObjectToScene(e,!0),this.editor.selectObject(e),!0}return!1}applyModifyPosition(t,e){const r=this.editor.findObjectByUuid(t.object);return!!r&&(e?r.position.fromArray(t.data.previousPosition):r.position.fromArray(t.data.position),this.editor.updatePropertiesPanel(),!0)}applyModifyScale(t,e){const r=this.editor.findObjectByUuid(t.object);return!!r&&(e?r.scale.fromArray(t.data.previousScale):r.scale.fromArray(t.data.scale),this.editor.updatePropertiesPanel(),!0)}applyModifyRotation(t,e){const r=this.editor.findObjectByUuid(t.object);return!!r&&(e?r.rotation.fromArray(t.data.previousRotation):r.rotation.fromArray(t.data.rotation),this.editor.updatePropertiesPanel(),!0)}applyModifySize(t,e){const r=this.editor.findObjectByUuid(t.object);return!!r&&(this.editor.transformControls&&(e?this.editor.transformControls.updateObjectSizeDirect(r,t.data.previousDimensions):this.editor.transformControls.updateObjectSizeDirect(r,t.data.dimensions)),this.editor.updatePropertiesPanel(),this.editor.objectsManager.updateSceneStats(),!0)}applyModifyColor(t,e){const r=this.editor.findObjectByUuid(t.object);return!(!r||!r.material)&&(e?this.editor.setObjectColor(r,t.data.previousColor):this.editor.setObjectColor(r,t.data.color),this.editor.updatePropertiesPanel(),!0)}applyModifyOpacity(t,e){const r=this.editor.findObjectByUuid(t.object);return!(!r||!r.material)&&(e?this.editor.setObjectOpacity(r,t.data.previousOpacity):this.editor.setObjectOpacity(r,t.data.opacity),this.editor.updatePropertiesPanel(),!0)}undoImport(t){const e=this.editor.findObjectByUuid(t.object);return!!e&&(this.removeObjectFromScene(e),!0)}redoImport(t){if(!t.data||!this.editor.projectManager)return!1;const e=this.editor.projectManager.deserializeObject(t.data);return!!e&&(this.addObjectToScene(e,!0),this.editor.selectObject(e),!0)}undoGroup(t){const e=this.editor.findObjectByUuid(t.groupUuid);e&&this.removeGroupFromScene(e);let r=0;return t.originalObjects&&Array.isArray(t.originalObjects)&&t.originalObjects.forEach(t=>{if(t.data&&this.editor.projectManager){const e=this.editor.projectManager.deserializeObject(t.data);if(e){if(t.parentUuid){const r=this.editor.findObjectByUuid(t.parentUuid);r?r.add(e):this.editor.objectsGroup.add(e)}else this.editor.objectsGroup.add(e);this.editor.objects.push(e),r++}}}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),r>0}redoGroup(t){if(t.originalObjects&&Array.isArray(t.originalObjects)&&t.originalObjects.forEach(t=>{const e=this.editor.findObjectByUuid(t.uuid);e&&this.removeObjectFromScene(e)}),t.groupData&&this.editor.projectManager){const e=this.editor.projectManager.deserializeObject(t.groupData);if(e)return this.addGroupToScene(e),!0}return!1}undoUngroup(t){t.ungroupedObjects&&Array.isArray(t.ungroupedObjects)&&t.ungroupedObjects.forEach(t=>{const e=this.editor.findObjectByUuid(t.uuid);e&&this.removeObjectFromScene(e)});let e=!1;if(t.groupData&&this.editor.projectManager){const r=this.editor.projectManager.deserializeObject(t.groupData);r&&(this.addGroupToScene(r),r.traverse(t=>{t!==r&&t instanceof THREE.Object3D&&t.updateMatrixWorld(!0)}),e=!0)}return this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),e}redoUngroup(t){const e=this.editor.findObjectByUuid(t.groupUuid);e&&this.removeGroupFromScene(e);let r=0;return t.ungroupedObjects&&Array.isArray(t.ungroupedObjects)&&t.ungroupedObjects.forEach(t=>{if(t.data&&this.editor.projectManager){const e=this.editor.projectManager.deserializeObject(t.data);e&&(this.addObjectToScene(e,!1),r++)}}),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel(),r>0}addGroupToScene(t){this.editor.objectsGroup.add(t),this.editor.objects.push(t),this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(t),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeGroupFromScene(t){t.parent&&t.parent.remove(t);const e=this.editor.objects.indexOf(t);if(e>-1&&this.editor.objects.splice(e,1),this.editor.groups){const e=this.editor.groups.indexOf(t);e>-1&&this.editor.groups.splice(e,1)}const r=this.editor.selectedObjects.indexOf(t);r>-1&&this.editor.selectedObjects.splice(r,1),this.editor.transformControls&&this.editor.transformControls.attachedObject===t&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}addObjectToScene(t,e=!1){this.editor.objectsGroup.add(t),this.editor.objects.push(t),"sketch_plane"===t.userData.type?this.editor.sketchPlanes.push(t):"work_plane"===t.userData.type?this.editor.workPlanes.push(t):"group"===t.userData.type&&(this.editor.groups||(this.editor.groups=[]),this.editor.groups.push(t)),e&&this.editor.selectObject(t),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}removeObjectFromScene(t){t.parent&&t.parent.remove(t);const e=this.editor.objects.indexOf(t);e>-1&&this.editor.objects.splice(e,1);const r=this.editor.selectedObjects.indexOf(t);if(r>-1&&this.editor.selectedObjects.splice(r,1),"sketch_plane"===t.userData.type){const e=this.editor.sketchPlanes.indexOf(t);e>-1&&this.editor.sketchPlanes.splice(e,1)}else if("work_plane"===t.userData.type){const e=this.editor.workPlanes.indexOf(t);e>-1&&this.editor.workPlanes.splice(e,1)}else if("group"===t.userData.type&&this.editor.groups){const e=this.editor.groups.indexOf(t);e>-1&&this.editor.groups.splice(e,1)}"group"===t.userData.type||t.isGroup?t.traverse(e=>{e!==t&&e.isMesh&&this.safeDisposeObject(e)}):this.safeDisposeObject(t),this.editor.transformControls&&this.editor.transformControls.attachedObject===t&&this.editor.transformControls.detach(),this.editor.objectsManager.updateSceneStats(),this.editor.objectsManager.updateSceneList(),this.editor.updatePropertiesPanel()}safeDisposeObject(t){if(t)try{t.geometry&&"function"==typeof t.geometry.dispose&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(t=>{t&&"function"==typeof t.dispose&&t.dispose()}):"function"==typeof t.material.dispose&&t.material.dispose())}catch(t){console.warn("Error disposing object:",t)}}updateHistoryUI(){const t=document.getElementById("historyList");t&&(t.innerHTML="",this.history.forEach((e,r)=>{const i=this.createHistoryItem(e,r);t.appendChild(i)}),t.scrollTop=t.scrollHeight,this.updateUndoRedoButtons())}createHistoryItem(t,e){const r=document.createElement("div");r.className="history-item",r.dataset.index=e,e===this.currentIndex&&r.classList.add("active");const{icon:i,text:o,color:s}=this.getActionInfo(t),n=new Date(t.timestamp).toLocaleTimeString();return r.innerHTML=`\n            <div class="history-item-icon" style="color: ${s};">\n                <i class="${i}"></i>\n            </div>\n            <div class="history-item-content">\n                <div class="history-item-title">${o}</div>\n                <div class="history-item-time">${n}</div>\n            </div>\n        `,r.addEventListener("click",()=>{this.jumpToHistory(e)}),r}getActionInfo(t){return{create:{icon:"fas fa-plus-circle",text:"Создание объекта",color:"#4CAF50"},delete:{icon:"fas fa-trash",text:`Удалено объектов: ${t.objects?.length||1}`,color:"#F44336"},boolean:{icon:"fas fa-shapes",text:`Булева операция: ${t.operation}`,color:"#2196F3"},import:{icon:"fas fa-file-import",text:`Импорт: ${t.data?.userData?.filename||"файл"}`,color:"#FF9800"},modify_position:{icon:"fas fa-arrows-alt",text:"Перемещение",color:"#9C27B0"},modify_scale:{icon:"fas fa-expand-alt",text:"Масштабирование",color:"#3F51B5"},modify_rotation:{icon:"fas fa-sync-alt",text:"Вращение",color:"#00BCD4"},modify_size:{icon:"fas fa-ruler",text:"Изменение размеров",color:"#8BC34A"},modify_position_multiple:{icon:"fas fa-arrows-alt",text:`Перемещение (${t.objects?.length||0} объектов)`,color:"#9C27B0"},modify_color:{icon:"fas fa-palette",text:"Изменение цвета",color:"#E91E63"},modify_opacity:{icon:"fas fa-adjust",text:"Изменение прозрачности",color:"#795548"},sketch_add:{icon:"fas fa-drafting-compass",text:"Добавлен элемент скетча",color:"#FF9800"},sketch_delete:{icon:"fas fa-drafting-compass",text:`Удалено элементов скетча: ${t.elements?.length||1}`,color:"#F44336"}}[t.type]||{icon:"fas fa-history",text:t.type,color:"#757575"}}jumpToHistory(t){if(t!==this.currentIndex)if(console.log("Jumping to history index:",t),t<this.currentIndex)for(;this.currentIndex>t&&this.undo(););else for(;this.currentIndex<t&&this.redo(););}updateUndoRedoButtons(){const t=document.getElementById("undo"),e=document.getElementById("redo");t&&(t.disabled=this.currentIndex<0,t.title=this.currentIndex<0?"Нечего отменять":"Отменить"),e&&(e.disabled=this.currentIndex>=this.history.length-1,e.title=this.currentIndex>=this.history.length-1?"Нечего повторять":"Повторить")}clear(){this.history=[],this.currentIndex=-1,this.updateHistoryUI()}getStats(){return{totalActions:this.history.length,currentIndex:this.currentIndex,canUndo:this.currentIndex>=0,canRedo:this.currentIndex<this.history.length-1}}exportHistory(){return{history:this.history,currentIndex:this.currentIndex}}importHistory(t){return!(!t||!Array.isArray(t.history))&&(this.history=t.history,this.currentIndex=Math.min(t.currentIndex,this.history.length-1),this.updateHistoryUI(),!0)}}