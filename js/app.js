
// ===== ЗАЩИТА КОНТРБАГТЕХ =====
const ALLOWED_HOSTS = ['prorab228.github.io', 'контрбагтех.рф'];
if (!ALLOWED_HOSTS.includes(window.location.hostname)) {
    document.body.innerHTML = '<div style="padding:40px;text-align:center;background:#1a1a1a;color:white;height:100vh;display:flex;align-items:center;justify-content:center;"><div><h2 style="color:#ff9800;">Доступ ограничен</h2><p>Редактор КонтрБагCAD работает только на официальном сайте.</p><p><a href="https://prorab228.github.io/KontrBugCAD/" style="color:#4CAF50;">Перейти на официальную страницу</a></p></div></div>';
    throw new Error('Access denied: Используйте официальный сайт.');
}
// ===== КОНЕЦ ЗАЩИТЫ =====

class CADEditor{constructor(){this.APP_VERSION="0.7.0 Beta",this.APP_NAME="КонтрБагCAD",this.APP_AUTHOR="Лунев Валерий Константинович ",this.scene=new THREE.Scene,this.camera=null,this.renderer=null,this.controls=null,this.objects=[],this.selectedObjects=[],this.groups=[],this.workPlanes=[],this.sketchPlanes=[],this.basePlanes=null,this.worldGroup=null,this.objectsGroup=null,this.sketchGroup=null,this.gridVisible=!0,this.axesVisible=!0,this.gridHelper=null,this.axesHelper=null,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.spacePressed=!1,this.originalMouseButtons=null,this.history=null,this.storage=null,this.toolManager=null,this.booleanOps=null,this.libraryManager=null,this.dragManager=null,this.objectsManager=null,this.planesManager=null,this.extrudeManager=null,this.projectManager=null,this.sketchManager=null,this.gearGenerator=null,this.rulerTool=null,this.threadGenerator=null,this.mmScale=1,this.pendingPrimitive=null,this.frames=0,this.lastTime=performance.now(),this.fps=60,this.focusCameraOnObject=this.focusCameraOnObject.bind(this),this.init()}init(){this.initThreeJS(),this.initManagers(),this.initUI(),this.initEventListeners(),this.animate(),this.initFileDrop(),this.planesManager.createBasePlanes()}initThreeJS(){const e=document.getElementById("viewport"),t=e.parentElement.clientWidth,s=e.parentElement.clientHeight;this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(t,s),this.renderer.setClearColor(1710618,1),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,e.appendChild(this.renderer.domElement),this.camera=new THREE.PerspectiveCamera(50,t/s,.1,1e3),this.camera.position.set(100,100,100),this.camera.lookAt(0,0,0),this.worldGroup=new THREE.Group,this.scene.add(this.worldGroup),this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.configureOrbitControls(),this.initLighting(),this.initHelpers(),this.objectsGroup=new THREE.Group,this.worldGroup.add(this.objectsGroup),this.sketchGroup=new THREE.Group,this.worldGroup.add(this.sketchGroup),this.renderer.domElement.addEventListener("contextmenu",e=>e.preventDefault())}configureOrbitControls(){this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!0,this.controls.mouseButtons={LEFT:null,MIDDLE:THREE.MOUSE.PAN,RIGHT:THREE.MOUSE.ROTATE},this.controls.panSpeed=1,this.controls.rotateSpeed=1,this.controls.zoomSpeed=1,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.maxPolarAngle=Math.PI}initManagers(){this.history=new HistoryManager(this),this.storage=new StorageManager,this.objectsManager=new ObjectsManager(this),this.planesManager=new PlanesManager(this),this.extrudeManager=new ExtrudeManager(this),this.projectManager=new ProjectManager(this),this.libraryManager=new LibraryManager(this),this.dragManager=new DragManager(this),this.toolManager=new ToolManager(this),this.initTools(),setTimeout(()=>{"undefined"==typeof THREE_BVH_CSG?(console.warn("three-bvh-csg не загружена"),this.showStatus("Булевы операции недоступны","warning")):(this.booleanOps=new BooleanOperations(this),console.log("Менеджер булевых операций инициализирован с three-bvh-csg"))},100)}initTools(){this.sketchManager=new SketchManager(this),this.gearGenerator=new GearGenerator(this),this.threadGenerator=new ThreadGenerator(this),this.toolManager.registerTool("select",new SelectTool(this)),this.toolManager.registerTool("move",new MoveTool(this)),this.toolManager.registerTool("rotate",new RotateTool(this)),this.toolManager.registerTool("scale",new ScaleTool(this)),this.toolManager.registerTool("sketch",new SketchTool(this)),this.toolManager.registerTool("extrude",new ExtrudeTool(this)),this.toolManager.registerTool("workplane",new WorkPlaneTool(this)),this.toolManager.registerTool("rulerTool",new RulerTool(this)),this.toolManager.registerTool("gearGenerator",new GearTool(this)),this.toolManager.registerTool("threadGenerator",new ThreadTool(this)),this.toolManager.registerTool("split",new SplitTool(this)),this.toolManager.registerTool("mirror",new MirrorTool(this)),this.toolManager.registerTool("group",new GroupTool(this)),this.toolManager.registerTool("ungroup",new UngroupTool(this)),this.toolManager.registerTool("boolean-union",new BooleanUnionTool(this)),this.toolManager.registerTool("boolean-subtract",new BooleanSubtractTool(this)),this.toolManager.registerTool("boolean-intersect",new BooleanIntersectTool(this)),this.toolManager.setCurrentTool("select")}initLighting(){const e=new THREE.AmbientLight(16777215,.6);this.scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(10,20,15),t.castShadow=!0,t.shadow.camera.left=-20,t.shadow.camera.right=20,t.shadow.camera.top=20,t.shadow.camera.bottom=-20,this.scene.add(t);const s=new THREE.DirectionalLight(16777215,.4);s.position.set(-10,10,-10),this.scene.add(s);const o=new THREE.PointLight(16777215,.5,100);o.position.set(0,10,0),this.scene.add(o)}initHelpers(){if(this.gridHelper=new THREE.GridHelper(500,100,10066329),this.gridHelper.position.y=0,this.gridHelper.visible=this.gridVisible,this.worldGroup.add(this.gridHelper),this.axesHelper=new THREE.AxesHelper(50),this.axesHelper.visible=this.axesVisible,this.worldGroup.add(this.axesHelper),this.gridHelper){const e=localStorage.getItem("cad-grid-color");e&&this.gridHelper.material.color.set(new THREE.Color(e))}}initUI(){document.getElementById("undo").addEventListener("click",()=>this.undo()),document.getElementById("redo").addEventListener("click",()=>this.redo()),document.getElementById("deleteObject").addEventListener("click",()=>this.deleteSelected()),document.getElementById("version").innerHTML=`<strong>Версия:</strong> ${this.APP_VERSION}`,this.objectsManager.updateSceneStats()}initEventListeners(){window.addEventListener("resize",()=>this.onWindowResize()),this.initMouseHandlers(),this.initKeyboardHandlers(),this.initFileOperations(),this.initViewControls(),this.initSketchTools(),this.initBooleanOperations(),this.initModalHandlers(),this.initPanelTabs(),this.initPropertyControls(),this.initThemeControls(),this.initEnvironmentControls()}initFileOperations(){document.getElementById("newProject").addEventListener("click",()=>this.newProject()),document.getElementById("openProject").addEventListener("click",()=>this.openProject()),document.getElementById("saveProject").addEventListener("click",()=>this.showSaveModal()),document.getElementById("exportSTL").addEventListener("click",()=>this.showExportModal()),document.getElementById("exportJSON").addEventListener("click",()=>this.exportJSON()),document.getElementById("exportSVG").addEventListener("click",()=>this.exportSVG()),document.getElementById("openSTL").addEventListener("click",()=>this.projectManager.openSTL())}initFileDrop(){const e=document.getElementById("viewport");e.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy"}),e.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;if(t.length>0){const s=t[0];if(s.name.toLowerCase().endsWith(".stl")){const t=this.libraryManager.getDropPosition(e);this.libraryManager.addCustomSTLModel(s,t)}}})}initViewControls(){Object.entries({homeView:"home",frontView:"front",topView:"top",rightView:"right",leftView:"left",backView:"back",bottomView:"bottom",isoView:"isometric"}).forEach(([e,t])=>{const s=document.getElementById(e);s&&s.addEventListener("click",()=>this.setView(t))}),document.getElementById("toggleGrid").addEventListener("click",()=>this.toggleGrid()),document.getElementById("toggleAxes").addEventListener("click",()=>this.toggleAxes()),document.getElementById("toggleWireframe").addEventListener("click",()=>this.toggleWireframe())}initSketchTools(){document.getElementById("openSketch").addEventListener("click",()=>{this.toolManager.setCurrentTool("sketch")}),document.getElementById("createSketchPlane").addEventListener("click",()=>{this.toolManager.setCurrentTool("workplane")}),document.getElementById("extrudeSketch").addEventListener("click",()=>{this.toolManager.setCurrentTool("extrude")}),document.querySelectorAll(".sketch-tool-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.sketchTool;this.sketchManager&&this.sketchManager.setCurrentTool(t)})}),document.getElementById("sketchDeleteBtn").addEventListener("click",()=>{this.sketchManager&&this.sketchManager.deleteSelected()}),document.getElementById("sketchClearBtn").addEventListener("click",()=>{this.sketchManager&&this.sketchManager.clearSketch()}),document.getElementById("exitSketchBtn").addEventListener("click",()=>{if(this.sketchManager){const e=this.toolManager.getTool("sketch");e&&e.exitSketchMode()}}),document.getElementById("toggleSketchGrid").addEventListener("click",()=>{this.sketchManager&&(this.sketchManager.toggleGrid(),this.showStatus("Сетка скетча: "+(this.sketchManager.gridVisible?"вкл":"выкл"),"info"))})}initBooleanOperations(){document.getElementById("booleanUnion").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-union")}),document.getElementById("booleanSubtract").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-subtract")}),document.getElementById("booleanIntersect").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-intersect")})}initModalHandlers(){document.querySelectorAll(".close-modal").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest(".modal-overlay");t&&t.classList.remove("active")})}),document.getElementById("aboutBtn").addEventListener("click",()=>{const e=document.getElementById("aboutModal");e.querySelector("h4").textContent=this.APP_NAME,e.querySelector("p:nth-child(2)").innerHTML=`<strong>Версия:</strong> ${this.APP_VERSION}`,e.querySelector("p:nth-child(3)").innerHTML=`<strong>Разработчик:</strong> ${this.APP_AUTHOR}`,e.classList.add("active")}),document.getElementById("cancelExport").addEventListener("click",()=>{document.getElementById("exportModal").classList.remove("active")}),document.getElementById("confirmExport").addEventListener("click",()=>{this.exportModel(),document.getElementById("exportModal").classList.remove("active")}),document.getElementById("cancelSave").addEventListener("click",()=>{document.getElementById("saveModal").classList.remove("active")}),document.getElementById("confirmSave").addEventListener("click",()=>{this.saveProject(),document.getElementById("saveModal").classList.remove("active")})}initPanelTabs(){document.querySelectorAll(".panel-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;document.querySelectorAll(".panel-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".panel-content").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById(`${t}Content`).classList.add("active")})})}initPropertyControls(){document.getElementById("objectColor").addEventListener("input",e=>{this.onObjectColorChange(e)}),document.getElementById("objectOpacity").addEventListener("input",e=>{this.onObjectOpacityChange(e)}),Object.entries({centerX:"x",centerY:"y",centerZ:"z",centerAll:"all"}).forEach(([e,t])=>{const s=document.getElementById(e);s&&s.addEventListener("click",()=>this.centerSelected(t))});const e=document.getElementById("extrudeSketchBtn");e&&e.addEventListener("click",()=>{this.toolManager.setCurrentTool("extrude")})}initThemeControls(){document.querySelectorAll(".theme-btn").forEach(e=>{e.addEventListener("click",t=>{const s=e.dataset.theme;this.setTheme(s),document.querySelectorAll(".theme-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active")})});const e=localStorage.getItem("cad-theme")||"dark";this.setTheme(e);const t=document.querySelector(`.theme-btn[data-theme="${e}"]`);t&&t.classList.add("active")}initEnvironmentControls(){const e=document.getElementById("backgroundColor");if(e){e.addEventListener("change",e=>{this.renderer.setClearColor(new THREE.Color(e.target.value)),localStorage.setItem("cad-bg-color",e.target.value)});const t=localStorage.getItem("cad-bg-color")||"#1a1a1a";e.value=t,this.renderer.setClearColor(new THREE.Color(t))}const t=document.getElementById("gridColor");if(t&&this.gridHelper){t.addEventListener("change",e=>{this.gridHelper.material.color.set(new THREE.Color(e.target.value)),localStorage.setItem("cad-grid-color",e.target.value)});const e=localStorage.getItem("cad-grid-color")||"#888888";t.value=e,this.gridHelper&&this.gridHelper.material.color.set(new THREE.Color(e))}const s=document.getElementById("resetEnvironment");s&&s.addEventListener("click",()=>{this.resetEnvironment()})}setTheme(e){const t=document.body;if(t.classList.add("theme-transition"),"auto"===e){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;t.classList.remove("dark-theme","light-theme"),t.classList.add(e?"dark-theme":"light-theme")}else t.classList.remove("dark-theme","light-theme"),t.classList.add(`${e}-theme`);localStorage.setItem("cad-theme",e);const s=document.querySelector(".theme-controls .fa-sun, .theme-controls .fa-moon");s&&("light"===e||"auto"===e&&!window.matchMedia("(prefers-color-scheme: dark)").matches?s.className="fas fa-sun":s.className="fas fa-moon"),setTimeout(()=>{t.classList.remove("theme-transition")},300)}resetEnvironment(){localStorage.removeItem("cad-bg-color"),localStorage.removeItem("cad-grid-color"),this.renderer.setClearColor(1710618,1),document.getElementById("backgroundColor").value="#1a1a1a",this.gridHelper&&this.gridHelper.material.color.set(4473924),document.getElementById("gridColor").value="#AAAAAA",this.showStatus("Настройки окружения сброшены","info")}initMouseHandlers(){const e=this.renderer.domElement;e.addEventListener("mousedown",e=>this.handleMouseDown(e)),e.addEventListener("mousemove",e=>this.handleMouseMove(e)),e.addEventListener("mouseup",e=>this.handleMouseUp(e)),e.addEventListener("dblclick",e=>this.handleDoubleClick(e))}initKeyboardHandlers(){document.addEventListener("keydown",e=>this.onKeyDown(e)),document.addEventListener("keyup",e=>this.onKeyUp(e))}handleMouseDown(e){const t=0===e.button,s=2===e.button,o=1===e.button;t&&(e.preventDefault(),this.updateMousePosition(e),this.toolManager.handleMouseDown(e))||(s&&(document.body.style.cursor="grab"),o&&(document.body.style.cursor="move"))}handleMouseMove(e){this.updateMousePosition(e),this.updateCoordinates(e),this.toolManager.handleMouseMove(e)}handleMouseUp(e){const t=2===e.button,s=1===e.button;(t||s)&&(document.body.style.cursor="default"),0===e.button&&this.toolManager.handleMouseUp(e)}handleDoubleClick(e){this.toolManager.handleDoubleClick(e)}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-(e.clientY-t.top)/t.height*2+1}toggleObjectSelection(e){const t=this.selectedObjects.indexOf(e);t>-1?(this.selectedObjects.splice(t,1),this.objectsManager.unhighlightObject(e)):(this.selectedObjects.push(e),this.objectsManager.highlightObject(e))}selectSingleObject(e){this.clearSelection(),this.selectedObjects=[e],this.objectsManager.highlightObject(e);const t=this.toolManager.getCurrentTool();t&&t.isTransformTool&&t.attachToObject&&t.attachToObject(e),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus()}selectObject(e){this.selectedObjects=[e],this.objectsManager.highlightObject(e),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus()}clearSelection(){this.selectedObjects.forEach(e=>this.objectsManager.unhighlightObject(e)),this.selectedObjects=[];const e=this.toolManager.getCurrentTool();e&&e.isTransformTool&&e.detach&&e.detach(),this.updatePropertiesPanel(),this.updateStatus()}setCurrentTool(e){this.toolManager.setCurrentTool(e)}deleteObject(e){if(!confirm("Удалить объект?"))return;e.parent&&e.parent.remove(e);const t=this.objects.indexOf(e);if(t>-1&&this.objects.splice(t,1),"sketch_plane"===e.userData.type){const t=this.sketchPlanes.indexOf(e);t>-1&&this.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.workPlanes.indexOf(e);t>-1&&this.workPlanes.splice(t,1)}else if("group"===e.userData.type){const t=this.groups.indexOf(e);t>-1&&this.groups.splice(t,1)}const s=this.selectedObjects.indexOf(e);s>-1&&this.selectedObjects.splice(s,1),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),this.objectsManager.updateSceneStats(),this.objectsManager.updateSceneList(),this.updatePropertiesPanel(),this.showStatus("Объект удален","info")}deleteSelected(){if(0===this.selectedObjects.length)return;const e=this.selectedObjects.map(e=>({uuid:e.uuid,data:e.userData}));this.history.addAction({type:"delete",objects:e}),this.selectedObjects.forEach(e=>{this.objectsGroup.remove(e);const t=this.objects.indexOf(e);if(t>-1&&this.objects.splice(t,1),"sketch_plane"===e.userData.type){const t=this.sketchPlanes.indexOf(e);t>-1&&this.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.workPlanes.indexOf(e);t>-1&&this.workPlanes.splice(t,1)}else if("group"===e.userData?.type){const t=this.groups.indexOf(e);t>-1&&this.groups.splice(t,1)}e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.clearSelection(),this.objectsManager.updateSceneStats(),this.objectsManager.updateSceneList(),this.toolManager.setCurrentTool("select")}centerSelected(e){0!==this.selectedObjects.length&&(this.selectedObjects.forEach(t=>{const s=(new THREE.Box3).setFromObject(t),o=new THREE.Vector3;switch(s.getCenter(o),e){case"x":t.position.x=0;break;case"y":t.position.y=0;break;case"z":t.position.z=0;break;case"all":t.position.set(0,0,0)}}),this.updatePropertiesPanel(),this.history.addAction({type:"center",objects:this.selectedObjects.map(e=>e.uuid),axis:e}))}setView(e){const t={home:[100,100,100],isometric:[100,100,100],front:[0,0,100],back:[0,0,-100],top:[0,100,0],bottom:[0,-100,0],left:[-100,0,0],right:[100,0,0]};t[e]&&(this.camera.position.set(...t[e]),this.camera.lookAt(0,0,0)),"perspective"===e?this.camera.fov=60:"orthographic"===e&&(this.camera.fov=20),"perspective"!==e&&"orthographic"!==e||this.camera.updateProjectionMatrix(),this.controls.update()}toggleGrid(){this.gridVisible=!this.gridVisible,this.gridHelper&&(this.gridHelper.visible=this.gridVisible),this.showStatus("Сетка: "+(this.gridVisible?"вкл":"выкл"),"info")}toggleAxes(){this.axesVisible=!this.axesVisible,this.axesHelper&&(this.axesHelper.visible=this.axesVisible),this.showStatus("Оси: "+(this.axesVisible?"вкл":"выкл"),"info")}toggleWireframe(){this.selectedObjects.length>0&&(this.selectedObjects.forEach(e=>{void 0!==e.material.wireframe&&(e.material.wireframe=!e.material.wireframe)}),this.showStatus("Режим каркаса переключен","info"))}focusCameraOnObject(e){this.objectsManager&&e&&this.objectsManager.focusCameraOnObject(e)}onKeyDown(e){if(this.toolManager.handleKeyDown(e))return;switch(e.key.toLowerCase()){case"delete":this.deleteSelected();break;case"z":case"я":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.shiftKey?this.redo():this.undo());break;case"y":case"н":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.redo());break;case"s":case"ы":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.saveProject());break;case"n":case"т":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.newProject());break;case"к":case"r":e.ctrlKey||e.metaKey?(e.preventDefault(),this.newProject()):(e.altKey||e.shiftKey)&&this.setView("home");break;case" ":this.spacePressed||(this.spacePressed=!0,this.originalMouseButtons={...this.controls.mouseButtons},this.controls.mouseButtons.LEFT=THREE.MOUSE.PAN);break;case"р":case"h":if(e.ctrlKey||e.metaKey){if(e.preventDefault(),this.dragManager){const e=this.dragManager.toggleSnapToGrid();document.getElementById("toggleGrid").classList.toggle("active",e)}this.sketchManager&&(this.sketchManager.snapEnabled=!this.sketchManager.snapEnabled)}}}onKeyUp(e){this.toolManager.handleKeyUp(e)," "===e.key&&this.spacePressed&&this.originalMouseButtons&&(this.spacePressed=!1,this.controls.mouseButtons=this.originalMouseButtons)}performUnion(){return this.booleanOps?this.booleanOps.unionMultiple(this.selectedObjects):null}performSubtract(){return!this.booleanOps||this.selectedObjects.length<2?null:this.booleanOps.subtract(this.selectedObjects[0],this.selectedObjects[1])}performIntersect(){return!this.booleanOps||this.selectedObjects.length<2?null:this.booleanOps.intersect(this.selectedObjects[0],this.selectedObjects[1])}addBooleanResult(e,t){console.log("=== addBooleanResult ==="),console.log("Operation:",t),console.log("Selected objects:",this.selectedObjects.length);const s=[];this.selectedObjects.forEach((e,t)=>{console.log(`Processing object ${t}:`,e.userData?.type,e.uuid);try{const o=this.projectManager.serializeObjectForHistory(e);console.log(`Serialized object ${t}:`,o),o?s.push({uuid:e.uuid,data:o}):console.error(`Failed to serialize object ${t}`)}catch(e){console.error(`Error serializing object ${t}:`,e)}}),console.log("Original objects to save:",s);const o=this.selectedObjects.map(e=>e.uuid);if(!e||!e.geometry)return void this.showStatus("Ошибка: недопустимый результат булевой операции","error");this.objectsGroup.add(e),this.objects.push(e);const i=[...this.selectedObjects];for(let e of i){this.objectsGroup.remove(e);const t=this.objects.indexOf(e);if(t>-1&&this.objects.splice(t,1),"sketch_plane"===e.userData?.type){const t=this.sketchPlanes.indexOf(e);t>-1&&this.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData?.type){const t=this.workPlanes.indexOf(e);t>-1&&this.workPlanes.splice(t,1)}}this.selectedObjects=[],this.objectsManager.updateSceneList(),this.selectObject(e),this.objectsManager.updateSceneStats();const n=this.projectManager.serializeObjectForHistory(e);console.log("Result data:",n);const r={type:"boolean",operation:t,result:e.uuid,sourceObjects:o,originalObjects:s,resultData:n};console.log("Adding to history:",r),this.history.addAction(r),this.showStatus(`Операция "${t}" завершена`,"success")}showLoadingIndicator(e){let t=document.getElementById("boolLoadingIndicator");if(t)t.querySelector(".message").textContent=e,t.style.display="flex";else if(t=document.createElement("div"),t.id="boolLoadingIndicator",t.style.cssText="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: rgba(0, 0, 0, 0.8);\n                color: white;\n                padding: 20px 30px;\n                border-radius: 8px;\n                z-index: 10001;\n                display: flex;\n                align-items: center;\n                gap: 15px;\n                font-family: Arial, sans-serif;\n            ",t.innerHTML=`\n                <div class="spinner" style="\n                    width: 24px;\n                    height: 24px;\n                    border: 3px solid rgba(255, 255, 255, 0.3);\n                    border-radius: 50%;\n                    border-top-color: #fff;\n                    animation: spin 1s linear infinite;\n                "></div>\n                <div class="message">${e}</div>\n            `,document.body.appendChild(t),!document.querySelector("#boolLoadingStyles")){const e=document.createElement("style");e.id="boolLoadingStyles",e.textContent="@keyframes spin { to { transform: rotate(360deg); } }",document.head.appendChild(e)}}hideLoadingIndicator(){const e=document.getElementById("boolLoadingIndicator");e&&(e.style.display="none")}newProject(){return this.projectManager.newProject()}showSaveModal(){return this.projectManager.showSaveModal()}saveProject(){return this.projectManager.saveProject()}openProject(){return this.projectManager.openProject()}loadProject(e){return this.projectManager.loadProject(e)}showExportModal(){return this.projectManager.showExportModal()}exportModel(){return this.projectManager.exportModel()}exportJSON(){return this.projectManager.exportJSON()}exportSVG(){return this.projectManager.exportSVG()}undo(){if(this.history){this.history.undo()&&this.showStatus("Отменено","info")}}redo(){if(this.history){this.history.redo()&&this.showStatus("Повторено","info")}}animate(){requestAnimationFrame(()=>this.animate()),TWEEN.update(),this.controls.update();const e=this.toolManager.getCurrentTool();e&&e.update&&e.update(),this.renderer.render(this.scene,this.camera),this.updateFPS()}updateFPS(){const e=performance.now(),t=e-this.lastTime;this.frames++,t>=1e3&&(this.fps=Math.round(1e3*this.frames/t),document.getElementById("fpsCounter").textContent=`FPS: ${this.fps}`,this.frames=0,this.lastTime=e)}onWindowResize(){const e=document.getElementById("viewport"),t=e.parentElement.clientWidth,s=e.parentElement.clientHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s)}showStatus(e,t="info"){const s=document.getElementById("status");s.textContent=e;s.style.background={success:"#00c853",error:"#f44336",warning:"#ff9800",info:"#2196f3"}[t]||"#2196f3",setTimeout(()=>{s.textContent="Готов",s.style.background="#00c853"},3e3)}updatePropertiesPanel(){if(!document.getElementById("propertiesContent"))return;console.log("Обновление панели свойств");const e=document.querySelector('.property-group[data-type="center"]'),t=document.querySelector('.property-group[data-type="appearance"]');if(e&&(e.style.display=this.selectedObjects.length>0?"block":"none"),t&&(t.style.display=1===this.selectedObjects.length?"block":"none"),e&&this.selectedObjects.length>0){const t=e.querySelector("h4");t&&(t.innerHTML=`<i class="fas fa-bullseye"></i> Центрирование (${this.selectedObjects.length} объектов)`)}if(t&&1===this.selectedObjects.length){const e=this.selectedObjects[0],t=document.getElementById("objectColor");if(t&&e.material){const s=new THREE.Color(e.material.color);t.value=s.getStyle(),t.disabled=!1}else t&&(t.disabled=!0);const s=document.getElementById("objectOpacity");s&&e.material?(s.value=void 0!==e.material.opacity?e.material.opacity:1,s.disabled=!1):s&&(s.disabled=!0)}const s=this.toolManager.getCurrentTool();s&&s instanceof TransformToolBase&&console.log(`Активный инструмент: ${s.name}, он управляет своими свойствами`)}updateStatus(){const e=this.toolManager.getCurrentTool(),t=e?e.name:"select",s={select:"Выделение",move:"Перемещение",rotate:"Вращение",scale:"Масштабирование",sketch:"Скетч",extrude:"Вытягивание",rulerTool:"Линейка",gearGenerator:"Шестерня",threadGenerator:"Резьба",workplane:"Рабочая плоскость",split:"Разрезание",mirror:"Отражение",group:"Группировка",ungroup:"Разгруппировка","boolean-union":"Объединение","boolean-subtract":"Вычитание","boolean-intersect":"Пересечение"}[t]||t;document.getElementById("modeIndicator").innerHTML=`<i class="fas fa-mouse-pointer"></i> Режим: ${s}`,document.getElementById("selectedInfo").textContent=`Выбрано: ${this.selectedObjects.length}`,this.updateToolButtons()}updateToolButtons(){const e=this.toolManager.getCurrentTool(),t=e?e.name:"select";document.querySelectorAll("[data-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.tool===t&&e.classList.add("active")})}updateCoordinates(e){this.raycaster.setFromCamera(this.mouse,this.camera);const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),s=new THREE.Vector3;this.raycaster.ray.intersectPlane(t,s)&&(document.getElementById("coords").textContent=`X: ${s.x.toFixed(2)}, Y: ${s.y.toFixed(2)}, Z: ${s.z.toFixed(2)}`)}onObjectColorChange(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0];let s=t.material;if(s||(s=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide}),t.material=s,t.userData.originalMaterial||(t.userData.originalMaterial=s.clone())),!s.color)return void this.showStatus("Материал объекта не поддерживает изменение цвета","error");const o=e.target.value,i=s.color.getHex?s.color.getHex():8421504;this.setObjectColor(t,o),this.history.addAction({type:"modify_color",object:t.uuid,data:{color:o,previousColor:i}})}onObjectOpacityChange(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0];let s=t.material;s||(s=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide,transparent:!0}),t.material=s,t.userData.originalMaterial||(t.userData.originalMaterial=s.clone()));const o=parseFloat(e.target.value),i=void 0!==s.opacity?s.opacity:1;this.setObjectOpacity(t,o),this.history.addAction({type:"modify_opacity",object:t.uuid,data:{opacity:o,previousOpacity:i}})}setObjectColor(e,t){if(!e)return;const s=new THREE.Color(t);if(!e.material)return e.material=new THREE.MeshStandardMaterial({color:s,side:THREE.FrontSide}),e.material.needsUpdate=!0,e.userData.originalMaterial=e.material.clone(),void(e.userData.currentColor=t);if(e.userData.originalMaterial){const t=e.userData.originalMaterial.clone();t.color.copy(s),e.userData.originalMaterial=t}else e.userData.originalMaterial=e.material.clone(),e.userData.originalMaterial.color.copy(s);e.material.color.copy(s),e.material.needsUpdate=!0,e.userData.currentColor=t}setObjectOpacity(e,t){if(e){if(!e.material)return e.material=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide,transparent:t<1,opacity:t}),e.material.needsUpdate=!0,e.userData.originalMaterial=e.material.clone(),void(e.userData.currentOpacity=t);if(e.userData.originalMaterial){const s=e.userData.originalMaterial.clone();s.opacity=t,s.transparent=t<1,e.userData.originalMaterial=s}else e.userData.originalMaterial=e.material.clone(),e.userData.originalMaterial.opacity=t,e.userData.originalMaterial.transparent=t<1;e.material.opacity=t,e.material.transparent=t<1,e.material.needsUpdate=!0,e.userData.currentOpacity=t}}findObjectByUuid(e){return this.objects.find(t=>t.uuid===e)||null}getVisibleObjects(){const e=[];return this.objectsGroup.traverse(t=>{t.isMesh&&t.visible&&e.push(t)}),e}}window.addEventListener("DOMContentLoaded",()=>{window.cadEditor=new CADEditor});