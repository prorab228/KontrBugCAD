
// ===== ЗАЩИТА КОНТРБАГТЕХ =====
const ALLOWED_HOSTS = ['prorab228.github.io', 'контрбагтех.рф'];
if (!ALLOWED_HOSTS.includes(window.location.hostname)) {
    document.body.innerHTML = '<div style="padding:40px;text-align:center;background:#1a1a1a;color:white;height:100vh;display:flex;align-items:center;justify-content:center;"><div><h2 style="color:#ff9800;">Доступ ограничен</h2><p>Редактор КонтрБагCAD работает только на официальном сайте.</p><p><a href="https://prorab228.github.io/KontrBugCAD/" style="color:#4CAF50;">Перейти на официальную страницу</a></p></div></div>';
    throw new Error('Access denied: Используйте официальный сайт.');
}
// ===== КОНЕЦ ЗАЩИТЫ =====

class CADEditor{constructor(){this.APP_VERSION="0.7.18 Beta",this.APP_NAME="КонтрБагCAD",this.APP_AUTHOR="Лунев Валерий Константинович ",this.autoSaveEnabled=!0,this.scene=new THREE.Scene,this.camera=null,this.renderer=null,this.controls=null,this.objects=[],this.selectedObjects=[],this.groups=[],this.clipboard=[],this.gridUnit="mm",this.gridStep=5,this.autoSaveEnabled=!0,this.workPlanes=[],this.sketchPlanes=[],this.basePlanes=null,this.worldGroup=null,this.objectsGroup=null,this.sketchGroup=null,this.gridVisible=!0,this.axesVisible=!0,this.gridHelper=null,this.axesHelper=null,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.spacePressed=!1,this.originalMouseButtons=null,this.history=null,this.toolManager=null,this.booleanOps=null,this.libraryManager=null,this.dragManager=null,this.objectsManager=null,this.planesManager=null,this.extrudeManager=null,this.projectManager=null,this.sketchManager=null,this.gearGenerator=null,this.rulerTool=null,this.threadGenerator=null,this.mmScale=1,this.pendingPrimitive=null,this.frames=0,this.lastTime=performance.now(),this.fps=60,this._statusTimeout=null,this.focusCameraOnObject=this.focusCameraOnObject.bind(this),this.init()}init(){this.loadAutoSaveSetting(),this.initThreeJS(),this.initManagers(),this.initUI(),this.initEventListeners(),this.animate(),this.initFileDrop(),this.planesManager.createBasePlanes(),this.startSimpleAutoSave(),setTimeout(()=>{this.loadLastProjectSimple()},100)}initThreeJS(){const e=document.getElementById("viewport"),t=e.parentElement.clientWidth,s=e.parentElement.clientHeight;this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(t,s),this.renderer.setClearColor(1710618,1),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,e.appendChild(this.renderer.domElement),this.camera=new THREE.PerspectiveCamera(50,t/s,.1,1e3),this.camera.position.set(100,100,100),this.camera.lookAt(0,0,0),this.worldGroup=new THREE.Group,this.scene.add(this.worldGroup),this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.configureOrbitControls(),this.initLighting(),this.initHelpers(),this.objectsGroup=new THREE.Group,this.worldGroup.add(this.objectsGroup),this.sketchGroup=new THREE.Group,this.worldGroup.add(this.sketchGroup),this.renderer.domElement.addEventListener("contextmenu",e=>e.preventDefault())}configureOrbitControls(){this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!0,this.controls.mouseButtons={LEFT:null,MIDDLE:THREE.MOUSE.PAN,RIGHT:THREE.MOUSE.ROTATE},this.controls.panSpeed=1,this.controls.rotateSpeed=1,this.controls.zoomSpeed=1,this.controls.minDistance=1,this.controls.maxDistance=1e3,this.controls.maxPolarAngle=Math.PI}initManagers(){this.history=new HistoryManager(this),this.objectsManager=new ObjectsManager(this),this.planesManager=new PlanesManager(this),this.extrudeManager=new ExtrudeManager(this),this.revolveManager=new RevolveManager(this),this.importManager=new ImportManager(this),this.exportManager=new ExportManager(this),this.projectManager=new ProjectManager(this),this.libraryManager=new LibraryManager(this),this.dragManager=new DragManager(this),this.toolManager=new ToolManager(this),this.initTools(),setTimeout(()=>{"undefined"==typeof THREE_BVH_CSG?(console.warn("three-bvh-csg не загружена"),this.showStatus("Булевы операции недоступны","warning")):(this.booleanOps=new BooleanOperations(this),console.log("Менеджер булевых операций инициализирован с three-bvh-csg"))},100)}initTools(){this.sketchManager=new SketchManager(this),this.gearGenerator=new GearGenerator(this),this.threadGenerator=new ThreadGenerator(this),this.toolManager.registerTool("select",new SelectTool(this)),this.toolManager.registerTool("move",new MoveTool(this)),this.toolManager.registerTool("rotate",new RotateTool(this)),this.toolManager.registerTool("scale",new ScaleTool(this)),this.toolManager.registerTool("sketch",new SketchTool(this)),this.toolManager.registerTool("extrude",new ExtrudeTool(this)),this.toolManager.registerTool("revolve",new RevolveTool(this)),this.toolManager.registerTool("workplane",new WorkPlaneTool(this)),this.toolManager.registerTool("rulerTool",new RulerTool(this)),this.toolManager.registerTool("gearGenerator",new GearTool(this)),this.toolManager.registerTool("threadGenerator",new ThreadTool(this)),this.toolManager.registerTool("split",new SplitTool(this)),this.toolManager.registerTool("mirror",new MirrorTool(this)),this.toolManager.registerTool("group",new GroupTool(this)),this.toolManager.registerTool("ungroup",new UngroupTool(this)),this.toolManager.registerTool("chamfer",new ChamferTool(this)),this.toolManager.registerTool("text3dTool",new Text3DTool(this)),this.toolManager.registerTool("boolean-union",new BooleanUnionTool(this)),this.toolManager.registerTool("boolean-subtract",new BooleanSubtractTool(this)),this.toolManager.registerTool("boolean-intersect",new BooleanIntersectTool(this)),this.toolManager.registerTool("repair",new RepairTool(this)),this.toolManager.registerTool("decimate",new DecimateTool(this)),this.toolManager.registerTool("imageTool",new ImageTool(this)),this.toolManager.setCurrentTool("select")}initLighting(){const e=new THREE.AmbientLight(16777215,.6);this.scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(10,20,15),t.castShadow=!0,t.shadow.camera.left=-20,t.shadow.camera.right=20,t.shadow.camera.top=20,t.shadow.camera.bottom=-20,this.scene.add(t);const s=new THREE.DirectionalLight(16777215,.4);s.position.set(-10,10,-10),this.scene.add(s)}createMainGrid(){this.gridHelper&&(this.worldGroup.remove(this.gridHelper),this.gridHelper.geometry.dispose(),this.gridHelper.material.dispose(),this.gridHelper=null);let e=this.gridStep;"inch"===this.gridUnit&&(e*=25.4);const t=Math.floor(500/e);this.gridHelper=new THREE.GridHelper(500,t,10066329),this.gridHelper.position.y=0,this.gridHelper.visible=this.gridVisible,this.worldGroup.add(this.gridHelper),console.log(`Создана основная сетка: шаг=${e}, единицы=${this.gridUnit}, делений=${t}`)}initHelpers(){const e=localStorage.getItem("cad-grid-unit")||"mm",t=localStorage.getItem("cad-grid-step")||5;if(e&&(this.gridUnit=e),t&&(this.gridStep=parseFloat(t)),this.createMainGrid(),this.axesHelper=new THREE.AxesHelper(50),this.axesHelper.visible=this.axesVisible,this.worldGroup.add(this.axesHelper),this.gridHelper){const e=localStorage.getItem("cad-grid-color")||"#FFFFFF";e&&this.gridHelper.material.color.set(new THREE.Color(e))}}initUI(){document.getElementById("undo").addEventListener("click",()=>this.undo()),document.getElementById("redo").addEventListener("click",()=>this.redo()),document.getElementById("deleteObject").addEventListener("click",()=>this.deleteSelected()),document.getElementById("copyObject").addEventListener("click",()=>this.copySelectedObjects()),document.getElementById("pasteObject").addEventListener("click",()=>this.pasteObjects()),document.getElementById("duplicateObject").addEventListener("click",()=>this.duplicateSelectedObjects()),document.getElementById("version").innerHTML=`<strong>Версия:</strong> ${this.APP_VERSION}`,this.objectsManager.updateSceneStats()}initEventListeners(){window.addEventListener("resize",()=>this.onWindowResize()),this.initMouseHandlers(),this.initKeyboardHandlers(),this.initFileOperations(),this.initViewControls(),this.initBooleanOperations(),this.initModalHandlers(),this.initPanelTabs(),this.initPropertyControls(),this.initThemeControls(),this.initEnvironmentControls()}initFileOperations(){document.getElementById("newProject").addEventListener("click",()=>this.projectManager.newProject()),document.getElementById("openProject").addEventListener("click",()=>this.projectManager.openProject()),document.getElementById("saveProject").addEventListener("click",()=>this.projectManager.showSaveModal()),document.getElementById("exportSTL").addEventListener("click",()=>this.exportManager.showExportModal()),document.getElementById("exportJSON").addEventListener("click",()=>this.exportManager.exportJSON()),document.getElementById("exportSVG").addEventListener("click",()=>this.exportManager.exportSVG()),document.getElementById("openSTL").addEventListener("click",()=>this.importManager.openSTL())}initFileDrop(){document.getElementById("viewport").addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;if(t.length>0){const s=t[0];if(s.name.toLowerCase().endsWith(".stl")){const t=this.libraryManager.getDropPosition(e);this.libraryManager.addCustomSTLModel(s,t)}else if(s.type.startsWith("image/")){const t=this.toolManager.getCurrentTool();t&&"imageTool"===t.name&&t.handleDrop?t.handleDrop(e):(this.toolManager.setCurrentTool("imageTool"),setTimeout(()=>{const t=this.toolManager.getTool("imageTool");t&&t.handleDrop&&t.handleDrop(e)},100))}}})}initViewControls(){Object.entries({homeView:"home",frontView:"front",topView:"top",rightView:"right",leftView:"left",backView:"back",bottomView:"bottom",isoView:"isometric",perspectiveView:"perspective",orthographicView:"orthographic"}).forEach(([e,t])=>{const s=document.getElementById(e);s&&s.addEventListener("click",()=>this.setView(t))}),document.getElementById("toggleGrid").addEventListener("click",()=>this.toggleGrid()),document.getElementById("toggleAxes").addEventListener("click",()=>this.toggleAxes()),document.getElementById("toggleWireframe").addEventListener("click",()=>this.toggleWireframe())}initBooleanOperations(){document.getElementById("booleanUnion").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-union")}),document.getElementById("booleanSubtract").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-subtract")}),document.getElementById("booleanIntersect").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-intersect")})}initModalHandlers(){document.querySelectorAll(".close-modal").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest(".modal-overlay");t&&t.classList.remove("active")})}),document.getElementById("aboutBtn").addEventListener("click",()=>{const e=document.getElementById("aboutModal");e.querySelector("h4").textContent=this.APP_NAME,e.querySelector("p:nth-child(2)").innerHTML=`<strong>Версия:</strong> ${this.APP_VERSION}`,e.querySelector("p:nth-child(3)").innerHTML=`<strong>Разработчик:</strong> ${this.APP_AUTHOR}`,e.classList.add("active")}),document.getElementById("cancelExport").addEventListener("click",()=>{document.getElementById("exportModal").classList.remove("active")}),document.getElementById("confirmExport").addEventListener("click",()=>{this.exportManager.exportModel(),document.getElementById("exportModal").classList.remove("active")}),document.getElementById("cancelSave").addEventListener("click",()=>{document.getElementById("saveModal").classList.remove("active")}),document.getElementById("confirmSave").addEventListener("click",()=>{this.projectManager.saveProject(),document.getElementById("saveModal").classList.remove("active")})}initPanelTabs(){document.querySelectorAll(".panel-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;document.querySelectorAll(".panel-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".panel-content").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById(`${t}Content`).classList.add("active")})})}switchToTab(e){const t=document.querySelectorAll(".panel-tab"),s=document.querySelectorAll(".panel-content");t.forEach(e=>e.classList.remove("active")),s.forEach(e=>e.classList.remove("active"));const i=document.querySelector(`.panel-tab[data-tab="${e}"]`),o=document.getElementById(`${e}Content`);i&&i.classList.add("active"),o&&o.classList.add("active"),console.log(`Переключено на вкладку: ${e}`)}initPropertyControls(){document.getElementById("objectColor").addEventListener("input",e=>{this.onObjectColorChange(e)}),document.getElementById("objectOpacity").addEventListener("input",e=>{this.onObjectOpacityChange(e)}),Object.entries({centerX:"x",centerY:"y",centerZ:"z",centerAll:"all"}).forEach(([e,t])=>{const s=document.getElementById(e);s&&s.addEventListener("click",()=>this.centerSelected(t))});const e=document.getElementById("extrudeSketchBtn");e&&e.addEventListener("click",()=>{this.toolManager.setCurrentTool("extrude")})}initThemeControls(){document.querySelectorAll(".theme-btn").forEach(e=>{e.addEventListener("click",t=>{const s=e.dataset.theme;this.setTheme(s),document.querySelectorAll(".theme-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active")})});const e=localStorage.getItem("cad-theme")||"light";this.setTheme(e);const t=document.querySelector(`.theme-btn[data-theme="${e}"]`);t&&t.classList.add("active")}initEnvironmentControls(){const e=document.getElementById("backgroundColor");if(e){e.addEventListener("change",e=>{this.renderer.setClearColor(new THREE.Color(e.target.value)),localStorage.setItem("cad-bg-color",e.target.value)});const t=localStorage.getItem("cad-bg-color")||"#FFFFFF";e.value=t,this.renderer.setClearColor(new THREE.Color(t))}const t=document.getElementById("gridColor");if(t&&this.gridHelper){t.addEventListener("change",e=>{this.gridHelper.material.color.set(new THREE.Color(e.target.value)),localStorage.setItem("cad-grid-color",e.target.value)});const e=localStorage.getItem("cad-grid-color")||"#FFFFFF";t.value=e,this.gridHelper&&this.gridHelper.material.color.set(new THREE.Color(e))}const s=document.getElementById("autoSaveCheckbox");s&&(s.checked=this.autoSaveEnabled,s.addEventListener("change",e=>{this.autoSaveEnabled=e.target.checked,this.saveAutoSaveSetting(),this.showStatus("Автосохранение "+(this.autoSaveEnabled?"включено":"выключено"),"info")}));const i=document.getElementById("mainGridUnit"),o=document.getElementById("mainGridStep");i&&(i.value=this.gridUnit,i.addEventListener("change",e=>{this.gridUnit=e.target.value,localStorage.setItem("cad-grid-unit",this.gridUnit),"mm"===this.gridUnit?(this.gridStep=5,this.sketchManager.gridStep=1):(this.gridStep=1/8,this.sketchManager.gridStep=1/16),this.updateGridStepOptions(),"sketch"==this.toolManager.currentTool.name&&(this.sketchManager.viewManager.updateGrid(),this.toolManager.getTool("sketch").updateGridStepOptions()),this.createMainGrid(),this.showStatus("Единицы сетки: "+("mm"===this.gridUnit?"мм":"дюймы"),"info")})),o&&(this.updateGridStepOptions(),o.addEventListener("change",e=>{this.gridStep=parseFloat(e.target.value),localStorage.setItem("cad-grid-step",this.gridStep),this.createMainGrid(),this.showStatus(`Шаг сетки: ${this.gridStep} ${"mm"===this.gridUnit?"мм":1===this.gridStep?"дюйм":"дюйма"}`,"info")}));const a=document.getElementById("resetEnvironment");a&&a.addEventListener("click",()=>{this.resetEnvironment()})}updateGridStepOptions(){const e=document.getElementById("mainGridStep");if(e)if(e.innerHTML="","mm"===this.gridUnit){[.1,.2,.5,1,2,5,10].forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=`${t} мм`,Math.abs(t-this.gridStep)<.001&&(s.selected=!0),e.appendChild(s)})}else{[{value:1/64,label:'1/64"'},{value:1/32,label:'1/32"'},{value:1/16,label:'1/16"'},{value:1/8,label:'1/8"'},{value:1/4,label:'1/4"'},{value:.5,label:'1/2"'},{value:1,label:'1"'}].forEach(t=>{const s=document.createElement("option");s.value=t.value,s.textContent=t.label,Math.abs(t.value-this.gridStep)<.001&&(s.selected=!0),e.appendChild(s)})}}setTheme(e){const t=document.body;if(t.classList.add("theme-transition"),"auto"===e){const e=window.matchMedia("(prefers-color-scheme: dark)").matches;t.classList.remove("dark-theme","light-theme"),t.classList.add(e?"dark-theme":"light-theme")}else t.classList.remove("dark-theme","light-theme"),t.classList.add(`${e}-theme`);localStorage.setItem("cad-theme",e);const s=document.querySelector(".theme-controls .fa-sun, .theme-controls .fa-moon");s&&("light"===e||"auto"===e&&!window.matchMedia("(prefers-color-scheme: dark)").matches?s.className="fas fa-sun":s.className="fas fa-moon"),setTimeout(()=>{t.classList.remove("theme-transition")},300)}resetEnvironment(){localStorage.removeItem("cad-bg-color"),localStorage.removeItem("cad-grid-color"),localStorage.removeItem("cad-grid-unit"),localStorage.removeItem("cad-grid-step"),this.renderer.setClearColor(16777215,1),document.getElementById("backgroundColor").value="#FFFFFF",this.gridHelper&&this.gridHelper.material.color.set(16777215),document.getElementById("gridColor").value="#FFFFFF",this.gridUnit="mm",this.gridStep=5,this.createMainGrid();const e=document.getElementById("mainGridUnit"),t=document.getElementById("mainGridStep");e&&(e.value="mm"),t&&this.updateGridStepOptions(),this.showStatus("Настройки окружения сброшены","info")}initMouseHandlers(){const e=this.renderer.domElement;e.addEventListener("mousedown",e=>this.handleMouseDown(e)),e.addEventListener("mousemove",e=>this.handleMouseMove(e)),e.addEventListener("mouseup",e=>this.handleMouseUp(e)),e.addEventListener("dblclick",e=>this.handleDoubleClick(e))}initKeyboardHandlers(){document.addEventListener("keydown",e=>this.onKeyDown(e)),document.addEventListener("keyup",e=>this.onKeyUp(e))}handleMouseDown(e){const t=0===e.button,s=2===e.button,i=1===e.button;t&&(e.preventDefault(),this.updateMousePosition(e),this.toolManager.handleMouseDown(e))||(s&&(document.body.style.cursor="grab"),i&&(document.body.style.cursor="move"))}handleMouseMove(e){this.updateMousePosition(e),this.updateCoordinates(e),this.toolManager.handleMouseMove(e)}handleMouseUp(e){const t=2===e.button,s=1===e.button;(t||s)&&(document.body.style.cursor="default"),0===e.button&&this.toolManager.handleMouseUp(e)}handleDoubleClick(e){this.toolManager.handleDoubleClick(e)}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-(e.clientY-t.top)/t.height*2+1}toggleObjectSelection(e){const t=this.selectedObjects.indexOf(e);t>-1?(this.selectedObjects.splice(t,1),this.objectsManager.unhighlightObject(e)):(this.selectedObjects.push(e),this.objectsManager.highlightObject(e)),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus()}selectSingleObject(e){this.clearSelection(),this.selectedObjects=[e],this.objectsManager.highlightObject(e);const t=this.toolManager.getCurrentTool();t&&t.isTransformTool&&t.attachToObject&&t.attachToObject(e),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus(),this.switchToTab("properties")}copySelectedObjects(){return"sketch"!=this.toolManager.currentTool.name&&(0===this.selectedObjects.length?(this.showStatus("Не выбрано объектов для копирования","warning"),!1):(this.clipboard=this.selectedObjects.map(e=>({data:this.projectManager.serializeObjectForHistory(e),originalPosition:e.position.clone(),originalUUID:e.uuid})),this.showStatus(`Скопировано объектов: ${this.selectedObjects.length}`,"success"),!0))}pasteObjects(){if("sketch"==this.toolManager.currentTool.name)return!1;if(0===this.clipboard.length)return this.showStatus("Буфер обмена пуст","warning"),!1;const e=[];return this.clipboard.forEach((t,s)=>{try{const s=this.projectManager.deserializeObjectOptimized(t.data);if(!s)return;s.uuid=THREE.MathUtils.generateUUID();const i=new THREE.Vector3(20,0,20);s.position.copy(t.originalPosition).add(i),this.addObjectToScene(s,!1),e.push(s)}catch(e){console.error("Ошибка при вставке объекта:",e)}}),this.clearSelection(),e.forEach(e=>{this.selectedObjects.push(e),this.objectsManager.highlightObject(e)}),e.length>0&&this.history.addAction({type:"paste",objects:e.map(e=>({uuid:e.uuid,data:this.projectManager.serializeObjectForHistory(e)}))}),this.showStatus(`Вставлено объектов: ${e.length}`,"success"),e.length>0}duplicateSelectedObjects(){if("sketch"==this.toolManager.currentTool.name)return!1;if(0===this.selectedObjects.length)return this.showStatus("Не выбрано объектов для дублирования","warning"),!1;this.copySelectedObjects();const e=this.pasteObjects();return e&&this.showStatus(`Дублировано объектов: ${this.selectedObjects.length}`,"success"),e}selectAllObjects(){if("sketch"==this.toolManager.currentTool.name)return!1;const e=this.objectsManager.getSelectableObjects();return 0===e.length?(this.showStatus("Нет объектов для выделения","warning"),!1):(this.clearSelection(),e.forEach(e=>{this.selectedObjects.push(e),this.objectsManager.highlightObject(e)}),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus(),this.showStatus(`Выделено объектов: ${e.length}`,"success"),!0)}addObjectToScene(e,t=!1){this.objectsGroup.add(e),this.objects.push(e),"sketch_plane"===e.userData.type?this.sketchPlanes.push(e):"work_plane"===e.userData.type?this.workPlanes.push(e):"group"===e.userData.type&&(this.groups||(this.groups=[]),this.groups.push(e)),t&&this.selectSingleObject(e),this.objectsManager.updateSceneStats(),this.objectsManager.updateSceneList(),this.updatePropertiesPanel()}clearSelection(){this.selectedObjects.forEach(e=>this.objectsManager.unhighlightObject(e)),this.selectedObjects=[];const e=this.toolManager.getCurrentTool();e&&e.isTransformTool&&e.detach&&e.detach(),this.updatePropertiesPanel(),this.updateStatus(),this.switchToTab("library")}setCurrentTool(e){this.toolManager.setCurrentTool(e)}deleteObject(e){if(!confirm("Удалить объект?"))return;e.parent&&e.parent.remove(e);const t=this.objects.indexOf(e);if(t>-1&&this.objects.splice(t,1),"sketch_plane"===e.userData.type){const t=this.sketchPlanes.indexOf(e);t>-1&&this.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.workPlanes.indexOf(e);t>-1&&this.workPlanes.splice(t,1)}else if("group"===e.userData.type){const t=this.groups.indexOf(e);t>-1&&this.groups.splice(t,1)}const s=this.selectedObjects.indexOf(e);s>-1&&this.selectedObjects.splice(s,1),e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose(),this.objectsManager.updateSceneStats(),this.objectsManager.updateSceneList(),this.updatePropertiesPanel(),this.showStatus("Объект удален","info")}deleteSelected(){if(0===this.selectedObjects.length)return;const e=this.selectedObjects.map(e=>({uuid:e.uuid,data:e.userData}));this.history.addAction({type:"delete",objects:e}),this.selectedObjects.forEach(e=>{this.objectsGroup.remove(e);const t=this.objects.indexOf(e);if(t>-1&&this.objects.splice(t,1),"sketch_plane"===e.userData.type){const t=this.sketchPlanes.indexOf(e);t>-1&&this.sketchPlanes.splice(t,1)}else if("work_plane"===e.userData.type){const t=this.workPlanes.indexOf(e);t>-1&&this.workPlanes.splice(t,1)}else if("group"===e.userData?.type){const t=this.groups.indexOf(e);t>-1&&this.groups.splice(t,1)}e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),this.clearSelection(),this.objectsManager.updateSceneStats(),this.objectsManager.updateSceneList()}centerSelected(e){0!==this.selectedObjects.length&&(this.selectedObjects.forEach(t=>{const s=(new THREE.Box3).setFromObject(t),i=new THREE.Vector3;switch(s.getCenter(i),e){case"x":t.position.x=0;break;case"y":t.position.y=0;break;case"z":t.position.z=0;break;case"all":t.position.set(0,0,0)}}),this.updatePropertiesPanel(),this.history.addAction({type:"center",objects:this.selectedObjects.map(e=>e.uuid),axis:e}))}setView(e){const t={home:[100,100,100],isometric:[100,100,100],front:[0,0,100],back:[0,0,-100],top:[0,100,0],bottom:[0,-100,0],left:[-100,0,0],right:[100,0,0]};if(console.log("setView",e,this.toolManager.currentTool.name),"home"===e&&"sketch"===this.toolManager.currentTool.name)this.sketchManager&&this.sketchManager.viewManager.setViewCameraToCurrentPlane();else if(t[e]){this.camera.lookAt(0,0,0);const s=new THREE.Vector3(0,1,0);this.camera.up.copy(s),this.camera.position.set(...t[e])}if("perspective"===e){if(!(this.camera instanceof THREE.PerspectiveCamera)){const e=this.camera.aspect||this.renderer.domElement.width/this.renderer.domElement.height,t=new THREE.PerspectiveCamera(60,e,.1,1e3);t.position.copy(this.camera.position),t.quaternion.copy(this.camera.quaternion),t.up.copy(this.camera.up),this.controls.object=t,this.camera.dispose&&this.camera.dispose(),this.camera=t}}else if("orthographic"===e&&!(this.camera instanceof THREE.OrthographicCamera)){const e=this.renderer.domElement.width/this.renderer.domElement.height,t=150,s=new THREE.OrthographicCamera(-t*e/2,t*e/2,t/2,-t/2,.1,1e3);s.position.copy(this.camera.position),s.quaternion.copy(this.camera.quaternion),s.up.copy(this.camera.up),this.controls.object=s,this.camera.dispose&&this.camera.dispose(),this.camera=s}this.camera.updateProjectionMatrix(),this.controls.update()}toggleGrid(){this.gridVisible=!this.gridVisible,this.gridHelper&&(this.gridHelper.visible=this.gridVisible),this.showStatus("Сетка: "+(this.gridVisible?"вкл":"выкл"),"info")}SetGridVisible(e){this.gridHelper&&(this.gridHelper.visible=e)}toggleAxes(){this.axesVisible=!this.axesVisible,this.axesHelper&&(this.axesHelper.visible=this.axesVisible),this.showStatus("Оси: "+(this.axesVisible?"вкл":"выкл"),"info")}toggleWireframe(){this.selectedObjects.length>0&&(this.selectedObjects.forEach(e=>{void 0!==e.material.wireframe&&(e.material.wireframe=!e.material.wireframe)}),this.showStatus("Режим каркаса переключен","info"))}focusCameraOnObject(e){this.objectsManager&&e&&this.objectsManager.focusCameraOnObject(e)}handleHistoryKeys(e){switch(e.key.toLowerCase()){case"z":case"я":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),e.shiftKey?this.redo():this.undo());break;case"y":case"н":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.redo())}return!1}isModalOpen(){const e=document.querySelectorAll(".modal-overlay");for(const t of e)if(t.classList.contains("active"))return!0;return!1}closeActiveModal(){const e=document.querySelector(".modal-overlay.active");e&&e.classList.remove("active")}isEditorKeyProcessingAllowed(){if(this.isModalOpen())return!1;const e=document.activeElement;return!("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName)}onKeyDown(e){if(!this.isEditorKeyProcessingAllowed())return void("Escape"===e.key&&this.closeActiveModal());if(this.handleHistoryKeys(e))return!0;if(this.toolManager.handleKeyDown(e))return;console.log("toolManager handleKeyDown",this.toolManager.handleKeyDown(e));switch(e.key.toLowerCase()){case"delete":this.deleteSelected();break;case"s":case"ы":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.projectManager.saveProject());break;case"n":case"т":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.projectManager.newProject());break;case"к":case"r":e.ctrlKey||e.metaKey?(e.preventDefault(),this.projectManager.newProject()):(e.altKey||e.shiftKey)&&this.setView("home");break;case" ":this.spacePressed||(this.spacePressed=!0,this.originalMouseButtons={...this.controls.mouseButtons},this.controls.mouseButtons.LEFT=THREE.MOUSE.PAN);break;case"р":case"h":if((e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.dragManager)){const e=this.dragManager.toggleSnapToGrid();document.getElementById("toggleGrid").classList.toggle("active",e)}break;case"c":case"с":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.copySelectedObjects();break;case"v":case"м":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.pasteObjects();break;case"d":case"в":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.duplicateSelectedObjects();break;case"a":case"ф":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.selectAllObjects()}}onKeyUp(e){this.toolManager.handleKeyUp(e)," "===e.key&&this.spacePressed&&this.originalMouseButtons&&(this.spacePressed=!1,this.controls.mouseButtons=this.originalMouseButtons)}undo(){if(this.history){this.history.undo()&&this.showStatus("Отменено","info")}}redo(){if(this.history){this.history.redo()&&this.showStatus("Повторено","info")}}loadAutoSaveSetting(){const e=localStorage.getItem("cad_autoSaveEnabled");null!==e&&(this.autoSaveEnabled="true"===e)}saveAutoSaveSetting(){localStorage.setItem("cad_autoSaveEnabled",this.autoSaveEnabled)}startSimpleAutoSave(){setInterval(()=>{this.autoSaveEnabled&&this.objects.length>0&&this.projectManager.simpleAutoSave()},6e4),window.addEventListener("beforeunload",()=>{this.autoSaveEnabled&&this.objects.length>0&&this.projectManager.simpleAutoSave()})}loadLastProjectSimple(){const e=this.projectManager.checkAutoSave();e?confirm("Обнаружен последний проект. Загрузить его?")?(this.projectManager.loadProject(e),this.showStatus("Последний проект загружен","success")):(this.projectManager.newProject(),confirm("Удалить автосохранение?")&&localStorage.removeItem("cad_last_project")):this.projectManager.newProject()}animate(){requestAnimationFrame(()=>this.animate()),TWEEN.update(),this.controls.update();const e=this.toolManager.getCurrentTool();e&&e.update&&e.update(),this.renderer.render(this.scene,this.camera),this.updateFPS()}updateFPS(){const e=performance.now(),t=e-this.lastTime;this.frames++,t>=1e3&&(this.fps=Math.round(1e3*this.frames/t),document.getElementById("fpsCounter").textContent=`FPS: ${this.fps}`,this.frames=0,this.lastTime=e)}onWindowResize(){const e=document.getElementById("viewport"),t=e.parentElement.clientWidth,s=e.parentElement.clientHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s)}showStatus(e,t="info",s=3e3){const i=document.getElementById("status");this._statusTimeout&&(clearTimeout(this._statusTimeout),this._statusTimeout=null),i.textContent=e;i.style.background={success:"#00c853",error:"#f44336",warning:"#ff9800",info:"#2196f3"}[t]||"#2196f3";const o="error"===t?5e3:s;this._statusTimeout=setTimeout(()=>{i.textContent="Готов",i.style.background="#00c853",this._statusTimeout=null},o)}updatePropertiesPanel(){if(!document.getElementById("propertiesContent"))return;console.log("Обновление панели свойств");const e=document.querySelector('.property-group[data-type="center"]'),t=document.querySelector('.property-group[data-type="appearance"]');if(e&&(e.style.display=this.selectedObjects.length>0?"block":"none"),t&&(t.style.display=1===this.selectedObjects.length?"block":"none"),e&&this.selectedObjects.length>0){const t=e.querySelector("h4");t&&(t.innerHTML=`<i class="fas fa-bullseye"></i> Центрирование (${this.selectedObjects.length} объектов)`)}if(t&&1===this.selectedObjects.length){const e=this.selectedObjects[0],t=document.getElementById("objectColor");if(t&&e.material){const s=new THREE.Color(e.material.color);t.value=s.getStyle(),t.disabled=!1}else t&&(t.disabled=!0);const s=document.getElementById("objectOpacity");s&&e.material?(s.value=void 0!==e.material.opacity?e.material.opacity:1,s.disabled=!1):s&&(s.disabled=!0)}const s=this.toolManager.getCurrentTool();s&&s instanceof TransformToolBase&&console.log(`Активный инструмент: ${s.name}, он управляет своими свойствами`)}updateStatus(){const e=this.toolManager.getCurrentTool(),t=e?e.name:"select",s={select:"Выделение",move:"Перемещение",rotate:"Вращение",scale:"Масштабирование",sketch:"Скетч",extrude:"Вытягивание",rulerTool:"Линейка",gearGenerator:"Шестерня",threadGenerator:"Резьба",workplane:"Рабочая плоскость",split:"Разрезание",mirror:"Отражение",group:"Группировка",ungroup:"Разгруппировка",imageTool:"Изображение","boolean-union":"Объединение","boolean-subtract":"Вычитание","boolean-intersect":"Пересечение"}[t]||t;document.getElementById("modeIndicator").innerHTML=`<i class="fas fa-mouse-pointer"></i> Режим: ${s}`,document.getElementById("selectedInfo").textContent=`Выбрано: ${this.selectedObjects.length}`,this.updateToolButtons()}updateToolButtons(){const e=this.toolManager.getCurrentTool(),t=e?e.name:"select";document.querySelectorAll("[data-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.tool===t&&e.classList.add("active")})}updateCoordinates(e){this.raycaster.setFromCamera(this.mouse,this.camera);const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),s=new THREE.Vector3;this.raycaster.ray.intersectPlane(t,s)&&(document.getElementById("coords").textContent=`X: ${s.x.toFixed(2)}, Y: ${s.y.toFixed(2)}, Z: ${s.z.toFixed(2)}`)}onObjectColorChange(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0];let s=t.material;if(s||(s=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide}),t.material=s,t.userData.originalMaterial||(t.userData.originalMaterial=s.clone())),!s.color)return void this.showStatus("Материал объекта не поддерживает изменение цвета","error");const i=e.target.value,o=s.color.getHex?s.color.getHex():8421504;this.setObjectColor(t,i),this.history.addAction({type:"modify_color",object:t.uuid,data:{color:i,previousColor:o}})}onObjectOpacityChange(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0];let s=t.material;s||(s=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide,transparent:!0}),t.material=s,t.userData.originalMaterial||(t.userData.originalMaterial=s.clone()));const i=parseFloat(e.target.value),o=void 0!==s.opacity?s.opacity:1;this.setObjectOpacity(t,i),this.history.addAction({type:"modify_opacity",object:t.uuid,data:{opacity:i,previousOpacity:o}})}setObjectColor(e,t){if(!e)return;const s=new THREE.Color(t);if(!e.material)return e.material=new THREE.MeshStandardMaterial({color:s,side:THREE.FrontSide}),e.material.needsUpdate=!0,e.userData.originalMaterial=e.material.clone(),void(e.userData.currentColor=t);if(e.userData.originalMaterial){const t=e.userData.originalMaterial.clone();t.color.copy(s),e.userData.originalMaterial=t}else e.userData.originalMaterial=e.material.clone(),e.userData.originalMaterial.color.copy(s);e.material.color.copy(s),e.material.needsUpdate=!0,e.userData.currentColor=t}setObjectOpacity(e,t){if(e){if(!e.material)return e.material=new THREE.MeshStandardMaterial({color:8421504,side:THREE.FrontSide,transparent:t<1,opacity:t}),e.material.needsUpdate=!0,e.userData.originalMaterial=e.material.clone(),void(e.userData.currentOpacity=t);if(e.userData.originalMaterial){const s=e.userData.originalMaterial.clone();s.opacity=t,s.transparent=t<1,e.userData.originalMaterial=s}else e.userData.originalMaterial=e.material.clone(),e.userData.originalMaterial.opacity=t,e.userData.originalMaterial.transparent=t<1;e.material.opacity=t,e.material.transparent=t<1,e.material.needsUpdate=!0,e.userData.currentOpacity=t}}findObjectByUuid(e){return this.objects.find(t=>t.uuid===e)||null}}window.addEventListener("DOMContentLoaded",()=>{window.cadEditor=new CADEditor});