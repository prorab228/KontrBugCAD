
// ===== ЗАЩИТА КОНТРБАГТЕХ =====
const ALLOWED_HOSTS = ['prorab228.github.io', 'cad.xn--80abhivsgrre8a.xn--p1ai', 'контрбагтех.рф' ,'cad.контрбагтех.рф'];
const isElectron = navigator.userAgent.includes('Electron');
if (!isElectron && !ALLOWED_HOSTS.includes(window.location.hostname)) {
    document.body.innerHTML = '<div style="padding:40px;text-align:center;background:#1a1a1a;color:white;height:100vh;display:flex;align-items:center;justify-content:center;"><div><h2 style="color:#ff9800;">Доступ ограничен</h2><p>Редактор КонтрБагCAD работает только на официальном сайте.</p><p><a href="https://cad.xn--80abhivsgrre8a.xn--p1ai/" style="color:#4CAF50;">Перейти на официальную страницу</a></p></div></div>';
    throw new Error('Access denied: Используйте официальный сайт.');
}
// ===== КОНЕЦ ЗАЩИТЫ =====

class CADEditor{constructor(){this.APP_VERSION="0.9.3",this.APP_NAME="КонтрБагCAD",this.APP_AUTHOR="Лунев Валерий Константинович",this.translator=window.translator,this.autoSaveEnabled=!0,this.scene=new THREE.Scene,this.camera=null,this.renderer=null,this.navigationCube=null,this.cameraManager=null,this.themeManager=null,this.controls=null,this.parametricModel=null,this.selectedObjects=[],this.gridUnit="mm",this.gridStep=5,this.autoSaveEnabled=!0,this.workPlanes=[],this.sketchPlanes=[],this.clipboard=[],this.basePlanes=null,this.worldGroup=null,this.gridVisible=!0,this.axesVisible=!0,this.gridHelper=null,this.axesHelper=null,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.spacePressed=!1,this.originalMouseButtons=null,this.objectsManager=null,this.planesManager=null,this.extrudeManager=null,this.revolveManager=null,this.projectManager=null,this.libraryManager=null,this.dragManager=null,this.toolManager=null,this.booleanOps=null,this.importManager=null,this.exportManager=null,this.gearGenerator=null,this.threadGenerator=null,this.mmScale=1,this.pendingPrimitive=null,this.frames=0,this.lastTime=performance.now(),this.fps=60,this._statusTimeout=null,this.focusCameraOnObject=this.focusCameraOnObject.bind(this),this.init()}init(){this.loadAutoSaveSetting(),this.initThreeJS(),this.initManagers(),this.initUI(),this.initEventListeners(),this.animate(),this.initFileDrop(),this.planesManager.createBasePlanes(),this.initLanguageControls(),this.startSimpleAutoSave(),setTimeout(async()=>{await this.fontManager.waitForFonts(this.fontManager.availableFonts.map(e=>e.name)),await this.loadLastProjectSimple()},100)}initThreeJS(){const e=document.getElementById("viewport"),t=e.parentElement.clientWidth,s=e.parentElement.clientHeight;this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(t,s),this.renderer.setClearColor(1710618,1),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,e.appendChild(this.renderer.domElement),this.cameraManager=new CameraManager(this.renderer),this.themeManager=new ThemeManager(this),this.themeManager.init(),this.camera=this.cameraManager.camera,this.controls=this.cameraManager.controls,this.navigationCube=new NavigationCube(this.cameraManager,this.themeManager),this.cameraManager.setupCamera(t,s),this.worldGroup=new THREE.Group,this.scene.add(this.worldGroup),this.initLighting(),this.initHelpers(),this.objectsGroup=new THREE.Group,this.worldGroup.add(this.objectsGroup),this.sketchGroup=new THREE.Group,this.worldGroup.add(this.sketchGroup),this.renderer.domElement.addEventListener("contextmenu",e=>e.preventDefault())}initManagers(){this.parametricModel=new ParametricModel(this),this.historyPanel=new HistoryPanel(this),this.parametricModel.onHistoryChange(()=>this.historyPanel.update()),this.parametricModel.onModelRebuilt(()=>this.restoreSelectionAfterRebuild()),this.objectsManager=new ObjectsManager(this),this.importManager=new ImportManager(this),this.exportManager=new ExportManager(this),this.projectManager=new ProjectManager(this),this.libraryManager=new LibraryManager(this),this.planesManager=new PlanesManager(this),this.sketchManager=new SketchManager(this),this.extrudeManager=new ExtrudeManager(this),this.revolveManager=new RevolveManager(this),this.dragManager=new DragManager(this),this.toolManager=new ToolManager(this),this.booleanOps=new BooleanOperations(this),this.fontManager=new FontManager(this),this.initTools()}initTools(){this.gearGenerator=new GearGenerator,this.threadGenerator=new ThreadGenerator,this.toolManager.registerTool("select",new SelectTool(this)),this.toolManager.registerTool("move",new MoveTool(this)),this.toolManager.registerTool("rotate",new RotateTool(this)),this.toolManager.registerTool("scale",new ScaleTool(this)),this.toolManager.registerTool("sketch",new SketchTool(this)),this.toolManager.registerTool("extrude",new ExtrudeTool(this)),this.toolManager.registerTool("revolve",new RevolveTool(this)),this.toolManager.registerTool("workplane",new WorkPlaneTool(this)),this.toolManager.registerTool("rulerTool",new RulerTool(this)),this.toolManager.registerTool("gearGenerator",new GearTool(this)),this.toolManager.registerTool("threadGenerator",new ThreadTool(this)),this.toolManager.registerTool("split",new SplitTool(this)),this.toolManager.registerTool("mirror",new MirrorTool(this)),this.toolManager.registerTool("group",new GroupTool(this)),this.toolManager.registerTool("ungroup",new UngroupTool(this)),this.toolManager.registerTool("chamfer",new FilletChamferTool(this)),this.toolManager.registerTool("text3dTool",new Text3DTool(this)),this.toolManager.registerTool("boolean-union",new BooleanUnionTool(this)),this.toolManager.registerTool("boolean-subtract",new BooleanSubtractTool(this)),this.toolManager.registerTool("boolean-intersect",new BooleanIntersectTool(this)),this.toolManager.registerTool("repair",new RepairTool(this)),this.toolManager.registerTool("decimate",new DecimateTool(this)),this.toolManager.registerTool("imageTool",new ImageTool(this)),this.toolManager.setCurrentTool("select")}initLighting(){const e=new THREE.AmbientLight(16777215,.6);this.scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(10,20,15),t.castShadow=!0,t.shadow.camera.left=-20,t.shadow.camera.right=20,t.shadow.camera.top=20,t.shadow.camera.bottom=-20,this.scene.add(t);const s=new THREE.DirectionalLight(16777215,.4);s.position.set(-10,10,-10),this.scene.add(s)}createMainGrid(){this.gridHelper&&(this.worldGroup.remove(this.gridHelper),this.gridHelper.geometry.dispose(),this.gridHelper.material.dispose(),this.gridHelper=null);let e=this.gridStep;"inch"===this.gridUnit&&(e*=25.4);const t=Math.floor(500/e);this.gridHelper=new THREE.GridHelper(500,t,10066329),this.gridHelper.position.y=0,this.gridHelper.visible=this.gridVisible,this.worldGroup.add(this.gridHelper),console.log(`Создана основная сетка: шаг=${e}, единицы=${this.gridUnit}, делений=${t}`)}initHelpers(){const e=localStorage.getItem("cad-grid-unit")||"mm",t=localStorage.getItem("cad-grid-step")||5;if(e&&(this.gridUnit=e),t&&(this.gridStep=parseFloat(t)),this.createMainGrid(),this.axesHelper=new THREE.AxesHelper(50),this.axesHelper.visible=this.axesVisible,this.worldGroup.add(this.axesHelper),this.gridHelper){const e=localStorage.getItem("cad-grid-color")||"#FFFFFF";this.gridHelper.material.color.set(new THREE.Color(e))}}initUI(){document.getElementById("undo").addEventListener("click",()=>this.undo()),document.getElementById("redo").addEventListener("click",()=>this.redo()),document.getElementById("deleteObject").addEventListener("click",()=>this.deleteSelected()),document.getElementById("copyObject").addEventListener("click",()=>this.copySelectedObjects()),document.getElementById("pasteObject").addEventListener("click",()=>this.pasteObjects()),document.getElementById("duplicateObject").addEventListener("click",()=>this.duplicateSelectedObjects()),document.getElementById("toggleGrid").addEventListener("click",()=>this.toggleGrid()),document.getElementById("toggleAxes").addEventListener("click",()=>this.toggleAxes()),document.getElementById("toggleWireframe").addEventListener("click",()=>this.toggleWireframe()),document.getElementById("version").innerHTML=`<strong>Версия:</strong> ${this.APP_VERSION}`,this.objectsManager.updateSceneStats()}initLanguageControls(){const e=document.getElementById("languageSelect");e&&(e.value=this.translator.currentLang,e.addEventListener("change",async e=>{const t=e.target.value;await this.translator.setLanguage(t);const s=this.translator.getLanguageName(t);this.showStatus(`Язык изменен на ${s}`,"info"),this.updateDynamicContent()})),window.addEventListener("languageChanged",()=>{this.updateDynamicContent()}),this.updateDynamicContent()}updateDynamicContent(){this.updateStatus(),this.objectsManager&&this.objectsManager.updateSceneStats(),this.historyPanel&&this.historyPanel.update(),this.navigationCube&&this.navigationCube.setLetters(this.translator.getNavigationCubeLetters()),console.log("translation",this.navigationCube)}initEventListeners(){window.addEventListener("resize",()=>this.onWindowResize()),this.initMouseHandlers(),this.initTouchHandlers(),this.initKeyboardHandlers(),this.initFileOperations(),this.initBooleanOperations(),this.initModalHandlers(),this.initPanelTabs(),this.initPropertyControls(),this.initThemeControls(),this.initEnvironmentControls()}initFileOperations(){document.getElementById("newProject").addEventListener("click",()=>this.projectManager.newProject()),document.getElementById("openProject").addEventListener("click",()=>this.projectManager.openProject()),document.getElementById("saveProject").addEventListener("click",()=>this.projectManager.showSaveModal()),document.getElementById("exportBtn").addEventListener("click",()=>this.exportManager.showExportModal()),document.getElementById("importBtn").addEventListener("click",()=>this.importManager.import())}initFileDrop(){document.getElementById("viewport").addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation();const t=e.dataTransfer.files;if(0===t.length)return;const s=t[0],a=s.name.split(".").pop().toLowerCase();if(["stl","obj","3mf"].includes(a))this.importManager.handleDrop(e);else if(s.type.startsWith("image/")){const t=this.toolManager.getCurrentTool();t&&"imageTool"===t.name&&t.handleDrop?t.handleDrop(e):(this.toolManager.setCurrentTool("imageTool"),setTimeout(()=>{const t=this.toolManager.getTool("imageTool");t&&t.handleDrop&&t.handleDrop(e)},100))}})}initBooleanOperations(){document.getElementById("booleanUnion").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-union")}),document.getElementById("booleanSubtract").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-subtract")}),document.getElementById("booleanIntersect").addEventListener("click",()=>{this.toolManager.setCurrentTool("boolean-intersect")})}initModalHandlers(){document.querySelectorAll(".close-modal").forEach(e=>{e.addEventListener("click",e=>{const t=e.target.closest(".modal-overlay");t&&t.classList.remove("active")})}),document.getElementById("aboutBtn").addEventListener("click",()=>{const e=document.getElementById("aboutModal");e.querySelector("h4").textContent=this.APP_NAME,e.querySelector("p:nth-child(2)").innerHTML=`<strong>Версия:</strong> ${this.APP_VERSION}`,e.querySelector("p:nth-child(3)").innerHTML=`<strong>Разработчик:</strong> ${this.APP_AUTHOR}`,e.classList.add("active")}),document.getElementById("cancelExport").addEventListener("click",()=>{document.getElementById("exportModal").classList.remove("active")}),document.getElementById("confirmExport").addEventListener("click",()=>{this.exportManager.exportModel(),document.getElementById("exportModal").classList.remove("active")}),document.getElementById("cancelSave").addEventListener("click",()=>{document.getElementById("saveModal").classList.remove("active")}),document.getElementById("confirmSave").addEventListener("click",()=>{this.projectManager.saveProject(),document.getElementById("saveModal").classList.remove("active")})}initPanelTabs(){document.querySelectorAll(".panel-tab").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.tab;document.querySelectorAll(".panel-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".panel-content").forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById(`${t}Content`).classList.add("active")})})}switchToTab(e){const t=document.querySelectorAll(".panel-tab"),s=document.querySelectorAll(".panel-content");t.forEach(e=>e.classList.remove("active")),s.forEach(e=>e.classList.remove("active"));const a=document.querySelector(`.panel-tab[data-tab="${e}"]`),i=document.getElementById(`${e}Content`);a&&a.classList.add("active"),i&&i.classList.add("active")}initPropertyControls(){document.getElementById("objectColor").addEventListener("input",e=>{this.onObjectColorChange(e)}),document.getElementById("objectColor").addEventListener("change",e=>{this.onObjectColorChangeCommit(e)}),document.getElementById("objectOpacity").addEventListener("input",e=>{this.onObjectOpacityChange(e)}),document.getElementById("objectOpacity").addEventListener("change",e=>{this.onObjectOpacityChangeCommit(e)}),Object.entries({centerX:"x",centerY:"y",centerZ:"z",centerAll:"all"}).forEach(([e,t])=>{const s=document.getElementById(e);s&&s.addEventListener("click",()=>this.centerSelected(t))});const e=document.getElementById("extrudeSketchBtn");e&&e.addEventListener("click",()=>{this.toolManager.setCurrentTool("extrude")})}initThemeControls(){document.querySelectorAll(".theme-btn").forEach(e=>{e.addEventListener("click",t=>{const s=e.dataset.theme;this.setTheme(s),document.querySelectorAll(".theme-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active")})});const e=localStorage.getItem("cad-theme")||"light";this.setTheme(e,!1);const t=document.querySelector(`.theme-btn[data-theme="${e}"]`);t&&t.classList.add("active")}initEnvironmentControls(){const e=document.getElementById("backgroundColor");if(e){e.addEventListener("change",e=>{this.renderer.setClearColor(new THREE.Color(e.target.value)),localStorage.setItem("cad-bg-color",e.target.value)});const t=localStorage.getItem("cad-bg-color")||"#FFFFFF";e.value=t,this.renderer.setClearColor(new THREE.Color(t))}const t=document.getElementById("gridColor");if(t&&this.gridHelper){t.addEventListener("change",e=>{this.gridHelper.material.color.set(new THREE.Color(e.target.value)),localStorage.setItem("cad-grid-color",e.target.value)});const e=localStorage.getItem("cad-grid-color")||"#FFFFFF";t.value=e,this.gridHelper.material.color.set(new THREE.Color(e))}const s=document.getElementById("autoSaveCheckbox");s&&(s.checked=this.autoSaveEnabled,s.addEventListener("change",e=>{this.autoSaveEnabled=e.target.checked,this.saveAutoSaveSetting(),this.showStatus("Автосохранение "+(this.autoSaveEnabled?"включено":"выключено"),"info")}));const a=document.getElementById("mainGridUnit"),i=document.getElementById("mainGridStep");a&&(a.value=this.gridUnit,a.addEventListener("change",e=>{this.gridUnit=e.target.value,localStorage.setItem("cad-grid-unit",this.gridUnit),"mm"===this.gridUnit?(this.gridStep=5,this.sketchManager.gridStep=1):(this.gridStep=1/8,this.sketchManager.gridStep=1/16),this.updateGridStepOptions(),"sketch"==this.toolManager.currentTool.name&&(this.sketchManager.viewManager.updateGrid(),this.toolManager.getTool("sketch").updateGridStepOptions()),this.createMainGrid(),this.showStatus("Единицы сетки: "+("mm"===this.gridUnit?"мм":"дюймы"),"info")})),i&&(this.updateGridStepOptions(),i.addEventListener("change",e=>{this.gridStep=parseFloat(e.target.value),localStorage.setItem("cad-grid-step",this.gridStep),this.createMainGrid(),this.showStatus(`Шаг сетки: ${this.gridStep} ${"mm"===this.gridUnit?"мм":1===this.gridStep?"дюйм":"дюйма"}`,"info")}));const o=document.getElementById("resetEnvironment");o&&o.addEventListener("click",()=>{this.resetEnvironment()})}updateGridStepOptions(){const e=document.getElementById("mainGridStep");if(e)if(e.innerHTML="","mm"===this.gridUnit){[.1,.2,.5,1,2,5,10].forEach(t=>{const s=document.createElement("option");s.value=t,s.textContent=`${t} мм`,Math.abs(t-this.gridStep)<.001&&(s.selected=!0),e.appendChild(s)})}else{[{value:1/64,label:'1/64"'},{value:1/32,label:'1/32"'},{value:1/16,label:'1/16"'},{value:1/8,label:'1/8"'},{value:1/4,label:'1/4"'},{value:.5,label:'1/2"'},{value:1,label:'1"'}].forEach(t=>{const s=document.createElement("option");s.value=t.value,s.textContent=t.label,Math.abs(t.value-this.gridStep)<.001&&(s.selected=!0),e.appendChild(s)})}}setTheme(e,t=!0){if(this.themeManager.setTheme(e),t){let t,s;"dark"===e?(t="#3a3a3a",s="#AAAAAA"):(t="#ffffff",s="#ffffff"),this.renderer&&this.renderer.setClearColor(new THREE.Color(t)),this.gridHelper&&this.gridHelper.material.color.set(new THREE.Color(s));const a=document.getElementById("backgroundColor");a&&(a.value=t);const i=document.getElementById("gridColor");i&&(i.value=s),localStorage.setItem("cad-bg-color",t),localStorage.setItem("cad-grid-color",s)}const s=document.querySelector(".theme-controls .fa-sun, .theme-controls .fa-moon");if(s){const e=this.themeManager.isDark();s.className=e?"fas fa-moon":"fas fa-sun"}}resetEnvironment(){localStorage.removeItem("cad-bg-color"),localStorage.removeItem("cad-grid-color"),localStorage.removeItem("cad-grid-unit"),localStorage.removeItem("cad-grid-step"),this.renderer.setClearColor(16777215,1),document.getElementById("backgroundColor").value="#FFFFFF",this.gridHelper&&this.gridHelper.material.color.set(16777215),document.getElementById("gridColor").value="#FFFFFF",this.gridUnit="mm",this.gridStep=5,this.createMainGrid();const e=document.getElementById("mainGridUnit"),t=document.getElementById("mainGridStep");e&&(e.value="mm"),t&&this.updateGridStepOptions(),this.showStatus("Настройки окружения сброшены","info")}initMouseHandlers(){const e=this.renderer.domElement;e.addEventListener("mousedown",e=>this.handleMouseDown(e)),e.addEventListener("mousemove",e=>this.handleMouseMove(e)),e.addEventListener("mouseup",e=>this.handleMouseUp(e)),e.addEventListener("dblclick",e=>this.handleDoubleClick(e))}shouldInterceptTouch(){const e=this.toolManager.getCurrentTool();if(!e)return!1;const t=e.name,s=this.selectedObjects.length>0,a=["move","rotate","scale","extrude","revolve","sketch","rulerTool"].includes(t);return s||a}initTouchHandlers(){const e=this.renderer.domElement;let t=null,s=0,a=0,i=0;e.addEventListener("touchstart",e=>{if(1===e.touches.length&&this.shouldInterceptTouch()){e.preventDefault(),e.stopPropagation();const o=e.touches[0];t=o.identifier,this.controls&&(this.controls.enabled=!1);const n=Date.now(),r=o.clientX-a,l=o.clientY-i,c=Math.sqrt(r*r+l*l);if(n-s<300&&c<20){const e={clientX:o.clientX,clientY:o.clientY,button:0,preventDefault:()=>{},stopPropagation:()=>{}};this.updateMousePosition(e),this.handleDoubleClick&&this.handleDoubleClick(e),s=0}else{const e={clientX:o.clientX,clientY:o.clientY,button:0,preventDefault:()=>{},stopPropagation:()=>{}};this.updateMousePosition(e),this.handleMouseDown(e)}s=n,a=o.clientX,i=o.clientY}else t=null,this.controls&&(this.controls.enabled=!0)}),e.addEventListener("touchmove",e=>{if(null!==t){const s=Array.from(e.touches).find(e=>e.identifier===t);if(s){e.preventDefault(),e.stopPropagation();const t={clientX:s.clientX,clientY:s.clientY,button:0,preventDefault:()=>{},stopPropagation:()=>{}};this.updateMousePosition(t),this.handleMouseMove(t)}else t=null}}),e.addEventListener("touchend",e=>{if(null!==t){const s=Array.from(e.changedTouches).find(e=>e.identifier===t);if(s){e.preventDefault(),e.stopPropagation();const a={clientX:s.clientX,clientY:s.clientY,button:0,preventDefault:()=>{},stopPropagation:()=>{}};this.updateMousePosition(a),this.handleMouseUp(a),t=null}}0===e.touches.length&&this.controls&&(this.controls.enabled=!this.shouldInterceptTouch())}),e.addEventListener("touchcancel",e=>{null!==t&&(this.handleMouseUp({button:0}),t=null),0===e.touches.length&&this.controls&&(this.controls.enabled=!this.shouldInterceptTouch())})}initKeyboardHandlers(){document.addEventListener("keydown",e=>this.onKeyDown(e)),document.addEventListener("keyup",e=>this.onKeyUp(e))}handleMouseDown(e){const t=0===e.button,s=2===e.button,a=1===e.button;t&&(e.preventDefault(),this.updateMousePosition(e),this.toolManager.handleMouseDown(e))||(s&&(document.body.style.cursor="grab"),a&&(document.body.style.cursor="move"))}handleMouseMove(e){this.updateMousePosition(e),this.updateCoordinates(e),this.toolManager.handleMouseMove(e)}handleMouseUp(e){const t=2===e.button,s=1===e.button;(t||s)&&(document.body.style.cursor="default"),0===e.button&&this.toolManager.handleMouseUp(e)}handleDoubleClick(e){this.toolManager.handleDoubleClick(e)}updateMousePosition(e){const t=this.renderer.domElement.getBoundingClientRect();this.mouse.x=(e.clientX-t.left)/t.width*2-1,this.mouse.y=-(e.clientY-t.top)/t.height*2+1}toggleObjectSelection(e){const t=this.selectedObjects.indexOf(e);t>-1?(this.selectedObjects.splice(t,1),this.objectsManager.unhighlightObject(e)):(this.selectedObjects.push(e),this.objectsManager.highlightObject(e)),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus()}selectSingleObject(e){this.clearSelection(!1),this.selectedObjects=[e],this.objectsManager.highlightObject(e);const t=this.toolManager.getCurrentTool();t&&t.isTransformTool&&t.attachToObject&&t.attachToObject(e),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus(),this.switchToTab("properties")}clearSelection(e=!0){this.selectedObjects.forEach(e=>this.objectsManager.unhighlightObject(e)),this.selectedObjects=[];const t=this.toolManager.getCurrentTool();t&&t.isTransformTool&&t.detach&&t.detach(),this.updatePropertiesPanel(),this.updateStatus(),e&&this.switchToTab("library")}copySelectedObjects(){return"sketch"===this.toolManager.currentTool.name?(this.showStatus("Копирование недоступно в режиме скетча","warning"),!1):0===this.selectedObjects.length?(this.showStatus("Нет объектов для копирования","warning"),!1):(this.clipboard=this.selectedObjects.map(e=>e.uuid),this.showStatus(`Скопировано: ${this.selectedObjects.length} объектов`,"success"),!0)}pasteObjects(){if("sketch"===this.toolManager.currentTool.name)return this.showStatus("Вставка недоступна в режиме скетча","warning"),!1;if(0===this.clipboard.length)return this.showStatus("Буфер обмена пуст","warning"),!1;if(this.clipboard.filter(e=>!this.parametricModel.objectMap.has(e)).length>0)return this.showStatus("Некоторые исходные объекты были удалены. Буфер очищен.","error"),this.clipboard=[],!1;this.clearSelection(!1);const e=new ParametricOperation("duplicate",{sourceUuids:[...this.clipboard],offset:[10,0,0]},[]),t=this.parametricModel.addOperation(e,!0);return this.selectObjects(t),this.showStatus(`Вставлено: ${t.length} объектов`,"success"),!0}duplicateSelectedObjects(){if("sketch"===this.toolManager.currentTool.name)return this.showStatus("Дублирование недоступно в режиме скетча","warning"),!1;if(0===this.selectedObjects.length)return this.showStatus("Нет объектов для дублирования","warning"),!1;const e=this.selectedObjects.map(e=>e.uuid);if(e.filter(e=>!this.parametricModel.objectMap.has(e)).length>0)return this.showStatus("Некоторые выбранные объекты больше не существуют. Выделение сброшено.","error"),this.clearSelection(!1),!1;this.clearSelection(!1);const t=new ParametricOperation("duplicate",{sourceUuids:e,offset:[10,0,0]},[]),s=this.parametricModel.addOperation(t,!0);return this.selectObjects(s),this.showStatus(`Сдублировано: ${s.length} объектов`,"success"),!0}selectObjects(e){this.clearSelection(!1);e.map(e=>this.findObjectByUuid(e)).filter(e=>e).forEach(e=>{this.selectedObjects.push(e),this.objectsManager.highlightObject(e)}),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus()}selectAllObjects(){if("sketch"==this.toolManager.currentTool.name)return!1;const e=this.objectsManager.getSelectableObjects();return 0===e.length?(this.showStatus("Нет объектов для выделения","warning"),!1):(this.clearSelection(!1),e.forEach(e=>{this.selectedObjects.push(e),this.objectsManager.highlightObject(e)}),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus(),this.showStatus(`Выделено объектов: ${e.length}`,"success"),!0)}restoreSelectionAfterRebuild(){if(0===this.selectedObjects.length)return;const e=this.selectedObjects.map(e=>e.uuid);this.clearSelection(!1);const t=e.map(e=>this.findObjectByUuid(e)).filter(e=>e);t.length>0&&(t.forEach(e=>{this.selectedObjects.push(e),this.objectsManager.highlightObject(e)}),this.updatePropertiesPanel(),this.objectsManager.updateSceneList(),this.updateStatus())}deleteObject(e){if(!e)return;if(!confirm("Удалить объект?"))return;this.parametricModel.deleteObjects([e.uuid]);const t=this.selectedObjects.indexOf(e);t>-1&&(this.selectedObjects.splice(t,1),this.objectsManager.unhighlightObject(e))}deleteSelected(){if(0===this.selectedObjects.length)return;const e=this.selectedObjects.map(e=>e.uuid);confirm(`Удалить ${e.length} объектов?`)&&(this.parametricModel.deleteObjects(e),this.clearSelection(!1))}centerSelected(e){0!==this.selectedObjects.length&&(this.selectedObjects.forEach(t=>{const s=t.position.clone();switch(e){case"x":s.x=0;break;case"y":s.y=0;break;case"z":s.z=0;break;case"all":s.set(0,0,0)}const a=new ParametricOperation("move",{target:t.uuid,position:s.toArray()},[]);this.parametricModel.addOperation(a)}),this.updatePropertiesPanel())}setView(e){this.cameraManager.setView(e)}toggleGrid(){this.gridVisible=!this.gridVisible,this.gridHelper&&(this.gridHelper.visible=this.gridVisible),this.showStatus("Сетка: "+(this.gridVisible?"вкл":"выкл"),"info")}SetGridVisible(e){this.gridHelper&&(this.gridHelper.visible=e)}toggleAxes(){this.axesVisible=!this.axesVisible,this.axesHelper&&(this.axesHelper.visible=this.axesVisible),this.showStatus("Оси: "+(this.axesVisible?"вкл":"выкл"),"info")}toggleWireframe(){this.selectedObjects.length>0&&(this.selectedObjects.forEach(e=>{void 0!==e.material.wireframe&&(e.material.wireframe=!e.material.wireframe)}),this.showStatus("Режим каркаса переключен","info"))}focusCameraOnObject(e){this.objectsManager&&e&&this.objectsManager.focusCameraOnObject(e)}undo(){if(this.parametricModel){this.parametricModel.undo()&&this.showStatus("Отменено","info")}}redo(){if(this.parametricModel){this.parametricModel.redo()&&this.showStatus("Повторено","info")}}loadAutoSaveSetting(){const e=localStorage.getItem("cad_autoSaveEnabled");null!==e&&(this.autoSaveEnabled="true"===e)}saveAutoSaveSetting(){localStorage.setItem("cad_autoSaveEnabled",this.autoSaveEnabled)}startSimpleAutoSave(){setInterval(()=>{this.autoSaveEnabled&&this.parametricModel&&this.parametricModel.operations.length>0&&this.projectManager.simpleAutoSave()},6e4),window.addEventListener("beforeunload",()=>{this.autoSaveEnabled&&this.parametricModel&&this.parametricModel.operations.length>0&&this.projectManager.simpleAutoSave()})}async loadLastProjectSimple(){const e=this.projectManager.checkAutoSave();e?confirm("Обнаружен последний проект. Загрузить его?")?(await this.projectManager.loadProject(e),this.showStatus("Последний проект загружен","success")):(this.projectManager.newProject(),confirm("Удалить автосохранение?")&&localStorage.removeItem("cad_last_project")):this.projectManager.newProject()}animate(){requestAnimationFrame(()=>this.animate()),TWEEN.update(),this.cameraManager.updateControls(),this.camera=this.cameraManager.camera,this.controls=this.cameraManager.controls;const e=this.toolManager.getCurrentTool();e&&e.update&&e.update(),this.renderer.render(this.scene,this.cameraManager.camera),this.navigationCube&&(this.navigationCube.update(),this.navigationCube.render()),this.updateFPS()}updateFPS(){const e=performance.now(),t=e-this.lastTime;this.frames++,t>=1e3&&(this.fps=Math.round(1e3*this.frames/t),document.getElementById("fpsCounter").textContent=`FPS: ${this.fps}`,this.frames=0,this.lastTime=e)}onWindowResize(){const e=document.getElementById("viewport"),t=e.parentElement.clientWidth,s=e.parentElement.clientHeight;this.cameraManager.handleResize(t,s),this.renderer.setSize(t,s)}showStatus(e,t="info",s=3e3){const a=document.getElementById("status");this._statusTimeout&&(clearTimeout(this._statusTimeout),this._statusTimeout=null);const i=this.translator.translateDynamic(e);a.textContent=i;a.style.background={success:"#00c853",error:"#f44336",warning:"#ff9800",info:"#2196f3"}[t]||"#2196f3";const o="error"===t?5e3:s;this._statusTimeout=setTimeout(()=>{a.textContent="Готов",a.style.background="#00c853",this._statusTimeout=null},o)}updatePropertiesPanel(){if(!document.getElementById("propertiesContent"))return;const e=document.querySelector('.property-group[data-type="center"]'),t=document.querySelector('.property-group[data-type="appearance"]');if(e&&(e.style.display=this.selectedObjects.length>0?"block":"none"),t&&(t.style.display=1===this.selectedObjects.length?"block":"none"),e&&this.selectedObjects.length>0){const t=e.querySelector("h4");t&&(t.innerHTML=`<i class="fas fa-bullseye"></i> Центрирование (${this.selectedObjects.length} объектов)`)}if(t&&1===this.selectedObjects.length){const e=this.selectedObjects[0],t=document.getElementById("objectColor");if(t&&e.material){const s=new THREE.Color(e.material.color);t.value=s.getStyle(),t.disabled=!1}else t&&(t.disabled=!0);const s=document.getElementById("objectOpacity");s&&e.material?(s.value=void 0!==e.material.opacity?e.material.opacity:1,s.disabled=!1):s&&(s.disabled=!0)}const s=this.toolManager.getCurrentTool();s&&TransformToolBase}updateStatus(){const e=this.toolManager.getCurrentTool(),t=e?e.name:"select",s={select:"Выделение",move:"Перемещение",rotate:"Вращение",scale:"Масштабирование",sketch:"Скетч",extrude:"Вытягивание",rulerTool:"Линейка",gearGenerator:"Шестерня",threadGenerator:"Резьба",workplane:"Рабочая плоскость",split:"Разрезание",mirror:"Отражение",group:"Группировка",ungroup:"Разгруппировка",imageTool:"Изображение","boolean-union":"Объединение","boolean-subtract":"Вычитание","boolean-intersect":"Пересечение",chamfer:"Фаска",text3dTool:"3D Текст"}[t]||t,a=this.translator.translateDynamic(s);document.getElementById("modeIndicator").innerHTML=`<i class="fas fa-mouse-pointer"></i> ${this.translator.translateDynamic("Режим:")} ${a}`,document.getElementById("selectedInfo").textContent=`${this.translator.translateDynamic("Выбрано:")} ${this.selectedObjects.length}`,this.updateToolButtons()}updateToolButtons(){const e=this.toolManager.getCurrentTool(),t=e?e.name:"select";document.querySelectorAll("[data-tool]").forEach(e=>{e.classList.remove("active"),e.dataset.tool===t&&e.classList.add("active")})}updateCoordinates(e){if(!this.cameraManager||!this.cameraManager.camera)return;this.raycaster.setFromCamera(this.mouse,this.cameraManager.camera);const t=new THREE.Plane(new THREE.Vector3(0,1,0),0),s=new THREE.Vector3;this.raycaster.ray.intersectPlane(t,s)&&(document.getElementById("coords").textContent=`X: ${s.x.toFixed(2)}, Y: ${s.y.toFixed(2)}, Z: ${s.z.toFixed(2)}`)}onObjectColorChange(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0],s=e.target.value;t.material&&(t.material.color.set(s),t.material.needsUpdate=!0)}onObjectOpacityChange(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0],s=parseFloat(e.target.value);t.material&&(t.material.opacity=s,t.material.transparent=s<1,t.material.needsUpdate=!0)}onObjectColorChangeCommit(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0],s=e.target.value,a=new ParametricOperation("change_color",{target:t.uuid,color:s},[]);this.parametricModel.addOperation(a)}onObjectOpacityChangeCommit(e){if(1!==this.selectedObjects.length)return;const t=this.selectedObjects[0],s=(parseFloat(e.target.value),new ParametricOperation("change_opacity",{target:t.uuid,opacity:t.material.opacity},[]));this.parametricModel.addOperation(s)}findObjectByUuid(e){return this.parametricModel&&this.parametricModel.objectMap.get(e)||null}isModalOpen(){const e=document.querySelectorAll(".modal-overlay");for(const t of e)if(t.classList.contains("active"))return!0;return!1}closeActiveModal(){const e=document.querySelector(".modal-overlay.active");e&&e.classList.remove("active")}isEditorKeyProcessingAllowed(){if(this.isModalOpen())return!1;const e=document.activeElement;return!("INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName)}onKeyDown(e){if(!this.isEditorKeyProcessingAllowed())return void("Escape"===e.key&&this.closeActiveModal());if(this.handleHistoryKeys(e))return;if(this.toolManager.handleKeyDown(e))return;switch(e.key.toLowerCase()){case"delete":this.deleteSelected();break;case"s":case"ы":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.projectManager.saveProject());break;case"n":case"т":(e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.projectManager.newProject());break;case" ":this.spacePressed||(this.spacePressed=!0,this.originalMouseButtons={...this.controls.mouseButtons},this.controls.mouseButtons.LEFT=THREE.MOUSE.PAN);break;case"р":case"h":if((e.ctrlKey||e.metaKey)&&(e.preventDefault(),this.dragManager)){const e=this.dragManager.toggleSnapToGrid();document.getElementById("toggleGrid").classList.toggle("active",e)}break;case"c":case"с":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.copySelectedObjects();break;case"v":case"м":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.pasteObjects();break;case"d":case"в":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.duplicateSelectedObjects();break;case"a":case"ф":if(e.ctrlKey||e.metaKey)return e.preventDefault(),void this.selectAllObjects()}}handleHistoryKeys(e){switch(e.key.toLowerCase()){case"z":case"я":if(e.ctrlKey||e.metaKey)return e.preventDefault(),e.shiftKey?this.redo():this.undo(),!0;break;case"y":case"н":if(e.ctrlKey||e.metaKey)return e.preventDefault(),this.redo(),!0}return!1}onKeyUp(e){this.toolManager.handleKeyUp(e)," "===e.key&&this.spacePressed&&this.originalMouseButtons&&(this.spacePressed=!1,this.controls.mouseButtons=this.originalMouseButtons)}}window.addEventListener("DOMContentLoaded",()=>{window.cadEditor=new CADEditor});