class ObjectsManager{constructor(e){this.editor=e}getObjectDimensions(e){const t=(new THREE.Box3).setFromObject(e),a=new THREE.Vector3;return t.getSize(a),{x:a.x,y:a.y,z:a.z}}getObjectIconAndType(e,t){let a="fa-cube",i="Объект";return"work_plane"===e.userData.type?(a="fa-square",i="Рабочая плоскость"):"sketch_plane"===e.userData.type?(a="fa-drafting-compass",i="Плоскость скетча"):"sketch_element"===e.userData.type?(a="fa-pencil-alt",i="Элемент скетча"):"extrude"===e.userData.type?(a="fa-arrows-alt-v",i="Вытягивание"):"group"===e.userData.type?(a="fa-object-group",i=`Группа (${e.userData.childCount||e.children.length} объектов)`):"thread"===e.userData.type&&(a="fa-screwdriver",i="external"===e.userData.threadType?"Наружная резьба":"Внутренняя резьба"),{icon:a,typeText:i}}getSelectableObjects(){console.log(Array.from(cadEditor.parametricModel.objectMap.values()).filter(e=>"group"===e.userData?.type));const e=[];return this.editor.parametricModel.objectMap.forEach(t=>{t.visible&&(!t.isMesh&&!t.isGroup||this._isHelper(t)||e.push(t))}),e}_isHelper(e){const t=e.userData?.type;return e.userData?.isHelper||["grid","axis","grid_helper","axes_helper","base_plane"].includes(t)}updateSceneStats(){let e=0,t=0;this.editor.parametricModel.objectMap.forEach(a=>{a.isGroup?a.traverse(a=>{a.isMesh&&a.geometry&&a.geometry.attributes&&a.geometry.attributes.position&&(e+=a.geometry.attributes.position.count||0,a.geometry.index?t+=a.geometry.index.count/3:a.geometry.attributes.position&&(t+=a.geometry.attributes.position.count/3))}):a.isMesh&&a.geometry&&a.geometry.attributes&&a.geometry.attributes.position&&(e+=a.geometry.attributes.position.count||0,a.geometry.index?t+=a.geometry.index.count/3:a.geometry.attributes.position&&(t+=a.geometry.attributes.position.count/3))}),document.getElementById("objectCount").textContent=this.editor.parametricModel.objectMap.size,document.getElementById("vertexCount").textContent=e.toLocaleString(),document.getElementById("faceCount").textContent=t.toLocaleString()}updateSceneList(){const e=document.getElementById("sceneList");if(!e)return;e.innerHTML="";Array.from(this.editor.parametricModel.objectMap.values()).forEach((t,a)=>{const i=document.createElement("div");i.className="scene-item",this.editor.selectedObjects.includes(t)&&i.classList.add("selected");const{icon:r,typeText:s}=this.getObjectIconAndType(t,a);let o=`\n                <button class="scene-item-action" title="Скрыть/показать" data-action="toggle">\n                    <i class="fas fa-eye${t.visible?"":"-slash"}"></i>\n                </button>\n            `;"sketch_plane"===t.userData.type&&(o+='\n                    <button class="scene-item-action" title="Редактировать скетч" data-action="edit-sketch">\n                        <i class="fas fa-edit"></i>\n                    </button>\n                '),o+='\n                <button class="scene-item-action" title="Удалить" data-action="delete">\n                    <i class="fas fa-trash"></i>\n                </button>\n            ',i.innerHTML=`\n                <i class="fas ${r}"></i>\n                <div class="scene-item-info">\n                    <div class="scene-item-name">${t.userData.name||s+" "+(a+1)}</div>\n                    <div class="scene-item-type">${s}</div>\n                </div>\n                <div class="scene-item-actions">\n                    ${o}\n                </div>\n            `,i.addEventListener("dblclick",e=>{e.stopPropagation(),e.target.closest(".scene-item-action")||(this.editor.selectSingleObject(t),this.focusCameraOnObject(t))}),i.querySelector('[data-action="toggle"]').addEventListener("click",e=>{e.stopPropagation();const a=!t.visible,i=new ParametricOperation("change_visibility",{target:t.uuid,visible:a},[]);this.editor.parametricModel.addOperation(i);e.target.closest("button").querySelector("i").className=a?"fas fa-eye":"fas fa-eye-slash",!a&&this.editor.selectedObjects.includes(t)&&this.editor.toggleObjectSelection(t)}),"sketch_plane"===t.userData.type&&i.querySelector('[data-action="edit-sketch"]').addEventListener("click",e=>{e.stopPropagation(),this.editor.selectSingleObject(t),this.editor.toolManager.setCurrentTool("sketch")}),i.querySelector('[data-action="delete"]').addEventListener("click",e=>{e.stopPropagation(),this.editor.deleteObject(t)}),e.appendChild(i)})}focusCameraOnObject(e){if(!e||!this.editor.camera)return;this.editor.selectedObjects.includes(e)||this.editor.selectSingleObject(e);const t=(new THREE.Box3).setFromObject(e),a=new THREE.Vector3;t.getCenter(a);const i=new THREE.Vector3;t.getSize(i);const r=Math.max(i.x,i.y,i.z),s=r>0?2*r:100,o=new THREE.Vector3;this.editor.camera.getWorldDirection(o);const n=o.clone(),l=new THREE.Vector3;l.copy(a),l.add(n.multiplyScalar(-s));const c=this.editor.camera.position.clone(),d=this.editor.controls.target.clone(),u=Date.now(),h=()=>{const e=Date.now()-u,t=Math.min(e/800,1),i=1-Math.pow(1-t,3);this.editor.camera.position.lerpVectors(c,l,i),this.editor.controls.target.lerpVectors(d,a,i),this.editor.controls.update(),t<1?requestAnimationFrame(h):(this.editor.controls.target.copy(a),this.editor.controls.update(),this.editor.showStatus("Камера сфокусирована на объекте","info"))};h()}highlightObject(e){e.isGroup?e.traverse(e=>{e.isMesh&&e.material&&this.highlightSingleObject(e)}):e.isMesh&&e.material&&this.highlightSingleObject(e)}highlightSingleObject(e){if(!e.material||e.userData.isHighlighted)return;e.userData.originalMaterial=e.material,e.userData.isHighlighted=!0;const t=e.material.clone();if(t.isMeshStandardMaterial){t.emissive.setHex(4473924),t.emissiveIntensity=.8;const e=t.color.clone().multiplyScalar(1.3);t.color.copy(e)}else if(t.isMeshPhongMaterial||t.isMeshLambertMaterial){t.emissive=new THREE.Color(4473924),t.emissiveIntensity=.8;const e=t.color.clone().multiplyScalar(1.3);t.color.copy(e)}else if(t.isMeshBasicMaterial){const e=t.color.clone().multiplyScalar(1.5);t.color.copy(e),t.transparent&&(t.opacity=Math.min(1.5*t.opacity,1))}else if(t.color){const e=t.color.clone().multiplyScalar(1.3);t.color.copy(e)}e.material=t,e.material.needsUpdate=!0,this.createObjectOutline(e)}createObjectOutline(e){e.userData.outline&&(e.remove(e.userData.outline),e.userData.outline.geometry.dispose(),e.userData.outline.material.dispose(),delete e.userData.outline);const t=new THREE.EdgesGeometry(e.geometry,15),a=new THREE.LineBasicMaterial({color:39423,linewidth:6,transparent:!0,opacity:.8}),i=new THREE.LineSegments(t,a);i.userData.isOutline=!0,e.add(i),e.userData.outline=i}unhighlightObject(e){e.isGroup?e.traverse(e=>{e.isMesh&&e.userData.isHighlighted&&this.unhighlightSingleObject(e)}):e.isMesh&&e.userData.isHighlighted&&this.unhighlightSingleObject(e)}unhighlightSingleObject(e){e.userData.originalMaterial&&(e.material=e.userData.originalMaterial,e.material.needsUpdate=!0,delete e.userData.originalMaterial,delete e.userData.isHighlighted,this.removeObjectOutline(e))}removeObjectOutline(e){if(!e.userData||!e.userData.outline)return;const t=e.userData.outline;if(e.children.includes(t)&&e.remove(t),t.geometry&&"function"==typeof t.geometry.dispose)try{t.geometry.dispose()}catch(e){console.warn("Ошибка при удалении геометрии контура:",e)}if(t.material&&"function"==typeof t.material.dispose)try{t.material.dispose()}catch(e){console.warn("Ошибка при удалении материала контура:",e)}Array.isArray(t.material)&&t.material.forEach(e=>{if(e&&"function"==typeof e.dispose)try{e.dispose()}catch(e){console.warn("Ошибка при удалении материала из массива:",e)}}),delete e.userData.outline}findTopParent(e){for(;e.parent&&e.parent!==this.editor.objectsGroup;)e=e.parent;return e}safeSetElementColor(e,t){if(e&&e.material)try{const a=e.material.clone();a.color.setHex(t),a.needsUpdate=!0,e.userData.originalMaterial||(e.userData.originalMaterial=e.material),e.material=a}catch(e){console.warn("Error setting element color:",e)}}getAllSketchElements(){const e=[],t=a=>{a.userData&&"sketch_element"===a.userData.type&&e.push(a),a.children.forEach(e=>t(e))};return this.editor.sketchPlanes.forEach(e=>t(e)),this.editor.workPlanes.forEach(e=>t(e)),t(this.editor.objectsGroup),e}getClosedSketchElements(){return this.getAllSketchElements().filter(e=>!(!e.userData||"sketch_element"===!e.userData.type)&&this.editor.extrudeManager.isSketchElementClosed(e))}highlightSketchElementsInGroup(e){e&&e.traverse(e=>{e.userData&&"sketch_element"===e.userData.type&&this.safeSetElementColor(e,2201331)})}isElementSelected(e){return this.editor.selectedObjects.includes(e)}toggleElementSelection(e){const t=this.editor.selectedObjects.indexOf(e);t>-1?(this.editor.selectedObjects.splice(t,1),this.safeRestoreElementColor(e)):(this.editor.selectedObjects.push(e),this.safeSetElementColor(e,16753920))}safeRestoreElementColor(e){if(e&&e.userData)try{if(e.userData.originalMaterial){const t=e.userData.originalMaterial;let a;if("LineBasicMaterial"===t.type)a=new THREE.LineBasicMaterial({color:t.color.getHex?t.color.getHex():1118481,linewidth:t.linewidth||2,transparent:t.transparent||!1,opacity:t.opacity||1});else if("MeshPhongMaterial"===t.type||"MeshBasicMaterial"===t.type){const e=t.color?t.color.getHex():8421504;a=new THREE.MeshPhongMaterial({color:e,transparent:t.transparent||!1,opacity:t.opacity||1,shininess:t.shininess||30})}else a=new THREE.MeshPhongMaterial({color:8421504});e.material&&e.material!==t&&e.material.dispose&&e.material.dispose(),e.material=a,e.material.needsUpdate=!0,delete e.userData.originalMaterial}else if(void 0!==e.userData.originalColor){const t="number"==typeof e.userData.originalColor?e.userData.originalColor:8421504;if(e.material&&e.material.color&&e.material.color.setHex)try{e.material.color.setHex(t),e.material.needsUpdate=!0}catch(e){}delete e.userData.originalColor}}catch(t){console.warn("Error restoring element color:",t),e&&e.material&&(e.material=new THREE.MeshPhongMaterial({color:8421504}))}}}