class ObjectsManager{constructor(e){this.editor=e,this.figureManager=new FigureManager(e)}initializeFigureManager(){return this.figureManager||(this.figureManager=new FigureManager(this.editor)),this.figureManager}getFigureManager(){return this.figureManager||this.initializeFigureManager(),this.figureManager}getObjectDimensions(e){const t=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;return t.getSize(i),{x:i.x,y:i.y,z:i.z}}getObjectIconAndType(e,t){let i="fa-cube",a="Объект";return"work_plane"===e.userData.type?(i="fa-square",a="Рабочая плоскость"):"sketch_plane"===e.userData.type?(i="fa-drafting-compass",a="Плоскость скетча"):"sketch_element"===e.userData.type?(i="fa-pencil-alt",a="Элемент скетча"):"sketch"===e.userData.type?(i="fa-drafting-compass",a="Скетч"):"extrude"===e.userData.type?(i="fa-arrows-alt-v",a="Вытягивание"):"group"===e.userData.type?(i="fa-object-group",a=`Группа (${e.userData.childCount||e.children.length} объектов)`):e.userData.type&&(a=e.userData.type),{icon:i,typeText:a}}updateSceneStats(){let e=0,t=0;this.editor.objects.forEach(i=>{i.isGroup?i.traverse(i=>{i.isMesh&&i.geometry&&i.geometry.attributes&&i.geometry.attributes.position&&(e+=i.geometry.attributes.position.count||0,i.geometry.index?t+=i.geometry.index.count/3:i.geometry.attributes.position&&(t+=i.geometry.attributes.position.count/3))}):i.isMesh&&i.geometry&&i.geometry.attributes&&i.geometry.attributes.position&&(e+=i.geometry.attributes.position.count||0,i.geometry.index?t+=i.geometry.index.count/3:i.geometry.attributes.position&&(t+=i.geometry.attributes.position.count/3))}),document.getElementById("objectCount").textContent=this.editor.objects.length,document.getElementById("vertexCount").textContent=e.toLocaleString(),document.getElementById("faceCount").textContent=t.toLocaleString()}updateSceneList(){const e=document.getElementById("sceneList");e&&(e.innerHTML="",this.editor.objects.forEach((t,i)=>{const a=document.createElement("div");a.className="scene-item",this.editor.selectedObjects.includes(t)&&a.classList.add("selected");const{icon:s,typeText:r}=this.getObjectIconAndType(t,i);let o=`\n                <button class="scene-item-action" title="Скрыть/показать" data-action="toggle">\n                    <i class="fas fa-eye${t.visible?"":"-slash"}"></i>\n                </button>\n            `;"sketch_plane"===t.userData.type&&(o+='\n                    <button class="scene-item-action" title="Редактировать скетч" data-action="edit-sketch">\n                        <i class="fas fa-edit"></i>\n                    </button>\n                '),o+='\n                <button class="scene-item-action" title="Удалить" data-action="delete">\n                    <i class="fas fa-trash"></i>\n                </button>\n            ',a.innerHTML=`\n                <i class="fas ${s}"></i>\n                <div class="scene-item-info">\n                    <div class="scene-item-name">${t.userData.name||r+" "+(i+1)}</div>\n                    <div class="scene-item-type">${r}</div>\n                </div>\n                <div class="scene-item-actions">\n                    ${o}\n                </div>\n            `,a.addEventListener("dblclick",e=>{e.stopPropagation(),e.target.closest(".scene-item-action")||(this.editor.selectObject(t),this.focusCameraOnObject(t))}),a.querySelector('[data-action="toggle"]').addEventListener("click",e=>{e.stopPropagation(),t.visible=!t.visible;e.target.closest("button").querySelector("i").className=t.visible?"fas fa-eye":"fas fa-eye-slash"}),"sketch_plane"===t.userData.type&&a.querySelector('[data-action="edit-sketch"]').addEventListener("click",e=>{e.stopPropagation(),this.editor.selectObject(t),this.editor.toolManager.setCurrentTool("sketch")}),a.querySelector('[data-action="delete"]').addEventListener("click",e=>{e.stopPropagation(),this.editor.deleteObject(t)}),e.appendChild(a)}))}focusCameraOnObject(e){if(!e||!this.editor.camera)return;this.editor.selectedObjects.includes(e)||this.editor.selectObject(e);const t=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;t.getCenter(i);const a=new THREE.Vector3;t.getSize(a);const s=Math.max(a.x,a.y,a.z),r=s>0?2*s:100,o=new THREE.Vector3;this.editor.camera.getWorldDirection(o);const n=o.clone(),l=new THREE.Vector3;l.copy(i),l.add(n.multiplyScalar(-r));const c=this.editor.camera.position.clone(),h=this.editor.controls.target.clone(),d=Date.now(),g=()=>{const e=Date.now()-d,t=Math.min(e/800,1),a=1-Math.pow(1-t,3);this.editor.camera.position.lerpVectors(c,l,a),this.editor.controls.target.lerpVectors(h,i,a),this.editor.controls.update(),t<1?requestAnimationFrame(g):(this.editor.controls.target.copy(i),this.editor.controls.update(),this.editor.showStatus("Камера сфокусирована на объекте","info"))};g()}highlightObject(e){e.isGroup?e.traverse(e=>{e.isMesh&&e.material&&this.highlightSingleObject(e)}):e.isMesh&&e.material&&this.highlightSingleObject(e)}highlightSingleObject(e){if(e.material&&!e.userData.isHighlighted)if(e.userData.originalMaterial=e.material,e.userData.isHighlighted=!0,e.material.isMeshPhongMaterial||e.material.isMeshLambertMaterial){const t=e.material.clone();t.emissive=new THREE.Color(4473924),t.emissiveIntensity=.8;const i=t.color.clone().multiplyScalar(1.3);t.color.copy(i),e.material=t,e.material.needsUpdate=!0}else if(e.material.isMeshBasicMaterial){const t=e.material.clone(),i=t.color.clone().multiplyScalar(1.5);t.color.copy(i),t.transparent&&(t.opacity=Math.min(1.5*t.opacity,1)),e.material=t,e.material.needsUpdate=!0}}unhighlightObject(e){e.isGroup?e.traverse(e=>{e.isMesh&&e.userData.isHighlighted&&this.unhighlightSingleObject(e)}):e.isMesh&&e.userData.isHighlighted&&this.unhighlightSingleObject(e)}unhighlightSingleObject(e){e.userData.originalMaterial&&(e.material=e.userData.originalMaterial,e.material.needsUpdate=!0,delete e.userData.originalMaterial,delete e.userData.isHighlighted)}findTopParent(e){for(;e.parent&&e.parent!==this.editor.objectsGroup;)e=e.parent;return e}safeSetElementColor(e,t){if(e&&e.material)try{const i=e.material.clone();i.color.setHex(t),i.needsUpdate=!0,e.userData.originalMaterial||(e.userData.originalMaterial=e.material),e.material=i}catch(e){console.warn("Error setting element color:",e)}}getAllSketchElements(){const e=[],t=i=>{i.userData&&"sketch_element"===i.userData.type&&e.push(i),i.children.forEach(e=>t(e))};return this.editor.sketchPlanes.forEach(e=>t(e)),this.editor.workPlanes.forEach(e=>t(e)),t(this.editor.objectsGroup),e}getClosedSketchElements(){return this.getAllSketchElements().filter(e=>!(!e.userData||"sketch_element"===!e.userData.type)&&this.editor.extrudeManager.isSketchElementClosed(e))}highlightSketchElementsInGroup(e){e&&e.traverse(e=>{e.userData&&"sketch_element"===e.userData.type&&this.safeSetElementColor(e,2201331)})}isElementSelected(e){return this.editor.selectedObjects.includes(e)}toggleElementSelection(e){const t=this.editor.selectedObjects.indexOf(e);t>-1?(this.editor.selectedObjects.splice(t,1),this.safeRestoreElementColor(e)):(this.editor.selectedObjects.push(e),this.safeSetElementColor(e,16753920))}safeRestoreElementColor(e){if(e&&e.userData)try{if(e.userData.originalMaterial)e.material=e.userData.originalMaterial,delete e.userData.originalMaterial;else if(e.userData.originalColor){const t=e.material.clone();t.color.copy(e.userData.originalColor),t.needsUpdate=!0,e.material=t}}catch(e){console.warn("Error restoring element color:",e)}}}