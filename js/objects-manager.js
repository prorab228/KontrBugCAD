class ObjectsManager{constructor(e){this.editor=e,this.figureManager=new FigureManager(e)}initializeFigureManager(){return this.figureManager||(this.figureManager=new FigureManager(this.editor)),this.figureManager}getFigureManager(){return this.figureManager||this.initializeFigureManager(),this.figureManager}getObjectDimensions(e){const t=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;return t.getSize(i),{x:i.x,y:i.y,z:i.z}}getObjectIconAndType(e,t){let i="fa-cube",a="Объект";return"work_plane"===e.userData.type?(i="fa-square",a="Рабочая плоскость"):"sketch_plane"===e.userData.type?(i="fa-drafting-compass",a="Плоскость скетча"):"sketch_element"===e.userData.type?(i="fa-pencil-alt",a="Элемент скетча"):"sketch"===e.userData.type?(i="fa-drafting-compass",a="Скетч"):"extrude"===e.userData.type?(i="fa-arrows-alt-v",a="Вытягивание"):"group"===e.userData.type?(i="fa-object-group",a=`Группа (${e.userData.childCount||e.children.length} объектов)`):e.userData.type?a=e.userData.type:"thread"===e.userData.type&&(i="fa-screwdriver",a="external"===e.userData.threadType?"Наружная резьба":"Внутренняя резьба"),{icon:i,typeText:a}}getSelectableObjects(){const e=[];return this.editor.objectsGroup.traverse(t=>{if(t.isMesh&&t.visible){const i=t.userData?.type;t.userData?.isHelper||"grid"===i||"axis"===i||"grid_helper"===i||"axes_helper"===i||e.push(t)}}),e}updateSceneStats(){let e=0,t=0;this.editor.objects.forEach(i=>{i.isGroup?i.traverse(i=>{i.isMesh&&i.geometry&&i.geometry.attributes&&i.geometry.attributes.position&&(e+=i.geometry.attributes.position.count||0,i.geometry.index?t+=i.geometry.index.count/3:i.geometry.attributes.position&&(t+=i.geometry.attributes.position.count/3))}):i.isMesh&&i.geometry&&i.geometry.attributes&&i.geometry.attributes.position&&(e+=i.geometry.attributes.position.count||0,i.geometry.index?t+=i.geometry.index.count/3:i.geometry.attributes.position&&(t+=i.geometry.attributes.position.count/3))}),document.getElementById("objectCount").textContent=this.editor.objects.length,document.getElementById("vertexCount").textContent=e.toLocaleString(),document.getElementById("faceCount").textContent=t.toLocaleString()}updateSceneList(){const e=document.getElementById("sceneList");e&&(e.innerHTML="",this.editor.objects.forEach((t,i)=>{const a=document.createElement("div");a.className="scene-item",this.editor.selectedObjects.includes(t)&&a.classList.add("selected");const{icon:r,typeText:s}=this.getObjectIconAndType(t,i);let o=`\n                <button class="scene-item-action" title="Скрыть/показать" data-action="toggle">\n                    <i class="fas fa-eye${t.visible?"":"-slash"}"></i>\n                </button>\n            `;"sketch_plane"===t.userData.type&&(o+='\n                    <button class="scene-item-action" title="Редактировать скетч" data-action="edit-sketch">\n                        <i class="fas fa-edit"></i>\n                    </button>\n                '),o+='\n                <button class="scene-item-action" title="Удалить" data-action="delete">\n                    <i class="fas fa-trash"></i>\n                </button>\n            ',a.innerHTML=`\n                <i class="fas ${r}"></i>\n                <div class="scene-item-info">\n                    <div class="scene-item-name">${t.userData.name||s+" "+(i+1)}</div>\n                    <div class="scene-item-type">${s}</div>\n                </div>\n                <div class="scene-item-actions">\n                    ${o}\n                </div>\n            `,a.addEventListener("dblclick",e=>{e.stopPropagation(),e.target.closest(".scene-item-action")||(this.editor.selectSingleObject(t),this.focusCameraOnObject(t))}),a.querySelector('[data-action="toggle"]').addEventListener("click",e=>{e.stopPropagation(),t.visible=!t.visible;e.target.closest("button").querySelector("i").className=t.visible?"fas fa-eye":"fas fa-eye-slash",!t.visible&&this.editor.selectedObjects.includes(t)&&this.editor.toggleObjectSelection(t)}),"sketch_plane"===t.userData.type&&a.querySelector('[data-action="edit-sketch"]').addEventListener("click",e=>{e.stopPropagation(),this.editor.selectSingleObject(t),this.editor.toolManager.setCurrentTool("sketch")}),a.querySelector('[data-action="delete"]').addEventListener("click",e=>{e.stopPropagation(),this.editor.deleteObject(t)}),e.appendChild(a)}))}focusCameraOnObject(e){if(!e||!this.editor.camera)return;this.editor.selectedObjects.includes(e)||this.editor.selectSingleObject(e);const t=(new THREE.Box3).setFromObject(e),i=new THREE.Vector3;t.getCenter(i);const a=new THREE.Vector3;t.getSize(a);const r=Math.max(a.x,a.y,a.z),s=r>0?2*r:100,o=new THREE.Vector3;this.editor.camera.getWorldDirection(o);const n=o.clone(),l=new THREE.Vector3;l.copy(i),l.add(n.multiplyScalar(-s));const c=this.editor.camera.position.clone(),u=this.editor.controls.target.clone(),h=Date.now(),d=()=>{const e=Date.now()-h,t=Math.min(e/800,1),a=1-Math.pow(1-t,3);this.editor.camera.position.lerpVectors(c,l,a),this.editor.controls.target.lerpVectors(u,i,a),this.editor.controls.update(),t<1?requestAnimationFrame(d):(this.editor.controls.target.copy(i),this.editor.controls.update(),this.editor.showStatus("Камера сфокусирована на объекте","info"))};d()}highlightObject(e){e.isGroup?e.traverse(e=>{e.isMesh&&e.material&&this.highlightSingleObject(e)}):e.isMesh&&e.material&&this.highlightSingleObject(e)}highlightSingleObject(e){if(!e.material||e.userData.isHighlighted)return;e.userData.originalMaterial=e.material,e.userData.isHighlighted=!0;const t=e.material.clone();if(t.isMeshStandardMaterial){t.emissive.setHex(4473924),t.emissiveIntensity=.8;const e=t.color.clone().multiplyScalar(1.3);t.color.copy(e)}else if(t.isMeshPhongMaterial||t.isMeshLambertMaterial){t.emissive=new THREE.Color(4473924),t.emissiveIntensity=.8;const e=t.color.clone().multiplyScalar(1.3);t.color.copy(e)}else if(t.isMeshBasicMaterial){const e=t.color.clone().multiplyScalar(1.5);t.color.copy(e),t.transparent&&(t.opacity=Math.min(1.5*t.opacity,1))}else if(t.color){const e=t.color.clone().multiplyScalar(1.3);t.color.copy(e)}e.material=t,e.material.needsUpdate=!0,this.createObjectOutline(e)}createObjectOutline(e){e.userData.outline&&(e.remove(e.userData.outline),e.userData.outline.geometry.dispose(),e.userData.outline.material.dispose(),delete e.userData.outline);const t=new THREE.EdgesGeometry(e.geometry,15),i=new THREE.LineBasicMaterial({color:39423,linewidth:6,transparent:!0,opacity:.8}),a=new THREE.LineSegments(t,i);a.userData.isOutline=!0,a.scale.copy(e.scale),e.add(a),e.userData.outline=a}unhighlightObject(e){e.isGroup?e.traverse(e=>{e.isMesh&&e.userData.isHighlighted&&this.unhighlightSingleObject(e)}):e.isMesh&&e.userData.isHighlighted&&this.unhighlightSingleObject(e)}unhighlightSingleObject(e){e.userData.originalMaterial&&(e.material=e.userData.originalMaterial,e.material.needsUpdate=!0,delete e.userData.originalMaterial,delete e.userData.isHighlighted,this.removeObjectOutline(e))}removeObjectOutline(e){if(!e.userData||!e.userData.outline)return;const t=e.userData.outline;if(e.children.includes(t)&&e.remove(t),t.geometry&&"function"==typeof t.geometry.dispose)try{t.geometry.dispose()}catch(e){console.warn("Ошибка при удалении геометрии контура:",e)}if(t.material&&"function"==typeof t.material.dispose)try{t.material.dispose()}catch(e){console.warn("Ошибка при удалении материала контура:",e)}Array.isArray(t.material)&&t.material.forEach(e=>{if(e&&"function"==typeof e.dispose)try{e.dispose()}catch(e){console.warn("Ошибка при удалении материала из массива:",e)}}),delete e.userData.outline}findTopParent(e){for(;e.parent&&e.parent!==this.editor.objectsGroup;)e=e.parent;return e}safeSetElementColor(e,t){if(e&&e.material)try{const i=e.material.clone();i.color.setHex(t),i.needsUpdate=!0,e.userData.originalMaterial||(e.userData.originalMaterial=e.material),e.material=i}catch(e){console.warn("Error setting element color:",e)}}getAllSketchElements(){const e=[],t=i=>{i.userData&&"sketch_element"===i.userData.type&&e.push(i),i.children.forEach(e=>t(e))};return this.editor.sketchPlanes.forEach(e=>t(e)),this.editor.workPlanes.forEach(e=>t(e)),t(this.editor.objectsGroup),e}getClosedSketchElements(){return this.getAllSketchElements().filter(e=>!(!e.userData||"sketch_element"===!e.userData.type)&&this.editor.extrudeManager.isSketchElementClosed(e))}highlightSketchElementsInGroup(e){e&&e.traverse(e=>{e.userData&&"sketch_element"===e.userData.type&&this.safeSetElementColor(e,2201331)})}isElementSelected(e){return this.editor.selectedObjects.includes(e)}toggleElementSelection(e){const t=this.editor.selectedObjects.indexOf(e);t>-1?(this.editor.selectedObjects.splice(t,1),this.safeRestoreElementColor(e)):(this.editor.selectedObjects.push(e),this.safeSetElementColor(e,16753920))}safeRestoreElementColor(e){if(e&&e.userData)try{if(e.userData.originalMaterial){const t=e.userData.originalMaterial;if(t&&t.color&&t.type){let i;if("LineBasicMaterial"===t.type)i=new THREE.LineBasicMaterial({color:t.color.getHex?t.color.getHex():"number"==typeof t.color?t.color:1118481,linewidth:t.linewidth||2,transparent:t.transparent||!1,opacity:t.opacity||1});else if("MeshPhongMaterial"===t.type||"MeshBasicMaterial"===t.type){const e=t.color?t.color.getHex?t.color.getHex():"number"==typeof t.color?t.color:8421504:8421504;i=new THREE.MeshPhongMaterial({color:e,transparent:t.transparent||!1,opacity:t.opacity||1,shininess:t.shininess||30})}else i=new THREE.MeshPhongMaterial({color:8421504});e.material&&e.material!==t&&e.material.dispose&&e.material.dispose(),e.material=i,e.material.needsUpdate=!0}delete e.userData.originalMaterial}else if(void 0!==e.userData.originalColor){const t="number"==typeof e.userData.originalColor?e.userData.originalColor:8421504;if(e.material&&e.material.color&&e.material.color.setHex)try{e.material.color.setHex(t),e.material.needsUpdate=!0}catch(e){console.warn("Error setting color:",e)}delete e.userData.originalColor}}catch(t){if(console.warn("Error restoring element color:",t),e&&e.material){const t=new THREE.MeshPhongMaterial({color:8421504});e.material=t}}}}